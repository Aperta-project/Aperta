#!/usr/bin/env ruby
require 'pathname'

mac_os = %x{uname}.chomp == "Darwin"
unless mac_os
  fail "This setup script is only designed for Mac OS."
end

# path to your application root.
APP_ROOT = Pathname.new File.expand_path('../../',  __FILE__)

Dir.chdir APP_ROOT do
  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file:

  puts "== Installing dependencies =="
  system "gem install bundler --conservative"
  system "bundle check || bundle install"

  system "brew install imagemagick --with-libtiff"

  system "brew install postgresql"

  system "brew install solr"
  system "rake sunspot:solr:start"

  system "brew install redis"
  system "redis-server $(brew --prefix)/etc/redis.conf"

  system "brew install go"
  unless ENV['GOPATH']
    puts "\n== Please ensure your $GOPATH is configured correctly =="
  end
  system "go get github.com/tahi-project/golang-eventsource"

  system "brew install node"
  system "npm install -g npm@latest"
  system "npm install -g bower"

  puts "\n== Creating the tahi PostgreSQL user =="
  system "createuser -s -r tahi"

  puts "\n== Copying sample files =="
  unless File.exist?("config/database.yml")
    system "cp config/database.yml.sample config/database.yml"
  end

  unless File.exist?(".env.development")
    system "cp .env-sample .env.development"
  end

  puts "\n== Add binstubs to PATH in ~/.zshenv like this: =="
  puts "export PATH=\".git/safe/../../bin:$PATH\""

  puts "\n== Marking this project's binstubs as safe =="
  system "mkdir -p .git/safe"

  puts "\n== Preparing database =="
  system "bin/rake db:setup"
  system "bin/rake db:setup RAILS_ENV=test"

  puts "\n== Removing old logs and tempfiles =="
  system "rm -f log/*"
  system "rm -rf tmp/cache"
end
