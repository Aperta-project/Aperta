#!/usr/bin/env ruby
require 'pathname'
begin
  require 'active_support/core_ext/object/blank'
rescue LoadError
  fail "Please run `gem install activesupport` first"
end

SLANGER_REPO = "git@github.com:Tahi-project/tahi-slanger.git"

def cmd_available? cmd
  `which #{cmd}` != ''
end

$os = `uname`.chomp.downcase.intern
unless $os == :darwin || ($os == :linux && cmd_available?('apt-get'))
  fail 'This setup script is only designed for Mac OS or Debian/Ubuntu.'
end

# path to your application root.
APP_ROOT = Pathname.new File.expand_path('../../',  __FILE__)

def run_pg(cmd)
  case $os
  when :darwin
    `#{cmd}`
  when :linux
    cmd = cmd.gsub("\"", "\\\"") # escape quotes
    `sudo su postgres -c "#{cmd}"`
  end
end

def header message
  full = "== #{message} =="
  puts
  puts "=" * full.length
  puts full
  puts "=" * full.length
  puts
end

def brew_install package, options=nil
  if `brew ls --versions #{package}`.present?
    puts "#{package} is already installed"
  else
    system "brew install #{package} #{options}"
  end
end

def ensure_postgres_setup
  if !cmd_available?('psql')
    puts "psql isn't available."
    puts "Would you like to install it right now? y/n"
    if gets.match /y/i
      case $os
      when :darwin
        system "brew install postgresql"
      when :linux
        system "apt-get install postgresql"
      end
    else
      puts "Please ensure postgresql is installed and configured."
      exit 1
    end
  end

  if !run_pg("psql -l")
    puts
    puts "Couldn't access postgresql database."
    puts "Please make sure postgresql is running and try again."
    exit 1
  end
end

def copy_template source, dest
  if File.exist?(dest)
    puts "#{dest} already exists; not copying from #{source}."
  else
    puts "Copying #{source} to #{dest}."
    system "cp #{source} #{dest}"
  end
end

def setup_slanger
  if Dir.exist? '../tahi-slanger'
    puts "Slanger repo already cloned."
  elsif !system "cd .. && git clone #{SLANGER_REPO}"
    puts "Couldn't clone repo."
    exit 1
  end

  header 'Installing tahi-slanger dependencies.'

  if !system "cd ../tahi-slanger && bundle install"
    exit 1
  end
end

Dir.chdir APP_ROOT do
  system "rm -f setup.log"

  header 'Checking database setup'
  ensure_postgres_setup

  header 'Installing other package dependencies'
  case $os
  when :darwin
    brew_install 'imagemagick', '--with-libtiff'
    %w(redis node watchman qt).each do |package|
      brew_install package
    end
  when :linux
    system "sudo apt-get install -y imagemagick redis-server nodejs qt5-default libqt5webkit5-dev"
  end

  header 'Installing gems'
  system 'gem install bundler --conservative'
  system 'bundle check || bundle install'

  header 'Installing javascript dependencies (output logged to setup.log)'
  system 'npm install >> setup.log'
  system 'bundle exec rake ember-cli:install_dependencies'

  # NOTE rolname is not a typo
  # http://stackoverflow.com/questions/8546759/how-to-check-if-a-postgres-user-exists
  if run_pg("psql postgres -tAc \"SELECT 1 FROM pg_roles WHERE rolname='tahi'\"").present?
    header 'PostgreSQL user already exists'
  else
    header 'Creating the tahi PostgreSQL user'
    run_pg('createuser -s -r tahi')
  end

  header 'Copying sample files'
  copy_template 'config/database.yml.sample', 'config/database.yml'
  copy_template '.env-sample', '.env.development'
  copy_template 'Procfile.template', 'Procfile.local'

  header 'Add binstubs to PATH in ~/.zshenv like this:'
  puts 'export PATH=".git/safe/../../bin:$PATH"'

  header "Marking this project's binstubs as safe"
  system 'mkdir -p .git/safe'

  header 'Adding pre-commit hook'
  system 'overcommit .'

  # required for db setup
  header 'Cloning tahi-slanger event server repo'
  setup_slanger

  header 'Preparing development database (output logged to setup.log)'
  system 'bin/rake db:setup >> setup.log'

  header 'Preparing testing database (output logged to setup.log)'
  system 'bin/rake db:setup RAILS_ENV=test >> setup.log'

  header 'Removing old logs and tempfiles'
  system 'rm -f log/**/*'
  system 'rm -rf tmp/cache'

  puts
  puts 'Success! Please source .env.development.'
end
