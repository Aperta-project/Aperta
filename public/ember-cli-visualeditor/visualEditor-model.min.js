ve.dm={},ve.dm.Model=function(a){this.element=a||{type:this.constructor["static"].name}},OO.initClass(ve.dm.Model),ve.dm.Model["static"].name=null,ve.dm.Model["static"].matchTagNames=null,ve.dm.Model["static"].matchRdfaTypes=null,ve.dm.Model["static"].allowedRdfaTypes=[],ve.dm.Model["static"].matchFunction=null,ve.dm.Model["static"].toDataElement=function(){return{type:this.name}},ve.dm.Model["static"].toDomElements=function(a,b){if(this.matchTagNames&&1===this.matchTagNames.length)return[b.createElement(this.matchTagNames[0])];throw new Error("ve.dm.Model subclass must match a single tag name or implement toDomElements")},ve.dm.Model["static"].enableAboutGrouping=!1,ve.dm.Model["static"].preserveHtmlAttributes=!0,ve.dm.Model["static"].getHashObject=function(a){return{type:a.type,attributes:a.attributes,originalDomElements:a.originalDomElements&&a.originalDomElements.map(function(a){return a.outerHTML}).join("")}},ve.dm.Model["static"].getMatchRdfaTypes=function(){return this.matchRdfaTypes},ve.dm.Model["static"].getAllowedRdfaTypes=function(){return this.allowedRdfaTypes},ve.dm.Model.prototype.isInspectable=function(){return!0},ve.dm.Model.prototype.getElement=function(){return this.element},ve.dm.Model.prototype.getType=function(){return this.constructor["static"].name},ve.dm.Model.prototype.getAttribute=function(a){return this.element&&this.element.attributes?this.element.attributes[a]:void 0},ve.dm.Model.prototype.getAttributes=function(a){var b,c,d=this.element&&this.element.attributes?this.element.attributes:{};if(a){c={};for(b in d)0===b.indexOf(a)&&(c[b.slice(a.length)]=d[b]);return c}return ve.extendObject({},d)},ve.dm.Model.prototype.getOriginalDomElements=function(){return this.element&&this.element.originalDomElements||[]},ve.dm.Model.prototype.hasAttributes=function(a,b){var c,d,e,f=this.getAttributes()||{};if(ve.isPlainObject(a)){for(c in a)if(!(c in f)||(b?a[c]!==f[c]:String(a[c])!==String(f[c])))return!1}else if(Array.isArray(a))for(d=0,e=a.length;e>d;d++)if(!(a[d]in f))return!1;return!0},ve.dm.Model.prototype.getClonedElement=function(){return ve.copy(this.element)},ve.dm.Model.prototype.getHashObject=function(){return this.constructor["static"].getHashObject(this.element)},ve.dm.ModelFactory=function(){ve.dm.ModelFactory["super"].call(this)},OO.inheritClass(ve.dm.ModelFactory,OO.Factory),ve.dm.ModelFactory.prototype.createFromElement=function(a){if(a&&a.type)return this.create(a.type,a);throw new Error("Element must have a .type property")},function(a){function b(a){var b,c,d=Array.prototype.slice.call(arguments,1,-1),e=arguments[arguments.length-1],f=a;for(b=0,c=d.length-1;c>b;b++)void 0===f[d[b]]&&(f[d[b]]={}),f=f[d[b]];f[d[b]]=f[d[b]]||[],f[d[b]].unshift(e)}function c(b){var c,d=Array.prototype.slice.call(arguments,1,-1),e=arguments[arguments.length-1],f=a.getProp.apply(b,[b].concat(d));f&&(c=f.indexOf(e),-1!==c&&f.splice(c,1))}a.dm.ModelRegistry=function(){OO.Registry.call(this),this.modelsByTag=[{},{}],this.modelsByTypeAndTag=[],this.modelsWithTypeRegExps=[[],[]],this.registrationOrder={},this.nextNumber=0,this.extSpecificTypes=[]},OO.inheritClass(a.dm.ModelRegistry,OO.Registry),a.dm.ModelRegistry.prototype.register=function(c){var d,e,f,g,h=c["static"]&&c["static"].name;if("string"!=typeof h||""===h)throw new Error("Model names must be strings and must not be empty");if(!(c.prototype instanceof a.dm.Model))throw new Error("Models must be subclasses of ve.dm.Model");if(c.prototype instanceof a.dm.Annotation)a.dm.annotationFactory.register(c);else if(c.prototype instanceof a.dm.Node)a.dm.nodeFactory.register(c);else{if(!(c.prototype instanceof a.dm.MetaItem))throw new Error("No factory associated with this ve.dm.Model subclass");a.dm.metaItemFactory.register(c)}for(a.dm.ModelRegistry["super"].prototype.register.call(this,h,c),f=null===c["static"].matchTagNames?[""]:c["static"].matchTagNames,g=null===c["static"].getMatchRdfaTypes()?[""]:c["static"].getMatchRdfaTypes(),d=0;d<f.length;d++)b(this.modelsByTag,+!!c["static"].matchFunction,f[d],h);for(d=0;d<g.length;d++)if(g[d]instanceof RegExp)b(this.modelsWithTypeRegExps,+!!c["static"].matchFunction,h);else for(e=0;e<f.length;e++)b(this.modelsByTypeAndTag,+!!c["static"].matchFunction,g[d],f[e],h);this.registrationOrder[h]=this.nextNumber++},a.dm.ModelRegistry.prototype.unregister=function(b){var d,e,f,g,h=b["static"]&&b["static"].name;if("string"!=typeof h||""===h)throw new Error("Model names must be strings and must not be empty");if(!(b.prototype instanceof a.dm.Model))throw new Error("Models must be subclasses of ve.dm.Model");if(b.prototype instanceof a.dm.Annotation)a.dm.annotationFactory.unregister(b);else if(b.prototype instanceof a.dm.Node)a.dm.nodeFactory.unregister(b);else{if(!(b.prototype instanceof a.dm.MetaItem))throw new Error("No factory associated with this ve.dm.Model subclass");a.dm.metaItemFactory.unregister(b)}for(a.dm.ModelRegistry["super"].prototype.unregister.call(this,h),f=null===b["static"].matchTagNames?[""]:b["static"].matchTagNames,g=null===b["static"].getMatchRdfaTypes()?[""]:b["static"].getMatchRdfaTypes(),d=0;d<f.length;d++)c(this.modelsByTag,+!!b["static"].matchFunction,f[d],h);for(d=0;d<g.length;d++)if(g[d]instanceof RegExp)c(this.modelsWithTypeRegExps,+!!b["static"].matchFunction,h);else for(e=0;e<f.length;e++)c(this.modelsByTypeAndTag,+!!b["static"].matchFunction,g[d],f[e],h);delete this.registrationOrder[h]},a.dm.ModelRegistry.prototype.matchElement=function(b,c,d){function e(a,b){return q.registrationOrder[b]-q.registrationOrder[a]}function f(a,b,c){var e,f,g,h=[],i=q.modelsWithTypeRegExps[+c];for(e=0;e<i.length;e++)if(!d||-1===d.indexOf(i[e]))for(g=q.registry[i[e]]["static"].getMatchRdfaTypes(),f=0;f<g.length;f++)g[f]instanceof RegExp&&a.match(g[f])&&(""===b&&null===q.registry[i[e]]["static"].matchTagNames||-1!==(q.registry[i[e]]["static"].matchTagNames||[]).indexOf(b))&&h.push(i[e]);return h}function g(a,b){function c(a,b){return a instanceof RegExp?!!b.match(a):a===b}var d,e,f,g=q.lookup(b),h=g["static"].getAllowedRdfaTypes(),i=g["static"].getMatchRdfaTypes();if(null===h||null===i)return!0;for(h=h.concat(i),d=0;d<a.length;d++){for(f=!1,e=0;e<h.length;e++)if(c(h[e],a[d])){f=!0;break}if(!f)return!1}return!0}function h(h,i){var j,k=[],l=[];for(j=0;j<h.length;j++)k=k.concat(a.getProp(q.modelsByTypeAndTag,1,h[j],i)||[]),d&&(k=OO.simpleArrayDifference(k,d)),l=l.concat(f(h[j],i,!0));for(k=k.filter(function(a){return g(h,a)}),l=l.filter(function(a){return g(h,a)}),c&&(k=k.filter(function(a){return q.registry[a]["static"].enableAboutGrouping}),l=l.filter(function(a){return q.registry[a]["static"].enableAboutGrouping})),k.sort(e),l.sort(e),k=k.concat(l),j=0;j<k.length;j++)if(q.registry[k[j]]["static"].matchFunction(b))return k[j];return null}function i(b,e){var h,i=[],j=[],k=null;for(h=0;h<b.length;h++)i=i.concat(a.getProp(q.modelsByTypeAndTag,0,b[h],e)||[]),d&&(i=OO.simpleArrayDifference(i,d)),j=j.concat(f(b[h],e,!1));for(i=i.filter(function(a){return g(b,a)}),j=j.filter(function(a){return g(b,a)}),c&&(i=i.filter(function(a){return q.registry[a]["static"].enableAboutGrouping}),j=j.filter(function(a){return q.registry[a]["static"].enableAboutGrouping})),i=i.length>0?i:j,h=0;h<i.length;h++)(null===k||q.registrationOrder[k]<q.registrationOrder[i[h]])&&(k=i[h]);return k}var j,k,l,m,n,o,p=b.nodeName.toLowerCase(),q=this;if(o=[],b.getAttribute&&(b.getAttribute("rel")&&(o=o.concat(b.getAttribute("rel").split(" "))),b.getAttribute("typeof")&&(o=o.concat(b.getAttribute("typeof").split(" "))),b.getAttribute("property")&&(o=o.concat(b.getAttribute("property").split(" ")))),o.length){if(n=h(o,p),null!==n)return n;if(n=h(o,""),null!==n)return n}for(m=a.getProp(this.modelsByTag,1,p)||[],j=0;j<m.length;j++)if(k=m[j],l=this.registry[k],null===l["static"].getMatchRdfaTypes()&&l["static"].matchFunction(b))return m[j];for(m=a.getProp(this.modelsByTypeAndTag,1,"","")||[],j=0;j<m.length;j++)if(this.registry[m[j]]["static"].matchFunction(b))return m[j];if(n=i(o,p),null!==n)return n;if(n=i(o,""),null!==n)return n;for(m=a.getProp(this.modelsByTag,0,p)||[],j=0;j<m.length;j++)if(k=m[j],l=this.registry[k],null===l["static"].getMatchRdfaTypes())return m[j];return m=a.getProp(this.modelsByTypeAndTag,0,"","")||[],m.length>0?m[0]:null},a.dm.ModelRegistry.prototype.isAnnotation=function(b){var c=this.lookup(this.matchElement(b));return(c&&c.prototype)instanceof a.dm.Annotation},a.dm.modelRegistry=new a.dm.ModelRegistry}(ve),ve.dm.NodeFactory=function(){ve.dm.NodeFactory["super"].call(this)},OO.inheritClass(ve.dm.NodeFactory,ve.dm.ModelFactory),ve.dm.NodeFactory.prototype.getDataElement=function(a,b){var c={type:a};if(Object.prototype.hasOwnProperty.call(this.registry,a))return b=ve.extendObject({},this.registry[a]["static"].defaultAttributes,b),ve.isEmptyObject(b)||(c.attributes=ve.copy(b)),c;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.getChildNodeTypes=function(a){if(Object.prototype.hasOwnProperty.call(this.registry,a))return this.registry[a]["static"].childNodeTypes;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.getParentNodeTypes=function(a){if(Object.prototype.hasOwnProperty.call(this.registry,a))return this.registry[a]["static"].parentNodeTypes;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.getSuggestedParentNodeTypes=function(a){if(Object.prototype.hasOwnProperty.call(this.registry,a))return this.registry[a]["static"].suggestedParentNodeTypes;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.canNodeHaveChildren=function(a){if(Object.prototype.hasOwnProperty.call(this.registry,a)){var b=this.registry[a]["static"].childNodeTypes;return null===b||Array.isArray(b)&&b.length>0}throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.canNodeHaveChildrenNotContent=function(a){if(Object.prototype.hasOwnProperty.call(this.registry,a))return this.canNodeHaveChildren(a)&&!this.registry[a]["static"].canContainContent&&!this.registry[a]["static"].isContent;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.isNodeWrapped=function(a){if(Object.prototype.hasOwnProperty.call(this.registry,a))return this.registry[a]["static"].isWrapped;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.canNodeContainContent=function(a){if(Object.prototype.hasOwnProperty.call(this.registry,a))return this.registry[a]["static"].canContainContent;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.canNodeTakeAnnotationType=function(a,b){if(!Object.prototype.hasOwnProperty.call(this.registry,a))throw new Error("Unknown node type: "+a);var c,d,e=this.registry[a]["static"].blacklistedAnnotationTypes;for(c=0,d=e.length;d>c;c++)if(b instanceof ve.dm.annotationFactory.lookup(e[c]))return!1;return!0},ve.dm.NodeFactory.prototype.isNodeContent=function(a){if(Object.prototype.hasOwnProperty.call(this.registry,a))return this.registry[a]["static"].isContent;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.isNodeFocusable=function(a){if(Object.prototype.hasOwnProperty.call(this.registry,a))return this.registry[a]["static"].isFocusable;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.doesNodeHaveSignificantWhitespace=function(a){if(Object.prototype.hasOwnProperty.call(this.registry,a))return this.registry[a]["static"].hasSignificantWhitespace;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.doesNodeHandleOwnChildren=function(a){if(Object.prototype.hasOwnProperty.call(this.registry,a))return this.registry[a]["static"].handlesOwnChildren;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.shouldIgnoreChildren=function(a){if(Object.prototype.hasOwnProperty.call(this.registry,a))return this.registry[a]["static"].ignoreChildren;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.isNodeInternal=function(a){if(Object.prototype.hasOwnProperty.call(this.registry,a))return this.registry[a]["static"].isInternal;throw new Error("Unknown node type: "+a)},ve.dm.nodeFactory=new ve.dm.NodeFactory,ve.dm.AnnotationFactory=function(){ve.dm.AnnotationFactory["super"].call(this)},OO.inheritClass(ve.dm.AnnotationFactory,ve.dm.ModelFactory),ve.dm.annotationFactory=new ve.dm.AnnotationFactory,ve.dm.AnnotationSet=function(a,b){this.store=a,this.storeIndexes=b||[]},ve.dm.AnnotationSet.prototype.getStore=function(){return this.store},ve.dm.AnnotationSet.prototype.clone=function(){return new ve.dm.AnnotationSet(this.getStore(),this.storeIndexes.slice(0))},ve.dm.AnnotationSet.prototype.getAnnotationsByName=function(a){return this.filter(function(b){return b.name===a})},ve.dm.AnnotationSet.prototype.getComparableAnnotations=function(a){return this.filter(function(b){return ve.compare(a.getComparableObject(),b.getComparableObject())})},ve.dm.AnnotationSet.prototype.getComparableAnnotationsFromSet=function(a){return this.filter(function(b){return a.containsComparable(b)})},ve.dm.AnnotationSet.prototype.hasAnnotationWithName=function(a){return this.containsMatching(function(b){return b.name===a})},ve.dm.AnnotationSet.prototype.get=function(a){return void 0!==a?this.getStore().value(this.getIndex(a)):this.getStore().values(this.getIndexes())},ve.dm.AnnotationSet.prototype.getIndex=function(a){return this.storeIndexes[a]},ve.dm.AnnotationSet.prototype.getIndexes=function(){return this.storeIndexes},ve.dm.AnnotationSet.prototype.getLength=function(){return this.storeIndexes.length},ve.dm.AnnotationSet.prototype.isEmpty=function(){return 0===this.getLength()},ve.dm.AnnotationSet.prototype.contains=function(a){return-1!==this.offsetOf(a)},ve.dm.AnnotationSet.prototype.containsIndex=function(a){return-1!==this.getIndexes().indexOf(a)},ve.dm.AnnotationSet.prototype.containsAnyOf=function(a){var b,c,d=a.getIndexes(),e=this.getIndexes();for(b=0,c=d.length;c>b;b++)if(-1!==e.indexOf(d[b]))return!0;return!1},ve.dm.AnnotationSet.prototype.containsAllOf=function(a){var b,c,d=a.getIndexes(),e=this.getIndexes();for(b=0,c=d.length;c>b;b++)if(-1===e.indexOf(d[b]))return!1;return!0},ve.dm.AnnotationSet.prototype.offsetOf=function(a){return this.offsetOfIndex(this.store.indexOfHash(OO.getHash(a)))},ve.dm.AnnotationSet.prototype.offsetOfIndex=function(a){return this.getIndexes().indexOf(a)},ve.dm.AnnotationSet.prototype.filter=function(a,b){var c,d,e,f,g;for(b||(e=this.clone(),e.removeAll()),c=0,d=this.getLength();d>c;c++)if(f=this.getIndex(c),g=this.getStore().value(f),a(g)){if(b)return!0;e.storeIndexes.push(f)}return b?!1:e},ve.dm.AnnotationSet.prototype.containsComparable=function(a){return this.filter(function(b){return a.compareTo(b)},!0)},ve.dm.AnnotationSet.prototype.containsComparableForSerialization=function(a){return this.filter(function(b){return a.compareToForSerialization(b)},!0)},ve.dm.AnnotationSet.prototype.containsMatching=function(a){return this.filter(a,!0)},ve.dm.AnnotationSet.prototype.compareTo=function(a){var b,c=this.getIndexes().length;if(c!==a.getLength())return!1;for(b=0;c>b;b++)if(!a.containsComparable(this.get(b)))return!1;return!0},ve.dm.AnnotationSet.prototype.equalsInOrder=function(a){var b,c,d=this.getIndexes(),e=a.getIndexes();if(d.length!==e.length)return!1;for(b=0,c=d.length;c>b;b++)if(d[b]!==e[b])return!1;return!0},ve.dm.AnnotationSet.prototype.add=function(a,b){var c=this.getStore().index(a);return 0>b&&(b=this.getLength()+b),b>=this.getLength()?void this.push(a):void(this.containsIndex(c)||this.storeIndexes.splice(b,0,c))},ve.dm.AnnotationSet.prototype.addSet=function(a){this.storeIndexes=OO.simpleArrayUnion(this.getIndexes(),a.getIndexes())},ve.dm.AnnotationSet.prototype.push=function(a){this.pushIndex(this.getStore().index(a))},ve.dm.AnnotationSet.prototype.pushIndex=function(a){this.storeIndexes.push(a)},ve.dm.AnnotationSet.prototype.removeAt=function(a){if(0>a&&(a=this.getLength()+a),a>=this.getLength())throw new Error("Offset out of bounds");this.storeIndexes.splice(a,1)},ve.dm.AnnotationSet.prototype.removeIndex=function(a){var b=this.offsetOfIndex(a);-1!==b&&this.storeIndexes.splice(b,1)},ve.dm.AnnotationSet.prototype.remove=function(a){var b=this.offsetOf(a);-1!==b&&this.storeIndexes.splice(b,1)},ve.dm.AnnotationSet.prototype.removeAll=function(){this.storeIndexes=[]},ve.dm.AnnotationSet.prototype.removeSet=function(a){this.storeIndexes=OO.simpleArrayDifference(this.getIndexes(),a.getIndexes())},ve.dm.AnnotationSet.prototype.removeNotInSet=function(a){this.storeIndexes=OO.simpleArrayIntersection(this.getIndexes(),a.getIndexes())},ve.dm.AnnotationSet.prototype.reversed=function(){var a=this.clone();return a.storeIndexes.reverse(),a},ve.dm.AnnotationSet.prototype.mergeWith=function(a){var b=this.clone();return b.addSet(a),b},ve.dm.AnnotationSet.prototype.diffWith=function(a){var b=this.clone();return b.removeSet(a),b},ve.dm.AnnotationSet.prototype.intersectWith=function(a){var b=this.clone();return b.removeNotInSet(a),b},ve.dm.MetaItemFactory=function(){ve.dm.MetaItemFactory["super"].call(this)},OO.inheritClass(ve.dm.MetaItemFactory,ve.dm.ModelFactory),ve.dm.MetaItemFactory.prototype.getGroup=function(a){if(Object.prototype.hasOwnProperty.call(this.registry,a))return this.registry[a]["static"].group;throw new Error("Unknown item type: "+a)},ve.dm.metaItemFactory=new ve.dm.MetaItemFactory,ve.dm.ClassAttributeNode=function(){},OO.initClass(ve.dm.ClassAttributeNode),ve.dm.ClassAttributeNode["static"].classAttributes={},ve.dm.ClassAttributeNode["static"].setClassAttributes=function(a,b){var c,d,e,f=[],g=b?b.trim().split(/\s+/):[];if(g.length){for(d=0,e=g.length;e>d;d++)c=g[d],Object.prototype.hasOwnProperty.call(this.classAttributes,c)?a=ve.extendObject(a,this.classAttributes[c]):f.push(c);a.originalClasses=b,a.unrecognizedClasses=f}},ve.dm.ClassAttributeNode["static"].getClassAttrFromAttributes=function(a){var b,c,d,e,f=[];for(b in this.classAttributes){d=this.classAttributes[b],e=!0;for(c in d)if(a[c]!==d[c]){e=!1;break}e&&f.push(b)}return a.unrecognizedClasses&&(f=OO.simpleArrayUnion(f,a.unrecognizedClasses)),a.originalClasses&&ve.compareClassLists(a.originalClasses,f)?a.originalClasses:f.length>0?f.join(" "):null},ve.dm.AlignableNode=function(){ve.dm.AlignableNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.AlignableNode,ve.dm.ClassAttributeNode),ve.dm.AlignableNode["static"].isAlignable=!0,ve.dm.AlignableNode["static"].classAttributes={"ve-align-left":{align:"left"},"ve-align-right":{align:"right"},"ve-align-center":{align:"center"}},ve.dm.FocusableNode=function(){},OO.initClass(ve.dm.FocusableNode),ve.dm.FocusableNode["static"].isFocusable=!0,ve.dm.Scalable=function(a){a=ve.extendObject({fixedRatio:!0,enforceMin:!0,enforceMax:!0},a),OO.EventEmitter.call(this),this.ratio=null,this.valid=null,this.defaultSize=!1,this.currentDimensions=null,this.defaultDimensions=null,this.originalDimensions=null,this.minDimensions=null,this.maxDimensions=null,this.fixedRatio=a.fixedRatio,a.currentDimensions&&this.setCurrentDimensions(a.currentDimensions),a.originalDimensions&&this.setOriginalDimensions(a.originalDimensions),a.defaultDimensions&&this.setDefaultDimensions(a.defaultDimensions),a.isDefault&&this.toggleDefault(!!a.isDefault),a.minDimensions&&this.setMinDimensions(a.minDimensions),a.maxDimensions&&this.setMaxDimensions(a.maxDimensions),this.setEnforcedMin(a.enforceMin),this.setEnforcedMax(a.enforceMax)},OO.mixinClass(ve.dm.Scalable,OO.EventEmitter),ve.dm.Scalable["static"].getDimensionsFromValue=function(a,b){return a=ve.copy(a),""===a.width&&(a.width=0),""===a.height&&(a.height=0),!a.height&&null!==b&&$.isNumeric(a.width)&&(a.height=Math.round(a.width/b)),!a.width&&null!==b&&$.isNumeric(a.height)&&(a.width=Math.round(a.height*b)),a},ve.dm.Scalable.prototype.clone=function(){var a=this.getCurrentDimensions(),b=this.getOriginalDimensions(),c=this.getDefaultDimensions(),d=this.getMinDimensions(),e=this.getMaxDimensions(),f={isDefault:!!this.isDefault(),enforceMin:!!this.isEnforcedMin(),enforceMax:!!this.isEnforcedMax()};return a&&(f.currentDimensions=ve.copy(a)),b&&(f.originalDimensions=ve.copy(b)),c&&(f.defaultDimensions=ve.copy(c)),d&&(f.minDimensions=ve.copy(d)),e&&(f.maxDimensions=ve.copy(e)),new this.constructor(f)},ve.dm.Scalable.prototype.setRatioFromDimensions=function(a){a&&a.width&&a.height&&(this.ratio=a.width/a.height),this.valid=null},ve.dm.Scalable.prototype.setCurrentDimensions=function(a){this.isDimensionsObjectValid(a)&&!ve.compare(a,this.getCurrentDimensions())&&(this.currentDimensions=ve.copy(a),this.fixedRatio&&!this.ratio&&this.setRatioFromDimensions(this.getCurrentDimensions()),this.valid=null,this.emit("currentSizeChange",this.getCurrentDimensions()))},ve.dm.Scalable.prototype.setOriginalDimensions=function(a){this.isDimensionsObjectValid(a)&&!ve.compare(a,this.getOriginalDimensions())&&(this.originalDimensions=ve.copy(a),this.fixedRatio&&this.setRatioFromDimensions(this.getOriginalDimensions()),this.valid=null,this.emit("originalSizeChange",this.getOriginalDimensions()))},ve.dm.Scalable.prototype.setDefaultDimensions=function(a){this.isDimensionsObjectValid(a)&&!ve.compare(a,this.getDefaultDimensions())&&(this.defaultDimensions=ve.copy(a),this.valid=null,this.emit("defaultSizeChange",this.isDefault()))},ve.dm.Scalable.prototype.clearDefaultDimensions=function(){this.defaultDimensions=null,this.valid=null,this.emit("defaultSizeChange",this.isDefault())},ve.dm.Scalable.prototype.clearOriginalDimensions=function(){this.originalDimensions=null,this.valid=null,this.emit("originalSizeChange",this.isDefault())},ve.dm.Scalable.prototype.toggleDefault=function(a){void 0===a&&(a=!this.isDefault()),this.isDefault()!==a&&(this.defaultSize=a,a&&this.setCurrentDimensions(this.getDefaultDimensions()),this.emit("defaultSizeChange",this.isDefault()))},ve.dm.Scalable.prototype.setMinDimensions=function(a){this.isDimensionsObjectValid(a)&&!ve.compare(a,this.getMinDimensions())&&(this.minDimensions=ve.copy(a),this.valid=null,this.emit("minSizeChange",a))},ve.dm.Scalable.prototype.setMaxDimensions=function(a){this.isDimensionsObjectValid(a)&&!ve.compare(a,this.getMaxDimensions())&&(this.maxDimensions=ve.copy(a),this.emit("maxSizeChange",a),this.valid=null)},ve.dm.Scalable.prototype.clearMinDimensions=function(){null!==this.minDimensions&&(this.minDimensions=null,this.valid=null,this.emit("minSizeChange",this.minDimensions))},ve.dm.Scalable.prototype.clearMaxDimensions=function(){null!==this.maxDimensions&&(this.maxDimensions=null,this.valid=null,this.emit("maxSizeChange",this.maxDimensions))},ve.dm.Scalable.prototype.getCurrentDimensions=function(){return this.currentDimensions},ve.dm.Scalable.prototype.getOriginalDimensions=function(){return this.originalDimensions},ve.dm.Scalable.prototype.getDefaultDimensions=function(){return this.defaultDimensions},ve.dm.Scalable.prototype.isDefault=function(){return this.defaultSize},ve.dm.Scalable.prototype.getMinDimensions=function(){return this.minDimensions},ve.dm.Scalable.prototype.getMaxDimensions=function(){return this.maxDimensions},ve.dm.Scalable.prototype.isEnforcedMin=function(){return this.enforceMin},ve.dm.Scalable.prototype.isEnforcedMax=function(){return this.enforceMax},ve.dm.Scalable.prototype.setEnforcedMin=function(a){this.valid=null,this.enforceMin=!!a},ve.dm.Scalable.prototype.setEnforcedMax=function(a){this.valid=null,this.enforceMax=!!a},ve.dm.Scalable.prototype.getRatio=function(){return this.ratio},ve.dm.Scalable.prototype.isFixedRatio=function(){return this.fixedRatio},ve.dm.Scalable.prototype.getCurrentScale=function(){return this.isFixedRatio()&&this.getCurrentDimensions()&&this.getOriginalDimensions()?this.getCurrentDimensions().width/this.getOriginalDimensions().width:null},ve.dm.Scalable.prototype.isTooSmall=function(){return!!(this.getCurrentDimensions()&&this.getMinDimensions()&&(this.getCurrentDimensions().width<this.getMinDimensions().width||this.getCurrentDimensions().height<this.getMinDimensions().height))},ve.dm.Scalable.prototype.isTooLarge=function(){return!!(this.getCurrentDimensions()&&this.getMaxDimensions()&&(this.getCurrentDimensions().width>this.getMaxDimensions().width||this.getCurrentDimensions().height>this.getMaxDimensions().height))},ve.dm.Scalable.prototype.getBoundedDimensions=function(a,b){var c,d,e,f,g=this.isEnforcedMin()&&this.getMinDimensions(),h=this.isEnforcedMax()&&this.getMaxDimensions();return a=ve.copy(a),g&&(a.width=Math.max(a.width,this.minDimensions.width),a.height=Math.max(a.height,this.minDimensions.height)),h&&(a.width=Math.min(a.width,this.maxDimensions.width),a.height=Math.min(a.height,this.maxDimensions.height)),this.isFixedRatio()&&(c=a.width/a.height,c<this.getRatio()?a.height=Math.round(a.width/this.getRatio()):a.width=Math.round(a.height*this.getRatio())),b&&(e=g?Math.ceil(g.width/b):-1/0,f=h?Math.floor(h.width/b):1/0,d=Math.round(a.width/b),a.width=Math.max(Math.min(d,f),e)*b,this.isFixedRatio()?a.height=Math.round(a.width/this.getRatio()):(e=g?Math.ceil(g.height/b):-1/0,f=h?Math.floor(h.height/b):1/0,d=Math.round(a.height/b),a.height=Math.max(Math.min(d,f),e)*b)),a},ve.dm.Scalable.prototype.isCurrentDimensionsValid=function(){var a=this.getCurrentDimensions(),b=this.isEnforcedMin()&&!$.isEmptyObject(this.getMinDimensions())&&this.getMinDimensions(),c=this.isEnforcedMax()&&!$.isEmptyObject(this.getMaxDimensions())&&this.getMaxDimensions();return this.valid=$.isNumeric(a.width)&&$.isNumeric(a.height)&&(!b||a.width>=b.width&&a.height>=b.height)&&(!c||a.width<=c.width&&a.height<=c.height),this.valid},ve.dm.Scalable.prototype.isDimensionsObjectValid=function(a){return!a||$.isEmptyObject(a)||void 0===a.width&&void 0===a.height?!1:!0},ve.dm.APIResultsProvider=function(a,b){b=b||{},this.setAPIurl(a),this.setDefaultFetchLimit(b.fetchLimit||30),this.setLang(b.lang),this.setOffset(b.offset||0),this.setAjaxSettings(b.ajaxSettings||{}),this.staticParams=b.staticParams||{},this.userParams=b.userParams||{},this.toggleDepleted(!1),OO.EventEmitter.call(this)},OO.mixinClass(ve.dm.APIResultsProvider,OO.EventEmitter),ve.dm.APIResultsProvider.prototype.getResults=function(){var a,b=$.Deferred(),c=$.extend({},this.getStaticParams(),this.getUserParams());return a=$.getJSON(this.getAPIurl(),c).done(function(a){"array"!==$.type(a)||"array"===$.type(a)&&0===a.length?b.resolve():b.resolve(a)}),b.promise({abort:a.abort})},ve.dm.APIResultsProvider.prototype.setAPIurl=function(a){this.apiurl=a},ve.dm.APIResultsProvider.prototype.getAPIurl=function(){return this.apiurl},ve.dm.APIResultsProvider.prototype.getStaticParams=function(){return this.staticParams},ve.dm.APIResultsProvider.prototype.getUserParams=function(){return this.userParams},ve.dm.APIResultsProvider.prototype.setUserParams=function(a){ve.compare(a,this.userParams,!0)||(this.userParams=$.extend({},this.userParams,a),this.setOffset(0),this.toggleDepleted(!1))},ve.dm.APIResultsProvider.prototype.getDefaultFetchLimit=function(){return this.limit},ve.dm.APIResultsProvider.prototype.setDefaultFetchLimit=function(a){this.limit=a},ve.dm.APIResultsProvider.prototype.getLang=function(){return this.lang},ve.dm.APIResultsProvider.prototype.setLang=function(a){this.lang=a},ve.dm.APIResultsProvider.prototype.getOffset=function(){return this.offset},ve.dm.APIResultsProvider.prototype.setOffset=function(a){this.offset=a},ve.dm.APIResultsProvider.prototype.isDepleted=function(){return this.depleted},ve.dm.APIResultsProvider.prototype.toggleDepleted=function(a){this.depleted=void 0!==a?a:!this.depleted},ve.dm.APIResultsProvider.prototype.getAjaxSettings=function(){return this.ajaxSettings},ve.dm.APIResultsProvider.prototype.setAjaxSettings=function(a){this.ajaxSettings=a},ve.dm.APIResultsQueue=function(a){a=a||{},this.fileRepoPromise=null,this.providers=[],this.providerPromises=[],this.queue=[],this.params={},this.limit=a.limit||20,this.setThreshold(a.threshold||10),OO.EventEmitter.call(this)},OO.mixinClass(ve.dm.APIResultsQueue,OO.EventEmitter),ve.dm.APIResultsQueue.prototype.setup=function(){return $.Deferred().resolve().promise({abort:$.noop})},ve.dm.APIResultsQueue.prototype.get=function(a){var b=null,c=this;return a=a||this.limit,this.queue.length<a+this.threshold&&(b=this.queryProviders(a+this.threshold).then(function(a){c.queue=c.queue.concat.apply(c.queue,a)})),$.when(b).then(function(){return c.queue.splice(0,a)})},ve.dm.APIResultsQueue.prototype.queryProviders=function(a){var b,c,d=this;return this.setup().then(function(){for(b=0,c=d.providerPromises.length;c>b;b++)d.providerPromises[b].abort();for(d.providerPromises=[],b=0,c=d.providers.length;c>b;b++)d.providers[b].isDepleted()||d.providerPromises.push(d.providers[b].getResults(a));return $.when.apply($,d.providerPromises).then(Array.prototype.concat.bind([]))})},ve.dm.APIResultsQueue.prototype.setParams=function(a){var b,c;if(!ve.compare(a,this.params,!0)){for(this.params=ve.extendObject(this.params,a),this.queue=[],b=0,c=this.providerPromises.length;c>b;b++)this.providerPromises[b].abort();for(b=0,c=this.providers.length;c>b;b++)this.providers[b].setUserParams(this.params)}},ve.dm.APIResultsQueue.prototype.getParams=function(){return this.params},ve.dm.APIResultsQueue.prototype.setProviders=function(a){this.providers=a},ve.dm.APIResultsQueue.prototype.addProvider=function(a){this.providers.push(a)},ve.dm.APIResultsQueue.prototype.getProviders=function(){return this.providers},ve.dm.APIResultsQueue.prototype.getQueueSize=function(){return this.queue.length},ve.dm.APIResultsQueue.prototype.setThreshold=function(a){this.threshold=a},ve.dm.APIResultsQueue.prototype.getThreshold=function(){return this.threshold},ve.dm.ResizableNode=function(){this.scalable=null,this.connect(this,{attributeChange:"onResizableAttributeChange"})},OO.initClass(ve.dm.ResizableNode),ve.dm.ResizableNode.prototype.getScalable=function(){return this.scalable||(this.scalable=this.createScalable()),this.scalable},ve.dm.ResizableNode.prototype.createScalable=null,ve.dm.ResizableNode.prototype.onResizableAttributeChange=function(a){("width"===a||"height"===a)&&this.getScalable().setCurrentDimensions({width:this.getAttribute("width"),height:this.getAttribute("height")})},ve.dm.Node=function(a){ve.dm.Model.call(this,a),ve.Node.call(this),OO.EventEmitter.call(this),this.length=0,this.element=a,this.doc=void 0},OO.inheritClass(ve.dm.Node,ve.dm.Model),OO.mixinClass(ve.dm.Node,ve.Node),OO.mixinClass(ve.dm.Node,OO.EventEmitter),ve.dm.Node["static"].handlesOwnChildren=!1,ve.dm.Node["static"].ignoreChildren=!1,ve.dm.Node["static"].isInternal=!1,ve.dm.Node["static"].isWrapped=!0,ve.dm.Node["static"].isContent=!1,ve.dm.Node["static"].isFocusable=!1,ve.dm.Node["static"].isAlignable=!1,ve.dm.Node["static"].canContainContent=!1,ve.dm.Node["static"].hasSignificantWhitespace=!1,ve.dm.Node["static"].childNodeTypes=null,ve.dm.Node["static"].parentNodeTypes=null,ve.dm.Node["static"].suggestedParentNodeTypes=null,ve.dm.Node["static"].blacklistedAnnotationTypes=[],ve.dm.Node["static"].defaultAttributes={},ve.dm.Node["static"].remapStoreIndexes=function(){},ve.dm.Node["static"].remapInternalListIndexes=function(){},ve.dm.Node["static"].remapInternalListKeys=function(){},ve.dm.Node["static"].isHybridInline=function(a,b){var c,d,e=!0;for(c=0,d=a.length;d>c;c++)if(ve.isBlockElement(a[c])){e=!1;break}return b.isExpectingContent()&&!b.isInWrapper()||b.isInWrapper()&&!b.canCloseWrapper()||e},ve.dm.Node["static"].cloneElement=function(a,b){var c=ve.copy(a);return!b&&c.internal&&(delete c.internal.generated,ve.isEmptyObject(c.internal)&&delete c.internal),c},ve.dm.Node.prototype.getClonedElement=function(a){return this.constructor["static"].cloneElement(this.element,a)},ve.dm.Node.prototype.getChildNodeTypes=function(){return this.constructor["static"].childNodeTypes},ve.dm.Node.prototype.getParentNodeTypes=function(){return this.constructor["static"].parentNodeTypes},ve.dm.Node.prototype.getSuggestedParentNodeTypes=function(){return this.constructor["static"].suggestedParentNodeTypes},ve.dm.Node.prototype.canHaveChildren=function(){var a=this.constructor["static"].childNodeTypes;
return null===a||Array.isArray(a)&&a.length>0},ve.dm.Node.prototype.canHaveChildrenNotContent=function(){return this.canHaveChildren()&&!this.constructor["static"].canContainContent&&!this.constructor["static"].isContent},ve.dm.Node.prototype.isInternal=function(){return this.constructor["static"].isInternal},ve.dm.Node.prototype.isWrapped=function(){return this.constructor["static"].isWrapped},ve.dm.Node.prototype.canContainContent=function(){return this.constructor["static"].canContainContent},ve.dm.Node.prototype.isContent=function(){return this.constructor["static"].isContent},ve.dm.Node.prototype.isFocusable=function(){return this.constructor["static"].isFocusable},ve.dm.Node.prototype.isAlignable=function(){return this.constructor["static"].isAlignable},ve.dm.Node.prototype.canHaveSlugBefore=function(){return!this.canContainContent()&&null===this.getParentNodeTypes()},ve.dm.Node.prototype.canHaveSlugAfter=ve.dm.Node.prototype.canHaveSlugBefore,ve.dm.Node.prototype.hasSignificantWhitespace=function(){return this.constructor["static"].hasSignificantWhitespace},ve.dm.Node.prototype.handlesOwnChildren=function(){return this.constructor["static"].handlesOwnChildren},ve.dm.Node.prototype.shouldIgnoreChildren=function(){return this.constructor["static"].ignoreChildren},ve.dm.Node.prototype.hasMatchingAncestor=function(a,b){for(var c=this;c&&!c.matches(a,b);)if(c=c.getParent(),null===c)return!1;return!0},ve.dm.Node.prototype.matches=function(a,b){var c;if(this.getType()!==a)return!1;if(b)for(c in b)if(this.getAttribute(c)!==b[c])return!1;return!0},ve.dm.Node.prototype.getLength=function(){return this.length},ve.dm.Node.prototype.setLength=function(a){if(0>a)throw new Error("Length cannot be negative");var b=a-this.length;this.length=a,this.parent&&this.parent.adjustLength(b),this.emit("lengthChange",b),this.emit("update")},ve.dm.Node.prototype.adjustLength=function(a){this.setLength(this.length+a)},ve.dm.Node.prototype.getOffset=function(){var a,b,c,d;if(!this.parent)return 0;for(c=this.parent.children,d=this.parent.getOffset()+(this.parent===this.root?0:1),a=0,b=c.length;b>a&&c[a]!==this;a++)d+=c[a].getOuterLength();if(a===b)throw new Error("Node not found in parent's children array");return d},ve.dm.Node.prototype.canBeMergedWith=function(a){var b=this,c=a;for(b.canContainContent()&&c.isContent()?c=c.getParent():c.canContainContent()&&b.isContent()&&(b=b.getParent());b!==c;){if(null===b||null===c||b.getType()!==c.getType())return!1;b=b.getParent(),c=c.getParent()}return!0},ve.dm.Node.prototype.isResilient=function(){var a=this.getOriginalDomElements()[0];return a&&"resilient"===a.dataset.mode},ve.dm.BranchNode=function(a,b){ve.BranchNode.call(this),ve.dm.Node.call(this,a),this.slugPositions={},Array.isArray(b)&&b.length&&this.splice.apply(this,[0,0].concat(b))},OO.inheritClass(ve.dm.BranchNode,ve.dm.Node),OO.mixinClass(ve.dm.BranchNode,ve.BranchNode),ve.dm.BranchNode.prototype.push=function(a){return this.splice(this.children.length,0,a),this.children.length},ve.dm.BranchNode.prototype.pop=function(){if(this.children.length){var a=this.children[this.children.length-1];return this.splice(this.children.length-1,1),a}},ve.dm.BranchNode.prototype.unshift=function(a){return this.splice(0,0,a),this.children.length},ve.dm.BranchNode.prototype.shift=function(){if(this.children.length){var a=this.children[0];return this.splice(0,1),a}},ve.dm.BranchNode.prototype.splice=function(){var a,b,c,d=Array.prototype.slice.call(arguments),e=0;for(c=this.children.splice.apply(this.children,d),a=0,b=c.length;b>a;a++)c[a].detach(),e-=c[a].getOuterLength();if(d.length>=3)for(b=d.length,a=2;b>a;a++)d[a].attach(this),e+=d[a].getOuterLength();return this.adjustLength(e,!0),this.setupBlockSlugs(),this.emit.apply(this,["splice"].concat(d)),c},ve.dm.BranchNode.prototype.setupBlockSlugs=function(){var a,b,c=this.canHaveChildrenNotContent();if(this.slugPositions={},!c||this.isAllowedChildNodeType("paragraph"))if(0===this.getLength()||1===this.children.length&&this.children[0].isInternal())this.slugPositions[0]=!0;else for(a=0,b=this.children.length;b>a;a++)this.children[a].isInternal()||(0===a&&this.children[a].canHaveSlugBefore()&&(this.slugPositions[a]=!0),this.children[a].canHaveSlugAfter()&&(a===this.children.length-1||this.children[a+1]&&this.children[a+1].canHaveSlugBefore())&&(this.slugPositions[a+1]=!0))},ve.dm.BranchNode.prototype.hasSlugAtOffset=function(a){var b,c=this.getOffset()+(this.isWrapped()?1:0);if(a===c)return!!this.slugPositions[0];for(b=0;b<this.children.length;b++)if(c+=this.children[b].getOuterLength(),a===c)return!!this.slugPositions[b+1];return!1},ve.dm.ContentBranchNode=function(){ve.dm.ContentBranchNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.ContentBranchNode,ve.dm.BranchNode),ve.dm.ContentBranchNode["static"].canContainContent=!0,ve.dm.LeafNode=function(a){ve.LeafNode.call(this),ve.dm.Node.call(this,a)},OO.inheritClass(ve.dm.LeafNode,ve.dm.Node),OO.mixinClass(ve.dm.LeafNode,ve.LeafNode),ve.dm.LeafNode["static"].childNodeTypes=[],ve.dm.LeafNode.prototype.getAnnotations=function(){return this.element.annotations||[]},ve.dm.Annotation=function(a){ve.dm.Model.call(this,a),this.name=this.constructor["static"].name},OO.inheritClass(ve.dm.Annotation,ve.dm.Model),ve.dm.Annotation["static"].enableAboutGrouping=!1,ve.dm.Annotation["static"].applyToAppendedContent=!0,ve.dm.Annotation["static"].splitOnWordbreak=!1,ve.dm.Annotation["static"].removes=[],ve.dm.Annotation["static"].toDomElements=null,ve.dm.Annotation["static"].getHashObject=function(a){return{type:a.type,attributes:a.attributes,originalDomElements:a.originalDomElements&&a.originalDomElements[0].cloneNode(!1).outerHTML}},ve.dm.Annotation.prototype.getDomElements=function(a){return this.constructor["static"].toDomElements(this.element,a||document)},ve.dm.Annotation.prototype.getComparableObject=function(){var a=this.getHashObject();return delete a.originalDomElements,a},ve.dm.Annotation.prototype.getComparableHtmlAttributes=function(){var a,b=this.getOriginalDomElements();return b[0]?(a=ve.getDomAttributes(b[0]),delete a["data-parsoid"],a):{}},ve.dm.Annotation.prototype.getComparableObjectForSerialization=function(){var a=this.getComparableObject(),b=this.getComparableHtmlAttributes();return ve.isEmptyObject(b)||(a.htmlAttributes=b),a},ve.dm.Annotation.prototype.isGenerated=function(){return this.getOriginalDomElements().length>0},ve.dm.Annotation.prototype.compareTo=function(a){return ve.compare(this.getComparableObject(),a.getComparableObject())},ve.dm.Annotation.prototype.compareToForSerialization=function(a){return this.isGenerated()&&a.isGenerated()?ve.compare(this.getHashObject(),a.getHashObject()):ve.compare(this.getComparableObjectForSerialization(),a.getComparableObjectForSerialization())},ve.dm.InternalList=function(a){OO.EventEmitter.call(this),this.document=a,this.itemHtmlQueue=[],this.listNode=null,this.nodes={},this.groupsChanged=[],this.keyIndexes={},this.keys=[],this.nextUniqueNumber=0,a&&a.connect(this,{transact:"onTransact"})},OO.mixinClass(ve.dm.InternalList,OO.EventEmitter),ve.dm.InternalList.prototype.queueItemHtml=function(a,b,c){var d=!1,e=this.getKeyIndex(a,b);return void 0===e?(e=this.itemHtmlQueue.length,this.keyIndexes[a+"/"+b]=e,this.itemHtmlQueue.push(c),d=!0):""===this.itemHtmlQueue[e]&&(this.itemHtmlQueue[e]=c,d=!0),{index:e,isNew:d}},ve.dm.InternalList.prototype.getItemHtmlQueue=function(){return this.itemHtmlQueue},ve.dm.InternalList.prototype.getDocument=function(){return this.document},ve.dm.InternalList.prototype.getListNode=function(){var a,b;if(!this.listNode||!this.listNode.doc)for(b=this.getDocument().getDocumentNode().children,a=b.length;a>=0;a--)if(b[a]instanceof ve.dm.InternalListNode){this.listNode=b[a];break}return this.listNode},ve.dm.InternalList.prototype.getItemNodeCount=function(){return this.getListNode().children.length},ve.dm.InternalList.prototype.getItemNode=function(a){return this.getListNode().children[a]},ve.dm.InternalList.prototype.getNodeGroups=function(){return this.nodes},ve.dm.InternalList.prototype.getNodeGroup=function(a){return this.nodes[a]},ve.dm.InternalList.prototype.getUniqueListKey=function(a,b,c){var d=this.getNodeGroup(a),e=0;if(void 0!==d.uniqueListKeys[b])return d.uniqueListKeys[b];for(;d.keyedNodes[c+e]||d.uniqueListKeysInUse[c+e];)e++;return d.uniqueListKeys[b]=c+e,d.uniqueListKeysInUse[c+e]=!0,c+e},ve.dm.InternalList.prototype.getNextUniqueNumber=function(){return this.nextUniqueNumber++},ve.dm.InternalList.prototype.convertToData=function(a,b){var c,d,e,f,g=this.getItemHtmlQueue(),h=[];for(h.push({type:"internalList"}),c=0,d=g.length;d>c;c++)""!==g[c]?(f=b.createElement("div"),f.innerHTML=g[c],e=a.getDataFromDomSubtree(f),h=h.concat([{type:"internalItem",attributes:{originalHtml:g[c]}}],e,[{type:"/internalItem"}])):h=h.concat([{type:"internalItem"},{type:"/internalItem"}]);return h.push({type:"/internalList"}),this.itemHtmlQueue=[],h},ve.dm.InternalList.prototype.getItemInsertion=function(a,b,c){var d,e,f=this.getKeyIndex(a,b);return void 0===f?(f=this.getItemNodeCount(),this.keyIndexes[a+"/"+b]=f,e=[{type:"internalItem"}].concat(c,[{type:"/internalItem"}]),d=ve.dm.Transaction.newFromInsertion(this.getDocument(),this.getListNode().getRange().end,e)):d=null,{transaction:d,index:f}},ve.dm.InternalList.prototype.getIndexPosition=function(a,b){return this.nodes[a].indexOrder.indexOf(b)},ve.dm.InternalList.prototype.getKeyIndex=function(a,b){return this.keyIndexes[a+"/"+b]},ve.dm.InternalList.prototype.addNode=function(a,b,c,d){var e,f,g,h,i=this.nodes[a];if(void 0===i&&(i=this.nodes[a]={keyedNodes:{},firstNodes:[],indexOrder:[],uniqueListKeys:{},uniqueListKeysInUse:{}}),h=i.keyedNodes[b],this.keys[c]=b,void 0===h&&(h=i.keyedNodes[b]=[]),d.getDocument().buildingNodeTree)h.push(d),1===h.length&&(i.firstNodes[c]=d);else{for(g=d.getRange().start,e=0,f=h.length;f>e&&!(g<h[e].getRange().start);e++);h.splice(e,0,d),0===e&&(i.firstNodes[c]=d)}-1===i.indexOrder.indexOf(c)&&i.indexOrder.push(c),this.markGroupAsChanged(a)},ve.dm.InternalList.prototype.markGroupAsChanged=function(a){-1===this.groupsChanged.indexOf(a)&&this.groupsChanged.push(a)},ve.dm.InternalList.prototype.onTransact=function(){var a;if(this.groupsChanged.length>0){for(a=0;a<this.groupsChanged.length;a++)this.sortGroupIndexes(this.nodes[this.groupsChanged[a]]);this.emit("update",this.groupsChanged),this.groupsChanged=[]}},ve.dm.InternalList.prototype.removeNode=function(a,b,c,d){var e,f,g,h,i=this.nodes[a];for(h=i.keyedNodes[b],e=0,f=h.length;f>e;e++)if(h[e]===d){h.splice(e,1),0===e&&(i.firstNodes[c]=h[0]);break}0===h.length&&(delete i.keyedNodes[b],delete i.firstNodes[c],g=i.indexOrder.indexOf(c),i.indexOrder.splice(g,1)),this.markGroupAsChanged(a)},ve.dm.InternalList.prototype.sortGroupIndexes=function(a){a.indexOrder.sort(function(b,c){return a.firstNodes[b].getRange().start-a.firstNodes[c].getRange().start})},ve.dm.InternalList.prototype.clone=function(a){var b=new this.constructor(a||this.getDocument());return b.nextUniqueNumber=this.nextUniqueNumber,b.itemHtmlQueue=ve.copy(this.itemHtmlQueue),b},ve.dm.InternalList.prototype.merge=function(a,b){var c,d,e,f=a.getItemNodeCount(),g=this.getItemNodeCount(),h=[],i={};for(c=0;b>c;c++)i[c]=c;for(c=b;f>c;c++){e=void 0;for(d in a.keyIndexes)if(a.keyIndexes[d]===c){e=d;break}void 0!==this.keyIndexes[e]?i[c]=this.keyIndexes[e]:(i[c]=g,void 0!==e&&(this.keyIndexes[e]=g),g++,h.push(a.getItemNode(c).getOuterRange()))}return{mapping:i,newItemRanges:h}},ve.dm.MetaItem=function(a){ve.dm.Model.call(this,a),OO.EventEmitter.call(this),this.list=null,this.offset=null,this.index=null,this.move=null},OO.inheritClass(ve.dm.MetaItem,ve.dm.Model),OO.mixinClass(ve.dm.MetaItem,OO.EventEmitter),ve.dm.MetaItem["static"].group="misc",ve.dm.MetaItem.prototype.remove=function(){if(!this.list)throw new Error("Cannot remove detached item");this.list.removeMeta(this)},ve.dm.MetaItem.prototype.replaceWith=function(a){var b=this.getOffset(),c=this.getIndex(),d=this.list;d.removeMeta(this),d.insertMeta(a,b,c)},ve.dm.MetaItem.prototype.getGroup=function(){return this.constructor["static"].group},ve.dm.MetaItem.prototype.getParentList=function(){return this.list},ve.dm.MetaItem.prototype.getOffset=function(){return this.offset},ve.dm.MetaItem.prototype.getIndex=function(){return this.index},ve.dm.MetaItem.prototype.setOffset=function(a){this.offset=a},ve.dm.MetaItem.prototype.setIndex=function(a){this.index=a},ve.dm.MetaItem.prototype.attach=function(a,b,c){this.list=a,this.offset=b,this.index=c},ve.dm.MetaItem.prototype.detach=function(a){this.list===a&&(this.list=null,this.offset=null,this.index=null)},ve.dm.MetaItem.prototype.isAttached=function(){return null!==this.list},ve.dm.MetaList=function(a){var b,c,d,e,f,g;OO.EventEmitter.call(this),this.surface=a,this.document=a.getDocument(),this.groups={},this.items=[],this.document.connect(this,{transact:"onTransact"}),e=this.document.getMetadata();for(b in e)if(Object.prototype.hasOwnProperty.call(e,b)&&Array.isArray(e[b]))for(c=0,d=e[b].length;d>c;c++)f=ve.dm.metaItemFactory.createFromElement(e[b][c]),g=this.groups[f.getGroup()],g||(g=this.groups[f.getGroup()]=[]),f.attach(this,Number(b),c),g.push(f),this.items.push(f)},OO.mixinClass(ve.dm.MetaList,OO.EventEmitter),ve.dm.MetaList.prototype.onTransact=function(a){var b,c,d,e,f,g,h,i,j,k,l,m=this.items.length,n=0,o=0,p=0,q=0,r=0,s=[],t=[],u=[],v=a.getOperations();for(b=0,c=v.length;c>b;b++)switch(v[b].type){case"retain":for(;m>n&&this.items[n].offset<o+v[b].length;n++)s.push({item:this.items[n],offset:this.items[n].offset+p-o,index:this.items[n].offset===o?r-q+this.items[n].index:this.items[n].index});o+=v[b].length,p+=v[b].length,q=0,r=0;break;case"retainMetadata":for(;m>n&&this.items[n].offset===o&&this.items[n].index<q+v[b].length;n++)s.push({item:this.items[n],offset:p,index:this.items[n].index+r-q});q+=v[b].length,r+=v[b].length;break;case"replace":if(i=v[b].insert,j=v[b].remove,void 0!==v[b].removeMetadata){for(k=v[b].insertMetadata,l=v[b].removeMetadata;m>n&&this.items[n].offset<o+l.length;n++)t.push(this.items[n]);for(d=0,e=k.length;e>d;d++)if(k[d])for(f=0,g=k[d].length;g>f;f++)h=ve.dm.metaItemFactory.createFromElement(k[d][f]),s.push({item:h,offset:p+d,index:f})}else for(;m>n&&this.items[n].offset<o+j.length;n++)s.push({item:this.items[n],offset:this.items[n].offset+p-o,index:this.items[n].index});o+=j.length,p+=i.length;break;case"replaceMetadata":for(k=v[b].insert,l=v[b].remove;m>n&&this.items[n].offset===o&&this.items[n].index<q+l.length;n++)t.push(this.items[n]);for(d=0,e=k.length;e>d;d++)h=ve.dm.metaItemFactory.createFromElement(k[d]),s.push({item:h,offset:p,index:r+d});q+=l.length,r+=k.length}for(;m>n;n++)s.push({item:this.items[n],offset:this.items[n].offset+p-o,index:this.items[n].offset===o?r-q+this.items[n].index:this.items[n].index});for(b=0,c=t.length;c>b;b++)this.deleteRemovedItem(t[b].offset,t[b].index),u.push(["remove",t[b],t[b].offset,t[b].index]);for(b=0,c=s.length;c>b;b++)s[b].item.isAttached()&&(s[b].offset!==s[b].item.offset||s[b].index!==s[b].item.index)&&(this.deleteRemovedItem(s[b].item.offset,s[b].item.index),s[b].preExisting=!0);for(b=0,c=s.length;c>b;b++)s[b].item.isAttached()||(this.addInsertedItem(s[b].offset,s[b].index,s[b].item),s[b].preExisting||u.push(["insert",s[b].item]));for(b=0,c=u.length;c>b;b++)this.emit.apply(this,u[b])},ve.dm.MetaList.prototype.findItem=function(a,b,c,d){var e="string"==typeof c?this.groups[c]||[]:this.items;return ve.binarySearch(e,function(c){return ve.compareTuples([a,b],[c.getOffset(),c.getIndex()])},d)},ve.dm.MetaList.prototype.getItemAt=function(a,b){var c=this.findItem(a,b);return null===c?null:this.items[c]},ve.dm.MetaList.prototype.getItemsInGroup=function(a){return(this.groups[a]||[]).slice(0)},ve.dm.MetaList.prototype.getAllItems=function(){return this.items.slice(0)},ve.dm.MetaList.prototype.insertMeta=function(a,b,c){var d;a instanceof ve.dm.MetaItem&&(a=a.getElement()),void 0===b&&(b=this.document.data.getLength()),void 0===c&&(c=(this.document.metadata.getData(b)||[]).length),d=ve.dm.Transaction.newFromMetadataInsertion(this.document,b,c,[a]),this.surface.change(d)},ve.dm.MetaList.prototype.removeMeta=function(a){var b;b=ve.dm.Transaction.newFromMetadataRemoval(this.document,a.getOffset(),new ve.Range(a.getIndex(),a.getIndex()+1)),this.surface.change(b)},ve.dm.MetaList.prototype.addInsertedItem=function(a,b,c){var d=c.getGroup(),e=this.findItem(a,b,null,!0);this.items.splice(e,0,c),this.groups[d]?(e=this.findItem(a,b,d,!0),this.groups[d].splice(e,0,c)):this.groups[d]=[c],c.attach(this,a,b)},ve.dm.MetaList.prototype.deleteRemovedItem=function(a,b){var c,d,e=this.findItem(a,b);if(null!==e)return c=this.items[e],d=c.getGroup(),this.items.splice(e,1),e=this.findItem(a,b,d),null!==e&&this.groups[d].splice(e,1),c.detach(this),c},ve.dm.TableMatrix=function(a){this.tableNode=a,this.matrix=null,this.rowNodes=null},ve.dm.TableMatrix.prototype.invalidate=function(){this.matrix=null,this.rowNodes=null},ve.dm.TableMatrix.prototype.update=function(){var a,b,c,d,e,f,g,h,i=[],j=[],k=this.tableNode.getIterator(),l=-1,m=-1;for(k.on("newRow",function(a){l++,m=-1,i[l]=i[l]||[],j.push(a)});void 0!==(a=k.next());){for(m++;i[l][m];)m++;if(a){if(b=new ve.dm.TableMatrixCell(a,l,m),i[l][m]=b,c=a.getRowspan(),d=a.getColspan(),1!==c||1!==d)for(e=0;c>e;e++)for(f=0;d>f;f++)(0!==e||0!==f)&&(g=l+e,h=m+f,i[g]=i[g]||[],i[g][h]=new ve.dm.TableMatrixCell(a,g,h,b))}else i[l][m]=null}this.matrix=i,this.rowNodes=j},ve.dm.TableMatrix.prototype.getCell=function(a,b){var c=this.getMatrix();return c[a]?c[a][b]:void 0},ve.dm.TableMatrix.prototype.getColumn=function(a){var b,c,d=this.getMatrix();for(b=[],c=0;c<d.length;c++)b.push(d[c][a]);return b},ve.dm.TableMatrix.prototype.getRow=function(a){var b=this.getMatrix();return b[a]},ve.dm.TableMatrix.prototype.getRowNode=function(a){var b=this.getRowNodes();return b[a]},ve.dm.TableMatrix.prototype.getMatrix=function(){return this.matrix||this.update(),this.matrix},ve.dm.TableMatrix.prototype.getRowNodes=function(){return this.rowNodes||this.update(),this.rowNodes},ve.dm.TableMatrix.prototype.getRowCount=function(){return this.getMatrix().length},ve.dm.TableMatrix.prototype.getColCount=function(a){var b=this.getMatrix();return b.length?b[a||0].length:0},ve.dm.TableMatrix.prototype.lookupCell=function(a){var b,c,d,e,f=this.getMatrix(),g=this.getRowNodes();if(b=g.indexOf(a.getParent()),0>b)return null;for(e=f[b],c=0,d=e.length;d>c;c++)if(e[c]&&e[c].node===a)return e[c];return null},ve.dm.TableMatrix.prototype.findClosestCell=function(a){var b,c,d,e=this.getMatrix();for(d=e[a.row],b=a.col;b>=0;b--)if(!d[b].isPlaceholder())return d[b];for(b=a.col+1,c=d.length;c>b;b++)if(!d[b].isPlaceholder())return d[b];return null},ve.dm.TableMatrixCell=function(a,b,c,d){this.node=a,this.row=b,this.col=c,this.key=b+"_"+c,this.owner=d||this},OO.initClass(ve.dm.TableMatrixCell),ve.dm.TableMatrixCell["static"].sortDescending=function(a,b){return a.row!==b.row?b.row-a.row:b.col-a.col},ve.dm.TableMatrixCell.prototype.isPlaceholder=function(){return this.owner!==this},ve.dm.TableMatrixCell.prototype.getOwner=function(){return this.owner},ve.dm.TableMatrixCell.prototype.equals=function(a){return this.getOwner().key===a.getOwner().key},ve.dm.TransactionProcessor=function(a,b){this.document=a,this.transaction=b,this.operations=b.getOperations(),this.modificationQueue=[],this.rollbackQueue=[],this.synchronizer=new ve.dm.DocumentSynchronizer(a,b),this.cursor=0,this.metadataCursor=0,this.adjustment=0,this.set=new ve.dm.AnnotationSet(this.document.getStore()),this.clear=new ve.dm.AnnotationSet(this.document.getStore())},ve.dm.TransactionProcessor.modifiers={},ve.dm.TransactionProcessor.processors={},ve.dm.TransactionProcessor.prototype.nextOperation=function(){return this.operations[this.operationIndex++]||!1},ve.dm.TransactionProcessor.prototype.executeOperation=function(a){if(!Object.prototype.hasOwnProperty.call(ve.dm.TransactionProcessor.processors,a.type))throw new Error("Invalid operation error. Operation type is not supported: "+a.type);ve.dm.TransactionProcessor.processors[a.type].call(this,a)},ve.dm.TransactionProcessor.prototype.process=function(a){var b;for(this.operationIndex=0;b=this.nextOperation();)this.executeOperation(b);try{this.applyModifications()}catch(c){throw this.rollbackModifications(),c}this.transaction.markAsApplied();try{a&&a(),this.synchronizer.synchronize(this.transaction)}catch(c){throw this.rollbackModifications(),this.document.rebuildTree(),c}},ve.dm.TransactionProcessor.prototype.queueModification=function(a){if("function"!=typeof ve.dm.TransactionProcessor.modifiers[a.type])throw new Error("Unrecognized modification type "+a.type);this.modificationQueue.push(a)},ve.dm.TransactionProcessor.prototype.applyModifications=function(){var a,b,c,d=this.modificationQueue;for(this.modificationQueue=[],a=0,b=d.length;b>a;a++)c=ve.dm.TransactionProcessor.modifiers[d[a].type],this.rollbackQueue.unshift(c.apply(this,d[a].args||[]))},ve.dm.TransactionProcessor.prototype.rollbackModifications=function(){var a,b,c=this.rollbackQueue;for(this.rollbackQueue=[],a=0,b=c.length;b>a;a++)c[a]()},ve.dm.TransactionProcessor.prototype.advanceCursor=function(a){this.cursor+=a,this.metadataCursor=0},ve.dm.TransactionProcessor.prototype.applyAnnotations=function(a){function b(a,b,c){if(a.containsAnyOf(b))throw new Error("Invalid transaction, annotation to be set is already set");if(a.addSet(b),!a.containsAllOf(c))throw new Error("Invalid transaction, annotation to be cleared is not set");a.removeSet(c)}var c,d,e,f,g,h=this.document.getNodeFactory();if(!this.set.isEmpty()||!this.clear.isEmpty()){for(e=this.cursor;a>e;e++){if(c=this.document.data.isElementData(e)){if(!h.isNodeContent(this.document.data.getType(e)))throw new Error("Invalid transaction, cannot annotate a non-content element");if(this.document.data.isCloseElementData(e))continue}d=this.document.data.getAnnotationsFromOffset(e),b(d,this.set,this.clear),this.queueModification({type:"annotateData",args:[e+this.adjustment,d]})}for(e=this.cursor+1;a>e;e++)for(f=0,g=this.document.metadata.getDataLength(e);g>f;f++)d=this.document.metadata.getAnnotationsFromOffsetAndIndex(e,f),b(d,this.set,this.clear),this.queueModification({type:"annotateMetadata",args:[e+this.adjustment,f,d]});this.cursor<a&&this.synchronizer.pushAnnotation(new ve.Range(this.cursor+this.adjustment,a+this.adjustment))}},ve.dm.TransactionProcessor.modifiers.splice=function(a,b,c,d){d=d||[];var e="metadata"===a?this.document.metadata:this.document.data,f=e.batchSplice(b,c,d);return function(){e.batchSplice(b,d.length,f)}},ve.dm.TransactionProcessor.modifiers.spliceMetadataAtOffset=function(a,b,c,d){d=d||[];var e=this.document.metadata,f=e.spliceMetadataAtOffset(a,b,c,d);return function(){e.spliceMetadataAtOffset(a,b,d.length,f)}},ve.dm.TransactionProcessor.modifiers.annotateData=function(a,b){var c=this.document.data,d=c.getAnnotationsFromOffset(a);return c.setAnnotationsAtOffset(a,b),function(){c.setAnnotationsAtOffset(a,d)}},ve.dm.TransactionProcessor.modifiers.annotateMetadata=function(a,b,c){var d=this.document.metadata,e=d.getAnnotationsFromOffsetAndIndex(a,b);return d.setAnnotationsAtOffsetAndIndex(a,b,c),function(){d.setAnnotationsAtOffsetAndIndex(a,b,e)}},ve.dm.TransactionProcessor.modifiers.setAttribute=function(a,b,c){var d=this.document.data,e=d.getData(a),f=e.attributes&&e.attributes[b];return d.setAttributeAtOffset(a,b,c),function(){d.setAttributeAtOffset(a,b,f)}},ve.dm.TransactionProcessor.processors.retain=function(a){this.applyAnnotations(this.cursor+a.length),this.advanceCursor(a.length)},ve.dm.TransactionProcessor.processors.retainMetadata=function(a){this.metadataCursor+=a.length},ve.dm.TransactionProcessor.processors.annotate=function(a){var b,c;if("set"===a.method)b=this.set;else{if("clear"!==a.method)throw new Error("Invalid annotation method "+a.method);b=this.clear}c=this.document.getStore().value(a.index),"start"===a.bias?b.push(c):b.remove(c)},ve.dm.TransactionProcessor.processors.attribute=function(a){if(!this.document.data.isElementData(this.cursor))throw new Error("Invalid element error, cannot set attributes on non-element data");this.queueModification({type:"setAttribute",args:[this.cursor+this.adjustment,a.key,a.to]}),this.synchronizer.pushAttributeChange(this.document.getDocumentNode().getNodeFromOffset(this.cursor+1),a.key,a.from,a.to)},ve.dm.TransactionProcessor.processors.replace=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p=a.remove,q=a.insert,r=a.removeMetadata,s=a.insertMetadata,t=new ve.dm.ElementLinearData(this.document.getStore(),p,this.document.getNodeFactory()),u=new ve.dm.ElementLinearData(this.document.getStore(),q,this.document.getNodeFactory()),v=t.isContentData(),w=u.isContentData(),x=t.containsElementData(),y=u.containsElementData(),z=a,A=0,B=0,C=[],D=0,E=0;if(v&&w)this.queueModification({type:"splice",args:["data",this.cursor+this.adjustment,p.length,q]}),this.queueModification(void 0!==r?{type:"splice",args:["metadata",this.cursor+this.adjustment,r.length,s]}:{type:"splice",args:["metadata",this.cursor+this.adjustment,p.length,new Array(q.length)]}),c=this.document.selectNodes(new ve.Range(this.cursor,this.cursor+p.length),"leaves"),b=c[0].node,x||y||1!==c.length||!b||"text"!==b.getType()?!x&&!y&&0===p.length&&q.length>0&&1===c.length&&b&&b.canContainContent()&&(void 0!==c[0].indexInNode||0===b.getLength())?this.synchronizer.pushInsertTextNode(b,c[0].indexInNode||0,q.length-p.length):(d=new ve.Range(c[0].nodeOuterRange.start,c[c.length-1].nodeOuterRange.end),this.synchronizer.pushRebuild(d,new ve.Range(d.start+this.adjustment,d.end+this.adjustment+q.length-p.length))):this.synchronizer.pushResize(b,q.length-p.length),this.advanceCursor(p.length),this.adjustment+=q.length-p.length;else{for(;;){if("replace"===z.type){if(l=z.remove,m=z.insert,n=z.removeMetadata,o=z.insertMetadata,this.queueModification({type:"splice",args:["data",this.cursor+this.adjustment,l.length,m]}),this.queueModification(void 0!==n?{type:"splice",args:["metadata",this.cursor+this.adjustment,n.length,o]}:{type:"splice",args:["metadata",this.cursor+this.adjustment,l.length,new Array(m.length)]}),C.push(new ve.Range(this.cursor,this.cursor+l.length)),g=this.cursor,this.advanceCursor(l.length),l.length>0)for(c=this.document.selectNodes(new ve.Range(g,g+l.length),"siblings"),e=0;e<c.length;e++)C.push(c[e].nodeOuterRange);for(e=0;e<l.length;e++)f=l[e].type,void 0!==f&&("/"===f.charAt(0)?A--:A++);for(e=0;e<m.length;e++)f=m[e].type,void 0!==f&&("/"===f.charAt(0)?(B--,D>B&&(h=h||this.document.getBranchNodeFromOffset(g),j=h.getOffset(),k=j+h.getOuterLength(),C.push(new ve.Range(j,k)),h=h.getParent()||h,D--)):B++);this.adjustment+=m.length-l.length,E+=m.length-l.length}else this.executeOperation(z);if(0===A&&0===B)break;if(z=this.nextOperation(),!z)throw new Error("Unbalanced set of replace operations found")}i=ve.Range["static"].newCoveringRange(C),this.synchronizer.pushRebuild(i,new ve.Range(i.start+this.adjustment-E,i.end+this.adjustment))}},ve.dm.TransactionProcessor.processors.replaceMetadata=function(a){this.queueModification({type:"spliceMetadataAtOffset",args:[this.cursor+this.adjustment,this.metadataCursor,a.remove.length,a.insert]}),this.metadataCursor+=a.insert.length},ve.dm.Transaction=function(a){this.operations=[],this.applied=!1,this.doc=a},ve.dm.Transaction.newFromReplacement=function(a,b,c,d){var e,f=new ve.dm.Transaction(a);return e=f.pushRemoval(a,0,b,d),e=f.pushInsertion(a,e,e,c),f.pushFinalRetain(a,e),f},ve.dm.Transaction.newFromInsertion=function(a,b,c){var d=new ve.dm.Transaction(a),e=d.pushInsertion(a,0,b,c);return d.pushFinalRetain(a,e),d},ve.dm.Transaction.newFromRemoval=function(a,b,c){var d=new ve.dm.Transaction(a),e=d.pushRemoval(a,0,b,c);return d.pushFinalRetain(a,e),d},ve.dm.Transaction.newFromDocumentInsertion=function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t=a.internalList.getListNode(),u=t.getRange(),v=c.internalList.getListNode(),w=v.getRange(),x=v.getOuterRange();for(d?(i=new ve.dm.ElementLinearData(a.getStore(),c.getData(d,!0),a.getNodeFactory()),j=new ve.dm.MetaLinearData(a.getStore(),c.getMetadata(d,!0))):(i=new ve.dm.ElementLinearData(a.getStore(),c.getData(new ve.Range(0,x.start),!0).concat(c.getData(new ve.Range(x.end,c.data.getLength()),!0)),a.getNodeFactory()),j=new ve.dm.MetaLinearData(a.getStore(),c.getMetadata(new ve.Range(0,x.start),!0).concat(x.end<c.data.getLength()?c.getMetadata(new ve.Range(x.end+1,c.data.getLength()),!0):[]))),g=a.getStore().merge(c.getStore()),i.remapStoreIndexes(g),h=a.internalList.merge(c.internalList,c.origInternalListLength||0),i.remapInternalListIndexes(h.mapping,a.internalList),c.origDoc===a?(c.origInternalListLength>0?(n=a.internalList.getItemNode(c.origInternalListLength-1).getOuterRange().end,o=c.internalList.getItemNode(c.origInternalListLength-1).getOuterRange().end):(n=u.start,o=w.start),m=new ve.dm.ElementLinearData(a.getStore(),c.getData(new ve.Range(w.start,o),!0),a.getNodeFactory()),m.remapStoreIndexes(g),k=m.data.concat(a.getData(new ve.Range(n,u.end),!0)),l=c.getMetadata(new ve.Range(w.start,o),!0).concat(a.getMetadata(new ve.Range(n,u.end),!0))):(k=a.getData(u,!0),l=a.getMetadata(u,!0)),e=0,f=h.newItemRanges.length;f>e;e++)m=new ve.dm.ElementLinearData(a.getStore(),c.getData(h.newItemRanges[e],!0),a.getNodeFactory()),m.remapStoreIndexes(g),k=k.concat(m.data),l=l.concat(c.getMetadata(h.newItemRanges[e],!0));if(p=new ve.dm.Transaction(a),b<=u.start)q=a.fixupInsertion(i.data,b),p.pushRetain(q.offset),p.pushReplace(a,q.offset,q.remove,q.data,j.data),p.pushRetain(u.start-(q.offset+q.remove)),p.pushReplace(a,u.start,u.end-u.start,k,l),p.pushFinalRetain(a,u.end);else if(b>=u.end)q=a.fixupInsertion(i.data,b),p.pushRetain(u.start),p.pushReplace(a,u.start,u.end-u.start,k,l),p.pushRetain(q.offset-u.end),p.pushReplace(a,q.offset,q.remove,q.data,j.data),p.pushFinalRetain(a,q.offset+q.remove);else if(b>=u.start&&b<=u.end){for(e=0;(r=a.internalList.getItemNode(e).getRange())&&b>r.end;)e++;c.origDoc===a?(r=c.internalList.getItemNode(e).getRange(),s=w):s=u,ve.batchSplice(k,r.start-s.start,r.end-r.start,i.data),ve.batchSplice(l,r.start-s.start,r.end-r.start,j.data),p.pushRetain(u.start),p.pushReplace(a,u.start,u.end-u.start,k,l),p.pushFinalRetain(a,u.end)}return p},ve.dm.Transaction.newFromAttributeChanges=function(a,b,c){var d=new ve.dm.Transaction(a),e=a.getData();if(void 0===e[b].type)throw new Error("Cannot set attributes to non-element data");if("/"===e[b].type.charAt(0))throw new Error("Cannot set attributes on closing element");return d.pushRetain(b),d.pushAttributeChanges(c,e[b].attributes||{}),d.pushFinalRetain(a,b),d},ve.dm.Transaction.newFromAnnotation=function(a,b,c,d){for(var e,f,g,h=new ve.dm.Transaction(a),i=a.data,j=a.getStore().index(d),k=b.start,l=k,m=!1,n=!1,o=0,p=a.getNodeFactory();k<b.end;)i.isElementData(k)?(f=i.getType(k),p.shouldIgnoreChildren(f)&&(o+=i.isOpenElementData(k)?1:-1),g=p.isNodeContent(f)&&("set"!==c||p.canNodeTakeAnnotationType(f,d))?!0:!1):g=!0,g=g&&!o,!g||n&&!i.isCloseElementData(k)?m&&(h.pushRetain(l),h.pushStopAnnotating(c,j),l=0,m=!1):i.isElementData(k)&&i.isCloseElementData(k)||n?i.isCloseElementData(k)&&(n=!1):(i.isElementData(k)&&(n=!0),e="set"===c?i.getAnnotationsFromOffset(k).containsComparable(d):i.getAnnotationsFromOffset(k).contains(d),e&&"set"===c||!e&&"clear"===c?m&&(h.pushRetain(l),h.pushStopAnnotating(c,j),l=0,m=!1):m||(h.pushRetain(l),h.pushStartAnnotating(c,j),l=0,m=!0)),l++,k++;return h.pushRetain(l),m&&h.pushStopAnnotating(c,j),h.pushFinalRetain(a,b.end),h},ve.dm.Transaction.newFromMetadataInsertion=function(a,b,c,d){var e=new ve.dm.Transaction(a),f=a.metadata,g=f.getData(b)||[];return 0===d.length?e:(e.pushRetain(b),e.pushRetainMetadata(c),e.pushReplaceMetadata([],d),e.pushRetainMetadata(g.length-c),e.pushFinalRetain(a,b,g.length),e)},ve.dm.Transaction.newFromMetadataRemoval=function(a,b,c){var d,e=new ve.dm.Transaction(a),f=a.metadata,g=f.getData(b)||[];if(!g.length)throw new Error("Cannot remove metadata from empty list");
if(c.start<0||c.end>g.length)throw new Error("Range out of bounds");return d=g.slice(c.start,c.end),0===d.length?e:(e.pushRetain(b),e.pushRetainMetadata(c.start),e.pushReplaceMetadata(d,[]),e.pushRetainMetadata(g.length-c.end),e.pushFinalRetain(a,b,g.length),e)},ve.dm.Transaction.newFromMetadataElementReplacement=function(a,b,c,d){var e,f=new ve.dm.Transaction(a),g=a.getMetadata(),h=g[b]||[];if(c>=h.length)throw new Error("Metadata index out of bounds");return e=h[c],f.pushRetain(b),f.pushRetainMetadata(c),f.pushReplaceMetadata([e],[d]),f.pushRetainMetadata(h.length-c-1),f.pushFinalRetain(a,b,h.length),f},ve.dm.Transaction.newFromContentBranchConversion=function(a,b,c,d){var e,f,g,h,i,j,k=new ve.dm.Transaction(a),l=a.selectNodes(b,"leaves"),m={type:c},n={type:"/"+c};for(ve.isPlainObject(d)?m.attributes=d:d={},e=0;e<l.length;e++)if(f=l[e],g=f.node.isContent()?f.node.getParent():f.node,g.canContainContent()){if(g.getType()===c&&ve.compare(d,g.getAttributes(),!0))continue;if(h=g.getOuterRange(),g===i)continue;k.pushRetain(h.start-(i?j.end:0)),g.getType()===c?(k.pushAttributeChanges(d,g.getAttributes()),k.pushRetain(g.getOuterLength())):(k.pushReplace(a,h.start,1,[ve.copy(m)]),k.pushRetain(g.getLength()),k.pushReplace(a,h.end-1,1,[ve.copy(n)])),i=g,j=h}return k.pushFinalRetain(a,i?j.end:0),k},ve.dm.Transaction.newFromWrap=function(a,b,c,d,e,f){function g(a){var b,c=[],d=a.length;for(b=0;d>b;b++)c[c.length]={type:"/"+a[d-b-1].type};return c}var h,i,j,k,l,m,n,o=new ve.dm.Transaction(a),p=0;if(m=g(e),n=g(f),b.start>c.length)o.pushRetain(b.start-c.length);else if(b.start<c.length)throw new Error("unwrapOuter is longer than the data preceding the range");if(d.length>0||c.length>0){for(j=a.data.slice(b.start-c.length,b.start),h=0;h<j.length;h++)if(j[h].type!==c[h].type)throw new Error("Element in unwrapOuter does not match: expected "+c[h].type+" but found "+j[h].type);o.pushReplace(a,b.start-c.length,c.length,ve.copy(d))}if(f.length>0||e.length>0){for(h=b.start;h<b.end;h++)if(a.data.isElementData(h))if(a.data.isCloseElementData(h))p--,0===p&&(i=h+1-e.length,o.pushRetain(i-k),o.pushReplace(a,i,e.length,ve.copy(n)));else{if(0===p){for(l=a.data.slice(h,h+e.length),i=0;i<l.length;i++)if(l[i].type!==e[i].type)throw new Error("Element in unwrapEach does not match: expected "+e[i].type+" but found "+l[i].type);o.pushReplace(a,h,e.length,ve.copy(f)),k=h+e.length}p++}}else o.pushRetain(b.end-b.start);return o.pushReplace(a,b.end,c.length,g(d)),o.pushFinalRetain(a,b.end+c.length),o},ve.dm.Transaction.reversers={annotate:{method:{set:"clear",clear:"set"}},attribute:{from:"to",to:"from"},replace:{insert:"remove",remove:"insert",insertMetadata:"removeMetadata",removeMetadata:"insertMetadata"},replaceMetadata:{insert:"remove",remove:"insert"}},ve.dm.Transaction.prototype.clone=function(){var a=new this.constructor;return a.operations=ve.copy(this.operations),a},ve.dm.Transaction.prototype.reversed=function(){var a,b,c,d,e,f,g=new this.constructor;for(a=0,b=this.operations.length;b>a;a++){c=this.operations[a],d=ve.copy(c),e=this.constructor.reversers[c.type]||{};for(f in e)d[f]="string"==typeof e[f]?c[e[f]]:e[f][c[f]];g.operations.push(d)}return g},ve.dm.Transaction.prototype.isNoOp=function(){return 0===this.operations.length?!0:1===this.operations.length?"retain"===this.operations[0].type:2===this.operations.length?"retain"===this.operations[0].type&&"retainMetadata"===this.operations[1].type:!1},ve.dm.Transaction.prototype.getOperations=function(){return this.operations},ve.dm.Transaction.prototype.getDocument=function(){return this.doc},ve.dm.Transaction.prototype.hasOperationWithType=function(a){var b,c;for(b=0,c=this.operations.length;c>b;b++)if(this.operations[b].type===a)return!0;return!1},ve.dm.Transaction.prototype.hasContentDataOperations=function(){return this.hasOperationWithType("replace")},ve.dm.Transaction.prototype.hasElementAttributeOperations=function(){return this.hasOperationWithType("attribute")},ve.dm.Transaction.prototype.hasAnnotationOperations=function(){return this.hasOperationWithType("annotate")},ve.dm.Transaction.prototype.hasBeenApplied=function(){return this.applied},ve.dm.Transaction.prototype.markAsApplied=function(){this.applied=!0},ve.dm.Transaction.prototype.translateOffset=function(a,b){var c,d,e,f,g,h=0,i=0;for(c=0;c<this.operations.length;c++)if(d=this.operations[c],"replace"===d.type){if(e=d.insert.length,f=d.remove.length,g=i,i+=e-f,a===h+f)return b&&e>f?a+i-e+f:a+i;if(a===h)return 0===e?h+f+i:h+g;if(a>h&&h+f>a)return h+f+i;h+=f}else if("retain"===d.type){if(a>=h&&a<h+d.length)return a+i;h+=d.length}return a+i},ve.dm.Transaction.prototype.translateRange=function(a,b){var c=this.translateOffset(a.start,!b),d=this.translateOffset(a.end,b);return a.isBackwards()?new ve.Range(d,c):new ve.Range(c,d)},ve.dm.Transaction.prototype.getModifiedRange=function(){var a,b,c,d,e,f=0;for(a=0,b=this.operations.length;b>a;a++)switch(c=this.operations[a],c.type){case"retainMetadata":continue;case"retain":f+=c.length;break;default:void 0===d&&(d=f+(c.insertedDataOffset||0)),"replace"===c.type&&(f+=c.insert.length),e=c.insertedDataLength?d+c.insertedDataLength:f}return void 0===d||void 0===e?null:new ve.Range(d,e)},ve.dm.Transaction.prototype.pushFinalRetain=function(a,b,c){var d=a.data,e=a.metadata,f=e.getData(d.getLength());b<a.data.getLength()&&(this.pushRetain(a.data.getLength()-b),c=0),void 0!==f&&f.length>0&&this.pushRetainMetadata(f.length-(c||0))},ve.dm.Transaction.prototype.pushRetain=function(a){if(0>a)throw new Error("Invalid retain length, cannot retain backwards:"+a);if(a){var b=this.operations.length-1;this.operations.length&&"retain"===this.operations[b].type?this.operations[b].length+=a:this.operations.push({type:"retain",length:a})}},ve.dm.Transaction.prototype.pushRetainMetadata=function(a){if(0>a)throw new Error("Invalid retain length, cannot retain backwards:"+a);if(a){var b=this.operations.length-1;this.operations.length&&"retainMetadata"===this.operations[b].type?this.operations[b].length+=a:this.operations.push({type:"retainMetadata",length:a})}},ve.dm.Transaction.prototype.addSafeRemoveOps=function(a,b,c,d){var e,f,g=0,h=a.getNodeFactory();for(e=b;c>e;e++)a.data.isElementData(e)&&h.isNodeInternal(a.data.getType(e))&&(a.data.isCloseElementData(e)?(g--,0===g&&(this.pushRetain(e+1-f),b=e+1)):(0===g&&(this.pushReplace(a,b,e-b,[],d?[]:void 0),f=e),g++));this.pushReplace(a,b,c-b,[],d?[]:void 0)},ve.dm.Transaction.prototype.pushReplaceInternal=function(a,b,c,d,e,f){if(0!==a.length||0!==b.length){var g={type:"replace",remove:a,insert:b};void 0!==c&&void 0!==d&&(g.removeMetadata=c,g.insertMetadata=d),void 0!==e&&void 0!==f&&(g.insertedDataOffset=e,g.insertedDataLength=f),this.operations.push(g)}},ve.dm.Transaction.prototype.pushReplace=function(a,b,c,d,e,f,g){if(0!==c||0!==d.length){var h,i=this.operations.length-1,j=i>=0?this.operations[i]:null,k=i>=1?this.operations[i-1]:null,l=new ve.Range(b,b+c),m=a.getData(l),n=a.getMetadata(l),o=ve.compare(n,[]),p=e&&ve.compare(e,[]),q=[];if(e||o?p&&o&&(e=void 0):(e=ve.dm.MetaLinearData["static"].merge(n),0===d.length?(h=e[0],e=[]):ve.batchSplice(e,1,0,new Array(d.length-1)),p=ve.compare(e,new Array(e.length))),j&&"replaceMetadata"===j.type&&j.insert.length>0&&0===j.remove.length&&k&&"replace"===k.type&&0===k.insert.length&&(q=[j.insert],this.operations.pop(),j=k),!(!j||"replace"!==j.type||j.insert.length>0&&void 0!==e||void 0!==j.insertedDataOffset||h||q.length>0&&void 0!==e&&!p))return j=this.operations.pop(),void this.pushReplace(a,b-j.remove.length,j.remove.length+c,j.insert.concat(d),(j.insertMetadata||new Array(j.insert.length)).concat(q).concat(void 0===e||p?new Array(d.length-q.length):e),f,g);if(j&&"replace"===j.type&&0===j.insert.length&&0===d.length&&(void 0===j.removeMetadata||q.length>0)&&(void 0===e||h))return j=this.operations.pop(),void this.pushReplace(a,b-j.remove.length,j.remove.length+c,[]);if(j&&"replaceMetadata"===j.type)throw new Error("replace after replaceMetadata not allowed");this.pushReplaceInternal(m,d,n,e,f,g),void 0!==h&&this.pushReplaceMetadata([],h)}},ve.dm.Transaction.prototype.pushReplaceMetadata=function(a,b){(0!==a.length||0!==b.length)&&this.operations.push({type:"replaceMetadata",remove:a,insert:b})},ve.dm.Transaction.prototype.pushReplaceElementAttribute=function(a,b,c){this.operations.push({type:"attribute",key:a,from:b,to:c})},ve.dm.Transaction.prototype.pushAttributeChanges=function(a,b){var c;for(c in a)b[c]!==a[c]&&this.pushReplaceElementAttribute(c,b[c],a[c])},ve.dm.Transaction.prototype.pushStartAnnotating=function(a,b){this.operations.push({type:"annotate",method:a,bias:"start",index:b})},ve.dm.Transaction.prototype.pushStopAnnotating=function(a,b){this.operations.push({type:"annotate",method:a,bias:"stop",index:b})},ve.dm.Transaction.prototype.pushInsertion=function(a,b,c,d){var e=a.fixupInsertion(d,c);return this.pushRetain(e.offset-b),this.pushReplace(a,e.offset,e.remove,e.data,void 0,e.insertedDataOffset,e.insertedDataLength),e.offset+e.remove},ve.dm.Transaction.prototype.pushRemoval=function(a,b,c,d){var e,f,g,h,i,j,k=b,l=null,m=null;if(c.isCollapsed())return this.pushRetain(c.start-b),c.start;if(f=a.selectNodes(c,"covered"),0===f.length)throw new Error("Invalid range, cannot remove from "+c.start+" to "+c.end);if(g=f[0],h=f[f.length-1],g.node.canBeMergedWith(h.node))return g.range||h.range?(l=(g.range||(g.node.isContent()?g.nodeOuterRange:g.nodeRange)).start,m=(h.range||(h.node.isContent()?h.nodeOuterRange:h.nodeRange)).end):(l=g.nodeOuterRange.start,m=h.nodeOuterRange.end),this.pushRetain(l-b),this.addSafeRemoveOps(a,l,m,d),m;for(e=0;e<f.length;e++)f[e].range?(i=f[e].range.start,j=f[e].range.end):(i=f[e].nodeOuterRange.start,j=f[e].nodeOuterRange.end),null===m?(l=i,m=j):m===i?m=j:(this.pushRetain(l-k),this.addSafeRemoveOps(a,l,m,d),k=m,l=i,m=j);return null!==m&&(this.pushRetain(l-k),this.addSafeRemoveOps(a,l,m,d),k=m),k},ve.dm.Selection=function(a){this.documentModel=a},OO.initClass(ve.dm.Selection),ve.dm.Selection["static"].type=null,ve.dm.Selection["static"].newFromJSON=function(a,b){var c="string"==typeof b?JSON.parse(b):b,d=ve.dm.selectionFactory.lookup(c.type);if(!d)throw new Error("Unknown selection type "+c.name);return d["static"].newFromHash(a,c)},ve.dm.Selection["static"].newFromHash=null,ve.dm.Selection.prototype.toJSON=null,ve.dm.Selection.prototype.getDescription=null,ve.dm.Selection.prototype.clone=null,ve.dm.Selection.prototype.collapseToStart=null,ve.dm.Selection.prototype.collapseToEnd=null,ve.dm.Selection.prototype.collapseToFrom=null,ve.dm.Selection.prototype.collapseToTo=null,ve.dm.Selection.prototype.isCollapsed=null,ve.dm.Selection.prototype.translateByTransaction=null,ve.dm.Selection.prototype.translateByTransactions=function(a,b){var c,d,e=this;for(c=0,d=a.length;d>c;c++)e=e.translateByTransaction(a[c],b);return e},ve.dm.Selection.prototype.isNull=function(){return!1},ve.dm.Selection.prototype.getRanges=null,ve.dm.Selection.prototype.getDocument=function(){return this.documentModel},ve.dm.Selection.prototype.equals=null,ve.dm.selectionFactory=new OO.Factory,ve.dm.Surface=function(a){OO.EventEmitter.call(this),this.documentModel=a,this.metaList=new ve.dm.MetaList(this),this.selection=new ve.dm.NullSelection(this.getDocument()),this.selectionBefore=new ve.dm.NullSelection(this.getDocument()),this.translatedSelection=null,this.branchNodes={},this.selectedNode=null,this.newTransactions=[],this.stagingStack=[],this.undoStack=[],this.undoIndex=0,this.historyTrackingInterval=null,this.insertionAnnotations=new ve.dm.AnnotationSet(this.getDocument().getStore()),this.coveredAnnotations=new ve.dm.AnnotationSet(this.getDocument().getStore()),this.enabled=!0,this.transacting=!1,this.queueingContextChanges=!1,this.contextChangeQueued=!1,this.getDocument().connect(this,{transact:"onDocumentTransact",precommit:"onDocumentPreCommit",presynchronize:"onDocumentPreSynchronize"})},OO.mixinClass(ve.dm.Surface,OO.EventEmitter),ve.dm.Surface.prototype.disable=function(){this.stopHistoryTracking(),this.enabled=!1,this.emit("history")},ve.dm.Surface.prototype.enable=function(){this.enabled=!0,this.startHistoryTracking(),this.emit("history")},ve.dm.Surface.prototype.initialize=function(){this.startHistoryTracking(),this.emit("contextChange")},ve.dm.Surface.prototype.startHistoryTracking=function(){this.enabled&&null===this.historyTrackingInterval&&(this.historyTrackingInterval=setInterval(this.breakpoint.bind(this),750))},ve.dm.Surface.prototype.stopHistoryTracking=function(){this.enabled&&null!==this.historyTrackingInterval&&(clearInterval(this.historyTrackingInterval),this.historyTrackingInterval=null)},ve.dm.Surface.prototype.getHistory=function(){return this.newTransactions.length>0?this.undoStack.slice(0).concat([{transactions:this.newTransactions.slice(0)}]):this.undoStack.slice(0)},ve.dm.Surface.prototype.isStaging=function(){return this.stagingStack.length>0},ve.dm.Surface.prototype.getStaging=function(){return this.stagingStack[this.stagingStack.length-1]},ve.dm.Surface.prototype.doesStagingAllowUndo=function(){var a=this.getStaging();return a&&a.allowUndo},ve.dm.Surface.prototype.getStagingTransactions=function(){var a=this.getStaging();return a&&a.transactions},ve.dm.Surface.prototype.pushStaging=function(a){this.isStaging()||(this.breakpoint(),this.stopHistoryTracking(),this.emit("history")),this.stagingStack.push({transactions:[],selectionBefore:new ve.dm.NullSelection(this.getDocument()),allowUndo:!!a})},ve.dm.Surface.prototype.popStaging=function(){if(this.isStaging()){var a,b,c=[],d=this.stagingStack.pop(),e=d.transactions;for(a=e.length-1;a>=0;a--)b=e[a].reversed(),c.push(b);return this.changeInternal(c,void 0,!0),this.isStaging()||(this.startHistoryTracking(),this.emit("history")),e}},ve.dm.Surface.prototype.applyStaging=function(){if(this.isStaging()){var a=this.stagingStack.pop();this.isStaging()?(ve.batchPush(this.getStagingTransactions(),a.transactions),this.getStaging().selectionBefore.isNull()&&(this.getStaging().selectionBefore=a.selectionBefore)):(this.truncateUndoStack(),this.newTransactions=a.transactions,this.selectionBefore=a.selectionBefore,this.breakpoint()),this.isStaging()||(this.startHistoryTracking(),this.emit("history"))}},ve.dm.Surface.prototype.popAllStaging=function(){if(this.isStaging()){for(var a=[];this.isStaging();)ve.batchSplice(a,0,0,this.popStaging());return a}},ve.dm.Surface.prototype.applyAllStaging=function(){for(;this.isStaging();)this.applyStaging()},ve.dm.Surface.prototype.getInsertionAnnotations=function(){return this.insertionAnnotations.clone()},ve.dm.Surface.prototype.setInsertionAnnotations=function(a){this.enabled&&(this.insertionAnnotations=null!==a?a.clone():new ve.dm.AnnotationSet(this.getDocument().getStore()),this.emit("insertionAnnotationsChange",this.insertionAnnotations),this.emit("contextChange"))},ve.dm.Surface.prototype.addInsertionAnnotations=function(a){if(this.enabled){if(a instanceof ve.dm.Annotation)this.insertionAnnotations.push(a);else{if(!(a instanceof ve.dm.AnnotationSet))throw new Error("Invalid annotations");this.insertionAnnotations.addSet(a)}this.emit("insertionAnnotationsChange",this.insertionAnnotations),this.emit("contextChange")}},ve.dm.Surface.prototype.removeInsertionAnnotations=function(a){if(this.enabled){if(a instanceof ve.dm.Annotation)this.insertionAnnotations.remove(a);else{if(!(a instanceof ve.dm.AnnotationSet))throw new Error("Invalid annotations");this.insertionAnnotations.removeSet(a)}this.emit("insertionAnnotationsChange",this.insertionAnnotations),this.emit("contextChange")}},ve.dm.Surface.prototype.canRedo=function(){return this.undoIndex>0&&this.enabled},ve.dm.Surface.prototype.canUndo=function(){return this.hasBeenModified()&&this.enabled&&(!this.isStaging()||this.doesStagingAllowUndo())},ve.dm.Surface.prototype.hasBeenModified=function(){return this.undoStack.length-this.undoIndex>0||!!this.newTransactions.length},ve.dm.Surface.prototype.getDocument=function(){return this.documentModel},ve.dm.Surface.prototype.getMetaList=function(){return this.metaList},ve.dm.Surface.prototype.getSelection=function(){return this.selection},ve.dm.Surface.prototype.getTranslatedSelection=function(){return this.translatedSelection||this.selection},ve.dm.Surface.prototype.getFragment=function(a,b,c){return new ve.dm.SurfaceFragment(this,a||this.selection,b,c)},ve.dm.Surface.prototype.getLinearFragment=function(a,b,c){return new ve.dm.SurfaceFragment(this,new ve.dm.LinearSelection(this.getDocument(),a),b,c)},ve.dm.Surface.prototype.truncateUndoStack=function(){this.undoIndex&&(this.undoStack=this.undoStack.slice(0,this.undoStack.length-this.undoIndex),this.undoIndex=0,this.emit("history"))},ve.dm.Surface.prototype.startQueueingContextChanges=function(){this.queueingContextChanges||(this.queueingContextChanges=!0,this.contextChangeQueued=!1)},ve.dm.Surface.prototype.emitContextChange=function(){this.queueingContextChanges?this.contextChangeQueued=!0:this.emit("contextChange")},ve.dm.Surface.prototype.stopQueueingContextChanges=function(){this.queueingContextChanges&&(this.queueingContextChanges=!1,this.contextChangeQueued&&(this.contextChangeQueued=!1,this.emit("contextChange")))},ve.dm.Surface.prototype.setLinearSelection=function(a){this.setSelection(new ve.dm.LinearSelection(this.getDocument(),a))},ve.dm.Surface.prototype.setNullSelection=function(){this.setSelection(new ve.dm.NullSelection(this.getDocument()))},ve.dm.Surface.prototype.setSelection=function(a){var b,c,d,e,f,g,h,i,j,k={},l=!1,m=!1,n=this.getDocument().data;if(this.enabled){if(this.translatedSelection=null,this.transacting)return void(this.selection=a);this.selection.equals(a)||(l=!0,this.selection=a),a instanceof ve.dm.LinearSelection&&(i=a.getRange(),k.start=this.getDocument().getBranchNodeFromOffset(i.start),k.end=i.isCollapsed()?k.start:this.getDocument().getBranchNodeFromOffset(i.end),i.isCollapsed()||(g=this.getDocument().documentNode.getNodeFromOffset(i.start+1),g&&g.getOuterRange().equalsSelection(i)&&(h=g)),i.isCollapsed()?(b=Math.max(0,i.start-1),n.isContentOffset(b)||(b=-1),c=Math.max(0,i.start),n.isContentOffset(c)||(c=-1),j=n.getAnnotationsFromOffset(i.start)):(b=n.getNearestContentOffset(i.start),c=n.getNearestContentOffset(i.end),j=n.getAnnotationsFromRange(i)),-1===b?f=new ve.dm.AnnotationSet(this.getDocument().getStore()):(d=n.getAnnotationsFromOffset(b),-1!==c?(e=n.getAnnotationsFromOffset(c),f=d.filter(function(a){return a.constructor["static"].applyToAppendedContent||e.containsComparable(a)})):f=d),f.equalsInOrder(this.insertionAnnotations)||this.setInsertionAnnotations(f)),(a instanceof ve.dm.TableSelection||a instanceof ve.dm.NullSelection)&&(m=!0),j&&!j.compareTo(this.coveredAnnotations)&&(this.coveredAnnotations=j,m=!0),(h!==this.selectedNode||k.start!==this.branchNodes.start||k.end!==this.branchNodes.end)&&(this.branchNodes=k,this.selectedNode=h,m=!0),l&&this.emit("select",this.selection.clone()),m&&this.emitContextChange()}},ve.dm.Surface.prototype.selectFirstContentOffset=function(){var a=this.getDocument().data.getNearestContentOffset(0,1);-1!==a?this.setLinearSelection(new ve.Range(a)):this.setNullSelection()},ve.dm.Surface.prototype.change=function(a,b){this.changeInternal(a,b,!1)},ve.dm.Surface.prototype.changeInternal=function(a,b,c){var d,e,f,g=this.selection.clone(),h=!1;if(this.enabled){if(this.startQueueingContextChanges(),a){for(a instanceof ve.dm.Transaction&&(a=[a]),this.transacting=!0,d=0,e=a.length;e>d;d++)a[d].isNoOp()||(c||(this.isStaging()?(this.getStagingTransactions().length||(this.getStaging().selectionBefore=g),this.getStagingTransactions().push(a[d])):(this.truncateUndoStack(),this.newTransactions.length||(this.selectionBefore=g),this.newTransactions.push(a[d]))),this.getDocument().commit(a[d]),a[d].hasElementAttributeOperations()&&(h=!0));this.transacting=!1}f=this.selection,b?this.setSelection(b):a&&this.setSelection(this.selection),!g.equals(f)&&f.equals(this.selection)&&this.emit("select",this.selection.clone()),h&&this.emitContextChange(),this.stopQueueingContextChanges()}},ve.dm.Surface.prototype.breakpoint=function(){return this.enabled?this.newTransactions.length>0?(this.undoStack.push({transactions:this.newTransactions,selection:this.selection.clone(),selectionBefore:this.selectionBefore.clone()}),this.newTransactions=[],this.emit("history"),!0):(this.selectionBefore.isNull()&&!this.selection.isNull()&&(this.selectionBefore=this.selection.clone()),!1):!1},ve.dm.Surface.prototype.undo=function(){var a,b,c,d=[];if(this.canUndo()&&(this.isStaging()&&this.popAllStaging(),this.breakpoint(),this.undoIndex++,b=this.undoStack[this.undoStack.length-this.undoIndex])){for(a=b.transactions.length-1;a>=0;a--)c=b.transactions[a].reversed(),d.push(c);this.changeInternal(d,b.selectionBefore,!0),this.emit("history")}},ve.dm.Surface.prototype.redo=function(){var a;this.canRedo()&&(this.breakpoint(),a=this.undoStack[this.undoStack.length-this.undoIndex],a&&(this.changeInternal(ve.copy(a.transactions),a.selection,!0),this.undoIndex--,this.emit("history")))},ve.dm.Surface.prototype.onDocumentTransact=function(a){this.setSelection(this.getSelection().translateByTransaction(a)),this.emit("documentUpdate",a)},ve.dm.Surface.prototype.getSelectedNode=function(){return this.selectedNode},ve.dm.Surface.prototype.onDocumentPreCommit=function(){this.translatedSelection=this.selection.clone()},ve.dm.Surface.prototype.onDocumentPreSynchronize=function(a){this.translatedSelection&&(this.translatedSelection=this.translatedSelection.translateByTransaction(a))},ve.dm.SurfaceFragment=function(a,b,c,d){return a?(this.document=a.getDocument(),this.noAutoSelect=!!c,this.excludeInsertions=!!d,this.surface=a,this.selection=b||a.getSelection(),this.leafNodes=null,void(this.historyPointer=this.document.getCompleteHistoryLength())):this},OO.initClass(ve.dm.SurfaceFragment),ve.dm.SurfaceFragment.prototype.getSelectedModels=function(a){if(this.isNull())return[];var b,c,d,e,f=this.getAnnotations(a);if(a)for(d=this.getCoveredNodes(),b=0,c=d.length;c>b;b++)d[b].range&&d[b].range.isCollapsed()?(d.splice(b,1),c--,b--):d[b]=d[b].node;else d=[],e=this.getSelectedNode(),e&&d.push(e);return d.concat(f.isEmpty()?[]:f.get())},ve.dm.SurfaceFragment.prototype.update=function(a){if(!this.isNull()){var b;a?(this.selection=a,this.historyPointer=this.document.getCompleteHistoryLength()):this.historyPointer<this.document.getCompleteHistoryLength()&&(b=this.document.getCompleteHistorySince(this.historyPointer),this.selection=this.selection.translateByTransactions(b,this.excludeInsertions),this.historyPointer+=b.length),this.leafNodes=null}},ve.dm.SurfaceFragment.prototype.change=function(a,b){if(!b&&this.isNull())throw new Error("Cannot change null fragment without selection");Array.isArray(a)||(a=[a]),this.surface.change(a,!this.noAutoSelect&&(b||this.getSelection(!0).translateByTransactions(a,this.excludeInsertions))),b&&this.update(b)},ve.dm.SurfaceFragment.prototype.getSurface=function(){return this.surface},ve.dm.SurfaceFragment.prototype.getDocument=function(){return this.document},ve.dm.SurfaceFragment.prototype.getSelection=function(a){return this.update(),a?this.selection:this.selection.clone()},ve.dm.SurfaceFragment.prototype.isNull=function(){return this.selection.isNull()},ve.dm.SurfaceFragment.prototype.willAutoSelect=function(){return!this.noAutoSelect},ve.dm.SurfaceFragment.prototype.setAutoSelect=function(a){return this.noAutoSelect=!a,this},ve.dm.SurfaceFragment.prototype.clone=function(a){return new this.constructor(this.surface,a||this.getSelection(),this.noAutoSelect,this.excludeInsertions)},ve.dm.SurfaceFragment.prototype.willExcludeInsertions=function(){return this.excludeInsertions},ve.dm.SurfaceFragment.prototype.setExcludeInsertions=function(a){a=!!a,this.excludeInsertions!==a&&(this.update(),this.excludeInsertions=a)},ve.dm.SurfaceFragment.prototype.adjustLinearSelection=function(a,b){if(!(this.selection instanceof ve.dm.LinearSelection))return this.clone();var c,d=this.getSelection(!0).getRange();return c=d&&new ve.Range(d.start+(a||0),d.end+(b||0)),this.clone(new ve.dm.LinearSelection(this.getDocument(),c))},ve.dm.SurfaceFragment.prototype.truncateLinearSelection=function(a){if(!(this.selection instanceof ve.dm.LinearSelection))return this.clone();var b=this.getSelection(!0).getRange();return this.clone(new ve.dm.LinearSelection(this.getDocument(),b.truncate(a)))},ve.dm.SurfaceFragment.prototype.collapseToStart=function(){return this.clone(this.getSelection(!0).collapseToStart())},ve.dm.SurfaceFragment.prototype.collapseToEnd=function(){return this.clone(this.getSelection(!0).collapseToEnd())},ve.dm.SurfaceFragment.prototype.trimLinearSelection=function(){if(!(this.selection instanceof ve.dm.LinearSelection))return this.clone();var a=this.getSelection(!0).getRange(),b=a;return b=0===this.getText().trim().length?new ve.Range(a.start):this.document.data.trimOuterSpaceFromRange(a),this.clone(new ve.dm.LinearSelection(this.getDocument(),b))},ve.dm.SurfaceFragment.prototype.expandLinearSelection=function(a,b){if(!(this.selection instanceof ve.dm.LinearSelection))return this.clone();var c,d,e,f,g=this.getSelection(!0).getRange();switch(a||"parent"){case"word":f=g.isCollapsed()?this.document.data.getWordRange(g.start):ve.Range["static"].newCoveringRange([this.document.data.getWordRange(g.start),this.document.data.getWordRange(g.end)],g.isBackwards());break;case"annotation":f=this.document.data.getAnnotatedRangeFromSelection(g,b),g.start>f.start||g.end<f.end?g.from>g.to&&(f=f.flip()):f=g;break;case"root":f=new ve.Range(0,this.getDocument().getInternalList().getListNode().getOuterRange().start);break;case"siblings":d=this.document.selectNodes(g,"siblings"),f=1===d.length?d[0].node.getOuterRange():new ve.Range(d[0].node.getOuterRange().start,d[d.length-1].node.getOuterRange().end);break;case"closest":if(d=this.document.selectNodes(g,"siblings"),d[0].nodeRange.equalsSelection(g)&&d[0].node instanceof b){f=d[0].nodeOuterRange;break}for(e=d[0].node.getParent();e&&!(e instanceof b);)c=e,e=e.getParent();e&&(f=e.getOuterRange());break;case"parent":c=this.document.selectNodes(g,"siblings")[0].node,e=c.getParent(),e&&(f=e.getOuterRange());break;default:throw new Error("Invalid scope argument: "+a)}return this.clone(f?new ve.dm.LinearSelection(this.getDocument(),f):new ve.dm.NullSelection(this.getDocument()))},ve.dm.SurfaceFragment.prototype.getData=function(a){return this.selection instanceof ve.dm.LinearSelection?this.document.getData(this.getSelection(!0).getRange(),a):[]},ve.dm.SurfaceFragment.prototype.getText=function(){return this.selection instanceof ve.dm.LinearSelection?this.document.data.getText(!1,this.getSelection(!0).getRange()):""},ve.dm.SurfaceFragment.prototype.getAnnotations=function(a){var b,c,d,e,f=this.getSelection(!0),g=new ve.dm.AnnotationSet(this.getDocument().getStore());if(f.isCollapsed())return this.surface.getInsertionAnnotations();for(d=f.getRanges(),b=0,c=d.length;c>b;b++)e=this.getDocument().data.getAnnotationsFromRange(d[b],a),a?g.addSet(e):g=b?g.intersectWith(e):e;return g},ve.dm.SurfaceFragment.prototype.hasAnnotations=function(){var a,b,c=this.getSelection().getRanges();for(a=0,b=c.length;b>a;a++)if(this.getDocument().data.hasAnnotationsInRange(c[a]))return!0;return!1},ve.dm.SurfaceFragment.prototype.getLeafNodes=function(){return this.selection instanceof ve.dm.LinearSelection?(this.update(),this.leafNodes||(this.leafNodes=this.document.selectNodes(this.getSelection().getRange(),"leaves")),this.leafNodes):[]},ve.dm.SurfaceFragment.prototype.getSelectedLeafNodes=function(){var a,b,c=[],d=this.getLeafNodes();for(a=0,b=d.length;b>a;a++)(1===b||!d[a].range||d[a].range.getLength())&&c.push(d[a].node);return c},ve.dm.SurfaceFragment.prototype.getSelectedNode=function(){if(!(this.selection instanceof ve.dm.LinearSelection))return null;var a,b,c=this.getSelection().getRange(),d=this.document.selectNodes(c,"covered");for(a=0,b=d.length;b>a;a++)if(d[a].nodeOuterRange.equalsSelection(c))return d[a].node;return null},ve.dm.SurfaceFragment.prototype.getCoveredNodes=function(){return this.selection instanceof ve.dm.LinearSelection?this.document.selectNodes(this.getSelection().getRange(),"covered"):[]},ve.dm.SurfaceFragment.prototype.getSiblingNodes=function(){return this.selection instanceof ve.dm.LinearSelection?this.document.selectNodes(this.getSelection().getRange(),"siblings"):[]},ve.dm.SurfaceFragment.prototype.select=function(){return this.surface.setSelection(this.getSelection()),this},ve.dm.SurfaceFragment.prototype.changeAttributes=function(a,b){var c,d,e,f=[],g=this.getCoveredNodes();for(c=0,d=g.length;d>c;c++)e=g[c],!e.node.isWrapped()||b&&e.node.getType()!==b||e.range&&e.range.isCollapsed()||f.push(ve.dm.Transaction.newFromAttributeChanges(this.document,e.nodeOuterRange.start,a));return f.length&&this.change(f),this},ve.dm.SurfaceFragment.prototype.annotateContent=function(a,b,c){var d,e,f,g,h,i,j,k,l=this.getSelection(!0).getRanges(),m=[];if(b instanceof ve.dm.Annotation)e=[b];else if(d=ve.dm.annotationFactory.create(b,c),"set"===a)e=[d];else for(e=[],f=0,g=l.length;g>f&&(e=this.document.data.getAnnotationsFromRange(l[f],!0).getAnnotationsByName(d.name).get(),!e.length);f++);for(f=0,g=l.length;g>f;f++)if(k=l[f],k.isCollapsed()){if("set"===a)for(f=0,g=e.length;g>f;f++)this.surface.addInsertionAnnotations(e[f]);else if("clear"===a)for(f=0,g=e.length;g>f;f++)this.surface.removeInsertionAnnotations(e[f])}else for(h=0,i=e.length;i>h;h++)j=ve.dm.Transaction.newFromAnnotation(this.document,k,a,e[h]),m.push(j);return this.change(m),this},ve.dm.SurfaceFragment.prototype.insertContent=function(a,b){if(!(this.selection instanceof ve.dm.LinearSelection))return this;var c,d,e,f,g,h,i;if(this.getSelection(!0).isCollapsed()||(f=this.getAnnotations(),this.removeContent()),h=this.getSelection(!0).getRange().start,"string"==typeof a)if(e=a.split(/[\r\n]+/),e.length>1)for(a=[],c=0,d=e.length;d>c;c++)e[c].length&&(a.push({type:"paragraph"}),a=a.concat(e[c].split("")),a.push({type:"/paragraph"}));else a=a.split("");return a.length&&(b&&!f&&(f=this.document.data.getAnnotationsFromOffset(0===h?0:h-1)),f&&f.getLength()>0&&ve.dm.Document["static"].addAnnotationsToData(a,f),g=ve.dm.Transaction.newFromInsertion(this.document,h,a),i=g.getModifiedRange(),this.change(g,new ve.dm.LinearSelection(this.getDocument(),i))),this},ve.dm.SurfaceFragment.prototype.insertHtml=function(a,b){return this.insertDocument(this.getDocument().newFromHtml(a,b)),this},ve.dm.SurfaceFragment.prototype.insertDocument=function(a){return this.selection instanceof ve.dm.LinearSelection?(this.getSelection(!0).isCollapsed()||this.removeContent(),this.change(new ve.dm.Transaction.newFromDocumentInsertion(this.getDocument(),this.getSelection().getRange().start,a)),this):this},ve.dm.SurfaceFragment.prototype.removeContent=function(){return this.selection instanceof ve.dm.LinearSelection?(this.getSelection(!0).isCollapsed()||this.change(ve.dm.Transaction.newFromRemoval(this.document,this.getSelection(!0).getRange())),this):this},ve.dm.SurfaceFragment.prototype["delete"]=function(a){if(!(this.selection instanceof ve.dm.LinearSelection))return this;var b,c,d,e,f,g,h,i,j=this.getSelection(!0).getRange();if(j.isCollapsed())return this;if(i=this.getDocument().getDocumentNode().getNodeFromOffset(j.start),i.getRange().containsRange(j))c=ve.dm.Transaction.newFromRemoval(this.document,j),this.change(c),b=c.translateRange(j);else{for(;!i.getOuterRange().containsRange(j);)i=i.getParent();b=this.deleteResilient(i,j,j)}return b.isCollapsed()||(e=this.document.getBranchNodeFromOffset(b.end,!1),e.getRange().start>=b.end&&(d=this.document.getBranchNodeFromOffset(b.start,!1),d.getRange().isCollapsed()&&!d.isResilient()?this.change([ve.dm.Transaction.newFromRemoval(this.document,d.getOuterRange())]):(f=this.document.getData(e.getRange()),g=e,g.traverseUpstream(function(a){var b=a.getParent();return 1===b.children.length?(g=b,!0):!1}),h=!1,g.traverseUpstream(function(a){return a===i?!1:(h=a.isResilient(),!h)
}),h||this.change([ve.dm.Transaction.newFromRemoval(this.document,g.getOuterRange()),ve.dm.Transaction.newFromInsertion(this.document,b.start,f)])))),this.document.getDocumentNode().getLength()<=2&&(c=ve.dm.Transaction.newFromInsertion(this.document,0,[{type:"paragraph"},{type:"/paragraph"}]),this.change(c),b=new ve.Range(1)),b=new ve.Range(this.document.data.getNearestContentOffset(b.start,a||-1)),this.change([],new ve.dm.LinearSelection(this.getDocument(),b)),this},ve.dm.SurfaceFragment.prototype.deleteResilient=function(a,b,c){var d,e,f,g,h,i=[],j=[];if(b.isCollapsed())return c;if(!a.canHaveChildren())return h=ve.dm.Transaction.newFromRemoval(this.document,b),this.change(h),c=h.translateRange(c);for(e=0;e<a.children.length;e++)d=a.children[e],d.getOuterRange().intersects(b)&&(j.push(d),i.push(d.isResilient()));for(e=j.length-1;e>=0;e--)d=j[e],d.isResilient()?(f=Math.max(Math.min(this.document.data.getNearestContentOffset(d.getRange().start,1),d.getRange().end),b.start),g=Math.min(Math.max(this.document.data.getNearestContentOffset(d.getRange().end,-1),d.getRange().start),b.end),c=this.deleteResilient(d,new ve.Range(f,g),c)):b.containsRange(d.getOuterRange())?(h=ve.dm.Transaction.newFromRemoval(this.document,d.getOuterRange()),this.change(h),c=h.translateRange(c)):(f=i[e-1]?Math.max(Math.min(this.document.data.getNearestContentOffset(d.getOuterRange().start,1),d.getOuterRange().end),b.start):Math.max(d.getOuterRange().start,b.start),g=i[e+1]?Math.min(Math.max(this.document.data.getNearestContentOffset(d.getOuterRange().end,-1),d.getOuterRange().start),b.end):Math.min(d.getOuterRange().end,b.end),c=this.deleteResilient(d,new ve.Range(f,g),c));return c},ve.dm.SurfaceFragment.prototype.convertNodes=function(a,b){return this.selection instanceof ve.dm.LinearSelection?(this.change(ve.dm.Transaction.newFromContentBranchConversion(this.document,this.getSelection().getRange(),a,b)),this):this},ve.dm.SurfaceFragment.prototype.wrapNodes=function(a){return this.selection instanceof ve.dm.LinearSelection?(Array.isArray(a)||(a=[a]),this.change(ve.dm.Transaction.newFromWrap(this.document,this.getSelection().getRange(),[],[],[],a)),this):this},ve.dm.SurfaceFragment.prototype.unwrapNodes=function(a,b){if(!(this.selection instanceof ve.dm.LinearSelection))return this;var c,d=this.getSelection().getRange(),e=[],f=[];if(d.getLength()<2*b)throw new Error("cannot unwrap by greater depth than maximum theoretical depth of selection");for(c=0;b>c;c++)e.push(this.surface.getDocument().data.getData(d.start+c));for(c=a;c>0;c--)f.push(this.surface.getDocument().data.getData(d.start-c));return this.change(ve.dm.Transaction.newFromWrap(this.document,d,f,[],e,[])),this},ve.dm.SurfaceFragment.prototype.rewrapNodes=function(a,b){if(!(this.selection instanceof ve.dm.LinearSelection))return this;var c,d=this.getSelection().getRange(),e=[];if(Array.isArray(b)||(b=[b]),d.getLength()<2*a)throw new Error("cannot unwrap by greater depth than maximum theoretical depth of selection");for(c=0;a>c;c++)e.push(this.surface.getDocument().data.getData(d.start+c));return this.change(ve.dm.Transaction.newFromWrap(this.document,d,[],[],e,b)),this},ve.dm.SurfaceFragment.prototype.wrapAllNodes=function(a){return this.selection instanceof ve.dm.LinearSelection?(Array.isArray(a)||(a=[a]),this.change(ve.dm.Transaction.newFromWrap(this.document,this.getSelection().getRange(),[],a,[],[])),this):this},ve.dm.SurfaceFragment.prototype.rewrapAllNodes=function(a,b){if(!(this.selection instanceof ve.dm.LinearSelection))return this;var c,d=[],e=this.getSelection().getRange(),f=new ve.Range(e.start+a,e.end-a);if(Array.isArray(b)||(b=[b]),e.getLength()<2*a)throw new Error("cannot unwrap by greater depth than maximum theoretical depth of selection");for(c=0;a>c;c++)d.push(this.surface.getDocument().data.getData(e.start+c));return this.change(ve.dm.Transaction.newFromWrap(this.document,f,d,b,[],[])),this},ve.dm.SurfaceFragment.prototype.isolateAndUnwrap=function(a){function b(a,b){var c,d,e,h=0,i=[];for(c=0,d=a.length;d>c;c++)i.unshift({type:"/"+a[c].type}),i.push(a[c].getClonedElement()),b&&(h+=2);e=ve.dm.Transaction.newFromInsertion(p.getDocument(),b?f:g,i),p.change(e),f+=h,g+=h}if(!(this.selection instanceof ve.dm.LinearSelection))return this;var c,d,e,f,g,h,i=0,j=this.document.getNodeFactory(),k=j.getSuggestedParentNodeTypes(a),l=!1,m=!1,n=[],o=[],p=this;for(c=this.getSiblingNodes(),d=c[0].node,f=d.getOuterRange().start;null!==k&&-1===k.indexOf(d.getParent().type);)d.getParent().indexOf(d)>0&&(l=!0),d=d.getParent(),l?n.unshift(d):f=d.getOuterRange().start,i++;for(e=c[c.length-1].node,g=e.getOuterRange().end;null!==k&&-1===k.indexOf(e.getParent().type);)e.getParent().indexOf(e)<e.getParent().getChildren().length-1&&(m=!0),e=e.getParent(),m?o.unshift(e):g=e.getOuterRange().end;return h=this.willExcludeInsertions(),this.setExcludeInsertions(!0),l&&b(n,!0),m&&b(o,!1),this.setExcludeInsertions(h),this.unwrapNodes(i,0),this},ve.dm.DataString=function(a){this.data=a},OO.inheritClass(ve.dm.DataString,unicodeJS.TextString),ve.dm.DataString.prototype.read=function(a){var b=this.data[a];return void 0!==b&&void 0===b.type?"string"==typeof b?b:b[0]:null},ve.dm.Document=function(a,b,c,d,e,f,g,h){if(ve.Document.call(this,new ve.dm.DocumentNode),b=b||ve.dm.nodeFactory,!(b instanceof ve.dm.NodeFactory))throw new Error("API changed: 2nd argument must be of type ve.dm.NodeFactory");var i,j,k=!0,l=d||this,m=this.documentNode;this.nodeFactory=b,this.lang=g||"en",this.dir=h||"ltr",this.documentNode.setRoot(m),this.documentNode.setDocument(l),this.internalList=e?e.clone(this):new ve.dm.InternalList(this),this.innerWhitespace=f?ve.copy(f):new Array(2),this.parentDocument=d,this.completeHistory=[],a instanceof ve.dm.ElementLinearData?(k=!1,i=a):i=a instanceof ve.dm.FlatLinearData?a:new ve.dm.FlatLinearData(new ve.dm.IndexValueStore,Array.isArray(a)?a:[]),this.store=i.getStore(),this.htmlDocument=c||ve.createDocumentFromHtml(""),k?(j=this.constructor["static"].splitData(i,b),this.data=j.elementData,this.metadata=j.metaData):(this.data=i,this.metadata=new ve.dm.MetaLinearData(this.data.getStore(),new Array(1+this.data.getLength())))},OO.inheritClass(ve.dm.Document,ve.Document),ve.dm.Document["static"].splitData=function(a,b){var c,d,e,f,g,h;for(g=new ve.dm.ElementLinearData(a.getStore(),[],b),h=new ve.dm.MetaLinearData(a.getStore()),c=0,d=a.getLength();d>c;c++)if(a.isElementData(c)){if(a.isOpenElementData(c)&&ve.dm.metaItemFactory.lookup(a.getType(c))){f=a.getData(c),e=g.getLength(),h.getData(e)||h.setData(e,[]),h.getData(e).push(f),c++;continue}g.push(a.getData(c))}else g.push(a.getData(c));return h.getLength()<g.getLength()+1&&(h.data=h.data.concat(new Array(1+g.getLength()-h.getLength()))),{elementData:g,metaData:h}},ve.dm.Document["static"].addAnnotationsToData=function(a,b){var c,d,e,f=b.getStore();if(!b.isEmpty())for(c=0,d=a.length;d>c;c++)a[c].type||(Array.isArray(a[c])?(e=new ve.dm.AnnotationSet(f,a[c][1]),e.addSet(b.clone())):(a[c]=[a[c]],e=b.clone()),a[c][1]=e.getIndexes())},ve.dm.Document.prototype.getDocumentNode=function(){return this.documentNode.length||this.documentNode.getDocument().buildingNodeTree||this.buildNodeTree(),this.documentNode},ve.dm.Document.prototype.buildNodeTree=function(){var a,b,c,d,e,f,g,h,i,j=0,k=!1,l=this.nodeFactory;for(e=[],f=[this.documentNode],g=[f,e],h=this.documentNode,i=this.documentNode.getDocument(),a=0,b=this.data.getLength();b>a;a++)if(this.data.isElementData(a))if(k&&(h.setLength(j),h=f[f.length-1],k=!1,j=0),this.data.isOpenElementData(a))if(c=l.createFromElement(this.data.getData(a)),c.setDocument(i),e.push(c),l.canNodeHaveChildren(c.getType()))f=e,e=[],g.push(e),h=c;else{if(!this.data.isCloseElementData(a+1)||this.data.getType(a+1)!==this.data.getType(a))throw new Error("Opening element for node that cannot have children must be followed by closing element");a++}else{if(d=g.pop(),e=f,f=g[g.length-2],!f)throw new Error("Unbalanced input passed to document");ve.batchSplice(h,0,0,d),h=f[f.length-1]}else k||(c=new ve.dm.TextNode,c.setDocument(i),e.push(c),h=c,k=!0),j++;k&&h.setLength(j),i.buildingNodeTree=!0,ve.batchSplice(this.documentNode,0,0,e),i.buildingNodeTree=!1},ve.dm.Document.prototype.getLength=function(){return this.data.getLength()},ve.dm.Document.prototype.commit=function(a){var b=this;if(a.hasBeenApplied())throw new Error("Cannot commit a transaction that has already been committed");this.emit("precommit"),new ve.dm.TransactionProcessor(this,a).process(function(){b.emit("presynchronize",a)}),this.completeHistory.push(a),this.emit("transact",a)},ve.dm.Document.prototype.getData=function(a,b){return this.data.getDataSlice(a,b)},ve.dm.Document.prototype.getMetadata=function(a,b){return this.metadata.getDataSlice(a,b)},ve.dm.Document.prototype.getHtmlDocument=function(){return this.htmlDocument},ve.dm.Document.prototype.getStore=function(){return this.store},ve.dm.Document.prototype.getInternalList=function(){return this.internalList},ve.dm.Document.prototype.getInnerWhitespace=function(){return this.innerWhitespace},ve.dm.Document.prototype.cloneSliceFromRange=function(a){for(var b,c,d,e,f,g,h,i,j,k,l,m=this.getBranchNodeFromOffset(a.start),n=this.getBranchNodeFromOffset(a.end),o=this.selectNodes(a,"siblings"),p=[],q=[],r=[],s=[];o[0]&&o[0].range&&o[0].range.isCollapsed()&&!o[0].node.isWrapped();)o.shift();for(b=o.length-1;o[b]&&o[b].range&&o[b].range.isCollapsed()&&!o[b].node.isWrapped();)o.pop(),b--;if(0===o.length)g=new ve.dm.ElementLinearData(this.getStore(),[],this.getNodeFactory()),i=j=new ve.Range(0);else if(m===n)k=o;else{for(c=o[0],d=o[o.length-1],e=c.node,f=d.node;!e.isWrapped();)e=e.getParent();for(;!f.isWrapped();)f=f.getParent();if(c.range)for(;;){for(;!m.isWrapped();)m=m.getParent();if(p.push(m.getClonedElement()),m===e)break;m=m.getParent()}if(d!==c&&d.range)for(;;){for(;!n.isWrapped();)n=n.getParent();if(q.push({type:"/"+n.getType()}),n===f)break;n=n.getParent()}k=this.selectNodes(new ve.Range(e.getOuterRange().start,f.getOuterRange().end),"covered")}if(!j){for(l=!1,b=k.length-1;b>=0;b--)if(null!==k[b].node.getParentNodeTypes()){l=!0;break}if(l)for(m=k[0].node;m.getParent()&&null!==m.getParentNodeTypes();)m=m.getParent(),r.push(m.getClonedElement()),s.push({type:"/"+m.getType()});g=new ve.dm.ElementLinearData(this.getStore(),r.reverse().concat(p.reverse()).concat(this.data.slice(a.start,a.end)).concat(q).concat(s),this.getNodeFactory()),i=new ve.Range(r.length+p.length,r.length+p.length+a.getLength()),j=new ve.Range(r.length,r.length+p.length+a.getLength()+q.length)}return ve.batchSplice(g.data,g.getLength(),0,this.getData(this.getInternalList().getListNode().getOuterRange(),!0)),h=new ve.dm.DocumentSlice(g,void 0,void 0,this.getInternalList().clone(),i,j)},ve.dm.Document.prototype.cloneFromRange=function(a){var b,c,d=this.getStore().clone(),e=this.getInternalList().getListNode().getOuterRange();return b=ve.copy(this.getFullData(a,!0)),(a.start>e.start||a.end<e.end)&&(b=b.concat(this.getFullData(e))),c=this.createDocument(new ve.dm.FlatLinearData(d,b),this.nodeFactory,this.getHtmlDocument(),void 0,this.getInternalList(),void 0,this.getLang(),this.getDir()),c.origDoc=this,c.origInternalListLength=this.internalList.getItemNodeCount(),c},ve.dm.Document.prototype.getFullData=function(a,b){var c,d,e=a?a.start:0,f=a?a.end:this.data.getLength(),g=[];for(void 0===b&&(b=!a);f>=e;){if(this.metadata.getData(e)&&(b||e!==a.start&&e!==a.end))for(c=0,d=this.metadata.getData(e).length;d>c;c++)g.push(this.metadata.getData(e)[c]),g.push({type:"/"+this.metadata.getData(e)[c].type});f>e&&g.push(this.data.getData(e)),e++}return g},ve.dm.Document.prototype.getSiblingWordBoundary=function(a,b){var c=new ve.dm.DataString(this.getData());return unicodeJS.wordbreak.moveBreakOffset(b,c,a,!0)},ve.dm.Document.prototype.getRelativeOffset=function(a,b,c){var d,e,f,g,h,i=this.data,j=this.nodeFactory;return"word"===c?(f=this.getSiblingWordBoundary(a,b),a===f&&(f=this.getRelativeOffset(a,b,"character")),f):(g=a+(b>0?0:-1),i.isElementData(g)&&j.isNodeFocusable(i.getType(g))?a+b:(d=i.getRelativeContentOffset(a,b),e=i.getRelativeStructuralOffset(a,b,!0),(0>e-a?-1:1)!==b?e=a:h=(0>e-a?-1:1)===b&&i.isElementData(e+b)&&j.isNodeFocusable(i.getType(e+b)),h||this.hasSlugAtOffset(e)?(h&&(e+=b),d===a||(0>d-a?-1:1)!==b?e:b>0?Math.min(d,e):Math.max(d,e)):b>0?Math.max(d,a):Math.min(d,a)))},ve.dm.Document.prototype.getRelativeRange=function(a,b,c,d,e){var f,g,h,i,j=a.to;if(!a.isCollapsed()&&!d){if(h=b>0?a.end:a.start,this.data.isContentOffset(h)||this.hasSlugAtOffset(h))return new ve.Range(h);j=h}return f=this.getRelativeOffset(j,b,c),g=this.getNearestFocusableNode(j,b,f),i=g?g.getOuterRange(-1===b):new ve.Range(f),e&&!e.containsRange(i)?a:d?new ve.Range(a.from,i.to):i},ve.dm.Document.prototype.getNearestFocusableNode=function(a,b,c){var d,e=this.nodeFactory;return this.data.getRelativeOffset(a,1===b?0:-1,function(b,c){return b>=Math.max(a,c)||b<Math.min(a,c)?!0:this.isOpenElementData(b)&&e.isNodeFocusable(this.getType(b))?(d=b+1,!0):this.isCloseElementData(b)&&e.isNodeFocusable(this.getType(b))?(d=b,!0):void 0},c),d?this.getDocumentNode().getNodeFromOffset(d):null},ve.dm.Document.prototype.getBranchNodeFromOffset=function(a){if(0>a||a>this.data.getLength())throw new Error("ve.dm.Document.getBranchNodeFromOffset(): offset "+a+" is out of bounds");return ve.Document.prototype.getBranchNodeFromOffset.call(this,a)},ve.dm.Document.prototype.hasSlugAtOffset=function(a){var b=this.getBranchNodeFromOffset(a);return b?b.hasSlugAtOffset(a):!1},ve.dm.Document.prototype.getDataFromNode=function(a){var b=a.getLength(),c=a.getOffset();return c>=0?(a.isWrapped()&&c++,this.data.slice(c,c+b)):null},ve.dm.Document.prototype.rebuildNodes=function(a,b,c,d,e){var f=this.data.sliceObject(d,d+e),g=this.createDocument(f,this.nodeFactory,this.htmlDocument,this),h=g.getDocumentNode().getChildren();return ve.batchSplice(a,b,c,h),h},ve.dm.Document.prototype.rebuildTree=function(){var a=this.getDocumentNode();this.rebuildNodes(a,0,a.getChildren().length,0,this.data.getLength())},ve.dm.Document.prototype.fixupInsertion=function(a,b){function c(a,b){var c;if(void 0!==a.type)if("/"!==a.type.charAt(0))0===x.length&&y.length>0&&y[y.length-1].getType()===a.type?f=y.pop():x.push(a),g=a.type;else if(x.length>0)c=x.pop().type;else{if(c=f.getType(),y.push(f),f=f.getParent(),!f)throw new Error("Inserted data is trying to close the root node (at index "+b+")");if(g=c,!(a.type==="/"+c||v.canNodeContainContent(a.type.slice(1))&&v.canNodeContainContent(c)))throw new Error("Cannot adopt content from "+a.type+" nodes into "+c+" nodes (at index "+b+")")}u.push(a)}var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u=[],v=this.nodeFactory,w=0,x=[],y=[],z=0,A=a.length,B=this;for(f=this.getBranchNodeFromOffset(b),g=f.getType(),h=!1,i=B.data.isOpenElementData(b-1),s=0;s<a.length;s++)if(h&&void 0!==a[s].type&&(g=x.length>0?x[x.length-1].type:f.getType()),void 0===a[s].type||"/"!==a[s].type.charAt(0)){j=a[s].type||"text",o=[],p=[],q=[],v.isNodeContent(j)&&!v.canNodeContainContent(g)&&(j="paragraph",o.unshift(v.getDataElement(j)));do if(k=v.getParentNodeTypes(j),m=null===k||-1!==k.indexOf(g),!m){if(0===k.length)throw new Error("Cannot insert "+j+" because it  cannot have a parent (at index "+s+")");j=k[0],o.unshift(v.getDataElement(j))}while(!m);do if(l=v.getChildNodeTypes(g),n=null===l||-1!==l.indexOf(j),n=n&&!(!v.isNodeContent(j)&&v.canNodeContainContent(g)),!n){if(i)return this.fixupInsertion(a,b-1);if(p.push({type:"/"+g}),x.length>0)r=x.pop(),g=r.type,q.push(ve.copy(r));else{if(!f.getParent())throw new Error("Cannot insert "+j+" even  after closing all containing nodes (at index "+s+")");y.push(f),q.push(f.getClonedElement()),f=f.getParent(),g=f.getType()}}while(!n);if(0===s&&"text"===j&&ve.isUnattachedCombiningMark(a[s])){if(B.data.isElementData(b-1))continue;b--,w++,d=B.data.getCharacterData(b)+a[s],e=B.data.getAnnotationIndexesFromOffset(b),e.length&&(d=[d,e]),a[s]=d}for(t=0;t<p.length;t++)0===s?z++:A++,u.push(p[t]);for(t=0;t<o.length;t++)0===s?z++:A++,c(o[t],s);c(a[s],s),void 0===a[s].type?(h=!0,o.length>0&&(g=j)):g=a[s].type}else c(a[s],s),g=x.length>0?x[x.length-1].type:f.getType();if(y.length>0&&B.data.isCloseElementData(b))return this.fixupInsertion(a,b+1);for(h&&(g=x.length>0?x[x.length-1].type:f.getType());x.length>0;)r=x[x.length-1],c({type:"/"+r.type},s);for(;y.length>0;)r=y[y.length-1],c(r.getClonedElement(),s);return{offset:b,data:u,remove:w,insertedDataOffset:z,insertedDataLength:A}},ve.dm.Document.prototype.newFromHtml=function(a,b){var c=ve.createDocumentFromHtml(a),d=ve.dm.converter.getModelFromDom(c,{targetDoc:this.getHtmlDocument(),fromClipboard:!!b},this),e=d.data;return d.metadata=new ve.dm.MetaLinearData(d.getStore(),new Array(1+e.getLength())),b&&(e.sanitize(b.external),b.all&&e.sanitize(b.all)),e.remapInternalListKeys(this.getInternalList()),d.buildNodeTree(),d},ve.dm.Document.prototype.findText=function(a,b,c){var d,e,f,g,h,i,j=[],k=this.data.getText(!0,new ve.Range(0,this.getInternalList().getListNode().getOuterRange().start));if(a instanceof RegExp)for(a=new RegExp(a.source,b?"g":"gi"),h=0,i=k.split("\n"),d=0,e=i.length;e>d;d++){for(;i[d]&&null!==(g=a.exec(i[d]));)0!==g[0].length?(j.push(new ve.Range(h+g.index,h+g.index+g[0].length)),c||(a.lastIndex=g.index+1)):a.lastIndex=g.index+1;h+=i[d].length+1,a.lastIndex=0}else for(b||(k=k.toLowerCase(),a=a.toLowerCase()),f=a.length,h=-1;-1!==(h=k.indexOf(a,h));)j.push(new ve.Range(h,h+f)),h+=c?f:1;return j},ve.dm.Document.prototype.getCompleteHistoryLength=function(){return this.completeHistory.length},ve.dm.Document.prototype.getCompleteHistorySince=function(a){return this.completeHistory.slice(a)},ve.dm.Document.prototype.getLang=function(){return this.lang},ve.dm.Document.prototype.getDir=function(){return this.dir},ve.dm.Document.prototype.getNodeFactory=function(){return this.nodeFactory},ve.dm.Document.prototype.createDocument=function(a,b,c,d,e,f,g,h){return new ve.dm.Document(a,b,c,d,e,f,g,h)},ve.dm.DocumentSlice=function(a,b,c,d,e,f){ve.dm.Document.call(this,a,b,c,d),this.originalRange=e,this.balancedRange=f},OO.inheritClass(ve.dm.DocumentSlice,ve.dm.Document),ve.dm.DocumentSlice.prototype.getOriginalData=function(){return this.getData(this.originalRange)},ve.dm.DocumentSlice.prototype.getBalancedData=function(){return this.getData(this.balancedRange)},ve.dm.LinearData=function(a,b){this.store=a,this.data=b||[]},OO.initClass(ve.dm.LinearData),ve.dm.LinearData["static"].getType=function(a){return this.isCloseElementData(a)?a.type.slice(1):a.type},ve.dm.LinearData["static"].isElementData=function(a){return void 0!==a&&"string"==typeof a.type},ve.dm.LinearData["static"].isOpenElementData=function(a){return this.isElementData(a)&&"/"!==a.type.charAt(0)},ve.dm.LinearData["static"].isCloseElementData=function(a){return this.isElementData(a)&&"/"===a.type.charAt(0)},ve.dm.LinearData.prototype.getData=function(a){return void 0===a?this.data:this.data[a]},ve.dm.LinearData.prototype.setData=function(a,b){this.data[a]=b},ve.dm.LinearData.prototype.push=function(){return Array.prototype.push.apply(this.data,arguments)},ve.dm.LinearData.prototype.getLength=function(){return this.getData().length},ve.dm.LinearData.prototype.getStore=function(){return this.store},ve.dm.LinearData.prototype.slice=function(){return Array.prototype.slice.apply(this.data,arguments)},ve.dm.LinearData.prototype.sliceObject=function(){return new this.constructor(this.getStore(),this.slice.apply(this,arguments))},ve.dm.LinearData.prototype.splice=function(){return Array.prototype.splice.apply(this.data,arguments)},ve.dm.LinearData.prototype.spliceObject=function(){return new this.constructor(this.getStore(),this.splice.apply(this,arguments))},ve.dm.LinearData.prototype.batchSplice=function(a,b,c){return ve.batchSplice(this.getData(),a,b,c)},ve.dm.LinearData.prototype.batchSpliceObject=function(a,b,c){return new this.constructor(this.getStore(),this.batchSplice.call(this,a,b,c))},ve.dm.LinearData.prototype.getDataSlice=function(a,b){var c,d,e=0,f=this.getLength();return void 0!==a&&(e=Math.max(0,Math.min(f,a.start)),c=Math.max(0,Math.min(f,a.end))),d=void 0===c?this.slice(e):this.slice(e,c),b?ve.copy(d):d},ve.dm.LinearData.prototype.clone=function(){return new this.constructor(this.getStore(),ve.copy(this.data))},ve.dm.DocumentSynchronizer=function(a,b){this.document=a,this.actionQueue=[],this.eventQueue=[],this.adjustment=0,this.transaction=b},ve.dm.DocumentSynchronizer.synchronizers={},ve.dm.DocumentSynchronizer.synchronizers.annotation=function(a){var b,c=a.range.translate(this.adjustment),d=this.document.selectNodes(c,"leaves");for(b=0;b<d.length;b++)this.queueEvent(d[b].node,"annotation"),this.queueEvent(d[b].node,"update")},ve.dm.DocumentSynchronizer.synchronizers.attributeChange=function(a){this.queueEvent(a.node,"attributeChange",a.key,a.from,a.to),this.queueEvent(a.node,"update")},ve.dm.DocumentSynchronizer.synchronizers.resize=function(a){var b=a.node,c=b.getParent();c&&"text"===b.getType()&&b.getLength()+a.adjustment===0?c.splice(c.indexOf(b),1):b.adjustLength(a.adjustment),this.adjustment+=a.adjustment},ve.dm.DocumentSynchronizer.synchronizers.insertTextNode=function(a){var b=new ve.dm.TextNode;b.setLength(a.length),a.parentNode.splice(a.index,0,b),this.adjustment+=a.length},ve.dm.DocumentSynchronizer.synchronizers.rebuild=function(a){var b,c,d,e,f=a.oldRange.translate(this.adjustment),g=this.document.selectNodes(f,"siblings");"indexInNode"in g[0]||!g[0].node.getParent()?(c=g[0].node,d=g[0].indexInNode||0,e=0):(b=g[0].node,c=b.getParent(),d=g[0].index,e=g.length),this.document.rebuildNodes(c,d,e,f.from,a.newRange.getLength()),this.adjustment+=a.newRange.getLength()-f.getLength()},ve.dm.DocumentSynchronizer.prototype.getDocument=function(){return this.document},ve.dm.DocumentSynchronizer.prototype.pushAnnotation=function(a){this.actionQueue.push({type:"annotation",range:a})},ve.dm.DocumentSynchronizer.prototype.pushAttributeChange=function(a,b,c,d){this.actionQueue.push({type:"attributeChange",node:a,key:b,from:c,to:d})},ve.dm.DocumentSynchronizer.prototype.pushResize=function(a,b){this.actionQueue.push({type:"resize",node:a,adjustment:b})},ve.dm.DocumentSynchronizer.prototype.pushInsertTextNode=function(a,b,c){this.actionQueue.push({type:"insertTextNode",parentNode:a,index:b,length:c})},ve.dm.DocumentSynchronizer.prototype.pushRebuild=function(a,b){this.actionQueue.push({type:"rebuild",oldRange:a,newRange:b})},ve.dm.DocumentSynchronizer.prototype.queueEvent=function(a){var b=Array.prototype.slice.call(arguments,1),c=OO.getHash(b);a.queuedEventHashes||(a.queuedEventHashes={}),a.queuedEventHashes[c]||(a.queuedEventHashes[c]=!0,this.eventQueue.push({node:a,args:b.concat(this.transaction)}))},ve.dm.DocumentSynchronizer.prototype.synchronize=function(){var a,b,c;for(c=0;c<this.actionQueue.length;c++){if(a=this.actionQueue[c],!Object.prototype.hasOwnProperty.call(ve.dm.DocumentSynchronizer.synchronizers,a.type))throw new Error("Invalid action type "+a.type);ve.dm.DocumentSynchronizer.synchronizers[a.type].call(this,a)}for(c=0;c<this.eventQueue.length;c++)b=this.eventQueue[c],b.node.emit.apply(b.node,b.args),delete b.node.queuedEventHashes;this.actionQueue=[],this.eventQueue=[]},ve.dm.IndexValueStore=function(){this.hashStore={},this.valueStore=[]},ve.dm.IndexValueStore.prototype.index=function(a,b,c){var d;return"string"!=typeof b&&(b=OO.getHash(a)),d=this.indexOfHash(b),(null===d||c)&&(null===d&&(d=this.valueStore.length),this.valueStore[d]=Array.isArray(a)?ve.copy(a):"object"==typeof a?ve.cloneObject(a):a,this.hashStore[b]=d),d},ve.dm.IndexValueStore.prototype.indexOfHash=function(a){return a in this.hashStore?this.hashStore[a]:null},ve.dm.IndexValueStore.prototype.indexes=function(a){var b,c,d=[];for(b=0,c=a.length;c>b;b++)d.push(this.index(a[b]));return d},ve.dm.IndexValueStore.prototype.value=function(a){return this.valueStore[a]},ve.dm.IndexValueStore.prototype.values=function(a){var b,c,d=[];for(b=0,c=a.length;c>b;b++)d.push(this.value(a[b]));return d},ve.dm.IndexValueStore.prototype.clone=function(){var a,b=new this.constructor;b.valueStore=this.valueStore.slice();for(a in this.hashStore)b.hashStore[a]=this.hashStore[a];return b},ve.dm.IndexValueStore.prototype.merge=function(a){var b,c,d={};for(b in a.hashStore)Object.prototype.hasOwnProperty.call(this.hashStore,b)||(c=this.valueStore.push(a.valueStore[a.hashStore[b]])-1,this.hashStore[b]=c),d[a.hashStore[b]]=this.hashStore[b];return d},ve.dm.Converter=function(a,b,c,d){this.modelRegistry=a,this.nodeFactory=b,this.annotationFactory=c,this.metaItemFactory=d,this.doc=null,this.documentData=null,this.store=null,this.internalList=null,this.forClipboard=null,this.fromClipboard=null,this.contextStack=null},ve.dm.Converter.computedAttributes=["href","src"],ve.dm.Converter.getDataContentFromText=function(a,b){var c,d,e=a.split("");if(!b||b.isEmpty())return e;for(c=0,d=e.length;d>c;c++)e[c]=[e[c],b.getIndexes().slice()];return e},ve.dm.Converter.openAndCloseAnnotations=function(a,b,c,d){var e,f,g,h,i,j;for(j=b.clone(),e=0,f=a.getLength();f>e;e++){if(g=a.getIndex(e),!j.containsIndex(g)&&!j.containsComparableForSerialization(a.get(e))){h=e;break}j.removeIndex(g)}if(void 0!==h)for(e=a.getLength()-1;e>=h;e--)d(a.get(e)),a.removeAt(e);for(i=a.clone(),e=0,f=b.getLength();f>e;e++)g=b.getIndex(e),i.containsIndex(g)||i.containsComparableForSerialization(b.get(e))?i.removeIndex(g):(c(b.get(e)),a.pushIndex(g))},ve.dm.Converter.renderHtmlAttributeList=function(a,b,c,d,e){var f,g,h,i,j,k;if(void 0===c&&(c=!0),c!==!1)for(f=0,g=a.length;g>f;f++)if(b[f]&&(j=a[f].attributes)){for(h=0,i=j.length;i>h;h++)b[f].hasAttribute(j[h].name)||c!==!0&&!c(j[h].name)||(k=d&&-1!==ve.dm.Converter.computedAttributes.indexOf(j[h].name)?a[f][j[h].name]:j[h].value,b[f].setAttribute(j[h].name,k)),(c===!0||c(j[h].name))&&(k=d&&-1!==ve.dm.Converter.computedAttributes.indexOf(j[h].name)?a[f][j[h].name]:j[h].value);e&&a[f].children.length>0&&ve.dm.Converter.renderHtmlAttributeList(a[f].children,b[f].children,c,d,!0)}},ve.dm.Converter.prototype.isConverting=function(){return null!==this.contextStack},ve.dm.Converter.prototype.getStore=function(){return this.store},ve.dm.Converter.prototype.getHtmlDocument=function(){return this.doc},ve.dm.Converter.prototype.getTargetHtmlDocument=function(){return this.targetDoc},ve.dm.Converter.prototype.isForClipboard=function(){return this.forClipboard},ve.dm.Converter.prototype.isFromClipboard=function(){return this.fromClipboard},ve.dm.Converter.prototype.getCurrentContext=function(){return null===this.contextStack?null:this.contextStack[this.contextStack.length-1]},ve.dm.Converter.prototype.getActiveAnnotations=function(){var a=this.getCurrentContext();return a?a.annotations:null},ve.dm.Converter.prototype.isExpectingContent=function(){var a=this.getCurrentContext();return a?a.expectingContent:null},ve.dm.Converter.prototype.isValidChildNodeType=function(a){var b,c=this.getCurrentContext();return c?(b=this.nodeFactory.getChildNodeTypes(c.branchType),null===b||-1!==b.indexOf(a)):null},ve.dm.Converter.prototype.isInWrapper=function(){var a=this.getCurrentContext();return a?a.inWrapper:null},ve.dm.Converter.prototype.canCloseWrapper=function(){var a=this.getCurrentContext();return a?a.canCloseWrapper:null},ve.dm.Converter.prototype.getDomElementsFromDataElement=function(a,b,c){var d,e=Array.isArray(a)?a[0]:a,f=this.modelRegistry.lookup(e.type);if(!f)throw new Error("Attempting to convert unknown data element type "+e.type);if(f["static"].isInternal)return!1;if(d=f["static"].toDomElements(a,b,this,c),!(Array.isArray(d)||f.prototype instanceof ve.dm.Annotation))throw new Error("toDomElements() failed to return an array when converting element of type "+e.type);return e.originalDomElements&&!ve.isEqualDomElements(d,e.originalDomElements)&&ve.dm.Converter.renderHtmlAttributeList(e.originalDomElements,d,f["static"].preserveHtmlAttributes,!1,!(f instanceof ve.dm.Node)||!this.nodeFactory.canNodeHaveChildren(e.type)||this.nodeFactory.doesNodeHandleOwnChildren(e.type)),d},ve.dm.Converter.prototype.createDataElements=function(a,b){var c=a["static"].toDataElement(b,this);return c?(Array.isArray(c)||(c=[c]),c[0].originalDomElements=b,c):null},ve.dm.Converter.prototype.getDomElementFromDataAnnotation=function(a,b){var c=a.toHtml(),d=b.createElement(c.tag);return ve.setDomAttributes(d,c.attributes),d},ve.dm.Converter.prototype.getModelFromDom=function(a,b,c){var d,e,f,g=new ve.dm.IndexValueStore,h=new ve.dm.InternalList;return b=b||{},this.doc=a,this.targetDoc=b.targetDoc||a,this.fromClipboard=b.fromClipboard,this.store=g,this.internalList=h,this.contextStack=[],d=new ve.dm.FlatLinearData(g,this.getDataFromDomSubtree(a.body)),e=this.internalList.convertToData(this,a),d.batchSplice(d.getLength(),0,e),f=this.getInnerWhitespace(d),this.doc=null,this.targetDoc=null,this.fromClipboard=null,this.store=null,this.internalList=null,this.contextStack=null,c?c.createDocument(d,this.nodeFactory,a,void 0,h,f,b.lang,b.dir):new ve.dm.Document(d,this.nodeFactory,a,void 0,h,f,b.lang,b.dir)},ve.dm.Converter.prototype.getDataFromDomClean=function(a,b,c){var d,e=this.contextStack;return this.contextStack=[],d=this.getDataFromDomSubtree(a,b,c),this.contextStack=e,d},ve.dm.Converter.prototype.getDataFromDomSubtree=function(a,b,c){function d(a,b,c){c&&(a.internal||(a.internal={}),a.internal.whitespace||(a.internal.whitespace=[]),a.internal.whitespace[b]=c)}function e(a){""!==C&&(d(a,0,C),C="")}function f(a){var b,c,e=[],f=q;for(b=0,c=E.length;c>b;b++)E[b].type&&"/"!==E[b].type.charAt(0)&&(E[b].internal&&E[b].internal.whitespace&&("restore"===a?(e=e.concat(ve.dm.Converter.getDataContentFromText(E[b].internal.whitespace[0],F.annotations)),delete E[b].internal):"fixup"===a&&d(f,3,E[b].internal.whitespace[0])),f=E[b]),e.push(E[b]);""!==D&&"restore"===a?ve.batchSplice(B,z,0,e):B=B.concat(e),E=[]}function g(){q={type:"paragraph",internal:{generated:"wrapper"}},B.push(q),F.inWrapper=!0,F.canCloseWrapper=!0,F.expectingContent=!0,e(q)}function h(){""!==D&&(B.splice(z,D.length),d(E.length>0?E[E.length-2]:q,3,D),C=D),B.push({type:"/paragraph"}),f("fixup"),q=void 0,F.inWrapper=!1,F.canCloseWrapper=!1,F.expectingContent=F.originallyExpectingContent}function i(a){var b,c,d=[],e=[a];if(!a.getAttribute||null===a.getAttribute("about"))return e;for(b=a.getAttribute("about"),c=a.nextSibling;c;c=c.nextSibling)if(c.getAttribute){if(c.getAttribute("about")!==b)break;e=e.concat(d),d=[],e.push(c)}else d.push(c);return e}function j(a,b){var c,d,e;for(c=a.length-1;c>=0;c--){if(d=ve.dm.LinearData["static"].getType(a[c]),!d)return!1;if(e=A.lookup(d)||ve.dm.AlienNode,!(e.prototype===b.prototype||e.prototype instanceof b))return!1}return!0}var k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A=this.modelRegistry,B=[],C="",D="",E=[],F={},G=this.contextStack.length?this.contextStack[this.contextStack.length-1]:null;for(F.annotations=c||(G?G.annotations.clone():new ve.dm.AnnotationSet(this.store)),F.branchType=b?b.type:G?G.branchType:"document",F.branchHasContent=this.nodeFactory.canNodeContainContent(F.branchType),F.originallyExpectingContent=F.branchHasContent||!F.annotations.isEmpty(),F.expectingContent=F.originallyExpectingContent,F.inWrapper=G?G.inWrapper:!1,F.canCloseWrapper=!1,this.contextStack.push(F),b&&B.push(b),k=0;k<a.childNodes.length;k++)switch(l=a.childNodes[k],l.nodeType){case Node.ELEMENT_NODE:case Node.COMMENT_NODE:if(l.getAttribute&&l.getAttribute("data-ve-ignore"))continue;if(x=i(l),t=this.modelRegistry.matchElement(l,x.length>1),u=this.modelRegistry.lookup(t)||ve.dm.AlienNode,m=u.prototype instanceof ve.dm.Annotation?[l]:u["static"].enableAboutGrouping?x:[l],n=this.createDataElements(u,m),n?u=this.modelRegistry.lookup(n[0].type):(u=ve.dm.AlienNode,m=u["static"].enableAboutGrouping?x:[l],n=this.createDataElements(u,m)),u.prototype instanceof ve.dm.Annotation)v=this.annotationFactory.createFromElement(n[0]),F.inWrapper||F.expectingContent||(g(),r=q),s=F.annotations.clone(),s.push(v),n=this.getDataFromDomSubtree(l,void 0,s),(!n.length||j(n,ve.dm.AlienMetaItem))&&(n=this.createDataElements(ve.dm.AlienMetaItem,m),n.push({type:"/"+n[0].type}),F.annotations.isEmpty()||(n[0].annotations=F.annotations.getIndexes().slice())),f("restore"),B=B.concat(n),D="";
else{if(u.prototype instanceof ve.dm.MetaItem){1===n.length&&n.push({type:"/"+n[0].type}),F.annotations.isEmpty()||(n[0].annotations=F.annotations.getIndexes().slice()),F.inWrapper&&F.canCloseWrapper?(E=E.concat(n),""!==D&&(B.splice(z,D.length),d(n[0],0,D),C=D,D="")):(f("restore"),B=B.concat(n),e(n[0]),r=n[0]),k+=m.length-1;break}w=this.nodeFactory.isNodeContent(n[0].type),!F.expectingContent&&w?(g(),r=q):F.expectingContent&&!w&&(F.inWrapper&&F.canCloseWrapper?h():(u=ve.dm.AlienNode,m=u["static"].enableAboutGrouping?x:[l],n=this.createDataElements(u,m),w=this.nodeFactory.isNodeContent(n[0].type))),F.inWrapper&&w&&(f("restore"),D="",C=""),w&&!F.annotations.isEmpty()&&(n[0].annotations=F.annotations.getIndexes().slice()),1===n.length&&1===m.length&&this.nodeFactory.canNodeHaveChildren(n[0].type)&&!this.nodeFactory.doesNodeHandleOwnChildren(n[0].type)?(f("restore"),B=B.concat(this.getDataFromDomSubtree(l,n[0],new ve.dm.AnnotationSet(this.store)))):(1===n.length&&n.push({type:"/"+n[0].type}),f("restore"),B=B.concat(n)),e(n[0]),r=n[0],k+=m.length-1}break;case Node.TEXT_NODE:if(o=l.data,""===o)break;if(!F.originallyExpectingContent){if(o.match(/^\s+$/)){F.inWrapper?(D=o,z=B.length,B=B.concat(ve.dm.Converter.getDataContentFromText(D,F.annotations))):(r?d(r,3,o):b&&d(b,1,o),C=o,D="",f("restore"));break}p=o.match(/^(\s*)([\s\S]*?)(\s*)$/),F.inWrapper?(f("restore"),B=B.concat(ve.dm.Converter.getDataContentFromText(p[1],F.annotations))):(g(),""!==p[1]&&(r?d(r,3,p[1]):b&&d(b,1,p[1]),d(q,0,p[1]))),B=B.concat(ve.dm.Converter.getDataContentFromText(p[2],F.annotations)),D=p[3],z=B.length,B=B.concat(ve.dm.Converter.getDataContentFromText(D,F.annotations)),r=q;break}F.annotations.isEmpty()&&0===k&&b&&!this.nodeFactory.doesNodeHaveSignificantWhitespace(b.type)&&(p=o.match(/^\s+/),p&&""!==p[0]&&(d(b,1,p[0]),o=o.slice(p[0].length))),F.annotations.isEmpty()&&k===a.childNodes.length-1&&b&&!this.nodeFactory.doesNodeHaveSignificantWhitespace(b.type)&&(p=o.match(/\s+$/),p&&""!==p[0]&&(d(b,2,p[0]),o=o.slice(0,o.length-p[0].length))),B=B.concat(ve.dm.Converter.getDataContentFromText(o,F.annotations))}return F.inWrapper&&F.canCloseWrapper&&(h(),F.inWrapper=!0),"paragraph"===F.branchType||!b||B[B.length-1]!==b||F.inWrapper||this.nodeFactory.canNodeContainContent(F.branchType)||this.nodeFactory.isNodeContent(F.branchType)||!this.isValidChildNodeType("paragraph")||(y={type:"paragraph",internal:{generated:"empty"}},e(y),B.push(y),B.push({type:"/paragraph"})),b&&(""!==C&&B[B.length-1]!==b&&(d(b,2,C),C=""),B.push({type:"/"+b.type})),"document"===F.branchType&&j(B,ve.dm.MetaItem)&&!c&&(y={type:"paragraph",internal:{generated:"empty"}},e(y),B.push(y),B.push({type:"/paragraph"})),this.contextStack.pop(),B},ve.dm.Converter.prototype.getInnerWhitespace=function(a){var b,c=new Array(2),d=0,e=a.getLength()-1;if(a.isOpenElementData(0)&&(b=ve.getProp(a.getData(0),"internal","whitespace"),c[0]=b?b[0]:void 0),a.isCloseElementData(e)){for(d++;--e;)if(a.isCloseElementData(e))d++;else if(a.isOpenElementData(e)&&(d--,0===d&&"internalList"!==a.getType(e)))break;b=ve.getProp(a.getData(e),"internal","whitespace"),c[1]=b?b[3]:void 0}return c},ve.dm.Converter.prototype.getDomFromModel=function(a,b){var c=ve.createDocumentFromHtml("");return this.getDomSubtreeFromModel(a,c.body,b),c},ve.dm.Converter.prototype.getDomSubtreeFromModel=function(a,b,c){this.documentData=a.getFullData(),this.store=a.getStore(),this.internalList=a.getInternalList(),this.forClipboard=!!c,this.getDomSubtreeFromData(this.documentData,b,a.getInnerWhitespace()),this.documentData=null,this.store=null,this.internalList=null,this.forClipboard=null},ve.dm.Converter.prototype.getDomSubtreeFromData=function(a,b,c){function d(){i.length>0&&(D.push(H.createTextNode(i)),i=""),D=[],C.push(D)}function e(a){var b,c,d,e,f,g,h,j="",k="",l=a.getOriginalDomElements()[0]&&a.getOriginalDomElements()[0].textContent||"";for(i.length>0&&(D.push(H.createTextNode(i)),i=""),e=C.pop(),D=C[C.length-1],g=e[0];g&&g.nodeType===Node.TEXT_NODE&&(f=g.data.match(/^\s+/))&&!l.match(/^\s/)&&(j+=f[0],g.deleteData(0,f[0].length),0===g.data.length);)e.shift(),g=e[0];for(h=e[e.length-1];h&&h.nodeType===Node.TEXT_NODE&&(f=h.data.match(/\s+$/))&&!l.match(/\s$/)&&(k=f[0]+k,h.deleteData(h.data.length-f[0].length,f[0].length),0===h.data.length);)e.pop(),h=e[e.length-1];if(e.length&&(d=G.getDomElementsFromDataElement(a.getElement(),H,e)[0]),j&&D.push(H.createTextNode(j)),d){for(b=0,c=e.length;c>b;b++)d.appendChild(e[b]);D.push(d)}else for(b=0,c=e.length;c>b;b++)D.push(e[b]);k&&D.push(H.createTextNode(k))}function f(b){var c,d;for(c=b+1,d=1;E>c&&d>0;c++)a[c].type&&(d+="/"===a[c].type.charAt(0)?-1:1);if(0!==d)throw new Error("Unbalanced data: "+d+" element(s) left open.");return c}function g(){var b;return b=K.lookup(a[j].type)&&K.doesNodeHandleOwnChildren(a[j].type)?a.slice(j,f(j)):a[j]}function h(){var b,c;for(j=0;E>j;j++)a[j].type&&"/"!==a[j].type.charAt(0)&&K.lookup(a[j].type)&&K.isNodeInternal(a[j].type)&&(b||(b=a.slice()),c=f(j),b.splice(j-(E-b.length),c-j),j=c-1);b&&(a=b,E=a.length)}var i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E=a.length,F=[],G=this,H=b.ownerDocument,I=b,J=new ve.dm.AnnotationSet(this.store),K=this.nodeFactory;for(h(),j=0;E>j;j++)if("string"==typeof a[j]){for(i="",l=j>0&&ve.dm.LinearData["static"].isOpenElementData(a[j-1])&&!K.doesNodeHaveSignificantWhitespace(ve.dm.LinearData["static"].getType(a[j-1]));"string"==typeof a[j];)l&&a[j].match(/\s/)||(i+=a[j],l=!1),j++;j--,i.length>0&&I.appendChild(H.createTextNode(i))}else if(Array.isArray(a[j])||void 0!==a[j].annotations&&(this.metaItemFactory.lookup(a[j].type)||this.nodeFactory.isNodeContent(a[j].type))){for(i="",D=[],C=[D];void 0!==a[j]&&(Array.isArray(a[j])||void 0!==a[j].annotations&&(this.metaItemFactory.lookup(a[j].type)||this.nodeFactory.isNodeContent(a[j].type)));){if(m=new ve.dm.AnnotationSet(this.store,a[j].annotations||a[j][1]),ve.dm.Converter.openAndCloseAnnotations(J,m,d,e),void 0===a[j].annotations)i+=a[j][0];else{for(i.length>0&&(D.push(H.createTextNode(i)),i=""),o=g(),q=this.getDomElementsFromDataElement(o,H),k=0;k<q.length;k++)D.push(q[k]);Array.isArray(o)?j+=o.length-1:j++}j++}for(j--,i.length>0&&(D.push(H.createTextNode(i)),i=""),ve.dm.Converter.openAndCloseAnnotations(J,new ve.dm.AnnotationSet(this.store),d,e),k=0;k<D.length;k++)I.appendChild(D[k])}else if(void 0!==a[j].type)if(n=a[j],"/"===n.type.charAt(0)){if(u=I.parentNode,B=a[j].type.slice(1),this.metaItemFactory.lookup(B)?w=F[F.length-1]:(w=this.nodeFactory.isNodeContent(B),F.pop()),p=u.lastOuterPost,!w&&I.veInternal&&I.veInternal.whitespace?(r=I.veInternal.whitespace[1],r&&(I.firstChild&&I.firstChild.nodeType===Node.TEXT_NODE?I.firstChild.insertData(0,r):(A=H.createTextNode(r),A.veIsWhitespace=!0,I.insertBefore(A,I.firstChild))),v=I.veInternal.childDomElements?I.veInternal.childDomElements[I.veInternal.childDomElements.length-1].lastChild:I.lastChild,s=I.veInternal.whitespace[2],t=void 0===I.lastOuterPost?s:I.lastOuterPost,s&&s===t&&(v&&v.nodeType===Node.TEXT_NODE?I.lastChild.appendData(s):(A=H.createTextNode(s),A.veIsWhitespace=!0,I.appendChild(A))),u.lastOuterPost=I.veInternal.whitespace[3]||""):w||(u.lastOuterPost=""),z=!1,I.veInternal)switch(I.veInternal.generated){case"slug":0===I.childNodes.length&&(z=!0);break;case"empty":0!==I.childNodes.length||j!==a.length-1&&"/"!==a[j+1].type.charAt(0)||(z=!0);break;case"wrapper":for(z=!0,y=I.parentElement.childNodes,k=y.length-2;k>=0;k--){if(x=y[k],x.nodeType===Node.TEXT_NODE&&!x.veIsWhitespace){z=!1;break}if(ve.isBlockElement(x))break}}if(z){if(I.childNodes.length)for(;I.firstChild;)u.insertBefore(I.firstChild,I);else u.lastOuterPost=p||"";u.removeChild(I)}delete I.veInternal,delete I.lastOuterPost,K.lookup(B)&&K.isNodeInternal(B)||(I=u)}else{if(this.metaItemFactory.lookup(a[j].type)?w=F[F.length-1]:(F.push(F[F.length-1]||this.nodeFactory.canNodeContainContent(a[j].type)),w=this.nodeFactory.isNodeContent(a[j].type)),o=g(),q=this.getDomElementsFromDataElement(o,H),q&&!q.length){j=f(j)-1;continue}if(q){for(q[0].veInternal=ve.extendObject({childDomElements:q},n.internal?ve.copy(n.internal):{}),k=0;k<q.length;k++)I.appendChild(q[k]);u=I,I=q[0],I.veInternal&&I.veInternal.whitespace?(s=I.veInternal.whitespace[0],t=void 0,I.previousSibling?t=u.lastOuterPost:u===b?t=c?c[0]:s:u.veInternal&&u.veInternal.whitespace&&(t=u.veInternal.whitespace[1],u.veInternal.whitespace[1]=void 0),s&&s===t&&(A=H.createTextNode(s),A.veIsWhitespace=!0,u.insertBefore(A,I))):!w&&!I.previousSibling&&u.veInternal&&u.veInternal.whitespace&&(u.veInternal.whitespace[1]=void 0)}Array.isArray(o)&&(j+=o.length-2)}void 0===b.lastOuterPost||c&&b.lastOuterPost!==c[1]||(b.lastChild&&b.lastChild.nodeType===Node.TEXT_NODE?b.lastChild.appendData(b.lastOuterPost):b.lastOuterPost.length>0&&b.appendChild(H.createTextNode(b.lastOuterPost)),delete b.lastOuterPost),ve.normalizeNode(b)},ve.dm.converter=new ve.dm.Converter(ve.dm.modelRegistry,ve.dm.nodeFactory,ve.dm.annotationFactory,ve.dm.metaItemFactory),ve.dm.LinearSelection=function(a,b){ve.dm.LinearSelection["super"].call(this,a),this.range=b},OO.inheritClass(ve.dm.LinearSelection,ve.dm.Selection),ve.dm.LinearSelection["static"].name="linear",ve.dm.LinearSelection["static"].newFromHash=function(a,b){return new ve.dm.LinearSelection(a,ve.Range["static"].newFromHash(b.range))},ve.dm.LinearSelection.prototype.toJSON=function(){return{type:this.constructor["static"].name,range:this.range}},ve.dm.LinearSelection.prototype.getDescription=function(){return"Linear: "+this.range.from+" - "+this.range.to},ve.dm.LinearSelection.prototype.clone=function(){return new this.constructor(this.getDocument(),this.getRange())},ve.dm.LinearSelection.prototype.collapseToStart=function(){return new this.constructor(this.getDocument(),new ve.Range(this.getRange().start))},ve.dm.LinearSelection.prototype.collapseToEnd=function(){return new this.constructor(this.getDocument(),new ve.Range(this.getRange().end))},ve.dm.LinearSelection.prototype.collapseToFrom=function(){return new this.constructor(this.getDocument(),new ve.Range(this.getRange().from))},ve.dm.LinearSelection.prototype.collapseToTo=function(){return new this.constructor(this.getDocument(),new ve.Range(this.getRange().to))},ve.dm.LinearSelection.prototype.isCollapsed=function(){return this.getRange().isCollapsed()},ve.dm.Selection.prototype.translateByTransaction=function(a,b){return new this.constructor(this.getDocument(),a.translateRange(this.getRange(),b))},ve.dm.LinearSelection.prototype.getRanges=function(){return[this.range]},ve.dm.LinearSelection.prototype.getRange=function(){return this.range},ve.dm.LinearSelection.prototype.equals=function(a){return a instanceof ve.dm.LinearSelection&&this.getDocument()===a.getDocument()&&this.getRange().equals(a.getRange())},ve.dm.selectionFactory.register(ve.dm.LinearSelection),ve.dm.NullSelection=function(a){ve.dm.NullSelection["super"].call(this,a)},OO.inheritClass(ve.dm.NullSelection,ve.dm.Selection),ve.dm.NullSelection["static"].name="null",ve.dm.NullSelection["static"].newFromHash=function(a){return new ve.dm.NullSelection(a)},ve.dm.NullSelection.prototype.toJSON=function(){return{type:this.constructor["static"].name}},ve.dm.NullSelection.prototype.getDescription=function(){return"Null"},ve.dm.NullSelection.prototype.clone=function(){return new this.constructor(this.getDocument())},ve.dm.NullSelection.prototype.collapseToStart=ve.dm.NullSelection.prototype.clone,ve.dm.NullSelection.prototype.collapseToEnd=ve.dm.NullSelection.prototype.clone,ve.dm.NullSelection.prototype.collapseToFrom=ve.dm.NullSelection.prototype.clone,ve.dm.NullSelection.prototype.collapseToTo=ve.dm.NullSelection.prototype.clone,ve.dm.NullSelection.prototype.isCollapsed=function(){return!0},ve.dm.NullSelection.prototype.translateByTransaction=ve.dm.NullSelection.prototype.clone,ve.dm.NullSelection.prototype.getRanges=function(){return[]},ve.dm.NullSelection.prototype.equals=function(a){return a instanceof ve.dm.NullSelection&&this.getDocument()===a.getDocument()},ve.dm.NullSelection.prototype.isNull=function(){return!0},ve.dm.selectionFactory.register(ve.dm.NullSelection),ve.dm.TableSelection=function(a,b,c,d,e,f,g){ve.dm.TableSelection["super"].call(this,a),this.tableRange=b,this.tableNode=null,e=void 0===e?c:e,f=void 0===f?d:f,this.fromCol=c,this.fromRow=d,this.toCol=e,this.toRow=f,this.startCol=e>c?c:e,this.startRow=f>d?d:f,this.endCol=e>c?e:c,this.endRow=f>d?f:d,this.intendedFromCol=this.fromCol,this.intendedFromRow=this.fromRow,this.intendedToCol=this.toCol,this.intendedToRow=this.toRow,g&&this.expand()},OO.inheritClass(ve.dm.TableSelection,ve.dm.Selection),ve.dm.TableSelection["static"].name="table",ve.dm.TableSelection["static"].newFromHash=function(a,b){return new ve.dm.TableSelection(a,ve.Range["static"].newFromHash(b.tableRange),b.fromCol,b.fromRow,b.toCol,b.toRow)},ve.dm.TableSelection.prototype.expand=function(){for(var a,b,c=0,d=1/0,e=1/0,f=-1/0,g=-1/0,h=this.fromCol>this.toCol,i=this.fromRow>this.toRow,j=this.getMatrixCells();j.length>c;){for(b=0;b<j.length;b++)a=j[b],d=Math.min(d,a.col),e=Math.min(e,a.row),f=Math.max(f,a.col+a.node.getColspan()-1),g=Math.max(g,a.row+a.node.getRowspan()-1);this.startCol=d,this.startRow=e,this.endCol=f,this.endRow=g,this.fromCol=h?f:d,this.fromRow=i?g:e,this.toCol=h?d:f,this.toRow=i?e:g,c=j.length,j=this.getMatrixCells()}},ve.dm.TableSelection.prototype.clone=function(){return new this.constructor(this.getDocument(),this.tableRange,this.fromCol,this.fromRow,this.toCol,this.toRow)},ve.dm.TableSelection.prototype.toJSON=function(){return{type:this.constructor["static"].name,tableRange:this.tableRange,fromCol:this.fromCol,fromRow:this.fromRow,toCol:this.toCol,toRow:this.toRow}},ve.dm.TableSelection.prototype.getDescription=function(){return"Table: "+this.tableRange.from+" - "+this.tableRange.to+", c"+this.fromCol+" r"+this.fromRow+" - c"+this.toCol+" r"+this.toRow},ve.dm.TableSelection.prototype.collapseToStart=function(){return new this.constructor(this.getDocument(),this.tableRange,this.startCol,this.startRow,this.startCol,this.startRow)},ve.dm.TableSelection.prototype.collapseToEnd=function(){return new this.constructor(this.getDocument(),this.tableRange,this.endCol,this.endRow,this.endCol,this.endRow)},ve.dm.TableSelection.prototype.collapseToFrom=function(){return new this.constructor(this.getDocument(),this.tableRange,this.fromCol,this.fromRow,this.fromCol,this.fromRow)},ve.dm.TableSelection.prototype.collapseToTo=function(){return new this.constructor(this.getDocument(),this.tableRange,this.toCol,this.toRow,this.toCol,this.toRow)},ve.dm.TableSelection.prototype.getRanges=function(){var a,b,c=[],d=this.getMatrixCells();for(a=0,b=d.length;b>a;a++)c.push(d[a].node.getRange());return c},ve.dm.TableSelection.prototype.getOuterRanges=function(){var a,b,c=[],d=this.getMatrixCells();for(a=0,b=d.length;b>a;a++)c.push(d[a].node.getOuterRange());return c},ve.dm.TableSelection.prototype.getMatrixCells=function(a){var b,c,d,e=this.getTableNode().getMatrix(),f=[],g={};for(b=this.startRow;b<=this.endRow;b++)for(c=this.startCol;c<=this.endCol;c++)d=e.getCell(b,c),d&&(!a&&d.isPlaceholder()&&(d=d.owner),g[d.key]||(f.push(d),g[d.key]=!0));return f},ve.dm.TableSelection.prototype.isCollapsed=function(){return!1},ve.dm.TableSelection.prototype.translateByTransaction=function(a,b){var c=a.translateRange(this.tableRange,b);return c.isCollapsed()?new ve.dm.NullSelection(this.getDocument()):new this.constructor(this.getDocument(),c,this.fromCol,this.fromRow,this.toCol,this.toRow)},ve.dm.TableSelection.prototype.isSingleCell=function(){return this.fromRow===this.toRow&&this.fromCol===this.toCol||1===this.getMatrixCells().length},ve.dm.TableSelection.prototype.getTableNode=function(){return this.tableNode||(this.tableNode=this.getDocument().getBranchNodeFromOffset(this.tableRange.start+1)),this.tableNode},ve.dm.TableSelection.prototype.newFromAdjustment=function(a,b,c,d){function e(a,b,c){for(var d,e=b.col,f=b.row,g=c>0?1:-1;0!==c;){if("col"===a){if(e+=g,e>=h.getColCount(f)||0>e)break}else if(f+=g,f>=h.getRowCount()||0>f)break;d=h.getCell(f,e),d&&!d.equals(b)&&(c-=g,b=d)}return b}var f,g,h=this.getTableNode().getMatrix();return void 0===c&&(c=a),void 0===d&&(d=b),f=h.getCell(this.intendedFromRow,this.intendedFromCol),a&&(f=e("col",f,a)),b&&(f=e("row",f,b)),g=h.getCell(this.intendedToRow,this.intendedToCol),c&&(g=e("col",g,c)),d&&(g=e("row",g,d)),new this.constructor(this.getDocument(),this.tableRange,f.col,f.row,g.col,g.row,!0)},ve.dm.TableSelection.prototype.equals=function(a){return a instanceof ve.dm.TableSelection&&this.getDocument()===a.getDocument()&&this.tableRange.equals(a.tableRange)&&this.fromCol===a.fromCol&&this.fromRow===a.fromRow&&this.toCol===a.toCol&&this.toRow===a.toRow},ve.dm.TableSelection.prototype.getRowCount=function(){return this.endRow-this.startRow+1},ve.dm.TableSelection.prototype.getColCount=function(){return this.endCol-this.startCol+1},ve.dm.TableSelection.prototype.isFullRow=function(){var a=this.getTableNode().getMatrix();return this.getColCount()===a.getColCount()},ve.dm.TableSelection.prototype.isFullCol=function(){var a=this.getTableNode().getMatrix();return this.getRowCount()===a.getRowCount()},ve.dm.TableSelection.prototype.isFullTable=function(){var a=this.getTableNode().getMatrix();return 0===this.startCol&&this.endCol===a.getColCount()-1&&0===this.startRow&&this.endRow===a.getRowCount()-1},ve.dm.selectionFactory.register(ve.dm.TableSelection),ve.dm.FlatLinearData=function(){ve.dm.FlatLinearData["super"].apply(this,arguments)},OO.inheritClass(ve.dm.FlatLinearData,ve.dm.LinearData),ve.dm.FlatLinearData.prototype.getType=function(a){return ve.dm.LinearData["static"].getType(this.getData(a))},ve.dm.FlatLinearData.prototype.isElementData=function(a){return ve.dm.LinearData["static"].isElementData(this.getData(a))},ve.dm.FlatLinearData.prototype.containsElementData=function(){for(var a=this.getLength();a--;)if(this.isElementData(a))return!0;return!1},ve.dm.FlatLinearData.prototype.isOpenElementData=function(a){return ve.dm.LinearData["static"].isOpenElementData(this.getData(a))},ve.dm.FlatLinearData.prototype.isCloseElementData=function(a){return ve.dm.LinearData["static"].isCloseElementData(this.getData(a))},ve.dm.ElementLinearData=function(a,b,c){ve.dm.ElementLinearData["super"].apply(this,arguments),this.nodeFactory=c||ve.dm.nodeFactory},OO.inheritClass(ve.dm.ElementLinearData,ve.dm.FlatLinearData),ve.dm.ElementLinearData["static"].startWordRegExp=new RegExp("^("+unicodeJS.characterclass.patterns.word+")"),ve.dm.ElementLinearData["static"].endWordRegExp=new RegExp("("+unicodeJS.characterclass.patterns.word+")$"),ve.dm.ElementLinearData["static"].compareElements=function(a,b){if(void 0===a||void 0===b)return!1;var c=a,d=b;return Array.isArray(a)&&(c=a[0]),Array.isArray(b)&&(d=b[0]),a&&a.type&&(c={type:a.type,attributes:a.attributes}),b&&b.type&&(d={type:b.type,attributes:b.attributes}),ve.compare(c,d)},ve.dm.ElementLinearData.prototype.isContentOffset=function(a){if(0===a||a===this.getLength())return!1;var b=this.getData(a-1),c=this.getData(a),d=this.nodeFactory;return void 0!==b&&void 0!==c&&("string"==typeof b||"string"==typeof c||Array.isArray(b)||Array.isArray(c)||"string"==typeof b.type&&"/"===b.type.charAt(0)&&d.isNodeContent(b.type.slice(1))||"string"==typeof c.type&&"/"!==c.type.charAt(0)&&d.isNodeContent(c.type)||"/"+b.type===c.type&&d.canNodeContainContent(b.type))},ve.dm.ElementLinearData.prototype.isStructuralOffset=function(a,b){if(0===a||a===this.getLength())return!0;var c=this.getData(a-1),d=this.getData(a),e=this.nodeFactory;return!(void 0===c||void 0===d||"string"!=typeof c.type||"string"!=typeof d.type||("/"!==c.type.charAt(0)||!e.canNodeHaveChildren(c.type.slice(1))&&e.isNodeContent(c.type.slice(1))||b&&null!==e.getParentNodeTypes(c.type.slice(1)))&&("/"===d.type.charAt(0)||!e.canNodeHaveChildren(d.type)&&e.isNodeContent(d.type)||b&&null!==e.getParentNodeTypes(d.type))&&("/"+c.type!==d.type||!e.canNodeHaveChildrenNotContent(c.type)||b&&null!==e.getChildNodeTypes(c.type)))},ve.dm.ElementLinearData.prototype.isContentData=function(){for(var a,b=this.getLength();b--;)if(a=this.getData(b),void 0!==a.type&&"/"!==a.type.charAt(0)&&!this.nodeFactory.isNodeContent(a.type))return!1;return!0},ve.dm.ElementLinearData.prototype.getAnnotationIndexesFromOffset=function(a,b){if(0>a||a>this.getLength())throw new Error("offset "+a+" out of bounds");b||!this.isCloseElementData(a)||this.nodeFactory.canNodeHaveChildren(this.getType(a))||(a=this.getRelativeContentOffset(a,-1));var c=this.getData(a);return void 0===c||"string"==typeof c?[]:c.annotations?c.annotations.slice():c[1]?c[1].slice():[]},ve.dm.ElementLinearData.prototype.getAnnotationsFromOffset=function(a,b){return new ve.dm.AnnotationSet(this.getStore(),this.getAnnotationIndexesFromOffset(a,b))},ve.dm.ElementLinearData.prototype.setAnnotationsAtOffset=function(a,b){this.setAnnotationIndexesAtOffset(a,this.getStore().indexes(b.get()))},ve.dm.ElementLinearData.prototype.setAnnotationIndexesAtOffset=function(a,b){var c,d=this.getData(a),e=this.isElementData(a);b.length>0?e?d.annotations=b:(c=this.getCharacterData(a),this.setData(a,[c,b])):e?delete d.annotations:(c=this.getCharacterData(a),this.setData(a,c))},ve.dm.ElementLinearData.prototype.setAttributeAtOffset=function(a,b,c){var d=this.getData(a);this.isElementData(a)&&(void 0===c?d.attributes&&delete d.attributes[b]:(d.attributes||(d.attributes={}),d.attributes[b]=c))},ve.dm.ElementLinearData.prototype.getCharacterData=function(a){var b=this.getData(a),c=Array.isArray(b)?b[0]:b;return"string"==typeof c?c:""},ve.dm.ElementLinearData.prototype.getAnnotatedRangeFromOffset=function(a,b){var c=a,d=a;if(this.getAnnotationsFromOffset(a).contains(b)===!1)return null;for(;c>0;)if(c--,this.getAnnotationsFromOffset(c).contains(b)===!1){c++;break}for(;d<this.getLength()&&this.getAnnotationsFromOffset(d).contains(b)!==!1;)d++;return new ve.Range(c,d)},ve.dm.ElementLinearData.prototype.getAnnotatedRangeFromSelection=function(a,b){for(var c=a.start,d=a.end;c>0;)if(c--,this.getAnnotationsFromOffset(c).contains(b)===!1){c++;break}for(;d<this.getLength()&&this.getAnnotationsFromOffset(d).contains(b)!==!1;)d++;return new ve.Range(c,d)},ve.dm.ElementLinearData.prototype.getAnnotationsFromRange=function(a,b){var c,d,e,f=0;for(c=a.start;c<a.end;c++)if(!(this.isElementData(c)&&(this.nodeFactory.shouldIgnoreChildren(this.getType(c))&&(f+=this.isOpenElementData(c)?1:-1),!this.nodeFactory.isNodeContent(this.getType(c)))||f>0))if(d){if(e=this.getAnnotationsFromOffset(c),b&&!e.isEmpty())d.addSet(e);else if(!b){if(e.isEmpty())return new ve.dm.AnnotationSet(this.getStore());if(d=d.getComparableAnnotationsFromSet(e),d.isEmpty())break}}else if(d=this.getAnnotationsFromOffset(c),0===a.getLength()||1===a.getLength())return d;return d||new ve.dm.AnnotationSet(this.getStore())},ve.dm.ElementLinearData.prototype.hasAnnotationsInRange=function(a){var b;for(b=a.start;b<a.end;b++)if(this.getAnnotationIndexesFromOffset(b,!0).length)return!0;return!1},ve.dm.ElementLinearData.prototype.trimOuterSpaceFromRange=function(a){for(var b=a.start,c=a.end;this.getCharacterData(c-1).match(/\s/);)c--;for(;c>b&&this.getCharacterData(b).match(/\s/);)b++;return a.to<a.end?new ve.Range(c,b):new ve.Range(b,c)},ve.dm.ElementLinearData.prototype.getText=function(a,b){var c,d="";for(b=b||new ve.Range(0,this.getLength()),c=b.start;c<b.end;c++)this.isElementData(c)?a&&(d+="\n"):d+=this.getCharacterData(c);return d},ve.dm.ElementLinearData.prototype.getRelativeOffset=function(a,b,c){var d,e,f,g,h=Array.prototype.slice.call(arguments,3),i=a,j=0,k=!1,l=0;if(0===b){if(c.apply(this,[a].concat(h)))return a;b=1}for(e=0>=a?1:a>=this.getLength()?-1:b>0?1:-1,b=Math.abs(b),d=i+e,a=-1;d>=0&&d<=this.getLength();){if(f=d+(e>0?-1:0),this.isElementData(f)&&this.nodeFactory.shouldIgnoreChildren(this.getType(f)))if(g=this.isOpenElementData(f),e>0&&g||0>e&&!g)l++;else if(l--,0>l)throw new Error("offset was inside an ignoreChildren node");if(c.apply(this,[d].concat(h))){if(!l&&(j++,a=d,b===j))return a}else if(!k&&0===j&&(0>e&&0===d||e>0&&d===this.getLength())){if(c.apply(this,[i].concat(h)))return i;e*=-1,d=i,b=1,k=!0,l=0}d+=e}return a},ve.dm.ElementLinearData.prototype.getRelativeContentOffset=function(a,b){return this.getRelativeOffset(a,b,this.constructor.prototype.isContentOffset)},ve.dm.ElementLinearData.prototype.getNearestContentOffset=function(a,b){if(this.isContentOffset(a))return a;if(void 0===b){var c=this.getRelativeContentOffset(a,-1),d=this.getRelativeContentOffset(a,1);return d-a>a-c?c:d}return this.getRelativeContentOffset(a,b>0?1:-1)},ve.dm.ElementLinearData.prototype.getRelativeStructuralOffset=function(a,b,c){return 0!==b||0!==a&&a!==this.getLength()?this.getRelativeOffset(a,b,this.constructor.prototype.isStructuralOffset,c):a},ve.dm.ElementLinearData.prototype.getNearestStructuralOffset=function(a,b,c){if(this.isStructuralOffset(a,c))return a;if(b)return this.getRelativeStructuralOffset(a,b>0?1:-1,c);var d=this.getRelativeStructuralOffset(a,-1,c),e=this.getRelativeStructuralOffset(a,1,c);return e-a>a-d?d:e},ve.dm.ElementLinearData.prototype.getWordRange=function(a){var b=new ve.dm.DataString(this.getData());return a=this.getNearestContentOffset(a),unicodeJS.wordbreak.isBreak(b,a)?this.constructor["static"].endWordRegExp.exec((b.read(a-2)||" ")+(b.read(a-1)||" "))?new ve.Range(unicodeJS.wordbreak.prevBreakOffset(b,a),a):this.constructor["static"].startWordRegExp.exec((b.read(a)||" ")+(b.read(a+1)||" "))?new ve.Range(a,unicodeJS.wordbreak.nextBreakOffset(b,a)):new ve.Range(a):new ve.Range(unicodeJS.wordbreak.prevBreakOffset(b,a),unicodeJS.wordbreak.nextBreakOffset(b,a))},ve.dm.ElementLinearData.prototype.getUsedStoreValues=function(a){var b,c,d,e,f={};for(a=a||new ve.Range(0,this.data.length),b=a.start;b<a.end;b++)for(d=this.getAnnotationIndexesFromOffset(b,!0),e=d.length;e--;)c=d[e],Object.prototype.hasOwnProperty.call(f,c)||(f[c]=this.getStore().value(c));return f},ve.dm.ElementLinearData.prototype.remapStoreIndexes=function(a){var b,c,d,e,f,g;for(b=0,c=this.data.length;c>b;b++){for(f=this.getAnnotationIndexesFromOffset(b,!0),d=0,e=f.length;e>d;d++)f[d]=a[f[d]];this.setAnnotationIndexesAtOffset(b,f),this.isOpenElementData(b)&&(g=this.nodeFactory.lookup(this.getType(b)),g["static"].remapStoreIndexes(this.data[b],a))}},ve.dm.ElementLinearData.prototype.remapInternalListIndexes=function(a,b){var c,d,e;for(c=0,d=this.data.length;d>c;c++)this.isOpenElementData(c)&&(e=this.nodeFactory.lookup(this.getType(c)),e["static"].remapInternalListIndexes(this.data[c],a,b))},ve.dm.ElementLinearData.prototype.remapInternalListKeys=function(a){var b,c,d;for(b=0,c=this.data.length;c>b;b++)this.isOpenElementData(b)&&(d=this.nodeFactory.lookup(this.getType(b)),d["static"].remapInternalListKeys(this.data[b],a))},ve.dm.ElementLinearData.prototype.sanitize=function(a,b,c){var d,e,f,g,h,i,j=this.getAnnotationsFromRange(new ve.Range(0,this.getLength()),!0);if(b)g=new ve.dm.AnnotationSet(this.getStore());else{if(a.removeOriginalDomElements)for(d=0,e=j.getLength();e>d;d++)delete j.get(d).element.originalDomElements;h=j.filter(function(b){return a.blacklist&&-1!==a.blacklist.indexOf(b.name)||"textStyle/span"===b.name&&a.removeOriginalDomElements})}for(d=0,e=this.getLength();e>d;d++){if(this.isElementData(d)){if(i=this.getType(d),a.conversions&&a.conversions[i]&&(i=a.conversions[i],this.getData(d).type=(this.isCloseElementData(d)?"/":"")+i),b&&"paragraph"!==i&&this.nodeFactory.canNodeContainContent(i)&&(i="paragraph",this.setData(d,{type:(this.isCloseElementData(d)?"/":"")+i})),a.blacklist&&-1!==a.blacklist.indexOf(i)||b&&"paragraph"!==i&&"internalList"!==i){this.splice(d,1),ve.getProp(this.getData(d),"internal","generated")&&(delete this.getData(d).internal.generated,ve.isEmptyObject(this.getData(d).internal)&&delete this.getData(d).internal),d--,e--;continue}if(!c&&d>0&&this.isCloseElementData(d)&&this.isOpenElementData(d-1)&&this.nodeFactory.canNodeContainContent(i)){this.splice(d-1,2),d-=2,e-=2;continue}}f=this.getAnnotationsFromOffset(d,!0),f.isEmpty()||(b?this.setAnnotationsAtOffset(d,g):h.getLength()&&(f.removeSet(h),this.setAnnotationsAtOffset(d,f))),this.isOpenElementData(d)&&a.removeOriginalDomElements&&delete this.getData(d).originalDomElements}},ve.dm.ElementLinearData.prototype.cloneElements=function(a){var b,c;for(b=0,c=this.getLength();c>b;b++)this.isOpenElementData(b)&&this.setData(b,ve.dm.Node["static"].cloneElement(this.getData(b),a))},ve.dm.ElementLinearData.prototype.countNonInternalElements=function(){var a,b,c,d=0,e=0;for(a=0,b=this.getLength();b>a;a++)c=this.getType(a),c&&this.nodeFactory.isNodeInternal(c)?this.isOpenElementData(a)?d++:d--:d||e++;return e},ve.dm.MetaLinearData=function(){ve.dm.MetaLinearData["super"].apply(this,arguments)},OO.inheritClass(ve.dm.MetaLinearData,ve.dm.LinearData),ve.dm.MetaLinearData["static"].merge=function(a){var b,c=[],d=!0;for(b=0;b<a.length;b++)void 0!==a[b]&&(d=!1,c=c.concat(a[b]));return d?[void 0]:[c]},ve.dm.MetaLinearData.prototype.getData=function(a,b){return void 0===a?this.data:void 0===b?this.data[a]:void 0===this.data[a]?void 0:this.data[a][b]},ve.dm.MetaLinearData.prototype.getDataLength=function(a){return void 0===this.data[a]?0:this.data[a].length},ve.dm.MetaLinearData.prototype.getTotalDataLength=function(){for(var a=0,b=this.getLength();b--;)a+=this.getDataLength(b);return a},ve.dm.MetaLinearData.prototype.spliceMetadataAtOffset=function(a,b,c,d){var e=this.getData(a);return e||(e=[],this.setData(a,e)),d=d||[],ve.batchSplice(e,b,c,d)},ve.dm.MetaLinearData.prototype.getAnnotationIndexesFromOffsetAndIndex=function(a,b){var c=this.getData(a,b);return c&&c.annotations||[]},ve.dm.MetaLinearData.prototype.getAnnotationsFromOffsetAndIndex=function(a,b){return new ve.dm.AnnotationSet(this.getStore(),this.getAnnotationIndexesFromOffsetAndIndex(a,b))},ve.dm.MetaLinearData.prototype.setAnnotationsAtOffsetAndIndex=function(a,b,c){var d=this.getData(a,b);c.isEmpty()?delete d.annotations:d.annotations=this.getStore().indexes(c.get())},ve.dm.GeneratedContentNode=function(){},OO.initClass(ve.dm.GeneratedContentNode),ve.dm.GeneratedContentNode["static"].storeGeneratedContents=function(a,b,c){var d=OO.getHash([this.getHashObject(a),void 0]);return c.index(b,d)},ve.dm.AlienNode=function(){ve.dm.AlienNode["super"].apply(this,arguments),ve.dm.FocusableNode.call(this)},OO.inheritClass(ve.dm.AlienNode,ve.dm.LeafNode),OO.mixinClass(ve.dm.AlienNode,ve.dm.FocusableNode),ve.dm.AlienNode["static"].name="alien",ve.dm.AlienNode["static"].preserveHtmlAttributes=!1,ve.dm.AlienNode["static"].enableAboutGrouping=!0,ve.dm.AlienNode["static"].matchRdfaTypes=["ve:Alien"],ve.dm.AlienNode["static"].toDataElement=function(a,b){var c=this.isHybridInline(a,b),d=c?"alienInline":"alienBlock";return{type:d}},ve.dm.AlienNode["static"].toDomElements=function(a,b){return ve.copyDomElements(a.originalDomElements,b)},ve.dm.AlienBlockNode=function(){ve.dm.AlienBlockNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.AlienBlockNode,ve.dm.AlienNode),ve.dm.AlienBlockNode["static"].name="alienBlock",ve.dm.AlienInlineNode=function(){ve.dm.AlienInlineNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.AlienInlineNode,ve.dm.AlienNode),ve.dm.AlienInlineNode["static"].name="alienInline",ve.dm.AlienInlineNode["static"].isContent=!0,ve.dm.modelRegistry.register(ve.dm.AlienBlockNode),ve.dm.modelRegistry.register(ve.dm.AlienInlineNode),ve.dm.BlockquoteNode=function(a,b){ve.dm.BranchNode.call(this,a,b)},OO.inheritClass(ve.dm.BlockquoteNode,ve.dm.BranchNode),ve.dm.BlockquoteNode["static"].name="blockquote",ve.dm.BlockquoteNode["static"].canContainContent=!0,ve.dm.BlockquoteNode["static"].matchTagNames=["blockquote"],ve.dm.modelRegistry.register(ve.dm.BlockquoteNode),ve.dm.BreakNode=function(){ve.dm.BreakNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.BreakNode,ve.dm.LeafNode),ve.dm.BreakNode["static"].name="break",ve.dm.BreakNode["static"].isContent=!0,ve.dm.BreakNode["static"].matchTagNames=["br"],ve.dm.modelRegistry.register(ve.dm.BreakNode),ve.dm.CenterNode=function(){ve.dm.CenterNode["super"].apply(this,arguments)
},OO.inheritClass(ve.dm.CenterNode,ve.dm.BranchNode),ve.dm.CenterNode["static"].name="center",ve.dm.CenterNode["static"].matchTagNames=["center"],ve.dm.modelRegistry.register(ve.dm.CenterNode),ve.dm.DefinitionListItemNode=function(){ve.dm.DefinitionListItemNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.DefinitionListItemNode,ve.dm.BranchNode),ve.dm.DefinitionListItemNode["static"].name="definitionListItem",ve.dm.DefinitionListItemNode["static"].parentNodeTypes=["definitionList"],ve.dm.DefinitionListItemNode["static"].defaultAttributes={style:"term"},ve.dm.DefinitionListItemNode["static"].matchTagNames=["dt","dd"],ve.dm.DefinitionListItemNode["static"].toDataElement=function(a){var b="dt"===a[0].nodeName.toLowerCase()?"term":"definition";return{type:this.name,attributes:{style:b}}},ve.dm.DefinitionListItemNode["static"].toDomElements=function(a,b){var c=a.attributes&&"term"===a.attributes.style?"dt":"dd";return[b.createElement(c)]},ve.dm.modelRegistry.register(ve.dm.DefinitionListItemNode),ve.dm.DefinitionListNode=function(){ve.dm.DefinitionListNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.DefinitionListNode,ve.dm.BranchNode),ve.dm.DefinitionListNode["static"].name="definitionList",ve.dm.DefinitionListNode["static"].childNodeTypes=["definitionListItem"],ve.dm.DefinitionListNode["static"].matchTagNames=["dl"],ve.dm.modelRegistry.register(ve.dm.DefinitionListNode),ve.dm.DivNode=function(){ve.dm.DivNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.DivNode,ve.dm.BranchNode),ve.dm.DivNode["static"].name="div",ve.dm.DivNode["static"].matchTagNames=["div"],ve.dm.modelRegistry.register(ve.dm.DivNode),ve.dm.DocumentNode=function(a){ve.dm.DocumentNode["super"].call(this,null,a),this.root=this},OO.inheritClass(ve.dm.DocumentNode,ve.dm.BranchNode),ve.dm.DocumentNode["static"].name="document",ve.dm.DocumentNode["static"].isWrapped=!1,ve.dm.DocumentNode["static"].parentNodeTypes=[],ve.dm.DocumentNode["static"].matchTagNames=[],ve.dm.modelRegistry.register(ve.dm.DocumentNode),ve.dm.HeadingNode=function(){ve.dm.HeadingNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.HeadingNode,ve.dm.ContentBranchNode),ve.dm.HeadingNode["static"].name="heading",ve.dm.HeadingNode["static"].canContainContent=!0,ve.dm.HeadingNode["static"].defaultAttributes={level:1},ve.dm.HeadingNode["static"].matchTagNames=["h1","h2","h3","h4","h5","h6"],ve.dm.HeadingNode["static"].toDataElement=function(a){var b={h1:1,h2:2,h3:3,h4:4,h5:5,h6:6},c=b[a[0].nodeName.toLowerCase()];return{type:this.name,attributes:{level:c}}},ve.dm.HeadingNode["static"].toDomElements=function(a,b){var c=a.attributes&&a.attributes.level||1;return[b.createElement("h"+c)]},ve.dm.modelRegistry.register(ve.dm.HeadingNode),ve.dm.InternalItemNode=function(){ve.dm.InternalItemNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.InternalItemNode,ve.dm.BranchNode),ve.dm.InternalItemNode["static"].name="internalItem",ve.dm.InternalItemNode["static"].matchTagNames=[],ve.dm.InternalItemNode["static"].ignoreChildren=!0,ve.dm.InternalItemNode["static"].isInternal=!0,ve.dm.modelRegistry.register(ve.dm.InternalItemNode),ve.dm.InternalListNode=function(){ve.dm.InternalListNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.InternalListNode,ve.dm.BranchNode),ve.dm.InternalListNode["static"].name="internalList",ve.dm.InternalListNode["static"].childNodeTypes=["internalItem"],ve.dm.InternalListNode["static"].matchTagNames=[],ve.dm.InternalListNode["static"].isInternal=!0,ve.dm.modelRegistry.register(ve.dm.InternalListNode),ve.dm.ListItemNode=function(){ve.dm.ListItemNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.ListItemNode,ve.dm.BranchNode),ve.dm.ListItemNode["static"].name="listItem",ve.dm.ListItemNode["static"].parentNodeTypes=["list"],ve.dm.ListItemNode["static"].matchTagNames=["li"],ve.dm.modelRegistry.register(ve.dm.ListItemNode),ve.dm.ListNode=function(){ve.dm.ListNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.ListNode,ve.dm.BranchNode),ve.dm.ListNode["static"].name="list",ve.dm.ListNode["static"].childNodeTypes=["listItem"],ve.dm.ListNode["static"].defaultAttributes={style:"bullet"},ve.dm.ListNode["static"].matchTagNames=["ul","ol"],ve.dm.ListNode["static"].toDataElement=function(a){var b="ol"===a[0].nodeName.toLowerCase()?"number":"bullet";return{type:this.name,attributes:{style:b}}},ve.dm.ListNode["static"].toDomElements=function(a,b){var c=a.attributes&&"number"===a.attributes.style?"ol":"ul";return[b.createElement(c)]},ve.dm.ListNode.prototype.canHaveSlugAfter=function(){return!1},ve.dm.modelRegistry.register(ve.dm.ListNode),ve.dm.ParagraphNode=function(){ve.dm.ParagraphNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.ParagraphNode,ve.dm.ContentBranchNode),ve.dm.ParagraphNode["static"].name="paragraph",ve.dm.ParagraphNode["static"].canContainContent=!0,ve.dm.ParagraphNode["static"].matchTagNames=["p"],ve.dm.modelRegistry.register(ve.dm.ParagraphNode),ve.dm.PreformattedNode=function(){ve.dm.PreformattedNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.PreformattedNode,ve.dm.ContentBranchNode),ve.dm.PreformattedNode["static"].name="preformatted",ve.dm.PreformattedNode["static"].canContainContent=!0,ve.dm.PreformattedNode["static"].hasSignificantWhitespace=!0,ve.dm.PreformattedNode["static"].matchTagNames=["pre"],ve.dm.modelRegistry.register(ve.dm.PreformattedNode),ve.dm.TableCaptionNode=function(){ve.dm.TableCaptionNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.TableCaptionNode,ve.dm.BranchNode),ve.dm.TableCaptionNode["static"].name="tableCaption",ve.dm.TableCaptionNode["static"].parentNodeTypes=["table"],ve.dm.TableCaptionNode["static"].matchTagNames=["caption"],ve.dm.modelRegistry.register(ve.dm.TableCaptionNode),ve.dm.TableCellNode=function(){ve.dm.TableCellNode["super"].apply(this,arguments),this.connect(this,{attributeChange:"onAttributeChange"})},OO.inheritClass(ve.dm.TableCellNode,ve.dm.BranchNode),ve.dm.TableCellNode["static"].name="tableCell",ve.dm.TableCellNode["static"].parentNodeTypes=["tableRow"],ve.dm.TableCellNode["static"].defaultAttributes={style:"data"},ve.dm.TableCellNode["static"].matchTagNames=["td","th"],ve.dm.TableCellNode["static"].preserveHtmlAttributes=function(a){return"colspan"!==a&&"rowspan"!==a},ve.dm.TableCellNode["static"].toDataElement=function(a){var b={style:"th"===a[0].nodeName.toLowerCase()?"header":"data"},c=a[0].getAttribute("colspan"),d=a[0].getAttribute("rowspan");return null!==c&&(b.originalColspan=c,""===c||isNaN(Number(c))||(b.colspan=Number(c))),null!==d&&(b.originalRowspan=d,""===d||isNaN(Number(d))||(b.rowspan=Number(d))),{type:this.name,attributes:b}},ve.dm.TableCellNode["static"].toDomElements=function(a,b){var c=a.attributes&&"header"===a.attributes.style?"th":"td",d=b.createElement(c),e=a.attributes,f={colspan:e.colspan,rowspan:e.rowspan};return 1===e.colspan&&1!==Number(e.originalColspan)&&(f.colspan=null),1===e.rowspan&&1!==Number(e.originalRowspan)&&(f.rowspan=null),(void 0===e.colspan||e.colspan===Number(e.originalColspan))&&(f.colspan=e.originalColspan),(void 0===e.rowspan||e.rowspan===Number(e.originalRowspan))&&(f.rowspan=e.originalRowspan),ve.setDomAttributes(d,f),[d]},ve.dm.TableCellNode["static"].createData=function(a){var b,c;return a=a||{},b={type:"tableCell",attributes:{style:a.style||"data",rowspan:a.rowspan||1,colspan:a.colspan||1}},c=a.content||[{type:"paragraph",internal:{generated:"wrapper"}},{type:"/paragraph"}],[b].concat(c).concat([{type:"/tableCell"}])},ve.dm.TableCellNode.prototype.getRowspan=function(){return this.element.attributes.rowspan||1},ve.dm.TableCellNode.prototype.getColspan=function(){return this.element.attributes.colspan||1},ve.dm.TableCellNode.prototype.getSpans=function(){return{col:this.getColspan(),row:this.getRowspan()}},ve.dm.TableCellNode.prototype.getStyle=function(){return this.element.attributes.style||"data"},ve.dm.TableCellNode.prototype.onAttributeChange=function(a){!this.getParent()||"colspan"!==a&&"rowspan"!==a||this.getParent().getParent().getParent().getMatrix().invalidate()},ve.dm.modelRegistry.register(ve.dm.TableCellNode),ve.dm.TableNode=function(){ve.dm.TableNode["super"].apply(this,arguments),this.matrix=new ve.dm.TableMatrix(this),this.connect(this,{splice:"onSplice"})},OO.inheritClass(ve.dm.TableNode,ve.dm.BranchNode),ve.dm.TableNode["static"].name="table",ve.dm.TableNode["static"].childNodeTypes=["tableSection","tableCaption"],ve.dm.TableNode["static"].matchTagNames=["table"],ve.dm.TableNode.prototype.onSplice=function(){this.getMatrix().invalidate()},ve.dm.TableNode.prototype.getMatrix=function(){return this.matrix},ve.dm.TableNode.prototype.getCaptionNode=function(){var a,b;for(a=0,b=this.children.length;b>a;a++)if(this.children[a]instanceof ve.dm.TableCaptionNode)return this.children[a];return null},ve.dm.TableNode.prototype.getIterator=function(){return new ve.dm.TableNodeCellIterator(this)},ve.dm.modelRegistry.register(ve.dm.TableNode),ve.dm.TableNodeCellIterator=function(a){OO.EventEmitter.call(this),this.table=a,this.sectionIndex=0,this.rowIndex=0,this.cellIndex=0,this.sectionCount=this.table.children.length,this.rowCount=0,this.cellCount=0,this.sectionNode=null,this.rowNode=null,this.cellNode=null,this.finished=!1},OO.mixinClass(ve.dm.TableNodeCellIterator,OO.EventEmitter),ve.dm.TableNodeCellIterator.prototype.isFinished=function(){return this.finished},ve.dm.TableNodeCellIterator.prototype.next=function(){if(this.isFinished())throw new Error("TableNodeCellIterator has no more cells left.");return this.nextCell(this),this.cellNode},ve.dm.TableNodeCellIterator.prototype.nextSection=function(){if(this.sectionIndex>=this.sectionCount)return this.finished=!0,void(this.sectionNode=void 0);var a=this.table.children[this.sectionIndex];return this.sectionIndex++,this.rowIndex=0,a instanceof ve.dm.TableSectionNode?(this.sectionNode=a,this.rowCount=this.sectionNode.children.length,this.emit("newSection",this.sectionNode),void 0):void this.nextSection()},ve.dm.TableNodeCellIterator.prototype.nextRow=function(){if(this.rowIndex>=this.rowCount&&(this.nextSection(),this.isFinished()))return void(this.rowNode=void 0);var a=this.sectionNode.children[this.rowIndex];return this.rowIndex++,this.cellIndex=0,a instanceof ve.dm.TableRowNode?(this.rowNode=a,this.cellCount=this.rowNode.children.length,this.emit("newRow",this.rowNode),void 0):void this.nextRow()},ve.dm.TableNodeCellIterator.prototype.nextCell=function(){if(this.sectionNode||this.nextSection(),this.rowNode||this.nextRow(),this.cellIndex>=this.cellCount&&(this.nextRow(),this.isFinished()))return void(this.cellNode=void 0);var a=this.rowNode.children[this.cellIndex];this.cellNode=a instanceof ve.dm.TableCellNode?a:null,this.cellIndex++},ve.dm.TableRowNode=function(){ve.dm.TableRowNode["super"].apply(this,arguments),this.connect(this,{splice:"onSplice"})},OO.inheritClass(ve.dm.TableRowNode,ve.dm.BranchNode),ve.dm.TableRowNode["static"].name="tableRow",ve.dm.TableRowNode["static"].childNodeTypes=["tableCell"],ve.dm.TableRowNode["static"].parentNodeTypes=["tableSection"],ve.dm.TableRowNode["static"].matchTagNames=["tr"],ve.dm.TableRowNode["static"].createData=function(a){a=a||{};var b,c=[],d=a.cellCount||1;for(c.push({type:"tableRow"}),b=0;d>b;b++)c=c.concat(ve.dm.TableCellNode["static"].createData(a));return c.push({type:"/tableRow"}),c},ve.dm.TableRowNode.prototype.onSplice=function(){this.getRoot()&&this.getParent().getParent().getMatrix().invalidate()},ve.dm.modelRegistry.register(ve.dm.TableRowNode),ve.dm.TableSectionNode=function(){ve.dm.TableSectionNode["super"].apply(this,arguments),this.connect(this,{splice:"onSplice"})},OO.inheritClass(ve.dm.TableSectionNode,ve.dm.BranchNode),ve.dm.TableSectionNode["static"].name="tableSection",ve.dm.TableSectionNode["static"].childNodeTypes=["tableRow"],ve.dm.TableSectionNode["static"].parentNodeTypes=["table"],ve.dm.TableSectionNode["static"].defaultAttributes={style:"body"},ve.dm.TableSectionNode["static"].matchTagNames=["thead","tbody","tfoot"],ve.dm.TableSectionNode["static"].toDataElement=function(a){var b={thead:"header",tbody:"body",tfoot:"footer"},c=b[a[0].nodeName.toLowerCase()]||"body";return{type:this.name,attributes:{style:c}}},ve.dm.TableSectionNode["static"].toDomElements=function(a,b){var c={header:"thead",body:"tbody",footer:"tfoot"},d=c[a.attributes&&a.attributes.style||"body"];return[b.createElement(d)]},ve.dm.TableSectionNode.prototype.onSplice=function(){this.getRoot()&&this.getParent().getMatrix().invalidate()},ve.dm.modelRegistry.register(ve.dm.TableSectionNode),ve.dm.TextNode=function(a){ve.dm.TextNode["super"].call(this),this.length=a||0},OO.inheritClass(ve.dm.TextNode,ve.dm.LeafNode),ve.dm.TextNode["static"].name="text",ve.dm.TextNode["static"].isWrapped=!1,ve.dm.TextNode["static"].isContent=!0,ve.dm.TextNode["static"].matchTagNames=[],ve.dm.TextNode.prototype.canHaveSlugBefore=function(){return!1},ve.dm.TextNode.prototype.canHaveSlugAfter=function(){return!1},ve.dm.modelRegistry.register(ve.dm.TextNode),ve.dm.ImageNode=function(){ve.dm.FocusableNode.call(this),ve.dm.ResizableNode.call(this)},OO.mixinClass(ve.dm.ImageNode,ve.dm.FocusableNode),OO.mixinClass(ve.dm.ImageNode,ve.dm.ResizableNode),ve.dm.ImageNode.prototype.createScalable=function(){return new ve.dm.Scalable({currentDimensions:{width:this.getAttribute("width"),height:this.getAttribute("height")},minDimensions:{width:1,height:1}})},ve.dm.BlockImageNode=function(){ve.dm.BlockImageNode["super"].apply(this,arguments),ve.dm.ImageNode.call(this),ve.dm.AlignableNode.call(this)},OO.inheritClass(ve.dm.BlockImageNode,ve.dm.BranchNode),OO.mixinClass(ve.dm.BlockImageNode,ve.dm.ImageNode),OO.mixinClass(ve.dm.BlockImageNode,ve.dm.ClassAttributeNode),OO.mixinClass(ve.dm.BlockImageNode,ve.dm.AlignableNode),ve.dm.BlockImageNode["static"].name="blockImage",ve.dm.BlockImageNode["static"].preserveHtmlAttributes=function(a){var b=["src","width","height","href"];return-1===b.indexOf(a)},ve.dm.BlockImageNode["static"].handlesOwnChildren=!0,ve.dm.BlockImageNode["static"].ignoreChildren=!0,ve.dm.BlockImageNode["static"].childNodeTypes=["imageCaption"],ve.dm.BlockImageNode["static"].matchTagNames=["figure"],ve.dm.BlockImageNode["static"].toDataElement=function(a,b){function c(a,b){return Array.prototype.filter.call(a.childNodes,function(a){return-1!==b.indexOf(a.nodeName.toLowerCase())})}var d,e=a[0],f=e.getAttribute("class"),g=c(e,"img")[0]||null,h=c(e,"figcaption")[0]||null,i={src:g&&g.getAttribute("src")},j=g&&g.getAttribute("width"),k=g&&g.getAttribute("height"),l=g&&g.getAttribute("alt");return void 0!==l&&(i.alt=l),this.setClassAttributes(i,f),i.width=void 0!==j&&""!==j?Number(j):null,i.height=void 0!==k&&""!==k?Number(k):null,d={type:this.name,attributes:i},h?[d].concat(b.getDataFromDomClean(h,{type:"imageCaption"})).concat([{type:"/"+this.name}]):[d,{type:"imageCaption"},{type:"/imageCaption"},{type:"/"+this.name}]},ve.dm.BlockImageNode["static"].toDomElements=function(a,b,c){var d=a[0],e=d.attributes.width,f=d.attributes.height,g=this.getClassAttrFromAttributes(d.attributes),h=b.createElement("figure"),i=b.createElement("img"),j=b.createElement("div"),k=a.slice(1,-1);if(i.setAttribute("src",d.attributes.src),i.setAttribute("width",e),i.setAttribute("height",f),void 0!==d.attributes.alt&&i.setAttribute("alt",d.attributes.alt),h.appendChild(i),g&&(h.className=g),k.length>2)for(c.getDomSubtreeFromData(a.slice(1,-1),j);j.firstChild;)h.appendChild(j.firstChild);return[h]},ve.dm.BlockImageNode.prototype.getCaptionNode=function(){var a=this.children[0];return a instanceof ve.dm.BlockImageCaptionNode?a:null},ve.dm.modelRegistry.register(ve.dm.BlockImageNode),ve.dm.BlockImageCaptionNode=function(){ve.dm.BlockImageCaptionNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.BlockImageCaptionNode,ve.dm.BranchNode),ve.dm.BlockImageCaptionNode["static"].name="imageCaption",ve.dm.BlockImageCaptionNode["static"].matchTagNames=[],ve.dm.BlockImageCaptionNode["static"].parentNodeTypes=["blockImage"],ve.dm.BlockImageCaptionNode["static"].toDomElements=function(a,b){return[b.createElement("figcaption")]},ve.dm.modelRegistry.register(ve.dm.BlockImageCaptionNode),ve.dm.InlineImageNode=function(){ve.dm.InlineImageNode["super"].apply(this,arguments),ve.dm.ImageNode.call(this)},OO.inheritClass(ve.dm.InlineImageNode,ve.dm.LeafNode),OO.mixinClass(ve.dm.InlineImageNode,ve.dm.ImageNode),ve.dm.InlineImageNode["static"].name="inlineImage",ve.dm.InlineImageNode["static"].isContent=!0,ve.dm.InlineImageNode["static"].matchTagNames=["img"],ve.dm.InlineImageNode["static"].toDataElement=function(a){var b=$(a[0]),c=b.attr("alt"),d=b.attr("width"),e=b.attr("height");return{type:this.name,attributes:{src:b.attr("src"),alt:void 0!==c?c:null,width:void 0!==d&&""!==d?Number(d):null,height:void 0!==e&&""!==e?Number(e):null}}},ve.dm.InlineImageNode["static"].toDomElements=function(a,b){var c=b.createElement("img");return ve.setDomAttributes(c,a.attributes,["alt","src","width","height"]),[c]},ve.dm.modelRegistry.register(ve.dm.InlineImageNode),ve.dm.LanguageAnnotation=function(){ve.dm.LanguageAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.LanguageAnnotation,ve.dm.Annotation),ve.dm.LanguageAnnotation["static"].name="meta/language",ve.dm.LanguageAnnotation["static"].matchTagNames=["span"],ve.dm.LanguageAnnotation["static"].matchFunction=function(a){var b=a.getAttribute("lang"),c=(a.getAttribute("dir")||"").toLowerCase();return b||"ltr"===c||"rtl"===c},ve.dm.LanguageAnnotation["static"].applyToAppendedContent=!0,ve.dm.LanguageAnnotation["static"].toDataElement=function(a){return{type:this.name,attributes:{lang:a[0].getAttribute("lang"),dir:a[0].getAttribute("dir")}}},ve.dm.LanguageAnnotation["static"].toDomElements=function(a,b){var c=b.createElement("span");return a.attributes.lang&&c.setAttribute("lang",a.attributes.lang),a.attributes.dir&&c.setAttribute("dir",a.attributes.dir),[c]},ve.dm.LanguageAnnotation.prototype.getComparableObject=function(){return{type:"meta/language",lang:this.getAttribute("lang"),dir:this.getAttribute("dir")}},ve.dm.modelRegistry.register(ve.dm.LanguageAnnotation),ve.dm.LinkAnnotation=function(){ve.dm.LinkAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.LinkAnnotation,ve.dm.Annotation),ve.dm.LinkAnnotation["static"].name="link",ve.dm.LinkAnnotation["static"].matchTagNames=["a"],ve.dm.LinkAnnotation["static"].splitOnWordbreak=!0,ve.dm.LinkAnnotation["static"].toDataElement=function(a){return{type:this.name,attributes:{href:a[0].getAttribute("href")}}},ve.dm.LinkAnnotation["static"].toDomElements=function(a,b){var c=b.createElement("a");return c.setAttribute("href",this.getHref(a)),[c]},ve.dm.LinkAnnotation["static"].getHref=function(a){return a.attributes.href},ve.dm.LinkAnnotation.prototype.getHref=function(){return this.constructor["static"].getHref(this.element)},ve.dm.LinkAnnotation.prototype.getComparableObject=function(){return{type:this.getType(),href:this.getAttribute("href")}},ve.dm.LinkAnnotation.prototype.getComparableHtmlAttributes=function(){var a=ve.dm.LinkAnnotation["super"].prototype.getComparableHtmlAttributes.call(this);return delete a.href,a},ve.dm.modelRegistry.register(ve.dm.LinkAnnotation),ve.dm.TextStyleAnnotation=function(){ve.dm.TextStyleAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.TextStyleAnnotation,ve.dm.Annotation),ve.dm.TextStyleAnnotation["static"].name="textStyle",ve.dm.TextStyleAnnotation["static"].matchTagNames=[],ve.dm.TextStyleAnnotation["static"].toDataElement=function(a,b){var c=b.isFromClipboard()?this.matchTagNames[0]:a[0].nodeName.toLowerCase();return{type:this.name,attributes:{nodeName:c}}},ve.dm.TextStyleAnnotation["static"].toDomElements=function(a,b){var c=ve.getProp(a,"attributes","nodeName");return[b.createElement(c||this.matchTagNames[0])]},ve.dm.TextStyleAnnotation.prototype.getComparableObject=function(){return{type:this.getType()}},ve.dm.modelRegistry.register(ve.dm.TextStyleAnnotation),ve.dm.AbbreviationAnnotation=function(){ve.dm.AbbreviationAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.AbbreviationAnnotation,ve.dm.TextStyleAnnotation),ve.dm.AbbreviationAnnotation["static"].name="textStyle/abbreviation",ve.dm.AbbreviationAnnotation["static"].matchTagNames=["abbr"],ve.dm.modelRegistry.register(ve.dm.AbbreviationAnnotation),ve.dm.BigAnnotation=function(){ve.dm.BigAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.BigAnnotation,ve.dm.TextStyleAnnotation),ve.dm.BigAnnotation["static"].name="textStyle/big",ve.dm.BigAnnotation["static"].matchTagNames=["big"],ve.dm.modelRegistry.register(ve.dm.BigAnnotation),ve.dm.BoldAnnotation=function(){ve.dm.BoldAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.BoldAnnotation,ve.dm.TextStyleAnnotation),ve.dm.BoldAnnotation["static"].name="textStyle/bold",ve.dm.BoldAnnotation["static"].matchTagNames=["b","strong"],ve.dm.modelRegistry.register(ve.dm.BoldAnnotation),ve.dm.CodeSampleAnnotation=function(){ve.dm.CodeSampleAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.CodeSampleAnnotation,ve.dm.TextStyleAnnotation),ve.dm.CodeSampleAnnotation["static"].name="textStyle/codeSample",ve.dm.CodeSampleAnnotation["static"].matchTagNames=["samp"],ve.dm.modelRegistry.register(ve.dm.CodeSampleAnnotation),ve.dm.CodeAnnotation=function(){ve.dm.CodeAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.CodeAnnotation,ve.dm.TextStyleAnnotation),ve.dm.CodeAnnotation["static"].name="textStyle/code",ve.dm.CodeAnnotation["static"].matchTagNames=["code","tt"],ve.dm.modelRegistry.register(ve.dm.CodeAnnotation),ve.dm.DatetimeAnnotation=function(){ve.dm.DatetimeAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.DatetimeAnnotation,ve.dm.TextStyleAnnotation),ve.dm.DatetimeAnnotation["static"].name="textStyle/datetime",ve.dm.DatetimeAnnotation["static"].matchTagNames=["time"],ve.dm.modelRegistry.register(ve.dm.DatetimeAnnotation),ve.dm.DefinitionAnnotation=function(){ve.dm.DefinitionAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.DefinitionAnnotation,ve.dm.TextStyleAnnotation),ve.dm.DefinitionAnnotation["static"].name="textStyle/definition",ve.dm.DefinitionAnnotation["static"].matchTagNames=["dfn"],ve.dm.modelRegistry.register(ve.dm.DefinitionAnnotation),ve.dm.FontAnnotation=function(){ve.dm.FontAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.FontAnnotation,ve.dm.TextStyleAnnotation),ve.dm.FontAnnotation["static"].name="textStyle/font",ve.dm.FontAnnotation["static"].matchTagNames=["font"],ve.dm.modelRegistry.register(ve.dm.FontAnnotation),ve.dm.HighlightAnnotation=function(){ve.dm.HighlightAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.HighlightAnnotation,ve.dm.TextStyleAnnotation),ve.dm.HighlightAnnotation["static"].name="textStyle/highlight",ve.dm.HighlightAnnotation["static"].matchTagNames=["mark"],ve.dm.modelRegistry.register(ve.dm.HighlightAnnotation),ve.dm.ItalicAnnotation=function(){ve.dm.ItalicAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.ItalicAnnotation,ve.dm.TextStyleAnnotation),ve.dm.ItalicAnnotation["static"].name="textStyle/italic",ve.dm.ItalicAnnotation["static"].matchTagNames=["i","em"],ve.dm.modelRegistry.register(ve.dm.ItalicAnnotation),ve.dm.QuotationAnnotation=function(){ve.dm.QuotationAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.QuotationAnnotation,ve.dm.TextStyleAnnotation),ve.dm.QuotationAnnotation["static"].name="textStyle/quotation",ve.dm.QuotationAnnotation["static"].matchTagNames=["q"],ve.dm.modelRegistry.register(ve.dm.QuotationAnnotation),ve.dm.SmallAnnotation=function(){ve.dm.SmallAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.SmallAnnotation,ve.dm.TextStyleAnnotation),ve.dm.SmallAnnotation["static"].name="textStyle/small",ve.dm.SmallAnnotation["static"].matchTagNames=["small"],ve.dm.modelRegistry.register(ve.dm.SmallAnnotation),ve.dm.SpanAnnotation=function(){ve.dm.SpanAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.SpanAnnotation,ve.dm.TextStyleAnnotation),ve.dm.SpanAnnotation["static"].name="textStyle/span",ve.dm.SpanAnnotation["static"].matchTagNames=["span"],ve.dm.modelRegistry.register(ve.dm.SpanAnnotation),ve.dm.StrikethroughAnnotation=function(){ve.dm.StrikethroughAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.StrikethroughAnnotation,ve.dm.TextStyleAnnotation),ve.dm.StrikethroughAnnotation["static"].name="textStyle/strikethrough",ve.dm.StrikethroughAnnotation["static"].matchTagNames=["s"],ve.dm.modelRegistry.register(ve.dm.StrikethroughAnnotation),ve.dm.SubscriptAnnotation=function(){ve.dm.SubscriptAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.SubscriptAnnotation,ve.dm.TextStyleAnnotation),ve.dm.SubscriptAnnotation["static"].name="textStyle/subscript",ve.dm.SubscriptAnnotation["static"].matchTagNames=["sub"],ve.dm.SubscriptAnnotation["static"].removes=["textStyle/superscript"],ve.dm.modelRegistry.register(ve.dm.SubscriptAnnotation),ve.dm.SuperscriptAnnotation=function(){ve.dm.SuperscriptAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.SuperscriptAnnotation,ve.dm.TextStyleAnnotation),ve.dm.SuperscriptAnnotation["static"].name="textStyle/superscript",ve.dm.SuperscriptAnnotation["static"].matchTagNames=["sup"],ve.dm.SuperscriptAnnotation["static"].removes=["textStyle/subscript"],ve.dm.modelRegistry.register(ve.dm.SuperscriptAnnotation),ve.dm.UnderlineAnnotation=function(){ve.dm.UnderlineAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.UnderlineAnnotation,ve.dm.TextStyleAnnotation),ve.dm.UnderlineAnnotation["static"].name="textStyle/underline",ve.dm.UnderlineAnnotation["static"].matchTagNames=["u"],ve.dm.modelRegistry.register(ve.dm.UnderlineAnnotation),ve.dm.UserInputAnnotation=function(){ve.dm.UserInputAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.UserInputAnnotation,ve.dm.TextStyleAnnotation),ve.dm.UserInputAnnotation["static"].name="textStyle/userInput",ve.dm.UserInputAnnotation["static"].matchTagNames=["kbd"],ve.dm.modelRegistry.register(ve.dm.UserInputAnnotation),ve.dm.VariableAnnotation=function(){ve.dm.VariableAnnotation["super"].apply(this,arguments)},OO.inheritClass(ve.dm.VariableAnnotation,ve.dm.TextStyleAnnotation),ve.dm.VariableAnnotation["static"].name="textStyle/variable",ve.dm.VariableAnnotation["static"].matchTagNames=["var"],ve.dm.modelRegistry.register(ve.dm.VariableAnnotation),ve.dm.AlienMetaItem=function(){ve.dm.AlienMetaItem["super"].apply(this,arguments)},OO.inheritClass(ve.dm.AlienMetaItem,ve.dm.MetaItem),ve.dm.AlienMetaItem["static"].name="alienMeta",ve.dm.AlienMetaItem["static"].matchTagNames=["meta","link"],ve.dm.AlienMetaItem["static"].preserveHtmlAttributes=!1,ve.dm.AlienMetaItem["static"].toDomElements=function(a,b){return ve.copyDomElements(a.originalDomElements,b)},ve.dm.modelRegistry.register(ve.dm.AlienMetaItem),ve.dm.CommentMetaItem=function(){ve.dm.CommentMetaItem["super"].apply(this,arguments)},OO.inheritClass(ve.dm.CommentMetaItem,ve.dm.MetaItem),ve.dm.CommentMetaItem["static"].name="commentMeta",ve.dm.CommentMetaItem["static"].matchTagNames=[],ve.dm.CommentMetaItem["static"].preserveHtmlAttributes=!1,ve.dm.CommentMetaItem["static"].toDomElements=function(a,b){return[b.createComment(a.attributes.text)]},ve.dm.modelRegistry.register(ve.dm.CommentMetaItem),ve.dm.CommentNode=function(a){ve.dm.CommentNode["super"].call(this,a),ve.dm.FocusableNode.call(this)},OO.inheritClass(ve.dm.CommentNode,ve.dm.LeafNode),OO.mixinClass(ve.dm.CommentNode,ve.dm.FocusableNode),ve.dm.CommentNode["static"].isContent=!0,ve.dm.CommentNode["static"].preserveHtmlAttributes=!1,ve.dm.CommentNode["static"].toDataElement=function(a,b){var c;return c=a[0].nodeType===Node.COMMENT_NODE?$("<textarea/>").html(a[0].data).text():a[0].getAttribute("data-ve-comment"),{type:b.isValidChildNodeType("comment")&&""!==c?"comment":"commentMeta",attributes:{text:c}}},ve.dm.CommentNode["static"].toDomElements=function(a,b,c){var d,e;return c.isForClipboard()?(d=b.createElement("span"),d.setAttribute("rel","ve:Comment"),d.setAttribute("data-ve-comment",a.attributes.text),[d]):(e=a.attributes.text.replace(/^[->]|--|-$|&/g,function(a){return a.slice(0,a.length-1)+"&#"+a.charCodeAt(a.length-1)+";"}),[b.createComment(e)])},ve.dm.RealCommentNode=function(){ve.dm.RealCommentNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.RealCommentNode,ve.dm.CommentNode),ve.dm.RealCommentNode["static"].name="comment",ve.dm.RealCommentNode["static"].matchTagNames=["#comment"],ve.dm.FakeCommentNode=function(){ve.dm.FakeCommentNode["super"].apply(this,arguments)},OO.inheritClass(ve.dm.FakeCommentNode,ve.dm.CommentNode),ve.dm.FakeCommentNode["static"].name="fakeComment",ve.dm.FakeCommentNode["static"].matchRdfaTypes=["ve:Comment"],ve.dm.modelRegistry.register(ve.dm.RealCommentNode),ve.dm.modelRegistry.register(ve.dm.FakeCommentNode);