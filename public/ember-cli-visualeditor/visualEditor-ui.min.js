ve.ce={},ve.ce.whitespacePattern=/[\u0020\u00A0]/g,ve.ce.minImgDataUri="data:image/gif;base64,R0lGODdhAQABAADcACwAAAAAAQABAAA",ve.ce.unicornImgDataUri="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAATCAQAAADly58hAAAAAmJLR0QAAKqNIzIAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeChIMMi319aEqAAAAzUlEQVQoz4XSMUoDURAG4K8NIljaeQZrCwsRb5FWL5Daa1iIjQewTycphAQloBEUAoogFmqMsiBmHSzcdfOWlcyU3/+YGXgsqJZMbvv/wLqZDCw1B9rCBSaOmgOHQsfQvVYT7wszIbPSxO9CCF8ebNXx1J2TIvDoxlrKU3mBIYz1U87mMISB3QqXk7e/A4bp1WV/CiE3sFHymZ4X4cO57yLWdVDyjoknr47/MPRcput1k+ljt/O4V1vu2bXViq9qPNW3WfGoxrk37UVfxQ999n1bP+Vh5gAAAABJRU5ErkJggg==",ve.ce.chimeraImgDataUri="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAATCAYAAAByUDbMAAAABGdBTUEAALGPC/xhBQAAAThJREFUOMvF088rRFEYxvGpKdnwJ8iStVnMytZ2ipJmI6xmZKEUe5aUULMzCxtlSkzNjCh2lClFSUpDmYj8KBZq6vreetLbrXs5Rjn1aWbuuee575z7nljsH8YkepoNaccsHrGFgWbCWpHCLZb+oroFzKOEbpeFHVp8gitsYltzSRyiqrkKhsKCevGMfWQwor/2ghns4BQTGMMcnlBA3Aa14U5VLeMDnqrq1/cDpHGv35eqrI5pG+Y/qYYp3WiN6zOHs8DcA7IK/BqLWMOuY5inQjwbNqheGnYMO9d+XtiwFu1BQU/y96ooKRO2Yq6vqog3jAbfZgKvuDELfGWFXQeu76GB9bD26MQRNnSMotTVJvGoxs2rx2oR/B47Rtd3pyBv3lCYnEtYWo0Yps8l7F3HKErjJ2G/Hp/F9YtlR3MQiAAAAABJRU5ErkJggg==",ve.ce.getDomText=function(a){var b=function(a){var c,d=a.nodeType,e=$(a),f="";if(d===Node.ELEMENT_NODE||d===Node.DOCUMENT_NODE||d===Node.DOCUMENT_FRAGMENT_NODE){if(e.hasClass("ve-ce-branchNode-blockSlug"))return"";if(e.hasClass("ve-ce-cursorHolder"))return"";if(e.hasClass("ve-ce-leafNode"))return c=e.data("view"),c&&a===c.$element[0]?new Array(c.getOuterLength()+1).join("☃"):"";for(a=a.firstChild;a;a=a.nextSibling)f+=b(a)}else if(d===Node.TEXT_NODE)return a.data;return f};return b(a).replace(ve.ce.whitespacePattern," ")},ve.ce.getDomHash=function(a){var b=a.nodeType,c=a.nodeName,d="";if(b===Node.TEXT_NODE||b===Node.CDATA_SECTION_NODE)return"#";if(b===Node.ELEMENT_NODE||b===Node.DOCUMENT_NODE){if(!$(a).hasClass("ve-ce-branchNode-blockSlug")&&!$(a).hasClass("ve-ce-cursorHolder")){for(d+="<"+c+">",a=a.firstChild;a;a=a.nextSibling)d+=ve.ce.getDomHash(a);d+="</"+c+">"}d=d.replace(/##+/g,"#")}return d},ve.ce.nextCursorOffset=function(a){var b,c;return null!==a.nextSibling&&a.nextSibling.nodeType===Node.TEXT_NODE?(b=a.nextSibling,c=0):(b=a.parentNode,c=1+Array.prototype.indexOf.call(a.parentNode.childNodes,a)),{node:b,offset:c}},ve.ce.previousCursorOffset=function(a){var b,c;return null!==a.previousSibling&&a.previousSibling.nodeType===Node.TEXT_NODE?(b=a.previousSibling,c=b.data.length):(b=a.parentNode,c=Array.prototype.indexOf.call(a.parentNode.childNodes,a)),{node:b,offset:c}},ve.ce.getOffset=function(a,b){function c(a){for(;!a.previousSibling;){if(a=a.parentNode,!a)throw new Error("domNode has no ancestor with a .data( 'view' )");if($(a).data("view")instanceof ve.ce.Node)return a}if(a=a.previousSibling,$(a).data("view")instanceof ve.ce.Node)return a;for(;a.lastChild;)if(a=a.lastChild,$(a).data("view")instanceof ve.ce.Node)return a;return a}var d,e,f,g,h,i=0,j=$(a);if(j.hasClass("ve-ce-unicorn")){if(0!==b)throw new Error("Non-zero offset in unicorn");return j.data("dmOffset")}if(h=a.nodeType===Node.ELEMENT_NODE?a.childNodes.length:a.data.length,0>b||b>h)throw new Error("domOffset is out of bounds");if(a.nodeType===Node.ELEMENT_NODE)if(0===a.childNodes.length){if(g=a,e=$(g).data("view"),e instanceof ve.ce.Node)return e.getOffset()+(e.isWrapped()?1:0);d=g}else if(b===a.childNodes.length){if(g=a.lastChild,e=$(g).data("view"),e instanceof ve.ce.Node)return e.getOffset()+e.getOuterLength();for(;g.lastChild;)if(g=g.lastChild,e=$(g).data("view"),e instanceof ve.ce.Node)return e.getOffset()+e.getOuterLength();d=g}else g=a.childNodes[b],d=c(g);else $(a.parentNode).hasClass("ve-ce-branchNode-blockSlug")||$(a.parentNode).hasClass("ve-ce-cursorHolder")||(i+=b),g=a,d=c(g);for(;;){if(e=$(d).data("view"),e instanceof ve.ce.Node)break;d.nodeType!==Node.TEXT_NODE||$(d.parentNode).hasClass("ve-ce-branchNode-blockSlug")||$(d.parentNode).hasClass("ve-ce-cursorHolder")||(i+=d.data.length),d=c(d)}if(f=e.getOffset(),$.contains(d,g))e.getModel().isContent()||(f+=e.getModel().isWrapped()?1:0),e.getModel().canContainContent()&&(f+=i);else{if(!e.parent)throw new Error("Node is not in document");f+=e.getOuterLength(),e.isContent()&&(f+=i)}return f},ve.ce.getOffsetOfSlug=function(a){var b,c=$(a);if(0===c.index())return b=c.parent().data("view").getModel(),b.getOffset()+(b.isWrapped()?1:0);if(c.prev().length)return b=c.prev().data("view").getModel(),b.getOffset()+b.getOuterLength();throw new Error("Incorrect slug location")},ve.ce.isAfterAnnotationBoundaries=function(a,b){var c,d;if(a.nodeType===Node.TEXT_NODE){if(b>0)return!1;b=Array.prototype.indexOf.call(a.parentNode.childNodes,a),a=a.parentNode}return 0===b?ve.dm.modelRegistry.isAnnotation(a):(c=a.childNodes[b-1],c&&ve.dm.modelRegistry.isAnnotation(c)?(d=a.childNodes[b],!d||!ve.dm.modelRegistry.isAnnotation(d)):!1)},ve.ce.isShortcutKey=function(a){return!(!a.ctrlKey&&!a.metaKey)},ve.ce.veRangeFromSelection=function(a){try{return new ve.Range(ve.ce.getOffset(a.anchorNode,a.anchorOffset),ve.ce.getOffset(a.focusNode,a.focusOffset))}catch(b){return null}},ve.ce.RangeState=function(a,b,c){this.branchNodeChanged=!1,this.selectionChanged=!1,this.contentChanged=!1,this.veRange=null,this.node=null,this.text=null,this.hash=null,this.saveState(a,b,c)},OO.initClass(ve.ce.RangeState),ve.ce.RangeState["static"].createNullSelection=function(){return{focusNode:null,focusOffset:0,anchorNode:null,anchorOffset:0}},ve.ce.RangeState["static"].compareSelections=function(a,b){return a.focusNode===b.focusNode&&a.focusOffset===b.focusOffset&&a.anchorNode===b.anchorNode&&a.anchorOffset===b.anchorOffset},ve.ce.RangeState.prototype.saveState=function(a,b,c){var d,e,f,g=a?a.misleadingSelection:this.constructor["static"].createNullSelection(),h=b.getElementDocument().getSelection();e=h.rangeCount&&OO.ui.contains(b.$element[0],h.anchorNode,!0)?{focusNode:h.focusNode,focusOffset:h.focusOffset,anchorNode:h.anchorNode,anchorOffset:h.anchorOffset}:this.constructor["static"].createNullSelection(),this.constructor["static"].compareSelections(g,e)?(this.selectionChanged=!1,this.veRange=a&&a.veRange):(this.selectionChanged=!0,this.veRange=ve.ce.veRangeFromSelection(e)),f=g.anchorNode!==e.anchorNode,f?(d=$(e.anchorNode).closest(".ve-ce-branchNode"),0===d.length?this.node=null:(this.node=d.data("view"),this.node&&this.node.root!==b&&(this.node=null,this.veRange=null))):this.node=a&&a.node,this.branchNodeChanged=(a&&a.node)!==this.node,c&&!f?(this.text=a.text,this.hash=a.hash):this.node?(this.text=ve.ce.getDomText(this.node.$element[0]),this.hash=ve.ce.getDomHash(this.node.$element[0])):(this.text=null,this.hash=null),this.contentChanged=!(c||this.branchNodeChanged||(a&&a.hash)===this.hash&&(a&&a.text)===this.text),this.misleadingSelection=e},ve.ce.AnnotationFactory=function(){OO.Factory.call(this)},OO.inheritClass(ve.ce.AnnotationFactory,OO.Factory),ve.ce.AnnotationFactory.prototype.getDescription=function(a){var b=a.constructor["static"].name;if(Object.prototype.hasOwnProperty.call(this.registry,b))return this.registry[b]["static"].getDescription(a);throw new Error("Unknown annotation type: "+b)},ve.ce.AnnotationFactory.prototype.isAnnotationContinuationForced=function(a){return Object.prototype.hasOwnProperty.call(this.registry,a)?this.registry[a]["static"].forceContinuation:!1},ve.ce.annotationFactory=new ve.ce.AnnotationFactory,ve.ce.NodeFactory=function(){OO.Factory.call(this)},OO.inheritClass(ve.ce.NodeFactory,OO.Factory),ve.ce.NodeFactory.prototype.getDescription=function(a){var b=a.constructor["static"].name;if(Object.prototype.hasOwnProperty.call(this.registry,b))return this.registry[b]["static"].getDescription(a);throw new Error("Unknown node type: "+b)},ve.ce.NodeFactory.prototype.splitNodeOnEnter=function(a){if(Object.prototype.hasOwnProperty.call(this.registry,a))return this.registry[a]["static"].splitOnEnter;throw new Error("Unknown node type: "+a)},ve.ce.NodeFactory.prototype.getNodePrimaryCommandName=function(a){if(Object.prototype.hasOwnProperty.call(this.registry,a))return this.registry[a]["static"].primaryCommandName;throw new Error("Unknown node type: "+a)},ve.ce.nodeFactory=new ve.ce.NodeFactory,ve.ce.Document=function(a,b){ve.Document.call(this,new ve.ce.DocumentNode(a.getDocumentNode(),b)),this.getDocumentNode().$element.prop({lang:a.getLang(),dir:a.getDir()}),this.model=a},OO.inheritClass(ve.ce.Document,ve.Document),ve.ce.Document.prototype.getSlugAtOffset=function(a){var b=this.getBranchNodeFromOffset(a);return b?b.getSlugAtOffset(a):null},ve.ce.Document.prototype.getNodeAndOffset=function(a){function b(a){for(;null===a.nextSibling;)if(a=a.parentNode,null===a)return null;for(a=a.nextSibling;a.firstChild;)a=a.firstChild;return a}function c(a){for(;null===a.previousSibling;)if(a=a.parentNode,null===a)return null;for(a=a.previousSibling;a.lastChild;)a=a.lastChild;return a}var d,e,f,g;return d=this.getNodeAndOffsetUnadjustedForUnicorn(a),e=d.node,f=b(e),g=c(e),(e.nodeType===Node.TEXT_NODE&&d.offset===e.data.length||e.nodeType===Node.ELEMENT_NODE&&e.classList.contains("ve-ce-branchNode-inlineSlug"))&&f&&f.nodeType===Node.ELEMENT_NODE&&f.classList.contains("ve-ce-pre-unicorn")?ve.ce.nextCursorOffset(f):e.nodeType===Node.ELEMENT_NODE&&e.childNodes.length>d.offset&&e.childNodes[d.offset].nodeType===Node.ELEMENT_NODE&&e.childNodes[d.offset].classList.contains("ve-ce-pre-unicorn")?{node:d.node,offset:d.offset+1}:(e.nodeType===Node.TEXT_NODE&&0===d.offset||e.nodeType===Node.ELEMENT_NODE&&e.classList.contains("ve-ce-branchNode-inlineSlug"))&&g&&g.nodeType===Node.ELEMENT_NODE&&g.classList.contains("ve-ce-post-unicorn")?ve.ce.previousCursorOffset(g):e.nodeType===Node.ELEMENT_NODE&&d.offset>0&&e.childNodes[d.offset-1].nodeType===Node.ELEMENT_NODE&&e.childNodes[d.offset-1].classList.contains("ve-ce-post-unicorn")?{node:d.node,offset:d.offset-1}:d},ve.ce.Document.prototype.getNodeAndOffsetUnadjustedForUnicorn=function(a){var b,c,d,e,f,g,h,i,j=[],k=this.getSlugAtOffset(a);if(k&&(!k.firstChild||$(k).hasClass("ve-ce-branchNode-blockSlug")||$(k.firstChild).hasClass("ve-ce-chimera")))return{node:k,offset:0};for(b=this.getBranchNodeFromOffset(a),c=b.getOffset()+(b.isWrapped()?1:0),d=[b.$element.contents(),0],e=[d];e.length>0;)if(d[1]>=d[0].length)e.pop(),d=e[e.length-1];else{if(f=d[0][d[1]],f.nodeType===Node.TEXT_NODE){if(h=f.textContent.length,a>=c&&c+h>=a)return{node:f,offset:a-c};c+=h}else if(f.nodeType===Node.ELEMENT_NODE)if(g=d[0].eq(d[1]),g.hasClass("ve-ce-unicorn")){if(a===c){if($(g[0].previousSibling).hasClass("ve-ce-unicorn"))return{node:g[0].parentNode,offset:d[1]-1};if($(g[0].nextSibling).hasClass("ve-ce-unicorn"))return{node:g[0].parentNode,offset:d[1]+1}}}else{if(!g.is(".ve-ce-branchNode, .ve-ce-leafNode")){if(g.hasClass("ve-ce-branchNode-blockSlug")){d[1]++;continue}e.push([g.contents(),0]),d[1]++,d=e[e.length-1];continue}if(i=g.data("view").model,-1===j.indexOf(i)){if(h=i.getOuterLength(),j.push(i),a>=c&&c+h>a){e.push([g.contents(),0]),d[1]++,d=e[e.length-1];continue}c+=h}}d[1]++}throw new Error("Offset could not be translated to a DOM element and offset: "+a)},ve.ce.Document.prototype.getDirectionFromSelection=function(a){var b,c,d;if(a instanceof ve.dm.LinearSelection)c=a.getRange();else{if(!(a instanceof ve.dm.TableSelection))return null;c=a.tableRange}if(d=this.selectNodes(c,"covered"),d.length>1)b=this.selectNodes(c,"siblings")[0].node.getParent();else for(b=d[0].node;b.isContent();)b=b.parent;return b.$element.css("direction")},ve.ce.View=function(a,b){this.model=a,OO.ui.Element.call(this,b),OO.EventEmitter.call(this),this.live=!1,this.connect(this,{setup:"onSetup",teardown:"onTeardown"}),ve.dm.Converter.renderHtmlAttributeList(this.model.getOriginalDomElements(),this.$element,this.constructor["static"].renderHtmlAttributes,!0,!(this.model instanceof ve.dm.Node)||!this.model.canHaveChildren()||this.model.handlesOwnChildren())},OO.inheritClass(ve.ce.View,OO.ui.Element),OO.mixinClass(ve.ce.View,OO.EventEmitter),ve.ce.View["static"].renderHtmlAttributes=function(a){var b=["abbr","about","align","alt","axis","bgcolor","border","cellpadding","cellspacing","char","charoff","cite","class","clear","color","colspan","datatype","datetime","dir","face","frame","headers","height","href","id","itemid","itemprop","itemref","itemscope","itemtype","lang","noshade","nowrap","property","rbspan","rel","resource","rev","rowspan","rules","scope","size","span","src","start","style","summary","title","type","typeof","valign","value","width"];return-1!==b.indexOf(a)},ve.ce.View.prototype.getModelHtmlDocument=function(){return null},ve.ce.View.prototype.onSetup=function(){this.$element.data("view",this)},ve.ce.View.prototype.onTeardown=function(){this.$element.removeData("view")},ve.ce.View.prototype.getModel=function(){return this.model},ve.ce.View.prototype.isLive=function(){return this.live},ve.ce.View.prototype.setLive=function(a){this.live=a,this.emit(this.live?"setup":"teardown")},ve.ce.View.prototype.isInContentEditable=function(){for(var a=this.$element[0].parentNode;a&&"inherit"===a.contentEditable;)a=a.parentNode;return!(!a||"true"!==a.contentEditable)},ve.ce.View.prototype.getResolvedAttribute=function(a){var b=this.model.getAttribute(a),c=this.getModelHtmlDocument();return c&&"string"==typeof b?ve.resolveUrl(b,c):b},ve.ce.View.prototype.destroy=function(){this.disconnect(this),this.model.disconnect(this),this.model=null},ve.ce.Annotation=function(a,b,c){ve.ce.View.call(this,a,c),this.parentNode=b||null},OO.inheritClass(ve.ce.Annotation,ve.ce.View),ve.ce.Annotation["static"].tagName="span",ve.ce.Annotation["static"].forceContinuation=!1,ve.ce.Annotation["static"].getDescription=function(){return""},ve.ce.Annotation.prototype.getParentNode=function(){return this.parentNode},ve.ce.Annotation.prototype.getModelHtmlDocument=function(){return this.parentNode&&this.parentNode.getModelHtmlDocument()},ve.ce.Annotation.prototype.destroy=function(){this.parentNode=null,ve.ce.View.prototype.destroy.call(this)},ve.ce.Node=function(a,b){ve.ce.View.call(this,a,b),ve.Node.call(this),this.parent=null},OO.inheritClass(ve.ce.Node,ve.ce.View),OO.mixinClass(ve.ce.Node,ve.Node),ve.ce.Node["static"].splitOnEnter=!1,ve.ce.Node["static"].primaryCommandName=null,ve.ce.Node["static"].getDescription=function(){return""},ve.ce.Node.prototype.getChildNodeTypes=function(){return this.model.getChildNodeTypes()},ve.ce.Node.prototype.getParentNodeTypes=function(){return this.model.getParentNodeTypes()},ve.ce.Node.prototype.getSuggestedParentNodeTypes=function(){return this.model.getSuggestedParentNodeTypes()},ve.ce.Node.prototype.canHaveChildren=function(){return this.model.canHaveChildren()},ve.ce.Node.prototype.canHaveChildrenNotContent=function(){return this.model.canHaveChildrenNotContent()},ve.ce.Node.prototype.isWrapped=function(){return this.model.isWrapped()},ve.ce.Node.prototype.canContainContent=function(){return this.model.canContainContent()},ve.ce.Node.prototype.isContent=function(){return this.model.isContent()},ve.ce.Node.prototype.isFocusable=function(){return this.model.isFocusable()},ve.ce.Node.prototype.isAlignable=function(){return this.model.isAlignable()},ve.ce.Node.prototype.hasSignificantWhitespace=function(){return this.model.hasSignificantWhitespace()},ve.ce.Node.prototype.handlesOwnChildren=function(){return this.model.handlesOwnChildren()},ve.ce.Node.prototype.shouldIgnoreChildren=function(){return this.model.shouldIgnoreChildren()},ve.ce.Node.prototype.getLength=function(){return this.model.getLength()},ve.ce.Node.prototype.getOuterLength=function(){return this.model.getOuterLength()},ve.ce.Node.prototype.getOffset=function(){return this.model.getOffset()},ve.ce.Node.prototype.splitOnEnter=function(){return this.constructor["static"].splitOnEnter},ve.ce.Node.prototype.destroy=function(){this.parent=null,this.root=null,this.doc=null,ve.ce.View.prototype.destroy.call(this)},ve.ce.Node.prototype.getModelHtmlDocument=function(){return this.model.getDocument()&&this.model.getDocument().getHtmlDocument()},ve.ce.BranchNode=function(a,b){ve.BranchNode.call(this),ve.ce.Node.call(this,a,b),this.$element.addClass("ve-ce-branchNode"),this.tagName=this.$element.get(0).nodeName.toLowerCase(),this.slugNodes=[],this.model.connect(this,{splice:"onSplice"}),this.onSplice.apply(this,[0,0].concat(a.getChildren()))},OO.inheritClass(ve.ce.BranchNode,ve.ce.Node),OO.mixinClass(ve.ce.BranchNode,ve.BranchNode),ve.ce.BranchNode.inlineSlugTemplate=function(){var a=$("<img>").addClass("ve-ce-chimera").css({width:"0",height:"0"}),b=$("<span>").addClass("ve-ce-branchNode-slug ve-ce-branchNode-inlineSlug").append(a);return"gecko"===$.client.profile().layout&&a.prop("src",ve.ce.minImgDataUri),b.get(0)}(),ve.ce.BranchNode.inputDebugInlineSlugTemplate=$("<span>").addClass("ve-ce-branchNode-slug ve-ce-branchNode-inlineSlug").append($("<img>").prop("src",ve.ce.chimeraImgDataUri).addClass("ve-ce-chimera")).get(0),ve.ce.BranchNode.blockSlugTemplate=$("<div>").addClass("ve-ce-branchNode-slug ve-ce-branchNode-blockSlug").get(0),ve.ce.BranchNode.prototype.onSetup=function(){ve.ce.Node.prototype.onSetup.call(this),this.$element.addClass("ve-ce-branchNode")},ve.ce.BranchNode.prototype.updateTagName=function(){var a,b=this.getTagName();if(b!==this.tagName){for(this.emit("teardown"),a=document.createElement(b),a.className=this.$element[0].className,a.contentEditable=this.$element[0].contentEditable;this.$element[0].firstChild;)a.appendChild(this.$element[0].firstChild);this.$element[0].parentNode&&this.$element[0].parentNode.replaceChild(a,this.$element[0]),this.$element=$(a),this.emit("setup"),this.tagName=b}},ve.ce.BranchNode.prototype.onModelUpdate=function(a){this.emit("childUpdate",a)},ve.ce.BranchNode.prototype.onSplice=function(a){var b,c,d,e,f,g,h,i,j=[];for(b=0,d=arguments.length;d>b;b++)j.push(arguments[b]);if(j.length>=3)for(b=2,d=j.length;d>b;b++)j[b]=ve.ce.nodeFactory.create(j[b].getType(),j[b]),j[b].model.connect(this,{update:"onModelUpdate"});for(i=this.children.splice.apply(this.children,j),b=0,d=i.length;d>b;b++)i[b].model.disconnect(this,{update:"onModelUpdate"}),i[b].setLive(!1),i[b].detach(),i[b].$element.detach();if(j.length>=3)for(a&&(e=this.children[a-1].$element.last()),b=j.length-1;b>=2;b--){if(j[b].attach(this),a)for(f=e[0].nextSibling,h=e[0].parentNode,c=0,d=j[b].$element.length;d>c;c++)h.insertBefore(j[b].$element[c],f);else for(g=this.$element[0],c=j[b].$element.length-1;c>=0;c--)g.insertBefore(j[b].$element[c],g.firstChild);this.live!==j[b].isLive()&&j[b].setLive(this.live)}this.setupBlockSlugs()},ve.ce.BranchNode.prototype.setupBlockSlugs=function(){this.canHaveChildrenNotContent()&&this.setupSlugs(!0)},ve.ce.BranchNode.prototype.setupInlineSlugs=function(){this.canHaveChildrenNotContent()||this.setupSlugs(!1)},ve.ce.BranchNode.prototype.setupSlugs=function(a){var b,c,d,e,f,g=this.getElementDocument();for(b in this.slugNodes)void 0!==this.slugNodes[b]&&this.slugNodes[b].parentNode&&this.slugNodes[b].parentNode.removeChild(this.slugNodes[b]),delete this.slugNodes[b];c=a?ve.ce.BranchNode.blockSlugTemplate:ve.inputDebug?ve.ce.BranchNode.inputDebugInlineSlugTemplate:ve.ce.BranchNode.inlineSlugTemplate;for(b in this.getModel().slugPositions)d=g.importNode(c,!0),this.children[b]&&this.children[b].$element[0]?(e=this.children[b].$element[0],e.parentNode.insertBefore(d,e)):this.$element[0].appendChild(d),this.slugNodes[b]=d,a&&(f=new OO.ui.ButtonWidget({label:ve.msg("visualeditor-slug-insert"),icon:"add",framed:!1}).on("click",this.onSlugClick.bind(this,d)),$(d).append(f.$element))},ve.ce.BranchNode.prototype.onSlugClick=function(a){this.getRoot().getSurface().createSlug(a)},ve.ce.BranchNode.prototype.getSlugAtOffset=function(a){var b,c=this.model.getOffset()+(this.isWrapped()?1:0);if(a===c)return this.slugNodes[0]||null;for(b=0;b<this.children.length;b++)if(c+=this.children[b].model.getOuterLength(),a===c)return this.slugNodes[b+1]||null},ve.ce.BranchNode.prototype.setLive=function(a){ve.ce.Node.prototype.setLive.call(this,a);for(var b=0;b<this.children.length;b++)this.children[b].setLive(a)},ve.ce.BranchNode.prototype.destroy=function(){var a,b;for(a=0,b=this.children.length;b>a;a++)this.children[a].destroy();ve.ce.Node.prototype.destroy.call(this)},ve.ce.ContentBranchNode=function(a,b){ve.ce.BranchNode.call(this,a,b),this.lastTransaction=null,this.rendered=!1,this.unicornAnnotations=null,this.unicorns=null,this.onClickHandler=this.onClick.bind(this),this.connect(this,{childUpdate:"onChildUpdate"}),this.$element.on("click",this.onClickHandler)},OO.inheritClass(ve.ce.ContentBranchNode,ve.ce.BranchNode),ve.ce.ContentBranchNode["static"].splitOnEnter=!0,ve.ce.ContentBranchNode["static"].appendRenderedContents=function(a,b){function c(a){var b,d,e;for(b=0,d=a.childNodes.length;d>b;b++)e=a.childNodes[b],e.veOrigNode?a.replaceChild(e.veOrigNode,e):e.childNodes&&e.childNodes.length&&c(e)}for(c(b);b.firstChild;)a.appendChild(b.firstChild)},ve.ce.ContentBranchNode.prototype.onClick=function(a){a.target===this.$element[0]||"A"!==a.target.nodeName.toUpperCase()||a.altKey||a.ctrlKey||a.metaKey||a.shiftKey||a.preventDefault()},ve.ce.ContentBranchNode.prototype.onChildUpdate=function(a){return null===a||a===this.lastTransaction?void(this.lastTransaction=a):void this.renderContents()},ve.ce.ContentBranchNode.prototype.onSplice=function(a,b){ve.ce.BranchNode.prototype.onSplice.apply(this,arguments),this.root instanceof ve.ce.DocumentNode&&this.root.getSurface().isRenderingLocked&&this.slugNodes.splice.apply(this.slugNodes,[a,b].concat(new Array(arguments.length-2))),this.renderContents()},ve.ce.ContentBranchNode.prototype.setupBlockSlugs=function(){this.root instanceof ve.ce.DocumentNode&&this.root.getSurface().isRenderingLocked()||ve.ce.BranchNode.prototype.setupBlockSlugs.apply(this,arguments)},ve.ce.ContentBranchNode.prototype.getRenderedContents=function(){function a(a){q=!0,""!==E&&(C.appendChild(A.createTextNode(E)),E=""),i=ve.ce.annotationFactory.create(a.getType(),a,F).$element[0],C.appendChild(i),C=i}function b(){q=!0,""!==E&&(C.appendChild(A.createTextNode(E)),E=""),C=C.parentNode}var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x=this.model.doc.getStore(),y=new ve.dm.AnnotationSet(x),z=[],A=this.getElementDocument(),B=A.createElement("div"),C=B,D={},E="",F=this;for(c=0,d=this.children.length;d>c;c++)z=z.concat(this.children[c].getAnnotatedHtml());if(m=-1,this.getRoot()&&(u=this.getRoot().getSurface(),k=u.getModel(),l=k.getTranslatedSelection(),l instanceof ve.dm.LinearSelection&&l.isCollapsed()&&(m=l.getRange().start-this.getOffset()-1)),0>m||m>this.getLength())D.hasCursor=!1;else{for(D.hasCursor=!0,s=0,c=0,d=z.length;d>c;c++){if(t=z[c][0],r="string"==typeof t?1:2,m>=s&&s+r>m){n=[{},k.getInsertionAnnotations().storeIndexes],z.splice(c,0,n);break}s+=r}c===d&&s===m&&(n=[{},k.getInsertionAnnotations().storeIndexes],z.push(n))}for(c=0,d=z.length;d>c;c++)if(Array.isArray(z[c])?(g=z[c][0],h=new ve.dm.AnnotationSet(x,z[c][1])):(g=z[c],h=new ve.dm.AnnotationSet(x)),n&&g===n[0]&&d-1>c&&(w=h.getAnnotationsByName("link"),v=new ve.dm.AnnotationSet(x,Array.isArray(z[c+1])?z[c+1][1]:void 0),v.containsAllOf(w)||h.removeSet(w)),q=!1,ve.dm.Converter.openAndCloseAnnotations(y,h,a,b),"string"==typeof g)E+=g;else if(n&&g===n[0])q?(""!==E&&(C.appendChild(A.createTextNode(E)),E=""),o=A.createElement("img"),p=A.createElement("img"),o.className="ve-ce-unicorn ve-ce-pre-unicorn",p.className="ve-ce-unicorn ve-ce-post-unicorn",$(o).data("dmOffset",this.getOffset()+1+c),$(p).data("dmOffset",this.getOffset()+1+c),ve.inputDebug?(o.setAttribute("src",ve.ce.unicornImgDataUri),p.setAttribute("src",ve.ce.unicornImgDataUri)):(o.setAttribute("src",ve.ce.minImgDataUri),p.setAttribute("src",ve.ce.minImgDataUri),o.style.width="0px",p.style.width="0px",o.style.height="0px",p.style.height="0px"),C.appendChild(o),C.appendChild(p),D.annotations=k.getInsertionAnnotations(),D.unicorns=[o,p]):(D.unicornAnnotations=null,D.unicorns=null);else for(""!==E&&(C.appendChild(A.createTextNode(E)),E=""),e=0,f=g.length;f>e;e++)j=g[e].cloneNode(!0),j.veOrigNode=g[e],C.appendChild(j);return""!==E&&(C.appendChild(A.createTextNode(E)),E=""),B.unicornInfo=D,B},ve.ce.ContentBranchNode.prototype.renderContents=function(){var a,b,c,d,e,f,g,h=this;if(this.root instanceof ve.ce.DocumentNode&&this.root.getSurface().isRenderingLocked())return!1;if(this.root instanceof ve.ce.DocumentNode&&this.root.getSurface().setContentBranchNodeChanged(),d=this.getRenderedContents(),e=d.unicornInfo,delete d.unicornInfo,this.rendered){for(f=this.$element[0].cloneNode(!0),g=this.$element[0].cloneNode(!1);d.firstChild;)g.appendChild(d.firstChild);if(ve.normalizeNode(f),ve.normalizeNode(g),g.isEqualNode(f))return!1;d=g}for(this.rendered=!0,this.unicornAnnotations=e.annotations||null,this.unicorns=e.unicorns||null,a=0,b=this.$element.length;b>a;a++)for(c=this.$element[a];c.firstChild;)c.removeChild(c.firstChild);return this.constructor["static"].appendRenderedContents(this.$element[0],d),this.getRoot()&&(e.hasCursor?this.unicorns?this.getRoot().getSurface().setUnicorning(this):this.getRoot().getSurface().setNotUnicorningAll(this):this.getRoot().getSurface().setNotUnicorning(this)),this.hasCursor=null,this.setupInlineSlugs(),ve.debug&&!ve.test&&(this.$element.css("backgroundColor","#eee"),setTimeout(function(){h.$element.css("backgroundColor","")},500)),!0},ve.ce.ContentBranchNode.prototype.onTeardown=function(){var a=this.getRoot().getSurface();ve.ce.BranchNode.prototype.onTeardown.call(this),a.setNotUnicorning(this)},ve.ce.ContentBranchNode.prototype.destroy=function(){this.$element.off("click",this.onClickHandler)},ve.ce.LeafNode=function(a){ve.LeafNode.call(this),ve.ce.Node.apply(this,arguments),a.isWrapped()&&this.$element.addClass("ve-ce-leafNode")},OO.inheritClass(ve.ce.LeafNode,ve.ce.Node),OO.mixinClass(ve.ce.LeafNode,ve.LeafNode),ve.ce.LeafNode["static"].tagName="span",ve.ce.LeafNode.prototype.onSetup=function(){ve.ce.Node.prototype.onSetup.call(this),this.model.isWrapped()&&this.$element.addClass("ve-ce-leafNode")},ve.ce.LeafNode.prototype.getAnnotatedHtml=function(){return[[this.$element,this.getModel().getAnnotations()]]},ve.ce.ClassAttributeNode=function(a,b){b=b||{},this.$classedElement=a||this.$element,this.currentAttributeClasses="",this.$classedElement.removeClass(this.getModel().getAttribute("originalClasses")).addClass(this.getModel().getAttribute("unrecognizedClasses")),this.connect(this,{setup:"updateAttributeClasses"}),this.model.connect(this,{attributeChange:"updateAttributeClasses"})},OO.initClass(ve.ce.ClassAttributeNode),ve.ce.ClassAttributeNode.prototype.updateAttributeClasses=function(){this.$classedElement.removeClass(this.currentAttributeClasses),this.currentAttributeClasses=this.model.constructor["static"].getClassAttrFromAttributes(this.model.element.attributes),this.$classedElement.addClass(this.currentAttributeClasses)},ve.ce.AlignableNode=function(){ve.ce.AlignableNode["super"].apply(this,arguments),this.align=null},OO.inheritClass(ve.ce.AlignableNode,ve.ce.ClassAttributeNode),ve.ce.AlignableNode.prototype.updateAttributeClasses=function(){ve.ce.AlignableNode["super"].prototype.updateAttributeClasses.apply(this,arguments);var a=this.model.getAttribute("align");a&&a!==this.align&&(this.emit("align",a),this.align=a)},ve.ce.FocusableNode=function(a,b){b=b||{},this.focused=!1,this.highlighted=!1,this.isFocusableSetup=!1,this.$highlights=$("<div>").addClass("ve-ce-focusableNode-highlights"),this.$focusable=a||this.$element,this.focusableSurface=null,this.rects=null,this.boundingRect=null,this.startAndEndRects=null,Array.isArray(b.classes)&&this.$highlights.addClass(b.classes.join(" ")),this.$element.addClass("ve-ce-focusableNode").prop("contentEditable","false"),this.connect(this,{setup:"onFocusableSetup",teardown:"onFocusableTeardown",resizeStart:"onFocusableResizeStart",resizeEnd:"onFocusableResizeEnd",rerender:"onFocusableRerender"})},OO.initClass(ve.ce.FocusableNode),ve.ce.FocusableNode.prototype.createHighlight=function(){return $("<div>").addClass("ve-ce-focusableNode-highlight").prop({title:this.constructor["static"].getDescription(this.model),draggable:!1}).append($("<img>").addClass("ve-ce-focusableNode-highlight-relocatable-marker").attr("src","data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==").on({mousedown:this.onFocusableMouseDown.bind(this),dragstart:this.onFocusableDragStart.bind(this),dragend:this.onFocusableDragEnd.bind(this)}))},ve.ce.FocusableNode.prototype.onFocusableSetup=function(){!this.isFocusableSetup&&this.root&&(this.focusableSurface=this.root.getSurface(),this.$element.addClass("ve-ce-focusableNode").prop("contentEditable","false"),this.$focusable.on({"mouseenter.ve-ce-focusableNode":this.onFocusableMouseEnter.bind(this),"mousedown.ve-ce-focusableNode touchend.ve-ce-focusableNode":this.onFocusableMouseDown.bind(this)}),this.$element.is(this.$focusable)||this.$element.on({"mousedown.ve-ce-focusableNode":function(a){a.preventDefault()}}),this.isFocusableSetup=!0)},ve.ce.FocusableNode.prototype.onFocusableTeardown=function(){this.isFocusableSetup&&this.root&&(this.$focusable.off(".ve-ce-focusableNode"),this.$element.off(".ve-ce-focusableNode"),this.clearHighlights(),this.$element.removeClass("ve-ce-focusableNode").removeProp("contentEditable"),this.focusableSurface=null,this.isFocusableSetup=!1)},ve.ce.FocusableNode.prototype.onFocusableMouseDown=function(a){var b,c=this,d=this.focusableSurface.getModel(),e=d.getSelection(),f=this.model.getOuterRange();this.isInContentEditable()&&(3===a.which&&(this.$highlights.addClass("ve-ce-focusableNode-highlights-contextOpen"),this.$highlights.prop("contentEditable","true"),ve.selectElement(this.$highlights[0]),setTimeout(function(){c.$highlights.removeClass("ve-ce-focusableNode-highlights-contextOpen"),c.$highlights.prop("contentEditable","true"),c.focusableSurface.preparePasteTargetForCopy()})),setTimeout(function(){b=e instanceof ve.dm.LinearSelection&&e.getRange(),d.getLinearFragment(a.shiftKey&&b?ve.Range["static"].newCoveringRange([b,f],b.from>f.from):f).select()}))},ve.ce.FocusableNode.prototype.onFocusableDblClick=function(){this.isInContentEditable()&&this.executeCommand()},ve.ce.FocusableNode.prototype.executeCommand=function(){if(!this.model.isInspectable())return!1;var a=ve.ui.commandRegistry.getCommandForNode(this);a&&a.execute(this.focusableSurface.getSurface())},ve.ce.FocusableNode.prototype.onFocusableDragStart=function(){this.focusableSurface&&this.focusableSurface.startRelocation(this),this.$highlights.addClass("ve-ce-focusableNode-highlights-relocating")},ve.ce.FocusableNode.prototype.onFocusableDragEnd=function(){this.focusableSurface&&this.focusableSurface.endRelocation(),this.$highlights.removeClass("ve-ce-focusableNode-highlights-relocating")},ve.ce.FocusableNode.prototype.onFocusableMouseEnter=function(){this.root.getSurface().dragging||this.root.getSurface().resizing||!this.isInContentEditable()||this.createHighlights()},ve.ce.FocusableNode.prototype.onSurfaceMouseMove=function(a){var b=$(a.target);b.hasClass("ve-ce-focusableNode-highlight")||0!==b.closest(".ve-ce-focusableNode").length||this.clearHighlights()},ve.ce.FocusableNode.prototype.onSurfaceMouseOut=function(a){null===a.relatedTarget&&this.clearHighlights()},ve.ce.FocusableNode.prototype.onFocusableResizeStart=function(){this.clearHighlights()},ve.ce.FocusableNode.prototype.onFocusableResizeEnd=function(){this.redrawHighlights()},ve.ce.FocusableNode.prototype.onFocusableRerender=function(){this.focused&&this.focusableSurface&&(this.redrawHighlights(),this.focusableSurface.getSurface().getContext().updateDimensions(!0))},ve.ce.FocusableNode.prototype.isFocused=function(){return this.focused},ve.ce.FocusableNode.prototype.setFocused=function(a){a=!!a,this.focused!==a&&(this.focused=a,this.focused?(this.emit("focus"),this.$element.addClass("ve-ce-focusableNode-focused"),this.createHighlights(),this.focusableSurface.appendHighlights(this.$highlights,this.focused),this.focusableSurface.$element.off(".ve-ce-focusableNode")):(this.emit("blur"),this.$element.removeClass("ve-ce-focusableNode-focused"),this.clearHighlights()))
},ve.ce.FocusableNode.prototype.createHighlights=function(){this.highlighted||(this.$highlights.on({mousedown:this.onFocusableMouseDown.bind(this),dblclick:this.onFocusableDblClick.bind(this)}),this.highlighted=!0,this.positionHighlights(),this.focusableSurface.appendHighlights(this.$highlights,this.focused),this.focused||this.focusableSurface.$element.on({"mousemove.ve-ce-focusableNode":this.onSurfaceMouseMove.bind(this),"mouseout.ve-ce-focusableNode":this.onSurfaceMouseOut.bind(this)}),this.focusableSurface.connect(this,{position:"positionHighlights"}))},ve.ce.FocusableNode.prototype.clearHighlights=function(){this.highlighted&&(this.$highlights.remove().empty(),this.focusableSurface.$element.off(".ve-ce-focusableNode"),this.focusableSurface.disconnect(this,{position:"positionHighlights"}),this.highlighted=!1,this.boundingRect=null)},ve.ce.FocusableNode.prototype.redrawHighlights=function(){this.clearHighlights(),this.createHighlights()},ve.ce.FocusableNode.prototype.calculateHighlights=function(){function a(a,b){return b.left>=a.left&&b.top>=a.top&&b.right<=a.right&&b.bottom<=a.bottom}function b(b){var c,d,i,k,l,m,n=$(b);if(!n.hasClass("ve-ce-noHighlight"))for(j&&(f=n.css("-webkit-column-count"),g=n.css("-webkit-column-width"),(f&&"auto"!==f||g&&"auto"!==g)&&(e=e.not(n.find("*")))),m=b.getClientRects(),c=0,i=m.length;i>c;c++){for(l=!1,d=0,k=h.length;k>d;d++){if(a(h[d],m[c])){l=!0;break}a(m[c],h[d])&&(h.splice(d,1),d--,k--)}l||h.push(m[c])}}var c,d,e,f,g,h=[],i=[],j="webkitColumnCount"in document.createElement("div").style,k=this.focusableSurface.getSurface().getBoundingClientRect();for(e=this.$focusable.find("*").addBack(),c=0;c<e.length;c++)b(e[c]);for(i=h.filter(function(a){return a.width>1&&a.height>1}),i.length>0&&(h=i),this.boundingRect=null,this.startAndEndRects=null,c=0,d=h.length;d>c;c++)h[c]=ve.translateRect(h[c],-k.left,-k.top),this.$highlights.append(this.createHighlight().css({top:h[c].top,left:h[c].left,width:h[c].width,height:h[c].height})),this.boundingRect?(this.boundingRect.top=Math.min(this.boundingRect.top,h[c].top),this.boundingRect.left=Math.min(this.boundingRect.left,h[c].left),this.boundingRect.bottom=Math.max(this.boundingRect.bottom,h[c].bottom),this.boundingRect.right=Math.max(this.boundingRect.right,h[c].right)):this.boundingRect=ve.copy(h[c]);this.boundingRect&&(this.boundingRect.width=this.boundingRect.right-this.boundingRect.left,this.boundingRect.height=this.boundingRect.bottom-this.boundingRect.top),this.rects=h},ve.ce.FocusableNode.prototype.positionHighlights=function(){if(this.highlighted){var a,b;for(this.calculateHighlights(),this.$highlights.empty().append($("<span>").addClass("ve-ce-focusableNode-highlight-selectable").html("&nbsp;")),a=0,b=this.rects.length;b>a;a++)this.$highlights.append(this.createHighlight().css({top:this.rects[a].top,left:this.rects[a].left,width:this.rects[a].width,height:this.rects[a].height}))}},ve.ce.FocusableNode.prototype.getRects=function(){return this.highlighted||this.calculateHighlights(),this.rects},ve.ce.FocusableNode.prototype.getBoundingRect=function(){return this.highlighted||this.calculateHighlights(),this.boundingRect},ve.ce.FocusableNode.prototype.getStartAndEndRects=function(){return this.highlighted||this.calculateHighlights(),this.startAndEndRects||(this.startAndEndRects=ve.getStartAndEndRects(this.rects)),this.startAndEndRects},ve.ce.ResizableNode=function(a,b){b=b||{},this.$resizable=a||this.$element,this.resizing=!1,this.enabled=!!this.$resizable.length,this.$resizeHandles=$("<div>"),this.snapToGrid=void 0!==b.snapToGrid?b.snapToGrid:10,this.outline=!!b.outline,this.showSizeLabel=b.showSizeLabel!==!1,this.showScaleLabel=b.showScaleLabel!==!1,this.canShowScaleLabel=!1,(this.showSizeLabel||this.showScaleLabel)&&(this.$sizeText=$("<span>").addClass("ve-ce-resizableNode-sizeText"),this.$sizeLabel=$("<div>").addClass("ve-ce-resizableNode-sizeLabel").append(this.$sizeText)),this.resizableOffset=null,this.resizableSurface=null,this.enabled&&(this.connect(this,{focus:"onResizableFocus",blur:"onResizableBlur",setup:"onResizableSetup",teardown:"onResizableTeardown",resizing:"onResizableResizing",resizeEnd:"onResizableFocus",rerender:"onResizableFocus",align:"onResizableAlign"}),this.model.connect(this,{attributeChange:"onResizableAttributeChange"}),this.$resizeHandles.addClass("ve-ce-resizableNode-handles").append($("<div>").addClass("ve-ce-resizableNode-nwHandle").data("handle","nw")).append($("<div>").addClass("ve-ce-resizableNode-neHandle").data("handle","ne")).append($("<div>").addClass("ve-ce-resizableNode-seHandle").data("handle","se")).append($("<div>").addClass("ve-ce-resizableNode-swHandle").data("handle","sw")))},OO.initClass(ve.ce.ResizableNode),ve.ce.ResizableNode.prototype.getResizableOffset=function(){return this.resizableOffset||(this.resizableOffset=OO.ui.Element["static"].getRelativePosition(this.$resizable,this.resizableSurface.getSurface().$element)),this.resizableOffset},ve.ce.ResizableNode.prototype.setOriginalDimensions=function(a){if(this.enabled){var b=this.model.getScalable();b.setOriginalDimensions(a),this.canShowScaleLabel=this.showScaleLabel&&b.getOriginalDimensions().width&&b.getOriginalDimensions().height}},ve.ce.ResizableNode.prototype.hideSizeLabel=function(){if(this.enabled){var a=this;setTimeout(function(){a.$sizeLabel.removeClass("ve-ce-resizableNode-sizeLabel-resizing")}),setTimeout(function(){a.$sizeLabel.addClass("oo-ui-element-hidden")},200)}},ve.ce.ResizableNode.prototype.updateSizeLabel=function(){if(this.enabled&&(this.showSizeLabel||this.canShowScaleLabel)){var a,b,c=this.model.getScalable(),d=c.getCurrentDimensions(),e=this.getResizableOffset(),f=(this.showSizeLabel?100:0)+(this.showScaleLabel?30:0);d.width<f?(a=e.top+d.height,b=30):(a=e.top,b=d.height),this.$sizeLabel.removeClass("oo-ui-element-hidden").addClass("ve-ce-resizableNode-sizeLabel-resizing").css({top:a,left:e.left,width:d.width,height:b,lineHeight:b+"px"}),this.$sizeText.empty(),this.showSizeLabel&&this.$sizeText.append($("<span>").addClass("ve-ce-resizableNode-sizeText-size").text(Math.round(d.width)+" × "+Math.round(d.height))),this.canShowScaleLabel&&this.$sizeText.append($("<span>").addClass("ve-ce-resizableNode-sizeText-scale").text(Math.round(100*c.getCurrentScale())+"%")),this.$sizeText.toggleClass("ve-ce-resizableNode-sizeText-warning",c.isTooSmall()||c.isTooLarge())}},ve.ce.ResizableNode.prototype.showHandles=function(a){if(this.enabled){var b,c,d=[],e=[],f=["nw","ne","sw","se"];for(b=0,c=f.length;c>b;b++)void 0===a||-1!==a.indexOf(f[b])?e.push("ve-ce-resizableNode-hide-"+f[b]):d.push("ve-ce-resizableNode-hide-"+f[b]);this.$resizeHandles.addClass(d.join(" ")).removeClass(e.join(" "))}},ve.ce.ResizableNode.prototype.onResizableFocus=function(){this.$resizeHandles.appendTo(this.resizableSurface.getSurface().$controls),this.$sizeLabel&&this.$sizeLabel.appendTo(this.resizableSurface.getSurface().$controls),this.model.getScalable(),this.setResizableHandlesSizeAndPosition(),this.$resizeHandles.find(".ve-ce-resizableNode-neHandle").css({marginRight:-this.$resizable.width()}).end().find(".ve-ce-resizableNode-swHandle").css({marginBottom:-this.$resizable.height()}).end().find(".ve-ce-resizableNode-seHandle").css({marginRight:-this.$resizable.width(),marginBottom:-this.$resizable.height()}),this.$resizeHandles.children().off(".ve-ce-resizableNode").on("mousedown.ve-ce-resizableNode",this.onResizeHandlesCornerMouseDown.bind(this)),this.resizableSurface.connect(this,{position:"setResizableHandlesSizeAndPosition"})},ve.ce.ResizableNode.prototype.onResizableBlur=function(){this.root&&(this.$resizeHandles.detach(),this.$sizeLabel&&this.$sizeLabel.detach(),this.resizableSurface.disconnect(this,{position:"setResizableHandlesSizeAndPosition"}))},ve.ce.ResizableNode.prototype.onResizableAlign=function(a){switch(a){case"right":this.showHandles(["sw"]);break;case"left":this.showHandles(["se"]);break;case"center":this.showHandles(["sw","se"]);break;default:this.showHandles()}},ve.ce.ResizableNode.prototype.onResizableSetup=function(){!this.isResizableSetup&&this.root&&(this.resizableSurface=this.root.getSurface(),this.isResizableSetup=!0)},ve.ce.ResizableNode.prototype.onResizableTeardown=function(){this.isResizableSetup&&this.root&&(this.onResizableBlur(),this.resizableSurface=null,this.isResizableSetup=!1)},ve.ce.ResizableNode.prototype.onResizableResizing=function(a){this.resizableOffset=null,this.model.getScalable().setCurrentDimensions(a),this.outline||(this.$resizable.css(this.model.getScalable().getCurrentDimensions()),this.setResizableHandlesPosition()),this.updateSizeLabel()},ve.ce.ResizableNode.prototype.onResizableAttributeChange=function(a,b,c){("width"===a||"height"===a)&&this.$resizable.css(a,c)},ve.ce.ResizableNode.prototype.onResizeHandlesCornerMouseDown=function(a){return this.root.getSurface().getSurface().getContext().toggle(!1),this.$resizeHandles.addClass("ve-ce-resizableNode-handles-resizing").css({width:this.$resizable.width(),height:this.$resizable.height()}),this.$resizeHandles.children().css("margin",0),this.resizeInfo={mouseX:a.screenX,mouseY:a.screenY,top:this.$resizeHandles.position().top,left:this.$resizeHandles.position().left,height:this.$resizeHandles.height(),width:this.$resizeHandles.width(),handle:$(a.target).data("handle")},this.resizing=!0,this.root.getSurface().resizing=!0,this.model.getScalable().setCurrentDimensions({width:this.resizeInfo.width,height:this.resizeInfo.height}),this.updateSizeLabel(),$(this.getElementDocument()).on({"mousemove.ve-ce-resizableNode":this.onDocumentMouseMove.bind(this),"mouseup.ve-ce-resizableNode":this.onDocumentMouseUp.bind(this)}),this.emit("resizeStart"),!1},ve.ce.ResizableNode.prototype.setResizableHandlesSizeAndPosition=function(){if(this.enabled){var a=this.$resizable.width(),b=this.$resizable.height();this.resizableOffset=null,this.setResizableHandlesPosition(),this.$resizeHandles.css({width:0,height:0}).find(".ve-ce-resizableNode-neHandle").css({marginRight:-a}).end().find(".ve-ce-resizableNode-swHandle").css({marginBottom:-b}).end().find(".ve-ce-resizableNode-seHandle").css({marginRight:-a,marginBottom:-b})}},ve.ce.ResizableNode.prototype.setResizableHandlesPosition=function(){if(this.enabled){var a=this.getResizableOffset();this.$resizeHandles.css({top:a.top,left:a.left})}},ve.ce.ResizableNode.prototype.onDocumentMouseMove=function(a){var b={},c={width:0,height:0,top:this.resizeInfo.top,left:this.resizeInfo.left};if(this.resizing){switch(this.resizeInfo.handle){case"se":b.x=a.screenX-this.resizeInfo.mouseX,b.y=a.screenY-this.resizeInfo.mouseY;break;case"nw":b.x=this.resizeInfo.mouseX-a.screenX,b.y=this.resizeInfo.mouseY-a.screenY;break;case"ne":b.x=a.screenX-this.resizeInfo.mouseX,b.y=this.resizeInfo.mouseY-a.screenY;break;case"sw":b.x=this.resizeInfo.mouseX-a.screenX,b.y=a.screenY-this.resizeInfo.mouseY}switch(c=this.model.getScalable().getBoundedDimensions({width:this.resizeInfo.width+b.x,height:this.resizeInfo.height+b.y},a.shiftKey&&this.snapToGrid),this.resizeInfo.handle){case"ne":c.top=this.resizeInfo.top+(this.resizeInfo.height-c.height);break;case"sw":c.left=this.resizeInfo.left+(this.resizeInfo.width-c.width);break;case"nw":c.top=this.resizeInfo.top+(this.resizeInfo.height-c.height),c.left=this.resizeInfo.left+(this.resizeInfo.width-c.width)}this.$resizeHandles.css(c),this.emit("resizing",{width:c.width,height:c.height})}},ve.ce.ResizableNode.prototype.onDocumentMouseUp=function(){var a,b=this.model.getOffset(),c=this.$resizeHandles.outerWidth(),d=this.$resizeHandles.outerHeight(),e=this.resizableSurface.getModel(),f=e.getDocument(),g=e.getSelection();this.$resizeHandles.removeClass("ve-ce-resizableNode-handles-resizing"),$(this.getElementDocument()).off(".ve-ce-resizableNode"),this.resizing=!1,this.root.getSurface().resizing=!1,this.hideSizeLabel(),a=this.getAttributeChanges(c,d),ve.isEmptyObject(a)||e.change(ve.dm.Transaction.newFromAttributeChanges(f,b,a),g),this.root.getSurface().getSurface().getContext().updateDimensions(),this.emit("resizeEnd")},ve.ce.ResizableNode.prototype.getAttributeChanges=function(a,b){var c={};return this.model.getAttribute("width")!==a&&(c.width=a),this.model.getAttribute("height")!==b&&(c.height=b),c},ve.ce.Surface=function(a,b,c){var d=this;OO.ui.Element.call(this,c),OO.EventEmitter.call(this),this.surface=b,this.model=a,this.documentView=new ve.ce.Document(a.getDocument(),this),this.surfaceObserver=new ve.ce.SurfaceObserver(this),this.$window=$(this.getElementWindow()),this.$document=$(this.getElementDocument()),this.$documentNode=this.getDocument().getDocumentNode().$element,this.nativeSelection=this.getElementWindow().getSelection(),this.eventSequencer=new ve.EventSequencer(["keydown","keypress","keyup","compositionstart","compositionend","input"]),this.clipboard=[],this.clipboardId=String(Math.random()),this.renderLocks=0,this.dragging=!1,this.relocatingNode=!1,this.selecting=!1,this.resizing=!1,this.focused=!1,this.deactivated=!1,this.$deactivatedSelection=$("<div>"),this.activeTableNode=null,this.contentBranchNodeChanged=!1,this.$highlightsFocused=$("<div>"),this.$highlightsBlurred=$("<div>"),this.$highlights=$("<div>").append(this.$highlightsFocused,this.$highlightsBlurred),this.$findResults=$("<div>"),this.$dropMarker=$("<div>").addClass("ve-ce-surface-dropMarker oo-ui-element-hidden"),this.$lastDropTarget=null,this.lastDropPosition=null,this.$pasteTarget=$("<div>"),this.pasting=!1,this.copying=!1,this.pasteSpecial=!1,this.focusedBlockSlug=null,this.focusedNode=null,this.newModelSelection=null,this.keyDownState={event:null,selection:null,focusIsAfterAnnotationBoundaries:null},this.cursorDirectionality=null,this.unicorningNode=null,this.setUnicorningRecursionGuard=!1,this.cursorHolders=null,this.hasSelectionChangeEvents="onselectionchange"in this.getElementDocument(),this.surfaceObserver.connect(this,{contentChange:"onSurfaceObserverContentChange",rangeChange:"onSurfaceObserverRangeChange",branchNodeChange:"onSurfaceObserverBranchNodeChange"}),this.model.connect(this,{select:"onModelSelect",documentUpdate:"onModelDocumentUpdate",insertionAnnotationsChange:"onInsertionAnnotationsChange"}),this.onDocumentMouseUpHandler=this.onDocumentMouseUp.bind(this),this.$documentNode.on({mousedown:this.onDocumentMouseDown.bind(this),mousemove:this.onDocumentMouseMove.bind(this),cut:this.onCut.bind(this),copy:this.onCopy.bind(this)}),this.onWindowResizeHandler=this.onWindowResize.bind(this),this.$window.on("resize",this.onWindowResizeHandler),this.onDocumentFocusInOutHandler=this.onDocumentFocusInOut.bind(this),this.$document.on("focusin focusout",this.onDocumentFocusInOutHandler),this.debounceFocusChange=ve.debounce(this.onFocusChange).bind(this),this.$document.on("mousedown",this.debounceFocusChange),this.$pasteTarget.add(this.$highlights).on({cut:this.onCut.bind(this),copy:this.onCopy.bind(this),paste:this.onPaste.bind(this)}),this.$documentNode.on("paste",this.onPaste.bind(this)).on("focus","a",function(){d.$documentNode[0].focus()}),this.hasSelectionChangeEvents?this.$document.on("selectionchange",this.onDocumentSelectionChange.bind(this)):this.$documentNode.on("mousemove",this.onDocumentSelectionChange.bind(this)),this.$element.on({dragstart:this.onDocumentDragStart.bind(this),dragover:this.onDocumentDragOver.bind(this),drop:this.onDocumentDrop.bind(this)}),this.eventSequencer.on({keydown:this.onDocumentKeyDown.bind(this),keyup:this.onDocumentKeyUp.bind(this),keypress:this.onDocumentKeyPress.bind(this),input:this.onDocumentInput.bind(this)}).after({keydown:this.afterDocumentKeyDown.bind(this)}),this.$element.addClass("ve-ce-surface notranslate"),this.$highlights.addClass("ve-ce-surface-highlights"),this.$highlightsFocused.addClass("ve-ce-surface-highlights-focused"),this.$highlightsBlurred.addClass("ve-ce-surface-highlights-blurred"),this.$deactivatedSelection.addClass("ve-ce-surface-deactivatedSelection"),this.$pasteTarget.addClass("ve-ce-surface-paste").prop({tabIndex:-1,contentEditable:"true"}),this.$highlights.append(this.$dropMarker),this.$element.append(this.$documentNode,this.$pasteTarget),this.surface.$blockers.append(this.$highlights),this.surface.$selections.append(this.$deactivatedSelection)},OO.inheritClass(ve.ce.Surface,OO.ui.Element),OO.mixinClass(ve.ce.Surface,OO.EventEmitter),ve.ce.Surface["static"].unsafeAttributes=["about","content","datatype","property","rel","resource","rev","typeof","style"],ve.ce.Surface["static"].cursorHolderTemplate=$("<div>").addClass("ve-ce-cursorHolder").prop("contentEditable","true").append($("<img>").addClass("ve-ce-cursorHolder-img")).get(0),ve.ce.Surface["static"].getClipboardHash=function(a,b){return b=b||{},a.text().slice(b.leftText?b.leftText.length:0,b.rightText?-b.rightText.length:void 0).replace(/\s/gm,"")},ve.ce.Surface.prototype.destroy=function(){var a=this.documentView.getDocumentNode();this.surfaceObserver.detach(),this.eventSequencer.detach(),a.setLive(!1),this.surfaceObserver.disconnect(this),this.model.disconnect(this),this.$document.off("focusin focusout",this.onDocumentFocusInOutHandler),this.$document.off("mousedown",this.debounceFocusChange),this.$window.off("resize",this.onWindowResizeHandler),this.$documentNode[0].blur(),this.$element.remove(),this.$highlights.remove()},ve.ce.Surface.prototype.getOffsetFromCoords=function(a,b){var c,d,e,f,g,h=this.getElementDocument();try{return h.caretPositionFromPoint?(d=document.caretPositionFromPoint(a,b),c=ve.ce.getOffset(d.offsetNode,d.offset)):h.caretRangeFromPoint?(e=document.caretRangeFromPoint(a,b),c=ve.ce.getOffset(e.startContainer,e.startOffset)):document.body.createTextRange&&(f=document.body.createTextRange(),f.moveToPoint(a,b),f.pasteHTML('<span class="ve-ce-textRange-drop-marker">&nbsp;</span>'),g=$(".ve-ce-textRange-drop-marker"),c=ve.ce.getOffset(g.get(0),0),g.remove()),c}catch(i){return-1}},ve.ce.Surface.prototype.getNodeClientRectFromRange=function(a){for(var b,c,d,e,f,g=a.endContainer;g&&g.nodeType!==Node.ELEMENT_NODE;)g=g.parentNode;if(!g)return null;if(b=g.getClientRects()[0],!b)return null;if(c="rtl"===this.getModel().getDocument().getDir()?"right":"left",e=a.endContainer.childNodes[a.endOffset],a.collapsed&&$(e).hasClass("ve-ce-unicorn")){if(f=e.getClientRects()[0],!f)return null;d=f[c]}else d=b[c];return{top:b.top,bottom:b.bottom,left:d,right:d,width:0,height:b.height}},ve.ce.Surface.prototype.getSelectionRects=function(a){var b,c,d,e,f,g,h,i=[],j=[];if(a=a||this.getModel().getSelection(),!(a instanceof ve.dm.LinearSelection))return null;if(d=a.getRange(),g=this.getFocusedNode(d))return g.getRects();if(e=this.getNativeRange(d),!e)return null;try{if(i=RangeFix.getClientRects(e),!i.length)throw new Error("getClientRects returned empty list")}catch(k){h=this.getNodeClientRectFromRange(e),h&&(i=[h])}if(f=this.getSurface().getBoundingClientRect(),!i||!f)return null;for(b=0,c=i.length;c>b;b++)j.push(ve.translateRect(i[b],-f.left,-f.top));return j},ve.ce.Surface.prototype.getSelectionStartAndEndRects=function(a){var b,c;return a=a||this.getModel().getSelection(),a instanceof ve.dm.LinearSelection?(b=a.getRange(),c=this.getFocusedNode(b),c?c.getStartAndEndRects():ve.getStartAndEndRects(this.getSelectionRects())):null},ve.ce.Surface.prototype.getSelectionBoundingRect=function(a){var b,c,d,e,f;if(a=a||this.getModel().getSelection(),!(a instanceof ve.dm.LinearSelection))return null;if(b=a.getRange(),f=this.getFocusedNode(b))return f.getBoundingRect();if(c=this.getNativeRange(b),!c)return null;try{if(d=RangeFix.getBoundingClientRect(c),!d)throw new Error("getBoundingClientRect returned null")}catch(g){d=this.getNodeClientRectFromRange(c)}return e=this.getSurface().getBoundingClientRect(),d&&e?ve.translateRect(d,-e.left,-e.top):null},ve.ce.Surface.prototype.initialize=function(){if(this.documentView.getDocumentNode().setLive(!0),"gecko"===$.client.profile().layout)try{this.$document[0].execCommand("enableObjectResizing",!1,!1),this.$document[0].execCommand("enableInlineTableEditing",!1,!1)}catch(a){}},ve.ce.Surface.prototype.enable=function(){this.documentView.getDocumentNode().enable(),this.emit("enable")},ve.ce.Surface.prototype.disable=function(){this.documentView.getDocumentNode().disable(),this.emit("disable")},ve.ce.Surface.prototype.focus=function(){var a,b=this,c=this.getModel().getSelection();if(this.focusedNode||c instanceof ve.dm.TableSelection)this.$pasteTarget[0].focus();else if(c instanceof ve.dm.LinearSelection)a=this.getDocument().getNodeAndOffset(c.getRange().start).node,$(a).closest("[contenteditable=true]")[0].focus();else if(c instanceof ve.dm.NullSelection)return void this.getModel().selectFirstContentOffset();this.onModelSelect(),setTimeout(function(){b.isFocused()||b.getModel().selectFirstContentOffset()})},ve.ce.Surface.prototype.onDocumentFocusInOut=function(a){"iframe"!==a.target.nodeName.toLowerCase()&&this.debounceFocusChange()},ve.ce.Surface.prototype.onFocusChange=function(){var a=!1;a=OO.ui.contains([this.$documentNode[0],this.$pasteTarget[0],this.$highlights[0]],this.nativeSelection.anchorNode,!0),this.deactivated?OO.ui.contains(this.$documentNode[0],this.nativeSelection.anchorNode,!0)&&this.onDocumentFocus():(a&&!this.isFocused()&&this.onDocumentFocus(),!a&&this.isFocused()&&this.onDocumentBlur())},ve.ce.Surface.prototype.deactivate=function(){this.deactivated||(this.surfaceObserver.disable(),this.deactivated=!0,this.nativeSelection.removeAllRanges(),this.updateDeactivatedSelection())},ve.ce.Surface.prototype.activate=function(){this.deactivated&&(this.deactivated=!1,this.updateDeactivatedSelection(),this.surfaceObserver.enable(),OO.ui.contains(this.$documentNode[0],this.nativeSelection.anchorNode,!0)?(this.surfaceObserver.clear(),this.surfaceObserver.pollOnce()):(this.focusedNode=null,this.onModelSelect()))},ve.ce.Surface.prototype.updateDeactivatedSelection=function(){var a,b,c,d=this.getModel().getSelection();if(this.$deactivatedSelection.empty(),this.deactivated&&!this.focusedNode&&d instanceof ve.dm.LinearSelection&&!d.isCollapsed()&&(c=this.getSelectionRects(d)))for(a=0,b=c.length;b>a;a++)this.$deactivatedSelection.append($("<div>").css({top:c[a].top,left:c[a].left,width:c[a].width,height:c[a].height}))},ve.ce.Surface.prototype.onDocumentFocus=function(){this.getModel().getSelection().isNull()&&this.getModel().selectFirstContentOffset(),this.eventSequencer.attach(this.$element),this.surfaceObserver.startTimerLoop(),this.focused=!0,this.activate(),this.emit("focus")},ve.ce.Surface.prototype.onDocumentBlur=function(){this.eventSequencer.detach(),this.surfaceObserver.stopTimerLoop(),this.surfaceObserver.pollOnce(),this.surfaceObserver.clear(),this.dragging=!1,this.focused=!1,this.focusedNode&&(this.focusedNode.setFocused(!1),this.focusedNode=null),this.getModel().setNullSelection(),this.emit("blur")},ve.ce.Surface.prototype.isFocused=function(){return this.focused},ve.ce.Surface.prototype.onDocumentMouseDown=function(a){var b;1===a.which&&(this.dragging=!0,this.$document.on("mouseup",this.onDocumentMouseUpHandler),this.surfaceObserver.stopTimerLoop(),setTimeout(this.afterDocumentMouseDown.bind(this,a,this.getModel().getSelection())),a.originalEvent.detail>=3&&!ve.init.platform.constructor["static"].isInternetExplorer()&&(a.preventDefault(),b=this.getModel().getFragment().collapseToStart().expandLinearSelection("closest",ve.dm.ContentBranchNode).adjustLinearSelection(1,-1),b.isNull()||b.select()))},ve.ce.Surface.prototype.afterDocumentMouseDown=function(a,b){this.surfaceObserver.pollOnce(),a.shiftKey&&this.fixShiftClickSelect(b)},ve.ce.Surface.prototype.onDocumentMouseUp=function(a){this.$document.off("mouseup",this.onDocumentMouseUpHandler),this.surfaceObserver.startTimerLoop(),setTimeout(this.afterDocumentMouseUp.bind(this,a,this.getModel().getSelection()))},ve.ce.Surface.prototype.afterDocumentMouseUp=function(a,b){this.surfaceObserver.pollOnce(),a.shiftKey&&this.fixShiftClickSelect(b),!a.shiftKey&&this.selecting&&(this.emit("selectionEnd"),this.selecting=!1),this.dragging=!1},ve.ce.Surface.prototype.fixShiftClickSelect=function(a){if(a instanceof ve.dm.LinearSelection){var b=this.getModel().getSelection();b.isCollapsed()&&!b.equals(a)&&this.getModel().setLinearSelection(new ve.Range(a.getRange().from,b.getRange().to))}},ve.ce.Surface.prototype.onDocumentMouseMove=function(){this.dragging&&!this.selecting&&(this.selecting=!0,this.emit("selectionStart"))},ve.ce.Surface.prototype.onDocumentSelectionChange=function(){this.dragging&&this.surfaceObserver.pollOnceSelection()},ve.ce.Surface.prototype.onDocumentDragStart=function(a){var b=a.originalEvent.dataTransfer;try{b.setData("application-x/VisualEditor",JSON.stringify(this.getModel().getSelection()))}catch(c){b.setData("text","__ve__"+JSON.stringify(this.getModel().getSelection()))}},ve.ce.Surface.prototype.onDocumentDragOver=function(a){if(this.relocatingNode){var b,c,d,e,f,g,h,i,j;if(!this.relocatingNode.isContent()){if(a.preventDefault(),b=$(a.target).closest(".ve-ce-branchNode, .ve-ce-leafNode"),b.length){for(i=this.relocatingNode.getType(),d=b.data("view");d.parent&&!d.parent.isAllowedChildNodeType(i);)d=d.parent;d.parent&&(j=!1,d.parent.traverseUpstream(function(a){return a.shouldIgnoreChildren()?(j=!0,!1):void 0})),d.parent&&!j?(c=d.$element,e=a.originalEvent.pageY-c.offset().top>c.outerHeight()/2?"bottom":"top"):(c=this.$lastDropTarget,e=this.lastDropPosition)}!this.$lastDropTarget||this.$lastDropTarget.is(c)&&e===this.lastDropPosition||(this.$dropMarker.addClass("oo-ui-element-hidden"),c=null),!c||c.is(this.$lastDropTarget)&&e===this.lastDropPosition||(f=c.position(),g=f.top+parseFloat(c.css("margin-top")),h=f.left+parseFloat(c.css("margin-left")),"bottom"===e&&(g+=c.outerHeight()),this.$dropMarker.css({top:g,left:h}).width(c.outerWidth()).removeClass("oo-ui-element-hidden")),void 0!==c&&(this.$lastDropTarget=c,this.lastDropPosition=e)}this.selecting&&(this.emit("selectionEnd"),this.selecting=!1,this.dragging=!1)}},ve.ce.Surface.prototype.onDocumentDrop=function(a){var b,c,d,e,f,g,h,i,j=a.originalEvent.dataTransfer,k=this.$lastDropTarget,l=this.lastDropPosition;if(a.preventDefault(),this.relocatingNode&&!this.relocatingNode.getModel().isContent()){if(!k)return;g=k.data("view").getModel().getOuterRange(),h="top"===l?g.start:g.end}else if(h=this.getOffsetFromCoords(a.originalEvent.pageX-this.$document.scrollLeft(),a.originalEvent.pageY-this.$document.scrollTop()),-1===h)return;i=this.getModel().getLinearFragment(new ve.Range(h));try{b=j.getData("application-x/VisualEditor")}catch(m){b=j.getData("text"),b="__ve__"===b.slice(0,6)?b.slice(6):null}this.relocatingNode?d=this.relocatingNode.getModel().getOuterRange():b&&(c=ve.dm.Selection["static"].newFromJSON(this.getModel().getDocument(),b),c instanceof ve.dm.LinearSelection&&(d=c.getRange())),d?(e=this.getModel().getLinearFragment(d),f=e.getData(),e.removeContent(),i.insertContent(f)):this.handleDataTransfer(j,!1,i),this.endRelocation()},ve.ce.Surface.prototype.onDocumentKeyDown=function(a){var b,c,d=this.getModel().getSelection(),e=!1;if(!(d instanceof ve.dm.NullSelection)&&229!==a.which){this.surfaceObserver.stopTimerLoop(),this.incRenderLock();try{this.surfaceObserver.pollOnce()}finally{this.decRenderLock()}switch(this.storeKeyDownState(a),a.keyCode){case OO.ui.Keys.LEFT:case OO.ui.Keys.RIGHT:case OO.ui.Keys.UP:case OO.ui.Keys.DOWN:this.dragging||this.selecting||!a.shiftKey||(this.selecting=!0,this.emit("selectionStart")),d instanceof ve.dm.LinearSelection?(this.handleLinearArrowKey(a),e=!0):d instanceof ve.dm.TableSelection&&this.handleTableArrowKey(a);break;case OO.ui.Keys.END:case OO.ui.Keys.HOME:case OO.ui.Keys.PAGEUP:case OO.ui.Keys.PAGEDOWN:d instanceof ve.dm.TableSelection&&this.handleTableArrowKey(a);break;case OO.ui.Keys.ENTER:a.preventDefault(),c=this.getFocusedNode(),c?c.executeCommand():d instanceof ve.dm.LinearSelection?(this.handleLinearEnter(a),e=!0):d instanceof ve.dm.TableSelection&&this.handleTableEnter(a);break;case OO.ui.Keys.BACKSPACE:case OO.ui.Keys.DELETE:d instanceof ve.dm.LinearSelection?(this.handleLinearDelete(a)&&a.preventDefault(),e=!0):d instanceof ve.dm.TableSelection&&(a.preventDefault(),this.handleTableDelete(a));break;case OO.ui.Keys.ESCAPE:this.getActiveTableNode()&&this.handleTableEditingEscape(a);break;default:b=new ve.ui.Trigger(a),b.isComplete()&&this.surface.execute(b)&&(a.preventDefault(),a.stopPropagation(),e=!0)}e||this.incRenderLock();try{this.surfaceObserver.pollOnce()}finally{e||this.decRenderLock()}this.surfaceObserver.startTimerLoop()}},ve.ce.Surface.prototype.onDocumentKeyPress=function(a){0===a.which||0===a.charCode||a.keyCode===OO.ui.Keys.TAB||a.keyCode===OO.ui.Keys.ESCAPE||ve.ce.isShortcutKey(a)||this.handleInsertion()},ve.ce.Surface.prototype.afterDocumentKeyDown=function(a){function b(a,b,c){var d,e;return d=a.nodeType===Node.TEXT_NODE?a:c>0&&b<a.childNodes.length?a.childNodes[b]:0>c&&b>0?a.childNodes[b-1]:a,e=$(d),e.closest("[contenteditable]").prop("contenteditable")?null:e.closest(".ve-ce-focusableNode, .ve-ce-tableNode").data("view")||null}function c(){return q&&p.keyDownState.selection.focusNode&&p.nativeSelection.focusNode&&ve.compareDocumentOrder(p.nativeSelection.focusNode,p.nativeSelection.focusOffset,p.keyDownState.selection.focusNode,p.keyDownState.selection.focusOffset)||null}var d,e,f,g,h,i,j,k,l,m,n,o,p=this,q=a.keyCode===OO.ui.Keys.UP||a.keyCode===OO.ui.Keys.DOWN||a.keyCode===OO.ui.Keys.LEFT||a.keyCode===OO.ui.Keys.RIGHT;if((a.keyCode===OO.ui.Keys.BACKSPACE||a.keyCode===OO.ui.Keys.DELETE)&&this.nativeSelection.focusNode&&this.nativeSelection.focusNode.nodeType===Node.ELEMENT_NODE&&!this.nativeSelection.focusNode.classList.contains("ve-ce-branchNode-inlineSlug")){this.incRenderLock();try{this.surfaceObserver.pollOnce()}finally{this.decRenderLock()}return j=p.model.getSelection(),void(j instanceof ve.dm.LinearSelection&&(i=j.getRange().end,k=this.documentView.getBranchNodeFromOffset(i),k&&k.getModel().hasSlugAtOffset(i)&&k.setupBlockSlugs()))}if(!(a!==this.keyDownState.event||q&&this.restoreActiveTableNodeSelection())){if(o=$(this.nativeSelection.focusNode),o.hasClass("ve-ce-cursorHolder"))o.hasClass("ve-ce-cursorHolder-after")?(d=-1,e=o.prev().data("view")):(d=1,e=o.next().data("view")),this.removeCursorHolders();else if(q&&!a.ctrlKey&&!a.altKey&&!a.metaKey&&this.keyDownState.selection.isCollapsed&&this.nativeSelection.isCollapsed&&null!==(d=c())&&(e=b(this.nativeSelection.focusNode,this.nativeSelection.focusOffset,d),!e)){try{f=ve.ce.getOffset(this.keyDownState.selection.focusNode,this.keyDownState.selection.focusOffset),g=ve.ce.getOffset(this.nativeSelection.focusNode,this.nativeSelection.focusOffset),h=g-f}catch(r){f=g=h=void 0}2===Math.abs(h)&&(e=this.model.documentModel.documentNode.getNodeFromOffset((f+g)/2),e.isFocusable()?l=new ve.Range(f,g):e=void 0)}e&&(l||(l=e.getOuterRange(),0>d&&(l=l.flip())),e instanceof ve.ce.TableNode?d>0?this.model.setSelection(new ve.dm.TableSelection(this.model.documentModel,l,0,0)):(n=e.getModel().getMatrix(),this.model.setSelection(new ve.dm.TableSelection(this.model.documentModel,l,n.getColCount()-1,n.getRowCount()-1))):this.model.setLinearSelection(l),a.keyCode===OO.ui.Keys.LEFT?this.cursorDirectionality=d>0?"rtl":"ltr":a.keyCode===OO.ui.Keys.RIGHT&&(this.cursorDirectionality=0>d?"rtl":"ltr")),m=!a.shiftKey&&(a.keyCode===OO.ui.Keys.LEFT||a.keyCode===OO.ui.Keys.RIGHT),this.incRenderLock();try{this.surfaceObserver.pollOnce()}finally{this.decRenderLock()}this.checkUnicorns(m)}},ve.ce.Surface.prototype.checkUnicorns=function(a){var b,c,d,e,f;if(this.unicorningNode&&this.unicorningNode.unicorns&&(b=this.unicorningNode.unicorns[0],c=this.unicorningNode.unicorns[1],0!==this.nativeSelection.rangeCount)){for(d=this.nativeSelection.getRangeAt(0),e=d.endContainer,e.nodeType===Node.ELEMENT_NODE&&(e=d.endOffset>0?e.childNodes[d.endOffset-1]:null);null!==e&&e.nodeType===Node.TEXT_NODE;)e=e.previousSibling;if(e!==b){if(f=ve.compareDocumentOrder(d.endContainer,d.endOffset,b.parentNode,Array.prototype.indexOf.call(b.parentNode.childNodes,b))<0?-1:1,a){this.incRenderLock();
try{this.moveModelCursor(f)}finally{this.decRenderLock()}}this.renderSelectedContentBranchNode(),this.showSelection(this.getModel().getSelection())}}},ve.ce.Surface.prototype.onDocumentKeyUp=function(a){!this.dragging&&this.selecting&&a.keyCode===OO.ui.Keys.SHIFT&&(this.selecting=!1,this.emit("selectionEnd"));var b,c,d;if(this.surface.toolbarHeight){if(b=this.getNativeRange(),!b)return null;c=RangeFix.getBoundingClientRect(b),c&&c.top<this.surface.toolbarHeight&&(d=this.getScrollPosition()+c.top-this.surface.toolbarHeight,this.setScrollPosition(d))}},ve.ce.Surface.prototype.onCut=function(a){var b=this;this.onCopy(a),setTimeout(function(){b.getModel().getFragment()["delete"]().select()})},ve.ce.Surface.prototype.onCopy=function(a){var b,c,d,e,f,g,h,i=this.getModel().getSelection(),j=this,k=this.getModel().getDocument().getHtmlDocument(),l=a.originalEvent.clipboardData;this.$pasteTarget.empty(),(i instanceof ve.dm.LinearSelection||i instanceof ve.dm.TableSelection&&i.isSingleCell())&&(g=i.getRanges()[0],h=this.model.documentModel.cloneSliceFromRange(g),h.data.cloneElements(!0),ve.dm.converter.getDomSubtreeFromModel(h,this.$pasteTarget[0],!0),this.$pasteTarget.find("span").addClass("ve-pasteProtect"),this.$pasteTarget.find("a").attr("href",function(a,b){return ve.resolveUrl(b,k)}),f="["+ve.ce.Surface["static"].unsafeAttributes.join("],[")+"]",this.$pasteTarget.find(f).each(function(){var a,b,c={},d=ve.ce.Surface["static"].unsafeAttributes;for(a=d.length;a--;)b=this.getAttribute(d[a]),null!==b&&(c[d[a]]=b);this.setAttribute("data-ve-attributes",JSON.stringify(c))}),d={slice:h,hash:null},c=this.clipboard.push(d)-1,l&&l.items?(a.preventDefault(),l.setData("text/xcustom",this.clipboardId+"-"+c),l.setData("text/html",this.$pasteTarget.html()),l.setData("text/plain",this.$pasteTarget.text())):(d.hash=this.constructor["static"].getClipboardHash(this.$pasteTarget.contents()),this.$pasteTarget.prepend($("<span>").attr("data-ve-clipboard-key",this.clipboardId+"-"+c).html("&nbsp;")),b=this.getNativeRange(),b?(e=this.getScrollPosition(),this.surfaceObserver.disable(),ve.selectElement(this.$pasteTarget[0]),this.setScrollPosition(e),setTimeout(function(){OO.ui.contains(j.$highlights[0],b.startContainer,!0)||(j.$documentNode[0].focus(),j.nativeSelection.removeAllRanges(),j.nativeSelection.addRange(b.cloneRange()),j.setScrollPosition(e)),j.surfaceObserver.clear(),j.surfaceObserver.enable()})):ve.selectElement(this.$pasteTarget[0])))},ve.ce.Surface.prototype.onPaste=function(a){var b=this;return this.pasting?!1:(this.beforePaste(a),this.surfaceObserver.disable(),this.pasting=!0,void setTimeout(function(){try{a.isDefaultPrevented()||b.afterPaste(a)}finally{b.surfaceObserver.clear(),b.surfaceObserver.enable(),b.pasting=!1,b.pasteSpecial=!1,b.beforePasteData=null}}))},ve.ce.Surface.prototype.beforePaste=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n=this.getModel().getSelection(),o=a.originalEvent.clipboardData,p=this.getModel().getDocument(),q=p.getNodeFactory();if(!(n instanceof ve.dm.LinearSelection||n instanceof ve.dm.TableSelection&&n.isSingleCell()))return n instanceof ve.dm.TableSelection&&n.isFullTable()?(this.pasteIntoTable(n.getTableNode(),o),void a.preventDefault()):void a.preventDefault();if(c=n.getRanges()[0],this.beforePasteData={},o){if(this.handleDataTransfer(o,!0))return void a.preventDefault();this.beforePasteData.custom=o.getData("text/xcustom"),this.beforePasteData.html=o.getData("text/html"),this.beforePasteData.html&&(this.beforePasteData.html=this.beforePasteData.html.replace(/^[\s\S]*<!-- *StartFragment *-->/,"").replace(/<!-- *EndFragment *-->[\s\S]*$/,""))}c.isCollapsed()||(b=ve.dm.Transaction.newFromRemoval(p,c),n=n.translateByTransaction(b),this.model.change(b,n),c=n.getRanges()[0]),this.beforePasteData.scrollTop=this.getScrollPosition(),this.$pasteTarget.empty(),d=p.getBranchNodeFromOffset(c.start),d.canContainContent()?(l=m=0,e=d.getRange(),f=d.getClonedElement(),h=[f],c.start>e.start&&(i="☀",h.push(i),l=m=1),c.end<e.end&&(j="☂",h.push(j)),i||j||(h.push("☁"),m=1),h.push({type:"/"+h[0].type}),delete f.internal,ve.dm.converter.getDomSubtreeFromModel(p.createDocument(new ve.dm.ElementLinearData(p.getStore(),h,q),q,p.getHtmlDocument(),void 0,p.getInternalList(),p.getLang(),p.getDir()),this.$pasteTarget[0]),this.$pasteTarget[0].focus(),g=this.getElementDocument().createRange(),k=this.$pasteTarget.children().contents()[0],g.setStart(k,l),g.setEnd(k,m),this.nativeSelection.removeAllRanges(),this.nativeSelection.addRange(g),this.beforePasteData.context=h,this.beforePasteData.leftText=i,this.beforePasteData.rightText=j):this.$pasteTarget[0].focus(),this.setScrollPosition(this.beforePasteData.scrollTop)},ve.ce.Surface.prototype.pasteIntoTable=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n;if(c=b.getData("text/html"),c&&(d=ve.createDocumentFromHtml(c))){for($(d).find("[style]").removeAttr("style"),e=ve.dm.converter.getModelFromDom(d,this.getModel().getDocument().getHtmlDocument(),null,null,this.getModel().getDocument()),h=e.data,e.metadata=new ve.dm.MetaLinearData(e.getStore(),new Array(1+h.getLength())),f=this.getSurface().getImportRules(),h.sanitize(f.external,this.pasteSpecial),f.all&&h.sanitize(f.all),h.remapInternalListKeys(this.model.getDocument().getInternalList()),e.buildNodeTree(),g=e.getDocumentNode(),j=null,m=g.getChildren(),n=0;n<m.length;n++)if(m[n]instanceof ve.dm.TableNode){j=m[n];break}j&&(k=e.getData(j.getRange()),l=ve.dm.Transaction.newFromReplacement(this.documentView.model,a.getRange(),k),i=this.model.getSelection(),this.model.change(l,i.collapseToStart()),this.model.setSelection(i.collapseToEnd()))}},ve.ce.Surface.prototype.afterPaste=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u=[],v="[id],[typeof],[rel]",w=this.getSurface().getImportRules(),x=this.beforePasteData||{},y=this.model.getSelection(),z=this;if(this.nativeSelection.isCollapsed&&(y instanceof ve.dm.LinearSelection||y instanceof ve.dm.TableSelection&&y.isSingleCell())){if(e=y.getRanges()[0],this.$pasteTarget.find("[style]").removeAttr("style"),this.$pasteTarget.find("span").each(function(){var a=$(this);a.removeClass("ve-pasteProtect"),""===a.attr("class")&&a.removeAttr("class"),this.attributes.length||a.replaceWith(this.childNodes)}),this.$pasteTarget.find("[data-ve-attributes]").each(function(){var a;try{a=JSON.parse(this.getAttribute("data-ve-attributes"))}catch(b){return}$(this).attr(a),this.removeAttribute("data-ve-attributes")}),x.custom?a=x.custom:x.html?(f=$($.parseHTML(x.html)),f=f.filter(function(){var b=this.getAttribute&&this.getAttribute("data-ve-clipboard-key");return b?(a=b,!1):!0}),d=this.constructor["static"].getClipboardHash(f)):(a=this.$pasteTarget.find("span[data-ve-clipboard-key]").data("ve-clipboard-key"),d=this.constructor["static"].getClipboardHash(this.$pasteTarget,x)),this.$pasteTarget.find("span[data-ve-clipboard-key]").remove(),a&&(g=a.split("-"),b=g[0],c=g[1],b===this.clipboardId&&this.clipboard[c]&&(x.custom||this.clipboard[c].hash===d)&&(i=this.clipboard[c].slice)),i)try{h=new ve.dm.ElementLinearData(i.getStore(),ve.copy(i.getOriginalData()),this.getModel().getDocument().getNodeFactory()),(w.all||this.pasteSpecial)&&h.sanitize(w.all||{},this.pasteSpecial),ve.dm.Document["static"].addAnnotationsToData(h.getData(),this.model.getInsertionAnnotations()),j=ve.dm.Transaction.newFromInsertion(this.documentView.model,e.start,h.getData())}catch(A){h=new ve.dm.ElementLinearData(i.getStore(),ve.copy(i.getBalancedData()),this.getModel().getDocument().getNodeFactory()),(w.all||this.pasteSpecial)&&h.sanitize(w.all||{},this.pasteSpecial),ve.dm.Document["static"].addAnnotationsToData(h.getData(),this.model.getInsertionAnnotations()),j=ve.dm.Transaction.newFromInsertion(this.documentView.model,e.start,h.getData())}else{if(a&&x.html&&(f||(f=$($.parseHTML(x.html))),("useClipboardData-0"===a||f.find(v).andSelf().filter(v).length>0&&0===this.$pasteTarget.find(v).length)&&(n=ve.createDocumentFromHtml(x.html),$(n).find("span").removeClass("ve-pasteProtect"),x.context=null)),n||(n=ve.createDocumentFromHtml(this.$pasteTarget.html())),o=$(n.body).find("img[src^=data\\:]"),o.length){for(p=0;p<o.length;p++)u.push(ve.ui.DataTransferItem["static"].newFromDataUri(o.eq(p).attr("src")));if(this.handleDataTransferItems(u,!0))return}if(m=ve.dm.converter.getModelFromDom(n,{targetDoc:this.getModel().getDocument().getHtmlDocument(),fromClipboard:!0},this.getModel().getDocument()),l=m.data,m.metadata=new ve.dm.MetaLinearData(m.getStore(),new Array(1+l.getLength())),a?l.sanitize(w.all||{},this.pasteSpecial):(l.sanitize(w.external,this.pasteSpecial),w.all&&l.sanitize(w.all)),l.remapInternalListKeys(this.model.getDocument().getInternalList()),m.buildNodeTree(),x.context){for(k=m.getInternalList().getListNode().getOuterRange(),q=new ve.dm.ElementLinearData(m.getStore(),ve.copy(x.context),m.getNodeFactory()),this.pasteSpecial&&q.sanitize(w,this.pasteSpecial,!0),r=0;q.getLength()&&ve.dm.ElementLinearData["static"].compareElements(l.getData(r),l.isElementData(r)?q.getData(0):x.leftText);)r++,q.splice(0,1);for(s=k.start;s>0&&q.getLength()&&ve.dm.ElementLinearData["static"].compareElements(l.getData(s-1),l.isElementData(s-1)?q.getData(q.getLength()-1):x.rightText);)s--,q.splice(q.getLength()-1,1);for(;s>0&&"break"===l.getType(s-1);)s--;t=new ve.Range(r,s)}j=ve.dm.Transaction.newFromDocumentInsertion(this.documentView.model,e.start,m,t)}this.$documentNode[0].focus(),setTimeout(function(){z.setScrollPosition(x.scrollTop)}),y=y.translateByTransaction(j),this.model.change(j,y.collapseToStart()),this.model.setSelection(y.collapseToEnd())}},ve.ce.Surface.prototype.handleDataTransfer=function(a,b,c){var d,e,f,g=[],h=["text/html","text/plain"];if(a.items)for(d=0,e=a.items.length;e>d;d++)"string"!==a.items[d].kind&&g.push(ve.ui.DataTransferItem["static"].newFromItem(a.items[d]));else if(a.files)for(d=0,e=a.files.length;e>d;d++)g.push(ve.ui.DataTransferItem["static"].newFromBlob(a.files[d]));for(d=0,e=h.length;d<h.length;d++)f=a.getData(h[d]),f&&g.push(ve.ui.DataTransferItem["static"].newFromString(f,h[d]));return this.handleDataTransferItems(g,b,c)},ve.ce.Surface.prototype.handleDataTransferItems=function(a,b,c){function d(a){a instanceof ve.dm.Document?c.collapseToEnd().insertDocument(a):c.collapseToEnd().insertContent(a)}var e,f,g,h=!1;for(c=c||this.getModel().getFragment(),e=0,f=a.length;f>e;e++)if(g=ve.ui.dataTransferHandlerFactory.getHandlerNameForItem(a[e],b)){ve.ui.dataTransferHandlerFactory.create(g,this.surface,a[e]).getInsertableData().done(d),h=!0;break}return h},ve.ce.Surface.prototype.selectAll=function(){var a,b,c,d=this.getModel().getSelection();d instanceof ve.dm.LinearSelection?(this.getActiveTableNode()&&this.getActiveTableNode().getEditingFragment()?(b=this.getActiveTableNode().getEditingRange(),b=new ve.Range(b.from+1,b.to-1)):(a=this.getModel().getDocument().getInternalList().getListNode().getOuterRange(),b=new ve.Range(this.getNearestCorrectOffset(0,1),this.getNearestCorrectOffset(a.start,-1))),this.getModel().setLinearSelection(b)):d instanceof ve.dm.TableSelection&&(c=d.getTableNode().getMatrix(),this.getModel().setSelection(new ve.dm.TableSelection(d.getDocument(),d.tableRange,0,0,c.getColCount()-1,c.getRowCount()-1)))},ve.ce.Surface.prototype.onDocumentInput=function(){this.incRenderLock();try{this.surfaceObserver.pollOnce()}finally{this.decRenderLock()}},ve.ce.Surface.prototype.onModelSelect=function(){var a,b,c=this.getModel().getSelection();this.cursorDirectionality=null,this.contentBranchNodeChanged=!1,c instanceof ve.dm.NullSelection&&this.removeCursorHolders(),c instanceof ve.dm.LinearSelection?(b=this.findBlockSlug(c.getRange()),b!==this.focusedBlockSlug&&(this.focusedBlockSlug&&(this.focusedBlockSlug.classList.remove("ve-ce-branchNode-blockSlug-focused"),this.focusedBlockSlug=null),b&&(b.classList.add("ve-ce-branchNode-blockSlug-focused"),this.focusedBlockSlug=b,this.preparePasteTargetForCopy())),a=this.findFocusedNode(c.getRange()),a!==this.focusedNode&&(this.focusedNode&&(this.focusedNode.setFocused(!1),this.focusedNode=null),a&&(a.setFocused(!0),this.focusedNode=a,this.dragging||(this.preparePasteTargetForCopy(),this.surfaceObserver.clear()),OO.ui.Element["static"].scrollIntoView(this.focusedNode.$element.get(0))))):(c instanceof ve.dm.TableSelection&&this.preparePasteTargetForCopy(),this.focusedNode&&this.focusedNode.setFocused(!1),this.focusedNode=null),this.isRenderingLocked()||c===this.newModelSelection||(this.showSelection(c),this.checkUnicorns(!1)),this.surfaceObserver.pollOnceNoEmit()},ve.ce.Surface.prototype.preparePasteTargetForCopy=function(){ve.init.platform.constructor["static"].isIos()?this.deactivate():(this.$pasteTarget.text("☢"),ve.selectElement(this.$pasteTarget[0]),this.$pasteTarget[0].focus())},ve.ce.Surface.prototype.getFocusedNode=function(a){if(!a)return this.focusedNode;var b=this.getModel().getSelection();return b instanceof ve.dm.LinearSelection&&a.equalsSelection(b.getRange())?this.focusedNode:this.findFocusedNode(a)},ve.ce.Surface.prototype.findBlockSlug=function(a){return a.isCollapsed()?this.documentView.getDocumentNode().getSlugAtOffset(a.end):null},ve.ce.Surface.prototype.findFocusedNode=function(a){var b,c,d=this.documentView.getDocumentNode();if(a.isCollapsed()){if(b=d.getNodeFromOffset(a.start),b&&b.isFocusable())return b}else if(b=d.getNodeFromOffset(a.start+1),b&&b.isFocusable()&&(c=d.getNodeFromOffset(a.end-1),b===c))return b;return null},ve.ce.Surface.prototype.onModelDocumentUpdate=function(){var a=this;this.contentBranchNodeChanged&&this.onModelSelect(),this.surfaceObserver.pollOnceNoEmit(),setTimeout(function(){a.emit("position")})},ve.ce.Surface.prototype.onInsertionAnnotationsChange=function(){var a=this.renderSelectedContentBranchNode();a&&(this.showSelection(this.getModel().getSelection()),this.surfaceObserver.pollOnceNoEmit())},ve.ce.Surface.prototype.renderSelectedContentBranchNode=function(){var a,b;return a=this.model.getSelection(),a instanceof ve.dm.LinearSelection?(b=this.documentView.getBranchNodeFromOffset(a.getRange().start),null===b?!1:b instanceof ve.ce.ContentBranchNode?b.renderContents():!1):!1},ve.ce.Surface.prototype.onSurfaceObserverBranchNodeChange=function(a,b){var c;a instanceof ve.ce.ContentBranchNode&&a.renderContents(),b&&(c=this,setTimeout(function(){c.updateCursorHolders(),c.showSelection(c.getModel().getSelection())}))},ve.ce.Surface.prototype.createSlug=function(a){var b,c=this,d=ve.ce.getOffsetOfSlug(a),e=this.getModel().getDocument();this.changeModel(ve.dm.Transaction.newFromInsertion(e,d,[{type:"paragraph",internal:{generated:"slug"}},{type:"/paragraph"}]),new ve.dm.LinearSelection(e,new ve.Range(d+1))),b=this.getDocument().getDocumentNode().getNodeFromOffset(d+1).$element,b.addClass("ve-ce-branchNode-newSlug"),setTimeout(function(){b.addClass("ve-ce-branchNode-newSlug-open"),setTimeout(function(){c.emit("position")},200)}),this.onModelSelect()},ve.ce.Surface.prototype.onSurfaceObserverRangeChange=function(a,b){if(!b||b.isCollapsed()||!a||!a.equalsSelection(b)){this.incRenderLock();try{this.changeModel(null,b?new ve.dm.LinearSelection(this.getModel().getDocument(),b):new ve.dm.NullSelection(this.getModel().getDocument()))}finally{this.decRenderLock()}for(this.checkUnicorns(!1);this.nativeSelection.rangeCount>1;)this.nativeSelection.removeRange(this.nativeSelection.getRangeAt(0))}},ve.ce.Surface.prototype.onSurfaceObserverContentChange=function(a,b,c){function d(a,b){var c,d,e,f,g,h,i=b.start,j=b.end,k=unicodeJS.wordbreak.isBreak(v,i-q-1),l=unicodeJS.wordbreak.isBreak(v,j+u-q-1);if(k||l)for(g=t.getAnnotationsFromOffset(i-1),h=t.getAnnotationsFromOffset(j),c=0,d=a.getLength();d>c;c++)e=a.get(c),f=a.getIndex(c),e.constructor["static"].splitOnWordbreak&&(k&&!h.containsIndex(f)||l&&!g.containsIndex(f))&&(a.removeAt(c),c--,d--)}var e,f,g,h,i,j,k,l,m,n,o=0,p=0,q=a.getModel().getOffset(),r=b.text.split(""),s=c.text.split(""),t=this.model.getDocument().data,u=c.text.length-b.text.length,v=new ve.dm.DataString(s),w=this;if(b.range&&c.range){if(i=b.range.isCollapsed()&&c.range.isCollapsed()?c.range.start-b.range.start:null,k=b.range.start-q-1,l=c.range.start-q-1,j=null!==i&&(u>0&&b.text.slice(0,k)===c.text.slice(0,k)&&b.text.slice(k)===c.text.slice(l)||0>u&&b.text.slice(0,l)===c.text.slice(0,l)&&b.text.slice(k-u+i)===c.text.slice(l)),u>0&&i===u&&j){e=s.slice(k,l),h=a.unicornAnnotations?a.unicornAnnotations:this.keyDownState.focusIsAfterAnnotationBoundaries?t.getAnnotationsFromOffset(q+k+1):this.model.getInsertionAnnotations(),h.getLength()&&(d(h,new ve.Range(b.range.start)),ve.dm.Document["static"].addAnnotationsToData(e,h)),this.incRenderLock();try{this.changeModel(ve.dm.Transaction.newFromInsertion(this.documentView.model,b.range.start,e),new ve.dm.LinearSelection(this.documentView.model,c.range))}finally{this.decRenderLock()}return void setTimeout(function(){w.checkSequences()})}if((0===i||i===u)&&j){f=0===i?new ve.Range(c.range.start,c.range.start-u):new ve.Range(c.range.start,b.range.start),this.incRenderLock();try{this.changeModel(ve.dm.Transaction.newFromRemoval(this.documentView.model,f),new ve.dm.LinearSelection(this.documentView.model,c.range))}finally{this.decRenderLock()}return}}for(g=Math.min(r.length,s.length);g>o&&r[o]===s[o];)++o;for(;g-o>p&&r[r.length-1-p]===s[s.length-1-p];)++p;n=new ve.Range(q+1+o,q+1+r.length-p),e=s.slice(o,s.length-p),h=a.unicornAnnotations?a.unicornAnnotations:t.getAnnotationsFromOffset(o+p<r.length?n.start:n.start-1),h.getLength()&&(d(h,n),ve.dm.Document["static"].addAnnotationsToData(e,h)),m=c.range,m.isCollapsed()&&(m=new ve.Range(this.getNearestCorrectOffset(m.start,1))),this.changeModel(ve.dm.Transaction.newFromReplacement(this.documentView.model,n,e),new ve.dm.LinearSelection(this.documentView.model,m)),this.queueCheckSequences=!0,setTimeout(function(){w.checkSequences()})},ve.ce.Surface.prototype.checkSequences=function(){var a,b,c=!1,d=this.getModel(),e=d.getSelection();if(e instanceof ve.dm.LinearSelection){for(b=ve.ui.sequenceRegistry.findMatching(d.getDocument().data,e.getRange().end),a=0;a<b.length;a++)c=b[a].execute(this.surface)||c;c&&this.showSelection(d.getSelection())}},ve.ce.Surface.prototype.onWindowResize=ve.debounce(function(){this.emit("position")},50),ve.ce.Surface.prototype.startRelocation=function(a){this.relocatingNode=a,this.emit("relocationStart",a)},ve.ce.Surface.prototype.endRelocation=function(){this.relocatingNode&&(this.emit("relocationEnd",this.relocatingNode),this.relocatingNode=null,this.$lastDropTarget&&(this.$dropMarker.addClass("oo-ui-element-hidden"),this.$lastDropTarget=null,this.lastDropPosition=null))},ve.ce.Surface.prototype.setActiveTableNode=function(a){this.activeTableNode=a},ve.ce.Surface.prototype.getActiveTableNode=function(){return this.activeTableNode},ve.ce.Surface.prototype.storeKeyDownState=function(a){this.keyDownState.event=a,this.keyDownState.selection=null,this.keyDownState.focusIsAfterAnnotationBoundaries=null,this.nativeSelection.rangeCount>0&&(this.keyDownState.focusIsAfterAnnotationBoundaries=ve.ce.isAfterAnnotationBoundaries(this.nativeSelection.focusNode,this.nativeSelection.focusOffset),(a.keyCode===OO.ui.Keys.UP||a.keyCode===OO.ui.Keys.DOWN||a.keyCode===OO.ui.Keys.LEFT||a.keyCode===OO.ui.Keys.RIGHT)&&(this.keyDownState.selection={isCollapsed:this.nativeSelection.isCollapsed,anchorNode:this.nativeSelection.anchorNode,anchorOffset:this.nativeSelection.anchorOffset,focusNode:this.nativeSelection.focusNode,focusOffset:this.nativeSelection.focusOffset}))},ve.ce.Surface.prototype.clearKeyDownState=function(){this.keyDownState.event=null,this.keyDownState.selection=null},ve.ce.Surface.prototype.moveModelCursor=function(a){var b=this.model.getSelection();b instanceof ve.dm.LinearSelection&&this.model.setLinearSelection(this.model.getDocument().getRelativeRange(b.getRange(),a,"character",!1))},ve.ce.Surface.prototype.getFocusedNodeDirectionality=function(){var a,b=this.model.getSelection().getRange();return this.cursorDirectionality?this.cursorDirectionality:(a=this.getDocument().getNodeAndOffset(b.to).node,a.nodeType===Node.TEXT_NODE&&(a=a.parentNode),$(a).css("direction"))},ve.ce.Surface.prototype.restoreActiveTableNodeSelection=function(){var a,b;return(a=this.getActiveTableNode())&&(b=a.getEditingRange())&&!b.containsRange(ve.ce.veRangeFromSelection(this.nativeSelection))?(this.showSelection(this.getModel().getSelection()),!0):!1},ve.ce.Surface.prototype.findAdjacentUneditableBranchNode=function(a){var b,c=a>0;if(b=$(this.nativeSelection.focusNode).closest(".ve-ce-branchNode,.ve-ce-leafNode,.ve-ce-surface-paste")[0],!b||b.classList.contains("ve-ce-surface-paste"))return null;for(;;){for(;!(c?b.nextSibling:b.previousSibling);)if(b=b.parentNode,null===b)return null;for(b=c?b.nextSibling:b.previousSibling;;){if($.data(b,"view")instanceof ve.ce.ContentBranchNode||b.nodeType===Node.TEXT_NODE)return null;if($(b).is(".ve-ce-focusableNode,.ve-ce-tableNode"))return b;if(!b.childNodes||0===b.childNodes.length)break;b=c?b.firstChild:b.lastChild}}},ve.ce.Surface.prototype.handleLinearArrowKey=function(a){var b,c,d,e,f,g,h,i,j=this.model.getSelection().getRange(),k=this;if(this.surfaceObserver.stopTimerLoop(),this.surfaceObserver.pollOnce(),g=a.keyCode===OO.ui.Keys.UP||a.keyCode===OO.ui.Keys.DOWN,this.focusedBlockSlug)return g?e=a.keyCode===OO.ui.Keys.DOWN?1:-1:(f=$(this.focusedBlockSlug).css("direction"),e=a.keyCode===OO.ui.Keys.LEFT^"rtl"===f?-1:1),j=this.model.getDocument().getRelativeRange(j,e,"character",a.shiftKey,this.getActiveTableNode()?this.getActiveTableNode().getEditingRange():null),this.model.setLinearSelection(j),void a.preventDefault();if(this.focusedNode){if(g?e=a.keyCode===OO.ui.Keys.DOWN?1:-1:(f=this.getFocusedNodeDirectionality(),e=a.keyCode===OO.ui.Keys.LEFT^"rtl"===f?-1:1),!this.focusedNode.isContent())return j=this.model.getDocument().getRelativeRange(j,e,"character",a.shiftKey,this.getActiveTableNode()?this.getActiveTableNode().getEditingRange():null),this.model.setLinearSelection(j),void a.preventDefault();if(a.shiftKey)-1===e^j.isBackwards()&&(j=j.flip()),this.model.setLinearSelection(new ve.Range(j.to));else if(j=new ve.Range(1===e?j.end:j.start),this.model.setLinearSelection(j),!g)return void a.preventDefault()}!this.nativeSelection.extend&&j.isBackwards()?(c=this.nativeSelection.anchorNode,d=this.nativeSelection.anchorOffset):!j.isCollapsed()&&g&&(c=this.nativeSelection.focusNode,d=this.nativeSelection.focusOffset),c&&(b=this.getElementDocument().createRange(),b.setStart(c,d),b.setEnd(c,d),this.nativeSelection.removeAllRanges(),this.nativeSelection.addRange(b)),h=this.nativeSelection.focusNode,i=this.nativeSelection.focusOffset,this.eventSequencer.afterOne({keydown:function(){var b,c,d;b=$(k.nativeSelection.focusNode).closest(".ve-ce-leafNode,.ve-ce-branchNode").data("view"),b&&(b.isFocusable()?(d=g?a.keyCode===OO.ui.Keys.DOWN?1:-1:ve.compareDocumentOrder(h,i,k.nativeSelection.focusNode,k.nativeSelection.focusOffset),c=d>0?b.getOuterRange():b.getOuterRange().flip()):(k.surfaceObserver.pollOnceNoEmit(),c=new ve.Range(k.surfaceObserver.getRange().to)),a.shiftKey&&(c=new ve.Range(j.from,c.to),k.getModel().setLinearSelection(c)),k.surfaceObserver.pollOnce())}})},ve.ce.Surface.prototype.updateCursorHolders=function(){var a=null,b=null,c=this.getElementDocument(),d=this.findAdjacentUneditableBranchNode(-1),e=this.findAdjacentUneditableBranchNode(1);this.removeCursorHolders(),d&&(a=c.importNode(this.constructor["static"].cursorHolderTemplate,!0),a.classList.add("ve-ce-cursorHolder-after"),ve.inputDebug&&$(a).css({width:"2px",height:"2px",border:"solid red 1px"}),$(d).after(a)),e&&(b=c.importNode(this.constructor["static"].cursorHolderTemplate,!0),b.classList.add("ve-ce-cursorHolder-before"),ve.inputDebug&&$(b).css({width:"2px",height:"2px",border:"solid red 1px"}),$(e).before(b)),this.cursorHolders={before:a,after:b}},ve.ce.Surface.prototype.removeCursorHolders=function(){this.cursorHolders&&(this.cursorHolders.before&&this.cursorHolders.before.remove(),this.cursorHolders.after&&this.cursorHolders.after.remove(),this.cursorHolders=null)},ve.ce.Surface.prototype.handleTableArrowKey=function(a){var b,c,d=!1,e=this.getModel().getSelection(),f=0,g=0;switch(a.keyCode){case OO.ui.Keys.LEFT:f=-1,d=!0;break;case OO.ui.Keys.RIGHT:f=1,d=!0;break;case OO.ui.Keys.UP:g=-1;break;case OO.ui.Keys.DOWN:g=1;break;case OO.ui.Keys.HOME:f=-1/0;break;case OO.ui.Keys.END:f=1/0;break;case OO.ui.Keys.PAGEUP:g=-1/0;break;case OO.ui.Keys.PAGEDOWN:g=1/0}a.preventDefault(),f&&d&&(b=this.documentView.getBranchNodeFromOffset(e.tableRange.start+1),"ltr"!==b.$element.css("direction")&&(f*=-1)),a.shiftKey||e.isSingleCell()||(e=e.collapseToFrom()),c=e.newFromAdjustment(a.shiftKey?0:f,a.shiftKey?0:g,f,g),this.getModel().setSelection(c)},ve.ce.Surface.prototype.handleInsertion=function(){if(!this.focusedNode){var a,b,c,d=!1,e=this.model.getSelection(),f=this.model.getDocument();e instanceof ve.dm.TableSelection&&(c=e.collapseToFrom(),b=f.data.getAnnotationsFromRange(c.getRanges()[0]),this.model.setSelection(c),this.handleTableDelete(),this.documentView.getBranchNodeFromOffset(e.tableRange.start+1).setEditing(!0),this.model.setInsertionAnnotations(b),e=this.model.getSelection()),e instanceof ve.dm.LinearSelection&&(a=e.getRange(),a.isCollapsed()||(b=f.data.getAnnotationsFromRange(new ve.Range(a.start,a.start+1)),this.documentView.rangeInsideOneLeafNode(a)||(this.model.change(ve.dm.Transaction.newFromRemoval(this.documentView.model,a),new ve.dm.LinearSelection(f,new ve.Range(a.start))),d=!0,this.surfaceObserver.clear(),a=this.model.getSelection().getRange()),this.model.setInsertionAnnotations(b)),d&&(this.surfaceObserver.stopTimerLoop(),this.surfaceObserver.pollOnce()))}},ve.ce.Surface.prototype.handleLinearEnter=function(a){var b,c,d,e,f,g,h,i,j=this.model.getSelection().getRange(),k=j.from,l=this.model.getDocument(),m=[{type:"paragraph"},{type:"/paragraph"}],n=!0,o=[],p=null,q=null,r=null;if(j.isCollapsed()||(b=ve.dm.Transaction.newFromRemoval(l,j),j=b.translateRange(j),this.model.change(b,new ve.dm.LinearSelection(l,j))),i=this.documentView.getBranchNodeFromOffset(j.from),null!==i&&(q=i.getModel(),r=q.getRange()),i&&i.handleEnter)return i.handleEnter(this,j.from),void this.surfaceObserver.clear();if(null===i)throw new Error("node === null");if("paragraph"===q.getType()||k!==r.from&&k!==r.to){if(a.shiftKey&&q.hasSignificantWhitespace())c=ve.dm.Transaction.newFromInsertion(l,j.from,"\n");else if(!i.splitOnEnter()){if(h=!1,l.hasSlugAtOffset(j.from)?h=!0:(g=l.data.getNearestContentOffset(k,-1),-1===g&&(h=!0)),!h)return k=g,i=this.documentView.getBranchNodeFromOffset(k),void(c=void 0);c=ve.dm.Transaction.newFromInsertion(l,k,m),h=void 0}}else k===r.to?c=ve.dm.Transaction.newFromInsertion(l,q.getOuterRange().to,m):k===r.from&&(c=ve.dm.Transaction.newFromInsertion(l,q.getOuterRange().from,m),n=!1);void 0===c&&(i.traverseUpstream(function(b){return b.splitOnEnter()?(o.splice(o.length/2,0,{type:"/"+b.type},b.getModel().getClonedElement()),p=b,a.shiftKey?!1:!0):!1}),d=p.getModel().getParent(),e=d.getChildren().length,"listItem"===p.type&&d.getChildren()[e-1]===p.getModel()&&1===p.children.length&&0===i.getModel().length?(f=p.getModel().getParent(),1===f.getChildren().length?c=ve.dm.Transaction.newFromRemoval(l,f.getOuterRange()):(c=ve.dm.Transaction.newFromRemoval(l,p.getModel().getOuterRange()),this.model.change(c),j=c.translateRange(j),c=ve.dm.Transaction.newFromInsertion(l,f.getOuterRange().to,m)),n=!1):c=ve.dm.Transaction.newFromInsertion(l,j.from,o)),this.model.change(c),j=c.translateRange(j),k=n?l.data.getRelativeContentOffset(j.from,1):l.data.getNearestContentOffset(j.from),-1===k?(this.model.change(ve.dm.Transaction.newFromInsertion(l,j.from,m)),this.model.setLinearSelection(new ve.Range(j.from+1))):this.model.setLinearSelection(new ve.Range(k)),this.surfaceObserver.clear()},ve.ce.Surface.prototype.handleTableEnter=function(a){var b=this.getModel().getSelection(),c=this.documentView.getBranchNodeFromOffset(b.tableRange.start+1);a.preventDefault(),c.setEditing(!0)},ve.ce.Surface.prototype.handleLinearDelete=function(a){var b,c,d,e,f,g,h,i,j=a.keyCode===OO.ui.Keys.DELETE?1:-1,k=a.altKey===!0||a.ctrlKey===!0?"word":"character",l=0,m=this.getModel().getSelection().getRange(),n=this.getModel().getDocument(),o=n.data;if(m.isCollapsed()){if(l=m.start,!a.ctrlKey&&(-1===j&&!o.isElementData(l-1)||1===j&&!o.isElementData(l)))return this.eventSequencer.afterOne({keydown:this.surfaceObserver.pollOnce.bind(this.surfaceObserver)}),!1;if(m=n.getRelativeRange(m,j,k,!0),d=this.getActiveTableNode()?this.getActiveTableNode().getEditingRange():null,d&&!d.containsRange(m))return!0;for(e=n.selectNodes(m,"siblings"),f=0;f<e.length;f++)if(g=e[f].node,h=e[f].nodeOuterRange,g instanceof ve.dm.TableNode)return m.containsOffset(h.start)?this.getModel().setSelection(new ve.dm.TableSelection(n,h,0,0)):(i=g.getMatrix(),this.getModel().setSelection(new ve.dm.TableSelection(n,h,i.getColCount()-1,i.getRowCount()-1))),!0;if(l=m.start,b=o.getLength(),b>l){for(;b>l&&o.isCloseElementData(l);)l++;if(c=n.getDocumentNode().getNodeFromOffset(l+1),c.isFocusable())return this.getModel().setLinearSelection(c.getOuterRange()),!0}if(m.isCollapsed())return!0}return this.getModel().getLinearFragment(m,!0)["delete"](j).select(),this.focus(),this.surfaceObserver.clear(),!0},ve.ce.Surface.prototype.handleTableDelete=function(){var a,b,c=this.getModel(),d=[],e=c.getSelection().getRanges();for(a=0,b=e.length;b>a;a++)d.push(c.getLinearFragment(e[a],!0));for(a=0,b=d.length;b>a;a++)d[a].insertContent([{type:"paragraph",internal:{generated:"wrapper"}},{type:"/paragraph"}])},ve.ce.Surface.prototype.handleTableEditingEscape=function(a){a.preventDefault(),a.stopPropagation(),this.getActiveTableNode().setEditing(!1)},ve.ce.Surface.prototype.getViewportRange=function(){function a(a){var b=null;return a.traverseUpstream(function(a){a.shouldIgnoreChildren()&&(b=a)}),b}function b(b,f,g){for(var h,i,j,k,l,m=f.start,n=f.end,o=1/0;f.getLength()<o;)o=f.getLength(),h=Math.round((f.start+f.end)/2),j=d.documentNode.getNodeFromOffset(h),k=a(j),k?(l=k.getOuterRange(),h="top"===g?l.end:l.start):h=e.getNearestContentOffset(h),i=c.getSelectionBoundingRect(new ve.dm.LinearSelection(d,new ve.Range(h))),i[g]>b?(n=h,f=new ve.Range(f.start,n)):(m=h,f=new ve.Range(m,f.end));return"bottom"===g?m:n}var c=this,d=this.getModel().getDocument(),e=d.data,f=this.getSurface().getBoundingClientRect(),g=50,h=Math.max(this.surface.toolbarHeight-f.top-g,0),i=h+this.$window.height()-this.surface.toolbarHeight+2*g,j=new ve.Range(0,this.getModel().getDocument().getInternalList().getListNode().getOuterRange().start);return new ve.Range(b(h,j,"bottom"),b(i,j,"top"))},ve.ce.Surface.prototype.showSelection=function(a){if(this.deactivated)return void setTimeout(this.updateDeactivatedSelection.bind(this));if(a instanceof ve.dm.LinearSelection&&!this.focusedNode&&!this.focusedBlockSlug){var b,c,d,e=a.getRange(),f=this.getRangeSelection(e),g=this.getElementDocument().createRange();if(g.setStart(f.start.node,f.start.offset),f.end&&g.setEnd(f.end.node,f.end.offset),f.end&&f.isBackwards&&this.nativeSelection.extend){b=g.cloneRange(),b.collapse(!1),this.nativeSelection.removeAllRanges(),this.nativeSelection.addRange(b);try{this.nativeSelection.extend(g.startContainer,g.startOffset)}catch(h){this.nativeSelection.addRange(g)}}else{if(this.nativeSelection.rangeCount>0&&(c=this.nativeSelection.getRangeAt(0))&&c.startContainer===g.startContainer&&c.startOffset===g.startOffset&&c.endContainer===g.endContainer&&c.endOffset===g.endOffset)return;this.nativeSelection.removeAllRanges(),this.nativeSelection.addRange(g)}OO.ui.contains(this.getElementDocument().activeElement,f.start.node,!0)?(d=$(f.start.node).closest("*"),OO.ui.Element["static"].scrollIntoView(d.get(0))):$(f.start.node).closest("[contenteditable=true]").focus()}},ve.ce.Surface.prototype.getRangeSelection=function(a){return a=new ve.Range(this.getNearestCorrectOffset(a.from,-1),this.getNearestCorrectOffset(a.to,1)),a.isCollapsed()?{start:this.documentView.getNodeAndOffset(a.start)}:{start:this.documentView.getNodeAndOffset(a.start),end:this.documentView.getNodeAndOffset(a.end),isBackwards:a.isBackwards()}
},ve.ce.Surface.prototype.getNativeRange=function(a){var b,c,d=this.getModel().getSelection();if(a&&!this.deactivated&&d instanceof ve.dm.LinearSelection&&d.getRange().equalsSelection(a)&&(a=null),!a){if(!(d instanceof ve.dm.LinearSelection))return null;if(this.nativeSelection.rangeCount>0)try{return this.nativeSelection.getRangeAt(0)}catch(e){}return null}return b=document.createRange(),c=this.getRangeSelection(a),b.setStart(c.start.node,c.start.offset),c.end&&b.setEnd(c.end.node,c.end.offset),b},ve.ce.Surface.prototype.appendHighlights=function(a,b){this.$highlightsBlurred.children().detach(),b?this.$highlightsFocused.append(a):this.$highlightsBlurred.append(a)},ve.ce.Surface.prototype.getNearestCorrectOffset=function(a,b){var c,d,e=this.getModel().getDocument(),f=e.data;return b=b>0?1:-1,f.isContentOffset(a)||e.hasSlugAtOffset(a)?a:(c=f.getNearestContentOffset(a,b),d=f.getNearestStructuralOffset(a,b,!0),e.hasSlugAtOffset(d)||-1===c?1===b?a>c?d:Math.min(c,d):c>a?d:Math.max(c,d):c)},ve.ce.Surface.prototype.getSurface=function(){return this.surface},ve.ce.Surface.prototype.getModel=function(){return this.model},ve.ce.Surface.prototype.getDocument=function(){return this.documentView},ve.ce.Surface.prototype.isRenderingLocked=function(){return this.renderLocks>0},ve.ce.Surface.prototype.incRenderLock=function(){this.renderLocks++},ve.ce.Surface.prototype.decRenderLock=function(){this.renderLocks--},ve.ce.Surface.prototype.changeModel=function(a,b){if(null!==this.newModelSelection)throw new Error("Nested change of newModelSelection");this.newModelSelection=b;try{this.model.change(a,b)}finally{this.newModelSelection=null}},ve.ce.Surface.prototype.setContentBranchNodeChanged=function(){this.contentBranchNodeChanged=!0,this.clearKeyDownState()},ve.ce.Surface.prototype.setUnicorning=function(a){if(this.setUnicorningRecursionGuard)throw new Error("setUnicorning recursing");if(this.unicorningNode&&this.unicorningNode!==a){this.setUnicorningRecursionGuard=!0;try{this.unicorningNode.renderContents()}finally{this.setUnicorningRecursionGuard=!1}}this.unicorningNode=a},ve.ce.Surface.prototype.setNotUnicorning=function(a){this.unicorningNode===a&&(this.unicorningNode=null)},ve.ce.Surface.prototype.setNotUnicorningAll=function(a){this.unicorningNode===a&&(this.unicorningNode=null),this.setUnicorning(null)},ve.ce.Surface.prototype.setScrollPosition=function(a){this.$window.scrollTop(a)},ve.ce.Surface.prototype.getScrollPosition=function(){return this.$window.scrollTop()},ve.ce.SurfaceObserver=function(a){OO.EventEmitter.call(this),this.surface=a,this.documentView=a.getDocument(),this.domDocument=this.documentView.getDocumentNode().getElementDocument(),this.polling=!1,this.disabled=!1,this.timeoutId=null,this.pollInterval=250,this.rangeState=null},OO.mixinClass(ve.ce.SurfaceObserver,OO.EventEmitter),ve.ce.SurfaceObserver.prototype.clear=function(){this.rangeState=null},ve.ce.SurfaceObserver.prototype.detach=function(){this.surface=null,this.documentView=null,this.domDocument=null},ve.ce.SurfaceObserver.prototype.startTimerLoop=function(){this.polling=!0,this.timerLoop(!0)},ve.ce.SurfaceObserver.prototype.timerLoop=function(a){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),a||this.pollOnce(),null!==this.pollInterval&&(this.timeoutId=this.setTimeout(this.timerLoop.bind(this),this.pollInterval))},ve.ce.SurfaceObserver.prototype.stopTimerLoop=function(){this.polling===!0&&(this.polling=!1,clearTimeout(this.timeoutId),this.timeoutId=null)},ve.ce.SurfaceObserver.prototype.disable=function(){this.disabled=!0},ve.ce.SurfaceObserver.prototype.enable=function(){this.disabled=!1},ve.ce.SurfaceObserver.prototype.pollOnce=function(){this.pollOnceInternal(!0)},ve.ce.SurfaceObserver.prototype.pollOnceNoEmit=function(){this.pollOnceInternal(!1)},ve.ce.SurfaceObserver.prototype.pollOnceSelection=function(){this.pollOnceInternal(!0,!0)},ve.ce.SurfaceObserver.prototype.pollOnceInternal=function(a,b){var c,d;this.domDocument&&!this.disabled&&(c=this.rangeState,d=new ve.ce.RangeState(c,this.documentView.getDocumentNode(),b),this.rangeState=d,!b&&null!==d.node&&d.contentChanged&&a&&this.emit("contentChange",d.node,{text:c.text,hash:c.hash,range:c.veRange},{text:d.text,hash:d.hash,range:d.veRange}),d.branchNodeChanged&&this.emit("branchNodeChange",c&&c.node&&c.node.root?c.node:null,d.node),d.selectionChanged&&a&&this.emit("rangeChange",c?c.veRange:null,d.veRange))},ve.ce.SurfaceObserver.prototype.setTimeout=function(a,b){return setTimeout(a,b)},ve.ce.SurfaceObserver.prototype.getRange=function(){return this.rangeState?this.rangeState.veRange:null},ve.ce.GeneratedContentNode=function(){this.generatingPromise=null,this.model.connect(this,{update:"onGeneratedContentNodeUpdate"}),this.connect(this,{teardown:"abortGenerating"}),this.update()},OO.initClass(ve.ce.GeneratedContentNode),ve.ce.GeneratedContentNode["static"].renderHtmlAttributes=!1,ve.ce.GeneratedContentNode.prototype.generateContents=null,ve.ce.GeneratedContentNode.prototype.onGeneratedContentNodeUpdate=function(){this.update()},ve.ce.GeneratedContentNode.prototype.getRenderedDomElements=function(a){var b,c,d,e=this.getElementDocument();if(d=$(ve.copyDomElements(a,e)),d=d.not("link, style"),d.find("link, style").remove(),d.length)for(b=0,c=d.length;c>b;b++)d[b].nodeType===Node.TEXT_NODE&&(d[b]=$("<span>").append(d[b])[0]);else d=$("<span>");return ve.resolveAttributes(d,a[0].ownerDocument,ve.dm.Converter.computedAttributes),d.toArray()},ve.ce.GeneratedContentNode.prototype.render=function(a){this.live&&this.emit("teardown");var b=$(this.getRenderedDomElements(ve.copyDomElements(a)));this.$element[0].parentNode?(this.$element.first().replaceWith(b),this.$element.remove(),this.$element=b):this.$element=b,this.$focusable&&(this.$focusable=this.getFocusableElement()),this.$resizable&&(this.$resizable=this.getResizableElement()),this.live&&this.emit("setup"),this.afterRender()},ve.ce.GeneratedContentNode.prototype.afterRender=function(){this.emit("rerender")},ve.ce.GeneratedContentNode.prototype.update=function(a){var b=this.model.doc.getStore(),c=b.indexOfHash(OO.getHash([this.model,a]));null!==c?this.render(b.value(c)):this.forceUpdate(a)},ve.ce.GeneratedContentNode.prototype.forceUpdate=function(a){var b,c=this;this.generatingPromise?this.abortGenerating():this.startGenerating(),b=this.generatingPromise=this.generateContents(a),b.done(function(d){c.generatingPromise===b&&c.doneGenerating(d,a)}).fail(function(){c.generatingPromise===b&&c.failGenerating()})},ve.ce.GeneratedContentNode.prototype.startGenerating=function(){this.$element.addClass("ve-ce-generatedContentNode-generating")},ve.ce.GeneratedContentNode.prototype.abortGenerating=function(){var a=this.generatingPromise;a&&(this.generatingPromise=null,$.isFunction(a.abort)&&a.abort()),this.$element.removeClass("ve-ce-generatedContentNode-generating")},ve.ce.GeneratedContentNode.prototype.doneGenerating=function(a,b){var c,d;this.model.doc&&(c=this.model.doc.getStore(),d=OO.getHash([this.model,b]),c.index(a,d)),this.$element.removeClass("ve-ce-generatedContentNode-generating"),this.generatingPromise=null,this.render(a)},ve.ce.GeneratedContentNode.prototype.failGenerating=function(){this.$element.removeClass("ve-ce-generatedContentNode-generating"),this.generatingPromise=null},ve.ce.GeneratedContentNode.prototype.isGenerating=function(){return!!this.generatingPromise},ve.ce.GeneratedContentNode.prototype.getFocusableElement=function(){return this.$element},ve.ce.GeneratedContentNode.prototype.getResizableElement=function(){return this.$element},ve.ce.GeneratedContentNode.prototype.isVisible=function(){if(""!==this.$element.text().trim())return!0;var a=!1;return this.$element.each(function(){var b=$(this);return b.width()>=8&&b.height()>=8?(a=!0,!1):void 0}),a},ve.ce.AlienNode=function(){ve.ce.AlienNode["super"].apply(this,arguments),this.$element=$(ve.copyDomElements(this.model.getOriginalDomElements(),document)),ve.ce.FocusableNode.call(this,this.$element,{classes:["ve-ce-alienNode-highlights"]})},OO.inheritClass(ve.ce.AlienNode,ve.ce.LeafNode),OO.mixinClass(ve.ce.AlienNode,ve.ce.FocusableNode),ve.ce.AlienNode["static"].name="alien",ve.ce.AlienNode["static"].getDescription=function(){return ve.msg("visualeditor-aliennode-tooltip")},ve.ce.AlienBlockNode=function(){ve.ce.AlienBlockNode["super"].apply(this,arguments)},OO.inheritClass(ve.ce.AlienBlockNode,ve.ce.AlienNode),ve.ce.AlienBlockNode["static"].name="alienBlock",ve.ce.AlienInlineNode=function(){ve.ce.AlienInlineNode["super"].apply(this,arguments)},OO.inheritClass(ve.ce.AlienInlineNode,ve.ce.AlienNode),ve.ce.AlienInlineNode["static"].name="alienInline",ve.ce.nodeFactory.register(ve.ce.AlienBlockNode),ve.ce.nodeFactory.register(ve.ce.AlienInlineNode),ve.ce.BlockquoteNode=function(a,b){ve.ce.ContentBranchNode.call(this,a,b)},OO.inheritClass(ve.ce.BlockquoteNode,ve.ce.ContentBranchNode),ve.ce.BlockquoteNode["static"].name="blockquote",ve.ce.BlockquoteNode["static"].tagName="blockquote",ve.ce.nodeFactory.register(ve.ce.BlockquoteNode),ve.ce.BreakNode=function(){ve.ce.BreakNode["super"].apply(this,arguments),this.$element.addClass("ve-ce-breakNode")},OO.inheritClass(ve.ce.BreakNode,ve.ce.LeafNode),ve.ce.BreakNode["static"].name="break",ve.ce.BreakNode["static"].tagName="br",ve.ce.nodeFactory.register(ve.ce.BreakNode),ve.ce.CenterNode=function(){ve.ce.CenterNode["super"].apply(this,arguments)},OO.inheritClass(ve.ce.CenterNode,ve.ce.BranchNode),ve.ce.CenterNode["static"].name="center",ve.ce.CenterNode["static"].tagName="center",ve.ce.nodeFactory.register(ve.ce.CenterNode),ve.ce.CommentNode=function(a,b){ve.ce.CommentNode["super"].call(this,a,b),ve.ce.FocusableNode.call(this,this.$element,b),OO.ui.mixin.IndicatorElement.call(this,$.extend({},b,{$indicator:this.$element,indicator:"alert"})),this.$element.addClass("ve-ce-commentNode").text(" ")},OO.inheritClass(ve.ce.CommentNode,ve.ce.LeafNode),OO.mixinClass(ve.ce.CommentNode,ve.ce.FocusableNode),OO.mixinClass(ve.ce.CommentNode,OO.ui.mixin.IndicatorElement),ve.ce.CommentNode["static"].name="comment",ve.ce.CommentNode["static"].primaryCommandName="comment",ve.ce.CommentNode["static"].getDescription=function(a){return a.getAttribute("text")},ve.ce.nodeFactory.register(ve.ce.CommentNode),ve.ce.DefinitionListItemNode=function(){ve.ce.DefinitionListItemNode["super"].apply(this,arguments),this.model.connect(this,{update:"onUpdate"})},OO.inheritClass(ve.ce.DefinitionListItemNode,ve.ce.BranchNode),ve.ce.DefinitionListItemNode["static"].name="definitionListItem",ve.ce.DefinitionListItemNode["static"].splitOnEnter=!0,ve.ce.DefinitionListItemNode.prototype.getTagName=function(){var a=this.model.getAttribute("style"),b={definition:"dd",term:"dt"};if(!Object.prototype.hasOwnProperty.call(b,a))throw new Error("Invalid style");return b[a]},ve.ce.DefinitionListItemNode.prototype.onUpdate=function(){this.updateTagName()},ve.ce.nodeFactory.register(ve.ce.DefinitionListItemNode),ve.ce.DefinitionListNode=function(){ve.ce.DefinitionListNode["super"].apply(this,arguments)},OO.inheritClass(ve.ce.DefinitionListNode,ve.ce.BranchNode),ve.ce.DefinitionListNode["static"].name="definitionList",ve.ce.DefinitionListNode["static"].tagName="dl",ve.ce.nodeFactory.register(ve.ce.DefinitionListNode),ve.ce.DivNode=function(){ve.ce.DivNode["super"].apply(this,arguments)},OO.inheritClass(ve.ce.DivNode,ve.ce.BranchNode),ve.ce.DivNode["static"].name="div",ve.ce.nodeFactory.register(ve.ce.DivNode),ve.ce.DocumentNode=function(a,b,c){ve.ce.DocumentNode["super"].call(this,a,c),this.surface=b,this.setRoot(this),this.$element.addClass("ve-ce-documentNode"),this.$element.prop({contentEditable:"true",spellcheck:!0})},OO.inheritClass(ve.ce.DocumentNode,ve.ce.BranchNode),ve.ce.DocumentNode["static"].name="document",ve.ce.DocumentNode.prototype.getOuterLength=function(){return this.length},ve.ce.DocumentNode.prototype.getSurface=function(){return this.surface},ve.ce.DocumentNode.prototype.disable=function(){this.$element.prop("contentEditable","false")},ve.ce.DocumentNode.prototype.enable=function(){this.$element.prop("contentEditable","true")},ve.ce.nodeFactory.register(ve.ce.DocumentNode),ve.ce.HeadingNode=function(){ve.ce.HeadingNode["super"].apply(this,arguments),this.model.connect(this,{update:"onUpdate"})},OO.inheritClass(ve.ce.HeadingNode,ve.ce.ContentBranchNode),ve.ce.HeadingNode["static"].name="heading",ve.ce.HeadingNode.prototype.getTagName=function(){var a=this.model.getAttribute("level"),b={1:"h1",2:"h2",3:"h3",4:"h4",5:"h5",6:"h6"};if(!Object.prototype.hasOwnProperty.call(b,a))throw new Error("Invalid level");return b[a]},ve.ce.HeadingNode.prototype.onUpdate=function(){this.updateTagName()},ve.ce.nodeFactory.register(ve.ce.HeadingNode),ve.ce.InternalItemNode=function(){ve.ce.InternalItemNode["super"].apply(this,arguments),this.$element.addClass("ve-ce-internalItemNode")},OO.inheritClass(ve.ce.InternalItemNode,ve.ce.BranchNode),ve.ce.InternalItemNode["static"].name="internalItem",ve.ce.InternalItemNode["static"].tagName="span",ve.ce.nodeFactory.register(ve.ce.InternalItemNode),ve.ce.InternalListNode=function(){ve.ce.InternalListNode["super"].apply(this,arguments),this.$element=$([])},OO.inheritClass(ve.ce.InternalListNode,ve.ce.BranchNode),ve.ce.InternalListNode["static"].name="internalList",ve.ce.InternalListNode.prototype.onSplice=function(){},ve.ce.nodeFactory.register(ve.ce.InternalListNode),ve.ce.ListItemNode=function(){ve.ce.ListItemNode["super"].apply(this,arguments)},OO.inheritClass(ve.ce.ListItemNode,ve.ce.BranchNode),ve.ce.ListItemNode["static"].name="listItem",ve.ce.ListItemNode["static"].tagName="li",ve.ce.ListItemNode["static"].splitOnEnter=!0,ve.ce.nodeFactory.register(ve.ce.ListItemNode),ve.ce.ListNode=function(){ve.ce.ListNode["super"].apply(this,arguments),this.model.connect(this,{update:"onUpdate"})},OO.inheritClass(ve.ce.ListNode,ve.ce.BranchNode),ve.ce.ListNode["static"].name="list",ve.ce.ListNode.prototype.getTagName=function(){var a=this.model.getAttribute("style"),b={bullet:"ul",number:"ol"};if(!Object.prototype.hasOwnProperty.call(b,a))throw new Error("Invalid style");return b[a]},ve.ce.ListNode.prototype.onUpdate=function(){this.updateTagName()},ve.ce.nodeFactory.register(ve.ce.ListNode),ve.ce.ParagraphNode=function(){ve.ce.ParagraphNode["super"].apply(this,arguments),this.$element.addClass("ve-ce-paragraphNode"),this.model.getElement().internal&&"wrapper"===this.model.getElement().internal.generated&&this.$element.addClass("ve-ce-generated-wrapper")},OO.inheritClass(ve.ce.ParagraphNode,ve.ce.ContentBranchNode),ve.ce.ParagraphNode["static"].name="paragraph",ve.ce.ParagraphNode["static"].tagName="p",ve.ce.nodeFactory.register(ve.ce.ParagraphNode),ve.ce.PreformattedNode=function(){ve.ce.PreformattedNode["super"].apply(this,arguments)},OO.inheritClass(ve.ce.PreformattedNode,ve.ce.ContentBranchNode),ve.ce.PreformattedNode["static"].name="preformatted",ve.ce.PreformattedNode["static"].tagName="pre",ve.ce.nodeFactory.register(ve.ce.PreformattedNode),ve.ce.TableCaptionNode=function(){ve.ce.TableCaptionNode["super"].apply(this,arguments),this.$element.addClass("ve-ce-tableCaptionNode").prop("contentEditable","true")},OO.inheritClass(ve.ce.TableCaptionNode,ve.ce.BranchNode),ve.ce.TableCaptionNode["static"].name="tableCaption",ve.ce.TableCaptionNode["static"].tagName="caption",ve.ce.nodeFactory.register(ve.ce.TableCaptionNode),ve.ce.TableCellNode=function(){ve.ce.TableCellNode["super"].apply(this,arguments);var a=this.model.getRowspan(),b=this.model.getColspan();this.$element.addClass("ve-ce-tableCellNode ve-ce-tableCellNode-"+this.model.getAttribute("style")),a>1&&this.$element.attr("rowspan",a),b>1&&this.$element.attr("colspan",b),this.$element.attr("title",ve.msg("visualeditor-tablecell-tooltip")),this.model.connect(this,{update:"onUpdate",attributeChange:"onAttributeChange"})},OO.inheritClass(ve.ce.TableCellNode,ve.ce.BranchNode),ve.ce.TableCellNode["static"].name="tableCell",ve.ce.TableCellNode.prototype.getTagName=function(){var a=this.model.getAttribute("style"),b={data:"td",header:"th"};if(!Object.prototype.hasOwnProperty.call(b,a))throw new Error("Invalid style");return b[a]},ve.ce.TableCellNode.prototype.setEditing=function(a){this.$element.toggleClass("ve-ce-tableCellNode-editing",a).prop("contentEditable",a.toString())},ve.ce.TableCellNode.prototype.onUpdate=function(){this.updateTagName()},ve.ce.TableCellNode.prototype.onSetup=function(){ve.ce.TableCellNode["super"].prototype.onSetup.call(this);var a=this.model.getRowspan(),b=this.model.getColspan();a>1&&this.$element.attr("rowspan",a),b>1&&this.$element.attr("colspan",b)},ve.ce.TableCellNode.prototype.onAttributeChange=function(a,b,c){switch(a){case"colspan":case"rowspan":c>1?this.$element.attr(a,c):this.$element.removeAttr(a);break;case"style":this.$element.removeClass("ve-ce-tableCellNode-"+b).addClass("ve-ce-tableCellNode-"+c),this.updateTagName()}},ve.ce.nodeFactory.register(ve.ce.TableCellNode),ve.ce.TableNode=function(){ve.ce.TableNode["super"].apply(this,arguments),this.surface=null,this.active=!1,this.startCell=null,this.editingFragment=null,this.$element.addClass("ve-ce-tableNode").prop("contentEditable","false")},OO.inheritClass(ve.ce.TableNode,ve.ce.BranchNode),ve.ce.TableNode.prototype.onSetup=function(){ve.ce.TableNode["super"].prototype.onSetup.call(this),!this.isSetup&&this.root&&(this.surface=this.getRoot().getSurface(),this.$selectionBox=$("<div>").addClass("ve-ce-tableNodeOverlay-selection-box"),this.$selectionBoxAnchor=$("<div>").addClass("ve-ce-tableNodeOverlay-selection-box-anchor"),this.colContext=new ve.ui.TableContext(this,"col",{classes:["ve-ui-tableContext-colContext"],indicator:"down"}),this.rowContext=new ve.ui.TableContext(this,"row",{classes:["ve-ui-tableContext-rowContext"],indicator:"next"}),this.$overlay=$("<div>").addClass("ve-ce-tableNodeOverlay oo-ui-element-hidden").append([this.$selectionBox,this.$selectionBoxAnchor,this.colContext.$element,this.rowContext.$element,this.$rowBracket,this.$colBracket]),this.surface.surface.$blockers.append(this.$overlay),this.$element.on({"mousedown.ve-ce-tableNode":this.onTableMouseDown.bind(this),"dblclick.ve-ce-tableNode":this.onTableDblClick.bind(this)}),this.onTableMouseUpHandler=this.onTableMouseUp.bind(this),this.onTableMouseMoveHandler=this.onTableMouseMove.bind(this),this.updateOverlayDebounced=ve.debounce(this.updateOverlay.bind(this)),this.surface.getModel().connect(this,{select:"onSurfaceModelSelect"}),this.surface.connect(this,{position:this.updateOverlayDebounced}))},ve.ce.TableNode.prototype.onTeardown=function(){ve.ce.TableNode["super"].prototype.onTeardown.call(this),this.$element.off(".ve-ce-tableNode"),this.surface.getModel().disconnect(this),this.surface.disconnect(this),this.$overlay.remove()},ve.ce.TableNode.prototype.onTableDblClick=function(a){this.getCellNodeFromTarget(a.target)&&this.surface.getModel().getSelection()instanceof ve.dm.TableSelection&&this.setEditing(!0)},ve.ce.TableNode.prototype.onTableMouseDown=function(a){var b,c,d,e,f;if(!("touchstart"===a.type&&a.originalEvent.touches.length>1)&&(b=this.getCellNodeFromTarget(a.target))){if(d=this.getModel().getMatrix().lookupCell(b.getModel()),!d)return void a.preventDefault();if(e=this.surface.getModel().getSelection(),c=a.shiftKey&&this.active?{col:e.fromCol,row:e.fromRow}:d,f=new ve.dm.TableSelection(this.getModel().getDocument(),this.getModel().getOuterRange(),c.col,c.row,d.col,d.row,!0),this.editingFragment){if(f.equals(this.editingFragment.getSelection()))return;this.setEditing(!1,!0)}this.surface.getModel().setSelection(f),this.startCell=c,this.surface.$document.on({"mouseup touchend":this.onTableMouseUpHandler,"mousemove touchmove":this.onTableMouseMoveHandler}),a.preventDefault()}},ve.ce.TableNode.prototype.getCellNodeFromTarget=function(a){var b=$(a),c=b.closest("table");return this.$element.is(c)?b.closest("td, th").data("view"):null},ve.ce.TableNode.prototype.onTableMouseMove=function(a){var b,c,d,e,f;if("touchmove"===a.type){if(a.originalEvent.touches.length>1)return;d=a.originalEvent.touches[0],e=this.surface.getElementDocument().elementFromPoint(d.clientX,d.clientY)}else e=a.target;f=this.getCellNodeFromTarget(e),f&&(b=this.getModel().matrix.lookupCell(f.getModel()),b&&(c=new ve.dm.TableSelection(this.getModel().getDocument(),this.getModel().getOuterRange(),this.startCell.col,this.startCell.row,b.col,b.row,!0),this.surface.getModel().setSelection(c)))},ve.ce.TableNode.prototype.onTableMouseUp=function(){this.startCell=null,this.surface.$document.off({"mouseup touchend":this.onTableMouseUpHandler,"mousemove touchmove":this.onTableMouseMoveHandler})},ve.ce.TableNode.prototype.setEditing=function(a,b){var c,d,e,f=this.surface.getModel(),g=f.getSelection();a?(g.isSingleCell()||(g=g.collapseToFrom(),this.surface.getModel().setSelection(g)),this.editingFragment=this.surface.getModel().getFragment(g),c=this.getCellNodesFromSelection(g)[0],c.setEditing(!0),b||(e=c.getModel().getRange(),d=f.getDocument().data.getNearestContentOffset(e.end,-1),d>e.start&&f.setLinearSelection(new ve.Range(d)))):this.editingFragment&&(this.getCellNodesFromSelection(this.editingFragment.getSelection())[0].setEditing(!1),b||f.setSelection(this.editingFragment.getSelection()),this.editingFragment=null),this.$element.toggleClass("ve-ce-tableNode-editing",a),this.$overlay.toggleClass("ve-ce-tableNodeOverlay-editing",a)},ve.ce.TableNode.prototype.getEditingFragment=function(){return this.editingFragment},ve.ce.TableNode.prototype.getEditingRange=function(){var a=this.getEditingFragment();return a?a.getSelection().getRanges()[0]:null},ve.ce.TableNode.prototype.onSurfaceModelSelect=function(a){var b=null!==this.editingFragment&&a instanceof ve.dm.LinearSelection&&this.editingFragment.getSelection().getRanges()[0].containsRange(a.getRange())||a instanceof ve.dm.TableSelection&&a.tableRange.equalsSelection(this.getModel().getOuterRange());b?(this.active||(this.$overlay.removeClass("oo-ui-element-hidden"),this.$element.on("touchstart.ve-ce-tableNode",this.onTableMouseDown.bind(this))),this.surface.setActiveTableNode(this),this.updateOverlayDebounced(!0)):!b&&this.active&&(this.$overlay.addClass("oo-ui-element-hidden"),this.editingFragment&&this.setEditing(!1,!0),this.surface.getActiveTableNode()===this&&this.surface.setActiveTableNode(null),this.$element.off("touchstart.ve-ce-tableNode")),this.$element.toggleClass("ve-ce-tableNode-active",b),this.active=b},ve.ce.TableNode.prototype.updateOverlay=function(a){if(this.active&&this.root){var b,c,d,e,f,g,h,i,j,k,l,m=this.editingFragment?this.editingFragment.getSelection():this.surface.getModel().getSelection(),n=this.getFirstSectionNode().$element[0].getBoundingClientRect(),o=this.surface.getSurface().$element[0].getBoundingClientRect();if(n){for(d=this.getCellNodesFromSelection(m),f=this.getCellNodesFromSelection(m.collapseToFrom())[0],g=ve.translateRect(f.$element[0].getBoundingClientRect(),-n.left,-n.top),i=1/0,k=-1/0,j=1/0,l=-1/0,b=0,c=d.length;c>b;b++)e=d[b].$element[0].getBoundingClientRect(),i=Math.min(i,e.top),k=Math.max(k,e.bottom),j=Math.min(j,e.left),l=Math.max(l,e.right);h=ve.translateRect({top:i,bottom:k,left:j,right:l,width:l-j,height:k-i},-n.left,-n.top),this.$selectionBox.css({top:h.top,left:h.left,width:h.width,height:h.height}),this.$selectionBoxAnchor.css({top:g.top,left:g.left,width:g.width,height:g.height}),this.$overlay.css({top:n.top-o.top,left:n.left-o.left,width:n.width}),this.colContext.$element.css({left:h.left}),this.colContext.indicator.$element.css({width:h.width}),this.colContext.popup.$element.css({"margin-left":h.width/2}),this.rowContext.$element.css({top:h.top}),this.rowContext.indicator.$element.css({height:h.height}),this.rowContext.popup.$element.css({"margin-top":h.height/2}),this.$selectionBox.toggleClass("ve-ce-tableNodeOverlay-selection-box-fullRow",m.isFullRow()).toggleClass("ve-ce-tableNodeOverlay-selection-box-fullCol",m.isFullCol()),a&&OO.ui.Element["static"].scrollIntoView(this.$selectionBox.get(0))}}},ve.ce.TableNode.prototype.getFirstSectionNode=function(){for(var a=0;!(this.children[a]instanceof ve.ce.TableSectionNode);)a++;return this.children[a]},ve.ce.TableNode.prototype.getCellNodesFromSelection=function(a){var b,c,d,e,f=a.getMatrixCells(),g=[];for(b=0,c=f.length;c>b;b++)d=f[b].node,e=this.getNodeFromOffset(d.getOffset()-this.model.getOffset()),g.push(e);return g},ve.ce.TableNode["static"].name="table",ve.ce.TableNode["static"].tagName="table",ve.ce.nodeFactory.register(ve.ce.TableNode),ve.ce.TableRowNode=function(){ve.ce.TableRowNode["super"].apply(this,arguments)},OO.inheritClass(ve.ce.TableRowNode,ve.ce.BranchNode),ve.ce.TableRowNode["static"].name="tableRow",ve.ce.TableRowNode["static"].tagName="tr",ve.ce.nodeFactory.register(ve.ce.TableRowNode),ve.ce.TableSectionNode=function(){ve.ce.TableSectionNode["super"].apply(this,arguments),this.model.connect(this,{update:"onUpdate"})},OO.inheritClass(ve.ce.TableSectionNode,ve.ce.BranchNode),ve.ce.TableSectionNode["static"].name="tableSection",ve.ce.TableSectionNode.prototype.getTagName=function(){var a=this.model.getAttribute("style"),b={header:"thead",body:"tbody",footer:"tfoot"};if(!Object.prototype.hasOwnProperty.call(b,a))throw new Error("Invalid style");return b[a]},ve.ce.TableSectionNode.prototype.onUpdate=function(){this.updateTagName()},ve.ce.nodeFactory.register(ve.ce.TableSectionNode),ve.ce.TextNode=function(){ve.ce.TextNode["super"].apply(this,arguments),this.$element=$([])},OO.inheritClass(ve.ce.TextNode,ve.ce.LeafNode),ve.ce.TextNode["static"].name="text",ve.ce.TextNode["static"].splitOnEnter=!0,ve.ce.TextNode.whitespaceHtmlCharacters={"\n":"↵","	":"➞"},ve.ce.TextNode.prototype.getAnnotatedHtml=function(){function a(a,b,c){Array.isArray(c[b])?(c[b]=c[b].slice(0),c[b][0]=a):c[b]=a}function b(a,b){return Array.isArray(b[a])?b[a][0]:b[a]}var c,d,e=this.model.getDocument().getDataFromNode(this.model),f=ve.ce.TextNode.whitespaceHtmlCharacters,g=this.getModel().getParent().hasSignificantWhitespace();if(!g){for(c=0;c<e.length;c++)d=b(c,e),Object.prototype.hasOwnProperty.call(f,d)&&a(f[d],c,e);for(e.length>0&&" "===b(0,e)&&a(" ",0,e),e.length>1&&" "===b(e.length-1,e)&&a(" ",e.length-1,e),c=0;c<e.length-1;c++)" "===b(c,e)&&" "===b(c+1,e)&&a(" ",c+1,e)}return e},ve.ce.nodeFactory.register(ve.ce.TextNode),ve.ce.ImageNode=function(a,b,c){c=ve.extendObject({enforceMax:!1,minDimensions:{width:1,height:1}},c),this.$figure=a,this.$image=b||a,ve.ce.FocusableNode.call(this,this.$figure,c),ve.ce.ResizableNode.call(this,this.$image,c),this.$image.on("load",this.onLoad.bind(this)),this.model.connect(this,{attributeChange:"onAttributeChange"}),this.$element.addClass("ve-ce-imageNode")},OO.mixinClass(ve.ce.ImageNode,ve.ce.FocusableNode),OO.mixinClass(ve.ce.ImageNode,ve.ce.ResizableNode),ve.ce.ImageNode["static"].getDescription=function(a){return a.getAttribute("src")},ve.ce.ImageNode.prototype.onAttributeChange=function(a,b,c){switch(a){case"src":this.$image.prop("src",this.getResolvedAttribute("src"));break;case"width":case"height":this.$image.css(a,null!==c?c:"")}},ve.ce.ImageNode.prototype.onLoad=function(){this.setOriginalDimensions({width:this.$image.prop("naturalWidth"),height:this.$image.prop("naturalHeight")})},ve.ce.BlockImageNode=function(a,b){b=ve.extendObject({minDimensions:{width:1,height:1}},b),ve.ce.BlockImageNode["super"].call(this,a,b),this.$image=$("<img>").prop("src",this.getResolvedAttribute("src")).prependTo(this.$element),ve.ce.ImageNode.call(this,this.$element,this.$image,b),ve.ce.AlignableNode.call(this,this.$element,b),this.$element.addClass("ve-ce-blockImageNode"),this.$image.prop({alt:this.model.getAttribute("alt"),src:this.getResolvedAttribute("src")}).css({width:this.model.getAttribute("width"),height:this.model.getAttribute("height")})},OO.inheritClass(ve.ce.BlockImageNode,ve.ce.BranchNode),OO.mixinClass(ve.ce.BlockImageNode,ve.ce.ImageNode),OO.mixinClass(ve.ce.BlockImageNode,ve.ce.ClassAttributeNode),OO.mixinClass(ve.ce.BlockImageNode,ve.ce.AlignableNode),ve.ce.BlockImageNode["static"].name="blockImage",ve.ce.BlockImageNode["static"].tagName="figure",ve.ce.nodeFactory.register(ve.ce.BlockImageNode),ve.ce.BlockImageCaptionNode=function(){ve.ce.BlockImageCaptionNode["super"].apply(this,arguments)},OO.inheritClass(ve.ce.BlockImageCaptionNode,ve.ce.BranchNode),ve.ce.BlockImageCaptionNode["static"].name="imageCaption",ve.ce.BlockImageCaptionNode["static"].tagName="figcaption",ve.ce.nodeFactory.register(ve.ce.BlockImageCaptionNode),ve.ce.InlineImageNode=function(a,b){b=ve.extendObject({minDimensions:{width:1,height:1}},b),ve.ce.InlineImageNode["super"].call(this,a,b),ve.ce.ImageNode.call(this,this.$element,null,b),this.$element.addClass("ve-ce-inlineImageNode").prop({alt:this.model.getAttribute("alt"),src:this.getResolvedAttribute("src")}).css({width:this.model.getAttribute("width"),height:this.model.getAttribute("height")})},OO.inheritClass(ve.ce.InlineImageNode,ve.ce.LeafNode),OO.mixinClass(ve.ce.InlineImageNode,ve.ce.ImageNode),ve.ce.InlineImageNode["static"].name="inlineImage",ve.ce.InlineImageNode["static"].tagName="img",ve.ce.nodeFactory.register(ve.ce.InlineImageNode),ve.ce.LanguageAnnotation=function(){ve.ce.LanguageAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-languageAnnotation").addClass("ve-ce-bidi-isolate").prop({lang:this.model.getAttribute("lang")||void 0,dir:this.model.getAttribute("dir")||void 0,title:this.constructor["static"].getDescription(this.model)})},OO.inheritClass(ve.ce.LanguageAnnotation,ve.ce.Annotation),ve.ce.LanguageAnnotation["static"].name="meta/language",ve.ce.LanguageAnnotation["static"].tagName="span",ve.ce.LanguageAnnotation["static"].getDescription=function(a){var b=(a.getAttribute("lang")||"").toLowerCase(),c=ve.init.platform.getLanguageName(b),d=(a.getAttribute("dir")||"").toUpperCase();return d&&d!==ve.init.platform.getLanguageDirection(b).toUpperCase()?ve.msg("visualeditor-languageannotation-description-with-dir",c,d):ve.msg("visualeditor-languageannotation-description",c)},ve.ce.annotationFactory.register(ve.ce.LanguageAnnotation),ve.ce.LinkAnnotation=function(){ve.ce.LinkAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-linkAnnotation").prop({href:ve.resolveUrl(this.model.getHref(),this.getModelHtmlDocument()),title:this.constructor["static"].getDescription(this.model)})},OO.inheritClass(ve.ce.LinkAnnotation,ve.ce.Annotation),ve.ce.LinkAnnotation["static"].name="link",ve.ce.LinkAnnotation["static"].tagName="a",ve.ce.LinkAnnotation["static"].forceContinuation=!0,ve.ce.LinkAnnotation["static"].getDescription=function(a){return a.getHref()},ve.ce.annotationFactory.register(ve.ce.LinkAnnotation),ve.ce.TextStyleAnnotation=function(){ve.ce.TextStyleAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-textStyleAnnotation")},OO.inheritClass(ve.ce.TextStyleAnnotation,ve.ce.Annotation),ve.ce.TextStyleAnnotation["static"].name="textStyle",ve.ce.TextStyleAnnotation.prototype.getTagName=function(){return this.getModel().getAttribute("nodeName")||this.constructor["static"].tagName},ve.ce.annotationFactory.register(ve.ce.TextStyleAnnotation),ve.ce.AbbreviationAnnotation=function(){ve.ce.AbbreviationAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-abbreviationAnnotation")},OO.inheritClass(ve.ce.AbbreviationAnnotation,ve.ce.TextStyleAnnotation),ve.ce.AbbreviationAnnotation["static"].name="textStyle/abbreviation",ve.ce.AbbreviationAnnotation["static"].tagName="abbr",ve.ce.annotationFactory.register(ve.ce.AbbreviationAnnotation),ve.ce.BigAnnotation=function(){ve.ce.BigAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-bigAnnotation")},OO.inheritClass(ve.ce.BigAnnotation,ve.ce.TextStyleAnnotation),ve.ce.BigAnnotation["static"].name="textStyle/big",ve.ce.BigAnnotation["static"].tagName="big",ve.ce.annotationFactory.register(ve.ce.BigAnnotation),ve.ce.BoldAnnotation=function(){ve.ce.BoldAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-boldAnnotation")
},OO.inheritClass(ve.ce.BoldAnnotation,ve.ce.TextStyleAnnotation),ve.ce.BoldAnnotation["static"].name="textStyle/bold",ve.ce.BoldAnnotation["static"].tagName="b",ve.ce.annotationFactory.register(ve.ce.BoldAnnotation),ve.ce.CodeAnnotation=function(){ve.ce.CodeAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-codeAnnotation")},OO.inheritClass(ve.ce.CodeAnnotation,ve.ce.TextStyleAnnotation),ve.ce.CodeAnnotation["static"].name="textStyle/code",ve.ce.CodeAnnotation["static"].tagName="code",ve.ce.annotationFactory.register(ve.ce.CodeAnnotation),ve.ce.CodeSampleAnnotation=function(){ve.ce.CodeSampleAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-codeSampleAnnotation")},OO.inheritClass(ve.ce.CodeSampleAnnotation,ve.ce.TextStyleAnnotation),ve.ce.CodeSampleAnnotation["static"].name="textStyle/codeSample",ve.ce.CodeSampleAnnotation["static"].tagName="samp",ve.ce.annotationFactory.register(ve.ce.CodeSampleAnnotation),ve.ce.DatetimeAnnotation=function(){ve.ce.DatetimeAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-datetimeAnnotation")},OO.inheritClass(ve.ce.DatetimeAnnotation,ve.ce.TextStyleAnnotation),ve.ce.DatetimeAnnotation["static"].name="textStyle/datetime",ve.ce.DatetimeAnnotation["static"].tagName="time",ve.ce.annotationFactory.register(ve.ce.DatetimeAnnotation),ve.ce.DefinitionAnnotation=function(){ve.ce.DefinitionAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-definitionAnnotation")},OO.inheritClass(ve.ce.DefinitionAnnotation,ve.ce.TextStyleAnnotation),ve.ce.DefinitionAnnotation["static"].name="textStyle/definition",ve.ce.DefinitionAnnotation["static"].tagName="dfn",ve.ce.annotationFactory.register(ve.ce.DefinitionAnnotation),ve.ce.FontAnnotation=function(){ve.ce.FontAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-fontAnnotation")},OO.inheritClass(ve.ce.FontAnnotation,ve.ce.TextStyleAnnotation),ve.ce.FontAnnotation["static"].name="textStyle/font",ve.ce.FontAnnotation["static"].tagName="font",ve.ce.annotationFactory.register(ve.ce.FontAnnotation),ve.ce.HighlightAnnotation=function(){ve.ce.HighlightAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-highlightAnnotation")},OO.inheritClass(ve.ce.HighlightAnnotation,ve.ce.TextStyleAnnotation),ve.ce.HighlightAnnotation["static"].name="textStyle/highlight",ve.ce.HighlightAnnotation["static"].tagName="mark",ve.ce.annotationFactory.register(ve.ce.HighlightAnnotation),ve.ce.ItalicAnnotation=function(){ve.ce.ItalicAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-italicAnnotation")},OO.inheritClass(ve.ce.ItalicAnnotation,ve.ce.TextStyleAnnotation),ve.ce.ItalicAnnotation["static"].name="textStyle/italic",ve.ce.ItalicAnnotation["static"].tagName="i",ve.ce.annotationFactory.register(ve.ce.ItalicAnnotation),ve.ce.QuotationAnnotation=function(){ve.ce.QuotationAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-quotationAnnotation")},OO.inheritClass(ve.ce.QuotationAnnotation,ve.ce.TextStyleAnnotation),ve.ce.QuotationAnnotation["static"].name="textStyle/quotation",ve.ce.QuotationAnnotation["static"].tagName="q",ve.ce.annotationFactory.register(ve.ce.QuotationAnnotation),ve.ce.SmallAnnotation=function(){ve.ce.SmallAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-smallAnnotation")},OO.inheritClass(ve.ce.SmallAnnotation,ve.ce.TextStyleAnnotation),ve.ce.SmallAnnotation["static"].name="textStyle/small",ve.ce.SmallAnnotation["static"].tagName="small",ve.ce.annotationFactory.register(ve.ce.SmallAnnotation),ve.ce.SpanAnnotation=function(){ve.ce.SpanAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-spanAnnotation")},OO.inheritClass(ve.ce.SpanAnnotation,ve.ce.TextStyleAnnotation),ve.ce.SpanAnnotation["static"].name="textStyle/span",ve.ce.SpanAnnotation["static"].tagName="span",ve.ce.annotationFactory.register(ve.ce.SpanAnnotation),ve.ce.StrikethroughAnnotation=function(){ve.ce.StrikethroughAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-strikethroughAnnotation")},OO.inheritClass(ve.ce.StrikethroughAnnotation,ve.ce.TextStyleAnnotation),ve.ce.StrikethroughAnnotation["static"].name="textStyle/strikethrough",ve.ce.StrikethroughAnnotation["static"].tagName="s",ve.ce.annotationFactory.register(ve.ce.StrikethroughAnnotation),ve.ce.SubscriptAnnotation=function(){ve.ce.SubscriptAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-subscriptAnnotation")},OO.inheritClass(ve.ce.SubscriptAnnotation,ve.ce.TextStyleAnnotation),ve.ce.SubscriptAnnotation["static"].name="textStyle/subscript",ve.ce.SubscriptAnnotation["static"].tagName="sub",ve.ce.annotationFactory.register(ve.ce.SubscriptAnnotation),ve.ce.SuperscriptAnnotation=function(){ve.ce.SuperscriptAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-superscriptAnnotation")},OO.inheritClass(ve.ce.SuperscriptAnnotation,ve.ce.TextStyleAnnotation),ve.ce.SuperscriptAnnotation["static"].name="textStyle/superscript",ve.ce.SuperscriptAnnotation["static"].tagName="sup",ve.ce.annotationFactory.register(ve.ce.SuperscriptAnnotation),ve.ce.UnderlineAnnotation=function(){ve.ce.UnderlineAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-underlineAnnotation")},OO.inheritClass(ve.ce.UnderlineAnnotation,ve.ce.TextStyleAnnotation),ve.ce.UnderlineAnnotation["static"].name="textStyle/underline",ve.ce.UnderlineAnnotation["static"].tagName="u",ve.ce.annotationFactory.register(ve.ce.UnderlineAnnotation),ve.ce.UserInputAnnotation=function(){ve.ce.UserInputAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-userInputAnnotation")},OO.inheritClass(ve.ce.UserInputAnnotation,ve.ce.TextStyleAnnotation),ve.ce.UserInputAnnotation["static"].name="textStyle/userInput",ve.ce.UserInputAnnotation["static"].tagName="kbd",ve.ce.annotationFactory.register(ve.ce.UserInputAnnotation),ve.ce.VariableAnnotation=function(){ve.ce.VariableAnnotation["super"].apply(this,arguments),this.$element.addClass("ve-ce-variableAnnotation")},OO.inheritClass(ve.ce.VariableAnnotation,ve.ce.TextStyleAnnotation),ve.ce.VariableAnnotation["static"].name="textStyle/variable",ve.ce.VariableAnnotation["static"].tagName="var",ve.ce.annotationFactory.register(ve.ce.VariableAnnotation),ve.ui={windowFactory:new OO.Factory},ve.ui.windowFactory.register(OO.ui.MessageDialog),ve.ui.Overlay=function(a){OO.ui.Element.call(this,a),this.$element.addClass("ve-ui-overlay")},OO.inheritClass(ve.ui.Overlay,OO.ui.Element),ve.ui.Surface=function(a,b){b=b||{};var c;OO.ui.Element.call(this,b),OO.EventEmitter.call(this,b),this.inDialog=b.inDialog||"",this.globalOverlay=new ve.ui.Overlay({classes:["ve-ui-overlay-global"]}),this.localOverlay=new ve.ui.Overlay({classes:["ve-ui-overlay-local"]}),this.$selections=$("<div>"),this.$blockers=$("<div>"),this.$controls=$("<div>"),this.$menus=$("<div>"),this.triggerListener=new ve.TriggerListener(OO.simpleArrayDifference(Object.keys(ve.ui.commandRegistry.registry),b.excludeCommands||[])),this.model=a,c=a.getDocument(),this.view=new ve.ce.Surface(this.model,this,{$:this.$}),this.dialogs=this.createDialogWindowManager(),this.importRules=b.importRules||{external:{blacklist:[]},all:null},this.enabled=!0,this.context=this.createContext(),this.progresses=[],this.showProgressDebounced=ve.debounce(this.showProgress.bind(this)),this.filibuster=null,this.debugBar=null,this.toolbarHeight=0,this.toolbarDialogs=new ve.ui.ToolbarDialogWindowManager(this,{factory:ve.ui.windowFactory,modal:!1}),this.$menus.append(this.context.$element),this.$element.addClass("ve-ui-surface").append(this.view.$element),this.view.$element.after(this.localOverlay.$element),this.localOverlay.$element.append(this.$selections,this.$blockers,this.$controls,this.$menus),this.globalOverlay.$element.append(this.dialogs.$element)},OO.inheritClass(ve.ui.Surface,OO.ui.Element),OO.mixinClass(ve.ui.Surface,OO.EventEmitter),ve.ui.Surface.prototype.destroy=function(){this.model.stopHistoryTracking(),this.view.destroy(),this.context.destroy(),this.dialogs.destroy(),this.toolbarDialogs.destroy(),this.debugBar&&this.debugBar.destroy(),this.$element.remove(),this.globalOverlay.$element.remove(),this.emit("destroy")},ve.ui.Surface.prototype.initialize=function(){$("body").append(this.globalOverlay.$element),ve.debug&&this.setupDebugBar(),this.$element.addClass("ve-ui-surface-dir-"+this.getDir()),this.getView().initialize(),this.getModel().initialize()},ve.ui.Surface.prototype.getDom=function(){return ve.dm.converter.getDomFromModel(this.getModel().getDocument())},ve.ui.Surface.prototype.getHtml=function(){return ve.properInnerHtml(this.getDom().body)},ve.ui.Surface.prototype.createContext=null,ve.ui.Surface.prototype.createDialogWindowManager=null,ve.ui.Surface.prototype.setupDebugBar=function(){this.debugBar=new ve.ui.DebugBar(this),this.debugBar.$element.insertAfter(this.$element)},ve.ui.Surface.prototype.getBoundingClientRect=function(){return this.$element[0].getClientRects()[0]},ve.ui.Surface.prototype.isEnabled=function(){return this.enabled},ve.ui.Surface.prototype.getModel=function(){return this.model},ve.ui.Surface.prototype.getView=function(){return this.view},ve.ui.Surface.prototype.getContext=function(){return this.context},ve.ui.Surface.prototype.getDialogs=function(){return this.dialogs},ve.ui.Surface.prototype.getToolbarDialogs=function(){return this.toolbarDialogs},ve.ui.Surface.prototype.getLocalOverlay=function(){return this.localOverlay},ve.ui.Surface.prototype.getGlobalOverlay=function(){return this.globalOverlay},ve.ui.Surface.prototype.disable=function(){this.view.disable(),this.model.disable(),this.enabled=!1},ve.ui.Surface.prototype.enable=function(){this.enabled=!0,this.view.enable(),this.model.enable()},ve.ui.Surface.prototype.execute=function(a,b){var c,d,e;if(this.enabled){if(a instanceof ve.ui.Trigger){if(c=this.triggerListener.getCommandByTrigger(a.toString()))return c.execute(this)}else if("string"==typeof a&&"string"==typeof b&&ve.ui.actionFactory.doesActionSupportMethod(a,b))return d=ve.ui.actionFactory.create(a,this),e=d[b].apply(d,Array.prototype.slice.call(arguments,2)),void 0===e||!!e;return!1}},ve.ui.Surface.prototype.setToolbarHeight=function(a){this.toolbarHeight=a},ve.ui.Surface.prototype.createProgress=function(a,b){var c=$.Deferred();return this.progresses.push({label:b,progressCompletePromise:a,progressBarDeferred:c}),this.showProgressDebounced(),c.promise()},ve.ui.Surface.prototype.showProgress=function(){var a=this.dialogs,b=this.progresses;a.openWindow("progress",{progresses:b}),this.progresses=[]},ve.ui.Surface.prototype.getImportRules=function(){return this.importRules},ve.ui.Surface.prototype.getDir=function(){return this.$element.css("direction")},ve.ui.Surface.prototype.initFilibuster=function(){var a=this;this.filibuster=(new ve.Filibuster).wrapClass(ve.EventSequencer).wrapNamespace(ve.dm,"ve.dm",[ve.dm.LinearSelection.prototype.getDescription,ve.dm.TableSelection.prototype.getDescription,ve.dm.NullSelection.prototype.getDescription]).wrapNamespace(ve.ce,"ve.ce").wrapNamespace(ve.ui,"ve.ui",[ve.ui.Surface.prototype.startFilibuster,ve.ui.Surface.prototype.stopFilibuster]).setObserver("dm doc",function(){return JSON.stringify(ve.Filibuster["static"].clonePlain(a.model.documentModel.data.data))}).setObserver("dm selection",function(){var b=a.model.selection;return b?b.getDescription():null}).setObserver("DOM doc",function(){return ve.serializeNodeDebug(a.view.$element[0])}).setObserver("DOM selection",function(){var b,c=a.view.nativeSelection;return 0===c.rangeCount?null:(b=c.getRangeAt(0),JSON.stringify({startContainer:ve.serializeNodeDebug(b.startContainer),startOffset:b.startOffset,endContainer:b.startContainer===b.endContainer?"(=startContainer)":ve.serializeNodeDebug(b.endContainer),endOffset:b.endOffset}))})},ve.ui.Surface.prototype.startFilibuster=function(){this.filibuster?this.filibuster.clearLogs():this.initFilibuster(),this.filibuster.start()},ve.ui.Surface.prototype.stopFilibuster=function(){this.filibuster.stop()},ve.ui.Surface.prototype.getInDialog=function(){return this.inDialog},ve.ui.Context=function(a,b){ve.ui.Context["super"].call(this,b),OO.ui.mixin.GroupElement.call(this,b),this.surface=a,this.visible=!1,this.choosing=!1,this.$group.addClass("ve-ui-context-menu"),this.$element.addClass("ve-ui-context oo-ui-element-hidden").append(this.$group)},OO.inheritClass(ve.ui.Context,OO.ui.Element),OO.mixinClass(ve.ui.Context,OO.ui.mixin.GroupElement),ve.ui.Context["static"].basicRendering=!1,ve.ui.Context.prototype.shouldUseBasicRendering=function(){return this.constructor["static"].basicRendering},ve.ui.Context.prototype.isVisible=function(){return this.visible},ve.ui.Context.prototype.getRelatedSources=null,ve.ui.Context.prototype.getSurface=function(){return this.surface},ve.ui.Context.prototype.toggleMenu=function(a){return a=void 0===a?!this.choosing:!!a,a!==this.choosing&&(this.choosing=a,this.$element.toggleClass("ve-ui-context-choosing",a),a?this.setupMenuItems():this.teardownMenuItems()),this},ve.ui.Context.prototype.setupMenuItems=function(){var a,b,c,d=this.getRelatedSources(),e=[];for(a=0,b=d.length;b>a;a++)c=d[a],"item"===c.type?e.push(ve.ui.contextItemFactory.create(d[a].name,this,d[a].model)):"tool"===c.type&&e.push(new ve.ui.ToolContextItem(this,d[a].model,ve.ui.toolFactory.lookup(d[a].name)));for(this.addItems(e),a=0,b=e.length;b>a;a++)e[a].connect(this,{command:"onContextItemCommand"}),e[a].setup();return this},ve.ui.Context.prototype.teardownMenuItems=function(){var a,b;for(a=0,b=this.items.length;b>a;a++)this.items[a].teardown();return this.clearItems(),this},ve.ui.Context.prototype.onContextItemCommand=function(){},ve.ui.Context.prototype.toggle=function(a){return a=void 0===a?!this.visible:!!a,a!==this.visible&&(this.visible=a,this.$element.toggleClass("oo-ui-element-hidden",!this.visible)),$.Deferred().resolve().promise()},ve.ui.Context.prototype.updateDimensions=function(){return this},ve.ui.Context.prototype.destroy=function(){return this.surface.getModel().disconnect(this),this.$element.remove(),this},ve.ui.LinearContext=function(){ve.ui.LinearContext["super"].apply(this,arguments),this.inspector=null,this.inspectors=this.createInspectorWindowManager(),this.lastSelectedNode=null,this.afterContextChangeTimeout=null,this.afterContextChangeHandler=this.afterContextChange.bind(this),this.updateDimensionsDebounced=ve.debounce(this.updateDimensions.bind(this)),this.surface.getModel().connect(this,{contextChange:"onContextChange",documentUpdate:"onDocumentUpdate"}),this.inspectors.connect(this,{opening:"onInspectorOpening"})},OO.inheritClass(ve.ui.LinearContext,ve.ui.Context),ve.ui.LinearContext["static"].basicRendering=!1,ve.ui.LinearContext.prototype.shouldUseBasicRendering=function(){return this.constructor["static"].basicRendering},ve.ui.LinearContext.prototype.onContextChange=function(){this.inspector&&(this.inspector.isOpening()||this.inspector.isClosing())?(clearTimeout(this.afterContextChangeTimeout),this.afterContextChangeTimeout=null,this.lastSelectedNode=this.surface.getModel().getSelectedNode()):null===this.afterContextChangeTimeout&&(this.afterContextChangeTimeout=setTimeout(this.afterContextChangeHandler)),this.relatedSources=null},ve.ui.LinearContext.prototype.onDocumentUpdate=function(){this.isVisible()&&!this.isEmpty()&&this.onContextChange()},ve.ui.LinearContext.prototype.afterContextChange=function(){var a=this.surface.getModel().getSelectedNode();this.afterContextChangeTimeout=null,this.isVisible()?this.isEmpty()?!this.inspector||a&&a===this.lastSelectedNode||this.inspector.close():this.isInspectable()?(this.teardownMenuItems(),this.setupMenuItems(),this.updateDimensionsDebounced()):(this.toggleMenu(!1),this.toggle(!1)):this.isInspectable()&&(this.toggleMenu(!0),this.toggle(!0)),this.lastSelectedNode=a},ve.ui.LinearContext.prototype.onInspectorOpening=function(a,b){var c=this,d=this.surface.getView().surfaceObserver;this.inspector=a,d.pollOnce(),d.stopTimerLoop(),b.progress(function(a){"setup"===a.state&&(c.isVisible()||c.toggle(!0),c.isEmpty()||c.toggleMenu(!1)),c.updateDimensionsDebounced()}).always(function(a){a.always(function(a){a.always(function(){var a=c.isInspectable();c.inspector=null,d.startTimerLoop(),a?(c.toggleMenu(!0),c.updateDimensionsDebounced()):c.toggle(!1),c.getSurface().getModel().getSelection()&&c.getSurface().getView().focus()})})})},ve.ui.LinearContext.prototype.isVisible=function(){return this.visible},ve.ui.LinearContext.prototype.isInspectable=function(){return!!this.getRelatedSources().length},ve.ui.LinearContext.prototype.getRelatedSources=function(){var a,b,c,d,e,f,g;if(!this.relatedSources&&(this.relatedSources=[],this.surface.getModel().getSelection()instanceof ve.dm.LinearSelection)){for(g=this.surface.getModel().getFragment().getSelectedModels(),f=[],d=ve.ui.contextItemFactory.getRelatedItems(g),a=0,b=d.length;b>a;a++)ve.ui.contextItemFactory.isExclusive(d[a].name)&&f.push(d[a].model),this.relatedSources.push({type:"item",embeddable:ve.ui.contextItemFactory.isEmbeddable(d[a].name),name:d[a].name,model:d[a].model});for(e=ve.ui.toolFactory.getRelatedItems(g),a=0,b=e.length;b>a;a++)-1===f.indexOf(e[a].model)&&(c=ve.ui.toolFactory.lookup(e[a].name),this.relatedSources.push({type:"tool",embeddable:!(c&&c.prototype instanceof ve.ui.InspectorTool),name:e[a].name,model:e[a].model}))}return this.relatedSources},ve.ui.LinearContext.prototype.getInspectors=function(){return this.inspectors},ve.ui.LinearContext.prototype.createInspectorWindowManager=null,ve.ui.LinearContext.prototype.destroy=function(){return this.inspectors.disconnect(this),this.inspectors.destroy(),clearTimeout(this.afterContextChangeTimeout),ve.ui.LinearContext["super"].prototype.destroy.call(this)},ve.ui.TableContext=function(a,b,c){c=c||{},ve.ui.TableContext["super"].call(this,a.surface.getSurface(),c),this.tableNode=a,this.itemGroup=b,this.indicator=new OO.ui.IndicatorWidget({classes:["ve-ui-tableContext-indicator"],indicator:c.indicator}),this.popup=new OO.ui.PopupWidget({classes:["ve-ui-tableContext-menu"],$container:this.surface.$element,width:150}),this.indicator.$element.on("mousedown",this.onIndicatorMouseDown.bind(this)),this.onDocumentMouseDownHandler=this.onDocumentMouseDown.bind(this),this.popup.$body.append(this.$group),this.$element.addClass("ve-ui-tableContext").append(this.indicator.$element,this.popup.$element),this.toggle(!0)},OO.inheritClass(ve.ui.TableContext,ve.ui.Context),ve.ui.TableContext["static"].basicRendering=!0,ve.ui.TableContext["static"].groups={col:["insertColumnBefore","insertColumnAfter","deleteColumn"],row:["insertRowBefore","insertRowAfter","deleteRow"]},ve.ui.TableContext.prototype.getRelatedSources=function(){var a,b,c=this.constructor["static"].groups[this.itemGroup];if(!this.relatedSources)for(this.relatedSources=[],a=0,b=c.length;b>a;a++)this.relatedSources.push({type:"item",name:c[a]});return this.relatedSources},ve.ui.TableContext.prototype.onContextItemCommand=function(){this.toggleMenu(!1)},ve.ui.TableContext.prototype.onIndicatorMouseDown=function(a){a.preventDefault(),this.toggleMenu()},ve.ui.TableContext.prototype.onDocumentMouseDown=function(a){$(a.target).closest(this.$element).length||this.toggleMenu(!1)},ve.ui.TableContext.prototype.toggleMenu=function(a){ve.ui.TableContext["super"].prototype.toggleMenu.call(this,a);var b,c=this.surface.getModel(),d=this.surface.getView();this.popup.toggle(a),this.popup.isVisible()?(this.tableNode.setEditing(!1),c.connect(this,{select:"toggleMenu"}),d.$document.on("mousedown",this.onDocumentMouseDownHandler),b=d.getDocument().getDirectionFromSelection(c.getSelection())||c.getDocument().getDir(),this.$element.removeClass("ve-ui-dir-block-rtl ve-ui-dir-block-ltr").addClass("ve-ui-dir-block-"+b)):(c.disconnect(this),d.$document.off("mousedown",this.onDocumentMouseDownHandler))},ve.ui.ModeledFactory=function(){},OO.initClass(ve.ui.ModeledFactory),ve.ui.ModeledFactory.prototype.getRelatedItems=function(a){function b(a){var b,c,d,e,f,g=[];for(d in j)if(e=j[d],e["static"].isCompatibleWith(a)){for(f=!0,b=0,c=g.length;c>b;b++){if(e.prototype instanceof g[b]){g.splice(b,1,e),f=!1;break}if(g[b].prototype instanceof e){f=!1;break}}f&&g.push(e)}return g}var c,d,e,f,g,h,i,j=this.registry,k={},l=[];for(c=0,d=a.length;d>c;c++)for(i=a[c],h=b(i),e=0,f=h.length;f>e;e++)g=h[e]["static"].name,k[g]||l.push({name:g,model:i}),k[g]=!0;return l},ve.ui.ContextItem=function(a,b,c){ve.ui.ContextItem["super"].call(this,c),OO.ui.mixin.IconElement.call(this,c),OO.ui.mixin.LabelElement.call(this,c),OO.ui.mixin.PendingElement.call(this,c),this.context=a,this.model=b,this.$head=$("<div>"),this.$title=$("<div>"),this.$actions=$("<div>"),this.$body=$("<div>"),this.$info=$("<div>"),this.$description=$("<div>"),this.editButton=new OO.ui.ButtonWidget({label:ve.msg("visualeditor-contextitemwidget-label-secondary"),flags:["progressive"],classes:["ve-ui-contextItem-editButton"]}),this.fragment=null,this.editButton.connect(this,{click:"onEditButtonClick"}),this.$element.on("mousedown",!1),this.$label.addClass("ve-ui-contextItem-label"),this.$icon.addClass("ve-ui-contextItem-icon"),this.$description.addClass("ve-ui-contextItem-description"),this.$info.addClass("ve-ui-contextItem-info").append(this.$description),this.$title.addClass("ve-ui-contextItem-title").append(this.$icon,this.$label),this.$actions.addClass("ve-ui-contextItem-actions").append(this.editButton.$element),this.$head.addClass("ve-ui-contextItem-head").append(this.$title,this.$info,this.$actions),this.$body.addClass("ve-ui-contextItem-body"),this.$element.addClass("ve-ui-contextItem").toggleClass("ve-ui-contextItem-basic",this.context.shouldUseBasicRendering()).append(this.$head,this.$body)},OO.inheritClass(ve.ui.ContextItem,OO.ui.Widget),OO.mixinClass(ve.ui.ContextItem,OO.ui.mixin.IconElement),OO.mixinClass(ve.ui.ContextItem,OO.ui.mixin.LabelElement),OO.mixinClass(ve.ui.ContextItem,OO.ui.mixin.PendingElement),ve.ui.ContextItem["static"].editable=!0,ve.ui.ContextItem["static"].embeddable=!0,ve.ui.ContextItem["static"].exclusive=!0,ve.ui.ContextItem["static"].commandName=null,ve.ui.ContextItem["static"].modelClasses=[],ve.ui.ContextItem.prototype.onEditButtonClick=function(){var a=this.getCommand();a&&(a.execute(this.context.getSurface()),this.emit("command"))},ve.ui.ContextItem["static"].isCompatibleWith=function(a){return ve.isInstanceOfAny(a,this.modelClasses)},ve.ui.ContextItem.prototype.isEditable=function(){return this.constructor["static"].editable},ve.ui.ContextItem.prototype.getCommand=function(){return ve.ui.commandRegistry.lookup(this.constructor["static"].commandName)},ve.ui.ContextItem.prototype.getFragment=function(){return this.fragment||(this.fragment=this.context.getSurface().getModel().getLinearFragment(this.model.getOuterRange())),this.fragment},ve.ui.ContextItem.prototype.getDescription=function(){return""},ve.ui.ContextItem.prototype.renderBody=function(){this.$body.text(this.getDescription())},ve.ui.ContextItem.prototype.renderDescription=function(){this.$description.text(this.getDescription())},ve.ui.ContextItem.prototype.setup=function(){return this.editButton.toggle(this.isEditable()),this.context.shouldUseBasicRendering()?this.renderDescription():this.renderBody(),this},ve.ui.ContextItem.prototype.teardown=function(){return this.$description.empty(),this.$body.empty(),this},ve.ui.ContextItemFactory=function(){ve.ui.ContextItemFactory["super"].call(this),ve.ui.ModeledFactory.call(this)},OO.inheritClass(ve.ui.ContextItemFactory,OO.Factory),OO.mixinClass(ve.ui.ContextItemFactory,ve.ui.ModeledFactory),ve.ui.ContextItemFactory.prototype.isEmbeddable=function(a){if(Object.prototype.hasOwnProperty.call(this.registry,a))return!!this.registry[a]["static"].embeddable;throw new Error("Unrecognized symbolic name: "+a)},ve.ui.ContextItemFactory.prototype.isExclusive=function(a){if(Object.prototype.hasOwnProperty.call(this.registry,a))return!!this.registry[a]["static"].exclusive;throw new Error("Unrecognized symbolic name: "+a)},ve.ui.contextItemFactory=new ve.ui.ContextItemFactory,ve.ui.AlignableContextItem=function(a,b,c){ve.ui.AlignableContextItem["super"].call(this,a,b,c);var d=b.getAttribute("align");this.align=new ve.ui.AlignWidget({dir:this.context.getSurface().getDir()}),this.align.selectItemByData(d),this.align.connect(this,{choose:"onAlignChoose"}),this.$element.addClass("ve-ui-alignableContextItem")},OO.inheritClass(ve.ui.AlignableContextItem,ve.ui.ContextItem),ve.ui.AlignableContextItem["static"].name="alignable",ve.ui.AlignableContextItem["static"].icon="align-float-left",ve.ui.AlignableContextItem["static"].label=OO.ui.deferMsg("visualeditor-alignablecontextitem-title"),ve.ui.AlignableContextItem["static"].editable=!1,ve.ui.AlignableContextItem["static"].exclusive=!1,ve.ui.AlignableContextItem["static"].isCompatibleWith=function(a){return a instanceof ve.dm.Node&&a.isAlignable()},ve.ui.AlignableContextItem.prototype.renderBody=function(){this.$body.empty().append(this.align.$element)},ve.ui.AlignableContextItem.prototype.renderDescription=function(){this.$description.empty().append(this.align.$element)},ve.ui.AlignableContextItem.prototype.onAlignChoose=function(a){this.getFragment().changeAttributes({align:a.getData()})},ve.ui.contextItemFactory.register(ve.ui.AlignableContextItem),ve.ui.CommentContextItem=function(a,b,c){ve.ui.CommentContextItem["super"].call(this,a,b,c),this.$element.addClass("ve-ui-commentContextItem")},OO.inheritClass(ve.ui.CommentContextItem,ve.ui.ContextItem),ve.ui.CommentContextItem["static"].name="comment",ve.ui.CommentContextItem["static"].icon="comment",ve.ui.CommentContextItem["static"].label=OO.ui.deferMsg("visualeditor-commentinspector-title"),ve.ui.CommentContextItem["static"].modelClasses=[ve.dm.CommentNode],ve.ui.CommentContextItem["static"].embeddable=!1,ve.ui.CommentContextItem["static"].commandName="comment",ve.ui.CommentContextItem.prototype.getDescription=function(){return this.model.getAttribute("text").trim()},ve.ui.contextItemFactory.register(ve.ui.CommentContextItem),ve.ui.LanguageContextItem=function(a,b,c){ve.ui.LanguageContextItem["super"].call(this,a,b,c),this.$element.addClass("ve-ui-languageContextItem")},OO.inheritClass(ve.ui.LanguageContextItem,ve.ui.ContextItem),ve.ui.LanguageContextItem["static"].name="language",ve.ui.LanguageContextItem["static"].icon="textLanguage",ve.ui.LanguageContextItem["static"].label=OO.ui.deferMsg("visualeditor-languageinspector-title"),ve.ui.LanguageContextItem["static"].modelClasses=[ve.dm.LanguageAnnotation],ve.ui.LanguageContextItem["static"].embeddable=!1,ve.ui.LanguageContextItem["static"].commandName="language",ve.ui.LanguageContextItem.prototype.getDescription=function(){return ve.ce.LanguageAnnotation["static"].getDescription(this.model)},ve.ui.contextItemFactory.register(ve.ui.LanguageContextItem),ve.ui.LinkContextItem=function(a,b,c){ve.ui.LinkContextItem["super"].call(this,a,b,c),this.$element.addClass("ve-ui-linkContextItem")},OO.inheritClass(ve.ui.LinkContextItem,ve.ui.ContextItem),ve.ui.LinkContextItem["static"].name="link",ve.ui.LinkContextItem["static"].icon="link",ve.ui.LinkContextItem["static"].label=OO.ui.deferMsg("visualeditor-linkinspector-title"),ve.ui.LinkContextItem["static"].modelClasses=[ve.dm.LinkAnnotation],ve.ui.LinkContextItem["static"].embeddable=!1,ve.ui.LinkContextItem["static"].commandName="link",ve.ui.LinkContextItem.prototype.getDescription=function(){return this.model.getHref()},ve.ui.LinkContextItem.prototype.renderBody=function(){var a=this.context.getSurface().getModel().getDocument().getHtmlDocument();this.$body.empty().append($("<a>").text(this.getDescription()).attr({href:ve.resolveUrl(this.model.getHref(),a),target:"_blank"}))},ve.ui.contextItemFactory.register(ve.ui.LinkContextItem),ve.ui.ToolContextItem=function(a,b,c,d){ve.ui.ToolContextItem["super"].call(this,a,b,d),this.tool=c,this.setIcon(c["static"].icon),this.setLabel(c["static"].title),this.$element.addClass("ve-ui-toolContextItem")},OO.inheritClass(ve.ui.ToolContextItem,ve.ui.ContextItem),ve.ui.ToolContextItem.prototype.getCommand=function(){return ve.ui.commandRegistry.lookup(this.tool["static"].commandName)},ve.ui.ToolContextItem.prototype.getDescription=function(){var a="";return this.model instanceof ve.dm.Annotation?a=ve.ce.annotationFactory.getDescription(this.model):this.model instanceof ve.dm.Node&&(a=ve.ce.nodeFactory.getDescription(this.model)),a},ve.ui.TableContextItem=function(){ve.ui.TableContextItem["super"].apply(this,arguments),this.$title.remove(),this.$info.remove(),this.editButton.toggleFramed(!1).clearFlags(),this.$element.addClass("ve-ui-tableContextItem")},OO.inheritClass(ve.ui.TableContextItem,ve.ui.ContextItem),ve.ui.TableContextItem["static"].name="table",ve.ui.TableContextItem["static"].title=null,ve.ui.TableContextItem.prototype.getTitle=function(){return this.constructor["static"].title},ve.ui.TableContextItem.prototype.setup=function(){ve.ui.TableContextItem["super"].prototype.setup.call(this),this.editButton.setIcon(this.constructor["static"].icon).setLabel(this.getTitle())},ve.ui.InsertColumnBeforeContextItem=function(){ve.ui.InsertColumnBeforeContextItem["super"].apply(this,arguments)},OO.inheritClass(ve.ui.InsertColumnBeforeContextItem,ve.ui.TableContextItem),ve.ui.InsertColumnBeforeContextItem["static"].name="insertColumnBefore",ve.ui.InsertColumnBeforeContextItem["static"].group="table-col",ve.ui.InsertColumnBeforeContextItem["static"].icon="tableAddColumnBefore",ve.ui.InsertColumnBeforeContextItem["static"].title=OO.ui.deferMsg("visualeditor-table-insert-col-before"),ve.ui.InsertColumnBeforeContextItem["static"].commandName="insertColumnBefore",ve.ui.contextItemFactory.register(ve.ui.InsertColumnBeforeContextItem),ve.ui.InsertColumnAfterContextItem=function(){ve.ui.InsertColumnAfterContextItem["super"].apply(this,arguments)},OO.inheritClass(ve.ui.InsertColumnAfterContextItem,ve.ui.TableContextItem),ve.ui.InsertColumnAfterContextItem["static"].name="insertColumnAfter",ve.ui.InsertColumnAfterContextItem["static"].group="table-col",ve.ui.InsertColumnAfterContextItem["static"].icon="tableAddColumnAfter",ve.ui.InsertColumnAfterContextItem["static"].title=OO.ui.deferMsg("visualeditor-table-insert-col-after"),ve.ui.InsertColumnAfterContextItem["static"].commandName="insertColumnAfter",ve.ui.contextItemFactory.register(ve.ui.InsertColumnAfterContextItem),ve.ui.DeleteColumnContextItem=function(){ve.ui.DeleteColumnContextItem["super"].apply(this,arguments)},OO.inheritClass(ve.ui.DeleteColumnContextItem,ve.ui.TableContextItem),ve.ui.DeleteColumnContextItem["static"].name="deleteColumn",ve.ui.DeleteColumnContextItem["static"].group="table-col",ve.ui.DeleteColumnContextItem["static"].icon="remove",ve.ui.DeleteColumnContextItem["static"].commandName="deleteColumn",ve.ui.DeleteColumnContextItem.prototype.getTitle=function(){var a=this.context.getSurface().getModel().getSelection(),b=a instanceof ve.dm.TableSelection?a.getColCount():0;return ve.msg("visualeditor-table-delete-col",b)},ve.ui.contextItemFactory.register(ve.ui.DeleteColumnContextItem),ve.ui.InsertRowBeforeContextItem=function(){ve.ui.InsertRowBeforeContextItem["super"].apply(this,arguments)},OO.inheritClass(ve.ui.InsertRowBeforeContextItem,ve.ui.TableContextItem),ve.ui.InsertRowBeforeContextItem["static"].name="insertRowBefore",ve.ui.InsertRowBeforeContextItem["static"].group="table-row",ve.ui.InsertRowBeforeContextItem["static"].icon="tableAddRowBefore",ve.ui.InsertRowBeforeContextItem["static"].title=OO.ui.deferMsg("visualeditor-table-insert-row-before"),ve.ui.InsertRowBeforeContextItem["static"].commandName="insertRowBefore",ve.ui.contextItemFactory.register(ve.ui.InsertRowBeforeContextItem),ve.ui.InsertRowAfterContextItem=function(){ve.ui.InsertRowAfterContextItem["super"].apply(this,arguments)},OO.inheritClass(ve.ui.InsertRowAfterContextItem,ve.ui.TableContextItem),ve.ui.InsertRowAfterContextItem["static"].name="insertRowAfter",ve.ui.InsertRowAfterContextItem["static"].group="table-row",ve.ui.InsertRowAfterContextItem["static"].icon="tableAddRowAfter",ve.ui.InsertRowAfterContextItem["static"].title=OO.ui.deferMsg("visualeditor-table-insert-row-after"),ve.ui.InsertRowAfterContextItem["static"].commandName="insertRowAfter",ve.ui.contextItemFactory.register(ve.ui.InsertRowAfterContextItem),ve.ui.DeleteRowContextItem=function(){ve.ui.DeleteRowContextItem["super"].apply(this,arguments)
},OO.inheritClass(ve.ui.DeleteRowContextItem,ve.ui.TableContextItem),ve.ui.DeleteRowContextItem["static"].name="deleteRow",ve.ui.DeleteRowContextItem["static"].group="table-row",ve.ui.DeleteRowContextItem["static"].icon="remove",ve.ui.DeleteRowContextItem["static"].commandName="deleteRow",ve.ui.DeleteRowContextItem.prototype.getTitle=function(){var a=this.context.getSurface().getModel().getSelection(),b=a instanceof ve.dm.TableSelection?a.getRowCount():0;return ve.msg("visualeditor-table-delete-row",b)},ve.ui.contextItemFactory.register(ve.ui.DeleteRowContextItem),ve.ui.Tool=function(a,b){OO.ui.Tool.call(this,a,b),this.setDisabled(!0)},OO.inheritClass(ve.ui.Tool,OO.ui.Tool),ve.ui.Tool["static"].commandName=null,ve.ui.Tool["static"].deactivateOnSelect=!0,ve.ui.Tool["static"].getCommandName=function(){return this.commandName},ve.ui.Tool.prototype.onUpdateState=function(a){var b=this.getCommand();null!==b&&this.setDisabled(!b||!a||!b.isExecutable(a))},ve.ui.Tool.prototype.onSelect=function(){var a=this.getCommand();a instanceof ve.ui.Command&&a.execute(this.toolbar.getSurface()),this.constructor["static"].deactivateOnSelect&&this.setActive(!1)},ve.ui.Tool.prototype.getCommand=function(){return null===this.constructor["static"].commandName?null:ve.ui.commandRegistry.lookup(this.constructor["static"].commandName)},ve.ui.Toolbar=function(a){a=a||{},OO.ui.Toolbar.call(this,ve.ui.toolFactory,ve.ui.toolGroupFactory,a),this.floating=!1,this.floatable=!!a.floatable,this.$window=$(this.getElementWindow()),this.elementOffset=null,this.scrollOffset=a.scrollOffset||0,this.windowEvents={scroll:this.onWindowScroll.bind(this)},this.contextDirection={inline:"ltr",block:"ltr"},this.$element.addClass("ve-ui-toolbar").addClass("ve-ui-dir-inline-"+this.contextDirection.inline).addClass("ve-ui-dir-block-"+this.contextDirection.block)},OO.inheritClass(ve.ui.Toolbar,OO.ui.Toolbar),ve.ui.Toolbar.prototype.setup=function(a,b){this.detach(),this.surface=b,ve.ui.Toolbar["super"].prototype.setup.call(this,a),this.getSurface().getModel().connect(this,{contextChange:"onContextChange"}),this.getSurface().getToolbarDialogs().connect(this,{opening:"onToolbarDialogsOpeningOrClosing",closing:"onToolbarDialogsOpeningOrClosing"})},ve.ui.Toolbar.prototype.isToolAvailable=function(a){if(!ve.ui.Toolbar["super"].prototype.isToolAvailable.apply(this,arguments))return!1;var b,c=this.getToolFactory().lookup(a);return c?(b=c["static"].commandName,!b||-1!==this.getCommands().indexOf(b)):!1},ve.ui.Toolbar.prototype.onWindowScroll=function(){var a=this.$window.scrollTop();a+this.scrollOffset>this.elementOffset.top?this["float"]():this.floating&&this.unfloat()},ve.ui.Toolbar.prototype.onWindowResize=function(){ve.ui.Toolbar["super"].prototype.onWindowResize.call(this),this.calculateOffset(),this.floating&&this.$bar.css({left:this.elementOffset.left,right:this.elementOffset.right})},ve.ui.Toolbar.prototype.onToolbarDialogsOpeningOrClosing=function(a,b){var c=this;b.then(function(){c.updateToolState(),setTimeout(function(){c.floating&&(c.unfloat(),c["float"]())},250)})},ve.ui.Toolbar.prototype.onContextChange=function(){this.updateToolState()},ve.ui.Toolbar.prototype.updateToolState=function(){if(!this.getSurface())return void this.emit("updateState",null,null);var a,b,c,d=this.getSurface().getModel().getFragment();a=b=this.surface.getView().documentView.getDirectionFromSelection(d.getSelection())||d.getDocument().getDir(),c=d.getAnnotations(),c.hasAnnotationWithName("meta/language")&&(a=c.getAnnotationsByName("meta/language").get(0).getAttribute("dir")),a!==this.contextDirection.inline&&(this.$element.removeClass("ve-ui-dir-inline-rtl ve-ui-dir-inline-ltr"),this.$element.addClass("ve-ui-dir-inline-"+a),this.contextDirection.inline=a),b!==this.contextDirection.block&&(this.$element.removeClass("ve-ui-dir-block-rtl ve-ui-dir-block-ltr"),this.$element.addClass("ve-ui-dir-block-"+b),this.contextDirection.block=b),this.emit("updateState",d,this.contextDirection)},ve.ui.Toolbar.prototype.getTriggers=function(a){return this.getSurface().triggerListener.getTriggers(a)},ve.ui.Toolbar.prototype.getCommands=function(){return this.getSurface().triggerListener.getCommands()},ve.ui.Toolbar.prototype.getToolAccelerator=function(a){var b=ve.ui.triggerRegistry.getMessages(a);return b?b.join(", "):void 0},ve.ui.Toolbar.prototype.getSurface=function(){return this.surface},ve.ui.Toolbar.prototype.initialize=function(){OO.ui.Toolbar.prototype.initialize.call(this),this.floatable&&(this.$window.on(this.windowEvents),this.onWindowScroll())},ve.ui.Toolbar.prototype.calculateOffset=function(){this.elementOffset=this.$element.offset(),this.elementOffset.right=this.$window.width()-this.$element.outerWidth()-this.elementOffset.left},ve.ui.Toolbar.prototype.detach=function(){this.unfloat(),this.getSurface()&&(this.getSurface().getModel().disconnect(this),this.getSurface().getToolbarDialogs().disconnect(this),this.getSurface().getToolbarDialogs().clearWindows(),this.surface=null)},ve.ui.Toolbar.prototype.destroy=function(){OO.ui.Toolbar.prototype.destroy.call(this),this.$window&&this.$window.off(this.windowEvents),this.detach()},ve.ui.Toolbar.prototype["float"]=function(){if(!this.floating){var a=this.$element.height();this.$element.css("height",a).addClass("ve-ui-toolbar-floating"),this.$bar.css({left:this.elementOffset.left,right:this.elementOffset.right}),this.floating=!0,this.surface.setToolbarHeight(a)}},ve.ui.Toolbar.prototype.unfloat=function(){this.floating&&(this.$element.css("height","").removeClass("ve-ui-toolbar-floating"),this.$bar.css({left:"",right:""}),this.floating=!1,this.surface.setToolbarHeight(0))},ve.ui.TargetToolbar=function(a,b){ve.ui.TargetToolbar["super"].call(this,b),this.target=a},OO.inheritClass(ve.ui.TargetToolbar,ve.ui.Toolbar),ve.ui.TargetToolbar.prototype.getTarget=function(){return this.target},ve.ui.TargetToolbar.prototype.getTriggers=function(a){var b=ve.ui.TargetToolbar["super"].prototype.getTriggers.apply(this,arguments);return b||this.getTarget().targetTriggerListener.getTriggers(a)||this.getTarget().documentTriggerListener.getTriggers(a)},ve.ui.TargetToolbar.prototype.getCommands=function(){return ve.ui.TargetToolbar["super"].prototype.getCommands.apply(this,arguments).concat(this.getTarget().targetTriggerListener.getCommands(),this.getTarget().documentTriggerListener.getCommands())},ve.ui.ToolFactory=function(){ve.ui.ToolFactory["super"].call(this),ve.ui.ModeledFactory.call(this)},OO.inheritClass(ve.ui.ToolFactory,OO.ui.ToolFactory),OO.mixinClass(ve.ui.ToolFactory,ve.ui.ModeledFactory),ve.ui.toolFactory=new ve.ui.ToolFactory,ve.ui.toolGroupFactory=new OO.ui.ToolGroupFactory,ve.ui.Command=function(a,b,c,d){d=d||{},this.name=a,this.action=b,this.method=c,this.supportedSelections=d.supportedSelections||null,this.args=d.args||[]},ve.ui.Command.prototype.execute=function(a){return this.isExecutable(a.getModel().getFragment())?a.execute.apply(a,[this.action,this.method].concat(this.args)):!1},ve.ui.Command.prototype.isExecutable=function(a){return!this.supportedSelections||-1!==this.supportedSelections.indexOf(a.getSelection().constructor["static"].name)},ve.ui.Command.prototype.getAction=function(){return this.action},ve.ui.Command.prototype.getMethod=function(){return this.method},ve.ui.Command.prototype.getName=function(){return this.name},ve.ui.Command.prototype.getArgs=function(){return this.args},ve.ui.CommandRegistry=function(){OO.Registry.call(this)},OO.inheritClass(ve.ui.CommandRegistry,OO.Registry),ve.ui.CommandRegistry.prototype.register=function(a){if(!(a instanceof ve.ui.Command))throw new Error("command must be an instance of ve.ui.Command, cannot be a "+typeof a);OO.Registry.prototype.register.call(this,a.getName(),a)},ve.ui.CommandRegistry.prototype.getCommandForNode=function(a){return this.lookup(a.constructor["static"].primaryCommandName)},ve.ui.commandRegistry=new ve.ui.CommandRegistry,ve.ui.commandRegistry.register(new ve.ui.Command("bold","annotation","toggle",{args:["textStyle/bold"],supportedSelections:["linear","table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("italic","annotation","toggle",{args:["textStyle/italic"],supportedSelections:["linear","table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("code","annotation","toggle",{args:["textStyle/code"],supportedSelections:["linear","table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("strikethrough","annotation","toggle",{args:["textStyle/strikethrough"],supportedSelections:["linear","table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("underline","annotation","toggle",{args:["textStyle/underline"],supportedSelections:["linear","table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("subscript","annotation","toggle",{args:["textStyle/subscript"],supportedSelections:["linear","table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("superscript","annotation","toggle",{args:["textStyle/superscript"],supportedSelections:["linear","table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("link","window","open",{args:["link"],supportedSelections:["linear"]})),ve.ui.commandRegistry.register(new ve.ui.Command("specialCharacter","window","toggle",{args:["specialCharacter"],supportedSelections:["linear"]})),ve.ui.commandRegistry.register(new ve.ui.Command("number","list","toggle",{args:["number"],supportedSelections:["linear"]})),ve.ui.commandRegistry.register(new ve.ui.Command("bullet","list","toggle",{args:["bullet"],supportedSelections:["linear"]})),ve.ui.commandRegistry.register(new ve.ui.Command("numberWrapOnce","list","wrapOnce",{args:["number",!0],supportedSelections:["linear"]})),ve.ui.commandRegistry.register(new ve.ui.Command("bulletWrapOnce","list","wrapOnce",{args:["bullet",!0],supportedSelections:["linear"]})),ve.ui.commandRegistry.register(new ve.ui.Command("commandHelp","window","open",{args:["commandHelp"]})),ve.ui.commandRegistry.register(new ve.ui.Command("findAndReplace","window","toggle",{args:["findAndReplace"]})),ve.ui.commandRegistry.register(new ve.ui.Command("findNext","window","open",{args:["findAndReplace",null,"findNext"]})),ve.ui.commandRegistry.register(new ve.ui.Command("findPrevious","window","open",{args:["findAndReplace",null,"findPrevious"]})),ve.ui.commandRegistry.register(new ve.ui.Command("code","annotation","toggle",{args:["textStyle/code"],supportedSelections:["linear","table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("strikethrough","annotation","toggle",{args:["textStyle/strikethrough"],supportedSelections:["linear","table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("language","window","open",{args:["language"],supportedSelections:["linear"]})),ve.ui.commandRegistry.register(new ve.ui.Command("paragraph","format","convert",{args:["paragraph"],supportedSelections:["linear"]})),ve.ui.commandRegistry.register(new ve.ui.Command("heading1","format","convert",{args:["heading",{level:1}],supportedSelections:["linear"]})),ve.ui.commandRegistry.register(new ve.ui.Command("heading2","format","convert",{args:["heading",{level:2}],supportedSelections:["linear"]})),ve.ui.commandRegistry.register(new ve.ui.Command("heading3","format","convert",{args:["heading",{level:3}],supportedSelections:["linear"]})),ve.ui.commandRegistry.register(new ve.ui.Command("heading4","format","convert",{args:["heading",{level:4}],supportedSelections:["linear"]})),ve.ui.commandRegistry.register(new ve.ui.Command("heading5","format","convert",{args:["heading",{level:5}],supportedSelections:["linear"]})),ve.ui.commandRegistry.register(new ve.ui.Command("heading6","format","convert",{args:["heading",{level:6}],supportedSelections:["linear"]})),ve.ui.commandRegistry.register(new ve.ui.Command("preformatted","format","convert",{args:["preformatted"],supportedSelections:["linear"]})),ve.ui.commandRegistry.register(new ve.ui.Command("blockquote","format","convert",{args:["blockquote"],supportedSelections:["linear"]})),ve.ui.commandRegistry.register(new ve.ui.Command("pasteSpecial","content","pasteSpecial",{supportedSelections:["linear","table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("selectAll","content","selectAll",{supportedSelections:["linear","table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("comment","window","open",{args:["comment"],supportedSelections:["linear"]})),ve.ui.commandRegistry.register(new ve.ui.Command("insertTable","table","create",{args:[{header:!0,rows:3,cols:4}],supportedSelections:["linear"]})),ve.ui.commandRegistry.register(new ve.ui.Command("deleteTable","table","delete",{args:["table"],supportedSelections:["table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("insertRowBefore","table","insert",{args:["row","before"],supportedSelections:["table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("insertRowAfter","table","insert",{args:["row","after"],supportedSelections:["table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("deleteRow","table","delete",{args:["row"],supportedSelections:["table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("insertColumnBefore","table","insert",{args:["col","before"],supportedSelections:["table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("insertColumnAfter","table","insert",{args:["col","after"],supportedSelections:["table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("deleteColumn","table","delete",{args:["col"],supportedSelections:["table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("tableCellHeader","table","changeCellStyle",{args:["header"],supportedSelections:["table"]})),ve.ui.commandRegistry.register(new ve.ui.Command("tableCellData","table","changeCellStyle",{args:["data"],supportedSelections:["table"]})),ve.ui.Trigger=function(a,b){this.modifiers={meta:!1,ctrl:!1,alt:!1,shift:!1},this.primary=!1;var c,d,e,f,g=ve.ui.Trigger["static"].keyAliases,h=ve.ui.Trigger["static"].primaryKeys,i=ve.ui.Trigger["static"].primaryKeyMap;if(a instanceof jQuery.Event)this.modifiers.meta=a.metaKey||!1,this.modifiers.ctrl=a.ctrlKey||!1,this.modifiers.alt=a.altKey||!1,this.modifiers.shift=a.shiftKey||!1,this.primary=i[a.which]||!1;else if("string"==typeof a)for(f=a.replace(/\s*/g,"").toLowerCase().split("+"),c=0,d=f.length;d>c;c++)e=f[c],Object.prototype.hasOwnProperty.call(g,e)&&(e=g[e]),Object.prototype.hasOwnProperty.call(this.modifiers,e)?this.modifiers[e]=!0:(-1!==h.indexOf(e)||b)&&(this.primary=e)},OO.initClass(ve.ui.Trigger),ve.ui.Trigger["static"].modifierKeys=["meta","ctrl","alt","shift"],ve.ui.Trigger["static"].primaryKeys=["backspace","tab","enter","escape","page-up","page-down","end","home","left","up","right","down","delete","clear","0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","multiply","add","subtract","decimal","divide","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12",";","=",",","-",".","/","`","[","\\","]","'"],ve.ui.Trigger["static"].platformFilters={mac:function(){var a={meta:"⌘",shift:"⇧",backspace:"⌫",ctrl:"^",alt:"⎇",escape:"⎋"};return function(b){var c,d;for(c=0,d=b.length;d>c;c++)b[c]=a[b[c]]||b[c];return b.join("").toUpperCase()}}()},ve.ui.Trigger["static"].keyAliases={command:"meta",apple:"meta",windows:"meta",option:"alt","return":"enter",esc:"escape",cmd:"meta",del:"delete",control:"ctrl",alternate:"alt","⌘":"meta","⎇":"alt","⇧":"shift","⏎":"enter","⌫":"backspace","⎋":"escape"},ve.ui.Trigger["static"].primaryKeyMap={8:"backspace",9:"tab",12:"clear",13:"enter",27:"escape",33:"page-up",34:"page-down",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",46:"delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"multiply",107:"add",109:"subtract",110:"decimal",111:"divide",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},ve.ui.Trigger.prototype.isComplete=function(){return this.primary!==!1},ve.ui.Trigger.prototype.toString=function(){var a,b,c=ve.ui.Trigger["static"].modifierKeys,d=[];for(a=0,b=c.length;b>a;a++)this.modifiers[c[a]]&&d.push(c[a]);return this.primary?(d.push(this.primary),d.join("+")):""},ve.ui.Trigger.prototype.getMessage=function(){var a,b=ve.ui.Trigger["static"].platformFilters,c=ve.getSystemPlatform();return a=this.toString().split("+"),Object.prototype.hasOwnProperty.call(b,c)?b[c](a):a.map(function(a){return a[0].toUpperCase()+a.slice(1).toLowerCase()}).join("+")},ve.ui.TriggerRegistry=function(){ve.ui.TriggerRegistry["super"].call(this)},OO.inheritClass(ve.ui.TriggerRegistry,OO.Registry),ve.ui.TriggerRegistry.prototype.register=function(a,b){var c,d,e,f=ve.getSystemPlatform(),g="mac"===f?"mac":"pc";if(ve.isPlainObject(b)){if(!Object.prototype.hasOwnProperty.call(b,g))return;e=Array.isArray(b[g])?b[g]:[b[g]]}else e=Array.isArray(b)?b:[b];for(c=0,d=e.length;d>c;c++){if(!(e[c]instanceof ve.ui.Trigger))throw new Error("Trigger must be an instance of ve.ui.Trigger");if(!e[c].isComplete())throw new Error("Incomplete trigger")}ve.ui.TriggerRegistry["super"].prototype.register.call(this,a,e)},ve.ui.TriggerRegistry.prototype.getMessages=function(a){return(this.lookup(a)||[]).map(function(a){return a.getMessage()})},ve.ui.triggerRegistry=new ve.ui.TriggerRegistry,ve.ui.triggerRegistry.register("undo",{mac:new ve.ui.Trigger("cmd+z"),pc:new ve.ui.Trigger("ctrl+z")}),ve.ui.triggerRegistry.register("redo",{mac:[new ve.ui.Trigger("cmd+shift+z"),new ve.ui.Trigger("cmd+y")],pc:[new ve.ui.Trigger("ctrl+shift+z"),new ve.ui.Trigger("ctrl+y")]}),ve.ui.triggerRegistry.register("bold",{mac:new ve.ui.Trigger("cmd+b"),pc:new ve.ui.Trigger("ctrl+b")}),ve.ui.triggerRegistry.register("italic",{mac:new ve.ui.Trigger("cmd+i"),pc:new ve.ui.Trigger("ctrl+i")}),ve.ui.triggerRegistry.register("link",{mac:new ve.ui.Trigger("cmd+k"),pc:new ve.ui.Trigger("ctrl+k")}),ve.ui.triggerRegistry.register("clear",{mac:[new ve.ui.Trigger("cmd+\\"),new ve.ui.Trigger("cmd+m")],pc:[new ve.ui.Trigger("ctrl+\\"),new ve.ui.Trigger("ctrl+m")]}),ve.ui.triggerRegistry.register("underline",{mac:new ve.ui.Trigger("cmd+u"),pc:new ve.ui.Trigger("ctrl+u")}),ve.ui.triggerRegistry.register("code",{mac:new ve.ui.Trigger("cmd+shift+6"),pc:new ve.ui.Trigger("ctrl+shift+6")}),ve.ui.triggerRegistry.register("strikethrough",{mac:new ve.ui.Trigger("cmd+shift+5"),pc:new ve.ui.Trigger("ctrl+shift+5")}),ve.ui.triggerRegistry.register("subscript",{mac:new ve.ui.Trigger("cmd+,"),pc:new ve.ui.Trigger("ctrl+,")}),ve.ui.triggerRegistry.register("superscript",{mac:new ve.ui.Trigger("cmd+."),pc:new ve.ui.Trigger("ctrl+.")}),ve.ui.triggerRegistry.register("indent",new ve.ui.Trigger("tab")),ve.ui.triggerRegistry.register("outdent",new ve.ui.Trigger("shift+tab")),ve.ui.triggerRegistry.register("commandHelp",{mac:[new ve.ui.Trigger("cmd+/"),new ve.ui.Trigger("cmd+shift+/")],pc:[new ve.ui.Trigger("ctrl+/"),new ve.ui.Trigger("ctrl+shift+/")]}),ve.ui.triggerRegistry.register("paragraph",new ve.ui.Trigger("ctrl+0")),ve.ui.triggerRegistry.register("heading1",new ve.ui.Trigger("ctrl+1")),ve.ui.triggerRegistry.register("heading2",new ve.ui.Trigger("ctrl+2")),ve.ui.triggerRegistry.register("heading3",new ve.ui.Trigger("ctrl+3")),ve.ui.triggerRegistry.register("heading4",new ve.ui.Trigger("ctrl+4")),ve.ui.triggerRegistry.register("heading5",new ve.ui.Trigger("ctrl+5")),ve.ui.triggerRegistry.register("heading6",new ve.ui.Trigger("ctrl+6")),ve.ui.triggerRegistry.register("preformatted",new ve.ui.Trigger("ctrl+7")),ve.ui.triggerRegistry.register("blockquote",new ve.ui.Trigger("ctrl+8")),ve.ui.triggerRegistry.register("selectAll",{mac:new ve.ui.Trigger("cmd+a"),pc:new ve.ui.Trigger("ctrl+a")}),ve.ui.triggerRegistry.register("pasteSpecial",{mac:new ve.ui.Trigger("cmd+shift+v"),pc:new ve.ui.Trigger("ctrl+shift+v")}),ve.ui.triggerRegistry.register("findAndReplace",{mac:new ve.ui.Trigger("cmd+f"),pc:new ve.ui.Trigger("ctrl+f")}),ve.ui.triggerRegistry.register("findNext",{mac:new ve.ui.Trigger("cmd+g"),pc:[new ve.ui.Trigger("ctrl+g"),new ve.ui.Trigger("f3")]}),ve.ui.triggerRegistry.register("findPrevious",{mac:new ve.ui.Trigger("cmd+shift+g"),pc:[new ve.ui.Trigger("shift+ctrl+g"),new ve.ui.Trigger("shift+f3")]}),ve.ui.Sequence=function(a,b,c,d){this.name=a,this.commandName=b,this.data=c,this.strip=d},OO.initClass(ve.ui.Sequence),ve.ui.Sequence.prototype.match=function(a,b){var c,d=b-1;for(c=this.data.length-1;c>=0;c--,d--)if("string"==typeof this.data[c]){if(this.data[c]!==a.getCharacterData(d))return!1}else if(!ve.compare(this.data[c],a.getData(d),!0))return!1;return!0},ve.ui.Sequence.prototype.execute=function(a){var b,c,d,e=a.getModel(),f=ve.ui.commandRegistry.lookup(this.getCommandName());if(!f)throw new Error("Command not found: "+this.getCommandName());return this.strip&&(b=e.getSelection().getRange(),d=e.getLinearFragment(new ve.Range(b.end,b.end-this.strip))),e.breakpoint(),c=f.execute(a),c&&d&&d.removeContent(),c},ve.ui.Sequence.prototype.getName=function(){return this.name},ve.ui.Sequence.prototype.getCommandName=function(){return this.commandName},ve.ui.SequenceRegistry=function(){ve.ui.SequenceRegistry["super"].call(this)},OO.inheritClass(ve.ui.SequenceRegistry,OO.Registry),ve.ui.SequenceRegistry.prototype.register=function(a){if(!(a instanceof ve.ui.Sequence))throw new Error("sequence must be an instance of ve.ui.Sequence, cannot be a "+typeof a);ve.ui.SequenceRegistry["super"].prototype.register.call(this,a.getName(),a)},ve.ui.SequenceRegistry.prototype.findMatching=function(a,b){var c,d=[];for(c in this.registry)this.registry[c].match(a,b)&&d.push(this.registry[c]);return d},ve.ui.sequenceRegistry=new ve.ui.SequenceRegistry,ve.ui.sequenceRegistry.register(new ve.ui.Sequence("bulletStar","bulletWrapOnce",[{type:"paragraph"},"*"," "],2)),ve.ui.sequenceRegistry.register(new ve.ui.Sequence("numberDot","numberWrapOnce",[{type:"paragraph"},"1","."," "],3)),ve.ui.Action=function(a){this.surface=a},OO.initClass(ve.ui.Action),ve.ui.Action["static"].methods=[],ve.ui.ActionFactory=function(){OO.Factory.call(this)},OO.inheritClass(ve.ui.ActionFactory,OO.Factory),ve.ui.ActionFactory.prototype.doesActionSupportMethod=function(a,b){if(Object.prototype.hasOwnProperty.call(this.registry,a))return-1!==this.registry[a]["static"].methods.indexOf(b);throw new Error("Unknown action: "+a)},ve.ui.actionFactory=new ve.ui.ActionFactory,ve.ui.DataTransferHandler=function(a,b){this.surface=a,this.item=b,this.insertableDataDeferred=$.Deferred()},OO.initClass(ve.ui.DataTransferHandler),ve.ui.DataTransferHandler["static"].name=null,ve.ui.DataTransferHandler["static"].kinds=null,ve.ui.DataTransferHandler["static"].types=[],ve.ui.DataTransferHandler["static"].handlesPaste=!0,ve.ui.DataTransferHandler["static"].matchFunction=null,ve.ui.DataTransferHandler.prototype.process=null,ve.ui.DataTransferHandler.prototype.getInsertableData=function(){return this.process(),this.insertableDataDeferred.promise()},ve.ui.DataTransferHandler.prototype.abort=function(){this.insertableDataDeferred.reject()},ve.ui.FileTransferHandler=function(){ve.ui.FileTransferHandler["super"].apply(this,arguments),this.file=this.item.getAsFile(),this.reader=new FileReader,this.progress=!1,this.progressBar=null,this.reader.addEventListener("progress",this.onFileProgress.bind(this)),this.reader.addEventListener("load",this.onFileLoad.bind(this)),this.reader.addEventListener("loadend",this.onFileLoadEnd.bind(this))},OO.inheritClass(ve.ui.FileTransferHandler,ve.ui.DataTransferHandler),ve.ui.FileTransferHandler["static"].kinds=["file"],ve.ui.FileTransferHandler["static"].extensions=[],ve.ui.FileTransferHandler.prototype.onFileProgress=function(){},ve.ui.FileTransferHandler.prototype.onFileLoad=function(){},ve.ui.FileTransferHandler.prototype.onFileLoadEnd=function(){},ve.ui.FileTransferHandler.prototype.createProgress=function(a,b){var c=this;this.surface.createProgress(a,b||this.file.name).done(function(a,b){a.setProgress(c.progress),c.progressBar=a,b.fail(c.abort.bind(c))})},ve.ui.FileTransferHandler.prototype.setProgress=function(a){this.progress=a,this.progressBar&&this.progressBar.setProgress(this.progress)},ve.ui.DataTransferHandlerFactory=function(){ve.ui.DataTransferHandlerFactory["super"].apply(this,arguments),this.handlerNamesByType={},this.handlerNamesByKindAndType={},this.handlerNamesByExtension={}},OO.inheritClass(ve.ui.DataTransferHandlerFactory,OO.Factory),ve.ui.DataTransferHandlerFactory.prototype.register=function(a){ve.ui.DataTransferHandlerFactory["super"].prototype.register.call(this,a);var b,c,d,e,f=a["static"].kinds,g=a["static"].types,h=a["static"].extensions;if(f)for(b=0,d=f.length;d>b;b++)for(c=0,e=g.length;e>c;c++)this.handlerNamesByKindAndType[f[b]]=this.handlerNamesByKindAndType[f[b]]||{},this.handlerNamesByKindAndType[f[b]][g[c]]=a["static"].name;else for(c=0,e=g.length;e>c;c++)this.handlerNamesByType[g[c]]=a["static"].name;if(a.prototype instanceof ve.ui.FileTransferHandler)for(b=0,d=h.length;d>b;b++)this.handlerNamesByExtension[h[b]]=a["static"].name},ve.ui.DataTransferHandlerFactory.prototype.getHandlerNameForItem=function(a,b){var c,d=this.handlerNamesByKindAndType[a.kind]&&this.handlerNamesByKindAndType[a.kind][a.type]||this.handlerNamesByType[a.type]||this.handlerNamesByExtension[a.getExtension()];if(d&&(c=this.registry[d],!(b&&!c["static"].handlesPaste||c["static"].matchFunction&&!c["static"].matchFunction(a))))return d},ve.ui.dataTransferHandlerFactory=new ve.ui.DataTransferHandlerFactory,ve.ui.DataTransferItem=function(a,b,c,d){this.kind=a,this.type=b,this.data=c,this.blob=this.data.blob||null,this.stringData=this.data.stringData||ve.getProp(this.blob,"name")||null,this.name=d},OO.initClass(ve.ui.DataTransferItem),ve.ui.DataTransferItem["static"].newFromBlob=function(a){return new ve.ui.DataTransferItem("file",a.type,{blob:a},a.name)},ve.ui.DataTransferItem["static"].newFromDataUri=function(a){var b=a.split(",");return new ve.ui.DataTransferItem("file",b[0].match(/^data:([^;]+)/)[1],{dataUri:b[1]})},ve.ui.DataTransferItem["static"].newFromString=function(a,b){return new ve.ui.DataTransferItem("string",b||"text/plain",{stringData:a})},ve.ui.DataTransferItem["static"].newFromItem=function(a){return new ve.ui.DataTransferItem(a.kind,a.type,{item:a},a.getAsFile().name)},ve.ui.DataTransferItem.prototype.getAsFile=function(){if(this.data.item)return this.data.item.getAsFile();var a,b,c;if(!this.blob&&this.data.dataUri){for(a=atob(this.data.dataUri),delete this.data.dataUri,b=[],c=0;c<a.length;c++)b.push(a.charCodeAt(c));this.blob=new Blob([new Uint8Array(b)],{type:this.type})}return this.blob},ve.ui.DataTransferItem.prototype.getExtension=function(){return this.name?this.name.split(".").pop():null},ve.ui.DataTransferItem.prototype.getAsString=function(){return this.stringData},ve.ui.WindowManager=function(a){a=a||{},ve.ui.WindowManager["super"].call(this,a),this.overlay=a.overlay||null,this.$element.addClass("ve-ui-dir-block-"+this.getDir())},OO.inheritClass(ve.ui.WindowManager,OO.ui.WindowManager),ve.ui.WindowManager.prototype.getDir=function(){return $("body").css("direction")},ve.ui.WindowManager.prototype.getOverlay=function(){return this.overlay},ve.ui.SurfaceWindowManager=function(a,b){this.surface=a,ve.ui.SurfaceWindowManager["super"].call(this,b)},OO.inheritClass(ve.ui.SurfaceWindowManager,ve.ui.WindowManager),ve.ui.SurfaceWindowManager.prototype.getDir=function(){return this.surface.getDir()||ve.ui.SurfaceWindowManager["super"].prototype.getDir.call(this)},ve.ui.SurfaceWindowManager.prototype.getSurface=function(){return this.surface},ve.ui.AnnotationAction=function(a){ve.ui.Action.call(this,a)},OO.inheritClass(ve.ui.AnnotationAction,ve.ui.Action),ve.ui.AnnotationAction["static"].name="annotation",ve.ui.AnnotationAction["static"].methods=["set","clear","toggle","clearAll"],ve.ui.AnnotationAction.prototype.set=function(a,b){var c,d,e=this.surface.getModel().getFragment(),f=ve.dm.annotationFactory.lookup(a),g=f["static"].removes;for(e.getSelection()instanceof ve.dm.LinearSelection&&(d=e.trimLinearSelection(),d.getSelection().isCollapsed()||(e=d)),c=g.length-1;c>=0;c--)e.annotateContent("clear",g[c]);return e.annotateContent("set",a,b),!0},ve.ui.AnnotationAction.prototype.clear=function(a,b){return this.surface.getModel().getFragment().annotateContent("clear",a,b),!0},ve.ui.AnnotationAction.prototype.toggle=function(a,b){var c,d,e,f=this.surface.getModel(),g=f.getFragment(),h=ve.dm.annotationFactory.create(a,b),i=h.constructor["static"].removes;return g.getSelection().isCollapsed()?(d=f.getInsertionAnnotations(),c=d.getAnnotationsByName(h.name),c.isEmpty()?(e=d.filter(function(a){return-1!==i.indexOf(a.name)}),f.removeInsertionAnnotations(e),f.addInsertionAnnotations(h)):f.removeInsertionAnnotations(c)):g.getAnnotations().containsComparable(h)?g.annotateContent("clear",a):this.set(a,b),!0},ve.ui.AnnotationAction.prototype.clearAll=function(){var a,b,c,d=this.surface.getModel(),e=d.getFragment(),f=e.getAnnotations(!0);for(c=f.get(),a=0,b=c.length;b>a;a++)e.annotateContent("clear",c[a].name,c[a].data);return d.setInsertionAnnotations(null),!0},ve.ui.actionFactory.register(ve.ui.AnnotationAction),ve.ui.ContentAction=function(a){ve.ui.Action.call(this,a)},OO.inheritClass(ve.ui.ContentAction,ve.ui.Action),ve.ui.ContentAction["static"].name="content",ve.ui.ContentAction["static"].methods=["insert","remove","select","pasteSpecial","selectAll"],ve.ui.ContentAction.prototype.insert=function(a,b){return this.surface.getModel().getFragment().insertContent(a,b),!0},ve.ui.ContentAction.prototype.remove=function(){return this.surface.getModel().getFragment().removeContent(),!0},ve.ui.ContentAction.prototype.select=function(a){return this.surface.getModel().setSelection(a),!0},ve.ui.ContentAction.prototype.selectAll=function(){return this.surface.getView().selectAll(),!0},ve.ui.ContentAction.prototype.pasteSpecial=function(){return this.surface.getView().pasteSpecial=!0,!1},ve.ui.actionFactory.register(ve.ui.ContentAction),ve.ui.FormatAction=function(a){ve.ui.Action.call(this,a)},OO.inheritClass(ve.ui.FormatAction,ve.ui.Action),ve.ui.FormatAction["static"].name="format",ve.ui.FormatAction["static"].methods=["convert"],ve.ui.FormatAction.prototype.convert=function(a,b){var c,d,e,f,g,h=this.surface.getModel(),i=h.getSelection(),j=h.getFragment(i,!0),k=h.getDocument(),l=[];if(i instanceof ve.dm.LinearSelection){for(c=k.selectNodes(i.getRange(),"leaves"),d=0,e=c.length;e>d;d++)f=c[d].node.isContent()?c[d].node.getParent():c[d].node,l.push(h.getLinearFragment(f.getOuterRange(),!0));for(d=0,e=l.length;e>d;d++)l[d].isolateAndUnwrap(a);return i=j.getSelection(),g=ve.dm.Transaction.newFromContentBranchConversion(k,i.getRange(),a,b),h.change(g,i),this.surface.getView().focus(),!0}},ve.ui.actionFactory.register(ve.ui.FormatAction),ve.ui.HistoryAction=function(a){ve.ui.Action.call(this,a)},OO.inheritClass(ve.ui.HistoryAction,ve.ui.Action),ve.ui.HistoryAction["static"].name="history",ve.ui.HistoryAction["static"].methods=["undo","redo"],ve.ui.HistoryAction.prototype.undo=function(){return this.surface.getModel().undo(),!0},ve.ui.HistoryAction.prototype.redo=function(){return this.surface.getModel().redo(),!0},ve.ui.actionFactory.register(ve.ui.HistoryAction),ve.ui.IndentationAction=function(a){ve.ui.Action.call(this,a)},OO.inheritClass(ve.ui.IndentationAction,ve.ui.Action),ve.ui.IndentationAction["static"].name="indentation",ve.ui.IndentationAction["static"].methods=["increase","decrease"],ve.ui.IndentationAction.prototype.increase=function(){var a,b,c,d=[],e=!1,f=this.surface.getModel(),g=f.getDocument(),h=f.getFragment();if(h.getSelection()instanceof ve.dm.LinearSelection){for(c=g.getCoveredSiblingGroups(h.getSelection().getRange()),a=0;a<c.length;a++)b=c[a],b.grandparent&&"list"===b.grandparent.getType()&&(d.push(f.getLinearFragment(b.parent.getRange(),!0)),e=!0);
for(a=0;a<d.length;a++)this.indentListItem(g.getBranchNodeFromOffset(d[a].getSelection().getRange().start));return h.select(),e}},ve.ui.IndentationAction.prototype.decrease=function(){var a,b,c,d=[],e=!1,f=this.surface.getModel(),g=f.getDocument(),h=f.getFragment();if(h.getSelection()instanceof ve.dm.LinearSelection){for(c=g.getCoveredSiblingGroups(h.getSelection().getRange()),a=0;a<c.length;a++)b=c[a],b.grandparent&&"list"===b.grandparent.getType()?(d.push(f.getLinearFragment(b.parent.getRange(),!0)),e=!0):b.parent&&"list"===b.parent.getType()&&(d.push(f.getLinearFragment(b.nodes[0].getRange(),!0)),e=!0);for(a=0;a<d.length;a++)this.unindentListItem(g.getBranchNodeFromOffset(d[a].getSelection().getRange().start));return h.select(),e}},ve.ui.IndentationAction.prototype.indentListItem=function(a){if(!(a instanceof ve.dm.ListItemNode))throw new Error("listItem must be a ve.dm.ListItemNode");var b,c,d,e,f,g,h=this.surface.getModel(),i=h.getDocument(),j=h.getSelection(),k=a.getParent().getAttribute("style"),l=a.getOuterRange();j instanceof ve.dm.LinearSelection&&(c=j.getRange(),b=ve.dm.Transaction.newFromWrap(i,l,[],[{type:"listItem"},{type:"list",attributes:{style:k}}],[],[]),h.change(b),c=b.translateRange(c),d=l.translate(2),e=new ve.Range(l.start,l.end+2),"listItem"===i.data.getData(l.start).type&&"/listItem"===i.data.getData(l.start-1).type&&(f=l.start-1,g=l.start+1,"list"===i.data.getData(g).type&&"/list"===i.data.getData(f-1).type&&(f--,g++),b=ve.dm.Transaction.newFromRemoval(i,new ve.Range(f,g)),h.change(b),c=b.translateRange(c),d=b.translateRange(d),e=b.translateRange(e)),h.setLinearSelection(c))},ve.ui.IndentationAction.prototype.unindentListItem=function(a){if(!(a instanceof ve.dm.ListItemNode))throw new Error("listItem must be a ve.dm.ListItemNode");var b,c,d,e,f,g,h=this.surface.getModel(),i=h.getDocument(),j=h.getLinearFragment(a.getOuterRange(),!0),k=a.getParent(),l=k.getClonedElement(),m=k.getParent().getType(),n=a.getOuterRange();if("list"!==i.data.getData(n.start-1).type&&(b=ve.dm.Transaction.newFromInsertion(i,n.start,[{type:"/list"},l]),h.change(b),n=n.translate(2)),"/list"!==i.data.getData(n.end).type&&(b=ve.dm.Transaction.newFromInsertion(i,n.end,[{type:"/list"},l]),h.change(b)),g=new ve.Range(n.start-1,n.end+1),"listItem"!==m)for(b=ve.dm.Transaction.newFromWrap(i,new ve.Range(n.start+1,n.end-1),[{type:"list"},{type:"listItem"}],[],[],[]),h.change(b),e=j.getSiblingNodes(),c=0,d=e.length;d>c;c++)f=e[c].node,"paragraph"===f.type&&f.element.internal&&"wrapper"===f.element.internal.generated&&(delete f.element.internal.generated,ve.isEmptyObject(f.element.internal)&&delete f.element.internal);else"listItem"!==i.data.getData(g.start-1).type&&(b=ve.dm.Transaction.newFromInsertion(i,g.start,[{type:"/listItem"},{type:"listItem"}]),h.change(b),g=g.translate(2)),"/listItem"!==i.data.getData(g.end).type&&(b=ve.dm.Transaction.newFromInsertion(i,g.end,[{type:"/listItem"},{type:"listItem"}]),h.change(b)),b=ve.dm.Transaction.newFromWrap(i,new ve.Range(g.start+1,g.end-1),[{type:"listItem"},{type:"list"}],[],[],[]),h.change(b)},ve.ui.actionFactory.register(ve.ui.IndentationAction),ve.ui.ListAction=function(a){ve.ui.Action.call(this,a)},OO.inheritClass(ve.ui.ListAction,ve.ui.Action),ve.ui.ListAction["static"].name="list",ve.ui.ListAction["static"].methods=["wrap","unwrap","toggle","wrapOnce"],ve.ui.ListAction.prototype.allWrapped=function(a){var b,c,d=a?{style:a}:void 0,e=this.surface.getModel().getFragment().getLeafNodes(),f=!!e.length;for(b=0,c=e.length;c>b;b++)if((1===c||!e[b].range||e[b].range.getLength())&&!e[b].node.hasMatchingAncestor("list",d)){f=!1;break}return f},ve.ui.ListAction.prototype.toggle=function(a,b){return this[this.allWrapped(a)?"unwrap":"wrap"](a,b)},ve.ui.ListAction.prototype.wrapOnce=function(a,b){return this.allWrapped()?!1:this.wrap(a,b)},ve.ui.ListAction.prototype.wrap=function(a,b){var c,d,e,f,g,h,i,j=this.surface.getModel(),k=j.getDocument(),l=j.getSelection();if(!(l instanceof ve.dm.LinearSelection))return!1;if(h=l.getRange(),b||j.breakpoint(),h.isCollapsed()&&!k.data.isContentOffset(h.to)&&k.hasSlugAtOffset(h.to))j.change(ve.dm.Transaction.newFromInsertion(k,h.from,[{type:"list",attributes:{style:a}},{type:"listItem"},{type:"paragraph"},{type:"/paragraph"},{type:"/listItem"},{type:"/list"}]),new ve.dm.LinearSelection(k,new ve.Range(h.to+3)));else for(i=k.getCoveredSiblingGroups(h),d=0;d<i.length;d++)g=i[d],g.grandparent&&"list"===g.grandparent.getType()?g.grandparent!==e&&(j.change(ve.dm.Transaction.newFromAttributeChanges(k,g.grandparent.getOffset(),{style:a}),l),e=g.grandparent):(f=new ve.Range(g.nodes[0].getOuterRange().start,g.nodes[g.nodes.length-1].getOuterRange().end),j.change(ve.dm.Transaction.newFromContentBranchConversion(k,f,"paragraph"),l),c=ve.dm.Transaction.newFromWrap(k,f,[],[{type:"list",attributes:{style:a}}],[],[{type:"listItem"}]),j.change(c,new ve.dm.LinearSelection(k,c.translateRange(h))));return b||j.breakpoint(),!0},ve.ui.ListAction.prototype.unwrap=function(a){var b,c=this.surface.getModel(),d=c.getDocument();if(!(c.getSelection()instanceof ve.dm.LinearSelection))return!1;a||c.breakpoint();do b=d.getBranchNodeFromOffset(c.getSelection().getRange().start);while(b.hasMatchingAncestor("list")&&this.surface.execute("indentation","decrease"));return a||c.breakpoint(),!0},ve.ui.actionFactory.register(ve.ui.ListAction),ve.ui.TableAction=function(a){ve.ui.Action.call(this,a)},OO.inheritClass(ve.ui.TableAction,ve.ui.Action),ve.ui.TableAction["static"].name="table",ve.ui.TableAction["static"].methods=["create","insert","delete","changeCellStyle","mergeCells","caption"],ve.ui.TableAction.prototype.create=function(a){a=a||{};var b,c=a.type||"table",d={type:c},e=this.surface.getModel(),f=e.getFragment(),g=[],h=a.cols||4,i=a.rows||3;if(!(f.getSelection()instanceof ve.dm.LinearSelection))return!1;for(a.attributes&&(d.attributes=ve.copy(a.attributes)),g.push(d),g.push({type:"tableSection",attributes:{style:"body"}}),a.header&&(g=g.concat(ve.dm.TableRowNode["static"].createData({style:"header",cellCount:h}))),b=0;i>b;b++)g=g.concat(ve.dm.TableRowNode["static"].createData({style:"data",cellCount:h}));return g.push({type:"/tableSection"}),g.push({type:"/"+c}),f.insertContent(g,!1),e.setSelection(new ve.dm.TableSelection(f.getDocument(),f.getSelection().getRange(),0,0,0,0)),!0},ve.ui.TableAction.prototype.insert=function(a,b){var c,d=this.surface.getModel(),e=d.getSelection();return e instanceof ve.dm.TableSelection?(c="col"===a?"before"===b?e.startCol:e.endCol:"before"===b?e.startRow:e.endRow,"before"===b&&(e="col"===a?e.newFromAdjustment(1,0):e.newFromAdjustment(0,1),d.setSelection(e)),this.insertRowOrCol(e.getTableNode(),a,c,b,e),!0):!1},ve.ui.TableAction.prototype["delete"]=function(a){var b,c,d,e,f=this.surface.getModel().getSelection();return f instanceof ve.dm.TableSelection?(b=f.getTableNode(),"table"===a?this.deleteTable(b):("col"===a?(c=f.startCol,d=f.endCol,e=f.isFullRow()):(c=f.startRow,d=f.endRow,e=f.isFullCol()),e?this.deleteTable(b):this.deleteRowsOrColumns(b.matrix,a,c,d)),!0):!1},ve.ui.TableAction.prototype.changeCellStyle=function(a){var b,c,d=[],e=this.surface.getModel(),f=e.getSelection();if(!(f instanceof ve.dm.TableSelection))return!1;for(c=f.getOuterRanges(),b=c.length-1;b>=0;b--)d.push(ve.dm.Transaction.newFromAttributeChanges(e.getDocument(),c[b].start,{style:a}));return e.change(d),!0},ve.ui.TableAction.prototype.mergeCells=function(){var a,b,c,d,e,f,g=[],h=this.surface.getModel(),i=h.getSelection(),j=i.getTableNode().getMatrix();if(!(i instanceof ve.dm.TableSelection))return!1;if(i.isSingleCell()){for(e=i.getMatrixCells(!0),g.push(ve.dm.Transaction.newFromAttributeChanges(h.getDocument(),e[0].node.getOuterRange().start,{colspan:1,rowspan:1})),a=e.length-1;a>=1;a--)g.push(this.replacePlaceholder(j,e[a],{style:e[0].node.getStyle()}));h.change(g)}else{for(e=i.getMatrixCells(),g.push(ve.dm.Transaction.newFromAttributeChanges(h.getDocument(),e[0].node.getOuterRange().start,{colspan:1+i.endCol-i.startCol,rowspan:1+i.endRow-i.startRow})),a=e.length-1;a>=1;a--)g.push(ve.dm.Transaction.newFromRemoval(h.getDocument(),e[a].node.getOuterRange()));for(h.change(g),b=i.endRow;b>=i.startRow;b--){for(f=!1,c=0;void 0!==(d=j.getCell(b,c));c++)if(d&&!d.isPlaceholder()){f=!0;break}f||this.deleteRowsOrColumns(j,"row",b,b)}for(c=i.endCol;c>=i.startCol;c--){for(f=!1,b=0;void 0!==(d=j.getCell(b,c));b++)if(d&&!d.isPlaceholder()){f=!0;break}f||this.deleteRowsOrColumns(j,"col",c,c)}}return!0},ve.ui.TableAction.prototype.caption=function(){var a,b,c,d,e,f=this.surface.getModel(),g=f.getSelection();if(g instanceof ve.dm.TableSelection)b=g.getTableNode().getCaptionNode();else{if(!(g instanceof ve.dm.LinearSelection))return!1;for(c=f.getFragment().getSelectedLeafNodes(),d=c[0];d;){if(d instanceof ve.dm.TableCaptionNode){b=d;break}d=d.getParent()}if(!b)return;e=f.getFragment(new ve.dm.TableSelection(f.getDocument(),b.getParent().getOuterRange(),0,0,0,0,!0))}return b?(a=f.getLinearFragment(b.getOuterRange(),!0),a.removeContent(),e&&e.select()):(a=f.getLinearFragment(new ve.Range(g.tableRange.start+1),!0),a.insertContent([{type:"tableCaption"},{type:"paragraph",internal:{generated:"wrapper"}},{type:"/paragraph"},{type:"/tableCaption"}],!1),a.collapseToStart().adjustLinearSelection(2,2).select()),!0},ve.ui.TableAction.prototype.deleteTable=function(a){this.surface.getModel().getLinearFragment(a.getOuterRange())["delete"]()},ve.ui.TableAction.prototype.insertRowOrCol=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r=a.matrix,s=[],t={},u=[],v=this.surface.getModel();for(i="before"===d,f=c+(i?-1:1),"row"===b?(g=r.getRow(c)||[],h=r.getRow(f)||[]):(g=r.getColumn(c)||[],h=r.getColumn(f)||[]),l=0,m=g.length;m>l;l++)n=g[l],n&&(o=h[l],o&&(n.isPlaceholder()||o.isPlaceholder())&&n.node===o.node?(n=n.owner||n,t[n.key]||(s.push(this.incrementSpan(n,b)),t[n.key]=!0)):u.push(n));if("row"===b)p=ve.dm.TableRowNode["static"].createData({cellCount:u.length,style:g[0].node.getStyle()}),k=r.getRowNode(c).getOuterRange(),j=i?k.start:k.end,s.push(ve.dm.Transaction.newFromInsertion(v.getDocument(),j,p));else for(u.sort(ve.dm.TableMatrixCell["static"].sortDescending),l=0;l<u.length;l++)n=u[l],n&&(o=r.findClosestCell(n),o?(k=o.node.getOuterRange(),j=o.col<n.col||o.col===n.col&&!i?k.end:k.start,q=o.node.getStyle()):(k=r.getRowNode(n.row).getRange(),j=i?k.start:k.end,q=g[0].node.getStyle()),p=ve.dm.TableCellNode["static"].createData({style:q}),s.push(ve.dm.Transaction.newFromInsertion(v.getDocument(),j,p)));v.change(s,e.translateByTransactions(s))},ve.ui.TableAction.prototype.incrementSpan=function(a,b){var c,d=this.surface.getModel();return c="row"===b?{rowspan:a.node.getRowspan()+1}:{colspan:a.node.getColspan()+1},ve.dm.Transaction.newFromAttributeChanges(d.getDocument(),a.node.getOuterRange().start,c)},ve.ui.TableAction.prototype.decrementSpan=function(a,b,c,d){var e,f,g=this.surface.getModel();return e=c-a[b]+Math.max(0,a[b]+a.node.getSpans()[b]-1-d),f="row"===b?{rowspan:e}:{colspan:e},ve.dm.Transaction.newFromAttributeChanges(g.getDocument(),a.node.getOuterRange().start,f)},ve.ui.TableAction.prototype.deleteRowsOrColumns=function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q=[],r=[],s={},t=[],u=this.surface.getModel();if("row"===b)for(e=c;d>=e;e++)q=q.concat(a.getRow(e));else for(f=c;d>=f;f++)q=q.concat(a.getColumn(f));for(g=0,h=q.length;h>g;g++)i=q[g],i&&(i.isPlaceholder()?(j=i.owner.key,s[j]||(r.push(this.decrementSpan(i.owner,b,c,d)),s[j]=!0)):(k=i.node.getSpans()[b],i[b]+k-1>d&&("col"===b?(l=i.row,m=d+1):(l=d+1,m=i.col),n=i.row+i.node.getRowspan()-1,o=i.col+i.node.getColspan()-1,t.push({action:"insert",cell:a.getCell(l,m),colspan:1+o-m,rowspan:1+n-l,style:i.node.getStyle(),content:u.getDocument().getData(i.node.getRange())})),"col"===b&&t.push({action:"delete",cell:i})));if(t.sort(function(a,b){return ve.dm.TableMatrixCell["static"].sortDescending(a.cell,b.cell)}),"row"===b){for(g=0;g<t.length;g++)r.push(this.replacePlaceholder(a,t[g].cell,t[g]));for(e=d;e>=c;e--)p=a.getRowNode(e),r.push(ve.dm.Transaction.newFromRemoval(u.getDocument(),p.getOuterRange()))}else for(g=0;g<t.length;g++)r.push("insert"===t[g].action?this.replacePlaceholder(a,t[g].cell,t[g]):ve.dm.Transaction.newFromRemoval(u.getDocument(),t[g].cell.node.getOuterRange()));u.change(r,new ve.dm.NullSelection(u.getDocument()))},ve.ui.TableAction.prototype.replacePlaceholder=function(a,b,c){var d,e,f,g=a.findClosestCell(b),h=this.surface.getModel();return g?(d=g.node.getOuterRange(),e=b.col<g.col?d.start:d.end):(d=a.getRowNode(b.row).getRange(),e=d.start),f=ve.dm.TableCellNode["static"].createData(c),ve.dm.Transaction.newFromInsertion(h.getDocument(),e,f)},ve.ui.actionFactory.register(ve.ui.TableAction),ve.ui.WindowAction=function(a){ve.ui.Action.call(this,a)},OO.inheritClass(ve.ui.WindowAction,ve.ui.Action),ve.ui.WindowAction["static"].name="window",ve.ui.WindowAction["static"].methods=["open","close","toggle"],ve.ui.WindowAction.prototype.open=function(a,b,c){var d,e,f=this.getWindowType(a),g=f&&this.getWindowManager(f),h=g.getCurrentWindow(),i=[],j=this.surface,k=j.getModel().getFragment(void 0,!0),l=j.getView().getDocument().getDirectionFromSelection(k.getSelection())||j.getModel().getDocument().getDir();return g?(b=ve.extendObject({dir:l},b,{fragment:k}),("toolbar"===f||"inspector"===f)&&(b=ve.extendObject(b,{surface:j}),h&&h.constructor["static"].name!==a&&i.push(g.closeWindow(h))),"dialog"===f&&(e=this.getWindowManager("inspector"),d=e.getCurrentWindow(),d&&i.push(e.closeWindow(d))),$.when.apply($,i).always(function(){g.getWindow(a).then(function(a){var d=g.openWindow(a,b);j.getView().emit("position"),a.constructor["static"].activeSurface||j.getView().deactivate(),d.then(function(b){b.then(function(b){a.constructor["static"].activeSurface||j.getView().activate(),b.then(function(){j.getView().emit("position")})})}).always(function(){c&&a.executeAction(c)})})}),!0):!1},ve.ui.WindowAction.prototype.close=function(a,b){var c=this.getWindowType(a),d=c&&this.getWindowManager(c);return d?(d.closeWindow(a,b),!0):!1},ve.ui.WindowAction.prototype.toggle=function(a,b){var c,d=this.getWindowType(a),e=d&&this.getWindowManager(d);return e?(c=e.getCurrentWindow(),c&&c.constructor["static"].name===a?this.close(a,b):this.open(a,b),!0):!1},ve.ui.WindowAction.prototype.getWindowType=function(a){var b=ve.ui.windowFactory.lookup(a);return b.prototype instanceof ve.ui.FragmentInspector?"inspector":b.prototype instanceof ve.ui.ToolbarDialog?"toolbar":b.prototype instanceof OO.ui.Dialog?"dialog":null},ve.ui.WindowAction.prototype.getWindowManager=function(a){switch(a){case"inspector":return this.surface.getContext().getInspectors();case"toolbar":return this.surface.getToolbarDialogs();case"dialog":return this.surface.getDialogs()}return null},ve.ui.actionFactory.register(ve.ui.WindowAction),ve.ui.ClearAnnotationCommand=function(){ve.ui.ClearAnnotationCommand["super"].call(this,"clear","annotation","clearAll",{supportedSelections:["linear","table"]})},OO.inheritClass(ve.ui.ClearAnnotationCommand,ve.ui.Command),ve.ui.ClearAnnotationCommand.prototype.isExecutable=function(a){return ve.ui.ClearAnnotationCommand["super"].prototype.isExecutable.apply(this,arguments)&&a.hasAnnotations()},ve.ui.commandRegistry.register(new ve.ui.ClearAnnotationCommand),ve.ui.HistoryCommand=function(a,b){ve.ui.HistoryCommand["super"].call(this,a,"history",b),this.check={undo:"canUndo",redo:"canRedo"}[b]},OO.inheritClass(ve.ui.HistoryCommand,ve.ui.Command),ve.ui.HistoryCommand.prototype.isExecutable=function(a){var b=a.getSurface();return ve.ui.HistoryCommand["super"].prototype.isExecutable.apply(this,arguments)&&b[this.check].call(b)},ve.ui.commandRegistry.register(new ve.ui.HistoryCommand("undo","undo")),ve.ui.commandRegistry.register(new ve.ui.HistoryCommand("redo","redo")),ve.ui.IndentationCommand=function(a,b){ve.ui.IndentationCommand["super"].call(this,a,"indentation",b,{supportedSelections:["linear"]})},OO.inheritClass(ve.ui.IndentationCommand,ve.ui.Command),ve.ui.IndentationCommand.prototype.isExecutable=function(a){if(!ve.ui.IndentationCommand["super"].prototype.isExecutable.apply(this,arguments))return!1;var b,c,d=a.getSelectedLeafNodes(),e=!1;for(b=0,c=d.length;c>b;b++)if(d[b].hasMatchingAncestor("listItem")){e=!0;break}return e},ve.ui.commandRegistry.register(new ve.ui.IndentationCommand("indent","increase")),ve.ui.commandRegistry.register(new ve.ui.IndentationCommand("outdent","decrease")),ve.ui.MergeCellsCommand=function(){ve.ui.MergeCellsCommand["super"].call(this,"mergeCells","table","mergeCells",{supportedSelections:["table"]})},OO.inheritClass(ve.ui.MergeCellsCommand,ve.ui.Command),ve.ui.MergeCellsCommand.prototype.isExecutable=function(a){return ve.ui.MergeCellsCommand["super"].prototype.isExecutable.apply(this,arguments)&&a.getSelection().getMatrixCells(!0).length>1},ve.ui.commandRegistry.register(new ve.ui.MergeCellsCommand),ve.ui.TableCaptionCommand=function(){ve.ui.TableCaptionCommand["super"].call(this,"tableCaption","table","caption",{supportedSelections:["linear","table"]})},OO.inheritClass(ve.ui.TableCaptionCommand,ve.ui.Command),ve.ui.TableCaptionCommand.prototype.isExecutable=function(a){if(!ve.ui.TableCaptionCommand["super"].prototype.isExecutable.apply(this,arguments))return!1;var b,c,d,e,f=a.getSelection();if(f instanceof ve.dm.TableSelection)return!0;for(d=a.getSelectedLeafNodes(),e=!!d.length,b=0,c=d.length;c>b;b++)if(!d[b].hasMatchingAncestor("tableCaption")){e=!1;break}return e},ve.ui.commandRegistry.register(new ve.ui.TableCaptionCommand),ve.ui.FragmentDialog=function(a){ve.ui.FragmentDialog["super"].call(this,a),this.fragment=null},OO.inheritClass(ve.ui.FragmentDialog,OO.ui.ProcessDialog),ve.ui.FragmentDialog.prototype.getSetupProcess=function(a){return a=a||{},ve.ui.FragmentDialog["super"].prototype.getSetupProcess.apply(this,a).next(function(){if(!(a.fragment instanceof ve.dm.SurfaceFragment))throw new Error("Cannot open dialog: opening data must contain a fragment");this.fragment=a.fragment},this)},ve.ui.FragmentDialog.prototype.getTeardownProcess=function(a){return ve.ui.FragmentDialog["super"].prototype.getTeardownProcess.apply(this,a).first(function(){this.fragment.select(),this.fragment=null},this)},ve.ui.FragmentDialog.prototype.getFragment=function(){return this.fragment},ve.ui.NodeDialog=function(a){ve.ui.NodeDialog["super"].call(this,a),this.selectedNode=null},OO.inheritClass(ve.ui.NodeDialog,ve.ui.FragmentDialog),ve.ui.NodeDialog["static"].modelClasses=[],ve.ui.NodeDialog.prototype.getSelectedNode=function(){var a,b,c=this.constructor["static"].modelClasses,d=this.getFragment().getSelectedNode();for(a=0,b=c.length;b>a;a++)if(d instanceof c[a])return d;return null},ve.ui.NodeDialog.prototype.initialize=function(a){ve.ui.NodeDialog["super"].prototype.initialize.call(this,a),this.$content.addClass("ve-ui-nodeDialog")},ve.ui.NodeDialog.prototype.getSetupProcess=function(a){return ve.ui.NodeDialog["super"].prototype.getSetupProcess.call(this,a).next(function(){this.selectedNode=this.getSelectedNode(a)},this)},ve.ui.NodeDialog.prototype.getTeardownProcess=function(a){return ve.ui.NodeDialog["super"].prototype.getTeardownProcess.call(this,a).first(function(){this.selectedNode=null},this)},ve.ui.ToolbarDialog=function(a){ve.ui.ToolbarDialog["super"].call(this,a),this.disabled=!1,this.$shield=$("<div>").addClass("ve-ui-toolbarDialog-shield"),this.$element.addClass("ve-ui-toolbarDialog")},OO.inheritClass(ve.ui.ToolbarDialog,OO.ui.Dialog),ve.ui.ToolbarDialog["static"].size="full",ve.ui.ToolbarDialog["static"].activeSurface=!0,ve.ui.ToolbarDialog["static"].padded=!0,ve.ui.ToolbarDialog.prototype.initialize=function(){ve.ui.ToolbarDialog["super"].prototype.initialize.call(this),this.$body.append(this.$shield),this.$content.addClass("ve-ui-toolbarDialog-content"),this.constructor["static"].padded&&this.$element.addClass("ve-ui-toolbarDialog-padded")},ve.ui.ToolbarDialog.prototype.setDisabled=function(a){this.$content.addClass("ve-ui-toolbarDialog-content"),a!==this.disabled&&(this.disabled=a,this.$body.append(this.$shield).toggleClass("ve-ui-toolbarDialog-disabled",this.disabled))},ve.ui.CommandHelpDialog=function(a){ve.ui.CommandHelpDialog["super"].call(this,a)},OO.inheritClass(ve.ui.CommandHelpDialog,OO.ui.ProcessDialog),ve.ui.CommandHelpDialog["static"].name="commandHelp",ve.ui.CommandHelpDialog["static"].size="large",ve.ui.CommandHelpDialog["static"].title=OO.ui.deferMsg("visualeditor-dialog-command-help-title"),ve.ui.CommandHelpDialog["static"].actions=[{label:OO.ui.deferMsg("visualeditor-dialog-action-done"),flags:"safe"}],ve.ui.CommandHelpDialog.prototype.getBodyHeight=function(){return Math.round(this.contentLayout.$element[0].scrollHeight)},ve.ui.CommandHelpDialog.prototype.initialize=function(){ve.ui.CommandHelpDialog["super"].prototype.initialize.call(this);var a,b,c,d,e,f,g,h,i,j,k=ve.getSystemPlatform(),l="mac"===k?"mac":"pc",m=this.constructor["static"].getCommandGroups();this.contentLayout=new OO.ui.PanelLayout({scrollable:!0,padded:!0,expanded:!1}),this.$container=$("<div>").addClass("ve-ui-commandHelpDialog-container");for(a in m){for(g=m[a].commands,i=$("<dl>").addClass("ve-ui-commandHelpDialog-list"),b=0,c=g.length;c>b;b++){if(g[b].trigger)f=ve.ui.triggerRegistry.lookup(g[b].trigger);else for(f=[],d=0,e=g[b].shortcuts.length;e>d;d++)h=g[b].shortcuts[d],f.push(new ve.ui.Trigger(ve.isPlainObject(h)?h[l]:h,!0));for(j=$("<dt>"),d=0,e=f.length;e>d;d++)j.append($("<kbd>").text(f[d].getMessage().replace(/\+/g," + ")));i.append(j,$("<dd>").text(ve.msg(g[b].msg)))}this.$container.append($("<div>").addClass("ve-ui-commandHelpDialog-section").append($("<h3>").text(ve.msg(m[a].title)),i))}this.contentLayout.$element.append(this.$container),this.$body.append(this.contentLayout.$element)},ve.ui.CommandHelpDialog["static"].getCommandGroups=function(){return{textStyle:{title:"visualeditor-shortcuts-text-style",commands:[{trigger:"bold",msg:"visualeditor-annotationbutton-bold-tooltip"},{trigger:"italic",msg:"visualeditor-annotationbutton-italic-tooltip"},{trigger:"link",msg:"visualeditor-annotationbutton-link-tooltip"},{trigger:"superscript",msg:"visualeditor-annotationbutton-superscript-tooltip"},{trigger:"subscript",msg:"visualeditor-annotationbutton-subscript-tooltip"},{trigger:"underline",msg:"visualeditor-annotationbutton-underline-tooltip"},{trigger:"code",msg:"visualeditor-annotationbutton-code-tooltip"},{trigger:"strikethrough",msg:"visualeditor-annotationbutton-strikethrough-tooltip"},{trigger:"clear",msg:"visualeditor-clearbutton-tooltip"}]},clipboard:{title:"visualeditor-shortcuts-clipboard",commands:[{shortcuts:[{mac:"cmd+x",pc:"ctrl+x"}],msg:"visualeditor-clipboard-cut"},{shortcuts:[{mac:"cmd+c",pc:"ctrl+c"}],msg:"visualeditor-clipboard-copy"},{shortcuts:[{mac:"cmd+v",pc:"ctrl+v"}],msg:"visualeditor-clipboard-paste"},{trigger:"pasteSpecial",msg:"visualeditor-clipboard-paste-special"}]},formatting:{title:"visualeditor-shortcuts-formatting",commands:[{trigger:"paragraph",msg:"visualeditor-formatdropdown-format-paragraph"},{shortcuts:["ctrl+(1-6)"],msg:"visualeditor-formatdropdown-format-heading-label"},{trigger:"preformatted",msg:"visualeditor-formatdropdown-format-preformatted"},{trigger:"blockquote",msg:"visualeditor-formatdropdown-format-blockquote"},{trigger:"indent",msg:"visualeditor-indentationbutton-indent-tooltip"},{trigger:"outdent",msg:"visualeditor-indentationbutton-outdent-tooltip"}]},history:{title:"visualeditor-shortcuts-history",commands:[{trigger:"undo",msg:"visualeditor-historybutton-undo-tooltip"},{trigger:"redo",msg:"visualeditor-historybutton-redo-tooltip"}]},other:{title:"visualeditor-shortcuts-other",commands:[{trigger:"findAndReplace",msg:"visualeditor-find-and-replace-title"},{trigger:"findNext",msg:"visualeditor-find-and-replace-next-button"},{trigger:"findPrevious",msg:"visualeditor-find-and-replace-previous-button"},{trigger:"selectAll",msg:"visualeditor-content-select-all"},{trigger:"commandHelp",msg:"visualeditor-dialog-command-help-title"}]}}},ve.ui.windowFactory.register(ve.ui.CommandHelpDialog),ve.ui.FindAndReplaceDialog=function(a){ve.ui.FindAndReplaceDialog["super"].call(this,a),this.$element.addClass("ve-ui-findAndReplaceDialog")},OO.inheritClass(ve.ui.FindAndReplaceDialog,ve.ui.ToolbarDialog),ve.ui.FindAndReplaceDialog["static"].name="findAndReplace",ve.ui.FindAndReplaceDialog["static"].title=OO.ui.deferMsg("visualeditor-find-and-replace-title"),ve.ui.FindAndReplaceDialog["static"].maxRenderedResults=100,ve.ui.FindAndReplaceDialog.prototype.initialize=function(){ve.ui.FindAndReplaceDialog["super"].prototype.initialize.call(this),this.surface=null,this.invalidRegex=!1,this.$findResults=$("<div>").addClass("ve-ui-findAndReplaceDialog-findResults"),this.initialFragment=null,this.fragments=[],this.results=0,this.renderedFragments=null,this.replacing=!1,this.focusedIndex=0,this.query=null,this.findText=new OO.ui.TextInputWidget({placeholder:ve.msg("visualeditor-find-and-replace-find-text"),validate:function(a){return function(){return!a.invalidRegex}}(this)}),this.matchCaseToggle=new OO.ui.ToggleButtonWidget({icon:"searchCaseSensitive",iconTitle:ve.msg("visualeditor-find-and-replace-match-case")}),this.regexToggle=new OO.ui.ToggleButtonWidget({icon:"searchRegularExpression",iconTitle:ve.msg("visualeditor-find-and-replace-regular-expression")}),this.previousButton=new OO.ui.ButtonWidget({icon:"previous",iconTitle:ve.msg("visualeditor-find-and-replace-previous-button")+" "+ve.ui.triggerRegistry.getMessages("findPrevious").join(", ")}),this.nextButton=new OO.ui.ButtonWidget({icon:"next",iconTitle:ve.msg("visualeditor-find-and-replace-next-button")+" "+ve.ui.triggerRegistry.getMessages("findNext").join(", ")}),this.replaceText=new OO.ui.TextInputWidget({placeholder:ve.msg("visualeditor-find-and-replace-replace-text")}),this.replaceButton=new OO.ui.ButtonWidget({label:ve.msg("visualeditor-find-and-replace-replace-button")}),this.replaceAllButton=new OO.ui.ButtonWidget({label:ve.msg("visualeditor-find-and-replace-replace-all-button")});var a=new OO.ui.ButtonGroupWidget({classes:["ve-ui-findAndReplaceDialog-cell"],items:[this.matchCaseToggle,this.regexToggle]}),b=new OO.ui.ButtonGroupWidget({classes:["ve-ui-findAndReplaceDialog-cell"],items:[this.previousButton,this.nextButton]}),c=new OO.ui.ButtonGroupWidget({classes:["ve-ui-findAndReplaceDialog-cell"],items:[this.replaceButton,this.replaceAllButton]}),d=new OO.ui.ButtonWidget({classes:["ve-ui-findAndReplaceDialog-cell"],label:ve.msg("visualeditor-find-and-replace-done")}),e=$("<div>").addClass("ve-ui-findAndReplaceDialog-row"),f=$("<div>").addClass("ve-ui-findAndReplaceDialog-row");this.onWindowScrollDebounced=ve.debounce(this.onWindowScroll.bind(this),250),this.updateFragmentsDebounced=ve.debounce(this.updateFragments.bind(this)),this.renderFragmentsDebounced=ve.debounce(this.renderFragments.bind(this)),this.findText.connect(this,{change:"onFindChange",enter:"onFindTextEnter"}),this.matchCaseToggle.connect(this,{change:"onFindChange"}),this.regexToggle.connect(this,{change:"onFindChange"}),this.nextButton.connect(this,{click:"findNext"}),this.previousButton.connect(this,{click:"findPrevious"}),this.replaceButton.connect(this,{click:"onReplaceButtonClick"}),this.replaceAllButton.connect(this,{click:"onReplaceAllButtonClick"}),d.connect(this,{click:"close"}),this.findText.$input.prop("tabIndex",1),this.replaceText.$input.prop("tabIndex",2),this.$content.addClass("ve-ui-findAndReplaceDialog-content"),this.$body.append(e.append($("<div>").addClass("ve-ui-findAndReplaceDialog-cell ve-ui-findAndReplaceDialog-cell-input").append(this.findText.$element),b.$element,a.$element),f.append($("<div>").addClass("ve-ui-findAndReplaceDialog-cell ve-ui-findAndReplaceDialog-cell-input").append(this.replaceText.$element),c.$element,d.$element))},ve.ui.FindAndReplaceDialog.prototype.getSetupProcess=function(a){return a=a||{},ve.ui.FindAndReplaceDialog["super"].prototype.getSetupProcess.call(this,a).first(function(){var b,c=a.fragment;this.surface=a.surface,this.surface.$selections.append(this.$findResults),this.surface.getModel().connect(this,{documentUpdate:this.updateFragmentsDebounced}),this.surface.getView().connect(this,{position:this.renderFragmentsDebounced}),this.surface.getView().$window.on("scroll",this.onWindowScrollDebounced),b=c.getText(),b&&b!==this.findText.getValue()?this.findText.setValue(b):this.onFindChange(),this.initialFragment=c},this)},ve.ui.FindAndReplaceDialog.prototype.getReadyProcess=function(a){return ve.ui.FindAndReplaceDialog["super"].prototype.getReadyProcess.call(this,a).next(function(){this.findText.focus().select()},this)},ve.ui.FindAndReplaceDialog.prototype.getTeardownProcess=function(a){return ve.ui.FindAndReplaceDialog["super"].prototype.getTeardownProcess.call(this,a).next(function(){var a,b=this.surface.getView(),c=this.surface.getModel();this.surface.getModel().disconnect(this),b.disconnect(this),this.surface.getView().$window.off("scroll",this.onWindowScrollDebounced),c.getSelection()instanceof ve.dm.NullSelection&&(this.fragments.length?a=this.fragments[this.focusedIndex].getSelection():this.initialFragment.getSelection()instanceof ve.dm.NullSelection||(a=this.initialFragment.getSelection())),a?c.setSelection(a):b.focus(),this.$findResults.empty().detach(),this.fragments=[],this.surface=null},this)},ve.ui.FindAndReplaceDialog.prototype.onWindowScroll=function(){this.renderedFragments.getLength()<this.results&&this.renderFragments()},ve.ui.FindAndReplaceDialog.prototype.onFindChange=function(){this.updateFragments(),this.renderFragments(),this.highlightFocused(!0)},ve.ui.FindAndReplaceDialog.prototype.onFindTextEnter=function(a){this.results&&(a.shiftKey?this.findPrevious():this.findNext())},ve.ui.FindAndReplaceDialog.prototype.updateFragments=function(){var a,b,c=this.surface.getModel(),d=c.getDocument(),e=[],f=this.matchCaseToggle.getValue(),g=this.regexToggle.getValue(),h=this.findText.getValue();if(this.invalidRegex=!1,g&&h)try{this.query=new RegExp(h)}catch(i){this.invalidRegex=!0}else this.query=h;if(this.findText.setValidityFlag(),this.fragments=[],this.query)for(e=d.findText(this.query,f,!0),a=0,b=e.length;b>a;a++)this.fragments.push(c.getLinearFragment(e[a],!0,!0));this.results=this.fragments.length,this.focusedIndex=Math.min(this.focusedIndex,this.results?this.results-1:0),this.nextButton.setDisabled(!this.results),this.previousButton.setDisabled(!this.results),this.replaceButton.setDisabled(!this.results),this.replaceAllButton.setDisabled(!this.results)},ve.ui.FindAndReplaceDialog.prototype.renderFragments=function(){if(!this.replacing){var a,b,c,d=0,e=this.results;if(this.results>50)for(c=this.surface.getView().getViewportRange(),a=0;a<this.results;a++)if(b=this.fragments[a].getSelection(),c&&b.getRange().start<c.start)d=a+1;else if(c&&b.getRange().end>c.end){e=a;break}this.renderRangeOfFragments(e-d<=this.constructor["static"].maxRenderedResults?new ve.Range(d,e):new ve.Range(this.focusedIndex,this.focusedIndex+1))}},ve.ui.FindAndReplaceDialog.prototype.renderRangeOfFragments=function(a){var b,c,d,e,f,g;for(this.$findResults.empty(),b=a.start;b<a.end;b++){for(e=this.surface.getView().getSelectionRects(this.fragments[b].getSelection()),f=$("<div>").addClass("ve-ui-findAndReplaceDialog-findResult"),g=1/0,c=0,d=e.length;d>c;c++)g=Math.min(g,e[c].top),f.append($("<div>").css({top:e[c].top,left:e[c].left,width:e[c].width,height:e[c].height}));f.data("top",g),this.$findResults.append(f)}this.renderedFragments=a,this.highlightFocused()},ve.ui.FindAndReplaceDialog.prototype.highlightFocused=function(a){var b,c,d,e,f,g,h=this.surface.getView();return this.results?(this.findText.setLabel(ve.msg("visualeditor-find-and-replace-results",this.focusedIndex+1,this.results)),this.$findResults.find(".ve-ui-findAndReplaceDialog-findResult-focused").removeClass("ve-ui-findAndReplaceDialog-findResult-focused"),this.renderedFragments.containsOffset(this.focusedIndex)?(b=this.$findResults.children().eq(this.focusedIndex-this.renderedFragments.start).addClass("ve-ui-findAndReplaceDialog-findResult-focused"),d=b.data("top")):a&&(c=h.getSelectionBoundingRect(this.fragments[this.focusedIndex].getSelection()),d=c.top),void(a&&(h=this.surface.getView(),e=d+h.$element.offset().top,f=h.$window.scrollTop()+this.surface.toolbarHeight,g=h.$window.height()-this.surface.toolbarHeight,(f>e||e>f+g)&&$("body, html").animate({scrollTop:e-g/2},"fast")))):void this.findText.setLabel(this.invalidRegex?ve.msg("visualeditor-find-and-replace-invalid-regex"):"")
},ve.ui.FindAndReplaceDialog.prototype.findNext=function(){this.focusedIndex=(this.focusedIndex+1)%this.results,this.highlightFocused(!0)},ve.ui.FindAndReplaceDialog.prototype.findPrevious=function(){this.focusedIndex=(this.focusedIndex+this.results-1)%this.results,this.highlightFocused(!0)},ve.ui.FindAndReplaceDialog.prototype.onReplaceButtonClick=function(){var a;if(this.results){if(this.replace(this.focusedIndex),a=this.fragments[this.focusedIndex].getSelection().getRange().end,this.updateFragments(),!this.results)return void(this.focusedIndex=0);for(;this.fragments[this.focusedIndex]&&this.fragments[this.focusedIndex].getSelection().getRange().end<=a;)this.focusedIndex++;this.focusedIndex=this.focusedIndex%this.results}},ve.ui.FindAndReplaceDialog.prototype.onReplaceAllButtonClick=function(){var a,b;for(a=0,b=this.results;b>a;a++)this.replace(a)},ve.ui.FindAndReplaceDialog.prototype.replace=function(a){var b=this.replaceText.getValue();this.query instanceof RegExp?this.fragments[a].insertContent(this.fragments[a].getText().replace(this.query,b),!0):this.fragments[a].insertContent(b,!0)},ve.ui.FindAndReplaceDialog.prototype.getActionProcess=function(a){return"findNext"===a||"findPrevious"===a?new OO.ui.Process(this[a],this):ve.ui.FindAndReplaceDialog["super"].prototype.getActionProcess.call(this,a)},ve.ui.windowFactory.register(ve.ui.FindAndReplaceDialog),ve.ui.ProgressDialog=function(a){ve.ui.ProgressDialog["super"].call(this,a)},OO.inheritClass(ve.ui.ProgressDialog,OO.ui.MessageDialog),ve.ui.ProgressDialog["static"].name="progress",ve.ui.ProgressDialog["static"].size="medium",ve.ui.ProgressDialog["static"].actions=[{action:"cancel",label:OO.ui.deferMsg("visualeditor-dialog-action-cancel"),flags:"destructive"}],ve.ui.ProgressDialog.prototype.initialize=function(){ve.ui.ProgressDialog["super"].prototype.initialize.call(this),this.inProgress=0,this.cancelDeferreds=[]},ve.ui.ProgressDialog.prototype.getSetupProcess=function(a){return a=a||{},ve.ui.ProgressDialog["super"].prototype.getSetupProcess.call(this,a).next(function(){var b,c,d,e,f,g,h,i=a.progresses;for(this.inProgress=i.length,this.text.$element.empty(),this.cancelDeferreds=[],b=0,c=i.length;c>b;b++)h=$.Deferred(),d=$("<div>").addClass("ve-ui-progressDialog-row"),e=new OO.ui.ProgressBarWidget,f=new OO.ui.FieldLayout(e,{label:i[b].label,align:"top"}),g=new OO.ui.ButtonWidget({framed:!1,icon:"cancel",iconTitle:OO.ui.deferMsg("visualeditor-dialog-action-cancel")}).on("click",h.reject.bind(h)),this.text.$element.append(d.append(f.$element,g.$element)),i[b].progressBarDeferred.resolve(e,h.promise()),i[b].progressCompletePromise.then(this.progressComplete.bind(this,d,!1),this.progressComplete.bind(this,d,!0)),this.cancelDeferreds.push(h)},this)},ve.ui.ProgressDialog.prototype.getActionProcess=function(a){return new OO.ui.Process(function(){var b,c;if("cancel"===a)for(b=0,c=this.cancelDeferreds.length;c>b;b++)this.cancelDeferreds[b].reject();this.close({action:a})},this)},ve.ui.ProgressDialog.prototype.progressComplete=function(a,b){this.inProgress--,this.inProgress||this.close(),b&&(a.remove(),this.updateSize())},ve.ui.windowFactory.register(ve.ui.ProgressDialog),ve.ui.SpecialCharacterDialog=function(a){ve.ui.ToolbarDialog.call(this,a),this.characters=null,this.$buttonDomList=null,this.categories=null,this.$element.addClass("ve-ui-specialCharacterDialog")},OO.inheritClass(ve.ui.SpecialCharacterDialog,ve.ui.ToolbarDialog),ve.ui.SpecialCharacterDialog["static"].name="specialCharacter",ve.ui.SpecialCharacterDialog["static"].title=OO.ui.deferMsg("visualeditor-specialCharacterDialog-title"),ve.ui.SpecialCharacterDialog["static"].size="full",ve.ui.SpecialCharacterDialog["static"].padded=!1,ve.ui.SpecialCharacterDialog.prototype.initialize=function(){ve.ui.SpecialCharacterDialog["super"].prototype.initialize.call(this),this.$spinner=$("<div>").addClass("ve-ui-specialCharacterDialog-spinner"),this.$content.append(this.$spinner)},ve.ui.SpecialCharacterDialog.prototype.getSetupProcess=function(a){return ve.ui.SpecialCharacterDialog["super"].prototype.getSetupProcess.call(this,a).next(function(){this.surface=a.surface,this.surface.getView().focus(),this.surface.getModel().connect(this,{contextChange:"onContextChange"});var b=this;this.characters||(this.$spinner.show(),ve.init.platform.fetchSpecialCharList().done(function(a){b.characters=a,b.buildButtonList()}).always(function(){b.$spinner.hide()}))},this)},ve.ui.SpecialCharacterDialog.prototype.getTeardownProcess=function(a){return a=a||{},ve.ui.SpecialCharacterDialog["super"].prototype.getTeardownProcess.call(this,a).first(function(){this.surface.getModel().disconnect(this),this.surface=null},this)},ve.ui.SpecialCharacterDialog.prototype.getReadyProcess=function(a){return a=a||{},ve.ui.SpecialCharacterDialog["super"].prototype.getReadyProcess.call(this,a).first(function(){this.surface.getView().focus()},this)},ve.ui.SpecialCharacterDialog.prototype.getActionProcess=function(a){return new OO.ui.Process(function(){this.close({action:a})},this)},ve.ui.SpecialCharacterDialog.prototype.onContextChange=function(){this.setDisabled(!(this.surface.getModel().getSelection()instanceof ve.dm.LinearSelection))},ve.ui.SpecialCharacterDialog.prototype.buildButtonList=function(){var a;this.bookletLayout=new OO.ui.BookletLayout({outlined:!0,continuous:!0}),this.pages=[];for(a in this.characters)this.pages.push(new ve.ui.SpecialCharacterPage(a,{label:a,characters:this.characters[a]}));this.bookletLayout.addPages(this.pages),this.bookletLayout.$element.on("click",".ve-ui-specialCharacterPage-character",this.onListClick.bind(this)),this.$body.append(this.bookletLayout.$element)},ve.ui.SpecialCharacterDialog.prototype.onListClick=function(a){var b=$(a.target).data("character"),c=this.surface.getModel().getFragment();b&&("string"==typeof b?c.insertContent(b,!0).collapseToEnd().select():"replace"===b.action.type?c.insertContent(b.action.options.peri,!0).collapseToEnd().select():"encapsulate"===b.action.type&&(c.collapseToStart().insertContent(b.action.options.pre,!0),c.collapseToEnd().insertContent(b.action.options.post,!0).collapseToEnd().select()))},ve.ui.windowFactory.register(ve.ui.SpecialCharacterDialog),ve.ui.HTMLStringTransferHandler=function(){ve.ui.HTMLStringTransferHandler["super"].apply(this,arguments)},OO.inheritClass(ve.ui.HTMLStringTransferHandler,ve.ui.DataTransferHandler),ve.ui.HTMLStringTransferHandler["static"].name="htmlString",ve.ui.HTMLStringTransferHandler["static"].types=["text/html","application/xhtml+xml"],ve.ui.HTMLStringTransferHandler["static"].handlesPaste=!1,ve.ui.HTMLStringTransferHandler.prototype.process=function(){this.insertableDataDeferred.resolve(this.surface.getModel().getDocument().newFromHtml(this.item.getAsString(),this.surface.getImportRules()))},ve.ui.dataTransferHandlerFactory.register(ve.ui.HTMLStringTransferHandler),ve.ui.PlainTextStringTransferHandler=function(){ve.ui.PlainTextStringTransferHandler["super"].apply(this,arguments)},OO.inheritClass(ve.ui.PlainTextStringTransferHandler,ve.ui.DataTransferHandler),ve.ui.PlainTextStringTransferHandler["static"].name="plainTextString",ve.ui.PlainTextStringTransferHandler["static"].types=["text/plain"],ve.ui.PlainTextStringTransferHandler["static"].handlesPaste=!1,ve.ui.PlainTextStringTransferHandler.prototype.process=function(){this.insertableDataDeferred.resolve(this.item.getAsString())},ve.ui.dataTransferHandlerFactory.register(ve.ui.PlainTextStringTransferHandler),ve.ui.DSVFileTransferHandler=function(){ve.ui.DSVFileTransferHandler["super"].apply(this,arguments)},OO.inheritClass(ve.ui.DSVFileTransferHandler,ve.ui.FileTransferHandler),ve.ui.DSVFileTransferHandler["static"].name="dsv",ve.ui.DSVFileTransferHandler["static"].types=["text/csv","text/tab-separated-values"],ve.ui.DSVFileTransferHandler["static"].extensions=["csv","tsv"],ve.ui.DSVFileTransferHandler.prototype.process=function(){this.createProgress(this.insertableDataDeferred.promise()),this.reader.readAsText(this.file)},ve.ui.DSVFileTransferHandler.prototype.onFileProgress=function(a){this.setProgress(a.lengthComputable?100*a.loaded/a.total:!1)},ve.ui.DSVFileTransferHandler.prototype.onFileLoad=function(){var a,b,c,d=[],e=Papa.parse(this.reader.result);if(e.meta.aborted||e.data.length<=0)return void this.insertableDataDeferred.reject();for(d.push({type:"table"}),d.push({type:"tableSection",attributes:{style:"body"}}),a=0;a<e.data.length;a++){for(d.push({type:"tableRow"}),c=e.data[a],b=0;b<c.length;b++)d.push({type:"tableCell",attributes:{style:0===a?"header":"data"}}),d.push({type:"paragraph",internal:{generated:"wrapper"}}),d=d.concat(c[b].split("")),d.push({type:"/paragraph"}),d.push({type:"/tableCell"});d.push({type:"/tableRow"})}d.push({type:"/tableSection"}),d.push({type:"/table"}),this.insertableDataDeferred.resolve(d),this.setProgress(100)},ve.ui.DSVFileTransferHandler.prototype.onFileLoadEnd=function(){this.insertableDataDeferred.reject()},ve.ui.DSVFileTransferHandler.prototype.abort=function(){ve.ui.DSVFileTransferHandler["super"].prototype.abort.call(this),this.reader.abort()},ve.ui.dataTransferHandlerFactory.register(ve.ui.DSVFileTransferHandler),ve.ui.PlainTextFileTransferHandler=function(){ve.ui.PlainTextFileTransferHandler["super"].apply(this,arguments)},OO.inheritClass(ve.ui.PlainTextFileTransferHandler,ve.ui.FileTransferHandler),ve.ui.PlainTextFileTransferHandler["static"].name="plainTextFile",ve.ui.PlainTextFileTransferHandler["static"].types=["text/plain"],ve.ui.PlainTextFileTransferHandler["static"].extension=["txt"],ve.ui.PlainTextFileTransferHandler.prototype.process=function(){this.createProgress(this.insertableDataDeferred.promise()),this.reader.readAsText(this.file)},ve.ui.PlainTextFileTransferHandler.prototype.onFileProgress=function(a){this.setProgress(a.lengthComputable?100*a.loaded/a.total:!1)},ve.ui.PlainTextFileTransferHandler.prototype.onFileLoad=function(){this.insertableDataDeferred.resolve(this.reader.result),this.setProgress(100)},ve.ui.PlainTextFileTransferHandler.prototype.onFileLoadEnd=function(){this.insertableDataDeferred.reject()},ve.ui.PlainTextFileTransferHandler.prototype.abort=function(){ve.ui.PlainTextFileTransferHandler["super"].prototype.abort.call(this),this.reader.abort()},ve.ui.dataTransferHandlerFactory.register(ve.ui.PlainTextFileTransferHandler),ve.ui.HTMLFileTransferHandler=function(){ve.ui.HTMLFileTransferHandler["super"].apply(this,arguments)},OO.inheritClass(ve.ui.HTMLFileTransferHandler,ve.ui.FileTransferHandler),ve.ui.HTMLFileTransferHandler["static"].name="htmlFile",ve.ui.HTMLFileTransferHandler["static"].types=["text/html","application/xhtml+xml"],ve.ui.HTMLFileTransferHandler["static"].extensions=["html","htm","xhtml"],ve.ui.HTMLFileTransferHandler.prototype.process=function(){this.createProgress(this.insertableDataDeferred.promise()),this.reader.readAsText(this.file)},ve.ui.HTMLFileTransferHandler.prototype.onFileProgress=function(a){this.setProgress(a.lengthComputable?100*a.loaded/a.total:!1)},ve.ui.HTMLFileTransferHandler.prototype.onFileLoad=function(){this.insertableDataDeferred.resolve(this.surface.getModel().getDocument().newFromHtml(this.reader.result,this.surface.getImportRules())),this.setProgress(100)},ve.ui.HTMLFileTransferHandler.prototype.onFileLoadEnd=function(){this.insertableDataDeferred.reject()},ve.ui.HTMLFileTransferHandler.prototype.abort=function(){ve.ui.HTMLFileTransferHandler["super"].prototype.abort.call(this),this.reader.abort()},ve.ui.dataTransferHandlerFactory.register(ve.ui.HTMLFileTransferHandler),ve.ui.ToolbarDialogWindowManager=function(a,b){ve.ui.ToolbarDialogWindowManager["super"].call(this,a,b)},OO.inheritClass(ve.ui.ToolbarDialogWindowManager,ve.ui.SurfaceWindowManager),ve.ui.ToolbarDialogWindowManager["static"].sizes=ve.copy(ve.ui.ToolbarDialogWindowManager["super"]["static"].sizes),ve.ui.ToolbarDialogWindowManager["static"].sizes.full={width:"100%",maxHeight:"100%"},ve.ui.ToolbarDialogWindowManager.prototype.getTeardownDelay=function(){return 250},ve.ui.AlignWidget=function(a){a=a||{},ve.ui.AlignWidget["super"].call(this,a);var b=[new OO.ui.ButtonOptionWidget({data:"left",icon:"alignLeft",label:ve.msg("visualeditor-align-widget-left")}),new OO.ui.ButtonOptionWidget({data:"center",icon:"alignCentre",label:ve.msg("visualeditor-align-widget-center")}),new OO.ui.ButtonOptionWidget({data:"right",icon:"alignRight",label:ve.msg("visualeditor-align-widget-right")})];"rtl"===a.dir&&(b=b.reverse()),this.addItems(b,0)},OO.inheritClass(ve.ui.AlignWidget,OO.ui.ButtonSelectWidget),ve.ui.LanguageSearchWidget=function(a){a=ve.extendObject({placeholder:ve.msg("visualeditor-language-search-input-placeholder")},a),OO.ui.SearchWidget.call(this,a),this.languageResultWidgets=[],this.filteredLanguageResultWidgets=[];var b,c,d,e=ve.init.platform.getLanguageCodes().sort();for(b=0,c=e.length;c>b;b++)d=e[b],this.languageResultWidgets.push(new ve.ui.LanguageResultWidget({data:{code:d,name:ve.init.platform.getLanguageName(d),autonym:ve.init.platform.getLanguageAutonym(d)}}));this.setAvailableLanguages(),this.$element.addClass("ve-ui-languageSearchWidget")},OO.inheritClass(ve.ui.LanguageSearchWidget,OO.ui.SearchWidget),ve.ui.LanguageSearchWidget.prototype.onQueryChange=function(){OO.ui.SearchWidget.prototype.onQueryChange.call(this),this.addResults()},ve.ui.LanguageSearchWidget.prototype.setAvailableLanguages=function(a){if(!a)return void(this.filteredLanguageResultWidgets=this.languageResultWidgets.slice());var b,c,d,e;for(this.filteredLanguageResultWidgets=[],b=0,c=this.languageResultWidgets.length;c>b;b++)d=this.languageResultWidgets[b],e=d.getData(),-1!==a.indexOf(e.code)&&this.filteredLanguageResultWidgets.push(d)},ve.ui.LanguageSearchWidget.prototype.addResults=function(){var a,b,c,d,e,f,g,h=["name","autonym","code"],i=this.query.getValue().trim(),j=new RegExp("^"+this.constructor["static"].escapeRegex(i),"i"),k=!!i.length,l=[];for(this.results.clearItems(),a=0,b=this.filteredLanguageResultWidgets.length;b>a;a++){for(e=this.filteredLanguageResultWidgets[a],f=e.getData(),g=null,c=0,d=h.length;d>c;c++)if(j.test(f[h[c]])){g=h[c];break}(""===i||g)&&l.push(e.updateLabel(i,g).setSelected(!1).setHighlighted(!1))}this.results.addItems(l),k&&this.results.highlightItem(this.results.getFirstSelectableItem())},ve.ui.LanguageSearchWidget["static"].escapeRegex=function(a){return a.replace(/[\-\[\]{}()*+?.,\\\^$\|#\s]/g,"\\$&")},ve.ui.LanguageResultWidget=function(a){OO.ui.OptionWidget.call(this,a),this.$element.addClass("ve-ui-languageResultWidget"),this.$name=$("<div>").addClass("ve-ui-languageResultWidget-name"),this.$otherMatch=$("<div>").addClass("ve-ui-languageResultWidget-otherMatch"),this.setLabel(this.$otherMatch.add(this.$name))},OO.inheritClass(ve.ui.LanguageResultWidget,OO.ui.OptionWidget),ve.ui.LanguageResultWidget.prototype.updateLabel=function(a,b){var c,d=this.getData();return this.$name.text(d.name),this.$otherMatch.text(d.code),b&&(c=ve.highlightQuery(d[b],a),"name"===b?this.$name.empty().append(c):this.$otherMatch.empty().append(c)),this},ve.ui.LanguageSearchDialog=function(a){ve.ui.LanguageSearchDialog["super"].call(this,a)},OO.inheritClass(ve.ui.LanguageSearchDialog,OO.ui.ProcessDialog),ve.ui.LanguageSearchDialog["static"].name="languageSearch",ve.ui.LanguageSearchDialog["static"].size="medium",ve.ui.LanguageSearchDialog["static"].title=OO.ui.deferMsg("visualeditor-dialog-language-search-title"),ve.ui.LanguageSearchDialog["static"].actions=[{label:OO.ui.deferMsg("visualeditor-dialog-action-cancel")}],ve.ui.LanguageSearchDialog["static"].languageSearchWidget=ve.ui.LanguageSearchWidget,ve.ui.LanguageSearchDialog.prototype.initialize=function(){ve.ui.LanguageSearchDialog["super"].prototype.initialize.apply(this,arguments),this.searchWidget=new this.constructor["static"].languageSearchWidget,this.searchWidget.getResults().connect(this,{choose:"onSearchResultsChoose"}),this.$body.append(this.searchWidget.$element)},ve.ui.LanguageSearchDialog.prototype.onSearchResultsChoose=function(a){var b=a.getData();this.close({action:"apply",lang:b.code,dir:ve.init.platform.getLanguageDirection(b.code)})},ve.ui.LanguageSearchDialog.prototype.getSetupProcess=function(a){return ve.ui.LanguageSearchDialog["super"].prototype.getSetupProcess.call(this,a).next(function(){this.searchWidget.setAvailableLanguages(a.availableLanguages),this.searchWidget.addResults()},this)},ve.ui.LanguageSearchDialog.prototype.getReadyProcess=function(a){return ve.ui.LanguageSearchDialog["super"].prototype.getReadyProcess.call(this,a).next(function(){this.searchWidget.getQuery().focus()},this)},ve.ui.LanguageSearchDialog.prototype.getTeardownProcess=function(a){return ve.ui.LanguageSearchDialog["super"].prototype.getTeardownProcess.call(this,a).first(function(){this.searchWidget.getQuery().setValue("")},this)},ve.ui.LanguageSearchDialog.prototype.getBodyHeight=function(){return 300},ve.ui.windowFactory.register(ve.ui.LanguageSearchDialog),ve.ui.LanguageInputWidget=function(a){a=a||{},OO.ui.Widget.call(this,a),this.lang=null,this.dir=null,this.overlay=new ve.ui.Overlay({classes:["ve-ui-overlay-global"]}),this.dialogs=a.dialogManager||new ve.ui.WindowManager({factory:ve.ui.windowFactory,isolate:!0}),this.availableLanguages=a.availableLanguages,this.findLanguageButton=new OO.ui.ButtonWidget({classes:["ve-ui-languageInputWidget-findLanguageButton"],label:ve.msg("visualeditor-languageinspector-widget-changelang"),indicator:"next"}),this.languageCodeTextInput=new OO.ui.TextInputWidget({classes:["ve-ui-languageInputWidget-languageCodeTextInput"]}),this.directionSelect=new OO.ui.ButtonSelectWidget({classes:["ve-ui-languageInputWidget-directionSelect"]}),this.findLanguageField=new OO.ui.FieldLayout(this.findLanguageButton,{align:"left",label:ve.msg("visualeditor-languageinspector-widget-label-language")}),this.languageCodeField=new OO.ui.FieldLayout(this.languageCodeTextInput,{align:"left",label:ve.msg("visualeditor-languageinspector-widget-label-langcode")}),this.directionField=new OO.ui.FieldLayout(this.directionSelect,{align:"left",label:ve.msg("visualeditor-languageinspector-widget-label-direction")}),this.findLanguageButton.connect(this,{click:"onFindLanguageButtonClick"}),this.languageCodeTextInput.connect(this,{change:"onChange"}),this.directionSelect.connect(this,{select:"onChange"});var b=[new OO.ui.ButtonOptionWidget({data:"rtl",icon:"textDirRTL"}),new OO.ui.ButtonOptionWidget({data:"ltr",icon:"textDirLTR"})];a.requireDir||b.splice(1,0,new OO.ui.ButtonOptionWidget({data:null,label:ve.msg("visualeditor-dialog-language-auto-direction")})),this.directionSelect.addItems(b),this.overlay.$element.append(this.dialogs.$element),$("body").append(this.overlay.$element),this.$element.addClass("ve-ui-languageInputWidget").append(this.findLanguageField.$element,this.languageCodeField.$element,this.directionField.$element)},OO.inheritClass(ve.ui.LanguageInputWidget,OO.ui.Widget),ve.ui.LanguageInputWidget.prototype.onFindLanguageButtonClick=function(){var a=this;this.dialogs.openWindow("languageSearch",{availableLanguages:this.availableLanguages}).then(function(b){b.then(function(b){b.then(function(b){b=b||{},"apply"===b.action&&a.setLangAndDir(b.lang,b.dir)})})})},ve.ui.LanguageInputWidget.prototype.onChange=function(){if(!this.updating){var a=this.directionSelect.getSelectedItem();this.setLangAndDir(this.languageCodeTextInput.getValue(),a?a.getData():null)}},ve.ui.LanguageInputWidget.prototype.setLangAndDir=function(a,b){(a!==this.lang||b!==this.dir)&&(this.updating=!0,a||b?(a=a||"",this.languageCodeTextInput.setValue(a),this.findLanguageButton.setLabel(ve.init.platform.getLanguageName(a.toLowerCase())||ve.msg("visualeditor-languageinspector-widget-changelang")),this.directionSelect.selectItemByData(b)):(this.languageCodeTextInput.setValue(""),this.findLanguageButton.setLabel(ve.msg("visualeditor-languageinspector-widget-changelang")),this.directionSelect.selectItem(null)),this.updating=!1,this.emit("change",a,b),this.lang=a,this.dir=b)},ve.ui.LanguageInputWidget.prototype.getLang=function(){return this.lang},ve.ui.LanguageInputWidget.prototype.getDir=function(){return this.dir},ve.ui.SurfaceWidget=function(a,b){b=b||{},OO.ui.Widget.call(this,b),this.surface=ve.init.target.createSurface(a,{excludeCommands:b.excludeCommands,importRules:b.importRules,inDialog:b.inDialog}),this.toolbar=new ve.ui.Toolbar,this.surface.$element.addClass("ve-ui-surfaceWidget-surface"),this.toolbar.$element.addClass("ve-ui-surfaceWidget-toolbar"),this.toolbar.$bar.append(this.surface.getToolbarDialogs().$element),this.$element.addClass("ve-ui-surfaceWidget").append(this.toolbar.$element,this.surface.$element),b.tools&&this.toolbar.setup(b.tools,this.surface)},OO.inheritClass(ve.ui.SurfaceWidget,OO.ui.Widget),ve.ui.SurfaceWidget.prototype.getSurface=function(){return this.surface},ve.ui.SurfaceWidget.prototype.getToolbar=function(){return this.toolbar},ve.ui.SurfaceWidget.prototype.getContent=function(){return this.surface.getModel().getDocument().getData()},ve.ui.SurfaceWidget.prototype.initialize=function(){this.toolbar.initialize(),this.surface.initialize()},ve.ui.SurfaceWidget.prototype.destroy=function(){this.surface&&this.surface.destroy(),this.toolbar&&this.toolbar.destroy(),this.$element.remove()},ve.ui.SurfaceWidget.prototype.focus=function(){this.surface.getView().focus()},ve.ui.LinkAnnotationWidget=function(a){this.annotation=null,this.text=this.createInputWidget(a),ve.ui.LinkAnnotationWidget["super"].apply(this,arguments),this.$element.append(this.text.$element).addClass("ve-ui-linkAnnotationWidget"),this.text.connect(this,{change:"onTextChange"})},OO.inheritClass(ve.ui.LinkAnnotationWidget,OO.ui.Widget),ve.ui.LinkAnnotationWidget["static"].getAnnotationFromText=function(a){var b=a.trim();return""===b?null:new ve.dm.LinkAnnotation({type:"link",attributes:{href:b}})},ve.ui.LinkAnnotationWidget["static"].getTextFromAnnotation=function(a){return a?a.getHref():""},ve.ui.LinkAnnotationWidget.prototype.createInputWidget=function(){return new OO.ui.TextInputWidget({validate:"non-empty"})},ve.ui.LinkAnnotationWidget.prototype.setDisabled=function(){ve.ui.LinkAnnotationWidget["super"].prototype.setDisabled.apply(this,arguments),this.text.setDisabled(this.isDisabled())},ve.ui.LinkAnnotationWidget.prototype.onTextChange=function(a){var b,c=this;$("body").hasClass("rtl")&&(b=ve.init.platform.getExternalLinkUrlProtocolsRegExp().test(a.trim()),this.text.setRTL(!b)),this.text.isValid().done(function(b){c.setAnnotation(b?c.constructor["static"].getAnnotationFromText(a):null,!0)})},ve.ui.LinkAnnotationWidget.prototype.setAnnotation=function(a,b){return ve.compare(a?a.getComparableObject():{},this.annotation?this.annotation.getComparableObject():{})?this:(this.annotation=a,b||this.text.setValue(this.constructor["static"].getTextFromAnnotation(a)),this.emit("change",this.annotation),this)},ve.ui.LinkAnnotationWidget.prototype.getAnnotation=function(){return this.annotation},ve.ui.LinkAnnotationWidget.prototype.getHref=function(){return this.constructor["static"].getTextFromAnnotation(this.annotation)},ve.ui.ContextSelectWidget=function(a){a=a||{},ve.ui.ContextSelectWidget["super"].call(this,a),this.connect(this,{choose:"onChooseItem"}),this.$element.addClass("ve-ui-contextSelectWidget")},OO.inheritClass(ve.ui.ContextSelectWidget,OO.ui.SelectWidget),ve.ui.ContextSelectWidget.prototype.onChooseItem=function(){this.selectItem(null)},ve.ui.ContextOptionWidget=function(a,b,c){c=c||{},ve.ui.ContextOptionWidget["super"].call(this,c),this.tool=a,this.model=b,this.$element.addClass("ve-ui-contextOptionWidget"),this.setIcon(this.tool["static"].icon),this.setLabel(this.getDescription())},OO.inheritClass(ve.ui.ContextOptionWidget,OO.ui.DecoratedOptionWidget),ve.ui.ContextOptionWidget.prototype.getDescription=function(){var a;return this.model instanceof ve.dm.Annotation?a=ve.ce.annotationFactory.getDescription(this.model):this.model instanceof ve.dm.Node&&(a=ve.ce.nodeFactory.getDescription(this.model)),a||(a=this.tool["static"].title),a},ve.ui.ContextOptionWidget.prototype.getCommand=function(){return ve.ui.commandRegistry.lookup(this.tool["static"].commandName)},ve.ui.DimensionsWidget=function(a){var b,c;a=a||{},OO.ui.Widget.call(this,a),this.widthInput=new OO.ui.TextInputWidget({validate:a.validate}),this.heightInput=new OO.ui.TextInputWidget({validate:a.validate}),this.defaults=a.defaults||{width:"",height:""},this.renderDefaults(),b=new OO.ui.LabelWidget({label:ve.msg("visualeditor-dimensionswidget-times")}),c=new OO.ui.LabelWidget({label:ve.msg("visualeditor-dimensionswidget-px")}),this.widthInput.connect(this,{change:"onWidthChange"}),this.heightInput.connect(this,{change:"onHeightChange"}),this.$element.addClass("ve-ui-dimensionsWidget").append(this.widthInput.$element,b.$element.addClass("ve-ui-dimensionsWidget-label-times"),this.heightInput.$element,c.$element.addClass("ve-ui-dimensionsWidget-label-px"))},OO.inheritClass(ve.ui.DimensionsWidget,OO.ui.Widget),ve.ui.DimensionsWidget.prototype.onWidthChange=function(a){this.emit("widthChange",a)},ve.ui.DimensionsWidget.prototype.onHeightChange=function(a){this.emit("heightChange",a)},ve.ui.DimensionsWidget.prototype.setDefaults=function(a){a.width&&a.height&&(this.defaults=ve.copy(a),this.renderDefaults())},ve.ui.DimensionsWidget.prototype.renderDefaults=function(){this.widthInput.$input.prop("placeholder",this.getDefaults().width),this.heightInput.$input.prop("placeholder",this.getDefaults().height)},ve.ui.DimensionsWidget.prototype.getDefaults=function(){return this.defaults},ve.ui.DimensionsWidget.prototype.removeDefaults=function(){this.defaults={width:"",height:""},this.renderDefaults()},ve.ui.DimensionsWidget.prototype.isEmpty=function(){return""===this.widthInput.getValue()&&""===this.heightInput.getValue()},ve.ui.DimensionsWidget.prototype.clear=function(){this.widthInput.setValue(""),this.heightInput.setValue("")},ve.ui.DimensionsWidget.prototype.reset=function(){this.setDimensions(this.getDefaults())},ve.ui.DimensionsWidget.prototype.setDimensions=function(a){a.width&&this.setWidth(a.width),a.height&&this.setHeight(a.height)},ve.ui.DimensionsWidget.prototype.getDimensions=function(){return{width:this.widthInput.getValue(),height:this.heightInput.getValue()}},ve.ui.DimensionsWidget.prototype.setDisabled=function(a){this.widthInput&&this.widthInput.setDisabled(a),this.heightInput&&this.heightInput.setDisabled(a)},ve.ui.DimensionsWidget.prototype.getWidth=function(){return this.widthInput.getValue()},ve.ui.DimensionsWidget.prototype.getHeight=function(){return this.heightInput.getValue()},ve.ui.DimensionsWidget.prototype.setWidth=function(a){this.widthInput.setValue(a)},ve.ui.DimensionsWidget.prototype.setHeight=function(a){this.heightInput.setValue(a)},ve.ui.DimensionsWidget.prototype.setValidityFlag=function(){this.widthInput.setValidityFlag(),this.heightInput.setValidityFlag()},ve.ui.MediaSizeWidget=function(a,b){var c,d,e;b=b||{},this.scalable=a||{},OO.ui.Widget.call(this,b),this.ratio={},this.currentDimensions={},this.maxDimensions={},this.valid=null,this.sizeTypeSelectWidget=new OO.ui.ButtonSelectWidget({classes:["ve-ui-mediaSizeWidget-section-sizetype"]}),this.sizeTypeSelectWidget.addItems([new OO.ui.ButtonOptionWidget({data:"default",label:ve.msg("visualeditor-mediasizewidget-sizeoptions-default")}),new OO.ui.ButtonOptionWidget({data:"custom",label:ve.msg("visualeditor-mediasizewidget-sizeoptions-custom")})]),this.scaleInput=new OO.ui.TextInputWidget,e=new OO.ui.LabelWidget({input:this.scaleInput,label:ve.msg("visualeditor-mediasizewidget-label-scale-percent")}),this.dimensionsWidget=new ve.ui.DimensionsWidget({validate:this.isValid.bind(this)}),this.errorLabel=new OO.ui.LabelWidget({label:ve.msg("visualeditor-mediasizewidget-label-defaulterror")}),c=new OO.ui.FieldLayout(this.scaleInput,{align:"right",label:ve.msg("visualeditor-mediasizewidget-label-scale")}),d=new OO.ui.FieldLayout(this.dimensionsWidget,{align:"right",label:ve.msg("visualeditor-mediasizewidget-label-custom"),classes:["ve-ui-mediaSizeWidget-section-custom"]}),this.fullSizeButton=new OO.ui.ButtonWidget({label:ve.msg("visualeditor-mediasizewidget-button-originaldimensions"),classes:["ve-ui-mediaSizeWidget-button-fullsize"]}),this.$element.addClass("ve-ui-mediaSizeWidget").append(this.sizeTypeSelectWidget.$element,d.$element,this.fullSizeButton.$element,$("<div>").addClass("ve-ui-mediaSizeWidget-label-error").append(this.errorLabel.$element)),this.dimensionsWidget.connect(this,{widthChange:["onDimensionsChange","width"],heightChange:["onDimensionsChange","height"]}),this.sizeTypeSelectWidget.connect(this,{choose:"onSizeTypeChoose"}),this.fullSizeButton.connect(this,{click:"onFullSizeButtonClick"})},OO.inheritClass(ve.ui.MediaSizeWidget,OO.ui.Widget),ve.ui.MediaSizeWidget.prototype.onScalableOriginalSizeChange=function(a){var b=!a||$.isEmptyObject(a);this.fullSizeButton.setDisabled(b),this.sizeTypeSelectWidget.getItemFromData("default").setDisabled(b),this.validateDimensions()},ve.ui.MediaSizeWidget.prototype.onScalableCurrentSizeChange=function(a){$.isEmptyObject(a)||(this.setCurrentDimensions(a),this.validateDimensions())},ve.ui.MediaSizeWidget.prototype.onScalableDefaultSizeChange=function(a){this.updateDefaultDimensions(),this.setSizeType(a?"default":"custom"),this.validateDimensions()},ve.ui.MediaSizeWidget.prototype.onDimensionsChange=function(a,b){var c={};0===Number(b)?this.setSizeType("default"):(this.setSizeType("custom"),$.isNumeric(b)?(c[a]=Number(b),this.setCurrentDimensions(c)):this.validateDimensions())},ve.ui.MediaSizeWidget.prototype.onScaleChange=function(){this.sizeTypeSelectWidget.selectItemByData(this.dimensionsWidget.isEmpty()?"default":"scale")},ve.ui.MediaSizeWidget.prototype.onSizeTypeChoose=function(a){var b=a.getData(),c=this.scalable.isDefault();this.scalable.toggleDefault("default"===b),"default"===b?(this.scaleInput.setDisabled(!0),$.isEmptyObject(this.dimensionsWidget.getDefaults())||this.dimensionsWidget.clear()):"scale"===b?(this.dimensionsWidget.setDisabled(!0),this.scaleInput.setDisabled(!1)):"custom"===b&&(this.dimensionsWidget.setDisabled(!1),this.scaleInput.setDisabled(!0),c&&!$.isEmptyObject(this.dimensionsWidget.getDefaults())&&this.setCurrentDimensions(this.dimensionsWidget.getDefaults()),this.validateDimensions()),this.emit("changeSizeType",b),this.validateDimensions()},ve.ui.MediaSizeWidget.prototype.setScalePlaceholder=function(a){this.scaleInput.$element.prop("placeholder",a)},ve.ui.MediaSizeWidget.prototype.getScalePlaceholder=function(){return this.scaleInput.$element.prop("placeholder")},ve.ui.MediaSizeWidget.prototype.setSizeType=function(a){(this.getSizeType()!==a||0===Number(this.dimensionsWidget.getWidth())||0===Number(this.dimensionsWidget.getHeight()))&&this.sizeTypeSelectWidget.chooseItem(this.sizeTypeSelectWidget.getItemFromData(a))},ve.ui.MediaSizeWidget.prototype.getSizeType=function(){return this.sizeTypeSelectWidget.getSelectedItem()?this.sizeTypeSelectWidget.getSelectedItem().getData():""},ve.ui.MediaSizeWidget.prototype.setScalable=function(a){this.scalable instanceof ve.dm.Scalable&&this.scalable.disconnect(this),this.scalable=a,this.scalable.connect(this,{defaultSizeChange:"onScalableDefaultSizeChange",originalSizeChange:"onScalableOriginalSizeChange",currentSizeChange:"onScalableCurrentSizeChange"}),this.updateDefaultDimensions(),this.scalable.isDefault()||this.setCurrentDimensions(this.scalable.getCurrentDimensions()),this.scalable.getOriginalDimensions()?(this.fullSizeButton.setDisabled(!1),this.sizeTypeSelectWidget.getItemFromData("default").setDisabled(!1),this.setSizeType(this.scalable.isDefault()?"default":"custom")):(this.fullSizeButton.setDisabled(!0),this.sizeTypeSelectWidget.getItemFromData("default").setDisabled(!0)),this.validateDimensions()},ve.ui.MediaSizeWidget.prototype.getScalable=function(){return this.scalable},ve.ui.MediaSizeWidget.prototype.onFullSizeButtonClick=function(){this.sizeTypeSelectWidget.chooseItem(this.sizeTypeSelectWidget.getItemFromData("custom")),this.setCurrentDimensions(this.scalable.getOriginalDimensions()),this.dimensionsWidget.setDisabled(!1)
},ve.ui.MediaSizeWidget.prototype.setRatio=function(a){this.scalable.setRatio(a)},ve.ui.MediaSizeWidget.prototype.getRatio=function(){return this.scalable.getRatio()},ve.ui.MediaSizeWidget.prototype.setMaxDimensions=function(a){var b=ve.dm.Scalable["static"].getDimensionsFromValue(a,this.scalable.getRatio());this.scalable.setMaxDimensions(b)},ve.ui.MediaSizeWidget.prototype.getMaxDimensions=function(){return this.scalable.getMaxDimensions()},ve.ui.MediaSizeWidget.prototype.getCurrentDimensions=function(){return this.currentDimensions},ve.ui.MediaSizeWidget.prototype.setDisabled=function(a){this.sizeTypeSelectWidget&&this.dimensionsWidget&&this.scalable&&this.fullSizeButton&&(this.sizeTypeSelectWidget.setDisabled(a),this.dimensionsWidget.setDisabled(a),this.fullSizeButton.setDisabled(a||!this.scalable.getOriginalDimensions()))},ve.ui.MediaSizeWidget.prototype.setCurrentDimensions=function(a){var b;this.preventChangeRecursion||(this.preventChangeRecursion=!0,b=ve.dm.Scalable["static"].getDimensionsFromValue(a,this.scalable.getRatio()),this.scalable.isDimensionsObjectValid(b)&&!this.scalable.isDefault()&&(this.currentDimensions=b,this.dimensionsWidget.setWidth(this.currentDimensions.width),this.dimensionsWidget.setHeight(this.currentDimensions.height),this.scalable.setCurrentDimensions(this.currentDimensions),this.validateDimensions(),this.emit("change",this.currentDimensions)),this.preventChangeRecursion=!1)},ve.ui.MediaSizeWidget.prototype.validateDimensions=function(){var a=this.isValid();return this.valid!==a&&(this.valid=a,this.errorLabel.toggle(!a),this.dimensionsWidget.setValidityFlag(),this.emit("valid",this.valid)),a},ve.ui.MediaSizeWidget.prototype.updateDefaultDimensions=function(){var a=this.scalable.getDefaultDimensions();$.isEmptyObject(a)?this.dimensionsWidget.removeDefaults():this.dimensionsWidget.setDefaults(a),this.sizeTypeSelectWidget.getItemFromData("default").setDisabled($.isEmptyObject(a)),this.validateDimensions()},ve.ui.MediaSizeWidget.prototype.isCustomEmpty=function(){return this.dimensionsWidget.isEmpty()},ve.ui.MediaSizeWidget.prototype.toggleFullSizeButtonDisabled=function(a){this.fullSizeButton.setDisabled(a)},ve.ui.MediaSizeWidget.prototype.isScaleEmpty=function(){return""===this.scaleInput.getValue()},ve.ui.MediaSizeWidget.prototype.isEmpty=function(){return this.isCustomEmpty()&&this.isScaleEmpty()},ve.ui.MediaSizeWidget.prototype.isValid=function(){var a=this.sizeTypeSelectWidget.getSelectedItem()?this.sizeTypeSelectWidget.getSelectedItem().getData():"custom";return"custom"===a?this.dimensionsWidget.getDefaults()&&this.dimensionsWidget.isEmpty()?!0:$.isNumeric(this.dimensionsWidget.getWidth())&&$.isNumeric(this.dimensionsWidget.getHeight())?this.scalable.isCurrentDimensionsValid():!1:!0},ve.ui.PreviewWidget=function(a,b){var c,d=[],e=this;OO.ui.Widget.call(this,b),this.model=a,this.rendering=ve.ce.nodeFactory.create(this.model.getType(),this.model),this.rendering instanceof ve.ce.BranchNode?ve.BranchNode["static"].traverse(this.rendering,function(a){"function"==typeof a.generateContents&&a.isGenerating()&&(c=$.Deferred(),a.once("rerender",c.resolve),d.push(c))}):"function"==typeof this.rendering.generateContents&&this.rendering.isGenerating()&&(c=$.Deferred(),this.rendering.once("rerender",c.resolve),d.push(c)),$.when.apply($,d).then(function(){e.rendering&&e.replaceWithModelDom()}),this.$element.addClass("ve-ui-previewWidget")},OO.inheritClass(ve.ui.PreviewWidget,OO.ui.Widget),ve.ui.PreviewWidget.prototype.destroy=function(){this.rendering&&(this.rendering.destroy(),this.rendering=null)},ve.ui.PreviewWidget.prototype.replaceWithModelDom=function(){var a=ve.dm.converter.getDomFromModel(this.model.getDocument(),!0),b=$(a.body);ve.resolveAttributes(b,this.model.getDocument().getHtmlDocument(),ve.dm.Converter.computedAttributes),b.find("a").attr("target","_blank"),this.$element.empty().append(b.contents()),this.emit("render"),this.rendering.destroy(),this.rendering=null},ve.ui.PreviewWidget.prototype.isGenerating=function(){return this.rendering&&this.rendering.isGenerating()},ve.ui.WhitespacePreservingTextInputWidget=function(a){a=a||{},ve.ui.WhitespacePreservingTextInputWidget["super"].call(this,a),this.limit=a.limit,this.whitespace=["",""],this.setValueAndWhitespace(a.valueAndWhitespace||""),this.$element.addClass("ve-ui-WhitespacePreservingTextInputWidget")},OO.inheritClass(ve.ui.WhitespacePreservingTextInputWidget,OO.ui.TextInputWidget),ve.ui.WhitespacePreservingTextInputWidget.prototype.setValueAndWhitespace=function(a){var b,c;b=this.limit?a.slice(0,this.limit):a,this.whitespace[0]=b.match(/^\s*/)[0],a=a.slice(this.whitespace[0].length),c=this.limit?a.slice(-this.limit):a,this.whitespace[1]=c.match(/\s*$/)[0],a=a.slice(0,a.length-this.whitespace[1].length),this.setValue(a)},ve.ui.WhitespacePreservingTextInputWidget.prototype.setWhitespace=function(a){this.whitespace=a},ve.ui.WhitespacePreservingTextInputWidget.prototype.getValue=function(){return this.whitespace?this.whitespace[0]+this.getInnerValue()+this.whitespace[1]:this.value},ve.ui.WhitespacePreservingTextInputWidget.prototype.getInnerValue=function(){return $.trim(this.value)},ve.ui.AnnotationTool=function(a,b){ve.ui.Tool.call(this,a,b)},OO.inheritClass(ve.ui.AnnotationTool,ve.ui.Tool),ve.ui.AnnotationTool["static"].annotation={name:""},ve.ui.AnnotationTool["static"].deactivateOnSelect=!1,ve.ui.AnnotationTool.prototype.onUpdateState=function(a){ve.ui.Tool.prototype.onUpdateState.apply(this,arguments),this.setActive(a&&a.getAnnotations().hasAnnotationWithName(this.constructor["static"].annotation.name))},ve.ui.BoldAnnotationTool=function(a,b){ve.ui.AnnotationTool.call(this,a,b)},OO.inheritClass(ve.ui.BoldAnnotationTool,ve.ui.AnnotationTool),ve.ui.BoldAnnotationTool["static"].name="bold",ve.ui.BoldAnnotationTool["static"].group="textStyle",ve.ui.BoldAnnotationTool["static"].icon="bold",ve.ui.BoldAnnotationTool["static"].title=OO.ui.deferMsg("visualeditor-annotationbutton-bold-tooltip"),ve.ui.BoldAnnotationTool["static"].annotation={name:"textStyle/bold"},ve.ui.BoldAnnotationTool["static"].commandName="bold",ve.ui.toolFactory.register(ve.ui.BoldAnnotationTool),ve.ui.ItalicAnnotationTool=function(a,b){ve.ui.AnnotationTool.call(this,a,b)},OO.inheritClass(ve.ui.ItalicAnnotationTool,ve.ui.AnnotationTool),ve.ui.ItalicAnnotationTool["static"].name="italic",ve.ui.ItalicAnnotationTool["static"].group="textStyle",ve.ui.ItalicAnnotationTool["static"].icon="italic",ve.ui.ItalicAnnotationTool["static"].title=OO.ui.deferMsg("visualeditor-annotationbutton-italic-tooltip"),ve.ui.ItalicAnnotationTool["static"].annotation={name:"textStyle/italic"},ve.ui.ItalicAnnotationTool["static"].commandName="italic",ve.ui.toolFactory.register(ve.ui.ItalicAnnotationTool),ve.ui.CodeAnnotationTool=function(a,b){ve.ui.AnnotationTool.call(this,a,b)},OO.inheritClass(ve.ui.CodeAnnotationTool,ve.ui.AnnotationTool),ve.ui.CodeAnnotationTool["static"].name="code",ve.ui.CodeAnnotationTool["static"].group="textStyle",ve.ui.CodeAnnotationTool["static"].icon="code",ve.ui.CodeAnnotationTool["static"].title=OO.ui.deferMsg("visualeditor-annotationbutton-code-tooltip"),ve.ui.CodeAnnotationTool["static"].annotation={name:"textStyle/code"},ve.ui.CodeAnnotationTool["static"].commandName="code",ve.ui.toolFactory.register(ve.ui.CodeAnnotationTool),ve.ui.StrikethroughAnnotationTool=function(a,b){ve.ui.AnnotationTool.call(this,a,b)},OO.inheritClass(ve.ui.StrikethroughAnnotationTool,ve.ui.AnnotationTool),ve.ui.StrikethroughAnnotationTool["static"].name="strikethrough",ve.ui.StrikethroughAnnotationTool["static"].group="textStyle",ve.ui.StrikethroughAnnotationTool["static"].icon="strikethrough",ve.ui.StrikethroughAnnotationTool["static"].title=OO.ui.deferMsg("visualeditor-annotationbutton-strikethrough-tooltip"),ve.ui.StrikethroughAnnotationTool["static"].annotation={name:"textStyle/strikethrough"},ve.ui.StrikethroughAnnotationTool["static"].commandName="strikethrough",ve.ui.toolFactory.register(ve.ui.StrikethroughAnnotationTool),ve.ui.UnderlineAnnotationTool=function(a,b){ve.ui.AnnotationTool.call(this,a,b)},OO.inheritClass(ve.ui.UnderlineAnnotationTool,ve.ui.AnnotationTool),ve.ui.UnderlineAnnotationTool["static"].name="underline",ve.ui.UnderlineAnnotationTool["static"].group="textStyle",ve.ui.UnderlineAnnotationTool["static"].icon="underline",ve.ui.UnderlineAnnotationTool["static"].title=OO.ui.deferMsg("visualeditor-annotationbutton-underline-tooltip"),ve.ui.UnderlineAnnotationTool["static"].annotation={name:"textStyle/underline"},ve.ui.UnderlineAnnotationTool["static"].commandName="underline",ve.ui.toolFactory.register(ve.ui.UnderlineAnnotationTool),ve.ui.SuperscriptAnnotationTool=function(a,b){ve.ui.AnnotationTool.call(this,a,b)},OO.inheritClass(ve.ui.SuperscriptAnnotationTool,ve.ui.AnnotationTool),ve.ui.SuperscriptAnnotationTool["static"].name="superscript",ve.ui.SuperscriptAnnotationTool["static"].group="textStyle",ve.ui.SuperscriptAnnotationTool["static"].icon="superscript",ve.ui.SuperscriptAnnotationTool["static"].title=OO.ui.deferMsg("visualeditor-annotationbutton-superscript-tooltip"),ve.ui.SuperscriptAnnotationTool["static"].annotation={name:"textStyle/superscript"},ve.ui.SuperscriptAnnotationTool["static"].commandName="superscript",ve.ui.toolFactory.register(ve.ui.SuperscriptAnnotationTool),ve.ui.SubscriptAnnotationTool=function(a,b){ve.ui.AnnotationTool.call(this,a,b)},OO.inheritClass(ve.ui.SubscriptAnnotationTool,ve.ui.AnnotationTool),ve.ui.SubscriptAnnotationTool["static"].name="subscript",ve.ui.SubscriptAnnotationTool["static"].group="textStyle",ve.ui.SubscriptAnnotationTool["static"].icon="subscript",ve.ui.SubscriptAnnotationTool["static"].title=OO.ui.deferMsg("visualeditor-annotationbutton-subscript-tooltip"),ve.ui.SubscriptAnnotationTool["static"].annotation={name:"textStyle/subscript"},ve.ui.SubscriptAnnotationTool["static"].commandName="subscript",ve.ui.toolFactory.register(ve.ui.SubscriptAnnotationTool),ve.ui.MoreTextStyleTool=function(a,b){OO.ui.ToolGroupTool.call(this,a,b)},OO.inheritClass(ve.ui.MoreTextStyleTool,OO.ui.ToolGroupTool),ve.ui.MoreTextStyleTool["static"].autoAddToCatchall=!1,ve.ui.MoreTextStyleTool["static"].name="moreTextStyle",ve.ui.MoreTextStyleTool["static"].group="textStyleExpansion",ve.ui.MoreTextStyleTool["static"].title=OO.ui.deferMsg("visualeditor-toolbar-style-tooltip"),ve.ui.MoreTextStyleTool["static"].groupConfig={header:OO.ui.deferMsg("visualeditor-toolbar-text-style"),icon:"textStyle",indicator:"down",title:OO.ui.deferMsg("visualeditor-toolbar-style-tooltip"),include:[{group:"textStyle"},"language","clear"],demote:["strikethrough","code","underline","language","clear"]},ve.ui.toolFactory.register(ve.ui.MoreTextStyleTool),ve.ui.ClearAnnotationTool=function(a,b){ve.ui.Tool.call(this,a,b),this.setDisabled(!0)},OO.inheritClass(ve.ui.ClearAnnotationTool,ve.ui.Tool),ve.ui.ClearAnnotationTool["static"].name="clear",ve.ui.ClearAnnotationTool["static"].group="utility",ve.ui.ClearAnnotationTool["static"].icon="cancel",ve.ui.ClearAnnotationTool["static"].title=OO.ui.deferMsg("visualeditor-clearbutton-tooltip"),ve.ui.ClearAnnotationTool["static"].commandName="clear",ve.ui.toolFactory.register(ve.ui.ClearAnnotationTool),ve.ui.DialogTool=function(){ve.ui.DialogTool["super"].apply(this,arguments)},OO.inheritClass(ve.ui.DialogTool,ve.ui.Tool),ve.ui.DialogTool["static"].modelClasses=[],ve.ui.DialogTool["static"].isCompatibleWith=function(a){return ve.isInstanceOfAny(a,this.modelClasses)},ve.ui.DialogTool.prototype.onUpdateState=function(){ve.ui.DialogTool["super"].prototype.onUpdateState.apply(this,arguments),this.setActive(!1)},ve.ui.CommandHelpDialogTool=function(){ve.ui.CommandHelpDialogTool["super"].apply(this,arguments)},OO.inheritClass(ve.ui.CommandHelpDialogTool,ve.ui.DialogTool),ve.ui.CommandHelpDialogTool["static"].name="commandHelp",ve.ui.CommandHelpDialogTool["static"].group="dialog",ve.ui.CommandHelpDialogTool["static"].icon="help",ve.ui.CommandHelpDialogTool["static"].title=OO.ui.deferMsg("visualeditor-dialog-command-help-title"),ve.ui.CommandHelpDialogTool["static"].autoAddToCatchall=!1,ve.ui.CommandHelpDialogTool["static"].autoAddToGroup=!1,ve.ui.CommandHelpDialogTool["static"].commandName="commandHelp",ve.ui.toolFactory.register(ve.ui.CommandHelpDialogTool),ve.ui.ToolbarDialogTool=function(){ve.ui.ToolbarDialogTool["super"].apply(this,arguments)},OO.inheritClass(ve.ui.ToolbarDialogTool,ve.ui.DialogTool),ve.ui.ToolbarDialogTool["static"].deactivateOnSelect=!1,ve.ui.ToolbarDialogTool["static"].activeWindow=null,ve.ui.ToolbarDialogTool.prototype.onUpdateState=function(){ve.ui.ToolbarDialogTool["super"].prototype.onUpdateState.apply(this,arguments);var a=this.toolbar.getSurface().getToolbarDialogs().currentWindow;this.setActive(a&&a.constructor["static"].name===this.constructor["static"].activeWindow)},ve.ui.FindAndReplaceTool=function(){ve.ui.FindAndReplaceTool["super"].apply(this,arguments)},OO.inheritClass(ve.ui.FindAndReplaceTool,ve.ui.ToolbarDialogTool),ve.ui.FindAndReplaceTool["static"].name="findAndReplace",ve.ui.FindAndReplaceTool["static"].group="dialog",ve.ui.FindAndReplaceTool["static"].icon="find",ve.ui.FindAndReplaceTool["static"].title=OO.ui.deferMsg("visualeditor-find-and-replace-title"),ve.ui.FindAndReplaceTool["static"].autoAddToCatchall=!1,ve.ui.FindAndReplaceTool["static"].autoAddToGroup=!1,ve.ui.FindAndReplaceTool["static"].commandName="findAndReplace",ve.ui.FindAndReplaceTool["static"].activeWindow="findAndReplace",ve.ui.toolFactory.register(ve.ui.FindAndReplaceTool),ve.ui.SpecialCharacterDialogTool=function(){ve.ui.SpecialCharacterDialogTool["super"].apply(this,arguments)},OO.inheritClass(ve.ui.SpecialCharacterDialogTool,ve.ui.ToolbarDialogTool),ve.ui.SpecialCharacterDialogTool["static"].name="specialCharacter",ve.ui.SpecialCharacterDialogTool["static"].group="dialog",ve.ui.SpecialCharacterDialogTool["static"].icon="specialCharacter",ve.ui.SpecialCharacterDialogTool["static"].title=OO.ui.deferMsg("visualeditor-specialcharacter-button-tooltip"),ve.ui.SpecialCharacterDialogTool["static"].autoAddToCatchall=!1,ve.ui.SpecialCharacterDialogTool["static"].autoAddToGroup=!1,ve.ui.SpecialCharacterDialogTool["static"].commandName="specialCharacter",ve.ui.SpecialCharacterDialogTool["static"].activeWindow="specialCharacter",ve.ui.toolFactory.register(ve.ui.SpecialCharacterDialogTool),ve.ui.FormatTool=function(a,b){ve.ui.Tool.call(this,a,b),this.convertible=!1},OO.inheritClass(ve.ui.FormatTool,ve.ui.Tool),ve.ui.FormatTool["static"].deactivateOnSelect=!1,ve.ui.FormatTool["static"].format=null,ve.ui.FormatTool.prototype.onUpdateState=function(a){if(ve.ui.FormatTool["super"].prototype.onUpdateState.apply(this,arguments),this.isDisabled())return this.toggle(!1),void this.setActive(!1);this.toggle(!0);var b,c,d,e,f,g=a.getSelection(),h=this.constructor["static"].format;if(g instanceof ve.dm.LinearSelection){for(d=a.getSelectedLeafNodes(),e=!!d.length,b=0,c=d.length;c>b;b++)if(!d[b].hasMatchingAncestor(h.type,h.attributes)){e=!1;break}}else if(g instanceof ve.dm.TableSelection)for(f=g.getMatrixCells(),e=!0,b=f.length-1;b>=0;b--)if(!f[b].node.matches(h.type,h.attributes)){e=!1;break}this.convertible=!e,this.setActive(e)},ve.ui.ParagraphFormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.ParagraphFormatTool,ve.ui.FormatTool),ve.ui.ParagraphFormatTool["static"].name="paragraph",ve.ui.ParagraphFormatTool["static"].group="format",ve.ui.ParagraphFormatTool["static"].title=OO.ui.deferMsg("visualeditor-formatdropdown-format-paragraph"),ve.ui.ParagraphFormatTool["static"].format={type:"paragraph"},ve.ui.ParagraphFormatTool["static"].commandName="paragraph",ve.ui.toolFactory.register(ve.ui.ParagraphFormatTool),ve.ui.Heading1FormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.Heading1FormatTool,ve.ui.FormatTool),ve.ui.Heading1FormatTool["static"].name="heading1",ve.ui.Heading1FormatTool["static"].group="format",ve.ui.Heading1FormatTool["static"].title=OO.ui.deferMsg("visualeditor-formatdropdown-format-heading1"),ve.ui.Heading1FormatTool["static"].format={type:"heading",attributes:{level:1}},ve.ui.Heading1FormatTool["static"].commandName="heading1",ve.ui.toolFactory.register(ve.ui.Heading1FormatTool),ve.ui.Heading2FormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.Heading2FormatTool,ve.ui.FormatTool),ve.ui.Heading2FormatTool["static"].name="heading2",ve.ui.Heading2FormatTool["static"].group="format",ve.ui.Heading2FormatTool["static"].title=OO.ui.deferMsg("visualeditor-formatdropdown-format-heading2"),ve.ui.Heading2FormatTool["static"].format={type:"heading",attributes:{level:2}},ve.ui.Heading2FormatTool["static"].commandName="heading2",ve.ui.toolFactory.register(ve.ui.Heading2FormatTool),ve.ui.Heading3FormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.Heading3FormatTool,ve.ui.FormatTool),ve.ui.Heading3FormatTool["static"].name="heading3",ve.ui.Heading3FormatTool["static"].group="format",ve.ui.Heading3FormatTool["static"].title=OO.ui.deferMsg("visualeditor-formatdropdown-format-heading3"),ve.ui.Heading3FormatTool["static"].format={type:"heading",attributes:{level:3}},ve.ui.Heading3FormatTool["static"].commandName="heading3",ve.ui.toolFactory.register(ve.ui.Heading3FormatTool),ve.ui.Heading4FormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.Heading4FormatTool,ve.ui.FormatTool),ve.ui.Heading4FormatTool["static"].name="heading4",ve.ui.Heading4FormatTool["static"].group="format",ve.ui.Heading4FormatTool["static"].title=OO.ui.deferMsg("visualeditor-formatdropdown-format-heading4"),ve.ui.Heading4FormatTool["static"].format={type:"heading",attributes:{level:4}},ve.ui.Heading4FormatTool["static"].commandName="heading4",ve.ui.toolFactory.register(ve.ui.Heading4FormatTool),ve.ui.Heading5FormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.Heading5FormatTool,ve.ui.FormatTool),ve.ui.Heading5FormatTool["static"].name="heading5",ve.ui.Heading5FormatTool["static"].group="format",ve.ui.Heading5FormatTool["static"].title=OO.ui.deferMsg("visualeditor-formatdropdown-format-heading5"),ve.ui.Heading5FormatTool["static"].format={type:"heading",attributes:{level:5}},ve.ui.Heading5FormatTool["static"].commandName="heading5",ve.ui.toolFactory.register(ve.ui.Heading5FormatTool),ve.ui.Heading6FormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.Heading6FormatTool,ve.ui.FormatTool),ve.ui.Heading6FormatTool["static"].name="heading6",ve.ui.Heading6FormatTool["static"].group="format",ve.ui.Heading6FormatTool["static"].title=OO.ui.deferMsg("visualeditor-formatdropdown-format-heading6"),ve.ui.Heading6FormatTool["static"].format={type:"heading",attributes:{level:6}},ve.ui.Heading6FormatTool["static"].commandName="heading6",ve.ui.toolFactory.register(ve.ui.Heading6FormatTool),ve.ui.PreformattedFormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.PreformattedFormatTool,ve.ui.FormatTool),ve.ui.PreformattedFormatTool["static"].name="preformatted",ve.ui.PreformattedFormatTool["static"].group="format",ve.ui.PreformattedFormatTool["static"].title=OO.ui.deferMsg("visualeditor-formatdropdown-format-preformatted"),ve.ui.PreformattedFormatTool["static"].format={type:"preformatted"},ve.ui.PreformattedFormatTool["static"].commandName="preformatted",ve.ui.toolFactory.register(ve.ui.PreformattedFormatTool),ve.ui.BlockquoteFormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.BlockquoteFormatTool,ve.ui.FormatTool),ve.ui.BlockquoteFormatTool["static"].name="blockquote",ve.ui.BlockquoteFormatTool["static"].group="format",ve.ui.BlockquoteFormatTool["static"].title=OO.ui.deferMsg("visualeditor-formatdropdown-format-blockquote"),ve.ui.BlockquoteFormatTool["static"].format={type:"blockquote"},ve.ui.BlockquoteFormatTool["static"].commandName="blockquote",ve.ui.toolFactory.register(ve.ui.BlockquoteFormatTool),ve.ui.TableCellHeaderFormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.TableCellHeaderFormatTool,ve.ui.FormatTool),ve.ui.TableCellHeaderFormatTool["static"].name="tableCellHeader",ve.ui.TableCellHeaderFormatTool["static"].group="format",ve.ui.TableCellHeaderFormatTool["static"].title=OO.ui.deferMsg("visualeditor-table-format-header"),ve.ui.TableCellHeaderFormatTool["static"].format={type:"tableCell",attributes:{style:"header"}},ve.ui.TableCellHeaderFormatTool["static"].commandName="tableCellHeader",ve.ui.toolFactory.register(ve.ui.TableCellHeaderFormatTool),ve.ui.TableCellDataFormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.TableCellDataFormatTool,ve.ui.FormatTool),ve.ui.TableCellDataFormatTool["static"].name="tableCellData",ve.ui.TableCellDataFormatTool["static"].group="format",ve.ui.TableCellDataFormatTool["static"].title=OO.ui.deferMsg("visualeditor-table-format-data"),ve.ui.TableCellDataFormatTool["static"].format={type:"tableCell",attributes:{style:"data"}},ve.ui.TableCellDataFormatTool["static"].commandName="tableCellData",ve.ui.toolFactory.register(ve.ui.TableCellDataFormatTool),ve.ui.HistoryTool=function(a,b){ve.ui.Tool.call(this,a,b),this.toolbar.getSurface().getModel().connect(this,{history:"onHistory"}),this.setDisabled(!0)},OO.inheritClass(ve.ui.HistoryTool,ve.ui.Tool),ve.ui.HistoryTool.prototype.onHistory=function(){this.onUpdateState(this.toolbar.getSurface().getModel().getFragment())},ve.ui.HistoryTool.prototype.destroy=function(){this.toolbar.getSurface().getModel().disconnect(this),ve.ui.HistoryTool["super"].prototype.destroy.call(this)},ve.ui.UndoHistoryTool=function(a,b){ve.ui.HistoryTool.call(this,a,b)},OO.inheritClass(ve.ui.UndoHistoryTool,ve.ui.HistoryTool),ve.ui.UndoHistoryTool["static"].name="undo",ve.ui.UndoHistoryTool["static"].group="history",ve.ui.UndoHistoryTool["static"].icon="undo",ve.ui.UndoHistoryTool["static"].title=OO.ui.deferMsg("visualeditor-historybutton-undo-tooltip"),ve.ui.UndoHistoryTool["static"].commandName="undo",ve.ui.toolFactory.register(ve.ui.UndoHistoryTool),ve.ui.RedoHistoryTool=function(a,b){ve.ui.HistoryTool.call(this,a,b)},OO.inheritClass(ve.ui.RedoHistoryTool,ve.ui.HistoryTool),ve.ui.RedoHistoryTool["static"].name="redo",ve.ui.RedoHistoryTool["static"].group="history",ve.ui.RedoHistoryTool["static"].icon="redo",ve.ui.RedoHistoryTool["static"].title=OO.ui.deferMsg("visualeditor-historybutton-redo-tooltip"),ve.ui.RedoHistoryTool["static"].commandName="redo",ve.ui.toolFactory.register(ve.ui.RedoHistoryTool),ve.ui.IndentationTool=function(a,b){ve.ui.Tool.call(this,a,b)},OO.inheritClass(ve.ui.IndentationTool,ve.ui.Tool),ve.ui.IncreaseIndentationTool=function(a,b){ve.ui.IndentationTool.call(this,a,b)},OO.inheritClass(ve.ui.IncreaseIndentationTool,ve.ui.IndentationTool),ve.ui.IncreaseIndentationTool["static"].name="indent",ve.ui.IncreaseIndentationTool["static"].group="structure",ve.ui.IncreaseIndentationTool["static"].icon="indent",ve.ui.IncreaseIndentationTool["static"].title=OO.ui.deferMsg("visualeditor-indentationbutton-indent-tooltip"),ve.ui.IncreaseIndentationTool["static"].commandName="indent",ve.ui.toolFactory.register(ve.ui.IncreaseIndentationTool),ve.ui.DecreaseIndentationTool=function(a,b){ve.ui.IndentationTool.call(this,a,b)},OO.inheritClass(ve.ui.DecreaseIndentationTool,ve.ui.IndentationTool),ve.ui.DecreaseIndentationTool["static"].name="outdent",ve.ui.DecreaseIndentationTool["static"].group="structure",ve.ui.DecreaseIndentationTool["static"].icon="outdent",ve.ui.DecreaseIndentationTool["static"].title=OO.ui.deferMsg("visualeditor-indentationbutton-outdent-tooltip"),ve.ui.DecreaseIndentationTool["static"].commandName="outdent",ve.ui.toolFactory.register(ve.ui.DecreaseIndentationTool),ve.ui.InspectorTool=function(a,b){ve.ui.Tool.call(this,a,b)},OO.inheritClass(ve.ui.InspectorTool,ve.ui.Tool),ve.ui.InspectorTool["static"].modelClasses=[],ve.ui.InspectorTool["static"].deactivateOnSelect=!1,ve.ui.InspectorTool["static"].isCompatibleWith=function(a){return ve.isInstanceOfAny(a,this.modelClasses)},ve.ui.InspectorTool.prototype.onUpdateState=function(a){var b,c,d,e=!1;for(ve.ui.Tool.prototype.onUpdateState.apply(this,arguments),d=a?a.getSelectedModels():[],b=0,c=d.length;c>b;b++)if(this.constructor["static"].isCompatibleWith(d[b])){e=!0;break}this.setActive(e)},ve.ui.LinkInspectorTool=function(a,b){ve.ui.InspectorTool.call(this,a,b)},OO.inheritClass(ve.ui.LinkInspectorTool,ve.ui.InspectorTool),ve.ui.LinkInspectorTool["static"].name="link",ve.ui.LinkInspectorTool["static"].group="meta",ve.ui.LinkInspectorTool["static"].icon="link",ve.ui.LinkInspectorTool["static"].title=OO.ui.deferMsg("visualeditor-annotationbutton-link-tooltip"),ve.ui.LinkInspectorTool["static"].modelClasses=[ve.dm.LinkAnnotation],ve.ui.LinkInspectorTool["static"].commandName="link",ve.ui.toolFactory.register(ve.ui.LinkInspectorTool),ve.ui.CommentInspectorTool=function(a,b){ve.ui.InspectorTool.call(this,a,b)},OO.inheritClass(ve.ui.CommentInspectorTool,ve.ui.InspectorTool),ve.ui.CommentInspectorTool["static"].name="comment",ve.ui.CommentInspectorTool["static"].group="meta",ve.ui.CommentInspectorTool["static"].icon="comment",ve.ui.CommentInspectorTool["static"].title=OO.ui.deferMsg("visualeditor-commentinspector-tooltip"),ve.ui.CommentInspectorTool["static"].modelClasses=[ve.dm.CommentNode],ve.ui.CommentInspectorTool["static"].commandName="comment",ve.ui.CommentInspectorTool["static"].deactivateOnSelect=!0,ve.ui.toolFactory.register(ve.ui.CommentInspectorTool),ve.ui.LanguageInspectorTool=function(a,b){ve.ui.InspectorTool.call(this,a,b)},OO.inheritClass(ve.ui.LanguageInspectorTool,ve.ui.InspectorTool),ve.ui.LanguageInspectorTool["static"].name="language",ve.ui.LanguageInspectorTool["static"].group="meta",ve.ui.LanguageInspectorTool["static"].icon="textLanguage",ve.ui.LanguageInspectorTool["static"].title=OO.ui.deferMsg("visualeditor-annotationbutton-language-tooltip"),ve.ui.LanguageInspectorTool["static"].modelClasses=[ve.dm.LanguageAnnotation],ve.ui.LanguageInspectorTool["static"].commandName="language",ve.ui.toolFactory.register(ve.ui.LanguageInspectorTool),ve.ui.ListTool=function(a,b){ve.ui.Tool.call(this,a,b),this.method=null},OO.inheritClass(ve.ui.ListTool,ve.ui.Tool),ve.ui.ListTool["static"].style="",ve.ui.ListTool["static"].deactivateOnSelect=!1,ve.ui.ListTool.prototype.onUpdateState=function(a){ve.ui.Tool.prototype.onUpdateState.apply(this,arguments);var b,c,d=a?a.getSelectedLeafNodes():[],e=this.constructor["static"].style,f=!!d.length;for(b=0,c=d.length;c>b;b++)if(!d[b].hasMatchingAncestor("list",{style:e})){f=!1;break}this.setActive(f)},ve.ui.BulletListTool=function(a,b){ve.ui.ListTool.call(this,a,b)},OO.inheritClass(ve.ui.BulletListTool,ve.ui.ListTool),ve.ui.BulletListTool["static"].name="bullet",ve.ui.BulletListTool["static"].group="structure",ve.ui.BulletListTool["static"].icon="listBullet",ve.ui.BulletListTool["static"].title=OO.ui.deferMsg("visualeditor-listbutton-bullet-tooltip"),ve.ui.BulletListTool["static"].style="bullet",ve.ui.BulletListTool["static"].commandName="bullet",ve.ui.toolFactory.register(ve.ui.BulletListTool),ve.ui.NumberListTool=function(a,b){ve.ui.ListTool.call(this,a,b)},OO.inheritClass(ve.ui.NumberListTool,ve.ui.ListTool),ve.ui.NumberListTool["static"].name="number",ve.ui.NumberListTool["static"].group="structure",ve.ui.NumberListTool["static"].icon="listNumbered",ve.ui.NumberListTool["static"].title=OO.ui.deferMsg("visualeditor-listbutton-number-tooltip"),ve.ui.NumberListTool["static"].style="number",ve.ui.NumberListTool["static"].commandName="number",ve.ui.toolFactory.register(ve.ui.NumberListTool),ve.ui.InsertTableTool=function(a,b){ve.ui.Tool.call(this,a,b)},OO.inheritClass(ve.ui.InsertTableTool,ve.ui.Tool),ve.ui.InsertTableTool["static"].name="insertTable",ve.ui.InsertTableTool["static"].group="insert",ve.ui.InsertTableTool["static"].icon="table",ve.ui.InsertTableTool["static"].title=OO.ui.deferMsg("visualeditor-table-insert-table"),ve.ui.InsertTableTool["static"].commandName="insertTable",ve.ui.toolFactory.register(ve.ui.InsertTableTool),ve.ui.DeleteTableTool=function(a,b){ve.ui.Tool.call(this,a,b)},OO.inheritClass(ve.ui.DeleteTableTool,ve.ui.Tool),ve.ui.DeleteTableTool["static"].name="deleteTable",ve.ui.DeleteTableTool["static"].group="table",ve.ui.DeleteTableTool["static"].autoAddToCatchall=!1,ve.ui.DeleteTableTool["static"].icon="remove",ve.ui.DeleteTableTool["static"].title=OO.ui.deferMsg("visualeditor-table-delete-table"),ve.ui.DeleteTableTool["static"].commandName="deleteTable",ve.ui.toolFactory.register(ve.ui.DeleteTableTool),ve.ui.MergeCellsTool=function(a,b){ve.ui.Tool.call(this,a,b)},OO.inheritClass(ve.ui.MergeCellsTool,ve.ui.Tool),ve.ui.MergeCellsTool["static"].name="mergeCells",ve.ui.MergeCellsTool["static"].group="table",ve.ui.MergeCellsTool["static"].autoAddToCatchall=!1,ve.ui.MergeCellsTool["static"].icon="tableMergeCells",ve.ui.MergeCellsTool["static"].title=OO.ui.deferMsg("visualeditor-table-merge-cells"),ve.ui.MergeCellsTool["static"].commandName="mergeCells",ve.ui.MergeCellsTool["static"].deactivateOnSelect=!1,ve.ui.MergeCellsTool.prototype.onUpdateState=function(a){return ve.ui.MergeCellsTool["super"].prototype.onUpdateState.apply(this,arguments),this.isDisabled()?void this.setActive(!1):void this.setActive(a.getSelection().isSingleCell())},ve.ui.toolFactory.register(ve.ui.MergeCellsTool),ve.ui.TableCaptionTool=function(a,b){ve.ui.Tool.call(this,a,b)},OO.inheritClass(ve.ui.TableCaptionTool,ve.ui.Tool),ve.ui.TableCaptionTool["static"].name="tableCaption",ve.ui.TableCaptionTool["static"].group="table",ve.ui.TableCaptionTool["static"].autoAddToCatchall=!1,ve.ui.TableCaptionTool["static"].icon="tableCaption",ve.ui.TableCaptionTool["static"].title=OO.ui.deferMsg("visualeditor-table-caption"),ve.ui.TableCaptionTool["static"].commandName="tableCaption",ve.ui.TableCaptionTool["static"].deactivateOnSelect=!1,ve.ui.TableCaptionTool.prototype.onUpdateState=function(a){if(ve.ui.TableCaptionTool["super"].prototype.onUpdateState.apply(this,arguments),this.isDisabled())return void this.setActive(!1);var b,c=a.getSelection();b=c instanceof ve.dm.TableSelection?!!c.getTableNode().getCaptionNode():!0,this.setActive(b)},ve.ui.toolFactory.register(ve.ui.TableCaptionTool),ve.ui.FragmentInspector=function(a){ve.ui.FragmentInspector["super"].call(this,a),this.fragment=null,this.previousSelection=null},OO.inheritClass(ve.ui.FragmentInspector,OO.ui.ProcessDialog),ve.ui.FragmentInspector["static"].actions=ve.ui.FragmentInspector["super"]["static"].actions.concat([{label:OO.ui.deferMsg("visualeditor-dialog-action-cancel"),flags:"safe",modes:["edit","insert"]},{action:"done",label:OO.ui.deferMsg("visualeditor-dialog-action-done"),flags:["progressive","primary"],modes:"edit"},{action:"done",label:OO.ui.deferMsg("visualeditor-dialog-action-insert"),flags:["constructive","primary"],modes:"insert"}]),ve.ui.FragmentInspector.prototype.onFormSubmit=function(){this.executeAction("done")},ve.ui.FragmentInspector.prototype.getFragment=function(){return this.fragment},ve.ui.FragmentInspector.prototype.getMode=function(){return this.fragment?this.fragment.getSelectedModels().length?"edit":"insert":""},ve.ui.FragmentInspector.prototype.initialize=function(){ve.ui.FragmentInspector["super"].prototype.initialize.call(this),this.container=new OO.ui.PanelLayout({scrollable:!0,classes:["ve-ui-fragmentInspector-container"]}),this.form=new OO.ui.FormLayout({classes:["ve-ui-fragmentInspector-form"]}),this.form.connect(this,{submit:"onFormSubmit"}),this.$element.addClass("ve-ui-fragmentInspector"),this.$content.addClass("ve-ui-fragmentInspector-content"),this.container.$element.append(this.form.$element,this.$otherActions),this.$body.append(this.container.$element)},ve.ui.FragmentInspector.prototype.getActionProcess=function(a){return"done"===a?new OO.ui.Process(function(){this.close({action:"done"})},this):ve.ui.FragmentInspector["super"].prototype.getActionProcess.call(this,a)},ve.ui.FragmentInspector.prototype.getSetupProcess=function(a){return a=a||{},ve.ui.FragmentInspector["super"].prototype.getSetupProcess.call(this,a).first(function(){if(!(a.fragment instanceof ve.dm.SurfaceFragment))throw new Error("Cannot open inspector: opening data must contain a fragment");
this.fragment=a.fragment,this.previousSelection=this.fragment.getSelection()},this).next(function(){this.actions.setMode(this.getMode())},this)},ve.ui.FragmentInspector.prototype.getTeardownProcess=function(a){return ve.ui.FragmentDialog["super"].prototype.getTeardownProcess.apply(this,a).next(function(){this.fragment=null,this.previousSelection=null},this)},ve.ui.FragmentInspector.prototype.getReadyProcess=function(a){return ve.ui.FragmentInspector["super"].prototype.getReadyProcess.call(this,a).first(0)},ve.ui.FragmentInspector.prototype.getBodyHeight=function(){return Math.ceil(this.container.$element[0].scrollHeight)+1},ve.ui.AnnotationInspector=function(a){ve.ui.FragmentInspector.call(this,a),this.initialSelection=null,this.initialAnnotation=null,this.initialAnnotationIsCovering=!1},OO.inheritClass(ve.ui.AnnotationInspector,ve.ui.FragmentInspector),ve.ui.AnnotationInspector["static"].modelClasses=[],ve.ui.AnnotationInspector["static"].actions=[{action:"remove",label:OO.ui.deferMsg("visualeditor-inspector-remove-tooltip"),flags:"destructive",modes:"edit"},{action:"done",label:OO.ui.deferMsg("visualeditor-dialog-action-done"),flags:["progressive","primary"],modes:"edit"},{label:OO.ui.deferMsg("visualeditor-dialog-action-cancel"),flags:"safe",modes:["edit","insert"]},{action:"done",label:OO.ui.deferMsg("visualeditor-dialog-action-insert"),flags:["constructive","primary"],modes:"insert"}],ve.ui.AnnotationInspector.prototype.shouldRemoveAnnotation=function(){return!1},ve.ui.AnnotationInspector.prototype.getInsertionData=function(){return this.getInsertionText().split("")},ve.ui.AnnotationInspector.prototype.getInsertionText=function(){return""},ve.ui.AnnotationInspector.prototype.getAnnotation=null,ve.ui.AnnotationInspector.prototype.getAnnotationFromFragment=null,ve.ui.AnnotationInspector.prototype.getMatchingAnnotations=function(a,b){var c=this.constructor["static"].modelClasses;return a.getAnnotations(b).filter(function(a){return ve.isInstanceOfAny(a,c)})},ve.ui.AnnotationInspector.prototype.getMode=function(){return this.fragment?this.fragment.trimLinearSelection().getSelectedModels().length?"edit":"insert":""},ve.ui.AnnotationInspector.prototype.getActionProcess=function(a){return"remove"===a?new OO.ui.Process(function(){this.close({action:"remove"})},this):ve.ui.AnnotationInspector["super"].prototype.getActionProcess.call(this,a)},ve.ui.AnnotationInspector.prototype.getSetupProcess=function(a){return ve.ui.AnnotationInspector["super"].prototype.getSetupProcess.call(this,a).next(function(){var a,b,c,d,e,f=this,g=this.getFragment(),h=g.getSurface(),i=this.getMatchingAnnotations(g,!0).get(0);h.pushStaging(),this.previousSelection instanceof ve.dm.LinearSelection&&!i&&(g.getSelection().isCollapsed()&&g.getDocument().data.isContentOffset(g.getSelection().getRange().start)?(a=g.expandLinearSelection("word"),g=a,d=g.document.data.getAnnotationsFromRange(g.selection.range),e=d.filter(function(a){return ve.isInstanceOfAny(a,f.constructor["static"].modelClasses)}),e.getLength()>0&&(i=e.get(0))):(b=g.trimLinearSelection(),g=b),g.getSelection().isCollapsed()||i||(i=this.getAnnotationFromFragment(g),i&&g.annotateContent("set",i))),i&&(a=g.expandLinearSelection("annotation",i),g=a),g.select(),this.initialSelection=g.getSelection(),this.initialAnnotation=this.getMatchingAnnotations(g,!0).get(0),c=this.getMatchingAnnotations(g).get(0),this.initialAnnotation?c&&c.compareTo(this.initialAnnotation)&&(this.initialAnnotationIsCovering=!0):this.initialAnnotation=this.getAnnotationFromFragment(g),this.fragment=g,this.actions.setMode(this.getMode())},this)},ve.ui.AnnotationInspector.prototype.getTeardownProcess=function(a){return a=a||{},ve.ui.AnnotationInspector["super"].prototype.getTeardownProcess.call(this,a).first(function(){var b,c,d,e,f=!1,g=!1,h=!1,i=this.getAnnotation(),j="remove"===a.action||"done"===a.action&&this.shouldRemoveAnnotation(),k=this.fragment.getSurface(),l=k.getFragment(this.initialSelection,!1),m=this.fragment.getSelection();if(!(m instanceof ve.dm.LinearSelection)||j&&m.getRange().isCollapsed())return void k.popStaging();if(!j){if("done"!==a.action)return void k.popStaging();this.initialSelection.isCollapsed()&&(g=!0),i&&(this.initialAnnotationIsCovering&&this.initialAnnotation&&this.initialAnnotation.compareTo(i)||(h=!0))}if(h?k.popStaging():k.applyStaging(),g&&(e=this.getInsertionData(),e.length&&(l.insertContent(e,!0),l.adjustLinearSelection(-e.length,0),this.previousSelection=new ve.dm.LinearSelection(l.getDocument(),new ve.Range(this.initialSelection.getRange().start+e.length)))),j||h)for(d=this.getMatchingAnnotations(l,!0).get(),b=0,c=d.length;c>b;b++)l.annotateContent("clear",d[b]);h&&(l.getSelection().isCollapsed()?f=!0:l.annotateContent("set",i)),(!a.action||g)&&(m=this.previousSelection),a.action&&k.setSelection(m),f&&k.addInsertionAnnotations(i)},this).next(function(){this.initialSelection=null,this.initialAnnotation=null,this.initialAnnotationIsCovering=!1},this)},ve.ui.NodeInspector=function(a){ve.ui.FragmentInspector.call(this,a),this.selectedNode=null},OO.inheritClass(ve.ui.NodeInspector,ve.ui.FragmentInspector),ve.ui.NodeInspector["static"].modelClasses=[],ve.ui.NodeInspector.prototype.getSelectedNode=function(){var a,b,c=this.constructor["static"].modelClasses,d=this.getFragment().getSelectedNode();for(a=0,b=c.length;b>a;a++)if(d instanceof c[a])return d;return null},ve.ui.NodeInspector.prototype.initialize=function(a){ve.ui.NodeInspector["super"].prototype.initialize.call(this,a),this.$content.addClass("ve-ui-nodeInspector")},ve.ui.NodeInspector.prototype.getSetupProcess=function(a){return ve.ui.NodeInspector["super"].prototype.getSetupProcess.call(this,a).next(function(){this.selectedNode=this.getSelectedNode(a)},this)},ve.ui.NodeInspector.prototype.getTeardownProcess=function(a){return ve.ui.NodeInspector["super"].prototype.getTeardownProcess.call(this,a).next(function(){this.selectedNode=null},this)},ve.ui.LinkAnnotationInspector=function(a){ve.ui.AnnotationInspector.call(this,a)},OO.inheritClass(ve.ui.LinkAnnotationInspector,ve.ui.AnnotationInspector),ve.ui.LinkAnnotationInspector["static"].name="link",ve.ui.LinkAnnotationInspector["static"].title=OO.ui.deferMsg("visualeditor-linkinspector-title"),ve.ui.LinkAnnotationInspector["static"].modelClasses=[ve.dm.LinkAnnotation],ve.ui.LinkAnnotationInspector["static"].actions=ve.ui.LinkAnnotationInspector["super"]["static"].actions.concat([{action:"open",label:OO.ui.deferMsg("visualeditor-linkinspector-open"),modes:["edit","insert"]}]),ve.ui.LinkAnnotationInspector.prototype.onAnnotationInputChange=function(){this.updateActions()},ve.ui.LinkAnnotationInspector.prototype.updateActions=function(){var a=this,b=this.annotationInput.getAnnotation();this.annotationInput.text.isValid().done(function(c){c=c&&!!b,a.actions.forEach({actions:["open","done","insert"]},function(a){a.setDisabled(!c)})})},ve.ui.LinkAnnotationInspector.prototype.shouldRemoveAnnotation=function(){return!this.annotationInput.getAnnotation()},ve.ui.LinkAnnotationInspector.prototype.getInsertionText=function(){return this.annotationInput.getHref()},ve.ui.LinkAnnotationInspector.prototype.getAnnotation=function(){return this.annotationInput.getAnnotation()},ve.ui.LinkAnnotationInspector.prototype.getAnnotationFromFragment=function(a){var b=a.getText();return b?new ve.dm.LinkAnnotation({type:"link",attributes:{href:a.getText()}}):null},ve.ui.LinkAnnotationInspector.prototype.initialize=function(){ve.ui.LinkAnnotationInspector["super"].prototype.initialize.call(this),this.annotationInput=this.createAnnotationInput(),this.annotationInput.connect(this,{change:"onAnnotationInputChange"}),this.form.$element.append(this.annotationInput.$element)},ve.ui.LinkAnnotationInspector.prototype.createAnnotationInput=function(){return new ve.ui.LinkAnnotationWidget},ve.ui.LinkAnnotationInspector.prototype.getSetupProcess=function(a){return ve.ui.LinkAnnotationInspector["super"].prototype.getSetupProcess.call(this,a).next(function(){this.getFragment().getSurface().disable(),this.annotationInput.setAnnotation(this.initialAnnotation),this.updateActions()},this)},ve.ui.LinkAnnotationInspector.prototype.getReadyProcess=function(a){return ve.ui.LinkAnnotationInspector["super"].prototype.getReadyProcess.call(this,a).next(function(){this.annotationInput.text.focus().select(),this.getFragment().getSurface().enable(),this.annotationInput.text.setValidityFlag(!0)},this)},ve.ui.LinkAnnotationInspector.prototype.getHoldProcess=function(a){return ve.ui.LinkAnnotationInspector["super"].prototype.getHoldProcess.call(this,a).next(function(){this.annotationInput.text.blur()},this)},ve.ui.LinkAnnotationInspector.prototype.getTeardownProcess=function(a){return ve.ui.LinkAnnotationInspector["super"].prototype.getTeardownProcess.call(this,a).next(function(){this.annotationInput.setAnnotation(null)},this)},ve.ui.LinkAnnotationInspector.prototype.getActionProcess=function(a){return"open"===a&&window.open(this.annotationInput.getHref()),ve.ui.LinkAnnotationInspector["super"].prototype.getActionProcess.call(this,a)},ve.ui.windowFactory.register(ve.ui.LinkAnnotationInspector),ve.ui.CommentInspector=function(a){ve.ui.NodeInspector.call(this,a)},OO.inheritClass(ve.ui.CommentInspector,ve.ui.NodeInspector),ve.ui.CommentInspector["static"].name="comment",ve.ui.CommentInspector["static"].icon="comment",ve.ui.CommentInspector["static"].title=OO.ui.deferMsg("visualeditor-commentinspector-title"),ve.ui.CommentInspector["static"].modelClasses=[ve.dm.CommentNode],ve.ui.CommentInspector["static"].size="large",ve.ui.CommentInspector["static"].actions=[{action:"remove",label:OO.ui.deferMsg("visualeditor-inspector-remove-tooltip"),flags:"destructive",modes:"edit"}].concat(ve.ui.FragmentInspector["static"].actions),ve.ui.CommentInspector.prototype.initialize=function(){ve.ui.CommentInspector["super"].prototype.initialize.call(this),this.textWidget=new ve.ui.WhitespacePreservingTextInputWidget({multiline:!0,autosize:!0}),this.previousTextWidgetHeight=0,this.textWidget.connect(this,{change:"onTextInputWidgetChange"}),this.$content.addClass("ve-ui-commentInspector-content"),this.form.$element.append(this.textWidget.$element)},ve.ui.CommentInspector.prototype.onTextInputWidgetChange=function(){var a=this.textWidget.$element.height();a!==this.previousTextWidgetHeight&&(this.updateSize(),this.previousTextWidgetHeight=a)},ve.ui.CommentInspector.prototype.getActionProcess=function(a){return"remove"===a||"insert"===a?new OO.ui.Process(function(){this.close({action:a})},this):ve.ui.CommentInspector["super"].prototype.getActionProcess.call(this,a)},ve.ui.CommentInspector.prototype.getSetupProcess=function(a){return ve.ui.CommentInspector["super"].prototype.getSetupProcess.call(this,a).next(function(){this.getFragment().getSurface().pushStaging(),this.commentNode=this.getSelectedNode(),this.commentNode?this.textWidget.setValueAndWhitespace(this.commentNode.getAttribute("text")||""):(this.textWidget.setWhitespace([" "," "]),this.getFragment().insertContent([{type:"comment",attributes:{text:""}},{type:"/comment"}]),this.commentNode=this.getSelectedNode())},this)},ve.ui.CommentInspector.prototype.getReadyProcess=function(a){return ve.ui.CommentInspector["super"].prototype.getReadyProcess.call(this,a).next(function(){this.getFragment().getSurface().enable(),this.textWidget.focus()},this)},ve.ui.CommentInspector.prototype.getTeardownProcess=function(a){return a=a||{},ve.ui.CommentInspector["super"].prototype.getTeardownProcess.call(this,a).first(function(){var b=this.getFragment().getSurface(),c=this.textWidget.getValue(),d=this.textWidget.getInnerValue();"remove"===a.action||""===d?(b.popStaging(),this.getFragment().removeContent()):(this.getFragment().changeAttributes({text:c}),b.applyStaging()),this.textWidget.setValueAndWhitespace("")},this)},ve.ui.windowFactory.register(ve.ui.CommentInspector),ve.ui.LanguageInspector=function(a){ve.ui.AnnotationInspector.call(this,a)},OO.inheritClass(ve.ui.LanguageInspector,ve.ui.AnnotationInspector),ve.ui.LanguageInspector["static"].name="language",ve.ui.LanguageInspector["static"].title=OO.ui.deferMsg("visualeditor-languageinspector-title"),ve.ui.LanguageInspector["static"].modelClasses=[ve.dm.LanguageAnnotation],ve.ui.LanguageInspector.prototype.getAnnotation=function(){var a=this.languageInput.getLang(),b=this.languageInput.getDir();return a||b?new ve.dm.LanguageAnnotation({type:"meta/language",attributes:{lang:a,dir:b}}):null},ve.ui.LanguageInspector.prototype.getAnnotationFromFragment=function(a){return new ve.dm.LanguageAnnotation({type:"meta/language",attributes:{lang:a.getDocument().getLang(),dir:a.getDocument().getDir()}})},ve.ui.LanguageInspector.prototype.initialize=function(){ve.ui.LanguageInspector["super"].prototype.initialize.call(this),this.languageInput=new ve.ui.LanguageInputWidget({dialogManager:this.manager.getSurface().getDialogs()}),this.form.$element.append(this.languageInput.$element)},ve.ui.LanguageInspector.prototype.getSetupProcess=function(a){return ve.ui.LanguageInspector["super"].prototype.getSetupProcess.call(this,a).next(function(){this.languageInput.setLangAndDir(this.initialAnnotation.getAttribute("lang"),this.initialAnnotation.getAttribute("dir"))},this)},ve.ui.windowFactory.register(ve.ui.LanguageInspector),ve.ui.SpecialCharacterPage=function(a,b){OO.ui.PageLayout.call(this,a,b),this.label=b.label,this.icon=b.icon;var c,d,e=b.characters,f=$("<div>").addClass("ve-ui-specialCharacterPage-characters"),g=f[0];for(c in e)d=document.createElement("div"),d.className="ve-ui-specialCharacterPage-character",e[c].titleMsg&&d.setAttribute("title",ve.msg(e[c].titleMsg)),d.textContent=c,$.data(d,"character",e[c]),g.appendChild(d);this.$element.addClass("ve-ui-specialCharacterPage").append($("<h3>").text(a),f)},OO.inheritClass(ve.ui.SpecialCharacterPage,OO.ui.PageLayout),ve.ui.SpecialCharacterPage.prototype.setupOutlineItem=function(a){ve.ui.SpecialCharacterPage["super"].prototype.setupOutlineItem.call(this,a),this.outlineItem.setLabel(this.label)},ve.ui.DesktopSurface=function(){ve.ui.Surface.apply(this,arguments)},OO.inheritClass(ve.ui.DesktopSurface,ve.ui.Surface),ve.ui.DesktopSurface.prototype.createContext=function(){return new ve.ui.DesktopContext(this)},ve.ui.DesktopSurface.prototype.createDialogWindowManager=function(){return new ve.ui.SurfaceWindowManager(this,{factory:ve.ui.windowFactory})},ve.ui.DesktopContext=function(){ve.ui.DesktopContext["super"].apply(this,arguments),this.popup=new OO.ui.PopupWidget({$container:this.surface.$element}),this.transitioning=null,this.suppressed=!1,this.onWindowResizeHandler=this.onPosition.bind(this),this.$window=$(this.getElementWindow()),this.surface.getView().connect(this,{relocationStart:"onSuppress",relocationEnd:"onUnsuppress",blur:"onSuppress",focus:"onUnsuppress",position:"onPosition"}),this.surface.getModel().connect(this,{select:"onModelSelect"}),this.inspectors.connect(this,{resize:"setPopupSize"}),this.$window.on("resize",this.onWindowResizeHandler),this.$element.addClass("ve-ui-desktopContext").append(this.popup.$element),this.$group.addClass("ve-ui-desktopContext-menu"),this.popup.$body.append(this.$group,this.inspectors.$element)},OO.inheritClass(ve.ui.DesktopContext,ve.ui.LinearContext),ve.ui.DesktopContext.prototype.afterContextChange=function(){ve.ui.DesktopContext["super"].prototype.afterContextChange.call(this),this.suppressed},ve.ui.DesktopContext.prototype.onSuppress=function(){this.suppressed=!0,this.isVisible()&&(this.isEmpty()?this.inspector&&this.inspector.close():(this.toggleMenu(!1),this.toggle(!1)))},ve.ui.DesktopContext.prototype.onUnsuppress=function(){this.suppressed=!1,this.isInspectable()&&(this.toggleMenu(!0),this.toggle(!0))},ve.ui.DesktopContext.prototype.onModelSelect=function(){this.isVisible()&&(this.inspector&&this.inspector.isOpened()&&this.inspector.close(),this.updateDimensionsDebounced())},ve.ui.DesktopContext.prototype.onPosition=function(){this.isVisible()&&this.updateDimensionsDebounced()},ve.ui.DesktopContext.prototype.createInspectorWindowManager=function(){return new ve.ui.DesktopInspectorWindowManager(this.surface,{factory:ve.ui.windowFactory,overlay:this.surface.getLocalOverlay(),modal:!1})},ve.ui.DesktopContext.prototype.onInspectorOpening=function(){ve.ui.DesktopContext["super"].prototype.onInspectorOpening.apply(this,arguments),this.setPopupSize()},ve.ui.DesktopContext.prototype.toggle=function(a){var b;return this.transitioning?this.transitioning:(a=void 0===a?!this.visible:!!a,a===this.visible?$.Deferred().resolve().promise():(this.transitioning=$.Deferred(),b=this.transitioning.promise(),this.popup.toggle(a),ve.ui.DesktopContext["super"].prototype.toggle.call(this,a),this.transitioning.resolve(),this.transitioning=null,this.visible=a,a?(this.inspector&&this.inspector.updateSize(),this.updateDimensions()):this.inspector&&this.inspector.close(),b))},ve.ui.DesktopContext.prototype.updateDimensions=function(){if(this.isVisible()){var a,b,c,d,e,f="rtl"===this.surface.getModel().getDocument().getDir(),g=this.surface.getView(),h=this.inspector&&this.inspector.previousSelection,i=g.getFocusedNode();return e=g.getSelectionBoundingRect(h),e?i&&!i.isContent()?(c=this.isEmbeddable()&&e.height>this.$group.outerHeight()+5&&e.width>this.$group.outerWidth()+10,this.popup.toggleAnchor(!c),c?(b={x:f?e.left:e.right,y:e.top},this.popup.align="backwards"):(d=(e.left+e.right)/2,b={x:d,y:e.bottom},this.popup.align="center")):(a=g.getSelectionStartAndEndRects(h),a&&(d=(e.left+e.right)/2,b=!f&&a.end.right>d||f&&a.end.left<d?{x:d,y:e.bottom}:{x:f?a.end.left:a.end.right,y:a.end.bottom}),this.popup.toggleAnchor(!0),this.popup.align="center"):(this.popup.toggleAnchor(!0),this.popup.align="center"),b&&this.$element.css({left:b.x,top:b.y}),this.setPopupSize(),this}},ve.ui.DesktopContext.prototype.isEmbeddable=function(){var a,b,c=this.getRelatedSources();for(a=0,b=c.length;b>a;a++)if(!c[a].embeddable)return!1;return!0},ve.ui.DesktopContext.prototype.setPopupSize=function(){var a=this.inspector?this.inspector.$frame:this.$group;this.popup.toggleClipping(!1),this.popup.setSize(a.outerWidth(!0),a.outerHeight(!0)),this.popup.scrollElementIntoView()},ve.ui.DesktopContext.prototype.destroy=function(){return this.surface.getView().disconnect(this),this.surface.getModel().disconnect(this),this.$window.off("resize",this.onWindowResizeHandler),ve.ui.DesktopContext["super"].prototype.destroy.call(this)},ve.ui.DesktopInspectorWindowManager=function(a,b){ve.ui.DesktopInspectorWindowManager["super"].call(this,a,b)},OO.inheritClass(ve.ui.DesktopInspectorWindowManager,ve.ui.SurfaceWindowManager),ve.ui.DesktopInspectorWindowManager["static"].sizes={small:{width:200,maxHeight:"100%"},medium:{width:300,maxHeight:"100%"},large:{width:400,maxHeight:"100%"},full:{width:"100%",height:"100%"}};