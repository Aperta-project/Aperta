#! /usr/bin/env bash

# This script will set up valdo in a directory next to your tahi project called ops_valdo/
# when it's done, you'll have to 'cap vagrant deploy:cold' from both tahi and ihat to have
# a fully functional aperta.

# exit immediately if any single command fails
set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
TAHI_DIR="$SCRIPT_DIR/../"
VALDO_REPO_DIR="$TAHI_DIR/../ops_valdo/"
VALDO_FOLDER_DIR="$VALDO_REPO_DIR/valdo/"
APERTA_APP_DIR="$VALDO_FOLDER_DIR/apps/aperta"

command_exists () {
  command -v "$1" >/dev/null 2>&1
}

if ! command_exists s3cmd ; then
  echo "You need to install s3cmd"
  echo "Try 'pip install s3cmd'. For more information, visit https://github.com/s3tools/s3cmd/blob/master/INSTALL"
  exit 1
fi

if [ ! -d "$VALDO_REPO_DIR" ]; then
  git clone git@github.com:PLOS/valdo.git --recursive $VALDO_REPO_DIR
fi
cd "$VALDO_REPO_DIR"
git pull
./refresh_submodules

vagrant plugin install vagrant-vbguest
vagrant plugin install vagrant-salt
vagrant plugin install vagrant-hostmanager
vagrant plugin install vagrant-host-path

cd "$VALDO_FOLDER_DIR"
rm -f vbox.box && s3cmd -c .s3cfg get s3://opsbuild/vbox-java.box vbox.box
vagrant box add -f vbox vbox.box

scp aperta@aperta-frontend-201.sfo.plos.org:secrets/.ploprc "$HOME/.ploprc"

cd "$APERTA_APP_DIR"
vagrant up

echo "If you see no errors above, your environment should now be ready for a cap deploy."
echo "go to your local tahi and ihat repos and run 'cap vagrant deploy:cold'"
echo "Once you've done the cap deploys, you should see tahi running at http://aperta.vagrant.local and ihat at http://aperta.vagrant.local:8888"

echo "If you see an error about a key mismatch, try 'ssh-keygen -R aperta'"
echo "If you're still having problems connecting to the vagrant, check your /etc/hosts file. You may need to run 'vagrant hostmanager' from ops_valdo/valdo/apps/aperta."
