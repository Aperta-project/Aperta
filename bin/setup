#!/usr/bin/env ruby
require 'pathname'
require 'securerandom'

SLANGER_REPO = "git@github.com:Tahi-project/tahi-slanger.git"

def cmd_available? cmd
  `which #{cmd}` != ''
end

$os = `uname`.chomp.downcase.intern
unless $os == :darwin || ($os == :linux && cmd_available?('apt-get'))
  fail 'This setup script is only designed for Mac OS or Debian/Ubuntu.'
end

# path to your application root.
APP_ROOT = Pathname.new File.expand_path('../../',  __FILE__)

def run_pg(cmd)
  out = case $os
  when :darwin
    `#{cmd}`
  when :linux
    cmd = cmd.gsub("\"", "\\\"") # escape quotes
    `sudo su postgres -c "#{cmd}"`
  end

  if $?.to_i != 0
    "postgres command failed: #{out}"
    exit 1
  else
    out
  end
end

def header message
  full = "== #{message} =="
  puts
  puts "=" * full.length
  puts full
  puts "=" * full.length
  puts
end

def brew_install package, options=nil
  if system("brew ls #{package} &>/dev/null")
    puts "#{package} is already installed"
  else
    system "brew install #{package} #{options}"
  end
end

def ensure_postgres_setup
  if !cmd_available?('psql')
    puts "psql isn't available."
    puts "Would you like to install it right now? y/n"
    if gets.match /y/i
      case $os
      when :darwin
        system "brew install postgresql"
      when :linux
        system "apt-get install postgresql"
      end
    else
      puts "Please ensure postgresql is installed and configured."
      exit 1
    end
  end

  puts "Checking to see if postgres is running and accessible..."

  if run_pg("psql -l")
    puts "Success!"
  end
end

def copy_template source, dest
  if File.exist?(dest)
    puts "Not copying from #{source} (#{dest} already exists)."
  else
    puts "Copying #{source} to #{dest}."
    system "cp #{source} #{dest}"
  end
end

def setup_slanger
  if Dir.exist? '../tahi-slanger'
    puts "Slanger repo already cloned."
  elsif !system "cd .. && git clone #{SLANGER_REPO}"
    puts "Couldn't clone repo."
    exit 1
  end

  header 'Installing tahi-slanger dependencies.'

  if !system "cd ../tahi-slanger && bundle install"
    exit 1
  end
end

def create_config_file(path)
  return if File.exists?(path)

  header "Generating default #{path}"
  File.open(path, 'w+') do |f|
    yield f
  end
  puts "Wrote to #{path}"
end


Dir.chdir APP_ROOT do
  system "rm -f setup.log"

  header 'Checking database setup'
  ensure_postgres_setup

  header 'Installing other package dependencies'
  case $os
  when :darwin
    brew_install 'imagemagick', '--with-libtiff'
    %w(node qt).each do |package|
      brew_install package
    end
  when :linux
    system "sudo apt-get install -y imagemagick nodejs qt5-default libqt5webkit5-dev"
  end

  header 'Installing gems'
  system 'gem install bundler --conservative'
  system 'bundle install'

  # Adding slanger to the Gemfile is not recommended: https://github.com/stevegraham/slanger#slanger
  header 'Installing Slanger gem'
  system 'gem install slanger'

  create_config_file('.env.development') do |f|
    f.puts "RAILS_SECRET_TOKEN=#{SecureRandom.hex(64)}"
  end

  header 'Ensuring PostgreSQL tahi role exists'
  # NOTE rolname is not a typo
  # http://stackoverflow.com/questions/8546759/how-to-check-if-a-postgres-user-exists
  roles = run_pg %q[psql postgres -tAc "SELECT 1 FROM pg_roles WHERE rolname='tahi'"]
  if !roles.empty?
    puts 'PostgreSQL user already exists'
  else
    puts 'Creating the tahi PostgreSQL user'
    run_pg('createuser -s -r tahi')
  end

  header 'Copying sample files'
  copy_template 'config/database.yml.sample', 'config/database.yml'
  copy_template 'Procfile.template', 'Procfile.local'

  create_config_file('.foreman') do |f|
    f.puts "port: 5000"
    f.puts "procfile: Procfile.local"
    f.puts "env: ''"
  end

  header 'Preparing development database (output logged to setup.log)'
  system 'bin/rake db:setup >> setup.log'

  header 'Preparing testing database (output logged to setup.log)'
  system 'bin/rake db:setup RAILS_ENV=test >> setup.log'

  header 'Installing javascript dependencies (output logged to setup.log)'
  system 'npm install >> setup.log'
  system 'bundle exec rake ember:install'

  header 'Removing old logs and tempfiles'
  system 'rm -f log/**/*'
  system 'rm -rf tmp/cache'

  header 'setting up overcommit'
  system 'overcommit --install'

  puts
  puts 'Success!'
end
