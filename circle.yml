# Copyright (c) 2018 Public Library of Science
#
# Permission is hereby granted, free of charge, to any person obtaining a
# copy of this software and associated documentation files (the "Software"),
# to deal in the Software without restriction, including without limitation
# the rights to use, copy, modify, merge, publish, distribute, sublicense,
# and/or sell copies of the Software, and to permit persons to whom the
# Software is furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
# THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
# FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
# DEALINGS IN THE SOFTWARE.
## Customize machine
machine:
  timezone:
    America/Los_Angeles

  ruby:
    version:
      2.3.6 # when changing ruby versions, also update the cache_directory path below
  node:
    version: 6.11.1

  environment:
    RAILS_ENV: test
    DATABASE_URL: postgres://ubuntu:@127.0.0.1:5432/circle_test
    FIREFOX_URL: https://download.mozilla.org/?product=firefox-latest&os=linux64&lang=en-US
    FIREFOX_FILE: ff/firefox.tar.bz2
    GECKODRIVER_URL: https://github.com/mozilla/geckodriver/releases/download/v0.20.1/geckodriver-v0.20.1-linux64.tar.gz
    GECKODRIVER_FILE: ff/geckodriver.tar.gz
    # We need to do this because firefox was segfaulting on the circle containers with a symlink
    SELENIUM_FIREFOX_PATH: /home/ubuntu/Aperta/firefox/firefox
    CARD_LOAD: true
    JOBS: 1

## Customize dependencies
dependencies:
  cache_directories:
    - "/opt/circleci/.rvm/gems/ruby-2.3.6@tahi"
    - "client/node_modules"
    - "client/bower_components"
    - ff

  pre:
    - gem update --system
    - mkdir -p ${PWD}/ff
    - gem install bundler -v '1.15.4'
    - bundle config --global jobs 7
    - bundle config --global without staging:production
    - |
        if [ -f ${FIREFOX_FILE} ] ; then
          curl -L -sH "Accept-encoding: gzip" -o ${FIREFOX_FILE} -z ${FIREFOX_FILE} "${FIREFOX_URL}"
        else
          curl -L -sH "Accept-encoding: gzip" -o ${FIREFOX_FILE} "${FIREFOX_URL}"
        fi
    - tar xvf ${FIREFOX_FILE}
    - "echo Using $(${SELENIUM_FIREFOX_PATH} --version)"
    - |
        if [ -f ${GECKODRIVER_FILE} ] ; then
          curl -L -sH "Accept-encoding: gzip" -o ${GECKODRIVER_FILE} -z ${GECKODRIVER_FILE} "${GECKODRIVER_URL}"
        else
          curl -L -sH "Accept-encoding: gzip" -o ${GECKODRIVER_FILE} "${GECKODRIVER_URL}"
        fi
    - tar xvf ${GECKODRIVER_FILE}
    - ln -s ${PWD}/geckodriver /home/ubuntu/bin/geckodriver
    - "echo Using $(geckodriver --version | head -1)"

  override:
    - bundle install: # note ':' here
        timeout: 600


## Customize database setup
database:
  pre:
    # install custom postgres extensions
    - psql -c "CREATE EXTENSION IF NOT EXISTS plpgsql;" -d circle_test
    - psql -c "CREATE EXTENSION IF NOT EXISTS pg_trgm;" -d circle_test
    - psql -c "CREATE EXTENSION IF NOT EXISTS unaccent;" -d circle_test
  override:
    - bundle exec rake db:create db:schema:load
  post:
    - bundle exec rake ember:install:
        timeout: 900 # 15 minutes


## Customize test commands
test:
  override:
    - bundle exec rake circleci:qunit:
       parallel: true
    - bundle exec rspec -p 30 -t ~js --format RspecJunitFormatter --out $CIRCLE_TEST_REPORTS/rspec-unit.xml:
        timeout: 1800
        parallel: true
        files:
          - "**/spec/**/*_spec.rb"
    - xvfb-run -a -s "-screen 0 1280x1024x24" bundle exec rspec -p 30 -t js --format RspecJunitFormatter --out $CIRCLE_TEST_REPORTS/rspec-features.xml:
        timeout: 1800
        parallel: true
        files:
          - "**/spec/**/*_spec.rb"
