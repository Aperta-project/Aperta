#!/usr/bin/env ruby
require "bundler"
require "dotenv"
require 'uri'

def validate_event_stream_config!
  return unless ENV['PUSHER_URL'].nil?
  raise "PUSHER_URL was not set in your .env.#{ENV['RAILS_ENV']} and is required to start slanger."
end

def rails_env
  @rails_env ||= ENV.fetch("RAILS_ENV")
end

Bundler.with_clean_env do
  Dotenv.load
  validate_event_stream_config!
  verbose = "-v" if rails_env == "development"
  url = URI.parse(ENV['PUSHER_URL'])
  begin
    exec("slanger --app_key #{url.user} --secret #{url.password} #{verbose} -w #{ENV.fetch('EVENT_STREAM_WS_HOST')}:#{ENV.fetch('EVENT_STREAM_WS_PORT')}")
  rescue => e
    puts "Slanger failed to start. Are you sure it's installed? `gem install slanger`"
    raise e
  end
end
