#!/usr/bin/env ruby

exit_code = 0
node_total = ENV["CIRCLE_NODE_TOTAL"].to_i
node_index = ENV["CIRCLE_NODE_INDEX"].to_i

cmds = ["bundle exec rspec --exclude-pattern \"spec/features/*_spec.rb\" --tag ~flaky",
        "rake ember:test",
        "bundle exec rspec engines --tag ~flaky",
        "bundle exec rspec spec engines --tag @flaky"]

# divide feature specs into node_total groups
features = Dir["spec/features/*_spec.rb"].sort
cmds += features.each_slice((features.size / node_total) + 1).map do |group|
  "bundle exec rspec -P #{group.join(',')} --tag ~flaky"
end

n = -1
cmds.each do |cmd|
  # divide tasks evenly between nodes, task 0 goes to node 0, task 1
  # to node 1, etc., modulo node_total
  n += 1
  next unless ((n % node_total) == node_index)
  puts cmd
  exit_code = 1 unless system(cmd)
end

exit exit_code
