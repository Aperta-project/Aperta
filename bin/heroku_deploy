#!/usr/bin/env sh

heroku_app_name=$1
version=$2

function print_usage {
  echo "Usage:  $0 <heroku-app-name> <version>"
  echo 
  echo "$0 is for deploying a release branch to tahi. It does not deploy from a tag since it may not exist at the time of deploy."
  echo
  echo "Example:"
  echo "  $0 tahi-lean-workflow 1.5.0"
}

if [ -z $heroku_app_name ] ; then
  echo "Heroku app name must be provided!" 1>&2
  echo
  print_usage
  exit 1
fi

if [ -z $version ] ; then
  echo "Version to deploy must be provided!" 1>&2
  echo
  print_usage
  exit 2
fi

echo "Starting Heroku deploy"
heroku pg:backups capture --app $heroku_app_name &&
git push -f https://git.heroku.com/$heroku_app_name.git origin/release/$version:master &&
heroku run bundle exec rake db:migrate cards:load roles-and-permissions:seed --app $heroku_app_name
