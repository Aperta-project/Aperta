- content_for :control_bar do
  #control-bar-container
    #control-bar
      %section
        %ul
          %li#paper-journal
            - if @paper.journal.logo.present?
              = image_tag @paper.journal.logo.url
            - else
              %div
                = @paper.journal.name
          -# %li#paper-short-title{contenteditable: true, placeholder: 'Type your short title here'}
            = @paper.short_title
        %ul
          - if current_user.admin?
            %li= link_to 'Task Manager', manage_paper_path(@paper)

%main
  %article{data: { 'paper-path' => paper_path(@paper, format: :json) } }
    #toolbar

    %div
      .title
        %h2#paper-title{contenteditable: true, placeholder: 'Type your article title here'}
          = @paper.title

      #paper-abstract{contenteditable: true, placeholder: 'Type your abstract here'}
        = @paper.abstract.html_safe

      - task = Task.where(title: "Add Authors", phase: @paper.phases.where(name: 'Submission Data').first).first
      #paper-authors.editable{class: "#{'completed' if task.completed?}", data: { 'card-name' => "authors", 'paper-title' => truncated_title(@paper), 'paper-path' => paper_path(@paper), 'paper-id' => @paper.to_param, 'task-path' => paper_task_path(@paper, task), authors: @paper.authors_json, 'refresh-on-close' => false }}

      #paper-body.editable{contenteditable: true, placeholder: 'Type the body of your article here'}
        = @paper.body.html_safe

  %aside
    %div
      - author_tasks = Task.where(role: 'author', phase: @paper.phases.where(name: 'Submission Data').first)
      - assigned_tasks = @tasks - author_tasks
      - unless assigned_tasks.empty?
        %ul.assigned-tasks.cards
          %ul.cards
            - assigned_tasks.each do |task|
              - if task.title == 'Register Decision'
                %li
                  = link_to '#', class: "card #{'completed' if task.completed?}", data: { 'card-name' => "register-decision", 'paper-title' => truncated_title(@paper), 'paper-path' => paper_path(@paper), 'paper-id' => @paper.to_param, 'task-path' => paper_task_path(@paper, task), 'task-completed' => task.completed?, 'decision-letters' => {"Accepted" => task.accept_letter, "Rejected" => task.reject_letter, "Revise" => task.revise_letter}.to_json, assignees: User.editors_for(@paper.journal).map { |u| [u.id, u.full_name] }.to_json, 'decision-letter' => @paper.decision_letter, 'decision' => @paper.decision, 'assignee-id' => task.assignee_id } do
                    %span.glyphicon.glyphicon-ok
                    = task.title
              - elsif task.title == 'Tech Check'
                %li
                  = link_to '#', class: "card #{'completed' if task.completed?}", data: { 'card-name' => "tech-check", 'paper-title' => truncated_title(@paper), 'paper-path' => paper_path(@paper), 'paper-id' => @paper.to_param, 'task-path' => paper_task_path(@paper, task), 'assignee-id' => task.assignee_id, assignees: User.admins.map { |u| [u.id, u.full_name] }.to_json } do
                    %span.glyphicon.glyphicon-ok
                    = task.title
              - elsif task.title == 'Reviewer Report'
                %li
                  = link_to '#', class: "card #{'completed' if task.completed?}", data: { 'card-name' => "reviewer-report", 'paper-title' => truncated_title(task.paper), 'paper-path' => paper_path(task.paper), 'paper-id' => task.paper.to_param, 'task-path' => paper_task_path(task.paper, task), 'assignee-id' => task.assignee_id } do
                    %span.glyphicon.glyphicon-ok
                    = task.title
              - elsif task.title == 'Assign Reviewers'
                %li
                  = link_to '#', class: "card #{'completed' if task.completed?}", data: { 'card-name' => "assign-reviewers", 'paper-title' => truncated_title(task.paper), 'paper-path' => paper_path(task.paper), 'paper-id' => task.paper.to_param, 'task-path' => paper_task_path(task.paper, task), 'assignee-id' => task.assignee_id, assignees: User.editors_for(task.paper.journal).map { |u| [u.id, u.full_name] }.to_json, 'reviewer-ids' => task.paper_roles, reviewers: User.reviewers_for(task.paper.journal).map { |u| [u.id, u.full_name] } } do
                    %span.glyphicon.glyphicon-ok
                    = task.title
              - else
                %li
                  = link_to '#', class: "card #{'completed' if task.completed?}", data: { 'overlay-name' => "card-#{task.id}", 'overlay-title' => truncated_title(@paper), 'paper-id' => task.paper.to_param, 'task-id' => task.to_param, 'task-completed' => task.completed? } do
                    %span.glyphicon.glyphicon-ok
                    = task.title
                .hidden{id: "card-#{task.id}-content"}
                  = render task, paper: task.paper

      - task = author_tasks.detect { |t| t.title == 'Upload Manuscript' }
      = link_to '#', class: "card #{'completed' if task.completed?}", data: { 'card-name' => "upload-manuscript", 'paper-title' => truncated_title(@paper), 'upload-paper-path' => upload_paper_path(@paper, format: :json), 'paper-path' => paper_path(@paper), 'paper-id' => @paper.to_param, 'task-path' => paper_task_path(@paper, task), 'refresh-on-close' => false } do
        %span.glyphicon.glyphicon-ok
        = task.title

      - task = author_tasks.detect { |t| t.title == 'Add Authors' }
      = link_to '#', class: "card #{'completed' if task.completed?}", data: { 'card-name' => "authors", 'paper-title' => truncated_title(@paper), 'paper-path' => paper_path(@paper), 'paper-id' => @paper.to_param, 'task-path' => paper_task_path(@paper, task), authors: @paper.authors_json, 'refresh-on-close' => false } do
        %span.glyphicon.glyphicon-ok
        = task.title

      - task = author_tasks.detect { |t| t.title == 'Upload Figures' }
      = link_to '#', class: "card #{'completed' if task.completed?}", data: { 'card-name' => "figures", 'paper-title' => truncated_title(@paper), 'figures-path' => paper_figures_path(@paper), 'paper-path' => paper_path(@paper), 'paper-id' => @paper.to_param, 'task-path' => paper_task_path(@paper, task), figures: @paper.figures.map(&:access_details).to_json, 'refresh-on-close' => false } do
        %span.glyphicon.glyphicon-ok
        = task.title

      - task = author_tasks.detect { |t| t.title == 'Enter Declarations' }
      = link_to '#', class: "card #{'completed' if task.completed?}", data: { 'card-name' => "declarations", 'paper-title' => truncated_title(@paper), 'paper-path' => paper_path(@paper), 'paper-id' => @paper.to_param, 'task-path' => paper_task_path(@paper, task), declarations: @paper.declarations.map { |d| d.slice(:question, :answer, :id) }.to_json, 'refresh-on-close' => false } do
        %span.glyphicon.glyphicon-ok
        = task.title

      %hr
      = link_to 'Submit', new_paper_submission_path(@paper), class: 'primary-button wide-button'

