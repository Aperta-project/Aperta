!function(a){"use strict";function b(a,b,c){var d,e,f,g={},h=[];for(d=0,e=b.length;e>d;d++)g[b[d]]=!0;for(d=0,e=a.length;e>d;d++)f=!!g[a[d]],f===c&&h.push(a[d]);return h}var c={},d=c.hasOwnProperty,e=c.toString;c.initClass=function(a){a.static=a.static||{}},c.inheritClass=function(a,b){if(a.prototype instanceof b)throw new Error("Target already inherits from origin");var d=a.prototype.constructor;a["super"]=a.parent=b,a.prototype=Object.create(b.prototype,{constructor:{value:d,enumerable:!1,writable:!0,configurable:!0}}),c.initClass(b),a.static=Object.create(b.static)},c.mixinClass=function(a,b){var e;for(e in b.prototype)"constructor"!==e&&d.call(b.prototype,e)&&(a.prototype[e]=b.prototype[e]);if(c.initClass(a),b.static)for(e in b.static)d.call(b.static,e)&&(a.static[e]=b.static[e]);else c.initClass(b)},c.cloneObject=function(a){var b,c;c=Object.create(a.constructor.prototype);for(b in a)d.call(a,b)&&(c[b]=a[b]);return c},c.getObjectValues=function(a){var b,c;if(a!==Object(a))throw new TypeError("Called on non-object");c=[];for(b in a)d.call(a,b)&&(c[c.length]=a[b]);return c},c.compare=function(a,b,e){var f,g,h,i,j;if(a===b)return!0;for(j in a)if(d.call(a,j)&&(f=a[j],g=b[j],h=typeof f,i=typeof g,h!==i||("string"===h||"number"===h)&&f!==g||f===Object(f)&&!c.compare(f,g,e)))return!1;return e?!0:c.compare(b,a,!0)},c.copy=function(a,b){var d,e,f,g;if("function"==typeof a.clone)return a.clone();g=Array.isArray(a)?new Array(a.length):{};for(d in a)e=a[d],f=typeof e,g[d]=Array.isArray(e)?c.copy(e,b):e&&"function"==typeof e.clone?b?b(e.clone()):e.clone():e&&"function"==typeof e.cloneNode?b?b(e.cloneNode(!0)):e.cloneNode(!0):c.isPlainObject(e)?c.copy(e,b):b?b(e):e;return g},c.getHash=function(a){return JSON.stringify(a,c.getHash.keySortReplacer)},c.getHash.keySortReplacer=function(a,b){var c,d,e,f;if(b&&"function"==typeof b.getHashObject&&(b=b.getHashObject()),Array.isArray(b)||Object(b)!==b)return b;for(c={},d=Object.keys(b).sort(),e=0,f=d.length;f>e;e+=1)c[d[e]]=b[d[e]];return c},c.simpleArrayUnion=function(){var a,b,c,d,e,f={},g=[];for(a=0,b=arguments.length;b>a;a++)for(c=arguments[a],d=0,e=c.length;e>d;d++)f[c[d]]||(f[c[d]]=!0,g.push(c[d]));return g},c.simpleArrayIntersection=function(a,c){return b(a,c,!0)},c.simpleArrayDifference=function(a,c){return b(a,c,!1)},c.isPlainObject=function(a){if(!a||"[object Object]"!==e.call(a)||a.nodeType||null!=a&&a==a.window)return!1;try{if(a.constructor&&!d.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(b){return!1}return!0},c.EventEmitter=function(){this.bindings={}},c.EventEmitter.prototype.on=function(a,b,c,e){var f;if("function"!=typeof b)throw new Error("Invalid callback. Function or method name expected.");return arguments.length<4&&(e=null),f=d.call(this.bindings,a)?this.bindings[a]:this.bindings[a]=[],f.push({callback:b,args:c,context:e}),this},c.EventEmitter.prototype.once=function(a,b){var c=this,d=function(){c.off(a,d),b.apply(c,Array.prototype.slice.call(arguments,0))};return this.on(a,d)},c.EventEmitter.prototype.off=function(a,b,c){var d,e;if(1===arguments.length)delete this.bindings[a];else{if("function"!=typeof b)throw new Error("Invalid callback. Function expected.");if(!(a in this.bindings&&this.bindings[a].length))return this;for(arguments.length<3&&(c=null),e=this.bindings[a],d=e.length;d--;)e[d].callback===b&&e[d].context===c&&e.splice(d,1);0===e.length&&delete this.bindings[a]}return this},c.EventEmitter.prototype.emit=function(a){var b,c,d,e,f;if(a in this.bindings){for(e=this.bindings[a].slice(),f=Array.prototype.slice.call(arguments,1),b=0,c=e.length;c>b;b++)d=e[b],d.callback.apply(d.context,d.args?d.args.concat(f):f);return!0}return!1},c.EventEmitter.prototype.connect=function(a,b){var c,d,e,f;for(f in b){if(c=b[f],Array.isArray(c)?(e=c.slice(1),c=c[0]):e=[],"string"==typeof c){if(!a[c]||"function"!=typeof a[c])throw new Error("Method not found: "+c);d=a[c]}else d=c;this.on.apply(this,[f,d,e,a])}return this},c.EventEmitter.prototype.disconnect=function(a,b){var c,d,e,f,g;if(b)for(f in b){if(d=b[f],"string"==typeof d){if(!a[d]||"function"!=typeof a[d])throw new Error("Method not found: "+d);e=a[d]}else e=d;this.off(f,e,a)}else for(f in this.bindings)for(g=this.bindings[f],c=g.length;c--;)g[c]&&g[c].context===a&&this.off(f,g[c].callback,a);return this},c.Registry=function(){c.EventEmitter.call(this),this.registry={}},c.mixinClass(c.Registry,c.EventEmitter),c.Registry.prototype.register=function(a,b){var c,d;if("string"==typeof a)this.registry[a]=b,this.emit("register",a,b);else{if(!Array.isArray(a))throw new Error("Name must be a string or array, cannot be a "+typeof a);for(c=0,d=a.length;d>c;c++)this.register(a[c],b)}},c.Registry.prototype.lookup=function(a){return this.registry[a]},c.Factory=function(){c.Factory.parent.call(this),this.entries=[]},c.inheritClass(c.Factory,c.Registry),c.Factory.prototype.register=function(a){var b;if("function"!=typeof a)throw new Error("constructor must be a function, cannot be a "+typeof a);if(b=a.static&&a.static.name,"string"!=typeof b||""===b)throw new Error("Name must be a string and must not be empty");this.entries.push(b),c.Factory.parent.prototype.register.call(this,b,a)},c.Factory.prototype.create=function(a){var b,c,d;if(!this.registry.hasOwnProperty(a))throw new Error("No class registered by that name: "+a);return d=this.registry[a],b=Array.prototype.slice.call(arguments,1),c=Object.create(d.prototype),d.apply(c,b),c},"undefined"!=typeof module&&module.exports?module.exports=c:a.OO=c}(this),function(a){"use strict";a.ui={},a.ui.bind=$.proxy,a.ui.Keys={UNDEFINED:0,BACKSPACE:8,DELETE:46,LEFT:37,RIGHT:39,UP:38,DOWN:40,ENTER:13,END:35,HOME:36,TAB:9,PAGEUP:33,PAGEDOWN:34,ESCAPE:27,SHIFT:16,SPACE:32},a.ui.getUserLanguages=function(){return["en"]},a.ui.getLocalValue=function(b,c,d){var e,f,g;if(b[c])return b[c];for(g=a.ui.getUserLanguages(),e=0,f=g.length;f>e;e++)if(c=g[e],b[c])return b[c];if(b[d])return b[d];for(c in b)return b[c];return void 0},function(){var b={"ooui-outline-control-move-down":"Move item down","ooui-outline-control-move-up":"Move item up","ooui-outline-control-remove":"Remove item","ooui-toolbar-more":"More","ooui-dialog-message-accept":"OK","ooui-dialog-message-reject":"Cancel","ooui-dialog-process-error":"Something went wrong","ooui-dialog-process-dismiss":"Dismiss","ooui-dialog-process-retry":"Try again"};a.ui.msg=function(a){var c=b[a],d=Array.prototype.slice.call(arguments,1);return c="string"==typeof c?c.replace(/\$(\d+)/g,function(a,b){var c=parseInt(b,10);return void 0!==d[c-1]?d[c-1]:"$"+b}):"["+a+"]"},a.ui.deferMsg=function(){var b=arguments;return function(){return a.ui.msg.apply(a.ui,b)}},a.ui.resolveMsg=function(a){return $.isFunction(a)?a():a}}(),a.ui.ActionSet=function(b){b=b||{},a.EventEmitter.call(this),this.list=[],this.categories={actions:"getAction",flags:"getFlags",modes:"getModes"},this.categorized={},this.special={},this.others=[],this.organized=!1,this.changing=!1,this.changed=!1},a.mixinClass(a.ui.ActionSet,a.EventEmitter),a.ui.ActionSet.static.specialFlags=["safe","primary"],a.ui.ActionSet.prototype.onActionChange=function(){this.organized=!1,this.changing?this.changed=!0:this.emit("change")},a.ui.ActionSet.prototype.isSpecial=function(a){var b;for(b in this.special)if(a===this.special[b])return!0;return!1},a.ui.ActionSet.prototype.get=function(a){var b,c,d,e,f,g,h,i;if(a){this.organize(),i=[];for(e in this.categorized)if(d=a[e])for(Array.isArray(d)||(d=[d]),b=0,c=d.length;c>b;b++)f=this.categorized[e][d[b]],Array.isArray(f)&&i.push.apply(i,f);for(b=0,c=i.length;c>b;b++)h=i[b],(void 0!==a.visible&&h.isVisible()!==a.visible||void 0!==a.disabled&&h.isDisabled()!==a.disabled)&&(i.splice(b,1),c--,b--);for(b=0,c=i.length;c>b;b++)for(h=i[b],g=i.lastIndexOf(h);g!==b;)i.splice(g,1),c--,g=i.lastIndexOf(h);return i}return this.list.slice()},a.ui.ActionSet.prototype.getSpecial=function(){return this.organize(),$.extend({},this.special)},a.ui.ActionSet.prototype.getOthers=function(){return this.organize(),this.others.slice()},a.ui.ActionSet.prototype.setMode=function(a){var b,c,d;for(this.changing=!0,b=0,c=this.list.length;c>b;b++)d=this.list[b],d.toggle(d.hasMode(a));return this.organized=!1,this.changing=!1,this.emit("change"),this},a.ui.ActionSet.prototype.setAbilities=function(a){var b,c,d,e;for(b=0,c=this.list.length;c>b;b++)e=this.list[b],d=e.getAction(),void 0!==a[d]&&e.setDisabled(!a[d]);return this},a.ui.ActionSet.prototype.forEach=function(a,b){return this.changed=!1,this.changing=!0,this.get(a).forEach(b),this.changing=!1,this.changed&&this.emit("change"),this},a.ui.ActionSet.prototype.add=function(a){var b,c,d;for(this.changing=!0,b=0,c=a.length;c>b;b++)d=a[b],d.connect(this,{click:["emit","click",d],resize:["emit","resize",d],toggle:["onActionChange"]}),this.list.push(d);return this.organized=!1,this.emit("add",a),this.changing=!1,this.emit("change"),this},a.ui.ActionSet.prototype.remove=function(a){var b,c,d,e;for(this.changing=!0,b=0,c=a.length;c>b;b++)e=a[b],d=this.list.indexOf(e),-1!==d&&(e.disconnect(this),this.list.splice(d,1));return this.organized=!1,this.emit("remove",a),this.changing=!1,this.emit("change"),this},a.ui.ActionSet.prototype.clear=function(){var a,b,c,d=this.list.slice();for(this.changing=!0,a=0,b=this.list.length;b>a;a++)c=this.list[a],c.disconnect(this);return this.list=[],this.organized=!1,this.emit("remove",d),this.changing=!1,this.emit("change"),this},a.ui.ActionSet.prototype.organize=function(){var a,b,c,d,e,f,g,h,i,j,k=this.constructor.static.specialFlags;if(!this.organized){for(this.categorized={},this.special={},this.others=[],a=0,b=this.list.length;b>a;a++)if(f=this.list[a],f.isVisible()){for(g in this.categories)for(this.categorized[g]||(this.categorized[g]={}),h=f[this.categories[g]](),Array.isArray(h)||(h=[h]),c=0,d=h.length;d>c;c++)i=h[c],this.categorized[g][i]||(this.categorized[g][i]=[]),this.categorized[g][i].push(f);for(j=!1,c=0,d=k.length;d>c;c++)if(e=k[c],!this.special[e]&&f.hasFlag(e)){this.special[e]=f,j=!0;break}j||this.others.push(f)}this.organized=!0}return this},a.ui.Element=function(b){b=b||{},this.$=b.$||a.ui.Element.getJQuery(document),this.$element=this.$(this.$.context.createElement(this.getTagName())),this.elementGroup=null,$.isArray(b.classes)&&this.$element.addClass(b.classes.join(" ")),b.text&&this.$element.text(b.text),b.$content&&this.$element.append(b.$content)},a.initClass(a.ui.Element),a.ui.Element.static.tagName="div",a.ui.Element.getJQuery=function(a,b){function c(a){return $(a,c.context)}return c.context=this.getDocument(a),b&&(c.frame=b),c},a.ui.Element.getDocument=function(a){return a[0]&&a[0].ownerDocument||a.context||a.ownerDocument||a.document||9===a.nodeType&&a||null},a.ui.Element.getWindow=function(a){var b=this.getDocument(a);return b.parentWindow||b.defaultView},a.ui.Element.getDir=function(a){var b,c;return a instanceof jQuery&&(a=a[0]),b=9===a.nodeType,c=void 0!==a.document,(b||c)&&(c&&(a=a.document),a=a.body),$(a).css("direction")},a.ui.Element.getFrameOffset=function(a,b,c){var d,e,f,g,h;if(b||(b=window),c||(c={top:0,left:0}),a.parent===a)return c;for(f=a.parent.document.getElementsByTagName("iframe"),d=0,e=f.length;e>d;d++)if(f[d].contentWindow===a){g=f[d];break}return g&&(h=g.getBoundingClientRect(),c.left+=h.left,c.top+=h.top,a!==b&&this.getFrameOffset(a.parent,c)),c},a.ui.Element.getRelativePosition=function(a,b){var c=a.offset(),d=b.offset();return{top:Math.round(c.top-d.top),left:Math.round(c.left-d.left)}},a.ui.Element.getBorders=function(a){var b=a.ownerDocument,c=b.parentWindow||b.defaultView,d=c&&c.getComputedStyle?c.getComputedStyle(a,null):a.currentStyle,e=$(a),f=parseFloat(d?d.borderTopWidth:e.css("borderTopWidth"))||0,g=parseFloat(d?d.borderLeftWidth:e.css("borderLeftWidth"))||0,h=parseFloat(d?d.borderBottomWidth:e.css("borderBottomWidth"))||0,i=parseFloat(d?d.borderRightWidth:e.css("borderRightWidth"))||0;return{top:Math.round(f),left:Math.round(g),bottom:Math.round(h),right:Math.round(i)}},a.ui.Element.getDimensions=function(a){var b,c,d=a.ownerDocument||a.document,e=d.parentWindow||d.defaultView;return e===a||a===d.documentElement?(c=$(e),{borders:{top:0,left:0,bottom:0,right:0},scroll:{top:c.scrollTop(),left:c.scrollLeft()},scrollbar:{right:0,bottom:0},rect:{top:0,left:0,bottom:c.innerHeight(),right:c.innerWidth()}}):(b=$(a),{borders:this.getBorders(a),scroll:{top:b.scrollTop(),left:b.scrollLeft()},scrollbar:{right:b.innerWidth()-a.clientWidth,bottom:b.innerHeight()-a.clientHeight},rect:a.getBoundingClientRect()})},a.ui.Element.getClosestScrollableContainer=function(a,b){var c,d,e=["overflow"],f=$(a).parent();for(("x"===b||"y"===b)&&e.push("overflow-"+b);f.length;){if(f[0]===a.ownerDocument.body)return f[0];for(c=e.length;c--;)if(d=f.css(e[c]),"auto"===d||"scroll"===d)return f[0];f=f.parent()}return this.getDocument(a).body},a.ui.Element.scrollIntoView=function(a,b){b=b||{};var c,d={},e="function"==typeof b.complete&&b.complete,f=this.getClosestScrollableContainer(a,b.direction),g=$(f),h=this.getDimensions(a),i=this.getDimensions(f),j=$(this.getWindow(a));c=g.is("body")?{top:h.rect.top,bottom:j.innerHeight()-h.rect.bottom,left:h.rect.left,right:j.innerWidth()-h.rect.right}:{top:h.rect.top-(i.rect.top+i.borders.top),bottom:i.rect.bottom-i.borders.bottom-i.scrollbar.bottom-h.rect.bottom,left:h.rect.left-(i.rect.left+i.borders.left),right:i.rect.right-i.borders.right-i.scrollbar.right-h.rect.right},b.direction&&"y"!==b.direction||(c.top<0?d.scrollTop=i.scroll.top+c.top:c.top>0&&c.bottom<0&&(d.scrollTop=i.scroll.top+Math.min(c.top,-c.bottom))),b.direction&&"x"!==b.direction||(c.left<0?d.scrollLeft=i.scroll.left+c.left:c.left>0&&c.right<0&&(d.scrollLeft=i.scroll.left+Math.min(c.left,-c.right))),$.isEmptyObject(d)?e&&e():(g.stop(!0).animate(d,b.duration||"fast"),e&&g.queue(function(a){e(),a()}))},a.ui.Element.prototype.getTagName=function(){return this.constructor.static.tagName},a.ui.Element.prototype.isElementAttached=function(){return $.contains(this.getElementDocument(),this.$element[0])},a.ui.Element.prototype.getElementDocument=function(){return a.ui.Element.getDocument(this.$element)},a.ui.Element.prototype.getElementWindow=function(){return a.ui.Element.getWindow(this.$element)},a.ui.Element.prototype.getClosestScrollableElementContainer=function(){return a.ui.Element.getClosestScrollableContainer(this.$element[0])},a.ui.Element.prototype.getElementGroup=function(){return this.elementGroup},a.ui.Element.prototype.setElementGroup=function(a){return this.elementGroup=a,this},a.ui.Element.prototype.scrollElementIntoView=function(b){return a.ui.Element.scrollIntoView(this.$element[0],b)},a.ui.Element.prototype.onDOMEvent=function(b,c){a.ui.Element.onDOMEvent(this.$element,b,c)},a.ui.Element.prototype.offDOMEvent=function(b,c){a.ui.Element.offDOMEvent(this.$element,b,c)},function(){a.ui.Element.onDOMEvent=function(a,b,c){$(a).on(b,c)},a.ui.Element.offDOMEvent=function(a,b,c){$(a).off(b,c)}}(),a.ui.Frame=function(b){a.ui.Frame.super.call(this,b),a.EventEmitter.call(this),this.loading=null,this.config=b,this.dir=null,this.$element.addClass("oo-ui-frame").attr({frameborder:0,scrolling:"no"})},a.inheritClass(a.ui.Frame,a.ui.Element),a.mixinClass(a.ui.Frame,a.EventEmitter),a.ui.Frame.static.tagName="iframe",a.ui.Frame.static.transplantStyles=function(a,b,c){var d,e,f,g,h,i,j,k=$([]),l="oo-ui-frame-transplantStyles-loaded",m=$.Deferred();for(d=0,e=a.styleSheets.length;e>d;d++)f=a.styleSheets[d].ownerNode,f.disabled||("link"===f.nodeName.toLowerCase()?(i="oo-ui-frame-transplantStyles-loaded-"+d,k=k.add($("<div>",b).attr("id",i).appendTo(b.body)),g=b.createElement("style"),g.textContent="@import url("+f.href+");\n#"+i+" { font-family: "+l+"; }"):g=b.importNode(f,!0),b.head.appendChild(g));return j=k,h=setTimeout(function n(){for(;j.length>0&&j.eq(0).css("font-family")===l;)j=j.slice(1);0===j.length?null!==h&&(h=null,k.remove(),m.resolve()):h=setTimeout(n,100)},100),0!==c&&setTimeout(function(){h&&(clearTimeout(h),h=null,k.remove(),m.reject())},c||5e3),m.promise()},a.ui.Frame.prototype.load=function(){var b,c,d=this;return this.loading?this.loading.promise():(this.loading=$.Deferred(),b=this.$element.prop("contentWindow"),c=b.document,this.dir=a.ui.Element.getDir(this.$element)||"ltr",c.open(),c.write('<!doctype html><html><body class="oo-ui-frame-content oo-ui-'+this.getDir()+'" dir="'+this.getDir()+'"></body></html>'),c.close(),this.$=a.ui.Element.getJQuery(c,this),this.$content=this.$(".oo-ui-frame-content").attr("tabIndex",0),this.$document=this.$(c),this.constructor.static.transplantStyles(this.getElementDocument(),this.$document[0]).always(function(){d.emit("load"),d.loading.resolve()}),this.loading.promise())},a.ui.Frame.prototype.setSize=function(a,b){return this.$element.css({width:a,height:b}),this},a.ui.Frame.prototype.getDir=function(){return this.dir},a.ui.Layout=function(b){b=b||{},a.ui.Layout.super.call(this,b),a.EventEmitter.call(this),this.$element.addClass("oo-ui-layout")},a.inheritClass(a.ui.Layout,a.ui.Element),a.mixinClass(a.ui.Layout,a.EventEmitter),a.ui.Widget=function(b){b=$.extend({disabled:!1},b),a.ui.Widget.super.call(this,b),a.EventEmitter.call(this),this.visible=!0,this.disabled=null,this.wasDisabled=null,this.$element.addClass("oo-ui-widget"),this.setDisabled(!!b.disabled)},a.inheritClass(a.ui.Widget,a.ui.Element),a.mixinClass(a.ui.Widget,a.EventEmitter),a.ui.Widget.prototype.isDisabled=function(){return this.disabled},a.ui.Widget.prototype.isVisible=function(){return this.visible},a.ui.Widget.prototype.setDisabled=function(a){var b;return this.disabled=!!a,b=this.isDisabled(),b!==this.wasDisabled&&(this.$element.toggleClass("oo-ui-widget-disabled",b),this.$element.toggleClass("oo-ui-widget-enabled",!b),this.emit("disable",b)),this.wasDisabled=b,this},a.ui.Widget.prototype.toggle=function(a){return a=void 0===a?!this.visible:!!a,a!==this.isVisible()&&(this.visible=a,this.$element.toggle(a),this.emit("toggle",a)),this},a.ui.Widget.prototype.updateDisabled=function(){return this.setDisabled(this.disabled),this},a.ui.Window=function(b,c){var d=this;if(c=c||{},a.ui.Window.super.call(this,c),a.EventEmitter.call(this),!(b instanceof a.ui.WindowManager))throw new Error("Cannot construct window: window must have a manager");this.manager=b,this.initialized=!1,this.visible=!1,this.opening=null,this.closing=null,this.opened=null,this.timing=null,this.size=c.size||this.constructor.static.size,this.frame=new a.ui.Frame({$:this.$}),this.$frame=this.$("<div>"),this.$=function(){throw new Error("this.$() cannot be used until the frame has been initialized.")},this.$element.addClass("oo-ui-window").css("visibility","hidden").append(this.$frame),this.$frame.addClass("oo-ui-window-frame").append(this.frame.$element),this.frame.on("load",function(){d.initialize(),d.initialized=!0,d.$element.hide().css("visibility","")})},a.inheritClass(a.ui.Window,a.ui.Element),a.mixinClass(a.ui.Window,a.EventEmitter),a.ui.Window.static.size="medium",a.ui.Window.prototype.isInitialized=function(){return this.initialized},a.ui.Window.prototype.isVisible=function(){return this.visible},a.ui.Window.prototype.isOpening=function(){return this.manager.isOpening(this)},a.ui.Window.prototype.isClosing=function(){return this.manager.isClosing(this)},a.ui.Window.prototype.isOpened=function(){return this.manager.isOpened(this)},a.ui.Window.prototype.getManager=function(){return this.manager},a.ui.Window.prototype.getFrame=function(){return this.frame},a.ui.Window.prototype.getSize=function(){return this.size},a.ui.Window.prototype.getContentHeight=function(){return Math.round(2*(this.$frame.outerHeight()-this.$frame.innerHeight())+(this.$head.outerHeight(!0)+this.getBodyHeight()+this.$foot.outerHeight(!0)))},a.ui.Window.prototype.getBodyHeight=function(){return this.$body[0].scrollHeight},a.ui.Window.prototype.getSetupProcess=function(){return new a.ui.Process},a.ui.Window.prototype.getReadyProcess=function(){return new a.ui.Process},a.ui.Window.prototype.getHoldProcess=function(){return new a.ui.Process},a.ui.Window.prototype.getTeardownProcess=function(){return new a.ui.Process},a.ui.Window.prototype.setSize=function(a){return this.size=a,this.manager.updateWindowSize(this),this},a.ui.Window.prototype.setDimensions=function(a){return this.$frame.css({width:a.width||"",minWidth:a.minWidth||"",maxWidth:a.maxWidth||""}),this.$frame.css({height:(void 0!==a.height?a.height:this.getContentHeight())||"",minHeight:a.minHeight||"",maxHeight:a.maxHeight||""}),this},a.ui.Window.prototype.initialize=function(){return this.$=this.frame.$,this.$head=this.$("<div>"),this.$body=this.$("<div>"),this.$foot=this.$("<div>"),this.$overlay=this.$("<div>"),this.$head.addClass("oo-ui-window-head"),this.$body.addClass("oo-ui-window-body"),this.$foot.addClass("oo-ui-window-foot"),this.$overlay.addClass("oo-ui-window-overlay"),this.frame.$content.addClass("oo-ui-window-content").append(this.$head,this.$body,this.$foot,this.$overlay),this},a.ui.Window.prototype.open=function(a){return this.manager.openWindow(this,a)},a.ui.Window.prototype.close=function(a){return this.manager.closeWindow(this,a)},a.ui.Window.prototype.load=function(){return this.frame.load()},a.ui.Window.prototype.setup=function(a){var b=this,c=$.Deferred();return this.$element.show(),this.visible=!0,this.getSetupProcess(a).execute().done(function(){b.manager.updateWindowSize(b),b.$element.addClass("oo-ui-window-setup").width(),b.frame.$content.addClass("oo-ui-window-content-setup").width(),c.resolve()}),c.promise()},a.ui.Window.prototype.ready=function(a){var b=this,c=$.Deferred();return this.frame.$content[0].focus(),this.getReadyProcess(a).execute().done(function(){b.$element.addClass("oo-ui-window-ready").width(),b.frame.$content.addClass("oo-ui-window-content-ready").width(),c.resolve()}),c.promise()},a.ui.Window.prototype.hold=function(a){var b=this,c=$.Deferred();return this.getHoldProcess(a).execute().done(function(){var a=b.frame.$content.find(":focus");a.length&&a[0].blur(),b.$element.removeClass("oo-ui-window-ready").width(),b.frame.$content.removeClass("oo-ui-window-content-ready").width(),c.resolve()}),c.promise()},a.ui.Window.prototype.teardown=function(a){var b=this,c=$.Deferred();return this.getTeardownProcess(a).execute().done(function(){b.$element.removeClass("oo-ui-window-setup").width(),b.frame.$content.removeClass("oo-ui-window-content-setup").width(),b.$element.hide(),b.visible=!1,c.resolve()}),c.promise()},a.ui.Dialog=function(b,c){a.ui.Dialog.super.call(this,b,c),this.actions=new a.ui.ActionSet,this.attachedActions=[],this.currentAction=null,this.pending=0,this.actions.connect(this,{click:"onActionClick",resize:"onActionResize",change:"onActionsChange"}),this.$element.addClass("oo-ui-dialog").attr("role","dialog")},a.inheritClass(a.ui.Dialog,a.ui.Window),a.ui.Dialog.static.name="",a.ui.Dialog.static.title="",a.ui.Dialog.static.actions=[],a.ui.Dialog.static.escapable=!0,a.ui.Dialog.prototype.onFrameDocumentKeyDown=function(b){return b.which===a.ui.Keys.ESCAPE?(this.close(),!1):void 0},a.ui.Dialog.prototype.onActionResize=function(){},a.ui.Dialog.prototype.onActionClick=function(a){this.isPending()||(this.currentAction=a,this.executeAction(a.getAction()))},a.ui.Dialog.prototype.onActionsChange=function(){this.detachActions(),this.isClosing()||this.attachActions()},a.ui.Dialog.prototype.isPending=function(){return!!this.pending},a.ui.Dialog.prototype.getActions=function(){return this.actions},a.ui.Dialog.prototype.getActionProcess=function(b){return(new a.ui.Process).next(function(){b||this.close()},this)},a.ui.Dialog.prototype.getSetupProcess=function(b){return b=b||{},a.ui.Dialog.super.prototype.getSetupProcess.call(this,b).next(function(){var c,d,e=[],f=this.constructor.static,g=void 0!==b.actions?b.actions:f.actions;for(this.title.setLabel(void 0!==b.title?b.title:this.constructor.static.title),c=0,d=g.length;d>c;c++)e.push(new a.ui.ActionWidget($.extend({$:this.$},g[c])));this.actions.add(e)},this)},a.ui.Dialog.prototype.getTeardownProcess=function(b){return a.ui.Dialog.super.prototype.getTeardownProcess.call(this,b).first(function(){this.actions.clear(),this.currentAction=null},this)},a.ui.Dialog.prototype.initialize=function(){a.ui.Dialog.super.prototype.initialize.call(this),this.title=new a.ui.LabelWidget({$:this.$}),this.constructor.static.escapable&&this.frame.$document.on("keydown",a.ui.bind(this.onFrameDocumentKeyDown,this)),this.frame.$content.addClass("oo-ui-dialog-content")},a.ui.Dialog.prototype.attachActions=function(){this.attachedActions=this.actions.get()},a.ui.Dialog.prototype.detachActions=function(){var a,b;for(a=0,b=this.attachedActions.length;b>a;a++)this.attachedActions[a].$element.detach();this.attachedActions=[]},a.ui.Dialog.prototype.executeAction=function(b){return this.pushPending(),this.getActionProcess(b).execute().always(a.ui.bind(this.popPending,this))},a.ui.Dialog.prototype.pushPending=function(){return 0===this.pending&&(this.frame.$content.addClass("oo-ui-actionDialog-content-pending"),this.$head.addClass("oo-ui-texture-pending")),this.pending++,this},a.ui.Dialog.prototype.popPending=function(){return 1===this.pending&&(this.frame.$content.removeClass("oo-ui-actionDialog-content-pending"),this.$head.removeClass("oo-ui-texture-pending")),this.pending=Math.max(0,this.pending-1),this},a.ui.WindowManager=function(b){b=b||{},a.ui.WindowManager.super.call(this,b),a.EventEmitter.call(this),this.factory=b.factory,this.modal=void 0===b.modal||!!b.modal,this.windows={},this.opening=null,this.opened=null,this.closing=null,this.size=null,this.currentWindow=null,this.$ariaHidden=null,this.requestedSize=null,this.onWindowResizeTimeout=null,this.onWindowResizeHandler=a.ui.bind(this.onWindowResize,this),this.afterWindowResizeHandler=a.ui.bind(this.afterWindowResize,this),this.onWindowMouseWheelHandler=a.ui.bind(this.onWindowMouseWheel,this),this.onDocumentKeyDownHandler=a.ui.bind(this.onDocumentKeyDown,this),this.$element.on("mousedown",!1),this.$element.addClass("oo-ui-windowManager").toggleClass("oo-ui-windowManager-modal",this.modal)},a.inheritClass(a.ui.WindowManager,a.ui.Element),a.mixinClass(a.ui.WindowManager,a.EventEmitter),a.ui.WindowManager.static.sizes={small:{width:300},medium:{width:500},large:{width:700},full:{width:"100%",height:"100%"}},a.ui.WindowManager.static.defaultSize="medium",a.ui.WindowManager.prototype.onWindowResize=function(){clearTimeout(this.onWindowResizeTimeout),this.onWindowResizeTimeout=setTimeout(this.afterWindowResizeHandler,200)},a.ui.WindowManager.prototype.afterWindowResize=function(){this.currentWindow&&this.updateWindowSize(this.currentWindow)},a.ui.WindowManager.prototype.onWindowMouseWheel=function(){return!1},a.ui.WindowManager.prototype.onDocumentKeyDown=function(b){switch(b.which){case a.ui.Keys.PAGEUP:case a.ui.Keys.PAGEDOWN:case a.ui.Keys.END:case a.ui.Keys.HOME:case a.ui.Keys.LEFT:case a.ui.Keys.UP:case a.ui.Keys.RIGHT:case a.ui.Keys.DOWN:return!1}},a.ui.WindowManager.prototype.isOpening=function(a){return a===this.currentWindow&&!!this.opening&&"pending"===this.opening.state()},a.ui.WindowManager.prototype.isClosing=function(a){return a===this.currentWindow&&!!this.closing&&"pending"===this.closing.state()},a.ui.WindowManager.prototype.isOpened=function(a){return a===this.currentWindow&&!!this.opened&&"pending"===this.opened.state()},a.ui.WindowManager.prototype.hasWindow=function(a){var b;for(b in this.windows)if(this.windows[b]===a)return!0;return!1},a.ui.WindowManager.prototype.getSetupDelay=function(){return 0},a.ui.WindowManager.prototype.getReadyDelay=function(){return 0},a.ui.WindowManager.prototype.getHoldDelay=function(){return 0},a.ui.WindowManager.prototype.getTeardownDelay=function(){return this.modal?250:0},a.ui.WindowManager.prototype.getWindow=function(b){var c=$.Deferred(),d=this.windows[b];return d instanceof a.ui.Window?c.resolve(d):this.factory?this.factory.lookup(b)?(d=this.factory.create(b,this,{$:this.$}),this.addWindows([d]).then(a.ui.bind(c.resolve,c,d),c.reject)):c.reject(new a.ui.Error("Cannot auto-instantiate window: symbolic name is unrecognized by the factory")):c.reject(new a.ui.Error("Cannot get unmanaged window: symbolic name unrecognized as a managed window")),c.promise()},a.ui.WindowManager.prototype.getCurrentWindow=function(){return this.currentWindow},a.ui.WindowManager.prototype.openWindow=function(b,c){var d=this,e=[],f=$.Deferred();return"string"==typeof b?this.getWindow(b).then(function(a){return d.openWindow(a,c)}):(this.hasWindow(b)||f.reject(new a.ui.Error("Cannot open window: window is not attached to manager")),"rejected"!==f.state()&&(e.push(b.load()),this.opening||this.opened?e.push(this.closeWindow(this.currentWindow)):this.closing&&e.push(this.closing),$.when.apply($,e).done(function(){d.modal&&(d.$(d.getElementDocument()).on({keydown:d.onDocumentKeyDownHandler}),d.$(d.getElementWindow()).on({mousewheel:d.onWindowMouseWheelHandler,"orientationchange resize":d.onWindowResizeHandler}),d.$ariaHidden=$("body").children().not(d.$element.parentsUntil("body").last()).attr("aria-hidden","")),d.currentWindow=b,d.opening=f,d.emit("opening",b,f,c),d.updateWindowSize(b),setTimeout(function(){b.setup(c).then(function(){d.opening.notify({state:"setup"}),setTimeout(function(){b.ready(c).then(function(){d.opening.notify({state:"ready"}),d.opening=null,d.opened=$.Deferred(),f.resolve(d.opened.promise(),c)})},d.getReadyDelay())})},d.getSetupDelay())})),f)},a.ui.WindowManager.prototype.closeWindow=function(b,c){var d=this,e=[],f=$.Deferred(),g=this.opened;return"string"==typeof b?b=this.windows[b]:this.hasWindow(b)||(b=null),b?b!==this.currentWindow?f.reject(new a.ui.Error("Cannot close window: window already closed with different data")):this.closing&&f.reject(new a.ui.Error("Cannot close window: window already closing with different data")):f.reject(new a.ui.Error("Cannot close window: window is not attached to manager")),"rejected"!==f.state()&&(this.opening&&e.push(this.opening),$.when.apply($,e).done(function(){d.closing=f,d.emit("closing",b,f,c),d.opened=null,g.resolve(f.promise(),c),setTimeout(function(){b.hold(c).then(function(){f.notify({state:"hold"}),setTimeout(function(){b.teardown(c).then(function(){f.notify({state:"teardown"}),d.modal&&(d.$(d.getElementDocument()).off({keydown:d.onDocumentKeyDownHandler}),d.$(d.getElementWindow()).off({mousewheel:d.onWindowMouseWheelHandler,"orientationchange resize":d.onWindowResizeHandler})),d.$ariaHidden&&(d.$ariaHidden.removeAttr("aria-hidden"),d.$ariaHidden=null),d.closing=null,d.currentWindow=null,f.resolve(c)})},d.getTeardownDelay())})},d.getHoldDelay())})),f},a.ui.WindowManager.prototype.addWindows=function(a){var b,c,d,e,f,g=[];if($.isArray(a))for(f={},b=0,c=a.length;c>b;b++){if(e=a[b].constructor.static.name,"string"!=typeof e)throw new Error("Cannot add window");f[e]=a[b]}else $.isPlainObject(a)&&(f=a);for(e in f)d=f[e],this.windows[e]=d,this.$element.append(d.$element),this.isElementAttached()&&g.push(d.load());return $.when.apply($,g)},a.ui.WindowManager.prototype.removeWindows=function(b){var c,d,e,f,g=this,h=[],i=function(a,b){delete g.windows[a],b.$element.detach()};for(c=0,d=b.length;d>c;c++){if(f=b[c],e=this.windows[f],!e)throw new Error("Cannot remove window");h.push(this.closeWindow(f).then(a.ui.bind(i,null,f,e)))}return $.when.apply($,h)},a.ui.WindowManager.prototype.clearWindows=function(){return this.removeWindows(Object.keys(this.windows))},a.ui.WindowManager.prototype.updateWindowSize=function(b){if(b===this.currentWindow){var c=a.ui.Element.getDimensions(b.getElementWindow()),d=this.constructor.static.sizes,e=b.getSize();return d[e]||(e=this.constructor.static.defaultSize),"full"!==e&&c.rect.right-c.rect.left<d[e].width&&(e="full"),this.$element.toggleClass("oo-ui-windowManager-fullscreen","full"===e),this.$element.toggleClass("oo-ui-windowManager-floating","full"!==e),b.setDimensions(d[e]),this}},a.ui.Error=function(a,b){b=b||{},this.message=a instanceof jQuery?a:String(a),this.recoverable=void 0===b.recoverable||!!b.recoverable
},a.initClass(a.ui.Error),a.ui.Error.prototype.isRecoverable=function(){return this.recoverable},a.ui.Error.prototype.getMessage=function(){return this.message instanceof jQuery?this.message.clone():$("<div>").text(this.message).contents()},a.ui.Error.prototype.getMessageText=function(){return this.message instanceof jQuery?this.message.text():this.message},a.ui.Process=function(a,b){this.steps=[],void 0!==a&&this.next(a,b)},a.initClass(a.ui.Process),a.ui.Process.prototype.execute=function(){function b(b){return function(){var c,d=b.callback.call(b.context);if(d===!1)return $.Deferred().reject([]).promise();if("number"==typeof d){if(0>d)throw new Error("Cannot go back in time: flux capacitor is out of service");return c=$.Deferred(),setTimeout(c.resolve,d),c.promise()}return d instanceof a.ui.Error?$.Deferred().reject([d]).promise():$.isArray(d)&&d.length&&d[0]instanceof a.ui.Error?$.Deferred().reject(d).promise():d&&$.isFunction(d.promise)?d.promise():$.Deferred().resolve().promise()}}var c,d,e;if(this.steps.length)for(e=b(this.steps[0])(),c=1,d=this.steps.length;d>c;c++)e=e.then(b(this.steps[c]));else e=$.Deferred().resolve().promise();return e},a.ui.Process.prototype.createStep=function(a,b){if("number"==typeof a||$.isFunction(a.promise))return{callback:function(){return a},context:null};if($.isFunction(a))return{callback:a,context:b};throw new Error("Cannot create process step: number, promise or function expected")},a.ui.Process.prototype.first=function(a,b){return this.steps.unshift(this.createStep(a,b)),this},a.ui.Process.prototype.next=function(a,b){return this.steps.push(this.createStep(a,b)),this},a.ui.ToolFactory=function(){a.ui.ToolFactory.super.call(this)},a.inheritClass(a.ui.ToolFactory,a.Factory),a.ui.ToolFactory.prototype.getTools=function(b,c,d,e){var f,g,h,i,j,k=[],l={};for(h=a.simpleArrayDifference(this.extract(b),this.extract(c)),i=this.extract(d,l),j=this.extract(e,l),f=0,g=h.length;g>f;f++)l[h[f]]||k.push(h[f]);return i.concat(k).concat(j)},a.ui.ToolFactory.prototype.extract=function(b,c){var d,e,f,g,h,i=[];if("*"===b)for(g in this.registry)h=this.registry[g],!h.static.autoAddToCatchall||c&&c[g]||(i.push(g),c&&(c[g]=!0));else if($.isArray(b))for(d=0,e=b.length;e>d;d++)if(f=b[d],"string"==typeof f&&(f={name:f}),a.isPlainObject(f))if(f.group)for(g in this.registry)h=this.registry[g],h.static.group!==f.group||!h.static.autoAddToGroup||c&&c[g]||(i.push(g),c&&(c[g]=!0));else!f.name||c&&c[f.name]||(i.push(f.name),c&&(c[f.name]=!0));return i},a.ui.ToolGroupFactory=function(){a.Factory.call(this);var b,c,d=this.constructor.static.getDefaultClasses();for(b=0,c=d.length;c>b;b++)this.register(d[b])},a.inheritClass(a.ui.ToolGroupFactory,a.Factory),a.ui.ToolGroupFactory.static.getDefaultClasses=function(){return[a.ui.BarToolGroup,a.ui.ListToolGroup,a.ui.MenuToolGroup]},a.ui.ButtonedElement=function(b,c){c=c||{},this.$button=b,this.tabIndex=null,this.framed=null,this.active=!1,this.onMouseUpHandler=a.ui.bind(this.onMouseUp,this),this.$button.on("mousedown",a.ui.bind(this.onMouseDown,this)),this.$element.addClass("oo-ui-buttonedElement"),this.$button.addClass("oo-ui-buttonedElement-button").attr("role","button"),this.setTabIndex(c.tabIndex||0),this.setAccessKey(c.accessKey),this.toggleFramed(void 0===c.framed||c.framed)},a.initClass(a.ui.ButtonedElement),a.ui.ButtonedElement.static.cancelButtonMouseDownEvents=!0,a.ui.ButtonedElement.prototype.onMouseDown=function(a){return this.isDisabled()||1!==a.which?!1:(this.tabIndex=this.$button.attr("tabindex"),this.$button.removeAttr("tabindex").addClass("oo-ui-buttonedElement-pressed"),this.getElementDocument().addEventListener("mouseup",this.onMouseUpHandler,!0),this.constructor.static.cancelButtonMouseDownEvents?!1:void 0)},a.ui.ButtonedElement.prototype.onMouseUp=function(a){return this.isDisabled()||1!==a.which?!1:(this.$button.attr("tabindex",this.tabIndex).removeClass("oo-ui-buttonedElement-pressed"),void this.getElementDocument().removeEventListener("mouseup",this.onMouseUpHandler,!0))},a.ui.ButtonedElement.prototype.toggleFramed=function(a){return a=void 0===a?!this.framed:!!a,a!==this.framed&&(this.framed=a,this.$element.toggleClass("oo-ui-buttonedElement-frameless",!a).toggleClass("oo-ui-buttonedElement-framed",a)),this},a.ui.ButtonedElement.prototype.setTabIndex=function(a){return"number"==typeof a&&a>=0?this.$button.attr("tabindex",a):this.$button.removeAttr("tabindex"),this},a.ui.ButtonedElement.prototype.setAccessKey=function(a){return"string"==typeof a&&a.length?this.$button.attr("accesskey",a):this.$button.removeAttr("accesskey"),this},a.ui.ButtonedElement.prototype.setActive=function(a){return this.$button.toggleClass("oo-ui-buttonedElement-active",!!a),this},a.ui.ClippableElement=function(b,c){c=c||{},this.$clippable=b,this.clipping=!1,this.clipped=!1,this.$clippableContainer=null,this.$clippableScroller=null,this.$clippableWindow=null,this.idealWidth=null,this.idealHeight=null,this.onClippableContainerScrollHandler=a.ui.bind(this.clip,this),this.onClippableWindowResizeHandler=a.ui.bind(this.clip,this),this.$clippable.addClass("oo-ui-clippableElement-clippable")},a.ui.ClippableElement.prototype.setClipping=function(b){return b=!!b,this.clipping!==b&&(this.clipping=b,this.clipping?(this.$clippableContainer=this.$(this.getClosestScrollableElementContainer()),this.$clippableScroller=this.$clippableContainer.is("body")?this.$(a.ui.Element.getWindow(this.$clippableContainer)):this.$clippableContainer,this.$clippableScroller.on("scroll",this.onClippableContainerScrollHandler),this.$clippableWindow=this.$(this.getElementWindow()).on("resize",this.onClippableWindowResizeHandler),setTimeout(a.ui.bind(this.clip,this))):(this.$clippableContainer=null,this.$clippableScroller.off("scroll",this.onClippableContainerScrollHandler),this.$clippableScroller=null,this.$clippableWindow.off("resize",this.onClippableWindowResizeHandler),this.$clippableWindow=null)),this},a.ui.ClippableElement.prototype.isClipping=function(){return this.clipping},a.ui.ClippableElement.prototype.isClipped=function(){return this.clipped},a.ui.ClippableElement.prototype.setIdealSize=function(a,b){this.idealWidth=a,this.idealHeight=b},a.ui.ClippableElement.prototype.clip=function(){if(!this.clipping)return this;var a=10,b=this.$clippable.offset(),c=this.$clippableContainer.is("body")?this.$clippableWindow:this.$clippableContainer,d=c.offset()||{top:0,left:0},e=c.innerHeight()-a,f=c.innerWidth()-a,g=this.$clippableScroller.scrollTop(),h=this.$clippableScroller.scrollLeft(),i=d.left+h+f-b.left,j=d.top+g+e-b.top,k=this.$clippable.prop("scrollWidth"),l=this.$clippable.prop("scrollHeight"),m=k>i,n=l>j;return m?this.$clippable.css({overflowX:"auto",width:i}):(this.$clippable.css("width",this.idealWidth||""),this.$clippable.width(),this.$clippable.css("overflowX","")),n?this.$clippable.css({overflowY:"auto",height:j}):(this.$clippable.css("height",this.idealHeight||""),this.$clippable.height(),this.$clippable.css("overflowY","")),this.clipped=m||n,this},a.ui.FlaggableElement=function(a){a=a||{},this.flags={},this.setFlags(a.flags)},a.ui.FlaggableElement.prototype.hasFlag=function(a){return a in this.flags},a.ui.FlaggableElement.prototype.getFlags=function(){return Object.keys(this.flags)},a.ui.FlaggableElement.prototype.clearFlags=function(){var a,b={},c="oo-ui-flaggableElement-";for(a in this.flags)b[a]=!1,delete this.flags[a],this.$element.removeClass(c+a);return this.emit("flag",b),this},a.ui.FlaggableElement.prototype.setFlags=function(b){var c,d,e,f={},g="oo-ui-flaggableElement-";if("string"==typeof b)this.flags[b]=!0,this.$element.addClass(g+b);else if($.isArray(b))for(c=0,d=b.length;d>c;c++)e=b[c],f[e]=!0,this.flags[e]=!0,this.$element.addClass(g+e);else if(a.isPlainObject(b))for(e in b)b[e]?(f[e]=!0,this.flags[e]=!0,this.$element.addClass(g+e)):(f[e]=!1,delete this.flags[e],this.$element.removeClass(g+e));return this.emit("flag",f),this},a.ui.GroupElement=function(a,b){b=b||{},this.$group=a,this.items=[],this.aggregateItemEvents={}},a.ui.GroupElement.prototype.getItems=function(){return this.items.slice(0)},a.ui.GroupElement.prototype.aggregate=function(a){var b,c,d,e,f,g,h;for(g in a){if(h=a[g],g in this.aggregateItemEvents){if(h)throw new Error("Duplicate item event aggregation for "+g);for(b=0,c=this.items.length;c>b;b++)d=this.items[b],d.connect&&d.disconnect&&(f={},f[g]=["emit",h,d],d.disconnect(this,f));delete this.aggregateItemEvents[g]}if(h)for(this.aggregateItemEvents[g]=h,b=0,c=this.items.length;c>b;b++)d=this.items[b],d.connect&&d.disconnect&&(e={},e[g]=["emit",h,d],d.connect(this,e))}},a.ui.GroupElement.prototype.addItems=function(a,b){var c,d,e,f,g,h,i=[];for(c=0,d=a.length;d>c;c++){if(e=a[c],h=$.inArray(e,this.items),h>=0&&(this.removeItems([e]),b>h&&b--),e.connect&&e.disconnect&&!$.isEmptyObject(this.aggregateItemEvents)){g={};for(f in this.aggregateItemEvents)g[f]=["emit",this.aggregateItemEvents[f],e];e.connect(this,g)}e.setElementGroup(this),i.push(e.$element.get(0))}return void 0===b||0>b||b>=this.items.length?(this.$group.append(i),this.items.push.apply(this.items,a)):0===b?(this.$group.prepend(i),this.items.unshift.apply(this.items,a)):(this.items[b].$element.before(i),this.items.splice.apply(this.items,[b,0].concat(a))),this},a.ui.GroupElement.prototype.removeItems=function(a){var b,c,d,e,f,g;for(b=0,c=a.length;c>b;b++)d=a[b],e=$.inArray(d,this.items),-1!==e&&(d.connect&&d.disconnect&&!$.isEmptyObject(this.aggregateItemEvents)&&(f={},g in this.aggregateItemEvents&&(f[g]=["emit",this.aggregateItemEvents[g],d]),d.disconnect(this,f)),d.setElementGroup(null),this.items.splice(e,1),d.$element.detach());return this},a.ui.GroupElement.prototype.clearItems=function(){var a,b,c,d,e;for(a=0,b=this.items.length;b>a;a++)c=this.items[a],c.connect&&c.disconnect&&!$.isEmptyObject(this.aggregateItemEvents)&&(d={},e in this.aggregateItemEvents&&(d[e]=["emit",this.aggregateItemEvents[e],c]),c.disconnect(this,d)),c.setElementGroup(null),c.$element.detach();return this.items=[],this},a.ui.IconedElement=function(a,b){b=b||{},this.$icon=a,this.icon=null,this.$icon.addClass("oo-ui-iconedElement-icon"),this.setIcon(b.icon||this.constructor.static.icon)},a.initClass(a.ui.IconedElement),a.ui.IconedElement.static.icon=null,a.ui.IconedElement.prototype.setIcon=function(b){return b=a.isPlainObject(b)?a.ui.getLocalValue(b,null,"default"):b,this.icon&&this.$icon.removeClass("oo-ui-icon-"+this.icon),"string"==typeof b&&(b=b.trim(),b.length&&(this.$icon.addClass("oo-ui-icon-"+b),this.icon=b)),this.$element.toggleClass("oo-ui-iconedElement",!!this.icon),this},a.ui.IconedElement.prototype.getIcon=function(){return this.icon},a.ui.IndicatedElement=function(a,b){b=b||{},this.$indicator=a,this.indicator=null,this.indicatorLabel=null,this.$indicator.addClass("oo-ui-indicatedElement-indicator"),this.setIndicator(b.indicator||this.constructor.static.indicator),this.setIndicatorTitle(b.indicatorTitle||this.constructor.static.indicatorTitle)},a.initClass(a.ui.IndicatedElement),a.ui.IndicatedElement.static.indicator=null,a.ui.IndicatedElement.static.indicatorTitle=null,a.ui.IndicatedElement.prototype.setIndicator=function(a){return this.indicator&&(this.$indicator.removeClass("oo-ui-indicator-"+this.indicator),this.indicator=null),"string"==typeof a&&(a=a.trim(),a.length&&(this.$indicator.addClass("oo-ui-indicator-"+a),this.indicator=a)),this.$element.toggleClass("oo-ui-indicatedElement",!!this.indicator),this},a.ui.IndicatedElement.prototype.setIndicatorTitle=function(b){return this.indicatorTitle=b=a.ui.resolveMsg(b),"string"==typeof b&&b.length?this.$indicator.attr("title",b):this.$indicator.removeAttr("title"),this},a.ui.IndicatedElement.prototype.getIndicator=function(){return this.indicator},a.ui.IndicatedElement.prototype.getIndicatorTitle=function(){return this.indicatorTitle},a.ui.LabeledElement=function(a,b){b=b||{},this.$label=a,this.label=null,this.$label.addClass("oo-ui-labeledElement-label"),this.setLabel(b.label||this.constructor.static.label),this.autoFitLabel=void 0===b.autoFitLabel||!!b.autoFitLabel},a.initClass(a.ui.LabeledElement),a.ui.LabeledElement.static.label=null,a.ui.LabeledElement.prototype.setLabel=function(b){var c=!1;return this.label=b=a.ui.resolveMsg(b)||null,"string"==typeof b&&b.length?b.match(/^\s*$/)?this.$label.html("&nbsp;"):this.$label.text(b):b instanceof jQuery?this.$label.empty().append(b):(this.$label.empty(),c=!0),this.$element.toggleClass("oo-ui-labeledElement",!c),this.$label.css("display",c?"none":""),this},a.ui.LabeledElement.prototype.getLabel=function(){return this.label},a.ui.LabeledElement.prototype.fitLabel=function(){return this.$label.autoEllipsis&&this.autoFitLabel&&this.$label.autoEllipsis({hasSpan:!1,tooltip:!0}),this},a.ui.PopuppableElement=function(b){b=b||{},this.popup=new a.ui.PopupWidget($.extend({autoClose:!0},b.popup,{$:this.$,$autoCloseIgnore:this.$element}))},a.ui.PopuppableElement.prototype.getPopup=function(){return this.popup},a.ui.TitledElement=function(a,b){b=b||{},this.$titled=a,this.title=null,this.setTitle(b.title||this.constructor.static.title)},a.initClass(a.ui.TitledElement),a.ui.TitledElement.static.title=null,a.ui.TitledElement.prototype.setTitle=function(b){return this.title=b=a.ui.resolveMsg(b)||null,"string"==typeof b&&b.length?this.$titled.attr("title",b):this.$titled.removeAttr("title"),this},a.ui.TitledElement.prototype.getTitle=function(){return this.title},a.ui.Tool=function(b,c){c=c||{},a.ui.Tool.super.call(this,c),a.ui.IconedElement.call(this,this.$("<span>"),c),this.toolGroup=b,this.toolbar=this.toolGroup.getToolbar(),this.active=!1,this.$title=this.$("<span>"),this.$link=this.$("<a>"),this.title=null,this.toolbar.connect(this,{updateState:"onUpdateState"}),this.$title.addClass("oo-ui-tool-title"),this.$link.addClass("oo-ui-tool-link").append(this.$icon,this.$title).prop("tabIndex",0).attr("role","button"),this.$element.data("oo-ui-tool",this).addClass("oo-ui-tool oo-ui-tool-name-"+this.constructor.static.name.replace(/^([^\/]+)\/([^\/]+).*$/,"$1-$2")).append(this.$link),this.setTitle(c.title||this.constructor.static.title)},a.inheritClass(a.ui.Tool,a.ui.Widget),a.mixinClass(a.ui.Tool,a.ui.IconedElement),a.ui.Tool.static.tagName="span",a.ui.Tool.static.name="",a.ui.Tool.static.group="",a.ui.Tool.static.title="",a.ui.Tool.static.autoAddToCatchall=!0,a.ui.Tool.static.autoAddToGroup=!0,a.ui.Tool.static.isCompatibleWith=function(){return!1},a.ui.Tool.prototype.onUpdateState=function(){throw new Error("OO.ui.Tool.onUpdateState not implemented in this subclass:"+this.constructor)},a.ui.Tool.prototype.onSelect=function(){throw new Error("OO.ui.Tool.onSelect not implemented in this subclass:"+this.constructor)},a.ui.Tool.prototype.isActive=function(){return this.active},a.ui.Tool.prototype.setActive=function(a){this.active=!!a,this.active?this.$element.addClass("oo-ui-tool-active"):this.$element.removeClass("oo-ui-tool-active")},a.ui.Tool.prototype.setTitle=function(b){return this.title=a.ui.resolveMsg(b),this.updateTitle(),this},a.ui.Tool.prototype.getTitle=function(){return this.title},a.ui.Tool.prototype.getName=function(){return this.constructor.static.name},a.ui.Tool.prototype.updateTitle=function(){var a=this.toolGroup.constructor.static.titleTooltips,b=this.toolGroup.constructor.static.accelTooltips,c=this.toolbar.getToolAccelerator(this.constructor.static.name),d=[];this.$title.empty().text(this.title).append(this.$("<span>").addClass("oo-ui-tool-accel").text(c)),a&&"string"==typeof this.title&&this.title.length&&d.push(this.title),b&&"string"==typeof c&&c.length&&d.push(c),d.length?this.$link.attr("title",d.join(" ")):this.$link.removeAttr("title")},a.ui.Tool.prototype.destroy=function(){this.toolbar.disconnect(this),this.$element.remove()},a.ui.Toolbar=function(b,c,d){d=d||{},a.ui.Toolbar.super.call(this,d),a.EventEmitter.call(this),a.ui.GroupElement.call(this,this.$("<div>"),d),this.toolFactory=b,this.toolGroupFactory=c,this.groups=[],this.tools={},this.$bar=this.$("<div>"),this.$actions=this.$("<div>"),this.initialized=!1,this.$element.add(this.$bar).add(this.$group).add(this.$actions).on("mousedown touchstart",a.ui.bind(this.onPointerDown,this)),this.$group.addClass("oo-ui-toolbar-tools"),this.$bar.addClass("oo-ui-toolbar-bar").append(this.$group),d.actions&&(this.$actions.addClass("oo-ui-toolbar-actions"),this.$bar.append(this.$actions)),this.$bar.append('<div style="clear:both"></div>'),d.shadow&&this.$bar.append('<div class="oo-ui-toolbar-shadow"></div>'),this.$element.addClass("oo-ui-toolbar").append(this.$bar)},a.inheritClass(a.ui.Toolbar,a.ui.Element),a.mixinClass(a.ui.Toolbar,a.EventEmitter),a.mixinClass(a.ui.Toolbar,a.ui.GroupElement),a.ui.Toolbar.prototype.getToolFactory=function(){return this.toolFactory},a.ui.Toolbar.prototype.getToolGroupFactory=function(){return this.toolGroupFactory},a.ui.Toolbar.prototype.onPointerDown=function(a){var b=this.$(a.target).closest(".oo-ui-widget"),c=this.$element.closest(".oo-ui-widget");return b.length&&b[0]!==c[0]?void 0:!1},a.ui.Toolbar.prototype.initialize=function(){this.initialized=!0},a.ui.Toolbar.prototype.setup=function(a){var b,c,d,e,f=[],g="bar";for(this.reset(),b=0,c=a.length;c>b;b++)e=a[b],"*"===e.include&&(void 0===e.type&&(e.type="list"),void 0===e.label&&(e.label="ooui-toolbar-more")),d=this.getToolGroupFactory().lookup(e.type)?e.type:g,f.push(this.getToolGroupFactory().create(d,this,$.extend({$:this.$},e)));this.addItems(f)},a.ui.Toolbar.prototype.reset=function(){var a,b;for(this.groups=[],this.tools={},a=0,b=this.items.length;b>a;a++)this.items[a].destroy();this.clearItems()},a.ui.Toolbar.prototype.destroy=function(){this.reset(),this.$element.remove()},a.ui.Toolbar.prototype.isToolAvailable=function(a){return!this.tools[a]},a.ui.Toolbar.prototype.reserveTool=function(a){this.tools[a.getName()]=a},a.ui.Toolbar.prototype.releaseTool=function(a){delete this.tools[a.getName()]},a.ui.Toolbar.prototype.getToolAccelerator=function(){return void 0},a.ui.ToolGroup=function(b,c){c=c||{},a.ui.ToolGroup.super.call(this,c),a.ui.GroupElement.call(this,this.$("<div>"),c),this.toolbar=b,this.tools={},this.pressed=null,this.autoDisabled=!1,this.include=c.include||[],this.exclude=c.exclude||[],this.promote=c.promote||[],this.demote=c.demote||[],this.onCapturedMouseUpHandler=a.ui.bind(this.onCapturedMouseUp,this),this.$element.on({"mousedown touchstart":a.ui.bind(this.onPointerDown,this),"mouseup touchend":a.ui.bind(this.onPointerUp,this),mouseover:a.ui.bind(this.onMouseOver,this),mouseout:a.ui.bind(this.onMouseOut,this)}),this.toolbar.getToolFactory().connect(this,{register:"onToolFactoryRegister"}),this.aggregate({disable:"itemDisable"}),this.connect(this,{itemDisable:"updateDisabled"}),this.$group.addClass("oo-ui-toolGroup-tools"),this.$element.addClass("oo-ui-toolGroup").append(this.$group),this.populate()},a.inheritClass(a.ui.ToolGroup,a.ui.Widget),a.mixinClass(a.ui.ToolGroup,a.ui.GroupElement),a.ui.ToolGroup.static.titleTooltips=!1,a.ui.ToolGroup.static.accelTooltips=!1,a.ui.ToolGroup.static.autoDisable=!0,a.ui.ToolGroup.prototype.isDisabled=function(){return this.autoDisabled||a.ui.ToolGroup.super.prototype.isDisabled.apply(this,arguments)},a.ui.ToolGroup.prototype.updateDisabled=function(){var b,c,d=!0;if(this.constructor.static.autoDisable){for(b=this.items.length-1;b>=0;b--)if(c=this.items[b],!c.isDisabled()){d=!1;break}this.autoDisabled=d}a.ui.ToolGroup.super.prototype.updateDisabled.apply(this,arguments)},a.ui.ToolGroup.prototype.onPointerDown=function(a){return!this.isDisabled()&&a.which<=1&&(this.pressed=this.getTargetTool(a),this.pressed&&(this.pressed.setActive(!0),this.getElementDocument().addEventListener("mouseup",this.onCapturedMouseUpHandler,!0))),!1},a.ui.ToolGroup.prototype.onCapturedMouseUp=function(a){this.getElementDocument().removeEventListener("mouseup",this.onCapturedMouseUpHandler,!0),this.onPointerUp(a)},a.ui.ToolGroup.prototype.onPointerUp=function(a){var b=this.getTargetTool(a);return!this.isDisabled()&&a.which<=1&&this.pressed&&this.pressed===b&&this.pressed.onSelect(),this.pressed=null,!1},a.ui.ToolGroup.prototype.onMouseOver=function(a){var b=this.getTargetTool(a);this.pressed&&this.pressed===b&&this.pressed.setActive(!0)},a.ui.ToolGroup.prototype.onMouseOut=function(a){var b=this.getTargetTool(a);this.pressed&&this.pressed===b&&this.pressed.setActive(!1)},a.ui.ToolGroup.prototype.getTargetTool=function(a){var b,c=this.$(a.target).closest(".oo-ui-tool-link");return c.length&&(b=c.parent().data("oo-ui-tool")),b&&!b.isDisabled()?b:null},a.ui.ToolGroup.prototype.onToolFactoryRegister=function(){this.populate()},a.ui.ToolGroup.prototype.getToolbar=function(){return this.toolbar},a.ui.ToolGroup.prototype.populate=function(){var a,b,c,d,e=this.toolbar.getToolFactory(),f={},g=[],h=[],i=this.toolbar.getToolFactory().getTools(this.include,this.exclude,this.promote,this.demote);for(a=0,b=i.length;b>a;a++)c=i[a],e.lookup(c)&&(this.toolbar.isToolAvailable(c)||this.tools[c])&&(d=this.tools[c],d||(this.tools[c]=d=e.create(c,this),d.updateTitle()),this.toolbar.reserveTool(d),g.push(d),f[c]=!0);for(c in this.tools)f[c]||(this.tools[c].destroy(),this.toolbar.releaseTool(this.tools[c]),h.push(this.tools[c]),delete this.tools[c]);h.length&&this.removeItems(h),g.length?this.$element.removeClass("oo-ui-toolGroup-empty"):this.$element.addClass("oo-ui-toolGroup-empty"),this.addItems(g),this.updateDisabled()},a.ui.ToolGroup.prototype.destroy=function(){var a;this.clearItems(),this.toolbar.getToolFactory().disconnect(this);for(a in this.tools)this.toolbar.releaseTool(this.tools[a]),this.tools[a].disconnect(this).destroy(),delete this.tools[a];this.$element.remove()},a.ui.MessageDialog=function(b,c){a.ui.MessageDialog.super.call(this,b,c),this.verticalActionLayout=null,this.$element.addClass("oo-ui-messageDialog")},a.inheritClass(a.ui.MessageDialog,a.ui.Dialog),a.ui.MessageDialog.static.name="message",a.ui.MessageDialog.static.size="small",a.ui.MessageDialog.static.verbose=!1,a.ui.MessageDialog.static.title=null,a.ui.MessageDialog.static.message=null,a.ui.MessageDialog.static.actions=[{action:"accept",label:a.ui.deferMsg("ooui-dialog-message-accept"),flags:"primary"},{action:"reject",label:a.ui.deferMsg("ooui-dialog-message-reject"),flags:"safe"}],a.ui.MessageDialog.prototype.onActionResize=function(b){return this.fitActions(),a.ui.ProcessDialog.super.prototype.onActionResize.call(this,b)},a.ui.MessageDialog.prototype.toggleVerticalActionLayout=function(a){return a=void 0===a?!this.verticalActionLayout:!!a,a!==this.verticalActionLayout&&(this.verticalActionLayout=a,this.$actions.toggleClass("oo-ui-messageDialog-actions-vertical",a).toggleClass("oo-ui-messageDialog-actions-horizontal",!a)),this},a.ui.MessageDialog.prototype.getActionProcess=function(b){return b?new a.ui.Process(function(){this.close({action:b})},this):a.ui.MessageDialog.super.prototype.getActionProcess.call(this,b)},a.ui.MessageDialog.prototype.getSetupProcess=function(b){return b=b||{},a.ui.MessageDialog.super.prototype.getSetupProcess.call(this,b).next(function(){this.title.setLabel(void 0!==b.title?b.title:this.constructor.static.title),this.message.setLabel(void 0!==b.message?b.message:this.constructor.static.message),this.message.$element.toggleClass("oo-ui-messageDialog-message-verbose",void 0!==b.verbose?b.verbose:this.constructor.static.verbose)},this)},a.ui.MessageDialog.prototype.getBodyHeight=function(){return Math.round(this.text.$element.outerHeight(!0))},a.ui.MessageDialog.prototype.initialize=function(){a.ui.MessageDialog.super.prototype.initialize.call(this),this.$actions=this.$("<div>"),this.container=new a.ui.PanelLayout({$:this.$,scrollable:!0,classes:["oo-ui-messageDialog-container"]}),this.text=new a.ui.PanelLayout({$:this.$,padded:!0,expanded:!1,classes:["oo-ui-messageDialog-text"]}),this.message=new a.ui.LabelWidget({$:this.$,classes:["oo-ui-messageDialog-message"]}),this.title.$element.addClass("oo-ui-messageDialog-title"),this.frame.$content.addClass("oo-ui-messageDialog-content"),this.container.$element.append(this.text.$element),this.text.$element.append(this.title.$element,this.message.$element),this.$body.append(this.container.$element),this.$actions.addClass("oo-ui-messageDialog-actions"),this.$foot.append(this.$actions)},a.ui.MessageDialog.prototype.attachActions=function(){var b,c,d,e,f;if(a.ui.MessageDialog.super.prototype.attachActions.call(this),e=this.actions.getSpecial(),f=this.actions.getOthers(),e.safe&&(this.$actions.append(e.safe.$element),e.safe.toggleFramed(!1)),f.length)for(b=0,c=f.length;c>b;b++)d=f[b],this.$actions.append(d.$element),d.toggleFramed(!1);e.primary&&(this.$actions.append(e.primary.$element),e.primary.toggleFramed(!1)),this.fitActions(),this.isOpening()||this.manager.updateWindowSize(this),this.$body.css("bottom",this.$foot.outerHeight(!0))},a.ui.MessageDialog.prototype.fitActions=function(){var a,b,c,d=this.actions.get();for(this.toggleVerticalActionLayout(!1),a=0,b=d.length;b>a;a++)if(c=d[a],c.$element.innerWidth()<c.$label.outerWidth(!0)){this.toggleVerticalActionLayout(!0);break}},a.ui.ProcessDialog=function(b,c){a.ui.ProcessDialog.super.call(this,b,c),this.$element.addClass("oo-ui-processDialog")},a.inheritClass(a.ui.ProcessDialog,a.ui.Dialog),a.ui.ProcessDialog.prototype.onDismissErrorButtonClick=function(){this.hideErrors()},a.ui.ProcessDialog.prototype.onRetryButtonClick=function(){this.hideErrors(),this.executeAction(this.currentAction.getAction())},a.ui.ProcessDialog.prototype.onActionResize=function(b){return this.actions.isSpecial(b)&&this.fitLabel(),a.ui.ProcessDialog.super.prototype.onActionResize.call(this,b)},a.ui.ProcessDialog.prototype.initialize=function(){a.ui.ProcessDialog.super.prototype.initialize.call(this),this.$navigation=this.$("<div>"),this.$location=this.$("<div>"),this.$safeActions=this.$("<div>"),this.$primaryActions=this.$("<div>"),this.$otherActions=this.$("<div>"),this.dismissButton=new a.ui.ButtonWidget({$:this.$,label:a.ui.msg("ooui-dialog-process-dismiss")}),this.retryButton=new a.ui.ButtonWidget({$:this.$,label:a.ui.msg("ooui-dialog-process-retry")}),this.$errors=this.$("<div>"),this.$errorsTitle=this.$("<div>"),this.dismissButton.connect(this,{click:"onDismissErrorButtonClick"}),this.retryButton.connect(this,{click:"onRetryButtonClick"}),this.title.$element.addClass("oo-ui-processDialog-title"),this.$location.append(this.title.$element).addClass("oo-ui-processDialog-location"),this.$safeActions.addClass("oo-ui-processDialog-actions-safe"),this.$primaryActions.addClass("oo-ui-processDialog-actions-primary"),this.$otherActions.addClass("oo-ui-processDialog-actions-other"),this.$errorsTitle.addClass("oo-ui-processDialog-errors-title").text(a.ui.msg("ooui-dialog-process-error")),this.$errors.addClass("oo-ui-processDialog-errors").append(this.$errorsTitle,this.dismissButton.$element,this.retryButton.$element),this.frame.$content.addClass("oo-ui-processDialog-content").append(this.$errors),this.$navigation.addClass("oo-ui-processDialog-navigation").append(this.$safeActions,this.$location,this.$primaryActions),this.$head.append(this.$navigation),this.$foot.append(this.$otherActions)},a.ui.ProcessDialog.prototype.attachActions=function(){var b,c,d,e,f;if(a.ui.ProcessDialog.super.prototype.attachActions.call(this),e=this.actions.getSpecial(),f=this.actions.getOthers(),e.primary&&(this.$primaryActions.append(e.primary.$element),e.primary.toggleFramed(!0)),f.length)for(b=0,c=f.length;c>b;b++)d=f[b],this.$otherActions.append(d.$element),d.toggleFramed(!0);e.safe&&(this.$safeActions.append(e.safe.$element),e.safe.toggleFramed(!0)),this.fitLabel(),this.$body.css("bottom",this.$foot.outerHeight(!0))},a.ui.ProcessDialog.prototype.executeAction=function(b){a.ui.ProcessDialog.super.prototype.executeAction.call(this,b).fail(a.ui.bind(this.showErrors,this))},a.ui.ProcessDialog.prototype.fitLabel=function(){var a=Math.max(this.$safeActions.is(":visible")?this.$safeActions.width():0,this.$primaryActions.is(":visible")?this.$primaryActions.width():0);return this.$location.css({paddingLeft:a,paddingRight:a}),this},a.ui.ProcessDialog.prototype.showErrors=function(a){var b,c,d,e=[],f=!0;for(b=0,c=a.length;c>b;b++)a[b].isRecoverable()||(f=!1),d=this.$("<div>").addClass("oo-ui-processDialog-error").append(a[b].getMessage()),e.push(d[0]);this.$errorItems=this.$(e),f?this.retryButton.clearFlags().setFlags(this.currentAction.getFlags()):this.currentAction.setDisabled(!0),this.retryButton.toggle(f),this.$errorsTitle.after(this.$errorItems),this.$errors.show().scrollTop(0)},a.ui.ProcessDialog.prototype.hideErrors=function(){this.$errors.hide(),this.$errorItems.remove(),this.$errorItems=null},a.ui.BookletLayout=function(b){b=b||{},a.ui.BookletLayout.super.call(this,b),this.currentPageName=null,this.pages={},this.ignoreFocus=!1,this.stackLayout=new a.ui.StackLayout({$:this.$,continuous:!!b.continuous}),this.autoFocus=void 0===b.autoFocus||!!b.autoFocus,this.outlineVisible=!1,this.outlined=!!b.outlined,this.outlined&&(this.editable=!!b.editable,this.outlineControlsWidget=null,this.outlineWidget=new a.ui.OutlineWidget({$:this.$}),this.outlinePanel=new a.ui.PanelLayout({$:this.$,scrollable:!0}),this.gridLayout=new a.ui.GridLayout([this.outlinePanel,this.stackLayout],{$:this.$,widths:[1,2]}),this.outlineVisible=!0,this.editable&&(this.outlineControlsWidget=new a.ui.OutlineControlsWidget(this.outlineWidget,{$:this.$}))),this.stackLayout.connect(this,{set:"onStackLayoutSet"}),this.outlined&&this.outlineWidget.connect(this,{select:"onOutlineWidgetSelect"}),this.autoFocus&&this.stackLayout.onDOMEvent("focusin",a.ui.bind(this.onStackLayoutFocus,this)),this.$element.addClass("oo-ui-bookletLayout"),this.stackLayout.$element.addClass("oo-ui-bookletLayout-stackLayout"),this.outlined?(this.outlinePanel.$element.addClass("oo-ui-bookletLayout-outlinePanel").append(this.outlineWidget.$element),this.editable&&this.outlinePanel.$element.addClass("oo-ui-bookletLayout-outlinePanel-editable").append(this.outlineControlsWidget.$element),this.$element.append(this.gridLayout.$element)):this.$element.append(this.stackLayout.$element)},a.inheritClass(a.ui.BookletLayout,a.ui.Layout),a.ui.BookletLayout.prototype.onStackLayoutFocus=function(a){var b,c;c=$(a.target).closest(".oo-ui-pageLayout");for(b in this.pages)if(this.pages[b].$element[0]===c[0]&&b!==this.currentPageName){this.setPage(b);break}},a.ui.BookletLayout.prototype.onStackLayoutSet=function(a){var b,c=this;a&&a.scrollElementIntoView({complete:function(){c.autoFocus&&(a.$element.find(":focus").length||(b=a.$element.find(":input:first"),b.length&&b[0].focus()))}})},a.ui.BookletLayout.prototype.onOutlineWidgetSelect=function(a){a&&this.setPage(a.getData())},a.ui.BookletLayout.prototype.isOutlined=function(){return this.outlined},a.ui.BookletLayout.prototype.isEditable=function(){return this.editable},a.ui.BookletLayout.prototype.isOutlineVisible=function(){return this.outlined&&this.outlineVisible},a.ui.BookletLayout.prototype.toggleOutline=function(a){return this.outlined&&(a=void 0===a?!this.outlineVisible:!!a,this.outlineVisible=a,this.gridLayout.layout(a?[1,2]:[0,1],[1])),this},a.ui.BookletLayout.prototype.getClosestPage=function(a){var b,c,d,e=this.stackLayout.getItems(),f=$.inArray(a,e);if(-1!==f&&(b=e[f+1],c=e[f-1],this.outlined)){if(d=this.outlineWidget.getItemFromData(a.getName()).getLevel(),c&&d===this.outlineWidget.getItemFromData(c.getName()).getLevel())return c;if(b&&d===this.outlineWidget.getItemFromData(b.getName()).getLevel())return b}return c||b||null},a.ui.BookletLayout.prototype.getOutline=function(){return this.outlineWidget},a.ui.BookletLayout.prototype.getOutlineControls=function(){return this.outlineControlsWidget},a.ui.BookletLayout.prototype.getPage=function(a){return this.pages[a]},a.ui.BookletLayout.prototype.getPageName=function(){return this.currentPageName},a.ui.BookletLayout.prototype.addPages=function(b,c){var d,e,f,g,h,i,j=this.stackLayout.getItems(),k=[],l=[];for(d=0,e=b.length;e>d;d++)g=b[d],f=g.getName(),Object.prototype.hasOwnProperty.call(this.pages,f)&&(i=$.inArray(this.pages[f],j),-1!==i&&c>i+1&&c--,k.push(this.pages[f]));
for(k.length&&this.removePages(k),d=0,e=b.length;e>d;d++)g=b[d],f=g.getName(),this.pages[g.getName()]=g,this.outlined&&(h=new a.ui.OutlineItemWidget(f,g,{$:this.$}),g.setOutlineItem(h),l.push(h));return this.outlined&&l.length&&(this.outlineWidget.addItems(l,c),this.updateOutlineWidget()),this.stackLayout.addItems(b,c),this.emit("add",b,c),this},a.ui.BookletLayout.prototype.removePages=function(a){var b,c,d,e,f=[];for(b=0,c=a.length;c>b;b++)e=a[b],d=e.getName(),delete this.pages[d],this.outlined&&(f.push(this.outlineWidget.getItemFromData(d)),e.setOutlineItem(null));return this.outlined&&f.length&&(this.outlineWidget.removeItems(f),this.updateOutlineWidget()),this.stackLayout.removeItems(a),this.emit("remove",a),this},a.ui.BookletLayout.prototype.clearPages=function(){var a,b,c=this.stackLayout.getItems();if(this.pages={},this.currentPageName=null,this.outlined)for(this.outlineWidget.clearItems(),a=0,b=c.length;b>a;a++)c[a].setOutlineItem(null);return this.stackLayout.clearItems(),this.emit("remove",c),this},a.ui.BookletLayout.prototype.setPage=function(a){var b,c,d=this.pages[a];a!==this.currentPageName&&(this.outlined&&(b=this.outlineWidget.getSelectedItem(),b&&b.getData()!==a&&this.outlineWidget.selectItem(this.outlineWidget.getItemFromData(a))),d&&(this.currentPageName&&this.pages[this.currentPageName]&&(this.pages[this.currentPageName].setActive(!1),this.autoFocus&&!d.$element.find(":input").length&&(c=this.pages[this.currentPageName].$element.find(":focus"),c.length&&c[0].blur())),this.currentPageName=a,this.stackLayout.setItem(d),d.setActive(!0),this.emit("set",d)))},a.ui.BookletLayout.prototype.updateOutlineWidget=function(){return this.outlineWidget.getSelectedItem()||this.outlineWidget.selectItem(this.outlineWidget.getFirstSelectableItem()),this},a.ui.FieldLayout=function(b,c){var d;c=$.extend({align:"left"},c),a.ui.FieldLayout.super.call(this,c),this.$help=this.$("<div>"),a.ui.LabeledElement.call(this,this.$("<label>"),c),c.help&&(d=new a.ui.PopupButtonWidget($.extend({$:this.$,frameless:!0,icon:"info",title:c.help},c,{label:null})),d.getPopup().$body.append(this.getElementDocument().createTextNode(c.help)),this.$help=d.$element),this.$field=this.$("<div>"),this.field=b,this.align=null,this.field instanceof a.ui.InputWidget&&this.$label.on("click",a.ui.bind(this.onLabelClick,this)),this.field.connect(this,{disable:"onFieldDisable"}),this.$element.addClass("oo-ui-fieldLayout"),this.$field.addClass("oo-ui-fieldLayout-field").toggleClass("oo-ui-fieldLayout-disable",this.field.isDisabled()).append(this.field.$element),this.setAlignment(c.align)},a.inheritClass(a.ui.FieldLayout,a.ui.Layout),a.mixinClass(a.ui.FieldLayout,a.ui.LabeledElement),a.ui.FieldLayout.prototype.onFieldDisable=function(a){this.$element.toggleClass("oo-ui-fieldLayout-disabled",a)},a.ui.FieldLayout.prototype.onLabelClick=function(){return this.field.simulateLabelClick(),!1},a.ui.FieldLayout.prototype.getField=function(){return this.field},a.ui.FieldLayout.prototype.setAlignment=function(a){return a!==this.align&&(-1===["left","right","top","inline"].indexOf(a)&&(a="left"),"inline"===a?this.$element.append(this.$field,this.$label,this.$help):this.$element.append(this.$help,this.$label,this.$field),this.align&&this.$element.removeClass("oo-ui-fieldLayout-align-"+this.align),this.align=a,this.$element.addClass("oo-ui-fieldLayout-align-"+this.align)),this},a.ui.FieldsetLayout=function(b){b=b||{},a.ui.FieldsetLayout.super.call(this,b),a.ui.IconedElement.call(this,this.$("<div>"),b),a.ui.LabeledElement.call(this,this.$("<div>"),b),a.ui.GroupElement.call(this,this.$("<div>"),b),this.$element.addClass("oo-ui-fieldsetLayout").prepend(this.$icon,this.$label,this.$group),$.isArray(b.items)&&this.addItems(b.items)},a.inheritClass(a.ui.FieldsetLayout,a.ui.Layout),a.mixinClass(a.ui.FieldsetLayout,a.ui.IconedElement),a.mixinClass(a.ui.FieldsetLayout,a.ui.LabeledElement),a.mixinClass(a.ui.FieldsetLayout,a.ui.GroupElement),a.ui.FieldsetLayout.static.tagName="div",a.ui.FormLayout=function(b){b=b||{},a.ui.FormLayout.super.call(this,b),this.$element.on("submit",a.ui.bind(this.onFormSubmit,this)),this.$element.addClass("oo-ui-formLayout")},a.inheritClass(a.ui.FormLayout,a.ui.Layout),a.ui.FormLayout.static.tagName="form",a.ui.FormLayout.prototype.onFormSubmit=function(){return this.emit("submit"),!1},a.ui.GridLayout=function(b,c){var d,e,f;for(c=c||{},a.ui.GridLayout.super.call(this,c),this.panels=[],this.widths=[],this.heights=[],this.$element.addClass("oo-ui-gridLayout"),d=0,e=b.length;e>d;d++)this.panels.push(b[d]),this.$element.append(b[d].$element);if(c.widths||c.heights)this.layout(c.widths||[1],c.heights||[1]);else{for(f=[],d=0,e=this.panels.length;e>d;d++)f[d]=1;this.layout(f,[1])}},a.inheritClass(a.ui.GridLayout,a.ui.Layout),a.ui.GridLayout.static.tagName="div",a.ui.GridLayout.prototype.layout=function(a,b){var c,d,e=0,f=0,g=a.length,h=b.length;if(g*h<this.panels.length)throw new Error("Grid is not large enough to fit "+this.panels.length+"panels");for(c=0;g>c;c++)e+=a[c];for(d=0;h>d;d++)f+=b[d];for(this.widths=[],this.heights=[],c=0;g>c;c++)this.widths[c]=a[c]/e;for(d=0;h>d;d++)this.heights[d]=b[d]/f;this.update(),this.emit("layout")},a.ui.GridLayout.prototype.update=function(){var b,c,d,e,f=0,g=0,h=0,i=0,j=0,k=this.widths.length,l=this.heights.length;for(c=0;l>c;c++){for(j=this.heights[c],b=0;k>b;b++)d=this.panels[f],i=this.widths[b],e={width:Math.round(100*i)+"%",height:Math.round(100*j)+"%",top:Math.round(100*h)+"%",visibility:0===i||0===j?"hidden":""},"rtl"===a.ui.Element.getDir(this.$.context)?e.right=Math.round(100*g)+"%":e.left=Math.round(100*g)+"%",d.$element.css(e),f++,g+=i;h+=j,g=0}this.emit("update")},a.ui.GridLayout.prototype.getPanel=function(a,b){return this.panels[a*this.widths.length+b]},a.ui.PanelLayout=function(b){b=b||{},a.ui.PanelLayout.super.call(this,b),this.$element.addClass("oo-ui-panelLayout"),b.scrollable&&this.$element.addClass("oo-ui-panelLayout-scrollable"),b.padded&&this.$element.addClass("oo-ui-panelLayout-padded"),(void 0===b.expanded||b.expanded)&&this.$element.addClass("oo-ui-panelLayout-expanded")},a.inheritClass(a.ui.PanelLayout,a.ui.Layout),a.ui.PageLayout=function(b,c){c=$.extend({scrollable:!0},c),a.ui.PageLayout.super.call(this,c),this.name=b,this.outlineItem=c.outlineItem||null,this.active=!1,this.$element.addClass("oo-ui-pageLayout")},a.inheritClass(a.ui.PageLayout,a.ui.PanelLayout),a.ui.PageLayout.prototype.getName=function(){return this.name},a.ui.PageLayout.prototype.isActive=function(){return this.active},a.ui.PageLayout.prototype.getOutlineItem=function(){return this.outlineItem},a.ui.PageLayout.prototype.setOutlineItem=function(a){return this.outlineItem=a||null,a&&this.setupOutlineItem(),this},a.ui.PageLayout.prototype.setupOutlineItem=function(){return this},a.ui.PageLayout.prototype.setActive=function(a){a=!!a,a!==this.active&&(this.active=a,this.$element.toggleClass("oo-ui-pageLayout-active",a),this.emit("active",this.active))},a.ui.StackLayout=function(b){b=$.extend({scrollable:!0},b),a.ui.StackLayout.super.call(this,b),a.ui.GroupElement.call(this,this.$element,b),this.currentItem=null,this.continuous=!!b.continuous,this.$element.addClass("oo-ui-stackLayout"),this.continuous&&this.$element.addClass("oo-ui-stackLayout-continuous"),$.isArray(b.items)&&this.addItems(b.items)},a.inheritClass(a.ui.StackLayout,a.ui.PanelLayout),a.mixinClass(a.ui.StackLayout,a.ui.GroupElement),a.ui.StackLayout.prototype.getCurrentItem=function(){return this.currentItem},a.ui.StackLayout.prototype.unsetCurrentItem=function(){var a=this.currentItem;null!==a&&(this.currentItem=null,this.emit("set",null))},a.ui.StackLayout.prototype.addItems=function(b,c){return a.ui.GroupElement.prototype.addItems.call(this,b,c),!this.currentItem&&b.length&&this.setItem(b[0]),this},a.ui.StackLayout.prototype.removeItems=function(b){return a.ui.GroupElement.prototype.removeItems.call(this,b),-1!==$.inArray(this.currentItem,b)&&(this.items.length?this.setItem(this.items[0]):this.unsetCurrentItem()),this},a.ui.StackLayout.prototype.clearItems=function(){return this.unsetCurrentItem(),a.ui.GroupElement.prototype.clearItems.call(this),this},a.ui.StackLayout.prototype.setItem=function(a){var b,c;if(a!==this.currentItem){if(!this.continuous)for(b=0,c=this.items.length;c>b;b++)this.items[b].$element.css("display","");-1!==$.inArray(a,this.items)?(this.continuous||a.$element.css("display","block"),this.currentItem=a,this.emit("set",a)):this.unsetCurrentItem()}return this},a.ui.BarToolGroup=function(b,c){a.ui.BarToolGroup.super.call(this,b,c),this.$element.addClass("oo-ui-barToolGroup")},a.inheritClass(a.ui.BarToolGroup,a.ui.ToolGroup),a.ui.BarToolGroup.static.titleTooltips=!0,a.ui.BarToolGroup.static.accelTooltips=!0,a.ui.BarToolGroup.static.name="bar",a.ui.PopupToolGroup=function(b,c){c=c||{},a.ui.PopupToolGroup.super.call(this,b,c),a.ui.IconedElement.call(this,this.$("<span>"),c),a.ui.IndicatedElement.call(this,this.$("<span>"),c),a.ui.LabeledElement.call(this,this.$("<span>"),c),a.ui.TitledElement.call(this,this.$element,c),a.ui.ClippableElement.call(this,this.$group,c),this.active=!1,this.dragging=!1,this.onBlurHandler=a.ui.bind(this.onBlur,this),this.$handle=this.$("<span>"),this.$handle.on({"mousedown touchstart":a.ui.bind(this.onHandlePointerDown,this),"mouseup touchend":a.ui.bind(this.onHandlePointerUp,this)}),this.$handle.addClass("oo-ui-popupToolGroup-handle").append(this.$icon,this.$label,this.$indicator),void 0!==c.header&&this.$group.prepend(this.$("<span>").addClass("oo-ui-popupToolGroup-header").text(c.header)),this.$element.addClass("oo-ui-popupToolGroup").prepend(this.$handle)},a.inheritClass(a.ui.PopupToolGroup,a.ui.ToolGroup),a.mixinClass(a.ui.PopupToolGroup,a.ui.IconedElement),a.mixinClass(a.ui.PopupToolGroup,a.ui.IndicatedElement),a.mixinClass(a.ui.PopupToolGroup,a.ui.LabeledElement),a.mixinClass(a.ui.PopupToolGroup,a.ui.TitledElement),a.mixinClass(a.ui.PopupToolGroup,a.ui.ClippableElement),a.ui.PopupToolGroup.prototype.setDisabled=function(){a.ui.PopupToolGroup.super.prototype.setDisabled.apply(this,arguments),this.isDisabled()&&this.isElementAttached()&&this.setActive(!1)},a.ui.PopupToolGroup.prototype.onBlur=function(a){this.$(a.target).closest(".oo-ui-popupToolGroup")[0]!==this.$element[0]&&this.setActive(!1)},a.ui.PopupToolGroup.prototype.onPointerUp=function(b){return!this.isDisabled()&&b.which<=1&&this.setActive(!1),a.ui.PopupToolGroup.super.prototype.onPointerUp.call(this,b)},a.ui.PopupToolGroup.prototype.onHandlePointerUp=function(){return!1},a.ui.PopupToolGroup.prototype.onHandlePointerDown=function(a){return!this.isDisabled()&&a.which<=1&&this.setActive(!this.active),!1},a.ui.PopupToolGroup.prototype.setActive=function(a){a=!!a,this.active!==a&&(this.active=a,a?(this.setClipping(!0),this.$element.addClass("oo-ui-popupToolGroup-active"),this.getElementDocument().addEventListener("mouseup",this.onBlurHandler,!0)):(this.setClipping(!1),this.$element.removeClass("oo-ui-popupToolGroup-active"),this.getElementDocument().removeEventListener("mouseup",this.onBlurHandler,!0)))},a.ui.ListToolGroup=function(b,c){a.ui.ListToolGroup.super.call(this,b,c),this.$element.addClass("oo-ui-listToolGroup")},a.inheritClass(a.ui.ListToolGroup,a.ui.PopupToolGroup),a.ui.ListToolGroup.static.accelTooltips=!0,a.ui.ListToolGroup.static.name="list",a.ui.MenuToolGroup=function(b,c){c=c||{},a.ui.MenuToolGroup.super.call(this,b,c),this.toolbar.connect(this,{updateState:"onUpdateState"}),this.$element.addClass("oo-ui-menuToolGroup")},a.inheritClass(a.ui.MenuToolGroup,a.ui.PopupToolGroup),a.ui.MenuToolGroup.static.accelTooltips=!0,a.ui.MenuToolGroup.static.name="menu",a.ui.MenuToolGroup.prototype.onUpdateState=function(){var a,b=[];for(a in this.tools)this.tools[a].isActive()&&b.push(this.tools[a].getTitle());this.setLabel(b.join(", ")||" ")},a.ui.PopupTool=function(b,c){a.ui.PopupTool.super.call(this,b,c),a.ui.PopuppableElement.call(this,c),this.$element.addClass("oo-ui-popupTool").append(this.popup.$element)},a.inheritClass(a.ui.PopupTool,a.ui.Tool),a.mixinClass(a.ui.PopupTool,a.ui.PopuppableElement),a.ui.PopupTool.prototype.onSelect=function(){return this.isDisabled()||this.popup.toggle(),this.setActive(!1),!1},a.ui.PopupTool.prototype.onUpdateState=function(){this.setActive(!1)},a.ui.GroupWidget=function(b,c){a.ui.GroupWidget.super.call(this,b,c)},a.inheritClass(a.ui.GroupWidget,a.ui.GroupElement),a.ui.GroupWidget.prototype.setDisabled=function(b){var c,d;if(a.ui.Widget.prototype.setDisabled.call(this,b),this.items)for(c=0,d=this.items.length;d>c;c++)this.items[c].updateDisabled();return this},a.ui.ItemWidget=function(){},a.ui.ItemWidget.prototype.isDisabled=function(){return this.disabled||this.elementGroup instanceof a.ui.Widget&&this.elementGroup.isDisabled()},a.ui.ItemWidget.prototype.setElementGroup=function(b){return a.ui.Element.prototype.setElementGroup.call(this,b),this.updateDisabled(),this},a.ui.LookupInputWidget=function(b,c){c=c||{},this.lookupInput=b,this.$overlay=c.$overlay||this.$("body,.oo-ui-window-overlay").last(),this.lookupMenu=new a.ui.TextInputMenuWidget(this,{$:a.ui.Element.getJQuery(this.$overlay),input:this.lookupInput,$container:c.$container}),this.lookupCache={},this.lookupQuery=null,this.lookupRequest=null,this.populating=!1,this.$overlay.append(this.lookupMenu.$element),this.lookupInput.$input.on({focus:a.ui.bind(this.onLookupInputFocus,this),blur:a.ui.bind(this.onLookupInputBlur,this),mousedown:a.ui.bind(this.onLookupInputMouseDown,this)}),this.lookupInput.connect(this,{change:"onLookupInputChange"}),this.$element.addClass("oo-ui-lookupWidget"),this.lookupMenu.$element.addClass("oo-ui-lookupWidget-menu")},a.ui.LookupInputWidget.prototype.onLookupInputFocus=function(){this.openLookupMenu()},a.ui.LookupInputWidget.prototype.onLookupInputBlur=function(){this.lookupMenu.toggle(!1)},a.ui.LookupInputWidget.prototype.onLookupInputMouseDown=function(){this.openLookupMenu()},a.ui.LookupInputWidget.prototype.onLookupInputChange=function(){this.openLookupMenu()},a.ui.LookupInputWidget.prototype.getLookupMenu=function(){return this.lookupMenu},a.ui.LookupInputWidget.prototype.openLookupMenu=function(){var a=this.lookupInput.getValue();return this.lookupMenu.$input.is(":focus")&&""!==$.trim(a)?(this.populateLookupMenu(),this.lookupMenu.toggle(!0)):this.lookupMenu.clearItems().toggle(!1),this},a.ui.LookupInputWidget.prototype.populateLookupMenu=function(){var a=this;return this.populating||(this.populating=!0,this.getLookupMenuItems().done(function(b){a.lookupMenu.clearItems(),b.length?(a.lookupMenu.addItems(b).toggle(!0),a.initializeLookupMenuSelection(),a.openLookupMenu()):a.lookupMenu.toggle(!0),a.populating=!1}).fail(function(){a.lookupMenu.clearItems(),a.populating=!1})),this},a.ui.LookupInputWidget.prototype.initializeLookupMenuSelection=function(){this.lookupMenu.getSelectedItem()||this.lookupMenu.selectItem(this.lookupMenu.getFirstSelectableItem()),this.lookupMenu.highlightItem(this.lookupMenu.getSelectedItem())},a.ui.LookupInputWidget.prototype.getLookupMenuItems=function(){var a=this,b=this.lookupInput.getValue(),c=$.Deferred();return b&&b!==this.lookupQuery&&(this.lookupRequest&&(this.lookupRequest.abort(),this.lookupQuery=null,this.lookupRequest=null),b in this.lookupCache?c.resolve(this.getLookupMenuItemsFromData(this.lookupCache[b])):(this.lookupQuery=b,this.lookupRequest=this.getLookupRequest().always(function(){a.lookupQuery=null,a.lookupRequest=null}).done(function(d){a.lookupCache[b]=a.getLookupCacheItemFromData(d),c.resolve(a.getLookupMenuItemsFromData(a.lookupCache[b]))}).fail(function(){c.reject()}),this.pushPending(),this.lookupRequest.always(function(){a.popPending()}))),c.promise()},a.ui.LookupInputWidget.prototype.getLookupRequest=function(){return null},a.ui.LookupInputWidget.prototype.onLookupRequestDone=function(){},a.ui.LookupInputWidget.prototype.getLookupMenuItemsFromData=function(){return[]},a.ui.OutlineControlsWidget=function(b,c){c=$.extend({icon:"add-item"},c),a.ui.OutlineControlsWidget.super.call(this,c),a.ui.GroupElement.call(this,this.$("<div>"),c),a.ui.IconedElement.call(this,this.$("<div>"),c),this.outline=b,this.$movers=this.$("<div>"),this.upButton=new a.ui.ButtonWidget({$:this.$,framed:!1,icon:"collapse",title:a.ui.msg("ooui-outline-control-move-up")}),this.downButton=new a.ui.ButtonWidget({$:this.$,framed:!1,icon:"expand",title:a.ui.msg("ooui-outline-control-move-down")}),this.removeButton=new a.ui.ButtonWidget({$:this.$,framed:!1,icon:"remove",title:a.ui.msg("ooui-outline-control-remove")}),b.connect(this,{select:"onOutlineChange",add:"onOutlineChange",remove:"onOutlineChange"}),this.upButton.connect(this,{click:["emit","move",-1]}),this.downButton.connect(this,{click:["emit","move",1]}),this.removeButton.connect(this,{click:["emit","remove"]}),this.$element.addClass("oo-ui-outlineControlsWidget"),this.$group.addClass("oo-ui-outlineControlsWidget-items"),this.$movers.addClass("oo-ui-outlineControlsWidget-movers").append(this.removeButton.$element,this.upButton.$element,this.downButton.$element),this.$element.append(this.$icon,this.$group,this.$movers)},a.inheritClass(a.ui.OutlineControlsWidget,a.ui.Widget),a.mixinClass(a.ui.OutlineControlsWidget,a.ui.GroupElement),a.mixinClass(a.ui.OutlineControlsWidget,a.ui.IconedElement),a.ui.OutlineControlsWidget.prototype.onOutlineChange=function(){var a,b,c,d,e=this.outline.getItems(),f=this.outline.getSelectedItem(),g=f&&f.isMovable(),h=f&&f.isRemovable();if(g){for(a=-1,b=e.length;++a<b;)if(e[a].isMovable()){c=e[a];break}for(a=b;a--;)if(e[a].isMovable()){d=e[a];break}}this.upButton.setDisabled(!g||f===c),this.downButton.setDisabled(!g||f===d),this.removeButton.setDisabled(!h)},a.ui.ToggleWidget=function(a){a=a||{},this.value=null,this.$element.addClass("oo-ui-toggleWidget"),this.setValue(!!a.value)},a.ui.ToggleWidget.prototype.getValue=function(){return this.value},a.ui.ToggleWidget.prototype.setValue=function(a){return a=!!a,this.value!==a&&(this.value=a,this.emit("change",a),this.$element.toggleClass("oo-ui-toggleWidget-on",a),this.$element.toggleClass("oo-ui-toggleWidget-off",!a)),this},a.ui.ButtonGroupWidget=function(b){a.ui.ButtonGroupWidget.super.call(this,b),a.ui.GroupElement.call(this,this.$element,b),this.$element.addClass("oo-ui-buttonGroupWidget"),$.isArray(b.items)&&this.addItems(b.items)},a.inheritClass(a.ui.ButtonGroupWidget,a.ui.Widget),a.mixinClass(a.ui.ButtonGroupWidget,a.ui.GroupElement),a.ui.ButtonWidget=function(b){b=$.extend({target:"_blank"},b),a.ui.ButtonWidget.super.call(this,b),a.ui.ButtonedElement.call(this,this.$("<a>"),b),a.ui.IconedElement.call(this,this.$("<span>"),b),a.ui.IndicatedElement.call(this,this.$("<span>"),b),a.ui.LabeledElement.call(this,this.$("<span>"),b),a.ui.TitledElement.call(this,this.$button,b),a.ui.FlaggableElement.call(this,b),this.href=null,this.target=null,this.isHyperlink=!1,this.$button.on({click:a.ui.bind(this.onClick,this),keypress:a.ui.bind(this.onKeyPress,this)}),this.$button.append(this.$icon,this.$label,this.$indicator),this.$element.addClass("oo-ui-buttonWidget").append(this.$button),this.setHref(b.href),this.setTarget(b.target)},a.inheritClass(a.ui.ButtonWidget,a.ui.Widget),a.mixinClass(a.ui.ButtonWidget,a.ui.ButtonedElement),a.mixinClass(a.ui.ButtonWidget,a.ui.IconedElement),a.mixinClass(a.ui.ButtonWidget,a.ui.IndicatedElement),a.mixinClass(a.ui.ButtonWidget,a.ui.LabeledElement),a.mixinClass(a.ui.ButtonWidget,a.ui.TitledElement),a.mixinClass(a.ui.ButtonWidget,a.ui.FlaggableElement),a.ui.ButtonWidget.prototype.onClick=function(){return!this.isDisabled()&&(this.emit("click"),this.isHyperlink)?!0:!1},a.ui.ButtonWidget.prototype.onKeyPress=function(b){return this.isDisabled()||b.which!==a.ui.Keys.SPACE&&b.which!==a.ui.Keys.ENTER||(this.onClick(),!this.isHyperlink)?!1:!0},a.ui.ButtonWidget.prototype.getHref=function(){return this.href},a.ui.ButtonWidget.prototype.getTarget=function(){return this.target},a.ui.ButtonWidget.prototype.setHref=function(a){return a="string"==typeof a?a:null,a!==this.href&&(this.href=a,null!==a?(this.$button.attr("href",a),this.isHyperlink=!0):(this.$button.removeAttr("href"),this.isHyperlink=!1)),this},a.ui.ButtonWidget.prototype.setTarget=function(a){return a="string"==typeof a?a:null,a!==this.target&&(this.target=a,null!==a?this.$button.attr("target",a):this.$button.removeAttr("target")),this},a.ui.ActionWidget=function(b){b=$.extend({framed:!1},b),a.ui.ActionWidget.super.call(this,b),this.action=b.action||"",this.modes=b.modes||[],this.width=0,this.height=0,this.$element.addClass("oo-ui-actionWidget")},a.inheritClass(a.ui.ActionWidget,a.ui.ButtonWidget),a.ui.ActionWidget.prototype.hasMode=function(a){return-1!==this.modes.indexOf(a)},a.ui.ActionWidget.prototype.getAction=function(){return this.action},a.ui.ActionWidget.prototype.getModes=function(){return this.modes.slice()},a.ui.ActionWidget.prototype.propagateResize=function(){var a,b;return this.isElementAttached()&&(a=this.$element.width(),b=this.$element.height(),(a!==this.width||b!==this.height)&&(this.width=a,this.height=b,this.emit("resize"))),this},a.ui.ActionWidget.prototype.setIcon=function(){return a.ui.IconedElement.prototype.setIcon.apply(this,arguments),this.propagateResize(),this},a.ui.ActionWidget.prototype.setLabel=function(){return a.ui.LabeledElement.prototype.setLabel.apply(this,arguments),this.propagateResize(),this},a.ui.ActionWidget.prototype.setFlags=function(){return a.ui.FlaggableElement.prototype.setFlags.apply(this,arguments),this.propagateResize(),this},a.ui.ActionWidget.prototype.clearFlags=function(){return a.ui.FlaggableElement.prototype.clearFlags.apply(this,arguments),this.propagateResize(),this},a.ui.ActionWidget.prototype.toggle=function(){return a.ui.ActionWidget.super.prototype.toggle.apply(this,arguments),this.propagateResize(),this},a.ui.PopupButtonWidget=function(b){a.ui.PopupButtonWidget.super.call(this,b),a.ui.PopuppableElement.call(this,b),this.$element.addClass("oo-ui-popupButtonWidget").append(this.popup.$element)},a.inheritClass(a.ui.PopupButtonWidget,a.ui.ButtonWidget),a.mixinClass(a.ui.PopupButtonWidget,a.ui.PopuppableElement),a.ui.PopupButtonWidget.prototype.onClick=function(b){return $.contains(this.popup.$element[0],b.target)?void 0:(this.isDisabled()||(this.popup.toggle(),a.ui.PopupButtonWidget.super.prototype.onClick.call(this)),!1)},a.ui.ToggleButtonWidget=function(b){b=b||{},a.ui.ToggleButtonWidget.super.call(this,b),a.ui.ToggleWidget.call(this,b),this.$element.addClass("oo-ui-toggleButtonWidget")},a.inheritClass(a.ui.ToggleButtonWidget,a.ui.ButtonWidget),a.mixinClass(a.ui.ToggleButtonWidget,a.ui.ToggleWidget),a.ui.ToggleButtonWidget.prototype.onClick=function(){return this.isDisabled()||this.setValue(!this.value),a.ui.ToggleButtonWidget.super.prototype.onClick.call(this)},a.ui.ToggleButtonWidget.prototype.setValue=function(b){return b=!!b,b!==this.value&&this.setActive(b),a.ui.ToggleWidget.prototype.setValue.call(this,b),this},a.ui.IconWidget=function(b){b=b||{},a.ui.IconWidget.super.call(this,b),a.ui.IconedElement.call(this,this.$element,b),a.ui.TitledElement.call(this,this.$element,b),this.$element.addClass("oo-ui-iconWidget")},a.inheritClass(a.ui.IconWidget,a.ui.Widget),a.mixinClass(a.ui.IconWidget,a.ui.IconedElement),a.mixinClass(a.ui.IconWidget,a.ui.TitledElement),a.ui.IconWidget.static.tagName="span",a.ui.IndicatorWidget=function(b){b=b||{},a.ui.IndicatorWidget.super.call(this,b),a.ui.IndicatedElement.call(this,this.$element,b),a.ui.TitledElement.call(this,this.$element,b),this.$element.addClass("oo-ui-indicatorWidget")},a.inheritClass(a.ui.IndicatorWidget,a.ui.Widget),a.mixinClass(a.ui.IndicatorWidget,a.ui.IndicatedElement),a.mixinClass(a.ui.IndicatorWidget,a.ui.TitledElement),a.ui.IndicatorWidget.static.tagName="span",a.ui.InlineMenuWidget=function(b){b=$.extend({indicator:"down"},b),a.ui.InlineMenuWidget.super.call(this,b),a.ui.IconedElement.call(this,this.$("<span>"),b),a.ui.IndicatedElement.call(this,this.$("<span>"),b),a.ui.LabeledElement.call(this,this.$("<span>"),b),a.ui.TitledElement.call(this,this.$label,b),this.menu=new a.ui.MenuWidget($.extend({$:this.$,widget:this},b.menu)),this.$handle=this.$("<span>"),this.$element.on({click:a.ui.bind(this.onClick,this)}),this.menu.connect(this,{select:"onMenuSelect"}),this.$handle.addClass("oo-ui-inlineMenuWidget-handle").append(this.$icon,this.$label,this.$indicator),this.$element.addClass("oo-ui-inlineMenuWidget").append(this.$handle,this.menu.$element)},a.inheritClass(a.ui.InlineMenuWidget,a.ui.Widget),a.mixinClass(a.ui.InlineMenuWidget,a.ui.IconedElement),a.mixinClass(a.ui.InlineMenuWidget,a.ui.IndicatedElement),a.mixinClass(a.ui.InlineMenuWidget,a.ui.LabeledElement),a.mixinClass(a.ui.InlineMenuWidget,a.ui.TitledElement),a.ui.InlineMenuWidget.prototype.getMenu=function(){return this.menu},a.ui.InlineMenuWidget.prototype.onMenuSelect=function(a){var b;a&&(b=a.getLabel(),b instanceof jQuery&&(b=b.clone()),this.setLabel(b))},a.ui.InlineMenuWidget.prototype.onClick=function(a){return $.contains(this.menu.$element[0],a.target)?void 0:(this.isDisabled()||this.menu.toggle(this.menu.isVisible()?!1:!0),!1)},a.ui.InputWidget=function(b){b=$.extend({readOnly:!1},b),a.ui.InputWidget.super.call(this,b),this.$input=this.getInputElement(b),this.value="",this.readOnly=!1,this.inputFilter=b.inputFilter,this.$input.on("keydown mouseup cut paste change input select",a.ui.bind(this.onEdit,this)),this.$input.attr("name",b.name).prop("disabled",this.isDisabled()),this.setReadOnly(b.readOnly),this.$element.addClass("oo-ui-inputWidget").append(this.$input),this.setValue(b.value)},a.inheritClass(a.ui.InputWidget,a.ui.Widget),a.ui.InputWidget.prototype.getInputElement=function(){return this.$("<input>")},a.ui.InputWidget.prototype.onEdit=function(){var a=this;this.isDisabled()||setTimeout(function(){a.setValue(a.$input.val())})},a.ui.InputWidget.prototype.getValue=function(){return this.value},a.ui.InputWidget.prototype.setRTL=function(a){a?(this.$input.removeClass("oo-ui-ltr"),this.$input.addClass("oo-ui-rtl")):(this.$input.removeClass("oo-ui-rtl"),this.$input.addClass("oo-ui-ltr"))},a.ui.InputWidget.prototype.setValue=function(a){return a=this.sanitizeValue(a),this.value!==a&&(this.value=a,this.emit("change",this.value)),this.$input.val()!==this.value&&this.$input.val(this.value),this},a.ui.InputWidget.prototype.sanitizeValue=function(a){return void 0===a||null===a?"":this.inputFilter?this.inputFilter(String(a)):String(a)},a.ui.InputWidget.prototype.simulateLabelClick=function(){this.isDisabled()||(this.$input.is(":checkbox,:radio")?this.$input.click():this.$input.is(":input")&&this.$input[0].focus())},a.ui.InputWidget.prototype.isReadOnly=function(){return this.readOnly},a.ui.InputWidget.prototype.setReadOnly=function(a){return this.readOnly=!!a,this.$input.prop("readOnly",this.readOnly),this},a.ui.InputWidget.prototype.setDisabled=function(b){return a.ui.InputWidget.super.prototype.setDisabled.call(this,b),this.$input&&this.$input.prop("disabled",this.isDisabled()),this},a.ui.InputWidget.prototype.focus=function(){return this.$input[0].focus(),this},a.ui.InputWidget.prototype.blur=function(){return this.$input[0].blur(),this},a.ui.CheckboxInputWidget=function(b){a.ui.CheckboxInputWidget.super.call(this,b),this.$element.addClass("oo-ui-checkboxInputWidget")},a.inheritClass(a.ui.CheckboxInputWidget,a.ui.InputWidget),a.ui.CheckboxInputWidget.prototype.getInputElement=function(){return this.$('<input type="checkbox" />')},a.ui.CheckboxInputWidget.prototype.getValue=function(){return this.value},a.ui.CheckboxInputWidget.prototype.setValue=function(a){a=!!a,this.value!==a&&(this.value=a,this.$input.prop("checked",this.value),this.emit("change",this.value))},a.ui.CheckboxInputWidget.prototype.onEdit=function(){var a=this;this.isDisabled()||setTimeout(function(){a.setValue(a.$input.prop("checked"))})},a.ui.TextInputWidget=function(b){var c=this;b=$.extend({maxRows:10},b),a.ui.TextInputWidget.super.call(this,b),this.pending=0,this.multiline=!!b.multiline,this.autosize=!!b.autosize,this.maxRows=b.maxRows,this.$input.on("keypress",a.ui.bind(this.onKeyPress,this)),this.$element.on("DOMNodeInsertedIntoDocument",a.ui.bind(this.onElementAttach,this)),this.$element.addClass("oo-ui-textInputWidget"),b.icon&&(this.$element.addClass("oo-ui-textInputWidget-decorated"),this.$element.append(this.$("<span>").addClass("oo-ui-textInputWidget-icon oo-ui-icon-"+b.icon).mousedown(function(){return c.$input[0].focus(),!1}))),b.placeholder&&this.$input.attr("placeholder",b.placeholder),this.$element.attr("role","textbox")},a.inheritClass(a.ui.TextInputWidget,a.ui.InputWidget),a.ui.TextInputWidget.prototype.onKeyPress=function(b){b.which!==a.ui.Keys.ENTER||this.multiline||this.emit("enter")},a.ui.TextInputWidget.prototype.onElementAttach=function(){this.adjustSize()},a.ui.TextInputWidget.prototype.onEdit=function(){return this.adjustSize(),a.ui.TextInputWidget.super.prototype.onEdit.call(this)},a.ui.TextInputWidget.prototype.setValue=function(b){return a.ui.TextInputWidget.super.prototype.setValue.call(this,b),this.adjustSize(),this},a.ui.TextInputWidget.prototype.adjustSize=function(){var a,b,c,d,e,f;return this.multiline&&this.autosize&&(a=this.$input.clone().val(this.$input.val()).css({height:0}).insertAfter(this.$input),b=a[0].scrollHeight,a.css("height",""),c=a.innerHeight(),d=a.outerHeight(),a.attr("rows",this.maxRows).css("height","auto"),e=a.innerHeight(),a.removeAttr("rows").css("height",""),a.remove(),f=Math.min(e,b),this.$input.css("height",f>d?f+(d-c):"")),this},a.ui.TextInputWidget.prototype.getInputElement=function(a){return this.$(a.multiline?"<textarea>":'<input type="text" />')},a.ui.TextInputWidget.prototype.isMultiline=function(){return!!this.multiline},a.ui.TextInputWidget.prototype.isAutosizing=function(){return!!this.autosize},a.ui.TextInputWidget.prototype.isPending=function(){return!!this.pending},a.ui.TextInputWidget.prototype.pushPending=function(){return 0===this.pending&&(this.$element.addClass("oo-ui-textInputWidget-pending"),this.$input.addClass("oo-ui-texture-pending")),this.pending++,this},a.ui.TextInputWidget.prototype.popPending=function(){return 1===this.pending&&(this.$element.removeClass("oo-ui-textInputWidget-pending"),this.$input.removeClass("oo-ui-texture-pending")),this.pending=Math.max(0,this.pending-1),this},a.ui.TextInputWidget.prototype.select=function(){return this.$input.select(),this},a.ui.LabelWidget=function(b){b=b||{},a.ui.LabelWidget.super.call(this,b),a.ui.LabeledElement.call(this,this.$element,b),this.input=b.input,this.input instanceof a.ui.InputWidget&&this.$element.on("click",a.ui.bind(this.onClick,this)),this.$element.addClass("oo-ui-labelWidget")},a.inheritClass(a.ui.LabelWidget,a.ui.Widget),a.mixinClass(a.ui.LabelWidget,a.ui.LabeledElement),a.ui.LabelWidget.static.tagName="label",a.ui.LabelWidget.prototype.onClick=function(){return this.input.simulateLabelClick(),!1},a.ui.OptionWidget=function(b,c){c=c||{},a.ui.OptionWidget.super.call(this,c),a.ui.ItemWidget.call(this),a.ui.LabeledElement.call(this,this.$("<span>"),c),a.ui.FlaggableElement.call(this,c),this.data=b,this.selected=!1,this.highlighted=!1,this.pressed=!1,this.$element.data("oo-ui-optionWidget",this).attr("rel",c.rel).attr("role","option").addClass("oo-ui-optionWidget").append(this.$label),this.$element.prepend(this.$icon).append(this.$indicator)},a.inheritClass(a.ui.OptionWidget,a.ui.Widget),a.mixinClass(a.ui.OptionWidget,a.ui.ItemWidget),a.mixinClass(a.ui.OptionWidget,a.ui.LabeledElement),a.mixinClass(a.ui.OptionWidget,a.ui.FlaggableElement),a.ui.OptionWidget.static.tagName="li",a.ui.OptionWidget.static.selectable=!0,a.ui.OptionWidget.static.highlightable=!0,a.ui.OptionWidget.static.pressable=!0,a.ui.OptionWidget.static.scrollIntoViewOnSelect=!1,a.ui.OptionWidget.prototype.isSelectable=function(){return this.constructor.static.selectable&&!this.isDisabled()},a.ui.OptionWidget.prototype.isHighlightable=function(){return this.constructor.static.highlightable&&!this.isDisabled()},a.ui.OptionWidget.prototype.isPressable=function(){return this.constructor.static.pressable&&!this.isDisabled()
},a.ui.OptionWidget.prototype.isSelected=function(){return this.selected},a.ui.OptionWidget.prototype.isHighlighted=function(){return this.highlighted},a.ui.OptionWidget.prototype.isPressed=function(){return this.pressed},a.ui.OptionWidget.prototype.setSelected=function(a){return this.constructor.static.selectable&&(this.selected=!!a,this.$element.toggleClass("oo-ui-optionWidget-selected",a),a&&this.constructor.static.scrollIntoViewOnSelect&&this.scrollElementIntoView()),this},a.ui.OptionWidget.prototype.setHighlighted=function(a){return this.constructor.static.highlightable&&(this.highlighted=!!a,this.$element.toggleClass("oo-ui-optionWidget-highlighted",a)),this},a.ui.OptionWidget.prototype.setPressed=function(a){return this.constructor.static.pressable&&(this.pressed=!!a,this.$element.toggleClass("oo-ui-optionWidget-pressed",a)),this},a.ui.OptionWidget.prototype.flash=function(){var a=this,b=this.$element,c=$.Deferred();return!this.isDisabled()&&this.constructor.static.pressable&&(b.removeClass("oo-ui-optionWidget-highlighted oo-ui-optionWidget-pressed"),setTimeout(function(){b.toggleClass("oo-ui-optionWidget-highlighted",a.highlighted).toggleClass("oo-ui-optionWidget-pressed",a.pressed),setTimeout(function(){c.resolve()},100)},100)),c.promise()},a.ui.OptionWidget.prototype.getData=function(){return this.data},a.ui.DecoratedOptionWidget=function(b,c){a.ui.DecoratedOptionWidget.super.call(this,b,c),a.ui.IconedElement.call(this,this.$("<span>"),c),a.ui.IndicatedElement.call(this,this.$("<span>"),c),this.$element.addClass("oo-ui-decoratedOptionWidget").prepend(this.$icon).append(this.$indicator)},a.inheritClass(a.ui.DecoratedOptionWidget,a.ui.OptionWidget),a.mixinClass(a.ui.OptionWidget,a.ui.IconedElement),a.mixinClass(a.ui.OptionWidget,a.ui.IndicatedElement),a.ui.ButtonOptionWidget=function(b,c){a.ui.ButtonOptionWidget.super.call(this,b,c),a.ui.ButtonedElement.call(this,this.$("<a>"),c),this.$element.addClass("oo-ui-buttonOptionWidget"),this.$button.append(this.$element.contents()),this.$element.append(this.$button)},a.inheritClass(a.ui.ButtonOptionWidget,a.ui.DecoratedOptionWidget),a.mixinClass(a.ui.ButtonOptionWidget,a.ui.ButtonedElement),a.ui.ButtonOptionWidget.static.cancelButtonMouseDownEvents=!1,a.ui.ButtonOptionWidget.prototype.setSelected=function(b){return a.ui.ButtonOptionWidget.super.prototype.setSelected.call(this,b),this.constructor.static.selectable&&this.setActive(b),this},a.ui.MenuItemWidget=function(b,c){c=$.extend({icon:"check"},c),a.ui.MenuItemWidget.super.call(this,b,c),this.$element.attr("role","menuitem").addClass("oo-ui-menuItemWidget")},a.inheritClass(a.ui.MenuItemWidget,a.ui.DecoratedOptionWidget),a.ui.MenuSectionItemWidget=function(b,c){a.ui.MenuSectionItemWidget.super.call(this,b,c),this.$element.addClass("oo-ui-menuSectionItemWidget")},a.inheritClass(a.ui.MenuSectionItemWidget,a.ui.DecoratedOptionWidget),a.ui.MenuSectionItemWidget.static.selectable=!1,a.ui.MenuSectionItemWidget.static.highlightable=!1,a.ui.OutlineItemWidget=function(b,c){c=c||{},a.ui.OutlineItemWidget.super.call(this,b,c),this.level=0,this.movable=!!c.movable,this.removable=!!c.removable,this.$element.addClass("oo-ui-outlineItemWidget"),this.setLevel(c.level)},a.inheritClass(a.ui.OutlineItemWidget,a.ui.DecoratedOptionWidget),a.ui.OutlineItemWidget.static.highlightable=!1,a.ui.OutlineItemWidget.static.scrollIntoViewOnSelect=!0,a.ui.OutlineItemWidget.static.levelClass="oo-ui-outlineItemWidget-level-",a.ui.OutlineItemWidget.static.levels=3,a.ui.OutlineItemWidget.prototype.isMovable=function(){return this.movable},a.ui.OutlineItemWidget.prototype.isRemovable=function(){return this.removable},a.ui.OutlineItemWidget.prototype.getLevel=function(){return this.level},a.ui.OutlineItemWidget.prototype.setMovable=function(a){return this.movable=!!a,this},a.ui.OutlineItemWidget.prototype.setRemovable=function(a){return this.removable=!!a,this},a.ui.OutlineItemWidget.prototype.setLevel=function(a){var b=this.constructor.static.levels,c=this.constructor.static.levelClass,d=b;for(this.level=a?Math.max(0,Math.min(b-1,a)):0;d--;)this.level===d?this.$element.addClass(c+d):this.$element.removeClass(c+d);return this},a.ui.PopupWidget=function(b){b=b||{},a.ui.PopupWidget.super.call(this,b),a.ui.LabeledElement.call(this,this.$("<div>"),b),a.ui.ClippableElement.call(this,this.$("<div>"),b),this.visible=!1,this.$popup=this.$("<div>"),this.$head=this.$("<div>"),this.$body=this.$clippable,this.$anchor=this.$("<div>"),this.$container=b.$container||this.$("body"),this.autoClose=!!b.autoClose,this.$autoCloseIgnore=b.$autoCloseIgnore,this.transitionTimeout=null,this.anchor=null,this.width=void 0!==b.width?b.width:320,this.height=void 0!==b.height?b.height:null,this.align=b.align||"center",this.closeButton=new a.ui.ButtonWidget({$:this.$,framed:!1,icon:"close"}),this.onMouseDownHandler=a.ui.bind(this.onMouseDown,this),this.closeButton.connect(this,{click:"onCloseButtonClick"}),this.toggleAnchor(void 0===b.anchor||b.anchor),this.$body.addClass("oo-ui-popupWidget-body"),this.$anchor.addClass("oo-ui-popupWidget-anchor"),this.$head.addClass("oo-ui-popupWidget-head").append(this.$label,this.closeButton.$element),b.head||this.$head.hide(),this.$popup.addClass("oo-ui-popupWidget-popup").append(this.$head,this.$body),this.$element.hide().addClass("oo-ui-popupWidget").append(this.$popup,this.$anchor),b.$content instanceof jQuery&&this.$body.append(b.$content),b.padded&&this.$body.addClass("oo-ui-popupWidget-body-padded")},a.inheritClass(a.ui.PopupWidget,a.ui.Widget),a.mixinClass(a.ui.PopupWidget,a.ui.LabeledElement),a.mixinClass(a.ui.PopupWidget,a.ui.ClippableElement),a.ui.PopupWidget.prototype.onMouseDown=function(a){!this.isVisible()||$.contains(this.$element[0],a.target)||this.$autoCloseIgnore&&this.$autoCloseIgnore.has(a.target).length||this.toggle(!1)},a.ui.PopupWidget.prototype.bindMouseDownListener=function(){this.getElementWindow().addEventListener("mousedown",this.onMouseDownHandler,!0)},a.ui.PopupWidget.prototype.onCloseButtonClick=function(){this.isVisible()&&this.toggle(!1)},a.ui.PopupWidget.prototype.unbindMouseDownListener=function(){this.getElementWindow().removeEventListener("mousedown",this.onMouseDownHandler,!0)},a.ui.PopupWidget.prototype.toggleAnchor=function(a){a=void 0===a?!this.anchored:!!a,this.anchored!==a&&(a?this.$element.addClass("oo-ui-popupWidget-anchored"):this.$element.removeClass("oo-ui-popupWidget-anchored"),this.anchored=a)},a.ui.PopupWidget.prototype.hasAnchor=function(){return this.anchor},a.ui.PopupWidget.prototype.toggle=function(b){b=void 0===b?!this.isVisible():!!b;var c=b!==this.isVisible();return a.ui.PopupWidget.super.prototype.toggle.call(this,b),c&&(b?(this.setClipping(!0),this.autoClose&&this.bindMouseDownListener(),this.updateDimensions()):(this.setClipping(!1),this.autoClose&&this.unbindMouseDownListener())),this},a.ui.PopupWidget.prototype.setSize=function(a,b,c){this.width=a,this.height=void 0!==b?b:null,this.isVisible()&&this.updateDimensions(c)},a.ui.PopupWidget.prototype.updateDimensions=function(a){var b=this,c=10,d=Math.round(this.$element.offset().left),e=Math.round(this.$container.offset().left),f=this.$container.innerWidth(),g=e+f,h=this.width*{left:0,center:-.5,right:-1}[this.align],i=this.$anchor.width(),j=h-c,k=h+c+this.width+c,l=d+j-e,m=g-(d+k);return clearTimeout(this.transitionTimeout),a&&this.$element.addClass("oo-ui-popupWidget-transitioning"),0>m?h+=m:0>l&&(h-=l),"right"===this.align?h+=i:"left"===this.align&&(h-=i),this.$popup.css({left:h,width:this.width,height:null!==this.height?this.height:"auto"}),a?this.transitionTimeout=setTimeout(function(){b.$element.removeClass("oo-ui-popupWidget-transitioning")},200):this.$element.removeClass("oo-ui-popupWidget-transitioning"),this},a.ui.SearchWidget=function(b){b=b||{},a.ui.SearchWidget.super.call(this,b),this.query=new a.ui.TextInputWidget({$:this.$,icon:"search",placeholder:b.placeholder,value:b.value}),this.results=new a.ui.SelectWidget({$:this.$}),this.$query=this.$("<div>"),this.$results=this.$("<div>"),this.query.connect(this,{change:"onQueryChange",enter:"onQueryEnter"}),this.results.connect(this,{highlight:"onResultsHighlight",select:"onResultsSelect"}),this.query.$input.on("keydown",a.ui.bind(this.onQueryKeydown,this)),this.$query.addClass("oo-ui-searchWidget-query").append(this.query.$element),this.$results.addClass("oo-ui-searchWidget-results").append(this.results.$element),this.$element.addClass("oo-ui-searchWidget").append(this.$results,this.$query)},a.inheritClass(a.ui.SearchWidget,a.ui.Widget),a.ui.SearchWidget.prototype.onQueryKeydown=function(b){var c,d,e=b.which===a.ui.Keys.DOWN?1:b.which===a.ui.Keys.UP?-1:0;e&&(c=this.results.getHighlightedItem(),c||(c=this.results.getSelectedItem()),d=this.results.getRelativeSelectableItem(c,e),this.results.highlightItem(d),d.scrollElementIntoView())},a.ui.SearchWidget.prototype.onQueryChange=function(){this.results.clearItems()},a.ui.SearchWidget.prototype.onQueryEnter=function(){this.results.selectItem(this.results.getHighlightedItem())},a.ui.SearchWidget.prototype.onResultsHighlight=function(a){this.emit("highlight",a?a.getData():null)},a.ui.SearchWidget.prototype.onResultsSelect=function(a){this.emit("select",a?a.getData():null)},a.ui.SearchWidget.prototype.getQuery=function(){return this.query},a.ui.SearchWidget.prototype.getResults=function(){return this.results},a.ui.SelectWidget=function(b){b=b||{},a.ui.SelectWidget.super.call(this,b),a.ui.GroupWidget.call(this,this.$element,b),this.pressed=!1,this.selecting=null,this.hashes={},this.onMouseUpHandler=a.ui.bind(this.onMouseUp,this),this.onMouseMoveHandler=a.ui.bind(this.onMouseMove,this),this.$element.on({mousedown:a.ui.bind(this.onMouseDown,this),mouseover:a.ui.bind(this.onMouseOver,this),mouseleave:a.ui.bind(this.onMouseLeave,this)}),this.$element.addClass("oo-ui-selectWidget oo-ui-selectWidget-depressed"),$.isArray(b.items)&&this.addItems(b.items)},a.inheritClass(a.ui.SelectWidget,a.ui.Widget),a.mixinClass(a.ui.SelectWidget,a.ui.GroupElement),a.mixinClass(a.ui.SelectWidget,a.ui.GroupWidget),a.ui.SelectWidget.static.tagName="ul",a.ui.SelectWidget.prototype.onMouseDown=function(a){var b;return this.isDisabled()||1!==a.which||(this.togglePressed(!0),b=this.getTargetItem(a),b&&b.isSelectable()&&(this.pressItem(b),this.selecting=b,this.getElementDocument().addEventListener("mouseup",this.onMouseUpHandler,!0),this.getElementDocument().addEventListener("mousemove",this.onMouseMoveHandler,!0))),!1},a.ui.SelectWidget.prototype.onMouseUp=function(a){var b;return this.togglePressed(!1),this.selecting||(b=this.getTargetItem(a),b&&b.isSelectable()&&(this.selecting=b)),!this.isDisabled()&&1===a.which&&this.selecting&&(this.pressItem(null),this.chooseItem(this.selecting),this.selecting=null),this.getElementDocument().removeEventListener("mouseup",this.onMouseUpHandler,!0),this.getElementDocument().removeEventListener("mousemove",this.onMouseMoveHandler,!0),!1},a.ui.SelectWidget.prototype.onMouseMove=function(a){var b;return!this.isDisabled()&&this.pressed&&(b=this.getTargetItem(a),b&&b!==this.selecting&&b.isSelectable()&&(this.pressItem(b),this.selecting=b)),!1},a.ui.SelectWidget.prototype.onMouseOver=function(a){var b;return this.isDisabled()||(b=this.getTargetItem(a),this.highlightItem(b&&b.isHighlightable()?b:null)),!1},a.ui.SelectWidget.prototype.onMouseLeave=function(){return this.isDisabled()||this.highlightItem(null),!1},a.ui.SelectWidget.prototype.getTargetItem=function(a){var b=this.$(a.target).closest(".oo-ui-optionWidget");return b.length?b.data("oo-ui-optionWidget"):null},a.ui.SelectWidget.prototype.getSelectedItem=function(){var a,b;for(a=0,b=this.items.length;b>a;a++)if(this.items[a].isSelected())return this.items[a];return null},a.ui.SelectWidget.prototype.getHighlightedItem=function(){var a,b;for(a=0,b=this.items.length;b>a;a++)if(this.items[a].isHighlighted())return this.items[a];return null},a.ui.SelectWidget.prototype.getItemFromData=function(b){var c=a.getHash(b);return c in this.hashes?this.hashes[c]:null},a.ui.SelectWidget.prototype.togglePressed=function(a){void 0===a&&(a=!this.pressed),a!==this.pressed&&(this.$element.toggleClass("oo-ui-selectWidget-pressed",a).toggleClass("oo-ui-selectWidget-depressed",!a),this.pressed=a)},a.ui.SelectWidget.prototype.highlightItem=function(a){var b,c,d,e=!1;for(b=0,c=this.items.length;c>b;b++)d=this.items[b]===a,this.items[b].isHighlighted()!==d&&(this.items[b].setHighlighted(d),e=!0);return e&&this.emit("highlight",a),this},a.ui.SelectWidget.prototype.selectItem=function(a){var b,c,d,e=!1;for(b=0,c=this.items.length;c>b;b++)d=this.items[b]===a,this.items[b].isSelected()!==d&&(this.items[b].setSelected(d),e=!0);return e&&this.emit("select",a),this},a.ui.SelectWidget.prototype.pressItem=function(a){var b,c,d,e=!1;for(b=0,c=this.items.length;c>b;b++)d=this.items[b]===a,this.items[b].isPressed()!==d&&(this.items[b].setPressed(d),e=!0);return e&&this.emit("press",a),this},a.ui.SelectWidget.prototype.chooseItem=function(a){return this.selectItem(a),this.emit("choose",a),this},a.ui.SelectWidget.prototype.getRelativeSelectableItem=function(b,c){for(var d=c>0?1:-1,e=this.items.length,f=b instanceof a.ui.OptionWidget?$.inArray(b,this.items):d>0?-1:0,g=Math.max(Math.min(f,e-1),0),h=d>0?Math.max(f,-1):Math.min(f,e);;){if(h=(h+d+e)%e,b=this.items[h],b instanceof a.ui.OptionWidget&&b.isSelectable())return b;if(h===g)break}return null},a.ui.SelectWidget.prototype.getFirstSelectableItem=function(){var b,c,d;for(b=0,c=this.items.length;c>b;b++)if(d=this.items[b],d instanceof a.ui.OptionWidget&&d.isSelectable())return d;return null},a.ui.SelectWidget.prototype.addItems=function(b,c){var d,e,f,g,h=[];for(d=0,e=b.length;e>d;d++)f=b[d],g=a.getHash(f.getData()),g in this.hashes&&h.push(this.hashes[g]),this.hashes[g]=f;return h.length&&this.removeItems(h),a.ui.GroupWidget.prototype.addItems.call(this,b,c),this.emit("add",b,void 0===c?this.items.length-b.length-1:c),this},a.ui.SelectWidget.prototype.removeItems=function(b){var c,d,e,f;for(c=0,d=b.length;d>c;c++)e=b[c],f=a.getHash(e.getData()),f in this.hashes&&delete this.hashes[f],e.isSelected()&&this.selectItem(null);return a.ui.GroupWidget.prototype.removeItems.call(this,b),this.emit("remove",b),this},a.ui.SelectWidget.prototype.clearItems=function(){var b=this.items.slice();return this.hashes={},a.ui.GroupWidget.prototype.clearItems.call(this),this.selectItem(null),this.emit("remove",b),this},a.ui.ButtonSelectWidget=function(b){a.ui.ButtonSelectWidget.super.call(this,b),this.$element.addClass("oo-ui-buttonSelectWidget")},a.inheritClass(a.ui.ButtonSelectWidget,a.ui.SelectWidget),a.ui.MenuWidget=function(b){b=b||{},a.ui.MenuWidget.super.call(this,b),a.ui.ClippableElement.call(this,this.$group,b),this.flashing=!1,this.visible=!1,this.newItems=null,this.autoHide=void 0===b.autoHide||!!b.autoHide,this.$input=b.input?b.input.$input:null,this.$widget=b.widget?b.widget.$element:null,this.$previousFocus=null,this.isolated=!b.input,this.onKeyDownHandler=a.ui.bind(this.onKeyDown,this),this.onDocumentMouseDownHandler=a.ui.bind(this.onDocumentMouseDown,this),this.$element.hide().attr("role","menu").addClass("oo-ui-menuWidget")},a.inheritClass(a.ui.MenuWidget,a.ui.SelectWidget),a.mixinClass(a.ui.MenuWidget,a.ui.ClippableElement),a.ui.MenuWidget.prototype.onDocumentMouseDown=function(a){$.contains(this.$element[0],a.target)||this.$widget&&$.contains(this.$widget[0],a.target)||this.toggle(!1)},a.ui.MenuWidget.prototype.onKeyDown=function(b){var c,d=!1,e=this.getHighlightedItem();if(!this.isDisabled()&&this.isVisible()){switch(e||(e=this.getSelectedItem()),b.keyCode){case a.ui.Keys.ENTER:this.chooseItem(e),d=!0;break;case a.ui.Keys.UP:c=this.getRelativeSelectableItem(e,-1),d=!0;break;case a.ui.Keys.DOWN:c=this.getRelativeSelectableItem(e,1),d=!0;break;case a.ui.Keys.ESCAPE:e&&e.setHighlighted(!1),this.toggle(!1),d=!0}if(c&&(this.highlightItem(c),c.scrollElementIntoView()),d)return b.preventDefault(),b.stopPropagation(),!1}},a.ui.MenuWidget.prototype.bindKeyDownListener=function(){this.$input?this.$input.on("keydown",this.onKeyDownHandler):this.getElementWindow().addEventListener("keydown",this.onKeyDownHandler,!0)},a.ui.MenuWidget.prototype.unbindKeyDownListener=function(){this.$input?this.$input.off("keydown"):this.getElementWindow().removeEventListener("keydown",this.onKeyDownHandler,!0)},a.ui.MenuWidget.prototype.chooseItem=function(b){var c=this;return a.ui.MenuWidget.super.prototype.chooseItem.call(this,b),b&&!this.flashing?(this.flashing=!0,b.flash().done(function(){c.toggle(!1),c.flashing=!1})):this.toggle(!1),this},a.ui.MenuWidget.prototype.addItems=function(b,c){var d,e,f;for(a.ui.MenuWidget.super.prototype.addItems.call(this,b,c),this.newItems||(this.newItems=[]),d=0,e=b.length;e>d;d++)f=b[d],this.isVisible()?f.fitLabel():this.newItems.push(f);return this},a.ui.MenuWidget.prototype.toggle=function(b){b=!!b&&!!this.items.length;var c,d,e=b!==this.isVisible();if(a.ui.MenuWidget.super.prototype.toggle.call(this,b),e)if(b){if(this.bindKeyDownListener(),this.isolated&&this.$input&&!this.$input.is(":focus")&&(this.$previousFocus=this.$(":focus"),this.$input[0].focus()),this.newItems&&this.newItems.length){for(c=0,d=this.newItems.length;d>c;c++)this.newItems[c].fitLabel();this.newItems=null}this.setClipping(!0),this.autoHide&&this.getElementDocument().addEventListener("mousedown",this.onDocumentMouseDownHandler,!0)}else this.unbindKeyDownListener(),this.isolated&&this.$previousFocus&&(this.$previousFocus[0].focus(),this.$previousFocus=null),this.getElementDocument().removeEventListener("mousedown",this.onDocumentMouseDownHandler,!0),this.setClipping(!1);return this},a.ui.TextInputMenuWidget=function(b,c){a.ui.TextInputMenuWidget.super.call(this,c),this.input=b,this.$container=c.$container||this.input.$element,this.onWindowResizeHandler=a.ui.bind(this.onWindowResize,this),this.$element.addClass("oo-ui-textInputMenuWidget")},a.inheritClass(a.ui.TextInputMenuWidget,a.ui.MenuWidget),a.ui.TextInputMenuWidget.prototype.onWindowResize=function(){this.position()},a.ui.TextInputMenuWidget.prototype.toggle=function(b){b=!!b;var c=b!==this.isVisible();return a.ui.TextInputMenuWidget.super.prototype.toggle.call(this,b),c&&(this.isVisible()?(this.position(),this.$(this.getElementWindow()).on("resize",this.onWindowResizeHandler)):this.$(this.getElementWindow()).off("resize",this.onWindowResizeHandler)),this},a.ui.TextInputMenuWidget.prototype.position=function(){var b,c=this.$container,d=c.offset();return d.top+=c.height(),this.input.$.frame&&this.input.$.context!==this.$element[0].ownerDocument?(b=a.ui.Element.getRelativePosition(this.input.$.frame.$element,this.$element.offsetParent()),d.left+=b.left,d.top+=b.top):"rtl"===this.$element.css("direction")&&(d.right=this.$element.parent().position().left-c.width()-d.left,delete d.left),this.$element.css(d),this.setIdealSize(c.width()),this},a.ui.OutlineWidget=function(b){b=b||{},a.ui.OutlineWidget.super.call(this,b),this.$element.addClass("oo-ui-outlineWidget")},a.inheritClass(a.ui.OutlineWidget,a.ui.SelectWidget),a.ui.ToggleSwitchWidget=function(b){a.ui.ToggleSwitchWidget.super.call(this,b),a.ui.ToggleWidget.call(this,b),this.dragging=!1,this.dragStart=null,this.sliding=!1,this.$glow=this.$("<span>"),this.$grip=this.$("<span>"),this.$element.on("click",a.ui.bind(this.onClick,this)),this.$glow.addClass("oo-ui-toggleSwitchWidget-glow"),this.$grip.addClass("oo-ui-toggleSwitchWidget-grip"),this.$element.addClass("oo-ui-toggleSwitchWidget").append(this.$glow,this.$grip)},a.inheritClass(a.ui.ToggleSwitchWidget,a.ui.Widget),a.mixinClass(a.ui.ToggleSwitchWidget,a.ui.ToggleWidget),a.ui.ToggleSwitchWidget.prototype.onClick=function(a){this.isDisabled()||1!==a.which||this.setValue(!this.value)}}(OO);var rangy;rangy=rangy||function(){function a(a,b){var c=typeof a[b];return c==p||!(c!=o||!a[b])||"unknown"==c}function b(a,b){return!(typeof a[b]!=o||!a[b])}function c(a,b){return typeof a[b]!=q}function d(a){return function(b,c){for(var d=c.length;d--;)if(!a(b,c[d]))return!1;return!0}}function e(a){return a&&v(a,u)&&x(a,t)}function f(a){return b(a,"body")?a.body:a.getElementsByTagName("body")[0]}function g(c){b(window,"console")&&a(window.console,"log")&&window.console.log(c)}function h(a,b){b?window.alert(a):g(a)}function i(a){z.initialized=!0,z.supported=!1,h("Rangy is not supported on this page in your browser. Reason: "+a,z.config.alertOnFail)}function j(a){h("Rangy warning: "+a,z.config.alertOnWarn)}function k(a){return a.message||a.description||String(a)}function l(){if(!z.initialized){var b,c=!1,d=!1;a(document,"createRange")&&(b=document.createRange(),v(b,s)&&x(b,r)&&(c=!0),b.detach());var h=f(document);if(!h||"body"!=h.nodeName.toLowerCase())return void i("No body element found");if(h&&a(h,"createTextRange")&&(b=h.createTextRange(),e(b)&&(d=!0)),!c&&!d)return void i("Neither Range nor TextRange are available");z.initialized=!0,z.features={implementsDomRange:c,implementsTextRange:d};var j,l;for(var m in y)(j=y[m])instanceof n&&j.init();for(var o=0,p=B.length;p>o;++o)try{B[o](z)}catch(q){l="Rangy init listener threw an exception. Continuing. Detail: "+k(q),g(l)}}}function m(a){a=a||window,l();for(var b=0,c=C.length;c>b;++b)C[b](a)}function n(a,b){this.name=a,this.initialized=!1,this.supported=!1,this.init=b}var o="object",p="function",q="undefined",r=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],s=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],t=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],u=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"],v=d(a),w=d(b),x=d(c),y={},z={version:"1.3alpha.772",initialized:!1,supported:!0,util:{isHostMethod:a,isHostObject:b,isHostProperty:c,areHostMethods:v,areHostObjects:w,areHostProperties:x,isTextRange:e,getBody:f},features:{},modules:y,config:{alertOnFail:!0,alertOnWarn:!1,preferTextRange:!1}};z.fail=i,z.warn=j,{}.hasOwnProperty?z.util.extend=function(a,b,c){var d,e;for(var f in b)b.hasOwnProperty(f)&&(d=a[f],e=b[f],c&&null!==d&&"object"==typeof d&&null!==e&&"object"==typeof e&&z.util.extend(d,e,!0),a[f]=e);return a}:i("hasOwnProperty not supported"),function(){var a=document.createElement("div");a.appendChild(document.createElement("span"));var b,c=[].slice;try{1==c.call(a.childNodes,0)[0].nodeType&&(b=function(a){return c.call(a,0)})}catch(d){}b||(b=function(a){for(var b=[],c=0,d=a.length;d>c;++c)b[c]=a[c];return b}),z.util.toArray=b}();var A;a(document,"addEventListener")?A=function(a,b,c){a.addEventListener(b,c,!1)}:a(document,"attachEvent")?A=function(a,b,c){a.attachEvent("on"+b,c)}:i("Document does not have required addEventListener or attachEvent method"),z.util.addListener=A;var B=[];z.init=l,z.addInitListener=function(a){z.initialized?a(z):B.push(a)};var C=[];z.addCreateMissingNativeApiListener=function(a){C.push(a)},z.createMissingNativeApi=m,n.prototype={fail:function(a){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+a)},warn:function(a){z.warn("Module "+this.name+": "+a)},deprecationNotice:function(a,b){z.warn("DEPRECATED: "+a+" in module "+this.name+"is deprecated. Please use "+b+" instead")},createError:function(a){return new Error("Error in Rangy "+this.name+" module: "+a)}},z.createModule=function(a,b){var c=new n(a,function(){if(!c.initialized){c.initialized=!0;try{b(z,c),c.supported=!0}catch(d){var e="Module '"+a+"' failed to load: "+k(d);g(e)}}});y[a]=c},z.requireModules=function(a){for(var b,c,d=0,e=a.length;e>d;++d){if(c=a[d],b=y[c],!(b&&b instanceof n))throw new Error("required module '"+c+"' not found");if(b.init(),!b.supported)throw new Error("required module '"+c+"' not supported")}};var D=!1,E=function(){D||(D=!0,z.initialized||l())};return typeof window==q?void i("No window found"):typeof document==q?void i("No document found"):(a(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",E,!1),A(window,"load",E),z)}(),rangy.createModule("DomUtil",function(a,b){function c(a){var b;return typeof a.namespaceURI==D||null===(b=a.namespaceURI)||"http://www.w3.org/1999/xhtml"==b}function d(a){var b=a.parentNode;return 1==b.nodeType?b:null}function e(a){for(var b=0;a=a.previousSibling;)++b;return b}function f(a){switch(a.nodeType){case 7:case 10:return 0;case 3:case 8:return a.length;default:return a.childNodes.length}}function g(a,b){var c,d=[];for(c=a;c;c=c.parentNode)d.push(c);for(c=b;c;c=c.parentNode)if(H(d,c))return c;return null}function h(a,b,c){for(var d=c?b:b.parentNode;d;){if(d===a)return!0;d=d.parentNode}return!1}function i(a,b){return h(a,b,!0)}function j(a,b,c){for(var d,e=c?a:a.parentNode;e;){if(d=e.parentNode,d===b)return e;e=d}return null}function k(a){var b=a.nodeType;return 3==b||4==b||8==b}function l(a){if(!a)return!1;var b=a.nodeType;return 3==b||8==b}function m(a,b){var c=b.nextSibling,d=b.parentNode;return c?d.insertBefore(a,c):d.appendChild(a),a}function n(a,b,c){var d=a.cloneNode(!1);if(d.deleteData(0,b),a.deleteData(b,a.length-b),m(d,a),c)for(var f,g=0;f=c[g++];)f.node==a&&f.offset>b?(f.node=d,f.offset-=b):f.node==a.parentNode&&f.offset>e(a)&&++f.offset;return d}function o(a){if(9==a.nodeType)return a;if(typeof a.ownerDocument!=D)return a.ownerDocument;if(typeof a.document!=D)return a.document;if(a.parentNode)return o(a.parentNode);throw b.createError("getDocument: no document found for node")}function p(a){var c=o(a);if(typeof c.defaultView!=D)return c.defaultView;if(typeof c.parentWindow!=D)return c.parentWindow;throw b.createError("Cannot get a window object for node")}function q(a){if(typeof a.contentDocument!=D)return a.contentDocument;if(typeof a.contentWindow!=D)return a.contentWindow.document;throw b.createError("getIframeDocument: No Document object found for iframe element")}function r(a){if(typeof a.contentWindow!=D)return a.contentWindow;if(typeof a.contentDocument!=D)return a.contentDocument.defaultView;throw b.createError("getIframeWindow: No Window object found for iframe element")}function s(a){return a&&E.isHostMethod(a,"setTimeout")&&E.isHostObject(a,"document")}function t(a,b,c){var d;if(a?E.isHostProperty(a,"nodeType")?d=1==a.nodeType&&"iframe"==a.tagName.toLowerCase()?q(a):o(a):s(a)&&(d=a.document):d=document,!d)throw b.createError(c+"(): Parameter must be a Window object or DOM node");return d}function u(a){for(var b;b=a.parentNode;)a=b;return a}function v(a,c,d,f){var h,i,k,l,m;if(a==d)return c===f?0:f>c?-1:1;if(h=j(d,a,!0))return c<=e(h)?-1:1;if(h=j(a,d,!0))return e(h)<f?-1:1;if(i=g(a,d),k=a===i?i:j(a,i,!0),l=d===i?i:j(d,i,!0),k===l)throw b.createError("comparePoints got to case 4 and childA and childB are the same!");for(m=i.firstChild;m;){if(m===k)return-1;if(m===l)return 1;m=m.nextSibling}}function w(a){try{return a.parentNode,!1}catch(b){return!0}}function x(a){if(!a)return"[No node]";if(I&&w(a))return"[Broken node]";if(k(a))return'"'+a.data+'"';if(1==a.nodeType){var b=a.id?' id="'+a.id+'"':"";return"<"+a.nodeName+b+">["+a.childNodes.length+"]["+a.innerHTML.slice(0,20)+"]"}return a.nodeName}function y(a){for(var b,c=o(a).createDocumentFragment();b=a.firstChild;)c.appendChild(b);return c}function z(a){this.root=a,this._next=a}function A(a){return new z(a)}function B(a,b){this.node=a,this.offset=b}function C(a){this.code=this[a],this.codeName=a,this.message="DOMException: "+this.codeName}var D="undefined",E=a.util;E.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||b.fail("document missing a Node creation method"),E.isHostMethod(document,"getElementsByTagName")||b.fail("document missing getElementsByTagName method");var F=document.createElement("div");E.areHostMethods(F,["insertBefore","appendChild","cloneNode"]||!E.areHostObjects(F,["previousSibling","nextSibling","childNodes","parentNode"]))||b.fail("Incomplete Element implementation"),E.isHostProperty(F,"innerHTML")||b.fail("Element is missing innerHTML property");var G=document.createTextNode("test");E.areHostMethods(G,["splitText","deleteData","insertData","appendData","cloneNode"]||!E.areHostObjects(F,["previousSibling","nextSibling","childNodes","parentNode"])||!E.areHostProperties(G,["data"]))||b.fail("Incomplete Text Node implementation");var H=function(a,b){for(var c=a.length;c--;)if(a[c]===b)return!0;return!1},I=!1;!function(){var b=document.createElement("b");b.innerHTML="1";var c=b.firstChild;b.innerHTML="<br>",I=w(c),a.features.crashyTextNodes=I}();var J;typeof window.getComputedStyle!=D?J=function(a,b){return p(a).getComputedStyle(a,null)[b]}:typeof document.documentElement.currentStyle!=D?J=function(a,b){return a.currentStyle[b]}:b.fail("No means of obtaining computed style properties found"),z.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var a,b,c=this._current=this._next;if(this._current)if(a=c.firstChild)this._next=a;else{for(b=null;c!==this.root&&!(b=c.nextSibling);)c=c.parentNode;this._next=b}return this._current},detach:function(){this._current=this._next=this.root=null}},B.prototype={equals:function(a){return!!a&&this.node===a.node&&this.offset==a.offset},inspect:function(){return"[DomPosition("+x(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},C.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11},C.prototype.toString=function(){return this.message},a.dom={arrayContains:H,isHtmlNamespace:c,parentElement:d,getNodeIndex:e,getNodeLength:f,getCommonAncestor:g,isAncestorOf:h,isOrIsAncestorOf:i,getClosestAncestorIn:j,isCharacterDataNode:k,isTextOrCommentNode:l,insertAfter:m,splitDataNode:n,getDocument:o,getWindow:p,getIframeWindow:r,getIframeDocument:q,getBody:E.getBody,isWindow:s,getContentDocument:t,getRootContainer:u,comparePoints:v,isBrokenNode:w,inspectNode:x,getComputedStyleProperty:J,fragmentFromNodeChildren:y,createIterator:A,DomPosition:B},a.DOMException=C}),rangy.createModule("DomRange",function(a){function b(a,b){return 3!=a.nodeType&&(R(a,b.startContainer)||R(a,b.endContainer))}function c(a){return a.document||S(a.startContainer)}function d(a){return new N(a.parentNode,Q(a))}function e(a){return new N(a.parentNode,Q(a)+1)}function f(a,b,c){var d=11==a.nodeType?a.firstChild:a;return P(b)?c==b.length?L.insertAfter(a,b):b.parentNode.insertBefore(a,0==c?b:U(b,c)):c>=b.childNodes.length?b.appendChild(a):b.insertBefore(a,b.childNodes[c]),d}function g(a,b,d){if(A(a),A(b),c(b)!=c(a))throw new O("WRONG_DOCUMENT_ERR");var e=T(a.startContainer,a.startOffset,b.endContainer,b.endOffset),f=T(a.endContainer,a.endOffset,b.startContainer,b.startOffset);return d?0>=e&&f>=0:0>e&&f>0}function h(a){for(var b,d,e,f=c(a.range).createDocumentFragment();d=a.next();){if(b=a.isPartiallySelectedSubtree(),d=d.cloneNode(!b),b&&(e=a.getSubtreeIterator(),d.appendChild(h(e)),e.detach(!0)),10==d.nodeType)throw new O("HIERARCHY_REQUEST_ERR");f.appendChild(d)}return f}function i(a,b,c){var d,e;c=c||{stop:!1};for(var f,g;f=a.next();)if(a.isPartiallySelectedSubtree()){if(b(f)===!1)return void(c.stop=!0);if(g=a.getSubtreeIterator(),i(g,b,c),g.detach(!0),c.stop)return}else for(d=L.createIterator(f);e=d.next();)if(b(e)===!1)return void(c.stop=!0)}function j(a){for(var b;a.next();)a.isPartiallySelectedSubtree()?(b=a.getSubtreeIterator(),j(b),b.detach(!0)):a.remove()}function k(a){for(var b,d,e=c(a.range).createDocumentFragment();b=a.next();){if(a.isPartiallySelectedSubtree()?(b=b.cloneNode(!1),d=a.getSubtreeIterator(),b.appendChild(k(d)),d.detach(!0)):a.remove(),10==b.nodeType)throw new O("HIERARCHY_REQUEST_ERR");e.appendChild(b)}return e}function l(a,b,c){var d,e=!(!b||!b.length),f=!!c;e&&(d=new RegExp("^("+b.join("|")+")$"));
var g=[];return i(new n(a,!1),function(a){e&&!d.test(a.nodeType)||f&&!c(a)||g.push(a)}),g}function m(a){var b="undefined"==typeof a.getName?"Range":a.getName();return"["+b+"("+L.inspectNode(a.startContainer)+":"+a.startOffset+", "+L.inspectNode(a.endContainer)+":"+a.endOffset+")]"}function n(a,b){if(this.range=a,this.clonePartiallySelectedTextNodes=b,!a.collapsed){this.sc=a.startContainer,this.so=a.startOffset,this.ec=a.endContainer,this.eo=a.endOffset;var c=a.commonAncestorContainer;this.sc===this.ec&&P(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==c||P(this.sc)?V(this.sc,c,!0):this.sc.childNodes[this.so],this._last=this.ec!==c||P(this.ec)?V(this.ec,c,!0):this.ec.childNodes[this.eo-1])}}function o(a){this.code=this[a],this.codeName=a,this.message="RangeException: "+this.codeName}function p(a){return function(b,c){for(var d,e=c?b:b.parentNode;e;){if(d=e.nodeType,X(a,d))return e;e=e.parentNode}return null}}function q(a,b){if(fb(a,b))throw new o("INVALID_NODE_TYPE_ERR")}function r(a){if(!a.startContainer)throw new O("INVALID_STATE_ERR")}function s(a,b){if(!X(b,a.nodeType))throw new o("INVALID_NODE_TYPE_ERR")}function t(a,b){if(0>b||b>(P(a)?a.length:a.childNodes.length))throw new O("INDEX_SIZE_ERR")}function u(a,b){if(db(a,!0)!==db(b,!0))throw new O("WRONG_DOCUMENT_ERR")}function v(a){if(eb(a,!0))throw new O("NO_MODIFICATION_ALLOWED_ERR")}function w(a,b){if(!a)throw new O(b)}function x(a){return Z&&L.isBrokenNode(a)||!X(_,a.nodeType)&&!db(a,!0)}function y(a,b){return b<=(P(a)?a.length:a.childNodes.length)}function z(a){return!!a.startContainer&&!!a.endContainer&&!x(a.startContainer)&&!x(a.endContainer)&&y(a.startContainer,a.startOffset)&&y(a.endContainer,a.endOffset)}function A(a){if(r(a),!z(a))throw new Error("Range error: Range is no longer valid after DOM mutation ("+a.inspect()+")")}function B(a,b){A(a);var c=a.startContainer,d=a.startOffset,e=a.endContainer,f=a.endOffset,g=c===e;P(e)&&f>0&&f<e.length&&U(e,f,b),P(c)&&d>0&&d<c.length&&(c=U(c,d,b),g?(f-=d,e=c):e==c.parentNode&&f>=Q(c)&&f++,d=0),a.setStartAndEnd(c,d,e,f)}function C(){}function D(a){a.START_TO_START=lb,a.START_TO_END=mb,a.END_TO_END=nb,a.END_TO_START=ob,a.NODE_BEFORE=pb,a.NODE_AFTER=qb,a.NODE_BEFORE_AND_AFTER=rb,a.NODE_INSIDE=sb}function E(a){D(a),D(a.prototype)}function F(a,b){return function(){A(this);var c,d,f=this.startContainer,g=this.startOffset,h=this.commonAncestorContainer,j=new n(this,!0);f!==h&&(c=V(f,h,!0),d=e(c),f=d.node,g=d.offset),i(j,v),j.reset();var k=a(j);return j.detach(),b(this,f,g,f,g),k}}function G(a,c,f){function g(a,b){return function(c){r(this),s(c,$),s(Y(c),_);var f=(a?d:e)(c);(b?h:i)(this,f.node,f.offset)}}function h(a,b,d){var e=a.endContainer,f=a.endOffset;(b!==a.startContainer||d!==a.startOffset)&&((Y(b)!=Y(e)||1==T(b,d,e,f))&&(e=b,f=d),c(a,b,d,e,f))}function i(a,b,d){var e=a.startContainer,f=a.startOffset;(b!==a.endContainer||d!==a.endOffset)&&((Y(b)!=Y(e)||-1==T(b,d,e,f))&&(e=b,f=d),c(a,e,f,b,d))}a.prototype=new C,M.extend(a.prototype,{setStart:function(a,b){r(this),q(a,!0),t(a,b),h(this,a,b)},setEnd:function(a,b){r(this),q(a,!0),t(a,b),i(this,a,b)},setStartAndEnd:function(){r(this);var a=arguments,b=a[0],d=a[1],e=b,f=d;switch(a.length){case 3:f=a[2];break;case 4:e=a[2],f=a[3]}c(this,b,d,e,f)},setBoundary:function(a,b,c){this["set"+(c?"Start":"End")](a,b)},setStartBefore:g(!0,!0),setStartAfter:g(!1,!0),setEndBefore:g(!0,!1),setEndAfter:g(!1,!1),collapse:function(a){A(this),a?c(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):c(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(a){r(this),q(a,!0),c(this,a,0,a,W(a))},selectNode:function(a){r(this),q(a,!1),s(a,$);var b=d(a),f=e(a);c(this,b.node,b.offset,f.node,f.offset)},extractContents:F(k,c),deleteContents:F(j,c),canSurroundContents:function(){A(this),v(this.startContainer),v(this.endContainer);var a=new n(this,!0),c=a._first&&b(a._first,this)||a._last&&b(a._last,this);return a.detach(),!c},detach:function(){f(this)},splitBoundaries:function(){B(this)},splitBoundariesPreservingPositions:function(a){B(this,a)},normalizeBoundaries:function(){A(this);var a=this.startContainer,b=this.startOffset,d=this.endContainer,e=this.endOffset,f=function(a){var b=a.nextSibling;b&&b.nodeType==a.nodeType&&(d=a,e=a.length,a.appendData(b.data),b.parentNode.removeChild(b))},g=function(c){var f=c.previousSibling;if(f&&f.nodeType==c.nodeType){a=c;var g=c.length;if(b=f.length,c.insertData(0,f.data),f.parentNode.removeChild(f),a==d)e+=b,d=a;else if(d==c.parentNode){var h=Q(c);e==h?(d=c,e=g):e>h&&e--}}},h=!0;if(P(d))d.length==e&&f(d);else{if(e>0){var i=d.childNodes[e-1];i&&P(i)&&f(i)}h=!this.collapsed}if(h){if(P(a))0==b&&g(a);else if(b<a.childNodes.length){var j=a.childNodes[b];j&&P(j)&&g(j)}}else a=d,b=e;c(this,a,b,d,e)},collapseToPoint:function(a,b){r(this),q(a,!0),t(a,b),this.setStartAndEnd(a,b)}}),E(a)}function H(a){a.collapsed=a.startContainer===a.endContainer&&a.startOffset===a.endOffset,a.commonAncestorContainer=a.collapsed?a.startContainer:L.getCommonAncestor(a.startContainer,a.endContainer)}function I(a,b,c,d,e){a.startContainer=b,a.startOffset=c,a.endContainer=d,a.endOffset=e,a.document=L.getDocument(b),H(a)}function J(a){r(a),a.startContainer=a.startOffset=a.endContainer=a.endOffset=a.document=null,a.collapsed=a.commonAncestorContainer=null}function K(a){this.startContainer=a,this.startOffset=0,this.endContainer=a,this.endOffset=0,this.document=a,H(this)}a.requireModules(["DomUtil"]);var L=a.dom,M=a.util,N=L.DomPosition,O=a.DOMException,P=L.isCharacterDataNode,Q=L.getNodeIndex,R=L.isOrIsAncestorOf,S=L.getDocument,T=L.comparePoints,U=L.splitDataNode,V=L.getClosestAncestorIn,W=L.getNodeLength,X=L.arrayContains,Y=L.getRootContainer,Z=a.features.crashyTextNodes;n.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next;return a&&(this._next=a!==this._last?a.nextSibling:null,P(a)&&this.clonePartiallySelectedTextNodes&&(a===this.ec&&(a=a.cloneNode(!0)).deleteData(this.eo,a.length-this.eo),this._current===this.sc&&(a=a.cloneNode(!0)).deleteData(0,this.so))),a},remove:function(){var a,b,c=this._current;!P(c)||c!==this.sc&&c!==this.ec?c.parentNode&&c.parentNode.removeChild(c):(a=c===this.sc?this.so:0,b=c===this.ec?this.eo:c.length,a!=b&&c.deleteData(a,b-a))},isPartiallySelectedSubtree:function(){var a=this._current;return b(a,this.range)},getSubtreeIterator:function(){var a;if(this.isSingleCharacterDataNode)a=this.range.cloneRange(),a.collapse(!1);else{a=new K(c(this.range));var b=this._current,d=b,e=0,f=b,g=W(b);R(b,this.sc)&&(d=this.sc,e=this.so),R(b,this.ec)&&(f=this.ec,g=this.eo),I(a,d,e,f,g)}return new n(a,this.clonePartiallySelectedTextNodes)},detach:function(a){a&&this.range.detach(),this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}},o.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2},o.prototype.toString=function(){return this.message};var $=[1,3,4,5,7,8,10],_=[2,9,11],ab=[5,6,10,12],bb=[1,3,4,5,7,8,10,11],cb=[1,3,4,5,7,8],db=p([9,11]),eb=p(ab),fb=p([6,10,12]),gb=document.createElement("style"),hb=!1;try{gb.innerHTML="<b>x</b>",hb=3==gb.firstChild.nodeType}catch(ib){}a.features.htmlParsingConforms=hb;var jb=hb?function(a){var b=this.startContainer,c=S(b);if(!b)throw new O("INVALID_STATE_ERR");var d=null;return 1==b.nodeType?d=b:P(b)&&(d=L.parentElement(b)),d=null===d||"HTML"==d.nodeName&&L.isHtmlNamespace(S(d).documentElement)&&L.isHtmlNamespace(d)?c.createElement("body"):d.cloneNode(!1),d.innerHTML=a,L.fragmentFromNodeChildren(d)}:function(a){r(this);var b=c(this),d=b.createElement("body");return d.innerHTML=a,L.fragmentFromNodeChildren(d)},kb=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],lb=0,mb=1,nb=2,ob=3,pb=0,qb=1,rb=2,sb=3;C.prototype={compareBoundaryPoints:function(a,b){A(this),u(this.startContainer,b.startContainer);var c,d,e,f,g=a==ob||a==lb?"start":"end",h=a==mb||a==lb?"start":"end";return c=this[g+"Container"],d=this[g+"Offset"],e=b[h+"Container"],f=b[h+"Offset"],T(c,d,e,f)},insertNode:function(a){if(A(this),s(a,bb),v(this.startContainer),R(a,this.startContainer))throw new O("HIERARCHY_REQUEST_ERR");var b=f(a,this.startContainer,this.startOffset);this.setStartBefore(b)},cloneContents:function(){A(this);var a,b;if(this.collapsed)return c(this).createDocumentFragment();if(this.startContainer===this.endContainer&&P(this.startContainer))return a=this.startContainer.cloneNode(!0),a.data=a.data.slice(this.startOffset,this.endOffset),b=c(this).createDocumentFragment(),b.appendChild(a),b;var d=new n(this,!0);return a=h(d),d.detach(),a},canSurroundContents:function(){A(this),v(this.startContainer),v(this.endContainer);var a=new n(this,!0),c=a._first&&b(a._first,this)||a._last&&b(a._last,this);return a.detach(),!c},surroundContents:function(a){if(s(a,cb),!this.canSurroundContents())throw new o("BAD_BOUNDARYPOINTS_ERR");var b=this.extractContents();if(a.hasChildNodes())for(;a.lastChild;)a.removeChild(a.lastChild);f(a,this.startContainer,this.startOffset),a.appendChild(b),this.selectNode(a)},cloneRange:function(){A(this);for(var a,b=new K(c(this)),d=kb.length;d--;)a=kb[d],b[a]=this[a];return b},toString:function(){A(this);var a=this.startContainer;if(a===this.endContainer&&P(a))return 3==a.nodeType||4==a.nodeType?a.data.slice(this.startOffset,this.endOffset):"";var b=[],c=new n(this,!0);return i(c,function(a){(3==a.nodeType||4==a.nodeType)&&b.push(a.data)}),c.detach(),b.join("")},compareNode:function(a){A(this);var b=a.parentNode,c=Q(a);if(!b)throw new O("NOT_FOUND_ERR");var d=this.comparePoint(b,c),e=this.comparePoint(b,c+1);return 0>d?e>0?rb:pb:e>0?qb:sb},comparePoint:function(a,b){return A(this),w(a,"HIERARCHY_REQUEST_ERR"),u(a,this.startContainer),T(a,b,this.startContainer,this.startOffset)<0?-1:T(a,b,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:jb,toHtml:function(){A(this);var a=this.commonAncestorContainer.parentNode.cloneNode(!1);return a.appendChild(this.cloneContents()),a.innerHTML},intersectsNode:function(a,b){if(A(this),w(a,"NOT_FOUND_ERR"),S(a)!==c(this))return!1;var d=a.parentNode,e=Q(a);w(d,"NOT_FOUND_ERR");var f=T(d,e,this.endContainer,this.endOffset),g=T(d,e+1,this.startContainer,this.startOffset);return b?0>=f&&g>=0:0>f&&g>0},isPointInRange:function(a,b){return A(this),w(a,"HIERARCHY_REQUEST_ERR"),u(a,this.startContainer),T(a,b,this.startContainer,this.startOffset)>=0&&T(a,b,this.endContainer,this.endOffset)<=0},intersectsRange:function(a){return g(this,a,!1)},intersectsOrTouchesRange:function(a){return g(this,a,!0)},intersection:function(a){if(this.intersectsRange(a)){var b=T(this.startContainer,this.startOffset,a.startContainer,a.startOffset),c=T(this.endContainer,this.endOffset,a.endContainer,a.endOffset),d=this.cloneRange();return-1==b&&d.setStart(a.startContainer,a.startOffset),1==c&&d.setEnd(a.endContainer,a.endOffset),d}return null},union:function(a){if(this.intersectsOrTouchesRange(a)){var b=this.cloneRange();return-1==T(a.startContainer,a.startOffset,this.startContainer,this.startOffset)&&b.setStart(a.startContainer,a.startOffset),1==T(a.endContainer,a.endOffset,this.endContainer,this.endOffset)&&b.setEnd(a.endContainer,a.endOffset),b}throw new o("Ranges do not intersect")},containsNode:function(a,b){return b?this.intersectsNode(a,!1):this.compareNode(a)==sb},containsNodeContents:function(a){return this.comparePoint(a,0)>=0&&this.comparePoint(a,W(a))<=0},containsRange:function(a){var b=this.intersection(a);return null!==b&&a.equals(b)},containsNodeText:function(a){var b=this.cloneRange();b.selectNode(a);var c=b.getNodes([3]);if(c.length>0){b.setStart(c[0],0);var d=c.pop();b.setEnd(d,d.length);var e=this.containsRange(b);return b.detach(),e}return this.containsNodeContents(a)},getNodes:function(a,b){return A(this),l(this,a,b)},getDocument:function(){return c(this)},collapseBefore:function(a){r(this),this.setEndBefore(a),this.collapse(!1)},collapseAfter:function(a){r(this),this.setStartAfter(a),this.collapse(!0)},getBookmark:function(b){var d=c(this),e=a.createRange(d);b=b||L.getBody(d),e.selectNodeContents(b);var f=this.intersection(e),g=0,h=0;return f&&(e.setEnd(f.startContainer,f.startOffset),g=e.toString().length,h=g+f.toString().length,e.detach()),{start:g,end:h,containerNode:b}},moveToBookmark:function(a){var b=a.containerNode,c=0;this.setStart(b,0),this.collapse(!0);for(var d,e,f,g,h=[b],i=!1,j=!1;!j&&(d=h.pop());)if(3==d.nodeType)e=c+d.length,!i&&a.start>=c&&a.start<=e&&(this.setStart(d,a.start-c),i=!0),i&&a.end>=c&&a.end<=e&&(this.setEnd(d,a.end-c),j=!0),c=e;else for(g=d.childNodes,f=g.length;f--;)h.push(g[f])},getName:function(){return"DomRange"},equals:function(a){return K.rangesEqual(this,a)},isValid:function(){return z(this)},inspect:function(){return m(this)}},G(K,I,J),a.rangePrototype=C.prototype,M.extend(K,{rangeProperties:kb,RangeIterator:n,copyComparisonConstants:E,createPrototypeRange:G,inspect:m,getRangeDocument:c,rangesEqual:function(a,b){return a.startContainer===b.startContainer&&a.startOffset===b.startOffset&&a.endContainer===b.endContainer&&a.endOffset===b.endOffset}}),a.DomRange=K,a.RangeException=o}),rangy.createModule("WrappedRange",function(a,b){a.requireModules(["DomUtil","DomRange"]);var c,d,e=a.dom,f=a.util,g=e.DomPosition,h=a.DomRange,i=e.getBody,j=e.getContentDocument,k=e.isCharacterDataNode;if(a.features.implementsDomRange&&!function(){function d(a){for(var b,c=n.length;c--;)b=n[c],a[b]=a.nativeRange[b];a.collapsed=a.startContainer===a.endContainer&&a.startOffset===a.endOffset}function g(a,b,c,d,e){var f=a.startContainer!==b||a.startOffset!=c,g=a.endContainer!==d||a.endOffset!=e,h=!a.equals(a.nativeRange);(f||g||h)&&(a.setEnd(d,e),a.setStart(b,c))}function k(a){a.nativeRange.detach(),a.detached=!0;for(var b=n.length;b--;)a[n[b]]=null}var l,m,n=h.rangeProperties;c=function(a){if(!a)throw b.createError("WrappedRange: Range must be specified");this.nativeRange=a,d(this)},h.createPrototypeRange(c,g,k),l=c.prototype,l.selectNode=function(a){this.nativeRange.selectNode(a),d(this)},l.cloneContents=function(){return this.nativeRange.cloneContents()},l.surroundContents=function(a){this.nativeRange.surroundContents(a),d(this)},l.collapse=function(a){this.nativeRange.collapse(a),d(this)},l.cloneRange=function(){return new c(this.nativeRange.cloneRange())},l.refresh=function(){d(this)},l.toString=function(){return this.nativeRange.toString()};var o=document.createTextNode("test");i(document).appendChild(o);var p=document.createRange();p.setStart(o,0),p.setEnd(o,0);try{p.setStart(o,1),l.setStart=function(a,b){this.nativeRange.setStart(a,b),d(this)},l.setEnd=function(a,b){this.nativeRange.setEnd(a,b),d(this)},m=function(a){return function(b){this.nativeRange[a](b),d(this)}}}catch(q){l.setStart=function(a,b){try{this.nativeRange.setStart(a,b)}catch(c){this.nativeRange.setEnd(a,b),this.nativeRange.setStart(a,b)}d(this)},l.setEnd=function(a,b){try{this.nativeRange.setEnd(a,b)}catch(c){this.nativeRange.setStart(a,b),this.nativeRange.setEnd(a,b)}d(this)},m=function(a,b){return function(c){try{this.nativeRange[a](c)}catch(e){this.nativeRange[b](c),this.nativeRange[a](c)}d(this)}}}l.setStartBefore=m("setStartBefore","setEndBefore"),l.setStartAfter=m("setStartAfter","setEndAfter"),l.setEndBefore=m("setEndBefore","setStartBefore"),l.setEndAfter=m("setEndAfter","setStartAfter"),p.selectNodeContents(o),l.selectNodeContents=p.startContainer==o&&p.endContainer==o&&0==p.startOffset&&p.endOffset==o.length?function(a){this.nativeRange.selectNodeContents(a),d(this)}:function(a){this.setStartAndEnd(a,0,e.getNodeLength(a))},p.selectNodeContents(o),p.setEnd(o,3);var r=document.createRange();r.selectNodeContents(o),r.setEnd(o,4),r.setStart(o,2),l.compareBoundaryPoints=-1==p.compareBoundaryPoints(p.START_TO_END,r)&&1==p.compareBoundaryPoints(p.END_TO_START,r)?function(a,b){return b=b.nativeRange||b,a==b.START_TO_END?a=b.END_TO_START:a==b.END_TO_START&&(a=b.START_TO_END),this.nativeRange.compareBoundaryPoints(a,b)}:function(a,b){return this.nativeRange.compareBoundaryPoints(a,b.nativeRange||b)};var s=document.createElement("div");s.innerHTML="123";var t=s.firstChild,u=i(document);u.appendChild(s),p.setStart(t,1),p.setEnd(t,2),p.deleteContents(),"13"==t.data&&(l.deleteContents=function(){this.nativeRange.deleteContents(),d(this)},l.extractContents=function(){var a=this.nativeRange.extractContents();return d(this),a}),u.removeChild(s),u=null,f.isHostMethod(p,"createContextualFragment")&&(l.createContextualFragment=function(a){return this.nativeRange.createContextualFragment(a)}),i(document).removeChild(o),p.detach(),r.detach(),l.getName=function(){return"WrappedRange"},a.WrappedRange=c,a.createNativeRange=function(a){return a=j(a,b,"createNativeRange"),a.createRange()}}(),a.features.implementsTextRange){var l=function(a){var b=a.parentElement(),c=a.duplicate();c.collapse(!0);var d=c.parentElement();c=a.duplicate(),c.collapse(!1);var f=c.parentElement(),g=d==f?d:e.getCommonAncestor(d,f);return g==b?g:e.getCommonAncestor(b,g)},m=function(a){return 0==a.compareEndPoints("StartToEnd",a)},n=function(a,b,c,d,f){var h=a.duplicate();h.collapse(c);var i=h.parentElement();if(e.isOrIsAncestorOf(b,i)||(i=b),!i.canHaveHTML){var j=new g(i.parentNode,e.getNodeIndex(i));return{boundaryPosition:j,nodeInfo:{nodeIndex:j.offset,containerElement:j.node}}}var l=e.getDocument(i).createElement("span");l.parentNode&&l.parentNode.removeChild(l);for(var m,n,o,p,q,r=c?"StartToStart":"StartToEnd",s=f&&f.containerElement==i?f.nodeIndex:0,t=i.childNodes.length,u=t,v=u;;){if(v==t?i.appendChild(l):i.insertBefore(l,i.childNodes[v]),h.moveToElementText(l),m=h.compareEndPoints(r,a),0==m||s==u)break;if(-1==m){if(u==s+1)break;s=v}else u=u==s+1?s:v;v=Math.floor((s+u)/2),i.removeChild(l)}if(q=l.nextSibling,-1==m&&q&&k(q)){h.setEndPoint(c?"EndToStart":"EndToEnd",a);var w;if(/[\r\n]/.test(q.data)){var x=h.duplicate(),y=x.text.replace(/\r\n/g,"\r").length;for(w=x.moveStart("character",y);-1==(m=x.compareEndPoints("StartToEnd",x));)w++,x.moveStart("character",1)}else w=h.text.length;p=new g(q,w)}else n=(d||!c)&&l.previousSibling,o=(d||c)&&l.nextSibling,p=o&&k(o)?new g(o,0):n&&k(n)?new g(n,n.data.length):new g(i,e.getNodeIndex(l));return l.parentNode.removeChild(l),{boundaryPosition:p,nodeInfo:{nodeIndex:v,containerElement:i}}},o=function(a,b){var c,d,f,g,h=a.offset,j=e.getDocument(a.node),l=i(j).createTextRange(),m=k(a.node);return m?(c=a.node,d=c.parentNode):(g=a.node.childNodes,c=h<g.length?g[h]:null,d=a.node),f=j.createElement("span"),f.innerHTML="&#feff;",c?d.insertBefore(f,c):d.appendChild(f),l.moveToElementText(f),l.collapse(!b),d.removeChild(f),m&&l[b?"moveStart":"moveEnd"]("character",h),l};if(d=function(a){this.textRange=a,this.refresh()},d.prototype=new h(document),d.prototype.refresh=function(){var a,b,c,d=l(this.textRange);m(this.textRange)?b=a=n(this.textRange,d,!0,!0).boundaryPosition:(c=n(this.textRange,d,!0,!1),a=c.boundaryPosition,b=n(this.textRange,d,!1,!1,c.nodeInfo).boundaryPosition),this.setStart(a.node,a.offset),this.setEnd(b.node,b.offset)},d.prototype.getName=function(){return"WrappedTextRange"},h.copyComparisonConstants(d),d.rangeToTextRange=function(a){if(a.collapsed)return o(new g(a.startContainer,a.startOffset),!0);var b=o(new g(a.startContainer,a.startOffset),!0),c=o(new g(a.endContainer,a.endOffset),!1),d=i(h.getRangeDocument(a)).createTextRange();return d.setEndPoint("StartToStart",b),d.setEndPoint("EndToEnd",c),d},a.WrappedTextRange=d,!a.features.implementsDomRange||a.config.preferTextRange){var p=function(){return this}();"undefined"==typeof p.Range&&(p.Range=d),a.createNativeRange=function(a){return a=j(a,b,"createNativeRange"),i(a).createTextRange()},a.WrappedRange=d}}a.createRange=function(c){return c=j(c,b,"createRange"),new a.WrappedRange(a.createNativeRange(c))},a.createRangyRange=function(a){return a=j(a,b,"createRangyRange"),new h(a)},a.createIframeRange=function(c){return b.deprecationNotice("createIframeRange()","createRange(iframeEl)"),a.createRange(c)},a.createIframeRangyRange=function(c){return b.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)"),a.createRangyRange(c)},a.addCreateMissingNativeApiListener(function(b){var c=b.document;"undefined"==typeof c.createRange&&(c.createRange=function(){return a.createRange(c)}),c=b=null})}),rangy.createModule("WrappedSelection",function(a,b){function c(a){return"string"==typeof a?"backward"==a:!!a}function d(a,c){if(a){if(A.isWindow(a))return a;if(a instanceof q)return a.win;var d=A.getContentDocument(a,b,c);return A.getWindow(d)}return window}function e(a){return d(a,"getWinSelection").getSelection()}function f(a){return d(a,"getDocSelection").document.selection}function g(a,b,c){var d=c?"end":"start",e=c?"start":"end";a.anchorNode=b[d+"Container"],a.anchorOffset=b[d+"Offset"],a.focusNode=b[e+"Container"],a.focusOffset=b[e+"Offset"]}function h(a){var b=a.nativeSelection;a.anchorNode=b.anchorNode,a.anchorOffset=b.anchorOffset,a.focusNode=b.focusNode,a.focusOffset=b.focusOffset}function i(a){a.anchorNode=a.focusNode=null,a.anchorOffset=a.focusOffset=0,a.rangeCount=0,a.isCollapsed=!0,a._ranges.length=0}function j(b){var c;return b instanceof D?(c=a.createNativeRange(b.getDocument()),c.setEnd(b.endContainer,b.endOffset),c.setStart(b.startContainer,b.startOffset)):b instanceof E?c=b.nativeRange:H.implementsDomRange&&b instanceof A.getWindow(b.startContainer).Range&&(c=b),c}function k(a){if(!a.length||1!=a[0].nodeType)return!1;for(var b=1,c=a.length;c>b;++b)if(!A.isAncestorOf(a[0],a[b]))return!1;return!0}function l(a){var c=a.getNodes();if(!k(c))throw b.createError("getSingleElementFromRange: range "+a.inspect()+" did not consist of a single element");return c[0]}function m(a){return!!a&&"undefined"!=typeof a.text}function n(a,b){var c=new E(b);a._ranges=[c],g(a,c,!1),a.rangeCount=1,a.isCollapsed=c.collapsed}function o(b){if(b._ranges.length=0,"None"==b.docSelection.type)i(b);else{var c=b.docSelection.createRange();if(m(c))n(b,c);else{b.rangeCount=c.length;for(var d,e=J(c.item(0)),f=0;f<b.rangeCount;++f)d=a.createRange(e),d.selectNode(c.item(f)),b._ranges.push(d);b.isCollapsed=1==b.rangeCount&&b._ranges[0].collapsed,g(b,b._ranges[b.rangeCount-1],!1)}}}function p(a,c){for(var d=a.docSelection.createRange(),e=l(c),f=J(d.item(0)),g=K(f).createControlRange(),h=0,i=d.length;i>h;++h)g.add(d.item(h));try{g.add(e)}catch(j){throw b.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}g.select(),o(a)}function q(a,b,c){this.nativeSelection=a,this.docSelection=b,this._ranges=[],this.win=c,this.refresh()}function r(a){a.win=a.anchorNode=a.focusNode=a._ranges=null,a.rangeCount=a.anchorOffset=a.focusOffset=0,a.detached=!0}function s(a,b){for(var c,d,e=$.length;e--;)if(c=$[e],d=c.selection,"deleteAll"==b)r(d);else if(c.win==a)return"delete"==b?($.splice(e,1),!0):d;return"deleteAll"==b&&($.length=0),null}function t(a,c){for(var d,e=J(c[0].startContainer),f=K(e).createControlRange(),g=0;rangeCount>g;++g){d=l(c[g]);try{f.add(d)}catch(h){throw b.createError("setRanges(): Element within the one of the specified Ranges could not be added to control selection (does it have layout?)")}}f.select(),o(a)}function u(a,b){if(a.win.document!=J(b))throw new F("WRONG_DOCUMENT_ERR")}function v(b){return function(c,d){var e;this.rangeCount?(e=this.getRangeAt(0),e["set"+(b?"Start":"End")](c,d)):(e=a.createRange(this.win.document),e.setStartAndEnd(c,d)),this.setSingleRange(e,this.isBackward())}}function w(a){var b=[],c=new G(a.anchorNode,a.anchorOffset),d=new G(a.focusNode,a.focusOffset),e="function"==typeof a.getName?a.getName():"Selection";if("undefined"!=typeof a.rangeCount)for(var f=0,g=a.rangeCount;g>f;++f)b[f]=D.inspect(a.getRangeAt(f));return"["+e+"(Ranges: "+b.join(", ")+")(anchor: "+c.inspect()+", focus: "+d.inspect()+"]"}a.requireModules(["DomUtil","DomRange","WrappedRange"]),a.config.checkSelectionRanges=!0;var x,y,z="boolean",A=a.dom,B=a.util,C=B.isHostMethod,D=a.DomRange,E=a.WrappedRange,F=a.DOMException,G=A.DomPosition,H=a.features,I="Control",J=A.getDocument,K=A.getBody,L=D.rangesEqual,M=C(window,"getSelection"),N=B.isHostObject(document,"selection");H.implementsWinGetSelection=M,H.implementsDocSelection=N;var O=N&&(!M||a.config.preferTextRange);O?(x=f,a.isSelectionValid=function(a){var b=d(a,"isSelectionValid").document,c=b.selection;return"None"!=c.type||J(c.createRange().parentElement())==b}):M?(x=e,a.isSelectionValid=function(){return!0}):b.fail("Neither document.selection or window.getSelection() detected."),a.getNativeSelection=x;var P=x(),Q=a.createNativeRange(document),R=K(document),S=B.areHostProperties(P,["anchorNode","focusNode","anchorOffset","focusOffset"]);H.selectionHasAnchorAndFocus=S;var T=C(P,"extend");H.selectionHasExtend=T;var U="number"==typeof P.rangeCount;H.selectionHasRangeCount=U;var V=!1,W=!0;B.areHostMethods(P,["addRange","getRangeAt","removeAllRanges"])&&"number"==typeof P.rangeCount&&H.implementsDomRange&&!function(){var a=window.getSelection();if(a){var b=K(document),c=b.appendChild(document.createElement("div"));c.contentEditable="false";var d=c.appendChild(document.createTextNode("   ")),e=document.createRange();e.setStart(d,1),e.collapse(!0),a.addRange(e),W=1==a.rangeCount,a.removeAllRanges();var f=e.cloneRange();e.setStart(d,0),f.setEnd(d,3),f.setStart(d,2),a.addRange(e),a.addRange(f),V=2==a.rangeCount,b.removeChild(c),a.removeAllRanges(),e.detach(),f.detach()}}(),H.selectionSupportsMultipleRanges=V,H.collapsedNonEditableSelectionsSupported=W;var X,Y=!1;R&&C(R,"createControlRange")&&(X=R.createControlRange(),B.areHostProperties(X,["item","add"])&&(Y=!0)),H.implementsControlRange=Y,y=S?function(a){return a.anchorNode===a.focusNode&&a.anchorOffset===a.focusOffset}:function(a){return a.rangeCount?a.getRangeAt(a.rangeCount-1).collapsed:!1};var Z;C(P,"getRangeAt")?Z=function(a,b){try{return a.getRangeAt(b)}catch(c){return null}}:S&&(Z=function(b){var c=J(b.anchorNode),d=a.createRange(c);return d.setStartAndEnd(b.anchorNode,b.anchorOffset,b.focusNode,b.focusOffset),d.collapsed!==this.isCollapsed&&d.setStartAndEnd(b.focusNode,b.focusOffset,b.anchorNode,b.anchorOffset),d});var $=[],_=function(a){if(a&&a instanceof q)return a.refresh(),a;a=d(a,"getNativeSelection");var b=s(a),c=x(a),e=N?f(a):null;return b?(b.nativeSelection=c,b.docSelection=e,b.refresh()):(b=new q(c,e,a),$.push({win:a,selection:b})),b};a.getSelection=_,a.getIframeSelection=function(c){return b.deprecationNotice("getIframeSelection()","getSelection(iframeEl)"),a.getSelection(A.getIframeWindow(c))};var ab=q.prototype;if(!O&&S&&B.areHostMethods(P,["removeAllRanges","addRange"])){ab.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),i(this)};var bb=function(b,c){var d=D.getRangeDocument(c),e=a.createRange(d);e.collapseToPoint(c.endContainer,c.endOffset),b.nativeSelection.addRange(j(e)),b.nativeSelection.extend(c.startContainer,c.startOffset),b.refresh()};ab.addRange=U?function(b,d){if(Y&&N&&this.docSelection.type==I)p(this,b);else if(c(d)&&T)bb(this,b);else{var e;if(V?e=this.rangeCount:(this.removeAllRanges(),e=0),this.nativeSelection.addRange(j(b).cloneRange()),this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==e+1){if(a.config.checkSelectionRanges){var f=Z(this.nativeSelection,this.rangeCount-1);f&&!L(f,b)&&(b=new E(f))}this._ranges[this.rangeCount-1]=b,g(this,b,eb(this.nativeSelection)),this.isCollapsed=y(this)}else this.refresh()}}:function(a,b){c(b)&&T?bb(this,a):(this.nativeSelection.addRange(j(a)),this.refresh())},ab.setRanges=function(a){if(Y&&a.length>1)t(this,a);else{this.removeAllRanges();for(var b=0,c=a.length;c>b;++b)this.addRange(a[b])}}}else{if(!(C(P,"empty")&&C(Q,"select")&&Y&&O))return b.fail("No means of selecting a Range or TextRange was found"),!1;ab.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var a;if(this.anchorNode)a=J(this.anchorNode);else if(this.docSelection.type==I){var b=this.docSelection.createRange();b.length&&(a=J(b.item(0)))}if(a){var c=K(a).createTextRange();c.select(),this.docSelection.empty()}}}catch(d){}i(this)},ab.addRange=function(b){this.docSelection.type==I?p(this,b):(a.WrappedTextRange.rangeToTextRange(b).select(),this._ranges[0]=b,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,g(this,b,!1))},ab.setRanges=function(a){this.removeAllRanges();var b=a.length;b>1?t(this,a):b&&this.addRange(a[0])}}ab.getRangeAt=function(a){if(0>a||a>=this.rangeCount)throw new F("INDEX_SIZE_ERR");return this._ranges[a].cloneRange()};var cb;if(O)cb=function(b){var c;a.isSelectionValid(b.win)?c=b.docSelection.createRange():(c=K(b.win.document).createTextRange(),c.collapse(!0)),b.docSelection.type==I?o(b):m(c)?n(b,c):i(b)};else if(C(P,"getRangeAt")&&"number"==typeof P.rangeCount)cb=function(b){if(Y&&N&&b.docSelection.type==I)o(b);else if(b._ranges.length=b.rangeCount=b.nativeSelection.rangeCount,b.rangeCount){for(var c=0,d=b.rangeCount;d>c;++c)b._ranges[c]=new a.WrappedRange(b.nativeSelection.getRangeAt(c));g(b,b._ranges[b.rangeCount-1],eb(b.nativeSelection)),b.isCollapsed=y(b)}else i(b)};else{if(!S||typeof P.isCollapsed!=z||typeof Q.collapsed!=z||!H.implementsDomRange)return b.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;cb=function(a){var b,c=a.nativeSelection;c.anchorNode?(b=Z(c,0),a._ranges=[b],a.rangeCount=1,h(a),a.isCollapsed=y(a)):i(a)}}ab.refresh=function(a){var b=a?this._ranges.slice(0):null,c=this.anchorNode,d=this.anchorOffset;if(cb(this),a){var e=b.length;if(e!=this._ranges.length)return!0;if(this.anchorNode!=c||this.anchorOffset!=d)return!0;for(;e--;)if(!L(b[e],this._ranges[e]))return!0;return!1}};var db=function(b,c){var d=b.getAllRanges();b.removeAllRanges();for(var e=0,f=d.length;f>e;++e)a.rangesEqual(c,d[e])||b.addRange(d[e]);b.rangeCount||i(b)};ab.removeRange=Y?function(a){if(this.docSelection.type==I){for(var b,c=this.docSelection.createRange(),d=l(a),e=J(c.item(0)),f=K(e).createControlRange(),g=!1,h=0,i=c.length;i>h;++h)b=c.item(h),b!==d||g?f.add(c.item(h)):g=!0;f.select(),o(this)}else db(this,a)}:function(a){db(this,a)};var eb;!O&&S&&H.implementsDomRange?(eb=function(a){var b=!1;return a.anchorNode&&(b=1==A.comparePoints(a.anchorNode,a.anchorOffset,a.focusNode,a.focusOffset)),b},ab.isBackward=function(){return eb(this)}):eb=ab.isBackward=function(){return!1},ab.isBackwards=ab.isBackward,ab.toString=function(){for(var a=[],b=0,c=this.rangeCount;c>b;++b)a[b]=""+this._ranges[b];return a.join("")},ab.collapse=function(b,c){u(this,b);var d=a.createRange(b);d.collapseToPoint(b,c),this.setSingleRange(d),this.isCollapsed=!0},ab.collapseToStart=function(){if(!this.rangeCount)throw new F("INVALID_STATE_ERR");var a=this._ranges[0];this.collapse(a.startContainer,a.startOffset)},ab.collapseToEnd=function(){if(!this.rangeCount)throw new F("INVALID_STATE_ERR");var a=this._ranges[this.rangeCount-1];this.collapse(a.endContainer,a.endOffset)},ab.selectAllChildren=function(b){u(this,b);var c=a.createRange(b);c.selectNodeContents(b),this.removeAllRanges(),this.addRange(c)},ab.deleteFromDocument=function(){if(Y&&N&&this.docSelection.type==I){for(var a,b=this.docSelection.createRange();b.length;)a=b.item(0),b.remove(a),a.parentNode.removeChild(a);this.refresh()}else if(this.rangeCount){var c=this.getAllRanges();if(c.length){this.removeAllRanges();for(var d=0,e=c.length;e>d;++d)c[d].deleteContents();this.addRange(c[e-1])}}},ab.eachRange=function(a,b){for(var c=0,d=this._ranges.length;d>c;++c)if(a(this.getRangeAt(c)))return b},ab.getAllRanges=function(){var a=[];return this.eachRange(function(b){a.push(b)}),a},ab.setSingleRange=function(a,b){this.removeAllRanges(),this.addRange(a,b)},ab.callMethodOnEachRange=function(a,b){var c=[];return this.eachRange(function(d){c.push(d[a].apply(d,b))
}),c},ab.setStart=v(!0),ab.setEnd=v(!1),a.rangePrototype.select=function(a){_(this.getDocument()).setSingleRange(this,a)},ab.changeEachRange=function(a){var b=[],c=this.isBackward();this.eachRange(function(c){a(c),b.push(c)}),this.removeAllRanges(),c&&1==b.length?this.addRange(b[0],"backward"):this.setRanges(b)},ab.containsNode=function(a,b){return this.eachRange(function(c){return c.containsNode(a,b)},!0)},ab.getBookmark=function(a){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[a])}},ab.moveToBookmark=function(b){for(var c,d,e=[],f=0;c=b.rangeBookmarks[f++];)d=a.createRange(this.win),d.moveToBookmark(c),e.push(d);b.backward?this.setSingleRange(e[0],"backward"):this.setRanges(e)},ab.toHtml=function(){return this.callMethodOnEachRange("toHtml").join("")},ab.getName=function(){return"WrappedSelection"},ab.inspect=function(){return w(this)},ab.detach=function(){s(this.win,"delete"),r(this)},q.detachAll=function(){s(null,"deleteAll")},q.inspect=w,q.isDirectionBackward=c,a.Selection=q,a.selectionPrototype=ab,a.addCreateMissingNativeApiListener(function(a){"undefined"==typeof a.getSelection&&(a.getSelection=function(){return _(a)}),a=null})}),rangy.createModule("Position",function(a,b){function c(a){var b=0,c=0;if(typeof a.pageXOffset==v&&typeof a.pageYOffset==v)b=a.pageXOffset,c=a.pageYOffset;else{var d=a.document,e=d.documentElement,f=d.compatMode,g="string"==typeof f&&f.indexOf("CSS")>=0&&e?e:z.getBody(d);if(g&&typeof g.scrollLeft==v&&typeof g.scrollTop==v)try{b=g.scrollLeft,c=g.scrollTop}catch(h){}}return{x:b,y:c}}function d(a,b){for(b=b.toLowerCase();a;){if(1==a.nodeType&&a.tagName.toLowerCase()==b)return a;a=a.parentNode}return null}function e(a,b,c,d){this.top=a,this.right=b,this.bottom=c,this.left=d,this.width=b-d,this.height=c-a}function f(a,b,c){return new e(a.top+c,a.right+b,a.bottom+c,a.left+b)}function g(a,b){var c=0,d=0,e=b.documentElement,g=z.getBody(b),h=0===e.clientWidth&&typeof g.clientTop==v?g:e,i=h.clientLeft,j=h.clientTop;return i&&(c=-i),j&&(d=-j),f(a,c,d)}function h(a){for(var b,c=[],d=[],f=[],g=[],h=0,i=a.length;i>h;++h)b=a[h],b&&(c.push(b.top),d.push(b.bottom),f.push(b.left),g.push(b.right));return new e(Math.min.apply(Math,c),Math.max.apply(Math,g),Math.max.apply(Math,d),Math.min.apply(Math,f))}function i(b,c,d){var e=z.getBody(b).createTextRange();e.moveToPoint(c,d);var f=new a.WrappedTextRange(e);return new B(f.startContainer,f.startOffset)}function j(a,b,c){var d=a.caretPositionFromPoint(b,c);return new B(d.offsetNode,d.offset)}function k(a,b,c){var d=a.caretRangeFromPoint(b,c);return new B(d.startContainer,d.startOffset)}function l(a){var b=(a.nativeRange||a).getClientRects();return b.length>0?b[b.length-1]:null}function m(a,b,c){return console.log("pointIsInOrAboveRect",a,b,Math.floor(c.top),Math.floor(c.right),Math.floor(c.bottom),Math.floor(c.left)),b<c.bottom&&a>=c.left&&a<=c.right}function n(b,c,d,e){var f=b.elementFromPoint(c,d);console.log("elementFromPoint is ",f);var g=a.createRange(b);g.selectNodeContents(f),g.collapse(!0);var h,i,j,k=f.firstChild;if(k){a:for(;k;){if(console.log(k),3==k.nodeType){for(h=0,j=k.length;j>=h;++h)if(g.setEnd(k,h),i=l(g),i&&m(c,d,i)){i.right-c>c-i.left&&--h;break a}}else if(g.setEndAfter(k),i=l(g),i&&m(c,d,i)){h=z.getNodeIndex(k),k=f.parentNode,e||++h;break}k=k.nextSibling}k||(k=f,h=f.childNodes.length)}else k=f.parentNode,h=z.getNodeIndex(f),e||++h;return new B(k,h)}function o(c){if(a.features.implementsTextRange)return i;if(typeof c.caretPositionFromPoint!=w)return j;if(typeof c.caretRangeFromPoint!=w)return k;if(typeof c.elementFromPoint!=w&&E)return n;throw b.createError("createCaretPositionFromPointGetter(): Browser does not provide a recognised method to create a selection from pixel coordinates")}function p(c,d,e,f,g){g=z.getContentDocument(g,b,"createRangeFromPoints");var h=o(g),i=h(g,c,d,!1),j=h(g,e,f,!0);console.log(i.node,i.offset,j.node,j.offset);var k=a.createRange(g);return k.setStartAndEnd(i.node,i.offset,j.node,j.offset),k}function q(a,b,c,d,e){var f,g,h,i,j=b>d||b==d&&a>c;j?(f=c,g=d,h=a,i=b):(f=a,g=b,h=c,i=d);var k=rangy.getSelection(e),l=p(f,g,h,i,e);return k.setSingleRange(l),k}function r(a){return function(){var b=this["get"+(a?"Start":"End")+"ClientPos"](),d=c(z.getWindow(this.startContainer));return{x:b.x+d.x,y:b.y+d.y}}}function s(a,b){return a.compareBoundaryPoints(b.START_TO_START,b)}function t(a){return function(){for(var b="getBounding"+(a?"Document":"Client")+"Rect",c=[],d=0;d<this.rangeCount;++d)c.push(this.getRangeAt(d)[b]());return h(c)}}function u(a,b){return function(){if(0==this.rangeCount)return null;var c=b?"Document":"Client",d=this.getAllRanges();return d.length>1&&d.sort(s),a?d[0]["getStart"+c+"Pos"]():d[d.length-1]["getEnd"+c+"Pos"]()}}a.requireModules(["WrappedSelection","WrappedRange"]);var v="number",w="undefined",x=a.WrappedRange,y=a.WrappedTextRange,z=a.dom,A=a.util,B=z.DomPosition,C=document.createElement("span"),D=A.isHostMethod(C,"getBoundingClientRect");C=null;var E=!1,F=!1;if(a.features.implementsDomRange){var G=a.createNativeRange();E=A.isHostMethod(G,"getClientRects"),F=A.isHostMethod(G,"getBoundingClientRect"),G.detach()}A.extend(a.features,{rangeSupportsGetBoundingClientRect:F,rangeSupportsGetClientRects:E,elementSupportsGetBoundingClientRect:D});var H=function(a){return function(){var b=this.cloneRange();b.collapse(a);var c=b.getBoundingClientRect();return{x:c[a?"left":"right"],y:c[a?"top":"bottom"]}}},I=a.rangePrototype;if(a.features.implementsTextRange&&D)I.getBoundingClientRect=function(){var a,b=y.rangeToTextRange(this),c=this.getNodes([1],function(a){return/^t[dh]$/i.test(a.tagName)}),e=[];if(c.length>0){for(var f,i,j,k,l=d(this.startContainer,"table"),m=0;f=c[m];++m)j=d(f,"table"),l&&j==l||(k=this.cloneRange(),l&&k.setStartAfter(l),k.setEndBefore(j),e.push(y.rangeToTextRange(k).getBoundingClientRect())),this.containsNode(f)?e.push(f.getBoundingClientRect()):(i=b.duplicate(),i.moveToElementText(f),-1==i.compareEndPoints("StartToStart",b)?i.setEndPoint("StartToStart",b):1==i.compareEndPoints("EndToEnd",b)&&i.setEndPoint("EndToEnd",b),e.push(i.getBoundingClientRect())),l=j;var n=d(this.endContainer,"table");!n&&l&&(k=this.cloneRange(),k.setStartAfter(l),e.push(y.rangeToTextRange(k).getBoundingClientRect())),a=h(e)}else a=b.getBoundingClientRect();return g(a,z.getDocument(this.startContainer))};else if(a.features.implementsDomRange){var J=function(a){return a instanceof x?a:new x(a)};if(F){if(I.getBoundingClientRect=function(){var a=J(this).nativeRange,b=a.getBoundingClientRect()||a.getClientRects()[0];return g(b,z.getDocument(this.startContainer))},E){H=function(a){return function(){var c,d=J(this).nativeRange,e=d.getClientRects();if(0==e.length&&D&&(console.log(d,d.getClientRects(),d.getBoundingClientRect()),this.collapsed&&1==this.startContainer.nodeType&&this.startOffset<this.startContainer.childNodes.length)){var f=this.startContainer.childNodes[this.startOffset];f.getClientRects&&console.log(f,f.getClientRects(),this.startContainer.getClientRects())}if(e.length>0)return a?(c=e[0],{x:c.left,y:c.top}):(c=e[e.length-1],{x:c.right,y:c.bottom});throw b.createError("Cannot get position for range "+this.inspect())}}}}else{var K=D?function(a){return g(a.getBoundingClientRect(),z.getDocument(a))}:function(a){for(var b=0,c=0,d=a,f=a.offsetWidth,h=a.offsetHeight;d;)b+=d.offsetLeft,c+=d.offsetTop,d=d.offsetParent;return g(new e(c,b+f,c+h,b),z.getDocument(a))},L=function(a){var b;a.splitBoundaries();var c=document.createElement("span");if(a.collapsed)a.insertNode(c),b=K(c),c.parentNode.removeChild(c);else{var d=a.cloneRange();d.collapse(!0),d.insertNode(c);var e=K(c);c.parentNode.removeChild(c),d.collapseToPoint(a.endContainer,a.endOffset),d.insertNode(c);var f=K(c);c.parentNode.removeChild(c);for(var g=[e,f],i=a.getNodes([1],function(b){return a.containsNode(b)}),j=0,k=i.length;k>j;++j)g.push(K(i[j]));b=h(g)}return a.normalizeBoundaries(),b};I.getBoundingClientRect=function(a){return L(J(a))}}}A.extend(I,{getBoundingDocumentRect:function(){var a=c(z.getWindow(this.startContainer));return f(this.getBoundingClientRect(),a.x,a.y)},getStartClientPos:H(!0),getEndClientPos:H(!1),getStartDocumentPos:r(!0),getEndDocumentPos:r(!1)}),A.extend(a.selectionPrototype,{getBoundingClientRect:t(!1),getBoundingDocumentRect:t(!0),getStartClientPos:u(!0,!1),getEndClientPos:u(!1,!1),getStartDocumentPos:u(!0,!0),getEndDocumentPos:u(!1,!0)}),a.positionFromPoint=function(a,c,d){return d=z.getContentDocument(d,b,"positionFromPoint"),o(d)(d,a,c)},a.createRangeFromPoints=p,a.moveSelectionToPoints=q}),window.rangy=rangy,function(a){"use strict";var b,c,d=Array.prototype.slice;c=function(b){this.options=a.extend({},c.defaults,b),this.parser=this.options.parser,this.locale=this.options.locale,this.messageStore=this.options.messageStore,this.languages={},this.init()},c.prototype={init:function(){var b=this;String.locale=b.locale,String.prototype.toLocaleString=function(){var c,d,e,f,g,h,i;for(e=this.valueOf(),f=b.locale,g=0;f;){c=f.split("-"),d=c.length;do{if(h=c.slice(0,d).join("-"),i=b.messageStore.get(h,e))return i;d--}while(d);if("en"===f)break;f=a.i18n.fallbacks[b.locale]&&a.i18n.fallbacks[b.locale][g]||b.options.fallbackLocale,a.i18n.log("Trying fallback locale for "+b.locale+": "+f),g++}return""}},destroy:function(){a.removeData(document,"i18n")},load:function(a,b){return this.messageStore.load(a,b)},parse:function(b,c){var d=b.toLocaleString();return this.parser.language=a.i18n.languages[a.i18n().locale]||a.i18n.languages["default"],""===d&&(d=b),this.parser.parse(d,c)}},a.i18n=function(b,e){var f,g=a.data(document,"i18n"),h="object"==typeof b&&b;return h&&h.locale&&g&&g.locale!==h.locale&&(String.locale=g.locale=h.locale),g||(g=new c(h),a.data(document,"i18n",g)),"string"==typeof b?(f=void 0!==e?d.call(arguments,1):[],g.parse(b,f)):g},a.fn.i18n=function(){var b=a.data(document,"i18n");return b||(b=new c,a.data(document,"i18n",b)),String.locale=b.locale,this.each(function(){var c=a(this),d=c.data("i18n");d?c.text(b.parse(d)):c.find("[data-i18n]").i18n()})},String.locale=String.locale||a("html").attr("lang"),String.locale||(void 0!==typeof window.navigator?(b=window.navigator,String.locale=b.language||b.userLanguage||""):String.locale=""),a.i18n.languages={},a.i18n.messageStore=a.i18n.messageStore||{},a.i18n.parser={parse:function(a,b){return a.replace(/\$(\d+)/g,function(a,c){var d=parseInt(c,10)-1;return void 0!==b[d]?b[d]:"$"+c})},emitter:{}},a.i18n.fallbacks={},a.i18n.debug=!1,a.i18n.log=function(){window.console&&a.i18n.debug&&window.console.log.apply(window.console,arguments)},c.defaults={locale:String.locale,fallbackLocale:"en",parser:a.i18n.parser,messageStore:a.i18n.messageStore},a.i18n.constructor=c}(jQuery),function(a){"use strict";function b(b){return a.getJSON(b).fail(function(c,d,e){a.i18n.log("Error in loading messages from "+b+" Exception: "+e)})}var c=function(){this.messages={},this.sources={}};c.prototype={load:function(c,d){var e=null,f=null,g=[],h=this;if("string"==typeof c)return a.i18n.log("Loading messages from: "+c),f=b(c).done(function(a){h.set(d,a)}),f.promise();if(d)return h.set(d,c),a.Deferred().resolve();for(e in c)Object.prototype.hasOwnProperty.call(c,e)&&(d=e,g.push(h.load(c[e],d)));return a.when.apply(a,g)},set:function(b,c){this.messages[b]=this.messages[b]?a.extend(this.messages[b],c):c},get:function(a,b){return this.messages[a]&&this.messages[a][b]}},a.extend(a.i18n.messageStore,new c)}(jQuery,window),function(a){"use strict";var b=function(b){this.options=a.extend({},a.i18n.parser.defaults,b),this.language=a.i18n.languages[String.locale]||a.i18n.languages["default"],this.emitter=a.i18n.parser.emitter};b.prototype={constructor:b,simpleParse:function(a,b){return a.replace(/\$(\d+)/g,function(a,c){var d=parseInt(c,10)-1;return void 0!==b[d]?b[d]:"$"+c})},parse:function(b,c){return b.indexOf("{{")<0?this.simpleParse(b,c):(this.emitter.language=a.i18n.languages[a.i18n().locale]||a.i18n.languages["default"],this.emitter.emit(this.ast(b),c))},ast:function(a){function b(a){return function(){var b,c;for(b=0;b<a.length;b++)if(c=a[b](),null!==c)return c;return null}}function c(a){var b,c,d=I,e=[];for(b=0;b<a.length;b++){if(c=a[b](),null===c)return I=d,null;e.push(c)}return e}function d(a,b){return function(){for(var c=I,d=[],e=b();null!==e;)d.push(e),e=b();return d.length<a?(I=c,null):d}}function e(b){var c=b.length;return function(){var d=null;return a.substr(I,c)===b&&(d=b,I+=c),d}}function f(b){return function(){var c=a.substr(I).match(b);return null===c?null:(I+=c[0].length,c[0])}}function g(a,b){return function(){var c=a();return null===c?null:b(c)}}function h(){var a=d(1,z)();return null===a?null:a.join("")}function i(){var a=d(1,A)();return null===a?null:a.join("")}function j(){var a=c([s,t]);return null===a?null:a[1]}function k(){var a=c([u,v]);return null===a?null:["REPLACE",parseInt(a[1],10)-1]}function l(){var a,b=c([q,d(0,G)]);return null===b?null:(a=b[1],a.length>1?["CONCAT"].concat(a):a[0])}function m(){var a=c([C,r,k]);return null===a?null:[a[0],a[2]]}function n(){var a=c([C,r,G]);return null===a?null:[a[0],a[2]]}function o(){var a=c([D,B,E]);return null===a?null:a[1]}function p(){var a=d(0,F)();return null===a?null:["CONCAT"].concat(a)}var q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I=0;if(q=e("|"),r=e(":"),s=e("\\"),t=f(/^./),u=e("$"),v=f(/^\d+/),w=f(/^[^{}\[\]$\\]/),x=f(/^[^{}\[\]$\\|]/),y=f(/^[^{}\[\]$\s]/),b([j,y]),z=b([j,x]),A=b([j,w]),C=g(f(/^[ !"$&'()*,.\/0-9;=?@A-Z\^_`a-z~\x80-\xFF+\-]+/),function(a){return a.toString()}),B=b([function(){var a=c([b([m,n]),d(0,l)]);return null===a?null:a[0].concat(a[1])},function(){var a=c([C,d(0,l)]);return null===a?null:[a[0]].concat(a[1])}]),D=e("{{"),E=e("}}"),F=b([o,k,i]),G=b([o,k,h]),H=p(),null===H||I!==a.length)throw new Error("Parse error at position "+I.toString()+" in input: "+a);return H}},a.extend(a.i18n.parser,new b)}(jQuery),function(a){"use strict";var b=function(){this.language=a.i18n.languages[String.locale]||a.i18n.languages["default"]};b.prototype={constructor:b,emit:function(b,c){var d,e,f,g=this;switch(typeof b){case"string":case"number":d=b;break;case"object":if(e=a.map(b.slice(1),function(a){return g.emit(a,c)}),f=b[0].toLowerCase(),"function"!=typeof g[f])throw new Error('unknown operation "'+f+'"');d=g[f](e,c);break;case"undefined":d="";break;default:throw new Error("unexpected type in AST: "+typeof b)}return d},concat:function(b){var c="";return a.each(b,function(a,b){c+=b}),c},replace:function(a,b){var c=parseInt(a[0],10);return c<b.length?b[c]:"$"+(c+1)},plural:function(a){var b=parseFloat(this.language.convertNumber(a[0],10)),c=a.slice(1);return c.length?this.language.convertPlural(b,c):""},gender:function(a){var b=a[0],c=a.slice(1);return this.language.gender(b,c)},grammar:function(a){var b=a[0],c=a[1];return c&&b&&this.language.convertGrammar(c,b)}},a.extend(a.i18n.parser.emitter,new b)}(jQuery),function(a){"use strict";var b={pluralRules:{ak:{one:"n = 0..1"},am:{one:"i = 0 or n = 1"},ar:{zero:"n = 0",one:"n = 1",two:"n = 2",few:"n % 100 = 3..10",many:"n % 100 = 11..99"},be:{one:"n % 10 = 1 and n % 100 != 11",few:"n % 10 = 2..4 and n % 100 != 12..14",many:"n % 10 = 0 or n % 10 = 5..9 or n % 100 = 11..14"},bh:{one:"n = 0..1"},bn:{one:"i = 0 or n = 1"},br:{one:"n % 10 = 1 and n % 100 != 11,71,91",two:"n % 10 = 2 and n % 100 != 12,72,92",few:"n % 10 = 3..4,9 and n % 100 != 10..19,70..79,90..99",many:"n != 0 and n % 1000000 = 0"},bs:{one:"v = 0 and i % 10 = 1 and i % 100 != 11 or f % 10 = 1 and f % 100 != 11",few:"v = 0 and i % 10 = 2..4 and i % 100 != 12..14 or f % 10 = 2..4 and f % 100 != 12..14"},cs:{one:"i = 1 and v = 0",few:"i = 2..4 and v = 0",many:"v != 0"},cy:{zero:"n = 0",one:"n = 1",two:"n = 2",few:"n = 3",many:"n = 6"},da:{one:"n = 1 or t != 0 and i = 0,1"},fa:{one:"i = 0 or n = 1"},ff:{one:"i = 0,1"},fil:{one:"i = 0..1 and v = 0"},fr:{one:"i = 0,1"},ga:{one:"n = 1",two:"n = 2",few:"n = 3..6",many:"n = 7..10"},gd:{one:"n = 1,11",two:"n = 2,12",few:"n = 3..10,13..19"},gu:{one:"i = 0 or n = 1"},guw:{one:"n = 0..1"},gv:{one:"n % 10 = 1",two:"n % 10 = 2",few:"n % 100 = 0,20,40,60"},he:{one:"i = 1 and v = 0",two:"i = 2 and v = 0",many:"v = 0 and n != 0..10 and n % 10 = 0"},hi:{one:"i = 0 or n = 1"},hr:{one:"v = 0 and i % 10 = 1 and i % 100 != 11 or f % 10 = 1 and f % 100 != 11",few:"v = 0 and i % 10 = 2..4 and i % 100 != 12..14 or f % 10 = 2..4 and f % 100 != 12..14"},hy:{one:"i = 0,1"},is:{one:"t = 0 and i % 10 = 1 and i % 100 != 11 or t != 0"},iu:{one:"n = 1",two:"n = 2"},iw:{one:"i = 1 and v = 0",two:"i = 2 and v = 0",many:"v = 0 and n != 0..10 and n % 10 = 0"},kab:{one:"i = 0,1"},kn:{one:"i = 0 or n = 1"},kw:{one:"n = 1",two:"n = 2"},lag:{zero:"n = 0",one:"i = 0,1 and n != 0"},ln:{one:"n = 0..1"},lt:{one:"n % 10 = 1 and n % 100 != 11..19",few:"n % 10 = 2..9 and n % 100 != 11..19",many:"f != 0"},lv:{zero:"n % 10 = 0 or n % 100 = 11..19 or v = 2 and f % 100 = 11..19",one:"n % 10 = 1 and n % 100 != 11 or v = 2 and f % 10 = 1 and f % 100 != 11 or v != 2 and f % 10 = 1"},mg:{one:"n = 0..1"},mk:{one:"v = 0 and i % 10 = 1 or f % 10 = 1"},mo:{one:"i = 1 and v = 0",few:"v != 0 or n = 0 or n != 1 and n % 100 = 1..19"},mr:{one:"i = 0 or n = 1"},mt:{one:"n = 1",few:"n = 0 or n % 100 = 2..10",many:"n % 100 = 11..19"},naq:{one:"n = 1",two:"n = 2"},nso:{one:"n = 0..1"},pa:{one:"n = 0..1"},pl:{one:"i = 1 and v = 0",few:"v = 0 and i % 10 = 2..4 and i % 100 != 12..14",many:"v = 0 and i != 1 and i % 10 = 0..1 or v = 0 and i % 10 = 5..9 or v = 0 and i % 100 = 12..14"},pt:{one:"i = 1 and v = 0 or i = 0 and t = 1"},pt_PT:{one:"n = 1 and v = 0"},ro:{one:"i = 1 and v = 0",few:"v != 0 or n = 0 or n != 1 and n % 100 = 1..19"},ru:{one:"v = 0 and i % 10 = 1 and i % 100 != 11",many:"v = 0 and i % 10 = 0 or v = 0 and i % 10 = 5..9 or v = 0 and i % 100 = 11..14"},se:{one:"n = 1",two:"n = 2"},sh:{one:"v = 0 and i % 10 = 1 and i % 100 != 11 or f % 10 = 1 and f % 100 != 11",few:"v = 0 and i % 10 = 2..4 and i % 100 != 12..14 or f % 10 = 2..4 and f % 100 != 12..14"},shi:{one:"i = 0 or n = 1",few:"n = 2..10"},si:{one:"n = 0,1 or i = 0 and f = 1"},sk:{one:"i = 1 and v = 0",few:"i = 2..4 and v = 0",many:"v != 0"},sl:{one:"v = 0 and i % 100 = 1",two:"v = 0 and i % 100 = 2",few:"v = 0 and i % 100 = 3..4 or v != 0"},sma:{one:"n = 1",two:"n = 2"},smi:{one:"n = 1",two:"n = 2"},smj:{one:"n = 1",two:"n = 2"},smn:{one:"n = 1",two:"n = 2"},sms:{one:"n = 1",two:"n = 2"},sr:{one:"v = 0 and i % 10 = 1 and i % 100 != 11 or f % 10 = 1 and f % 100 != 11",few:"v = 0 and i % 10 = 2..4 and i % 100 != 12..14 or f % 10 = 2..4 and f % 100 != 12..14"},ti:{one:"n = 0..1"},tl:{one:"i = 0..1 and v = 0"},tzm:{one:"n = 0..1 or n = 11..99"},uk:{one:"v = 0 and i % 10 = 1 and i % 100 != 11",few:"v = 0 and i % 10 = 2..4 and i % 100 != 12..14",many:"v = 0 and i % 10 = 0 or v = 0 and i % 10 = 5..9 or v = 0 and i % 100 = 11..14"},wa:{one:"n = 0..1"},zu:{one:"i = 0 or n = 1"}},convertPlural:function(b,c){var d,e,f,g,h,i=new RegExp("\\d+=","i");if(!c||0===c.length)return"";for(f=0;f<c.length;f++)if(h=c[f],i.test(h)){if(g=parseInt(h.substring(0,h.indexOf("=")),10),g===b)return h.substr(h.indexOf("=")+1);c[f]=void 0}return c=a.map(c,function(a){return void 0!==a?a:void 0}),(d=this.pluralRules[a.i18n().locale])?(e=this.getPluralForm(b,d),e=Math.min(e,c.length-1),c[e]):1===b?c[0]:c[1]},getPluralForm:function(a,b){var c,d=["zero","one","two","few","many","other"],e=0;for(c=0;c<d.length;c++)if(b[d[c]]){if(pluralRuleParser(b[d[c]],a))return e;e++}return e},convertNumber:function(b,c){var d,e,f,g,h,i;if(g=this.digitTransformTable(a.i18n().locale),h=""+b,i="",!g)return b;if(c){if(parseFloat(b,10)===b)return b;d=[];for(e in g)d[g[e]]=e;g=d}for(f=0;f<h.length;f++)i+=g[h[f]]?g[h[f]]:h[f];return c?parseFloat(i,10):i},convertGrammar:function(a){return a},gender:function(a,b){if(!b||0===b.length)return"";for(;b.length<2;)b.push(b[b.length-1]);return"male"===a?b[0]:"female"===a?b[1]:3===b.length?b[2]:b[0]},digitTransformTable:function(a){var b={ar:"٠١٢٣٤٥٦٧٨٩",fa:"۰۱۲۳۴۵۶۷۸۹",ml:"൦൧൨൩൪൫൬൭൮൯",kn:"೦೧೨೩೪೫೬೭೮೯",lo:"໐໑໒໓໔໕໖໗໘໙",or:"୦୧୨୩୪୫୬୭୮୯",kh:"០១២៣៤៥៦៧៨៩",pa:"੦੧੨੩੪੫੬੭੮੯",gu:"૦૧૨૩૪૫૬૭૮૯",hi:"०१२३४५६७८९",my:"၀၁၂၃၄၅၆၇၈၉",ta:"௦௧௨௩௪௫௬௭௮௯",te:"౦౧౨౩౪౫౬౭౮౯",th:"๐๑๒๓๔๕๖๗๘๙",bo:"༠༡༢༣༤༥༦༧༨༩"};return b[a]?b[a].split(""):!1}};a.extend(a.i18n.languages,{"default":b})}(jQuery),function(a){"use strict";a.i18n=a.i18n||{},a.extend(a.i18n.fallbacks,{ab:["ru"],ace:["id"],aln:["sq"],als:["gsw","de"],an:["es"],anp:["hi"],arn:["es"],arz:["ar"],av:["ru"],ay:["es"],ba:["ru"],bar:["de"],"bat-smg":["sgs","lt"],bcc:["fa"],"be-x-old":["be-tarask"],bh:["bho"],bjn:["id"],bm:["fr"],bpy:["bn"],bqi:["fa"],bug:["id"],"cbk-zam":["es"],ce:["ru"],crh:["crh-latn"],"crh-cyrl":["ru"],csb:["pl"],cv:["ru"],"de-at":["de"],"de-ch":["de"],"de-formal":["de"],dsb:["de"],dtp:["ms"],egl:["it"],eml:["it"],ff:["fr"],fit:["fi"],"fiu-vro":["vro","et"],frc:["fr"],frp:["fr"],frr:["de"],fur:["it"],gag:["tr"],gan:["gan-hant","zh-hant","zh-hans"],"gan-hans":["zh-hans"],"gan-hant":["zh-hant","zh-hans"],gl:["pt"],glk:["fa"],gn:["es"],gsw:["de"],hif:["hif-latn"],hsb:["de"],ht:["fr"],ii:["zh-cn","zh-hans"],inh:["ru"],iu:["ike-cans"],jut:["da"],jv:["id"],kaa:["kk-latn","kk-cyrl"],kbd:["kbd-cyrl"],khw:["ur"],kiu:["tr"],kk:["kk-cyrl"],"kk-arab":["kk-cyrl"],"kk-latn":["kk-cyrl"],"kk-cn":["kk-arab","kk-cyrl"],"kk-kz":["kk-cyrl"],"kk-tr":["kk-latn","kk-cyrl"],kl:["da"],"ko-kp":["ko"],koi:["ru"],krc:["ru"],ks:["ks-arab"],ksh:["de"],ku:["ku-latn"],"ku-arab":["ckb"],kv:["ru"],lad:["es"],lb:["de"],lbe:["ru"],lez:["ru"],li:["nl"],lij:["it"],liv:["et"],lmo:["it"],ln:["fr"],ltg:["lv"],lzz:["tr"],mai:["hi"],"map-bms":["jv","id"],mg:["fr"],mhr:["ru"],min:["id"],mo:["ro"],mrj:["ru"],mwl:["pt"],myv:["ru"],mzn:["fa"],nah:["es"],nap:["it"],nds:["de"],"nds-nl":["nl"],"nl-informal":["nl"],no:["nb"],os:["ru"],pcd:["fr"],pdc:["de"],pdt:["de"],pfl:["de"],pms:["it"],pt:["pt-br"],"pt-br":["pt"],qu:["es"],qug:["qu","es"],rgn:["it"],rmy:["ro"],"roa-rup":["rup"],rue:["uk","ru"],ruq:["ruq-latn","ro"],"ruq-cyrl":["mk"],"ruq-latn":["ro"],sa:["hi"],sah:["ru"],scn:["it"],sg:["fr"],sgs:["lt"],sli:["de"],sr:["sr-ec"],srn:["nl"],stq:["de"],su:["id"],szl:["pl"],tcy:["kn"],tg:["tg-cyrl"],tt:["tt-cyrl","ru"],"tt-cyrl":["ru"],ty:["fr"],udm:["ru"],ug:["ug-arab"],uk:["ru"],vec:["it"],vep:["et"],vls:["nl"],vmf:["de"],vot:["fi"],vro:["et"],wa:["fr"],wo:["fr"],wuu:["zh-hans"],xal:["ru"],xmf:["ka"],yi:["he"],za:["zh-hans"],zea:["nl"],zh:["zh-hans"],"zh-classical":["lzh"],"zh-cn":["zh-hans"],"zh-hant":["zh-hans"],"zh-hk":["zh-hant","zh-hans"],"zh-min-nan":["nan"],"zh-mo":["zh-hk","zh-hant","zh-hans"],"zh-my":["zh-sg","zh-hans"],"zh-sg":["zh-hans"],"zh-tw":["zh-hant","zh-hans"],"zh-yue":["yue"]})}(jQuery),function(a){"use strict";a.i18n.languages.bs=a.extend({},a.i18n.languages["default"],{convertGrammar:function(a,b){switch(b){case"instrumental":a="s "+a;break;case"lokativ":a="o "+a}return a}})}(jQuery),function(a){"use strict";a.i18n.languages.dsb=a.extend({},a.i18n.languages["default"],{convertGrammar:function(a,b){switch(b){case"instrumental":a="z "+a;break;case"lokatiw":a="wo "+a}return a}})}(jQuery),function(a){"use strict";a.i18n.languages.fi=a.extend({},a.i18n.languages["default"],{convertGrammar:function(a,b){var c=a.match(/[aou][^äöy]*$/i),d=a;switch(a.match(/wiki$/i)&&(c=!1),a.match(/[bcdfghjklmnpqrstvwxz]$/i)&&(a+="i"),b){case"genitive":a+="n";break;case"elative":a+=c?"sta":"stä";break;case"partitive":a+=c?"a":"ä";break;case"illative":a+=a.substr(a.length-1)+"n";break;case"inessive":a+=c?"ssa":"ssä";break;default:a=d}return a}})}(jQuery),function(a){"use strict";a.i18n.languages.ga=a.extend({},a.i18n.languages["default"],{convertGrammar:function(a,b){if("ainmlae"===b)switch(a){case"an Domhnach":a="Dé Domhnaigh";break;case"an Luan":a="Dé Luain";break;case"an Mháirt":a="Dé Mháirt";break;case"an Chéadaoin":a="Dé Chéadaoin";break;case"an Déardaoin":a="Déardaoin";break;case"an Aoine":a="Dé hAoine";break;case"an Satharn":a="Dé Sathairn"}return a}})}(jQuery),function(a){"use strict";a.i18n.languages.he=a.extend({},a.i18n.languages["default"],{convertGrammar:function(a,b){switch(b){case"prefixed":case"תחילית":"ו"===a.substr(0,1)&&"וו"!==a.substr(0,2)&&(a="ו"+a),"ה"===a.substr(0,1)&&(a=a.substr(1,a.length)),(a.substr(0,1)<"א"||a.substr(0,1)>"ת")&&(a="־"+a)}return a}})}(jQuery),function(a){"use strict";a.i18n.languages.hsb=a.extend({},a.i18n.languages["default"],{convertGrammar:function(a,b){switch(b){case"instrumental":a="z "+a;break;case"lokatiw":a="wo "+a}return a}})}(jQuery),function(a){"use strict";a.i18n.languages.hu=a.extend({},a.i18n.languages["default"],{convertGrammar:function(a,b){switch(b){case"rol":a+="ról";break;case"ba":a+="ba";break;case"k":a+="k"}return a}})}(jQuery),function(a){"use strict";a.i18n.languages.hy=a.extend({},a.i18n.languages["default"],{convertGrammar:function(a,b){return"genitive"===b&&("ա"===a.substr(-1)?a=a.substr(0,a.length-1)+"այի":"ո"===a.substr(-1)?a=a.substr(0,a.length-1)+"ոյի":"գիրք"===a.substr(-4)?a=a.substr(0,a.length-4)+"գրքի":a+="ի"),a}})}(jQuery),function(a){"use strict";a.i18n.languages.la=a.extend({},a.i18n.languages["default"],{convertGrammar:function(a,b){switch(b){case"genitive":a=a.replace(/u[ms]$/i,"i"),a=a.replace(/ommunia$/i,"ommunium"),a=a.replace(/a$/i,"ae"),a=a.replace(/libri$/i,"librorum"),a=a.replace(/nuntii$/i,"nuntiorum"),a=a.replace(/tio$/i,"tionis"),a=a.replace(/ns$/i,"ntis"),a=a.replace(/as$/i,"atis"),a=a.replace(/es$/i,"ei");break;case"accusative":a=a.replace(/u[ms]$/i,"um"),a=a.replace(/ommunia$/i,"am"),a=a.replace(/a$/i,"ommunia"),a=a.replace(/libri$/i,"libros"),a=a.replace(/nuntii$/i,"nuntios"),a=a.replace(/tio$/i,"tionem"),a=a.replace(/ns$/i,"ntem"),a=a.replace(/as$/i,"atem"),a=a.replace(/es$/i,"em");break;case"ablative":a=a.replace(/u[ms]$/i,"o"),a=a.replace(/ommunia$/i,"ommunibus"),a=a.replace(/a$/i,"a"),a=a.replace(/libri$/i,"libris"),a=a.replace(/nuntii$/i,"nuntiis"),a=a.replace(/tio$/i,"tione"),a=a.replace(/ns$/i,"nte"),a=a.replace(/as$/i,"ate"),a=a.replace(/es$/i,"e")}return a}})}(jQuery),function(a){"use strict";a.i18n.languages.ml=a.extend({},a.i18n.languages["default"],{convertGrammar:function(a,b){switch(b=b.toLowerCase()){case"ഉദ്ദേശിക":case"dative":"ു"===a.substr(-1)||"ൂ"===a.substr(-1)||"ൗ"===a.substr(-1)||"ൌ"===a.substr(-1)?a+="വിന്":"ം"===a.substr(-1)?a=a.substr(0,a.length-1)+"ത്തിന്":"ൻ"===a.substr(-1)?a=a.substr(0,a.length-1)+"ന്":"ന്‍"===a.substr(-3)?a=a.substr(0,a.length-1):"ൾ"===a.substr(-1)||"ള്‍"===a.substr(-3)?a+="ക്ക്":"ർ"===a.substr(-1)||"ര്‍"===a.substr(-3)?a+="ക്ക്":"ൽ"===a.substr(-1)?a=a.substr(0,a.length-1)+"ലിന്":"ല്‍"===a.substr(-3)?a=a.substr(0,a.length-2)+"ിന്":"ു്"===a.substr(-2)?a=a.substr(0,a.length-2)+"ിന്":"്"===a.substr(-1)?a=a.substr(0,a.length-1)+"ിന്":a+="യ്ക്ക്";break;case"സംബന്ധിക":case"genitive":"ം"===a.substr(-1)?a=a.substr(0,a.length-1)+"ത്തിന്റെ":"ു്"===a.substr(-2)?a=a.substr(0,a.length-2)+"ിന്റെ":"്"===a.substr(-1)?a=a.substr(0,a.length-1)+"ിന്റെ":"ു"===a.substr(-1)||"ൂ"===a.substr(-1)||"ൗ"===a.substr(-1)||"ൌ"===a.substr(-1)?a+="വിന്റെ":"ൻ"===a.substr(-1)?a=a.substr(0,a.length-1)+"ന്റെ":"ന്‍"===a.substr(-3)?a=a.substr(0,a.length-1)+"റെ":"ള്‍"===a.substr(-3)?a=a.substr(0,a.length-2)+"ുടെ":"ൾ"===a.substr(-1)?a=a.substr(0,a.length-1)+"ളുടെ":"ൽ"===a.substr(-1)?a=a.substr(0,a.length-1)+"ലിന്റെ":"ല്‍"===a.substr(-3)?a=a.substr(0,a.length-2)+"ിന്റെ":"ര്‍"===a.substr(-3)?a=a.substr(0,a.length-2)+"ുടെ":"ർ"===a.substr(-1)?a=a.substr(0,a.length-1)+"രുടെ":a+="യുടെ"}return a}})}(jQuery),function(a){"use strict";a.i18n.languages.os=a.extend({},a.i18n.languages["default"],{convertGrammar:function(a,b){var c,d,e,f;switch(c="мæ",d="",e="",f="",a.match(/тæ$/i)?(a=a.substring(0,a.length-1),c="æм"):a.match(/[аæеёиоыэюя]$/i)?d="й":a.match(/у$/i)?a.substring(a.length-2,a.length-1).match(/[аæеёиоыэюя]$/i)||(d="й"):a.match(/[бвгджзйклмнопрстфхцчшщьъ]$/i)||(e="-"),b){case"genitive":f=e+d+"ы";break;case"dative":f=e+d+"æн";break;case"allative":f=e+c;break;case"ablative":f="й"===d?e+d+"æ":e+d+"æй";break;case"superessive":f=e+d+"ыл";break;case"equative":f=e+d+"ау";break;case"comitative":f=e+"имæ"}return a+f}})}(jQuery),function(a){"use strict";a.i18n.languages.ru=a.extend({},a.i18n.languages["default"],{convertGrammar:function(a,b){return"genitive"===b&&("ь"===a.substr(-1)?a=a.substr(0,a.length-1)+"я":"ия"===a.substr(-2)?a=a.substr(0,a.length-2)+"ии":"ка"===a.substr(-2)?a=a.substr(0,a.length-2)+"ки":"ти"===a.substr(-2)?a=a.substr(0,a.length-2)+"тей":"ды"===a.substr(-2)?a=a.substr(0,a.length-2)+"дов":"ник"===a.substr(-3)&&(a=a.substr(0,a.length-3)+"ника")),a}})}(jQuery),function(a){"use strict";a.i18n.languages.sl=a.extend({},a.i18n.languages["default"],{convertGrammar:function(a,b){switch(b){case"mestnik":a="o "+a;break;case"orodnik":a="z "+a}return a}})}(jQuery),function(a){"use strict";a.i18n.languages.uk=a.extend({},a.i18n.languages["default"],{convertGrammar:function(a,b){switch(b){case"genitive":"ь"===a.substr(-1)?a=a.substr(0,a.length-1)+"я":"ія"===a.substr(-2)?a=a.substr(0,a.length-2)+"ії":"ка"===a.substr(-2)?a=a.substr(0,a.length-2)+"ки":"ти"===a.substr(-2)?a=a.substr(0,a.length-2)+"тей":"ды"===a.substr(-2)?a=a.substr(0,a.length-2)+"дов":"ник"===a.substr(-3)&&(a=a.substr(0,a.length-3)+"ника");break;case"accusative":"ія"===a.substr(-2)&&(a=a.substr(0,a.length-2)+"ію")}return a}})}(jQuery),function(a){"use strict";a.uls=a.uls||{},a.uls.data={languages:{aa:["Latn",["AF"],"Qafár af"],ab:["Cyrl",["EU"],"Аҧсшәа"],ace:["Latn",["AS","PA"],"Acèh"],ady:["Cyrl",["EU","ME"],"Адыгэбзэ"],"ady-cyrl":["ady"],"ady-latn":["Latn",["EU","ME"],"Adygabze"],aeb:["Arab",["AF"],"زَوُن"],af:["Latn",["AF"],"Afrikaans"],ahr:["Deva",["AS"],"अहिराणी"],ak:["Latn",["AF"],"Akan"],akz:["Latn",["AM"],"Albaamo innaaɬiilka"],aln:["Latn",["EU"],"Gegë"],am:["Ethi",["AF"],"አማርኛ"],an:["Latn",["EU"],"aragonés"],ang:["Latn",["EU"],"Ænglisc"],anp:["Deva",["AS"],"अङ्गिका"],ar:["Arab",["ME"],"العربية"],arc:["Syrc",["ME"],"ܐܪܡܝܐ"],arn:["Latn",["AM"],"mapudungun"],aro:["Latn",["AM"],"Araona"],arq:["Latn",["AF"],"Dziri"],ary:["Latn",["ME"],"Maġribi"],arz:["Arab",["ME"],"مصرى"],as:["Beng",["AS"],"অসমীয়া"],ase:["Sgnw",["AM"],"American sign language"],ast:["Latn",["EU"],"asturianu"],av:["Cyrl",["EU"],"авар"],avk:["Latn",["WW"],"Kotava"],ay:["Latn",["AM"],"Aymar aru"],az:["az-latn"],"az-latn":["Latn",["EU","ME"],"azərbaycanca"],"az-arab":["Arab",["EU","ME"],"آذربايجانجا"],"az-cyrl":["Latn",["EU","ME"],"азәрбајҹанҹа"],azb:["az-arab"],ba:["Cyrl",["EU"],"башҡортса"],bar:["Latn",["EU"],"Boarisch"],"bat-smg":["sgs"],"bbc-latn":["Latn",["AS"],"Batak Toba"],"bbc-batk":["Batk",["AS"],"Batak Toba"],bbc:["Latn",["AS"],"Batak Toba"],bcc:["Arab",["AS","ME"],"بلوچی مکرانی"],bcl:["Latn",["AS"],"Bikol Central"],"be-tarask":["Cyrl",["EU"],"беларуская (тарашкевіца)"],"be-x-old":["be-tarask"],be:["Cyrl",["EU"],"беларуская"],bew:["Latn",["AS"],"Bahasa Betawi"],bfq:["Taml",["AS"],"படகா"],bg:["Cyrl",["EU"],"български"],bh:["Deva",["AS"],"भोजपुरी"],bho:["Deva",["AS"],"भोजपुरी"],bi:["Latn",["PA"],"Bislama"],bjn:["Latn",["AS"],"Bahasa Banjar"],bm:["Latn",["AF"],"bamanankan"],bn:["Beng",["AS"],"বাংলা"],bo:["Tibt",["AS"],"བོད་ཡིག"],bpy:["Beng",["AS"],"বিষ্ণুপ্রিয়া মণিপুরী"],bqi:["Arab",["ME"],"بختياري"],br:["Latn",["EU"],"brezhoneg"],brh:["Latn",["ME","AS"],"Bráhuí"],brx:["Deva",["AS"],"बड़ो"],bs:["Latn",["EU"],"bosanski"],bto:["Latn",["AS"],"Iriga Bicolano"],bug:["Bugi",["AS"],"ᨅᨔ ᨕᨘᨁᨗ"],bxr:["Cyrl",["AS"],"буряад"],ca:["Latn",["EU"],"català"],"cbk-zam":["Latn",["AS"],"Chavacano de Zamboanga"],cdo:["Latn",["AS"],"Mìng-dĕ̤ng-ngṳ̄"],ce:["Cyrl",["EU"],"нохчийн"],ceb:["Latn",["AS"],"Cebuano"],ch:["Latn",["PA"],"Chamoru"],cho:["Latn",["AM"],"Choctaw"],chr:["Cher",["AM"],"ᏣᎳᎩ"],chy:["Latn",["AM"],"Tsetsêhestâhese"],ckb:["Arab",["ME"],"کوردی"],co:["Latn",["EU"],"corsu"],cps:["Latn",["AS"],"Capiceño"],cr:["Cans",["AM"],"ᓀᐦᐃᔭᐍᐏᐣ"],"cr-cans":["cr"],"cr-latn":["Latn",["AM"],"Nēhiyawēwin"],crh:["Latn",["EU"],"qırımtatarca"],"crh-cyrl":["Cyrl",["EU"],"къырымтатарджа"],"crh-latn":["crh"],cs:["Latn",["EU"],"česky"],csb:["Latn",["EU"],"kaszëbsczi"],cu:["Cyrl",["EU"],"словѣньскъ / ⰔⰎⰑⰂⰡⰐⰠⰔⰍⰟ"],cv:["Cyrl",["EU"],"Чӑвашла"],cy:["Latn",["EU"],"Cymraeg"],da:["Latn",["EU"],"dansk"],"de-at":["Latn",["EU"],"Österreichisches Deutsch"],"de-ch":["Latn",["EU"],"Schweizer Hochdeutsch"],"de-formal":["Latn",["EU"],"Deutsch (Sie-Form)"],de:["Latn",["EU"],"Deutsch"],diq:["Latn",["EU","AS"],"Zazaki"],dsb:["Latn",["EU"],"dolnoserbski"],dtp:["Latn",["AS"],"Dusun Bundu-liwan"],dv:["Thaa",["AS"],"ދިވެހިބަސް"],dz:["Tibt",["AS"],"ཇོང་ཁ"],ee:["Latn",["AF"],"eʋegbe"],egl:["Latn",["EU"],"Emiliàn"],el:["Grek",["EU"],"Ελληνικά"],eml:["Latn",["EU"],"emiliàn e rumagnòl"],"en-ca":["Latn",["AM"],"Canadian English"],"en-gb":["Latn",["EU","AS","PA"],"British English"],en:["Latn",["EU","AM","AF","ME","AS","PA","WW"],"English"],eo:["Latn",["WW"],"Esperanto"],"es-419":["Latn",["AM"],"español de America Latina"],"es-formal":["Latn",["EU","AM","AF","WW"],"español (formal)"],es:["Latn",["EU","AM","AF","WW"],"español"],esu:["Latn",["AM"],"Yup'ik"],et:["Latn",["EU"],"eesti"],eu:["Latn",["EU"],"euskara"],ext:["Latn",["EU"],"estremeñu"],fa:["Arab",["ME"],"فارسی"],ff:["Latn",["AF"],"Fulfulde"],fi:["Latn",["EU"],"suomi"],fil:["tl"],fit:["Latn",["EU"],"meänkieli"],"fiu-vro":["vro"],fj:["Latn",["PA"],"Na Vosa Vakaviti"],fo:["Latn",["EU"],"føroyskt"],fr:["Latn",["EU","AM","WW"],"français"],frc:["Latn",["AM"],"français cadien"],frp:["Latn",["EU"],"arpetan"],frr:["Latn",["EU"],"Nordfriisk"],fur:["Latn",["EU"],"furlan"],fy:["Latn",["EU"],"Frysk"],ga:["Latn",["EU"],"Gaeilge"],gag:["Latn",["EU"],"Gagauz"],gah:["Latn",["AS"],"Alekano"],"gan-hans":["Hans",["AS"],"赣语（简体）"],"gan-hant":["gan"],gan:["Hant",["AS"],"贛語"],gbz:["Latn",["AS"],"Dari"],gcf:["Latn",["AM"],"Guadeloupean Creole French"],gd:["Latn",["EU"],"Gàidhlig"],gl:["Latn",["EU"],"galego"],glk:["Arab",["ME"],"گیلکی"],gn:["Latn",["AM"],"Avañe'ẽ"],gom:["Deva",["AS"],"कोंकणी"],"gom-deva":["gom"],"gom-latn":["Latn",["AS"],"Konknni"],got:["Goth",["EU"],"𐌲𐌿𐍄𐌹𐍃𐌺"],grc:["Grek",["EU"],"Ἀρχαία ἑλληνικὴ"],gsw:["Latn",["EU"],"Alemannisch"],gu:["Gujr",["AS"],"ગુજરાતી"],guc:["Latn",["AM"],"Wayúu"],gur:["Latn",["AF"],"Gurenɛ"],gv:["Latn",["EU"],"Gaelg"],"ha-arab":["Arab",["AF"],"هَوُسَ"],"ha-latn":["Latn",["AF"],"Hausa"],ha:["ha-latn"],hak:["Latn",["AS"],"Hak-kâ-fa"],haw:["Latn",["AM","PA"],"Hawai`i"],he:["Hebr",["ME"],"עברית"],hi:["Deva",["AS"],"हिन्दी"],hif:["Latn",["PA","AS"],"Fiji Hindi"],"hif-deva":["Deva",["AS"],"फ़ीजी हिन्दी"],"hif-latn":["hif"],hil:["Latn",["AS"],"Ilonggo"],hne:["Deva",["AS"],"छत्तीसगढ़ी"],ho:["Latn",["PA"],"Hiri Motu"],hr:["Latn",["EU"],"hrvatski"],hsb:["Latn",["EU"],"hornjoserbsce"],hsn:["Hans",["AS"],"湘语"],ht:["Latn",["AM"],"Kreyòl ayisyen"],"hu-formal":["Latn",["EU"],"Magyar (magázó)"],hu:["Latn",["EU"],"magyar"],hy:["Armn",["EU","ME"],"Հայերեն"],hz:["Latn",["AF"],"Otsiherero"],ia:["Latn",["WW"],"interlingua"],id:["Latn",["AS"],"Bahasa Indonesia"],ie:["Latn",["WW"],"Interlingue"],ig:["Latn",["AF"],"Igbo"],ii:["Yiii",["AS"],"ꆇꉙ"],ik:["Latn",["AM"],"Iñupiak"],"ike-cans":["Cans",["AM"],"ᐃᓄᒃᑎᑐᑦ"],"ike-latn":["Latn",["AM"],"inuktitut"],ilo:["Latn",["AS"],"Ilokano"],inh:["Cyrl",["EU"],"ГӀалгӀай"],io:["Latn",["WW"],"Ido"],is:["Latn",["EU"],"íslenska"],it:["Latn",["EU"],"italiano"],iu:["Cans",["AM"],"ᐃᓄᒃᑎᑐᑦ"],ja:["Jpan",["AS"],"日本語"],jam:["Latn",["AM"],"Patois"],jbo:["Latn",["WW"],"lojban"],jut:["Latn",["EU"],"jysk"],jv:["Latn",["AS","PA"],"Basa Jawa"],"jv-java":["Java",["AS","PA"],"ꦧꦱꦗꦮ"],ka:["Geor",["EU"],"ქართული"],kaa:["Latn",["AS"],"Qaraqalpaqsha"],kab:["Latn",["AF","EU"],"Taqbaylit"],"kbd-cyrl":["kbd"],"kbd-latn":["Latn",["EU"],"Qabardjajəbza"],kbd:["Cyrl",["EU","ME"],"Адыгэбзэ"],kea:["Latn",["AF"],"Kabuverdianu"],kg:["Latn",["AF"],"Kongo"],kgp:["Latn",["AM"],"Kaingáng"],khw:["Arab",["ME","AS"],"کھوار"],ki:["Latn",["AF"],"Gĩkũyũ"],kiu:["Latn",["EU","ME"],"Kırmancki"],kj:["Latn",["AF"],"Kwanyama"],kk:["kk-cyrl"],"kk-arab":["Arab",["EU","AS"],"قازاقشا (تٶتە)"],"kk-cn":["kk-arab"],"kk-cyrl":["Cyrl",["EU","AS"],"қазақша"],"kk-kz":["kk-cyrl"],"kk-latn":["Latn",["EU","AS","ME"],"qazaqşa"],"kk-tr":["kk-latn"],kl:["Latn",["AM","EU"],"kalaallisut"],km:["Khmr",["AS"],"ភាសាខ្មែរ"],kn:["Knda",["AS"],"ಕನ್ನಡ"],"ko-kp":["Kore",["AS"],"한국어 (조선)"],ko:["Kore",["AS"],"한국어"],koi:["Cyrl",["EU"],"Перем Коми"],kr:["Latn",["AF"],"Kanuri"],krc:["Cyrl",["EU"],"къарачай-малкъар"],kri:["Latn",["AF"],"Krio"],krj:["Latn",["ME","EU"],"Kinaray-a"],krl:["Latn",["EU"],"Karjala"],"ks-arab":["Arab",["AS"],"کٲشُر"],"ks-deva":["Deva",["AS"],"कॉशुर"],ks:["Arab",["AS"],"کٲشُر"],ksf:["Latn",["AF"],"Bafia"],ksh:["Latn",["EU"],"Ripoarisch"],ku:["ku-latn"],"ku-arab":["Arab",["EU","ME"],"كوردي"],"ku-latn":["Latn",["EU","ME"],"Kurdî"],kv:["Cyrl",["EU"],"коми"],kw:["Latn",["EU"],"kernowek"],ky:["Cyrl",["AS"],"Кыргызча"],la:["Latn",["EU"],"Latina"],lad:["lad-latn"],"lad-latn":["Latn",["ME","EU","AM"],"Ladino"],"lad-hebr":["Hebr",["ME","EU","AM"],"לאדינו"],lb:["Latn",["EU"],"Lëtzebuergesch"],lbe:["Cyrl",["EU"],"лакку"],lez:["Cyrl",["EU"],"лезги"],lfn:["Latn",["WW"],"Lingua Franca Nova"],lg:["Latn",["AF"],"Luganda"],li:["Latn",["EU"],"Limburgs"],lij:["Latn",["EU"],"Ligure"],liv:["Latn",["EU"],"Līvõ kēļ"],lld:["Latn",["EU"],"Ladin"],lmo:["Latn",["EU"],"lumbaart"],ln:["Latn",["AF"],"lingála"],lo:["Laoo",["AS"],"ລາວ"],loz:["Latn",["AF"],"Silozi"],lt:["Latn",["EU"],"lietuvių"],lrc:["Arab",["AS"],"لوری"],ltg:["Latn",["EU"],"latgaļu"],lus:["Latn",["AS"],"Mizo ţawng"],lut:["Latn",["AM"],"dxʷləšucid"],lv:["Latn",["EU"],"latviešu"],lzh:["Hant",["AS"],"文言"],lzz:["Latn",["EU","ME"],"Lazuri"],mai:["Deva",["AS"],"मैथिली"],"map-bms":["Latn",["AS"],"Basa Banyumasan"],mdf:["Cyrl",["EU"],"мокшень"],mfe:["Latn",["AM"],"Morisyen"],mg:["Latn",["AF"],"Malagasy"],mh:["Latn",["PA"],"Ebon"],mhr:["Cyrl",["EU"],"олык марий"],mi:["Latn",["PA"],"Māori"],mic:["Latn",["AM"],"Mi'kmaq"],min:["Latn",["AS"],"Baso Minangkabau"],mk:["Cyrl",["EU"],"македонски"],ml:["Mlym",["AS","ME"],"മലയാളം"],mn:["Cyrl",["AS"],"монгол"],mnc:["Mong",["AS"],"ᠮᠠᠨᠵᡠ ᡤᡳᠰᡠᠨ"],mni:["Beng",["AS"],"মেইতেই লোন্"],mnw:["Mymr",["AS"],"ဘာသာ မန်"],mo:["Cyrl",["EU"],"молдовеняскэ"],mr:["Deva",["AS","ME"],"मराठी"],mrj:["Cyrl",["EU"],"кырык мары"],ms:["Latn",["AS"],"Bahasa Melayu"],mt:["Latn",["EU"],"Malti"],mui:["Latn",["AS"],"Musi"],mus:["Latn",["AM"],"Mvskoke"],mwl:["Latn",["EU"],"Mirandés"],mwv:["Latn",["AS"],"Behase Mentawei"],my:["Mymr",["AS"],"မြန်မာဘာသာ"],myv:["Cyrl",["EU"],"эрзянь"],mzn:["Arab",["ME","AS"],"مازِرونی"],na:["Latn",["PA"],"Dorerin Naoero"],nah:["Latn",["AM"],"Nāhuatl"],nan:["Latn",["AS"],"Bân-lâm-gú"],nap:["Latn",["EU"],"Nnapulitano"],nb:["Latn",["EU"],"norsk (bokmål)"],"nds-nl":["Latn",["EU"],"Nedersaksisch"],nds:["Latn",["EU"],"Plattdüütsch"],ne:["Deva",["AS"],"नेपाली"],"new":["Deva",["AS"],"नेपाल भाषा"],ng:["Latn",["AF"],"Oshiwambo"],niu:["Latn",["PA"],"ko e vagahau Niuē"],njo:["Latn",["AS"],"Ao"],"nl-informal":["Latn",["EU","AM"],"Nederlands (informeel)"],nl:["Latn",["EU","AM"],"Nederlands"],nn:["Latn",["EU"],"norsk (nynorsk)"],no:["Latn",["EU"],"norsk"],nov:["Latn",["WW"],"Novial"],nqo:["Nkoo",["AF"],"ߒߞߏ"],nrm:["Latn",["EU"],"Nouormand"],nso:["Latn",["AF"],"Sesotho sa Leboa"],nv:["Latn",["AM"],"Diné bizaad"],ny:["Latn",["AF"],"Chi-Chewa"],oc:["Latn",["EU"],"occitan"],om:["Latn",["AF"],"Oromoo"],or:["Orya",["AS"],"ଓଡ଼ିଆ"],os:["Cyrl",["EU"],"Ирон"],ota:["Latn",["AS","EU"],"Ottoman Turkish"],pa:["pa-guru"],"pa-guru":["Guru",["AS"],"ਪੰਜਾਬੀ"],pag:["Latn",["AS"],"Pangasinan"],pam:["Latn",["AS"],"Kapampangan"],pap:["Latn",["AM"],"Papiamentu"],pcd:["Latn",["EU"],"Picard"],pdc:["Latn",["EU","AM"],"Deitsch"],pdt:["Latn",["EU","AM"],"Plautdietsch"],pfl:["Latn",["EU"],"Pälzisch"],pi:["Deva",["AS"],"पालि"],pih:["Latn",["PA"],"Norfuk / Pitkern"],pis:["Latn",["PA"],"Pijin"],pko:["Latn",["AF"],"Pökoot"],pl:["Latn",["EU"],"polski"],pms:["Latn",["EU"],"Piemontèis"],pnb:["Arab",["AS","ME"],"پنجابی"],pnt:["Grek",["EU"],"Ποντιακά"],ppl:["Latn",["AM"],"Nawat"],prg:["Latn",["EU"],"Prūsiskan"],ps:["Arab",["AS","ME"],"پښتو"],"pt-br":["Latn",["AM"],"português do Brasil"],pt:["Latn",["EU","AM","AS","PA","AF","WW"],"português"],qu:["Latn",["AM"],"Runa Simi"],qug:["Latn",["AM"],"Runa shimi"],rap:["Latn",["AM"],"arero rapa nui"],rgn:["Latn",["EU"],"Rumagnôl"],rif:["Latn",["AF"],"Tarifit"],rki:["Mymr",["AS"],"ရခိုင်"],rm:["Latn",["EU"],"rumantsch"],rmf:["Latn",["EU"],"kaalengo tšimb"],rmy:["Latn",["EU"],"Romani"],rn:["Latn",["AF"],"Kirundi"],ro:["Latn",["EU"],"română"],"roa-rup":["rup"],"roa-tara":["Latn",["EU"],"tarandíne"],rtm:["Latn",["PA"],"Faeag Rotuma"],ru:["Cyrl",["EU","AS","ME"],"русский"],rue:["Cyrl",["EU"],"русиньскый"],rup:["Latn",["EU"],"Armãneashce"],ruq:["Cyrl",["EU"],"Влахесте"],"ruq-cyrl":["ruq"],"ruq-grek":["Grek",["EU"],"Megleno-Romanian (Greek script)"],"ruq-latn":["Latn",["EU"],"Vlăheşte"],rw:["Latn",["AF"],"Kinyarwanda"],rwr:["Deva",["AS"],"मारवाड़ी"],ryu:["Kana",["AS"],"ʔucināguci"],sa:["Deva",["AS"],"संस्कृतम्"],sah:["Cyrl",["EU","AS"],"саха тыла"],sat:["Latn",["AS"],"Santali"],saz:["Saur",["AS"],"ꢱꣃꢬꢵꢯ꣄ꢡ꣄ꢬꢵ"],sc:["Latn",["EU"],"sardu"],scn:["Latn",["EU"],"sicilianu"],sco:["Latn",["EU"],"Scots"],sd:["Arab",["AS"],"سنڌي"],sdc:["Latn",["EU"],"Sassaresu"],se:["Latn",["EU"],"sámegiella"],ses:["Latn",["AF"],"Koyraboro Senni"],sei:["Latn",["AM"],"Cmique Itom"],sg:["Latn",["AF"],"Sängö"],sgs:["Latn",["EU"],"žemaitėška"],sh:["Latn",["EU"],"srpskohrvatski"],"shi-latn":["Latn",["AF"],"Tašlḥiyt"],"shi-tfng":["Tfng",["AF"],"ⵜⴰⵛⵍⵃⵉⵜ"],shi:["shi-latn"],shn:["Mymr",["AS"],"လိၵ်ႈတႆး"],si:["Sinh",["AS"],"සිංහල"],simple:["Latn",["WW"],"Simple English"],sk:["Latn",["EU"],"slovenčina"],sl:["Latn",["EU"],"slovenščina"],sli:["Latn",["EU"],"Schläsch"],slr:["Latn",["AS"],"Salırça"],sly:["Latn",["AS"],"Bahasa Selayar"],syc:["Syrc",["ME"],"ܣܘܪܝܝܐ"],sm:["Latn",["PA"],"Gagana Samoa"],sma:["Latn",["EU"],"åarjelsaemien"],smj:["Latn",["EU"],"julevsámegiella"],smn:["Latn",["EU"],"anarâškielâ"],sms:["Latn",["EU"],"sää´mǩiõll"],sn:["Latn",["AF"],"chiShona"],so:["Latn",["AF"],"Soomaaliga"],sq:["Latn",["EU"],"shqip"],sr:["sr-cyrl"],"sr-ec":["sr-cyrl"],"sr-cyrl":["Cyrl",["EU"],"српски"],"sr-el":["sr-latn"],"sr-latn":["Latn",["EU"],"srpski"],srn:["Latn",["AM","EU"],"Sranantongo"],ss:["Latn",["AF"],"SiSwati"],st:["Latn",["AF"],"Sesotho"],stq:["Latn",["EU"],"Seeltersk"],su:["Latn",["AS"],"Basa Sunda"],sv:["Latn",["EU"],"svenska"],sw:["Latn",["AF"],"Kiswahili"],swb:["Latn",["AF"],"Shikomoro"],sxu:["Latn",["EU"],"Säggssch"],szl:["Latn",["EU"],"ślůnski"],ta:["Taml",["AS"],"தமிழ்"],tcy:["Knda",["AS"],"ತುಳು"],te:["Telu",["AS"],"తెలుగు"],tet:["Latn",["AS","PA"],"tetun"],"tg-cyrl":["Cyrl",["AS"],"тоҷикӣ"],"tg-latn":["Latn",["AS"],"tojikī"],tg:["Cyrl",["AS"],"тоҷикӣ"],th:["Thai",["AS"],"ไทย"],ti:["Ethi",["AF"],"ትግርኛ"],tk:["Latn",["AS"],"Türkmençe"],tkr:["Cyrl",["AS"],"ЦӀаьхна миз"],tl:["Latn",["AS"],"Tagalog"],tly:["Cyrl",["EU","AS","ME"],"толышә зывон"],tn:["Latn",["AF"],"Setswana"],to:["Latn",["PA"],"lea faka-Tonga"],tokipona:["Latn",["WW"],"Toki Pona"],tpi:["Latn",["PA","AS"],"Tok Pisin"],tr:["Latn",["EU","ME"],"Türkçe"],trp:["Latn",["AS"],"Kokborok (Tripuri)"],tru:["Latn",["AS"],"Ṫuroyo"],ts:["Latn",["AF"],"Xitsonga"],tsd:["Grek",["EU"],"Τσακωνικά"],tt:["Cyrl",["EU"],"татарча"],"tt-cyrl":["tt"],"tt-latn":["Latn",["EU"],"tatarça"],ttt:["Cyrl",["AS"],"Tati"],tum:["Latn",["AF"],"chiTumbuka"],tw:["Latn",["AF"],"Twi"],twd:["Latn",["EU"],"Tweants"],ty:["Latn",["PA"],"Reo Mā`ohi"],tyv:["Cyrl",["AS"],"тыва дыл"],tzm:["Tfng",["AF"],"ⵜⴰⵎⴰⵣⵉⵖⵜ"],udm:["Cyrl",["EU"],"удмурт"],ug:["ug-arab"],"ug-arab":["Arab",["AS"],"ئۇيغۇرچە"],"ug-latn":["Latn",["AS"],"uyghurche"],"ug-cyrl":["Cyrl",["AS"],"уйғурчә"],uk:["Cyrl",["EU"],"українська"],ur:["Arab",["AS","ME"],"اردو"],uz:["Latn",["AS"],"oʻzbekcha"],ve:["Latn",["AF"],"Tshivenda"],vec:["Latn",["EU"],"vèneto"],vep:["Latn",["EU"],"vepsän kel’"],vi:["Latn",["AS"],"Tiếng Việt"],vls:["Latn",["EU"],"West-Vlams"],vmf:["Latn",["EU"],"Mainfränkisch"],vo:["Latn",["WW"],"Volapük"],vot:["Latn",["EU"],"Vaďďa"],vro:["Latn",["EU"],"Võro"],wa:["Latn",["EU"],"walon"],war:["Latn",["AS"],"Winaray"],wls:["Latn",["PA"],"Faka'uvea"],wo:["Latn",["AF"],"Wolof"],wuu:["Hans",["AS"],"吴语"],xal:["Cyrl",["EU"],"хальмг"],xh:["Latn",["AF"],"isiXhosa"],xmf:["Geor",["EU"],"მარგალური"],ydd:["Hebr",["AS","EU"],"Eastern Yiddish"],yi:["Hebr",["ME","EU","AM"],"ייִדיש"],yo:["Latn",["AF"],"Yorùbá"],yrk:["Cyrl",["AS"],"Ненэцяʼ вада"],yrl:["Latn",["AM"],"ñe'engatú"],yua:["Latn",["AM"],"Maaya T'aan"],yue:["Hant",["AS"],"粵語"],za:["Latn",["AS"],"Vahcuengh"],zea:["Latn",["EU"],"Zeêuws"],zh:["Hans",["AS"],"中文"],"zh-classical":["Hant",["AS"],"文言"],"zh-cn":["Hans",["AS"],"中文（中国大陆）"],"zh-hans":["Hans",["AS"],"中文（简体）"],"zh-hant":["Hant",["AS"],"中文（繁體）"],"zh-hk":["Hant",["AS"],"中文（香港）"],"zh-min-nan":["nan"],"zh-mo":["Hant",["AS"],"中文（澳門）"],"zh-my":["Hans",["AS"],"中文（马来西亚）"],"zh-sg":["Hans",["AS"],"中文（新加坡）"],"zh-tw":["Hant",["AS"],"中文（台灣）"],"zh-yue":["yue"],zu:["Latn",["AF"],"isiZulu"]},scriptgroups:{Latin:["Latn","Goth"],Greek:["Grek"],WestCaucasian:["Armn","Geor"],Arabic:["Arab"],MiddleEastern:["Hebr","Syrc"],African:["Ethi","Nkoo","Tfng"],SouthAsian:["Beng","Deva","Gujr","Guru","Knda","Mlym","Orya","Saur","Sinh","Taml","Telu","Tibt","Thaa"],Cyrillic:["Cyrl"],CJK:["Hans","Hant","Kana","Kore","Jpan","Yiii"],SouthEastAsian:["Batk","Bugi","Java","Khmr","Laoo","Mymr","Thai"],Mongolian:["Mong"],SignWriting:["Sgnw"],NativeAmerican:["Cher","Cans"],Special:["Zyyy"]},rtlscripts:["Arab","Hebr","Syrc","Nkoo","Thaa"],regiongroups:{WW:1,SP:1,AM:2,EU:3,ME:3,AF:3,AS:4,PA:4},territories:{AC:["en"],AD:["ca","es","fr"],AE:["ar","ml","ps","bal","fa"],AF:["fa","ps","haz","uz-arab","tk-latn","prd","bal","ug-arab","kk-arab"],AG:["en","pt"],AI:["en"],AL:["sq","el","mk"],AM:["hy","az-latn","ku-latn"],AO:["pt","umb","kmb","ln"],AQ:["und"],AR:["es","cy","gn"],AS:["sm","en"],AT:["de","hr","sl","hu"],AU:["en","zh-hant","it"],AW:["nl","pap","en"],AX:["sv"],AZ:["az-latn","az-cyrl","ku-latn"],BA:["bs-cyrl","bs-latn","hr","sr-cyrl","sr-latn"],BB:["en"],BD:["bn","rkt","syl","ccp","my","grt","mni"],BE:["nl","en","fr","wa","de"],BF:["mos","dyu","fr"],BG:["bg","tr"],BH:["ar","ml"],BI:["rn","fr","sw"],BJ:["fr","fon","yo"],BL:["fr"],BM:["en"],BN:["ms-latn","zh-hant","ms-arab","en"],BO:["es","qu","ay","gn"],BQ:["pap","nl"],BR:["pt","de","it","ja","ko","kgp","gub","xav"],BS:["en"],BT:["dz","ne","tsj","lep"],BV:["und"],BW:["en","tn","af"],BY:["be","ru"],BZ:["en","es"],CA:["en","fr","it","de","cr-cans","crk","yi","iu","moe","crj","atj","crl","csw","crm","ikt","dgr","den","scs","nsk","chp","gwi"],CC:["ms-arab","en"],CD:["sw","lua","swc","fr","ln","lu","kg","lol","rw"],CF:["fr","sg","ln"],CG:["fr","ln"],CH:["de","fr","gsw","it","lmo","rm","rmo","wae"],CI:["fr","bci","sef","daf","kfo","bqv"],CK:["en"],CL:["es"],CM:["fr","en","bum","ff","ewo","ybb","bbj","nnh","bkm","bas","bax","byv","mua","maf","bfd","bss","kkj","dua","mgo","ar","jgo","ksf","agq","ha-arab","nmg","yav"],CN:["zh-hans","ii","ug-arab","za","mn-mong","bo","ko","kk-arab","lis","ky-arab","nbf","khb","tdd","lcp","en","ru","vi","uz-cyrl"],CO:["es"],CP:["und"],CR:["es"],CU:["es"],CV:["kea","pt"],CW:["pap","nl","es"],CX:["en"],CY:["el","tr","hy","ar"],CZ:["cs","de","pl"],DE:["de","en","nds","tr","hr","it","ku-latn","ru","el","ksh","pl","es","nl","da","dsb"],DG:["en"],DJ:["aa","so","ar","fr"],DK:["da","de","kl"],DM:["en"],DO:["es","en"],DZ:["ar","fr","kab"],EA:["es"],EC:["es"],EE:["et","ru"],EG:["ar","el"],EH:["ar"],ER:["ti","en","tig","ar","aa","ssy","byn"],ES:["es","en","ca","gl","eu","ast"],ET:["en","am","om","so","ti","sid","wal","aa"],FI:["fi","sv","ru","en","et","rmf","se","smn","sms"],FJ:["en","hi","fj"],FK:["en"],FM:["chk","pon","kos","yap","en","uli"],FO:["fo"],FR:["fr","en","oc","it","pt","gsw","br","co","ca","nl","eu","ia"],GA:["fr","puu"],GB:["en","sco","pa-guru","cy","bn","zh-hant","syl","el","it","ks-arab","gd","yi","ml","ga","fr","kw"],GD:["en"],GE:["ka","ru","hy","ab","os","ku-latn"],GF:["fr","gcr","zh-hant"],GG:["en"],GH:["ak","en","ee","abr","gaa","ha-latn","saf"],GI:["en"],GL:["kl","da"],GM:["en","man-latn"],GN:["fr","ff","man-nkoo","sus","kpe"],GP:["fr"],GQ:["es","fan","fr","bvb"],GR:["el","mk","tr","bg","sq"],GS:["und"],GT:["es"],GU:["en","ch"],GW:["pt"],GY:["en"],HK:["zh-hant","en","zh-hans"],HM:["und"],HN:["es","en"],HR:["hr","it"],HT:["ht","fr"],HU:["hu","de","ro","hr","sk","sl"],IC:["es"],ID:["id","jv","su","mad","ms-arab","min","bya","bjn","ban","bug","ace","bew","sas","bbc","zh-hant","mak","ljp","rej","gor","nij","kge","aoz","kvr","lbw","rob","mdr","sxn"],IE:["en","ga"],IL:["he","ar","ru","ro","yi","en","pl","hu","am","ti","ml"],IM:["en","gv"],IN:["hi","en","bn","te","mr","ta","ur","gu","kn","ml","or","pa-guru","bho","awa","as","bgc","mag","mwr","mai","hne","dcc","bjj","ne","sat","wtm","rkt","ks-arab","kok","swv","gbm","lmn","sd-arab","gon-telu","kfy","doi","kru","sck","tcy","wbq","xnr","wbr","khn","brx","noe","bhb","mni","raj","hoc","mtr","unr-beng","bhi","hoj","kha","kfr","grt","unx-beng","bfy","srx","saz","ccp","sd-deva","bfq","ria","bo","bft","bra","lep","btv","lif-deva","lah","sa","kht","dv","dz"],IO:["en"],IQ:["ar","ckb","fa","syr"],IR:["fa","az-arab","glk","ckb","tk-latn","sdh","lrc","ar","bal","rmt","bqi","luz","lki","prd","hy","ps","ka","kk-arab"],IS:["is","da"],IT:["it","en","nap","scn","fur","de","fr","sl","ca","el","hr"],JE:["en"],JM:["en"],JO:["ar"],JP:["ja","ryu","ko"],KE:["en","sw","ki","luy","luo","kam","kln","guz","mer","mas","ebu","so","dav","teo","pko","om","saq","ar","pa-guru","gu"],KG:["ky-cyrl","ru"],KH:["km","cja","kdt"],KI:["en","gil"],KM:["ar","fr","zdj"],KN:["en"],KP:["ko"],KR:["ko"],KW:["ar"],KY:["en"],KZ:["ru","kk-cyrl","de","ug-cyrl"],LA:["lo","kjg","kdt"],LB:["ar","hy","ku-arab","fr","en"],LC:["en"],LI:["de","gsw","wae"],LK:["si","ta","en"],LR:["en","kpe","vai-vaii","men","vai-latn"],LS:["st","zu","ss","en","xh"],LT:["lt","ru"],LU:["fr","lb","de"],LV:["lv","ru"],LY:["ar"],MA:["ar","zgh","fr","tzm-latn","shi-latn","shi-tfng","rif","es"],MC:["fr"],MD:["ro","uk","bg","gag","ru"],ME:["sr-latn","sq","sr-cyrl"],MF:["fr"],MG:["mg","fr","en"],MH:["en","mh"],MK:["mk","sq","tr"],ML:["bm","fr","ffm","snk","mwk","ses","tmh","khq","dtm","kao","ar","bmq","bze"],MM:["my","shn","mnw","kht"],MN:["mn-cyrl","kk-arab","zh-hans","ru","ug-cyrl"],MO:["zh-hant","pt","zh-hans","en"],MP:["en","ch"],MQ:["fr"],MR:["ar","fr","ff","wo"],MS:["en"],MT:["mt","en"],MU:["mfe","en","bho","ur","fr","ta"],MV:["dv"],MW:["en","ny","tum","zu"],MX:["es","yua","nhe","nhw","maz","nch"],MY:["ms-latn","en","zh-hant","ta","bjn","jv","zmi","ml","bug"],MZ:["pt","vmw","ndc","ts","ngl","seh","mgh","rng","ny","yao","sw","zu"],NA:["af","kj","ng","naq","en","de","tn"],NC:["fr"],NE:["ha-latn","fr","dje","fuq","tmh","ar","twq"],NF:["en"],NG:["en","pcm","ha-latn","ig","yo","fuv","tiv","efi","ibb","ha-arab","bin","kaj","kcg","ar","cch","amo"],NI:["es"],NL:["nl","en","li","fy","gos","id","zea","rif","tr"],NO:["nb","nn","se"],NP:["ne","mai","bho","new","jml","taj","awa","thl","bap","tdg","thr","mgp","lif-deva","thq","mrd","bfy","xsr","rjs","tsf","hi","ggn","gvr","bo","tkt","tdh","bn","unr-deva","lep"],NR:["en","na"],NU:["en","niu"],NZ:["en","mi"],OM:["ar","bal","fa"],PA:["es","en","zh-hant"],PE:["es","qu","ay"],PF:["fr","ty","zh-hant"],PG:["tpi","en","ho"],PH:["en","fil","es","ceb","ilo","hil","bik","war","bhk","pam","pag","mdh","tsg","zh-hant","bto","hnn","tbw","bku"],PK:["ur","pa-arab","en","lah","ps","sd-arab","skr","bal","brh","hno","fa","hnd","tg-arab","gju","bft","kvx","khw","mvy","kxp","gjk","ks-arab","btv"],PL:["pl","be","uk","csb","de","lt"],PM:["fr","en"],PN:["en"],PR:["es","en"],PS:["ar"],PT:["pt","gl"],PW:["pau","en"],PY:["gn","es","de"],QA:["ar","fa","ml"],RE:["fr","rcf","ta"],RO:["ro","hu","de","tr","sr-latn","bg","el","pl"],RS:["sr-cyrl","sr-latn","sq","hu","ro","hr","sk","uk"],RU:["ru","tt","ba","cv","hy","ce","av","udm","chm","sah","os","kbd","myv","dar","bua","mdf","kum","kv","lez","krc","inh","tyv","az-cyrl","ady","krl","koi","lbe","mrj","alt","fi","sr-latn","mn-cyrl","cu"],RW:["rw","fr","en"],SA:["ar"],SB:["en"],SC:["crs","fr","en"],SD:["ar","en","nus","ha-arab"],SE:["sv","fi","fit","se","rmu","yi","smj","sma","ia"],SG:["en","zh-hans","ms-latn","ta","ml","pa-guru"],SH:["en"],SI:["sl","hu","it"],SJ:["nb","ru"],SK:["sk","hu","uk","pl","de"],SL:["kri","en","men","tem"],SM:["it","eo"],SN:["fr","wo","ff","srr","dyo"],SO:["so","ar","sw","om"],SR:["nl","srn","zh-hant"],SS:["ar","en"],ST:["pt"],SV:["es"],SX:["en","es","vic","nl"],SY:["ar","ku-latn","fr","hy","syr"],SZ:["en","ss","zu","ts"],TA:["en"],TC:["en"],TD:["fr","ar"],TF:["fr"],TG:["fr","ee"],TH:["th","tts","nod","sou","mfa","zh-hant","kxm","kdt","mnw","shn","lcp","lwl"],TJ:["tg-cyrl","fa","ar"],TK:["en","tkl"],TL:["pt","tet"],TM:["tk-latn","ru","uz-latn","ku-latn"],TN:["ar","fr"],TO:["to","en"],TR:["tr","ku-latn","zza","kbd","az-latn","ar","bgx","bg","ady","hy","ka","sr-latn","sq","ab","el","uz-latn","ky-latn","kk-cyrl"],TT:["en","es"],TV:["tvl","en"],TW:["zh-hant","trv"],TZ:["sw","en","suk","nym","kde","bez","ksb","mas","mgy","asa","lag","jmc","rof","vun","rwk","sbp"],UA:["uk","ru","pl","yi","rue","be","ro","bg","tr","hu","el"],UG:["sw","lg","nyn","cgg","xog","en","teo","laj","ach","myx","rw","ttj","hi"],UM:["en"],US:["en","es","zh-hant","fr","de","fil","it","vi","ko","ru","nv","yi","haw","chr","lkt","ik"],UY:["es"],UZ:["uz-latn","uz-cyrl","ru","kaa","tr"],VA:["it","la"],VC:["en"],VE:["es"],VG:["en"],VI:["en"],VN:["vi","zh-hant","cjm"],VU:["bi","en","fr"],WF:["wls","fr","fud"],WS:["sm","en"],XK:["sq","sr-cyrl","sr-latn"],YE:["ar"],YT:["swb","fr","buc","sw"],ZA:["en","zu","xh","af","nso","tn","st","ts","ss","ve","hi","nr","sw"],ZM:["en","bem","ny","loz"],ZW:["en","sn","nd","mxc","ndc","kck","ny","ve","tn"],ZZ:[]}}
}(jQuery),function(a){"use strict";a.uls.data.isRedirect=function(b){return void 0!==a.uls.data.languages[b]&&1===a.uls.data.languages[b].length?a.uls.data.languages[b][0]:!1},a.uls.data.getScript=function(b){var c=a.uls.data.isRedirect(b);return c?a.uls.data.getScript(c):a.uls.data.languages[b]?a.uls.data.languages[b][0]:"Zyyy"},a.uls.data.getRegions=function(b){var c=a.uls.data.isRedirect(b);return c?a.uls.data.getRegions(c):a.uls.data.languages[b]&&a.uls.data.languages[b][1]||"UNKNOWN"},a.uls.data.getAutonym=function(b){var c=a.uls.data.isRedirect(b);return c?a.uls.data.getAutonym(c):a.uls.data.languages[b]&&a.uls.data.languages[b][2]||b},a.uls.data.getAutonyms=function(){var b,c={};for(b in a.uls.data.languages)a.uls.data.isRedirect(b)||(c[b]=a.uls.data.getAutonym(b));return c},a.uls.data.getAllRegions=function(){var b,c=[];for(b in a.uls.data.regiongroups)c.push(b);return c},a.uls.data.getLanguagesInScript=function(b){return a.uls.data.getLanguagesInScripts([b])},a.uls.data.getLanguagesInScripts=function(b){var c,d,e=[];for(c in a.uls.data.languages)if(!a.uls.data.isRedirect(c))for(d=0;d<b.length;d++)if(b[d]===a.uls.data.getScript(c)){e.push(c);break}return e},a.uls.data.getLanguagesInRegion=function(b){return a.uls.data.getLanguagesInRegions([b])},a.uls.data.getLanguagesInRegions=function(b){var c,d,e=[];for(c in a.uls.data.languages)if(!a.uls.data.isRedirect(c))for(d=0;d<b.length;d++)if(-1!==a.inArray(b[d],a.uls.data.getRegions(c))){e.push(c);break}return e},a.uls.data.getLanguagesInRegionGroup=function(b){return a.uls.data.getLanguagesInRegions(a.uls.data.getRegionsInGroup(b))},a.uls.data.getLanguagesByScriptInRegion=function(b){var c,d,e={};for(c in a.uls.data.languages)a.uls.data.isRedirect(c)||-1!==a.inArray(b,a.uls.data.getRegions(c))&&(d=a.uls.data.getScript(c),void 0===e[d]&&(e[d]=[]),e[d].push(c));return e},a.uls.data.getLanguagesByScriptGroupInRegion=function(b){return a.uls.data.getLanguagesByScriptGroupInRegions([b])},a.uls.data.getAllLanguagesByScriptGroup=function(){return a.uls.data.getLanguagesByScriptGroupInRegions(a.uls.data.getAllRegions())},a.uls.data.getLanguagesByScriptGroup=function(b){var c,d,e,f={};for(c in b)d=a.uls.data.isRedirect(c)||c,e=a.uls.data.getScriptGroupOfLanguage(d),f[e]||(f[e]=[]),-1===a.inArray(d,f[e])&&f[e].push(d);return f},a.uls.data.getLanguagesByScriptGroupInRegions=function(b){var c,d,e,f={};for(c in a.uls.data.languages)if(!a.uls.data.isRedirect(c))for(d=0;d<b.length;d++)if(-1!==a.inArray(b[d],a.uls.data.getRegions(c))){e=a.uls.data.getScriptGroupOfLanguage(c),void 0===f[e]&&(f[e]=[]),f[e].push(c);break}return f},a.uls.data.getAllLanguagesByRegionAndScript=function(){var b,c,d,e,f,g,h,i={};for(b in a.uls.data.regiongroups)c=a.uls.data.regiongroups[b],void 0===i[c]&&(i[c]={}),i[c][b]={};for(d in a.uls.data.languages)if(!a.uls.data.isRedirect(d))for(e=a.uls.data.getScript(d),f=a.uls.data.getGroupOfScript(e),g=a.uls.data.getRegions(d),h=0;h<g.length;h++)b=g[h],c=a.uls.data.regiongroups[b],void 0===i[c][b][f]&&(i[c][b][f]={}),void 0===i[c][b][f][e]&&(i[c][b][f][e]=[]),i[c][b][f][e].push(d);return i},a.uls.data.getRegionsInGroup=function(b){var c,d=[];for(c in a.uls.data.regiongroups)a.uls.data.regiongroups[c]===b&&d.push(c);return d},a.uls.data.getGroupOfScript=function(b){var c;for(c in a.uls.data.scriptgroups)if(-1!==a.inArray(b,a.uls.data.scriptgroups[c]))return c;return"Other"},a.uls.data.getScriptGroupOfLanguage=function(b){return a.uls.data.getGroupOfScript(a.uls.data.getScript(b))},a.uls.data.sortByAutonym=function(b,c){var d=a.uls.data.getAutonym(b)||b,e=a.uls.data.getAutonym(c)||c;return d.toLowerCase()<e.toLowerCase()?-1:1},a.uls.data.isRtl=function(b){return-1!==a.inArray(a.uls.data.getScript(b),a.uls.data.rtlscripts)},a.uls.data.getDir=function(b){return a.uls.data.isRtl(b)?"rtl":"ltr"},a.uls.data.getLanguagesInTerritory=function(b){return a.uls.data.territories[b]},a.uls.data.addLanguage=function(b,c){a.uls.data.languages[b]=c.target?[c.target]:[c.script,c.regions,c.autonym]},a.uls.data.deleteLanguage=function(b){return a.uls.data.languages[b]?(delete a.uls.data.languages[b],!0):!1}}(jQuery),function(){function a(a){return"\\u"+(a+65536).toString(16).substr(-4)}function b(b,c,d){var e;return b===c?a(b):(e=a(b)+"-"+a(c),d?"["+e+"]":e)}function c(a,b){var c,d,e,f,g,h,i,j,k;return c=56320,d=57343,e=55296+(a-65536>>10),g=56320+(a-65536&1023),f=55296+(b-65536>>10),h=56320+(b-65536&1023),e===f?[{hi:[e,f],lo:[g,h]}]:(i=[],j=55296+(a-65536+1023>>10),k=55296+(b-65536-1023>>10),j>e&&i.push({hi:[e,e],lo:[g,d]}),k>=j&&i.push({hi:[j,k],lo:[c,d]}),f>k&&i.push({hi:[f,f],lo:[c,h]}),i)}var d;d={},d.splitCharacters=function(a){return a.split(/(?![\uDC00-\uDFFF])/g)},d.charRangeArrayRegexp=function(d){var e,f,g,h,i,j,k,l,m,n=[],o=[];for(e=0;e<d.length;e++)if(k=d[e],"number"==typeof k&&65535>=k){if(k>=55296&&57343>=k)throw new Error("Surrogate: "+k.toString(16));if(k>1114111)throw new Error("Character code too high: "+k.toString(16));n.push(a(k))}else if("number"==typeof k&&k>65535)i=55296+(k-65536>>10),j=56320+(k-65536&1023),o.push(a(i)+a(j));else{if(g=k[0],h=k[1],g>h)throw new Error(g.toString(16)+" > "+h.toString(16));if(h>1114111)throw new Error("Character code too high: "+h.toString(16));if(h>=55296&&57343>=g)throw new Error("range includes surrogates: "+g.toString(16)+"-"+h.toString(16));for(65535>=h?(n.push(b(g,h)),m=[]):65535>=g&&h>65535?(n.push(b(g,65535)),m=c(65536,h)):g>65535&&(m=c(g,h)),f=0;f<m.length;f++)l=m[f],i=b(l.hi[0],l.hi[1],!0),j=b(l.lo[0],l.lo[1],!0),o.push(i+j)}return 1!==n.length||n[0].match(/-/)?n.length>0&&o.unshift("["+n.join("")+"]"):o.unshift(n[0]),o.join("|")},window.unicodeJS=d}(),unicodeJS.TextString=function(a){this.clusters=unicodeJS.graphemebreak.splitClusters(a)},unicodeJS.TextString.prototype.read=function(a){var b=this.clusters[a];return void 0!==b?b:null},unicodeJS.TextString.prototype.getLength=function(){return this.clusters.length},unicodeJS.TextString.prototype.substring=function(a,b){var c=new unicodeJS.TextString("");return c.clusters=this.clusters.slice(a,b),c},unicodeJS.TextString.prototype.getString=function(){return this.clusters.join("")},unicodeJS.graphemebreakproperties={CR:[13],LF:[10],Control:[[0,9],[11,12],[14,31],[127,159],173,[1536,1540],1564,1757,1807,6158,8203,[8206,8207],8232,8233,[8234,8238],[8288,8292],8293,[8294,8303],65279,[65520,65528],[65529,65531],69821,[119155,119162],917504,917505,[917506,917535],[917536,917631],[917632,917759],[918e3,921599]],Extend:[[768,879],[1155,1159],[1160,1161],[1425,1469],1471,[1473,1474],[1476,1477],1479,[1552,1562],[1611,1631],1648,[1750,1756],[1759,1764],[1767,1768],[1770,1773],1809,[1840,1866],[1958,1968],[2027,2035],[2070,2073],[2075,2083],[2085,2087],[2089,2093],[2137,2139],[2276,2302],[2304,2306],2362,2364,[2369,2376],2381,[2385,2391],[2402,2403],2433,2492,2494,[2497,2500],2509,2519,[2530,2531],[2561,2562],2620,[2625,2626],[2631,2632],[2635,2637],2641,[2672,2673],2677,[2689,2690],2748,[2753,2757],[2759,2760],2765,[2786,2787],2817,2876,2878,2879,[2881,2884],2893,2902,2903,[2914,2915],2946,3006,3008,3021,3031,[3134,3136],[3142,3144],[3146,3149],[3157,3158],[3170,3171],3260,3263,3266,3270,[3276,3277],[3285,3286],[3298,3299],3390,[3393,3396],3405,3415,[3426,3427],3530,3535,[3538,3540],3542,3551,3633,[3636,3642],[3655,3662],3761,[3764,3769],[3771,3772],[3784,3789],[3864,3865],3893,3895,3897,[3953,3966],[3968,3972],[3974,3975],[3981,3991],[3993,4028],4038,[4141,4144],[4146,4151],[4153,4154],[4157,4158],[4184,4185],[4190,4192],[4209,4212],4226,[4229,4230],4237,4253,[4957,4959],[5906,5908],[5938,5940],[5970,5971],[6002,6003],[6068,6069],[6071,6077],6086,[6089,6099],6109,[6155,6157],6313,[6432,6434],[6439,6440],6450,[6457,6459],[6679,6680],6683,6742,[6744,6750],6752,6754,[6757,6764],[6771,6780],6783,[6912,6915],6964,[6966,6970],6972,6978,[7019,7027],[7040,7041],[7074,7077],[7080,7081],7083,7142,[7144,7145],7149,[7151,7153],[7212,7219],[7222,7223],[7376,7378],[7380,7392],[7394,7400],7405,7412,[7616,7654],[7676,7679],[8204,8205],[8400,8412],[8413,8416],8417,[8418,8420],[8421,8432],[11503,11505],11647,[11744,11775],[12330,12333],[12334,12335],[12441,12442],42607,[42608,42610],[42612,42621],42655,[42736,42737],43010,43014,43019,[43045,43046],43204,[43232,43249],[43302,43309],[43335,43345],[43392,43394],43443,[43446,43449],43452,[43561,43566],[43569,43570],[43573,43574],43587,43596,43696,[43698,43700],[43703,43704],[43710,43711],43713,[43756,43757],43766,44005,44008,44013,64286,[65024,65039],[65056,65062],[65438,65439],66045,[68097,68099],[68101,68102],[68108,68111],[68152,68154],68159,69633,[69688,69702],[69760,69761],[69811,69814],[69817,69818],[69888,69890],[69927,69931],[69933,69940],[70016,70017],[70070,70078],71339,71341,[71344,71349],71351,[94095,94098],119141,[119143,119145],[119150,119154],[119163,119170],[119173,119179],[119210,119213],[119362,119364],[917760,917999]],RegionalIndicator:[[127462,127487]],SpacingMark:[2307,2363,[2366,2368],[2377,2380],[2382,2383],[2434,2435],[2495,2496],[2503,2504],[2507,2508],2563,[2622,2624],2691,[2750,2752],2761,[2763,2764],[2818,2819],2880,[2887,2888],[2891,2892],3007,[3009,3010],[3014,3016],[3018,3020],[3073,3075],[3137,3140],[3202,3203],3262,[3264,3265],[3267,3268],[3271,3272],[3274,3275],[3330,3331],[3391,3392],[3398,3400],[3402,3404],[3458,3459],[3536,3537],[3544,3550],[3570,3571],3635,3763,[3902,3903],3967,4145,[4155,4156],[4182,4183],4228,6070,[6078,6085],[6087,6088],[6435,6438],[6441,6443],[6448,6449],[6451,6456],[6581,6583],6586,[6681,6682],6741,6743,[6765,6770],6916,6965,6971,[6973,6977],[6979,6980],7042,7073,[7078,7079],7082,[7084,7085],7143,[7146,7148],7150,[7154,7155],[7204,7211],[7220,7221],7393,[7410,7411],[43043,43044],43047,[43136,43137],[43188,43203],[43346,43347],43395,[43444,43445],[43450,43451],[43453,43456],[43567,43568],[43571,43572],43597,43755,[43758,43759],43765,[44003,44004],[44006,44007],[44009,44010],44012,69632,69634,69762,[69808,69810],[69815,69816],69932,70018,[70067,70069],[70079,70080],71340,[71342,71343],71350,[94033,94078],119142,119149],L:[[4352,4447],[43360,43388]],V:[[4448,4519],[55216,55238]],T:[[4520,4607],[55243,55291]],LV:[44032,44060,44088,44116,44144,44172,44200,44228,44256,44284,44312,44340,44368,44396,44424,44452,44480,44508,44536,44564,44592,44620,44648,44676,44704,44732,44760,44788,44816,44844,44872,44900,44928,44956,44984,45012,45040,45068,45096,45124,45152,45180,45208,45236,45264,45292,45320,45348,45376,45404,45432,45460,45488,45516,45544,45572,45600,45628,45656,45684,45712,45740,45768,45796,45824,45852,45880,45908,45936,45964,45992,46020,46048,46076,46104,46132,46160,46188,46216,46244,46272,46300,46328,46356,46384,46412,46440,46468,46496,46524,46552,46580,46608,46636,46664,46692,46720,46748,46776,46804,46832,46860,46888,46916,46944,46972,47e3,47028,47056,47084,47112,47140,47168,47196,47224,47252,47280,47308,47336,47364,47392,47420,47448,47476,47504,47532,47560,47588,47616,47644,47672,47700,47728,47756,47784,47812,47840,47868,47896,47924,47952,47980,48008,48036,48064,48092,48120,48148,48176,48204,48232,48260,48288,48316,48344,48372,48400,48428,48456,48484,48512,48540,48568,48596,48624,48652,48680,48708,48736,48764,48792,48820,48848,48876,48904,48932,48960,48988,49016,49044,49072,49100,49128,49156,49184,49212,49240,49268,49296,49324,49352,49380,49408,49436,49464,49492,49520,49548,49576,49604,49632,49660,49688,49716,49744,49772,49800,49828,49856,49884,49912,49940,49968,49996,50024,50052,50080,50108,50136,50164,50192,50220,50248,50276,50304,50332,50360,50388,50416,50444,50472,50500,50528,50556,50584,50612,50640,50668,50696,50724,50752,50780,50808,50836,50864,50892,50920,50948,50976,51004,51032,51060,51088,51116,51144,51172,51200,51228,51256,51284,51312,51340,51368,51396,51424,51452,51480,51508,51536,51564,51592,51620,51648,51676,51704,51732,51760,51788,51816,51844,51872,51900,51928,51956,51984,52012,52040,52068,52096,52124,52152,52180,52208,52236,52264,52292,52320,52348,52376,52404,52432,52460,52488,52516,52544,52572,52600,52628,52656,52684,52712,52740,52768,52796,52824,52852,52880,52908,52936,52964,52992,53020,53048,53076,53104,53132,53160,53188,53216,53244,53272,53300,53328,53356,53384,53412,53440,53468,53496,53524,53552,53580,53608,53636,53664,53692,53720,53748,53776,53804,53832,53860,53888,53916,53944,53972,54e3,54028,54056,54084,54112,54140,54168,54196,54224,54252,54280,54308,54336,54364,54392,54420,54448,54476,54504,54532,54560,54588,54616,54644,54672,54700,54728,54756,54784,54812,54840,54868,54896,54924,54952,54980,55008,55036,55064,55092,55120,55148,55176],LVT:[[44033,44059],[44061,44087],[44089,44115],[44117,44143],[44145,44171],[44173,44199],[44201,44227],[44229,44255],[44257,44283],[44285,44311],[44313,44339],[44341,44367],[44369,44395],[44397,44423],[44425,44451],[44453,44479],[44481,44507],[44509,44535],[44537,44563],[44565,44591],[44593,44619],[44621,44647],[44649,44675],[44677,44703],[44705,44731],[44733,44759],[44761,44787],[44789,44815],[44817,44843],[44845,44871],[44873,44899],[44901,44927],[44929,44955],[44957,44983],[44985,45011],[45013,45039],[45041,45067],[45069,45095],[45097,45123],[45125,45151],[45153,45179],[45181,45207],[45209,45235],[45237,45263],[45265,45291],[45293,45319],[45321,45347],[45349,45375],[45377,45403],[45405,45431],[45433,45459],[45461,45487],[45489,45515],[45517,45543],[45545,45571],[45573,45599],[45601,45627],[45629,45655],[45657,45683],[45685,45711],[45713,45739],[45741,45767],[45769,45795],[45797,45823],[45825,45851],[45853,45879],[45881,45907],[45909,45935],[45937,45963],[45965,45991],[45993,46019],[46021,46047],[46049,46075],[46077,46103],[46105,46131],[46133,46159],[46161,46187],[46189,46215],[46217,46243],[46245,46271],[46273,46299],[46301,46327],[46329,46355],[46357,46383],[46385,46411],[46413,46439],[46441,46467],[46469,46495],[46497,46523],[46525,46551],[46553,46579],[46581,46607],[46609,46635],[46637,46663],[46665,46691],[46693,46719],[46721,46747],[46749,46775],[46777,46803],[46805,46831],[46833,46859],[46861,46887],[46889,46915],[46917,46943],[46945,46971],[46973,46999],[47001,47027],[47029,47055],[47057,47083],[47085,47111],[47113,47139],[47141,47167],[47169,47195],[47197,47223],[47225,47251],[47253,47279],[47281,47307],[47309,47335],[47337,47363],[47365,47391],[47393,47419],[47421,47447],[47449,47475],[47477,47503],[47505,47531],[47533,47559],[47561,47587],[47589,47615],[47617,47643],[47645,47671],[47673,47699],[47701,47727],[47729,47755],[47757,47783],[47785,47811],[47813,47839],[47841,47867],[47869,47895],[47897,47923],[47925,47951],[47953,47979],[47981,48007],[48009,48035],[48037,48063],[48065,48091],[48093,48119],[48121,48147],[48149,48175],[48177,48203],[48205,48231],[48233,48259],[48261,48287],[48289,48315],[48317,48343],[48345,48371],[48373,48399],[48401,48427],[48429,48455],[48457,48483],[48485,48511],[48513,48539],[48541,48567],[48569,48595],[48597,48623],[48625,48651],[48653,48679],[48681,48707],[48709,48735],[48737,48763],[48765,48791],[48793,48819],[48821,48847],[48849,48875],[48877,48903],[48905,48931],[48933,48959],[48961,48987],[48989,49015],[49017,49043],[49045,49071],[49073,49099],[49101,49127],[49129,49155],[49157,49183],[49185,49211],[49213,49239],[49241,49267],[49269,49295],[49297,49323],[49325,49351],[49353,49379],[49381,49407],[49409,49435],[49437,49463],[49465,49491],[49493,49519],[49521,49547],[49549,49575],[49577,49603],[49605,49631],[49633,49659],[49661,49687],[49689,49715],[49717,49743],[49745,49771],[49773,49799],[49801,49827],[49829,49855],[49857,49883],[49885,49911],[49913,49939],[49941,49967],[49969,49995],[49997,50023],[50025,50051],[50053,50079],[50081,50107],[50109,50135],[50137,50163],[50165,50191],[50193,50219],[50221,50247],[50249,50275],[50277,50303],[50305,50331],[50333,50359],[50361,50387],[50389,50415],[50417,50443],[50445,50471],[50473,50499],[50501,50527],[50529,50555],[50557,50583],[50585,50611],[50613,50639],[50641,50667],[50669,50695],[50697,50723],[50725,50751],[50753,50779],[50781,50807],[50809,50835],[50837,50863],[50865,50891],[50893,50919],[50921,50947],[50949,50975],[50977,51003],[51005,51031],[51033,51059],[51061,51087],[51089,51115],[51117,51143],[51145,51171],[51173,51199],[51201,51227],[51229,51255],[51257,51283],[51285,51311],[51313,51339],[51341,51367],[51369,51395],[51397,51423],[51425,51451],[51453,51479],[51481,51507],[51509,51535],[51537,51563],[51565,51591],[51593,51619],[51621,51647],[51649,51675],[51677,51703],[51705,51731],[51733,51759],[51761,51787],[51789,51815],[51817,51843],[51845,51871],[51873,51899],[51901,51927],[51929,51955],[51957,51983],[51985,52011],[52013,52039],[52041,52067],[52069,52095],[52097,52123],[52125,52151],[52153,52179],[52181,52207],[52209,52235],[52237,52263],[52265,52291],[52293,52319],[52321,52347],[52349,52375],[52377,52403],[52405,52431],[52433,52459],[52461,52487],[52489,52515],[52517,52543],[52545,52571],[52573,52599],[52601,52627],[52629,52655],[52657,52683],[52685,52711],[52713,52739],[52741,52767],[52769,52795],[52797,52823],[52825,52851],[52853,52879],[52881,52907],[52909,52935],[52937,52963],[52965,52991],[52993,53019],[53021,53047],[53049,53075],[53077,53103],[53105,53131],[53133,53159],[53161,53187],[53189,53215],[53217,53243],[53245,53271],[53273,53299],[53301,53327],[53329,53355],[53357,53383],[53385,53411],[53413,53439],[53441,53467],[53469,53495],[53497,53523],[53525,53551],[53553,53579],[53581,53607],[53609,53635],[53637,53663],[53665,53691],[53693,53719],[53721,53747],[53749,53775],[53777,53803],[53805,53831],[53833,53859],[53861,53887],[53889,53915],[53917,53943],[53945,53971],[53973,53999],[54001,54027],[54029,54055],[54057,54083],[54085,54111],[54113,54139],[54141,54167],[54169,54195],[54197,54223],[54225,54251],[54253,54279],[54281,54307],[54309,54335],[54337,54363],[54365,54391],[54393,54419],[54421,54447],[54449,54475],[54477,54503],[54505,54531],[54533,54559],[54561,54587],[54589,54615],[54617,54643],[54645,54671],[54673,54699],[54701,54727],[54729,54755],[54757,54783],[54785,54811],[54813,54839],[54841,54867],[54869,54895],[54897,54923],[54925,54951],[54953,54979],[54981,55007],[55009,55035],[55037,55063],[55065,55091],[55093,55119],[55121,55147],[55149,55175],[55177,55203]]},function(){var a,b,c,d=unicodeJS.graphemebreakproperties,e="[^\\ud800-\\udfff]|[\\ud800-\\udbff][\\udc00-\\udfff]",f=unicodeJS.graphemebreak={},g={};for(a in d)g[a]=unicodeJS.charRangeArrayRegexp(d[a]);b=["\\r\\n",g.Control,"(?:"+g.L+")*(?:"+g.V+")+(?:"+g.T+")*","(?:"+g.L+")*(?:"+g.LV+")(?:"+g.V+")*(?:"+g.T+")*","(?:"+g.L+")*(?:"+g.LVT+")(?:"+g.T+")*","(?:"+g.L+")+","(?:"+g.T+")+","(?:"+g.RegionalIndicator+")+","(?:"+e+")(?:"+g.Extend+"|"+g.SpacingMark+")+",e],c=new RegExp("("+b.join("|")+")"),f.splitClusters=function(a){var b,d,e,f=[];for(d=a.split(c),b=0,e=d.length;e>b;b++)""!==d[b]&&f.push(d[b]);return f}}(),unicodeJS.wordbreakproperties={DoubleQuote:[34],SingleQuote:[39],HebrewLetter:[[1488,1514],[1520,1522],64285,[64287,64296],[64298,64310],[64312,64316],64318,[64320,64321],[64323,64324],[64326,64335]],CR:[13],LF:[10],Newline:[[11,12],133,8232,8233],Extend:[[768,879],[1155,1159],[1160,1161],[1425,1469],1471,[1473,1474],[1476,1477],1479,[1552,1562],[1611,1631],1648,[1750,1756],[1759,1764],[1767,1768],[1770,1773],1809,[1840,1866],[1958,1968],[2027,2035],[2070,2073],[2075,2083],[2085,2087],[2089,2093],[2137,2139],[2276,2302],[2304,2306],2307,2362,2363,2364,[2366,2368],[2369,2376],[2377,2380],2381,[2382,2383],[2385,2391],[2402,2403],2433,[2434,2435],2492,[2494,2496],[2497,2500],[2503,2504],[2507,2508],2509,2519,[2530,2531],[2561,2562],2563,2620,[2622,2624],[2625,2626],[2631,2632],[2635,2637],2641,[2672,2673],2677,[2689,2690],2691,2748,[2750,2752],[2753,2757],[2759,2760],2761,[2763,2764],2765,[2786,2787],2817,[2818,2819],2876,2878,2879,2880,[2881,2884],[2887,2888],[2891,2892],2893,2902,2903,[2914,2915],2946,[3006,3007],3008,[3009,3010],[3014,3016],[3018,3020],3021,3031,[3073,3075],[3134,3136],[3137,3140],[3142,3144],[3146,3149],[3157,3158],[3170,3171],[3202,3203],3260,3262,3263,[3264,3268],3270,[3271,3272],[3274,3275],[3276,3277],[3285,3286],[3298,3299],[3330,3331],[3390,3392],[3393,3396],[3398,3400],[3402,3404],3405,3415,[3426,3427],[3458,3459],3530,[3535,3537],[3538,3540],3542,[3544,3551],[3570,3571],3633,[3636,3642],[3655,3662],3761,[3764,3769],[3771,3772],[3784,3789],[3864,3865],3893,3895,3897,[3902,3903],[3953,3966],3967,[3968,3972],[3974,3975],[3981,3991],[3993,4028],4038,[4139,4140],[4141,4144],4145,[4146,4151],4152,[4153,4154],[4155,4156],[4157,4158],[4182,4183],[4184,4185],[4190,4192],[4194,4196],[4199,4205],[4209,4212],4226,[4227,4228],[4229,4230],[4231,4236],4237,4239,[4250,4252],4253,[4957,4959],[5906,5908],[5938,5940],[5970,5971],[6002,6003],[6068,6069],6070,[6071,6077],[6078,6085],6086,[6087,6088],[6089,6099],6109,[6155,6157],6313,[6432,6434],[6435,6438],[6439,6440],[6441,6443],[6448,6449],6450,[6451,6456],[6457,6459],[6576,6592],[6600,6601],[6679,6680],[6681,6682],6683,6741,6742,6743,[6744,6750],6752,6753,6754,[6755,6756],[6757,6764],[6765,6770],[6771,6780],6783,[6912,6915],6916,6964,6965,[6966,6970],6971,6972,[6973,6977],6978,[6979,6980],[7019,7027],[7040,7041],7042,7073,[7074,7077],[7078,7079],[7080,7081],7082,7083,[7084,7085],7142,7143,[7144,7145],[7146,7148],7149,7150,[7151,7153],[7154,7155],[7204,7211],[7212,7219],[7220,7221],[7222,7223],[7376,7378],[7380,7392],7393,[7394,7400],7405,[7410,7411],7412,[7616,7654],[7676,7679],[8204,8205],[8400,8412],[8413,8416],8417,[8418,8420],[8421,8432],[11503,11505],11647,[11744,11775],[12330,12333],[12334,12335],[12441,12442],42607,[42608,42610],[42612,42621],42655,[42736,42737],43010,43014,43019,[43043,43044],[43045,43046],43047,[43136,43137],[43188,43203],43204,[43232,43249],[43302,43309],[43335,43345],[43346,43347],[43392,43394],43395,43443,[43444,43445],[43446,43449],[43450,43451],43452,[43453,43456],[43561,43566],[43567,43568],[43569,43570],[43571,43572],[43573,43574],43587,43596,43597,43643,43696,[43698,43700],[43703,43704],[43710,43711],43713,43755,[43756,43757],[43758,43759],43765,43766,[44003,44004],44005,[44006,44007],44008,[44009,44010],44012,44013,64286,[65024,65039],[65056,65062],[65438,65439],66045,[68097,68099],[68101,68102],[68108,68111],[68152,68154],68159,69632,69633,69634,[69688,69702],[69760,69761],69762,[69808,69810],[69811,69814],[69815,69816],[69817,69818],[69888,69890],[69927,69931],69932,[69933,69940],[70016,70017],70018,[70067,70069],[70070,70078],[70079,70080],71339,71340,71341,[71342,71343],[71344,71349],71350,71351,[94033,94078],[94095,94098],[119141,119142],[119143,119145],[119149,119154],[119163,119170],[119173,119179],[119210,119213],[119362,119364],[917760,917999]],RegionalIndicator:[[127462,127487]],Format:[173,[1536,1540],1564,1757,1807,6158,[8206,8207],[8234,8238],[8288,8292],[8294,8303],65279,[65529,65531],69821,[119155,119162],917505,[917536,917631]],Katakana:[[12337,12341],[12443,12444],12448,[12449,12538],[12540,12542],12543,[12784,12799],[13008,13054],[13056,13143],[65382,65391],65392,[65393,65437],110592],ALetter:[[65,90],[97,122],170,181,186,[192,214],[216,246],[248,442],443,[444,447],[448,451],[452,659],660,[661,687],[688,705],[710,721],[736,740],748,750,[880,883],884,[886,887],890,[891,893],902,[904,906],908,[910,929],[931,1013],[1015,1153],[1162,1319],[1329,1366],1369,[1377,1415],1523,[1568,1599],1600,[1601,1610],[1646,1647],[1649,1747],1749,[1765,1766],[1774,1775],[1786,1788],1791,1808,[1810,1839],[1869,1957],1969,[1994,2026],[2036,2037],2042,[2048,2069],2074,2084,2088,[2112,2136],2208,[2210,2220],[2308,2361],2365,2384,[2392,2401],2417,[2418,2423],[2425,2431],[2437,2444],[2447,2448],[2451,2472],[2474,2480],2482,[2486,2489],2493,2510,[2524,2525],[2527,2529],[2544,2545],[2565,2570],[2575,2576],[2579,2600],[2602,2608],[2610,2611],[2613,2614],[2616,2617],[2649,2652],2654,[2674,2676],[2693,2701],[2703,2705],[2707,2728],[2730,2736],[2738,2739],[2741,2745],2749,2768,[2784,2785],[2821,2828],[2831,2832],[2835,2856],[2858,2864],[2866,2867],[2869,2873],2877,[2908,2909],[2911,2913],2929,2947,[2949,2954],[2958,2960],[2962,2965],[2969,2970],2972,[2974,2975],[2979,2980],[2984,2986],[2990,3001],3024,[3077,3084],[3086,3088],[3090,3112],[3114,3123],[3125,3129],3133,[3160,3161],[3168,3169],[3205,3212],[3214,3216],[3218,3240],[3242,3251],[3253,3257],3261,3294,[3296,3297],[3313,3314],[3333,3340],[3342,3344],[3346,3386],3389,3406,[3424,3425],[3450,3455],[3461,3478],[3482,3505],[3507,3515],3517,[3520,3526],3840,[3904,3911],[3913,3948],[3976,3980],[4256,4293],4295,4301,[4304,4346],4348,[4349,4680],[4682,4685],[4688,4694],4696,[4698,4701],[4704,4744],[4746,4749],[4752,4784],[4786,4789],[4792,4798],4800,[4802,4805],[4808,4822],[4824,4880],[4882,4885],[4888,4954],[4992,5007],[5024,5108],[5121,5740],[5743,5759],[5761,5786],[5792,5866],[5870,5872],[5888,5900],[5902,5905],[5920,5937],[5952,5969],[5984,5996],[5998,6e3],[6176,6210],6211,[6212,6263],[6272,6312],6314,[6320,6389],[6400,6428],[6656,6678],[6917,6963],[6981,6987],[7043,7072],[7086,7087],[7098,7141],[7168,7203],[7245,7247],[7258,7287],[7288,7293],[7401,7404],[7406,7409],[7413,7414],[7424,7467],[7468,7530],[7531,7543],7544,[7545,7578],[7579,7615],[7680,7957],[7960,7965],[7968,8005],[8008,8013],[8016,8023],8025,8027,8029,[8031,8061],[8064,8116],[8118,8124],8126,[8130,8132],[8134,8140],[8144,8147],[8150,8155],[8160,8172],[8178,8180],[8182,8188],8305,8319,[8336,8348],8450,8455,[8458,8467],8469,[8473,8477],8484,8486,8488,[8490,8493],[8495,8500],[8501,8504],8505,[8508,8511],[8517,8521],8526,[8544,8578],[8579,8580],[8581,8584],[9398,9449],[11264,11310],[11312,11358],[11360,11387],[11388,11389],[11390,11492],[11499,11502],[11506,11507],[11520,11557],11559,11565,[11568,11623],11631,[11648,11670],[11680,11686],[11688,11694],[11696,11702],[11704,11710],[11712,11718],[11720,11726],[11728,11734],[11736,11742],11823,12293,12347,12348,[12549,12589],[12593,12686],[12704,12730],[40960,40980],40981,[40982,42124],[42192,42231],[42232,42237],[42240,42507],42508,[42512,42527],[42538,42539],[42560,42605],42606,42623,[42624,42647],[42656,42725],[42726,42735],[42775,42783],[42786,42863],42864,[42865,42887],42888,[42891,42894],[42896,42899],[42912,42922],[43e3,43001],43002,[43003,43009],[43011,43013],[43015,43018],[43020,43042],[43072,43123],[43138,43187],[43250,43255],43259,[43274,43301],[43312,43334],[43360,43388],[43396,43442],43471,[43520,43560],[43584,43586],[43588,43595],[43744,43754],43762,[43763,43764],[43777,43782],[43785,43790],[43793,43798],[43808,43814],[43816,43822],[43968,44002],[44032,55203],[55216,55238],[55243,55291],[64256,64262],[64275,64279],[64336,64433],[64467,64829],[64848,64911],[64914,64967],[65008,65019],[65136,65140],[65142,65276],[65313,65338],[65345,65370],[65440,65470],[65474,65479],[65482,65487],[65490,65495],[65498,65500],[65536,65547],[65549,65574],[65576,65594],[65596,65597],[65599,65613],[65616,65629],[65664,65786],[65856,65908],[66176,66204],[66208,66256],[66304,66334],[66352,66368],66369,[66370,66377],66378,[66432,66461],[66464,66499],[66504,66511],[66513,66517],[66560,66639],[66640,66717],[67584,67589],67592,[67594,67637],[67639,67640],67644,[67647,67669],[67840,67861],[67872,67897],[67968,68023],[68030,68031],68096,[68112,68115],[68117,68119],[68121,68147],[68192,68220],[68352,68405],[68416,68437],[68448,68466],[68608,68680],[69635,69687],[69763,69807],[69840,69864],[69891,69926],[70019,70066],[70081,70084],[71296,71338],[73728,74606],[74752,74850],[77824,78894],[92160,92728],[93952,94020],94032,[94099,94111],[119808,119892],[119894,119964],[119966,119967],119970,[119973,119974],[119977,119980],[119982,119993],119995,[119997,120003],[120005,120069],[120071,120074],[120077,120084],[120086,120092],[120094,120121],[120123,120126],[120128,120132],120134,[120138,120144],[120146,120485],[120488,120512],[120514,120538],[120540,120570],[120572,120596],[120598,120628],[120630,120654],[120656,120686],[120688,120712],[120714,120744],[120746,120770],[120772,120779],[126464,126467],[126469,126495],[126497,126498],126500,126503,[126505,126514],[126516,126519],126521,126523,126530,126535,126537,126539,[126541,126543],[126545,126546],126548,126551,126553,126555,126557,126559,[126561,126562],126564,[126567,126570],[126572,126578],[126580,126583],[126585,126588],126590,[126592,126601],[126603,126619],[126625,126627],[126629,126633],[126635,126651]],MidLetter:[58,183,727,903,1524,8231,65043,65109,65306],MidNum:[44,59,894,1417,[1548,1549],1644,2040,8260,65040,65044,65104,65108,65292,65307],MidNumLet:[46,8216,8217,8228,65106,65287,65294],Numeric:[[48,57],[1632,1641],1643,[1776,1785],[1984,1993],[2406,2415],[2534,2543],[2662,2671],[2790,2799],[2918,2927],[3046,3055],[3174,3183],[3302,3311],[3430,3439],[3664,3673],[3792,3801],[3872,3881],[4160,4169],[4240,4249],[6112,6121],[6160,6169],[6470,6479],[6608,6617],[6784,6793],[6800,6809],[6992,7001],[7088,7097],[7232,7241],[7248,7257],[42528,42537],[43216,43225],[43264,43273],[43472,43481],[43600,43609],[44016,44025],[66720,66729],[69734,69743],[69872,69881],[69942,69951],[70096,70105],[71360,71369],[120782,120831]],ExtendNumLet:[95,[8255,8256],8276,[65075,65076],[65101,65103],65343]},function(){function a(a){var b,c;if("string"!=typeof a)return null;b=unicodeJS.splitCharacters(a)[0];for(c in e)if(e[c].test(b))return c;return null}var b,c=unicodeJS.wordbreakproperties,d=unicodeJS.wordbreak={},e={};for(b in c)e[b]=new RegExp(unicodeJS.charRangeArrayRegexp(c[b]));d.nextBreakOffset=function(a,b,c){return d.moveBreakOffset(1,a,b,c)},d.prevBreakOffset=function(a,b,c){return d.moveBreakOffset(-1,a,b,c)},d.moveBreakOffset=function(b,c,d,e){for(var f,g=d,h=b>0?0:-1;null!==c.read(g+h);)if(g+=b,unicodeJS.wordbreak.isBreak(c,g)){if(e&&(f=a(c.read(g-b+h)),"ALetter"!==f&&"Numeric"!==f&&"Katakana"!==f&&"HebrewLetter"!==f))continue;break}return g},d.isBreak=function(b,c){if(null===b.read(c-1)||null===b.read(c))return!0;var d=[],e=[],f=0,g=0;switch(e.push(a(b.read(c+g))),d.push(a(b.read(c-f-1))),!0){case"CR"===d[0]&&"LF"===e[0]:return!1;case"Newline"===d[0]||"CR"===d[0]||"LF"===d[0]:case"Newline"===e[0]||"CR"===e[0]||"LF"===e[0]:return!0}if("Extend"===e[0]||"Format"===e[0])return!1;for(;"Extend"===d[0]||"Format"===d[0];){if(f++,0>=c-f-1)return!0;d[d.length-1]=a(b.read(c-f-1))}if(!("ALetter"!==d[0]&&"HebrewLetter"!==d[0]||"ALetter"!==e[0]&&"HebrewLetter"!==e[0]))return!1;switch(f++,g++,e.push(a(b.read(c+g))),d.push(a(b.read(c-f-1))),!0){case!("ALetter"!==d[0]&&"HebrewLetter"!==d[0]||"ALetter"!==e[1]&&"HebrewLetter"!==e[1]||"MidLetter"!==e[0]&&"MidNumLet"!==e[0]&&"SingleQuote"!==e[0]):case!("ALetter"!==e[0]&&"HebrewLetter"!==e[0]||"ALetter"!==d[1]&&"HebrewLetter"!==d[1]||"MidLetter"!==d[0]&&"MidNumLet"!==d[0]&&"SingleQuote"!==d[0]):case"HebrewLetter"===d[0]&&"SingleQuote"===e[0]:case"HebrewLetter"===d[0]&&"DoubleQuote"===e[0]&&"HebrewLetter"===e[1]:case"HebrewLetter"===d[1]&&"DoubleQuote"===d[0]&&"HebrewLetter"===e[0]:case"Numeric"===d[0]&&"Numeric"===e[0]:case("ALetter"===d[0]||"HebrewLetter"===d[0])&&"Numeric"===e[0]:case"Numeric"===d[0]&&("ALetter"===e[0]||"HebrewLetter"===e[0]):return!1;case"Numeric"===e[0]&&"Numeric"===d[1]&&("MidNum"===d[0]||"MidNumLet"===d[0]||"SingleQuote"===d[0]):case"Numeric"===d[0]&&"Numeric"===e[1]&&("MidNum"===e[0]||"MidNumLet"===e[0]||"SingleQuote"===e[0]):return!1;case"Katakana"===d[0]&&"Katakana"===e[0]:return!1;case"ExtendNumLet"===e[0]&&("ALetter"===d[0]||"HebrewLetter"===d[0]||"Numeric"===d[0]||"Katakana"===d[0]||"ExtendNumLet"===d[0]):case"ExtendNumLet"===d[0]&&("ALetter"===e[0]||"HebrewLetter"===e[0]||"Numeric"===e[0]||"Katakana"===e[0]):return!1;case"RegionalIndicator"===d[0]&&"RegionalIndicator"===e[0]:return!1}return!0}}(),function(){var a={instances:[]};a.isInstanceOfAny=function(a,b){for(var c=b.length;b[--c];)if(a instanceof b[c])return!0;return!1},a.cloneObject=OO.cloneObject,a.getObjectValues=OO.getObjectValues,a.getObjectKeys=Object.keys,a.compare=OO.compare,a.copy=OO.copy,a.copyDomElements=function(a,b){return a.map(function(a){return b?b.importNode(a,!0):a.cloneNode(!0)})},a.isPlainObject=$.isPlainObject,a.isEmptyObject=$.isEmptyObject,a.isArray=Array.isArray,a.bind=$.proxy,a.indexOf=$.inArray,a.extendObject=$.extend,a.batchSplice=function(){function b(){var a=256,b=[];
return b[a]="a",b.splice(a+1,0,"b"),"a"!==b[a]}var c;return c=b()?function(a,b){var c,d,e,f;return c=Array.prototype.slice.call(arguments,2),d=this.slice(0,a),e=this.slice(a,b),f=this.slice(a+b),this.length=0,this.push.apply(this,d),this.push.apply(this,c),this.push.apply(this,f),e}:Array.prototype.splice,function(b,d,e,f){var g,h,i=0,j=1024,k=e,l=[];if(g=a.isArray(b)?c:b.splice,0===f.length)return g.call(b,d,e);for(;i<f.length;)h=g.apply(b,[i+d,k].concat(f.slice(i,i+j))),k>0&&(l=h),i+=j,k=0;return l}}(),a.insertIntoArray=function(b,c,d){a.batchSplice(b,c,0,d)},a.getProp=function(a){var b,c=a;for(b=1;b<arguments.length;b++){if(void 0===c||null===c)return void 0;c=c[arguments[b]]}return c},a.setProp=function(a){var b,c=a;if(Object(a)===a){for(b=1;b<arguments.length-2;b++){if(void 0===c[arguments[b]]&&(c[arguments[b]]={}),null===c[arguments[b]]||"object"!=typeof c[arguments[b]])return;c=c[arguments[b]]}c[arguments[arguments.length-2]]=arguments[arguments.length-1]}},a.log=function(){},a.dir=function(){},a.debounce=function(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,c||a.apply(e,f)};c&&!d&&a.apply(e,f),clearTimeout(d),d=setTimeout(g,b)}},a.selectEnd=function(a){if(a.focus(),void 0!==a.selectionStart)a.selectionStart=a.selectionEnd=a.value.length;else if(a.createTextRange){var b=a.createTextRange();b.collapse(!1),b.select()}},a.msg=function(){return a.init.platform.getMessage.apply(a.init.platform,arguments)},a.splitClusters=function(a){return a.split("")},a.isUnattachedCombiningMark=function(a){return/^[\u0300-\u036F]+$/.test(a)},a.getByteOffset=function(a,b){return unicodeJS.graphemebreak.splitClusters(a).slice(0,b).join("").length},a.getClusterOffset=function(a,b){return unicodeJS.graphemebreak.splitClusters(a.substring(0,b)).length},a.graphemeSafeSubstring=function(b,c,d,e){var f=a.getByteOffset(b,a.getClusterOffset(b,c)),g=a.getByteOffset(b,a.getClusterOffset(b,d));return f!==g||e?(f>c&&e&&(f=a.getByteOffset(b,a.getClusterOffset(b,c)-1)),g>d&&!e&&(g=a.getByteOffset(b,a.getClusterOffset(b,d)-1)),b.substring(f,g)):""},a.escapeHtml=function(b){return b.replace(/['"<>&]/g,a.escapeHtml.escapeHtmlCharacter)},a.escapeHtml.escapeHtmlCharacter=function(a){switch(a){case"'":return"&#039;";case'"':return"&quot;";case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";default:return a}},a.getHtmlAttributes=function(b){var c,d,e=[];if(!a.isPlainObject(b)||a.isEmptyObject(b))return"";for(c in b){if(d=b[c],d===!0)d=c;else if(d===!1)continue;e.push(c+'="'+a.escapeHtml(String(d))+'"')}return e.join(" ")},a.getOpeningHtmlTag=function(b,c){var d=a.getHtmlAttributes(c);return"<"+b+(d?" "+d:"")+">"},a.getDomAttributes=function(a){var b,c={};for(b=0;b<a.attributes.length;b++)c[a.attributes[b].name]=a.attributes[b].value;return c},a.setDomAttributes=function(a,b,c){var d;if(a.setAttribute&&a.removeAttribute)for(d in b)if(void 0===b[d]||null===b[d])a.removeAttribute(d);else{if(c&&-1===c.indexOf(d.toLowerCase()))continue;a.setAttribute(d,b[d])}},a.getDomElementSummary=function(b,c){var d,e={type:b.nodeName.toLowerCase(),text:b.textContent,attributes:{},children:[]};if(c&&b.nodeType===Node.ELEMENT_NODE&&(e.html=b.outerHTML),b.attributes)for(d=0;d<b.attributes.length;d++)e.attributes[b.attributes[d].name]=b.attributes[d].value;if(b.childNodes)for(d=0;d<b.childNodes.length;d++)b.childNodes[d].nodeType!==Node.TEXT_NODE&&e.children.push(a.getDomElementSummary(b.childNodes[d],c));return e},a.convertDomElements=function(b){return b&&b.nodeType?a.getDomElementSummary(b):b},a.isBlockElement=function(b){var c="string"==typeof b?b:b.nodeName;return-1!==a.indexOf(c.toLowerCase(),a.elementTypes.block)},a.isVoidElement=function(b){var c="string"==typeof b?b:b.nodeName;return-1!==a.indexOf(c.toLowerCase(),a.elementTypes.void)},a.elementTypes={block:["div","p","table","tbody","thead","tfoot","caption","th","tr","td","ul","ol","li","dl","dt","dd","h1","h2","h3","h4","h5","h6","hgroup","article","aside","body","nav","section","footer","header","figure","figcaption","fieldset","details","blockquote","hr","button","canvas","center","col","colgroup","embed","map","object","pre","progress","video"],"void":["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"]},a.createDocumentFromHtml=function(a){var b,c,d;try{if(""===a&&(a="<body></body>"),b=(new DOMParser).parseFromString(a,"text/html"))return b}catch(e){}return c=$('<iframe frameborder="0" width="0" height="0" />'),d=c.get(0),document.documentElement.appendChild(d),b=d.contentWindow&&d.contentWindow.document||d.contentDocument,b.open(),b.write(a),b.close(),d.parentNode.removeChild(d),b.documentElement&&void 0!==b.documentElement.cloneNode(!1)||(b=document.implementation.createHTMLDocument(""),a=a.replace(/^\s*(?:<!doctype[^>]*>)?\s*<html[^>]*>/i,""),a=a.replace(/<\/html>\s*$/i,""),b.documentElement.innerHTML=a),b},a.resolveUrl=function(b,c){var d,e;return"string"==typeof c?(d=a.createDocumentFromHtml(""),e=d.createElement("base"),e.setAttribute("href",c),d.head.appendChild(e)):d=c,e=d.createElement("a"),e.setAttribute("href",b),e.href||b},a.properInnerHtml=function(b){return a.fixupPreBug(b).innerHTML},a.properOuterHtml=function(b){return a.fixupPreBug(b).outerHTML},a.fixupPreBug=function(b){var c,d;return void 0===a.isPreInnerHtmlBroken&&(c=document.createElement("div"),c.innerHTML="<pre>\n\n</pre>",a.isPreInnerHtmlBroken="<pre>\n</pre>"===c.innerHTML),a.isPreInnerHtmlBroken?(d=$(b).clone(),d.find("pre, textarea, listing").each(function(){var a;this.firstChild&&this.firstChild.nodeType===Node.TEXT_NODE&&(a=this.firstChild.data.match(/^(\r\n|\r|\n)/),a&&a[1]&&this.firstChild.insertData(0,a[1]))}),d.get(0)):b},a.contains=function(b,c,d){var e;for(a.isArray(b)||(b=[b]),e=b.length-1;e>=0;e--)if(d&&c===b[e]||$.contains(b[e],c))return!0;return!1},a.now=function(){var a=window.performance,b=a&&a.timing&&a.timing.navigationStart;return b&&"function"==typeof a.now?function(){return b+a.now()}:Date.now}(),a.isMsie=-1!==navigator.userAgent.indexOf("MSIE"),window.ve=a}(),function(){var a=$.Callbacks("memory"),b=[];ve.track=function(c,d){b.push({topic:c,timeStamp:ve.now(),data:d}),a.fire(b)},ve.trackSubscribe=function(b,c){var d=0;a.add(function(a){for(var e;d<a.length;d++)e=a[d],0===e.topic.indexOf(b)&&c.call(e,e.topic,e.data)})},ve.trackSubscribeAll=function(a){ve.trackSubscribe("",a)}}(),ve.init={},ve.init.Platform=function(){OO.EventEmitter.call(this)},OO.mixinClass(ve.init.Platform,OO.EventEmitter),ve.init.Platform.prototype.getExternalLinkUrlProtocolsRegExp=function(){throw new Error("ve.init.Platform.getExternalLinkUrlProtocolsRegExp must be overridden in subclass")},ve.init.Platform.prototype.getModulesUrl=function(){throw new Error("ve.init.Platform.getModulesUrl must be overridden in subclass")},ve.init.Platform.prototype.addMessages=function(){throw new Error("ve.init.Platform.addMessages must be overridden in subclass")},ve.init.Platform.prototype.getMessage=function(){throw new Error("ve.init.Platform.getMessage must be overridden in subclass")},ve.init.Platform.prototype.addParsedMessages=function(){throw new Error("ve.init.Platform.addParsedMessages must be overridden in subclass")},ve.init.Platform.prototype.getParsedMessage=function(){throw new Error("ve.init.Platform.getParsedMessage must be overridden in subclass")},ve.init.Platform.prototype.getSystemPlatform=function(){throw new Error("ve.init.Platform.getSystemPlatform must be overridden in subclass")},ve.init.Platform.prototype.getUserLanguages=function(){throw new Error("ve.init.Platform.getUserLanguages must be overridden in subclass")},ve.init.Platform.prototype.getMediaSources=function(){throw new Error("ve.init.Platform.getMediaSources must be overridden in subclass")},ve.init.Platform.prototype.getLanguageCodes=function(){throw new Error("ve.init.Platform.getLanguageCodes must be overridden in subclass")},ve.init.Platform.prototype.getLanguageName=function(){throw new Error("ve.init.Platform.getLanguageName must be overridden in subclass")},ve.init.Platform.prototype.getLanguageAutonym=function(){throw new Error("ve.init.Platform.getLanguageAutonym must be overridden in subclass")},ve.init.Platform.prototype.getLanguageDirection=function(){throw new Error("ve.init.Platform.getLanguageDirection must be overridden in subclass")},ve.init.Platform.prototype.isInternetExplorer=function(){throw new Error("ve.init.Platform.isInternetExplorer must be overridden in subclass")},ve.init.Platform.prototype.initialize=function(){return $.Deferred().resolve().promise()},ve.init.Platform.prototype.getInitializedPromise=function(){return this.initialized||(this.initialized=this.initialize()),this.initialized},ve.init.Target=function(a){if(OO.EventEmitter.call(this),!$.contains(a[0].ownerDocument,a[0]))throw new Error("Container must be attached to the DOM");this.$element=a,this.surface=null,this.toolbar=null,this.debugBar=null,ve.init.target=this},ve.init.Target.prototype.destroy=function(){this.surface&&(this.surface.destroy(),this.surface=null),this.toolbar&&(this.toolbar.destroy(),this.toolbar=null),this.$element&&(this.$element.remove(),this.$element=null),ve.init.target=null},OO.mixinClass(ve.init.Target,OO.EventEmitter),ve.init.Target.static.toolbarGroups=[{header:OO.ui.deferMsg("visualeditor-toolbar-history"),include:["undo","redo"]},{header:OO.ui.deferMsg("visualeditor-toolbar-paragraph-format"),type:"menu",indicator:"down",title:OO.ui.deferMsg("visualeditor-toolbar-format-tooltip"),include:[{group:"format"}],promote:["paragraph"],demote:["preformatted"]},{header:OO.ui.deferMsg("visualeditor-toolbar-text-style"),type:"list",indicator:"down",icon:"text-style",title:OO.ui.deferMsg("visualeditor-toolbar-style-tooltip"),include:[{group:"textStyle"},"language","clear"],promote:["bold","italic"],demote:["strikethrough","code","underline","language","clear"]},{header:OO.ui.deferMsg("visualeditor-linkinspector-title"),include:["link"]},{header:OO.ui.deferMsg("visualeditor-toolbar-structure"),type:"list",icon:"bullet-list",indicator:"down",include:[{group:"structure"}],demote:["outdent","indent"]},{header:OO.ui.deferMsg("visualeditor-toolbar-insert"),type:"list",icon:"insert",label:"",title:OO.ui.deferMsg("visualeditor-toolbar-insert"),indicator:"down",include:"*",demote:["specialcharacter"]}],ve.init.Target.static.surfaceCommands=["undo","redo","bold","italic","link","clear","underline","subscript","superscript","indent","outdent","commandHelp","paragraph","heading1","heading2","heading3","heading4","heading5","heading6","preformatted","pasteSpecial"],ve.init.Target.static.pasteRules={external:{blacklist:["textStyle/span","alienInline","alienBlock"]},all:null},ve.init.Target.prototype.createSurface=function(a,b){return new ve.ui.DesktopSurface(a,b)},ve.init.Target.prototype.getSurface=function(){return this.surface},ve.init.Target.prototype.getToolbar=function(){return this.toolbar},ve.init.Target.prototype.getDebugBar=function(){return this.debugBar},ve.init.Target.prototype.setupToolbar=function(a){if(!this.surface)throw new Error("Surface must be setup before Toolbar");this.toolbar=new ve.ui.TargetToolbar(this,this.surface,a),this.toolbar.setup(this.constructor.static.toolbarGroups),this.surface.addCommands(this.constructor.static.surfaceCommands),this.toolbar.$element.insertBefore(this.surface.$element)},ve.init.Target.prototype.setupDebugBar=function(){if(!this.surface)throw new Error("Surface must be setup before DebugBar");this.debugBar=new ve.ui.DebugBar(this.surface),this.debugBar.$element.insertAfter(this.surface.$element)},ve.init.sa={},ve.init.sa.Platform=function(){ve.init.Platform.call(this),this.externalLinkUrlProtocolsRegExp=/^https?\:\/\//,this.modulesUrl="extensions/VisualEditor/modules",this.parsedMessages={},this.userLanguages=["en"]},OO.inheritClass(ve.init.sa.Platform,ve.init.Platform),ve.init.sa.Platform.prototype.getExternalLinkUrlProtocolsRegExp=function(){return this.externalLinkUrlProtocolsRegExp},ve.init.sa.Platform.prototype.setModulesUrl=function(a){this.modulesUrl=a},ve.init.sa.Platform.prototype.getModulesUrl=function(){return this.modulesUrl},ve.init.sa.Platform.prototype.addMessages=function(a){$.i18n().load(a,$.i18n().locale)},ve.init.sa.Platform.prototype.getMessage=$.i18n,ve.init.sa.Platform.prototype.addParsedMessages=function(a){for(var b in a)this.parsedMessages[b]=a[b]},ve.init.sa.Platform.prototype.getParsedMessage=function(a){return a in this.parsedMessages?this.parsedMessages[a]:this.getMessage(a).replace(/['"<>&]/g,function(a){switch(a){case"'":return"&#039;";case'"':return"&quot;";case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;"}})},ve.init.sa.Platform.prototype.getSystemPlatform=function(){var a=["win","mac","linux","sunos","solaris","iphone"],b=new RegExp("("+a.join("|")+")").exec(window.navigator.platform.toLowerCase());return b?b[1]:void 0},ve.init.sa.Platform.prototype.isInternetExplorer=function(){return-1!==navigator.appVersion.indexOf("Trident")},ve.init.sa.Platform.prototype.getLanguageCodes=function(){return Object.keys($.uls.data.getAutonyms())},ve.init.sa.Platform.prototype.getLanguageName=$.uls.data.getAutonym,ve.init.sa.Platform.prototype.getLanguageAutonym=$.uls.data.getAutonym,ve.init.sa.Platform.prototype.getLanguageDirection=$.uls.data.getDir,ve.init.sa.Platform.prototype.getUserLanguages=function(){return this.userLanguages},ve.init.sa.Platform.prototype.initialize=function(){var a,b,c,d,e,f,g=this.getModulesUrl(),h=$.i18n().locale,i=[h,"en"],j={},k=[],l=$.i18n.fallbacks[h];if(!l)for(d=h.split("-"),d.pop();d.length&&!l;)c=d.join("-"),i.push(c),l=$.i18n.fallbacks[c],d.pop();for(l&&(i=i.concat(l)),this.userLanguages=i,a=0,b=i.length;b>a;a++)j[i[a]]||(j[i[a]]=!0,e=i[a].toLowerCase()+".json",f=$.Deferred(),$.i18n().load(g+"/ve/i18n/"+e,i[a]).always(f.resolve),k.push(f.promise()),f=$.Deferred(),$.i18n().load(g+"/../lib/oojs-ui/i18n/"+e,i[a]).always(f.resolve),k.push(f.promise()));return $.when.apply($,k)},ve.init.platform=new ve.init.sa.Platform,OO.ui.getUserLanguages=ve.bind(ve.init.platform.getUserLanguages,ve.init.platform),OO.ui.msg=ve.bind(ve.init.platform.getMessage,ve.init.platform),ve.init.sa.Target=function(a,b,c){switch(ve.init.Target.call(this,a),c=c||this.constructor.static.defaultSurfaceType){case"desktop":this.surfaceClass=ve.ui.DesktopSurface;break;case"mobile":this.surfaceClass=ve.ui.MobileSurface;break;default:throw new Error("Unknown surfaceType: "+c)}this.setupDone=!1,ve.init.platform.getInitializedPromise().done(ve.bind(this.setup,this,b))},OO.inheritClass(ve.init.sa.Target,ve.init.Target),ve.init.sa.Target.static.defaultSurfaceType="desktop",ve.init.sa.Target.prototype.setup=function(a){var b=this;this.setupDone||(this.setupDone=!0,this.surface=this.createSurface(a),this.surface.addCommands(this.constructor.static.surfaceCommands),this.$element.append(this.surface.$element),this.setupToolbar(),ve.debug&&this.setupDebugBar(),this.toolbar.$element.addClass("ve-init-sa-target-toolbar"),this.toolbar.enableFloatable(),this.toolbar.initialize(),this.surface.setPasteRules(this.constructor.static.pasteRules),this.surface.initialize(),setTimeout(function(){b.emit("surfaceReady")}))},ve.init.sa.Target.prototype.createSurface=function(a,b){return new this.surfaceClass(a,b)},ve.init.sa.Target.prototype.setupToolbar=function(){ve.init.sa.Target.super.prototype.setupToolbar.call(this,{shadow:!0,actions:!0});var a=new ve.ui.TargetToolbar(this,this.surface);a.setup([{include:["commandHelp"]}]),this.toolbar.$actions.append(a.$element)},ve.Range=function(a,b){this.from=a||0,this.to=void 0===b?this.from:b,this.start=this.from<this.to?this.from:this.to,this.end=this.from<this.to?this.to:this.from},ve.Range.newFromJSON=function(a){var b=JSON.parse(a);return new ve.Range(b[0],b[1])},ve.Range.newFromTranslatedRange=function(a,b){return new ve.Range(a.from+b,a.to+b)},ve.Range.newCoveringRange=function(a,b){var c,d,e,f;if(!a||0===a.length)throw new Error("newCoveringRange() requires at least one range");for(c=a[0].start,d=a[0].end,e=1;e<a.length;e++)a[e].start<c&&(c=a[e].start),a[e].end>d&&(d=a[e].end);return f=b?new ve.Range(d,c):new ve.Range(c,d)},ve.Range.prototype.clone=function(){return new ve.Range(this.from,this.to)},ve.Range.prototype.containsOffset=function(a){return a>=this.start&&a<this.end},ve.Range.prototype.getLength=function(){return Math.abs(this.from-this.to)},ve.Range.prototype.flip=function(){return new ve.Range(this.to,this.from)},ve.Range.prototype.equals=function(a){return a&&this.from===a.from&&this.to===a.to},ve.Range.prototype.equalsSelection=function(a){return a&&this.end===a.end&&this.start===a.start},ve.Range.prototype.truncate=function(a){return a>=0?new ve.Range(this.start,Math.min(this.start+a,this.end)):new ve.Range(Math.max(this.end+a,this.start),this.end)},ve.Range.prototype.isCollapsed=function(){return this.from===this.to},ve.Range.prototype.isBackwards=function(){return this.from>this.to},ve.Range.prototype.toJSON=function(){return JSON.stringify([this.from,this.to])},ve.Node=function(){this.type=this.constructor.static.name,this.parent=null,this.root=null,this.doc=null},ve.Node.prototype.canHaveChildren=function(){throw new Error("ve.Node.canHaveChildren must be overridden in subclass")},ve.Node.prototype.canHaveChildrenNotContent=function(){throw new Error("ve.Node.canHaveChildrenNotContent must be overridden in subclass")},ve.Node.prototype.isWrapped=function(){throw new Error("ve.Node.isWrapped must be overridden in subclass")},ve.Node.prototype.getLength=function(){throw new Error("ve.Node.getLength must be overridden in subclass")},ve.Node.prototype.getOuterLength=function(){throw new Error("ve.Node.getOuterLength must be overridden in subclass")},ve.Node.prototype.getOuterRange=function(a){var b=new ve.Range(this.getOffset(),this.getOffset()+this.getOuterLength());return a?b.flip():b},ve.Node.prototype.getType=function(){return this.type},ve.Node.prototype.getParent=function(){return this.parent},ve.Node.prototype.getRoot=function(){return this.root},ve.Node.prototype.setRoot=function(a){a!==this.root&&(this.root=a,this.emit(this.getRoot()?"root":"unroot"))},ve.Node.prototype.getDocument=function(){return this.doc},ve.Node.prototype.setDocument=function(a){this.doc=a},ve.Node.prototype.attach=function(a){this.parent=a,this.setRoot(a.getRoot()),this.setDocument(a.getDocument()),this.emit("attach",a)},ve.Node.prototype.detach=function(){var a=this.parent;this.parent=null,this.setRoot(null),this.setDocument(null),this.emit("detach",a)},ve.Node.prototype.traverseUpstream=function(a){for(var b=this;b&&a(b)!==!1;)b=b.getParent()},ve.BranchNode=function(a){this.children=ve.isArray(a)?a:[]},ve.BranchNode.prototype.hasChildren=function(){return!0},ve.BranchNode.prototype.getChildren=function(){return this.children},ve.BranchNode.prototype.indexOf=function(a){return ve.indexOf(a,this.children)},ve.BranchNode.prototype.setRoot=function(a){if(a!==this.root){this.root=a;for(var b=0;b<this.children.length;b++)this.children[b].setRoot(a)}},ve.BranchNode.prototype.setDocument=function(a){if(a!==this.doc){this.doc=a;for(var b=0;b<this.children.length;b++)this.children[b].setDocument(a)}},ve.BranchNode.prototype.getNodeFromOffset=function(a,b){if(0===a)return this;if(this.children.length){var c,d,e,f,g=0;for(c=0,d=this.children.length;d>c;c++){if(f=this.children[c],a===g)return this;if(e=f.getOuterLength(),a>=g&&g+e>a)return!b&&f.hasChildren()&&f.getChildren().length?this.getNodeFromOffset.call(f,a-g-1):f;g+=e}if(a===g)return this}return null},ve.LeafNode=function(){},ve.LeafNode.prototype.hasChildren=function(){return!1},ve.Document=function(a){OO.EventEmitter.call(this),this.documentNode=a},OO.mixinClass(ve.Document,OO.EventEmitter),ve.Document.prototype.getDocumentNode=function(){return this.documentNode},ve.Document.prototype.selectNodes=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s=this.getDocumentNode(),t=[],u=a.start,v=a.end,w=[{node:s,index:0,startOffset:0}],x=w[0],y=!1;if(b=b||"leaves","leaves"!==b&&"branches"!==b&&"covered"!==b&&"siblings"!==b)throw new Error("Invalid mode: "+b);if(0>u||u>s.getLength())throw new Error("Invalid start offset: "+u);if(0>v||v>s.getLength())throw new Error("Invalid end offset: "+v);if(!s.children||0===s.children.length)return m=new ve.Range(0,s.getLength()),[{node:s,range:new ve.Range(u,v),index:0,nodeRange:m,nodeOuterRange:m}];f=s.children[0].isWrapped()?1:0;do{if(c=x.node.children[x.index],d=x.node.children[x.index-1],e=x.node.children[x.index+1],g=f+c.getLength(),i=u>=f&&g>=u,j=v>=f&&g>=v,o=c.isWrapped(),p=d?!d.isWrapped():!1,q=e?!e.isWrapped():!1,r=(0===c.getLength()||c.handlesOwnChildren())&&!c.isContent()&&!c.canContainContent(),k=(o?u===f-1:u===f)&&!p,l=(o?v===g+1:v===g)&&!q,n=new ve.Range(x.startOffset,x.startOffset+x.node.getLength()),o&&v===f-1&&0===x.index)return o=x.node.isWrapped(),t.push({node:x.node,indexInNode:0,range:new ve.Range(v,v),nodeRange:n,nodeOuterRange:new ve.Range(n.start-o,n.end+o)}),h=w[w.length-2],h&&(t[t.length-1].index=h.index),t;if(u===v&&(k||l)&&o)return o=x.node.isWrapped(),t=[{node:x.node,indexInNode:x.index+(l?1:0),range:new ve.Range(u,v),nodeRange:n,nodeOuterRange:new ve.Range(n.start-o,n.end+o)}],h=w[w.length-2],h&&(t[0].index=h.index),t;if(k){if(("leaves"===b||"covered"===b&&j||"branches"===b&&c.canHaveChildrenNotContent())&&c.children&&c.children.length&&!c.handlesOwnChildren()){x={node:c,index:0,startOffset:f},w.push(x),y=!0,c.children[0].isWrapped()&&f++;continue}if(j)return[{node:c,range:new ve.Range(u,v),index:x.index,nodeRange:new ve.Range(f,g),nodeOuterRange:new ve.Range(f-o,g+o),parentOuterRange:new ve.Range(n.start-x.node.isWrapped(),n.end+x.node.isWrapped())}];t.push({node:c,index:x.index,nodeRange:new ve.Range(f,g),nodeOuterRange:new ve.Range(f-o,g+o),parentOuterRange:new ve.Range(n.start-x.node.isWrapped(),n.end+x.node.isWrapped())}),y=!0}else{if(i&&j){if(c.children&&c.children.length&&("branches"!==b||c.canHaveChildrenNotContent())){x={node:c,index:0,startOffset:f},w.push(x),c.children[0].isWrapped()&&f++;continue}return t=[{node:c,range:new ve.Range(u,v),index:x.index,nodeRange:new ve.Range(f,g),nodeOuterRange:new ve.Range(f-o,g+o),parentOuterRange:new ve.Range(n.start-x.node.isWrapped(),n.end+x.node.isWrapped())}],r&&(t[0].indexInNode=0),t}if(i){if(("leaves"===b||"covered"===b||"branches"===b&&c.canHaveChildrenNotContent())&&c.children&&c.children.length){x={node:c,index:0,startOffset:f},w.push(x),c.children[0].isWrapped()&&f++;continue}t.push({node:c,range:new ve.Range(u,g),index:x.index,nodeRange:new ve.Range(f,g),nodeOuterRange:new ve.Range(f-o,g+o),parentOuterRange:new ve.Range(n.start-x.node.isWrapped(),n.end+x.node.isWrapped())}),y=!0}else{if(l){if(("leaves"===b||"branches"===b&&c.canHaveChildrenNotContent())&&c.children&&c.children.length){x={node:c,index:0,startOffset:f},w.push(x),c.children[0].isWrapped()&&f++;continue}return t.push({node:c,index:x.index,nodeRange:new ve.Range(f,g),nodeOuterRange:new ve.Range(f-o,g+o),parentOuterRange:new ve.Range(n.start-x.node.isWrapped(),n.end+x.node.isWrapped())}),t}if(j){if(("leaves"===b||"covered"===b||"branches"===b&&c.canHaveChildrenNotContent())&&c.children&&c.children.length){x={node:c,index:0,startOffset:f},w.push(x),c.children[0].isWrapped()&&f++;continue}return t.push({node:c,range:new ve.Range(f,v),index:x.index,nodeRange:new ve.Range(f,g),nodeOuterRange:new ve.Range(f-o,g+o),parentOuterRange:new ve.Range(n.start-x.node.isWrapped(),n.end+x.node.isWrapped())}),t}if(y&&v>g){if(("leaves"===b||"branches"===b&&c.canHaveChildrenNotContent())&&c.children&&c.children.length){x={node:c,index:0,startOffset:f},w.push(x),c.children[0].isWrapped()&&f++;continue}t.push({node:c,index:x.index,nodeRange:new ve.Range(f,g),nodeOuterRange:new ve.Range(f-o,g+o),parentOuterRange:new ve.Range(n.start-x.node.isWrapped(),n.end+x.node.isWrapped())})}}}if(e)x.index++,f=g+(c.isWrapped()?1:0)+(e.isWrapped()?1:0);else{for(f=g+(c.isWrapped()?1:0);!e;){if(c.isWrapped()&&u===f&&(n=new ve.Range(x.startOffset,x.startOffset+x.node.getLength()),o=x.node.isWrapped(),t=[{node:x.node,indexInNode:x.index+1,range:new ve.Range(f,f),nodeRange:n,nodeOuterRange:new ve.Range(n.start-o,n.end+o)}],h=w[w.length-2],h&&(t[0].index=h.index)),w.pop(),0===w.length)return t;x=w[w.length-1],x.index++,e=x.node.children[x.index],f++}e.isWrapped()&&f++}}while(v>=f-1);if(0===t.length)throw new Error("Failed to select any nodes");return t},ve.Document.prototype.getCoveredSiblingGroups=function(a){var b,c,d,e,f,g,h=this.selectNodes(a,"leaves"),i=[],j=0;for(b=0;b<h.length;b++)if(!(h[b].nodeOuterRange.end<=j)){if(e=h[b].node,e.isContent()&&(e=e.getParent()),f=e.getParent(),!f)break;i.push({parent:f,grandparent:f.getParent(),nodes:[]}),c=e,g=c;do{if(i[i.length-1].nodes.push(g),d=g,b++,void 0===h[b])break;g=h[b].node,g.isContent()&&(g=g.getParent())}while(g.getParent()===f);b--,j=f.getOuterRange().end}return i},ve.EventSequencer=function(a){function b(a){return function(b){return f.onEvent(a,b)}}var c,d,e,f=this;for(this.$node=null,this.eventNames=a,this.eventHandlers={},this.pendingCalls=[],this.onListenersForEvent={},this.afterListenersForEvent={},this.afterOneListenersForEvent={},c=0,d=a.length;d>c;c++)e=a[c],this.onListenersForEvent[e]=[],this.afterListenersForEvent[e]=[],this.afterOneListenersForEvent[e]=[],this.eventHandlers[e]=b(e);this.onLoopListeners=[],this.afterLoopListeners=[],this.afterLoopOneListeners=[],this.doneOnLoop=!1,this.afterLoopTimeoutId=null},ve.EventSequencer.prototype.attach=function(a){return this.detach(),this.$node=a.on(this.eventHandlers),this},ve.EventSequencer.prototype.detach=function(){return null!==this.$node?(this.runPendingCalls(),this.$node.off(this.eventHandlers),this.$node=null,this):void 0},ve.EventSequencer.prototype.onLoop=function(a){return Array.prototype.push.apply(this.onLoopListeners,a),this},ve.EventSequencer.prototype.on=function(a){var b;for(b in a)this.onListenersForEvent[b].push(a[b]);return this},ve.EventSequencer.prototype.after=function(a){var b;for(b in a)this.afterListenersForEvent[b].push(a[b]);return this},ve.EventSequencer.prototype.afterOne=function(a){var b;for(b in a)this.afterOneListenersForEvent[b].push(a[b]);return this},ve.EventSequencer.prototype.afterLoop=function(a){return ve.isArray(a)||(a=[a]),Array.prototype.push.apply(this.afterLoopListeners,a),this},ve.EventSequencer.prototype.afterLoopOne=function(a){return ve.isArray(a)||(a=[a]),Array.prototype.push.apply(this.afterLoopOneListeners,a),this},ve.EventSequencer.prototype.onEvent=function(a,b){var c,d,e,f,g,h,i;for(this.runPendingCalls(),this.doneOnLoop||(this.doneOnLoop=!0,this.doOnLoop()),f=this.onListenersForEvent[a]||[],c=0,d=f.length;d>c;c++)(e=f[c])(b);((this.afterListenersForEvent[a]||[]).length>0||(this.afterOneListenersForEvent[a]||[]).length>0||this.afterLoopListeners.length>0)&&(g={id:null,ev:b,eventName:a},h=this,i=this.postpone(function(){null!==g.id&&(h.resetAfterLoopTimeout(),g.id=null,h.afterEvent(a,b))}),g.id=i,this.pendingCalls.push(g))},ve.EventSequencer.prototype.afterEvent=function(a,b){var c,d,e,f;for(e=(this.afterListenersForEvent[a]||[]).slice(),f=(this.afterOneListenersForEvent[a]||[]).slice(),(this.afterOneListenersForEvent[a]||[]).length=0,c=0,d=e.length;d>c;c++)e[c](b);for(c=0,d=f.length;d>c;c++)f[c](b)},ve.EventSequencer.prototype.doOnLoop=function(){var a,b;for(a=0,b=this.onLoopListeners.length;b>a;a++)this.onLoopListeners[a]()},ve.EventSequencer.prototype.doAfterLoop=function(a){var b,c,d,e;if(this.afterLoopTimeoutId===a){for(this.afterLoopTimeoutId=null,d=this.afterLoopListeners.slice(),e=this.afterLoopOneListeners.slice(),this.afterLoopOneListeners.length=0,b=0,c=this.afterLoopListeners.length;c>b;b++)this.afterLoopListeners[b]();for(b=0,c=this.afterLoopOneListeners.length;c>b;b++)this.afterLoopOneListeners[b]()}},ve.EventSequencer.prototype.resetAfterLoopTimeout=function(){var a,b=this;null!==this.afterLoopTimeoutId&&this.cancelPostponed(this.afterLoopTimeoutId),a=this.postpone(function(){b.doAfterLoop(a)}),this.afterLoopTimeoutId=a},ve.EventSequencer.prototype.runPendingCalls=function(){var a,b;for(a=0;a<this.pendingCalls.length;a++)b=this.pendingCalls[a],null!==b.id&&(this.cancelPostponed(b.id),b.id=null,this.afterEvent(b.eventName,b.ev));this.pendingCalls.length=0},ve.EventSequencer.prototype.postpone=function(a){return setTimeout(a)},ve.EventSequencer.prototype.cancelPostponed=function(a){clearTimeout(a)},ve.dm={},ve.dm.Model=function(a){this.element=a||{type:this.constructor.static.name}},ve.dm.Model.static={},ve.dm.Model.static.name=null,ve.dm.Model.static.matchTagNames=null,ve.dm.Model.static.matchRdfaTypes=null,ve.dm.Model.static.matchFunction=null,ve.dm.Model.static.toDataElement=function(){return{type:this.name}},ve.dm.Model.static.toDomElements=function(a,b){if(this.matchTagNames&&1===this.matchTagNames.length)return[b.createElement(this.matchTagNames[0])];throw new Error("ve.dm.Model subclass must match a single tag name or implement toDomElements")},ve.dm.Model.static.enableAboutGrouping=!1,ve.dm.Model.static.storeHtmlAttributes=!0,ve.dm.Model.matchesAttributeSpec=function(a,b){function c(b){return b instanceof RegExp?!!b.exec(a):"boolean"==typeof b?b:a===b}function d(a){var b,d;for(ve.isArray(a)||(a=[a]),b=0,d=a.length;d>b;b++)if(c(a[b]))return!0;return!1}return void 0===b.whitelist&&void 0===b.blacklist?d(b):d(b.whitelist||!0)&&!d(b.blacklist||!1)},ve.dm.Model.static.getHashObject=function(a){return{type:a.type,attributes:a.attributes,htmlAttributes:a.htmlAttributes}},ve.dm.Model.static.getMatchRdfaTypes=function(){return this.matchRdfaTypes},ve.dm.Model.static.removeHtmlAttribute=function(a,b){function c(a){var d;for(d=0;d<a.length;d++)a[d].values&&(delete a[d].values[b],ve.isEmptyObject(a[d].values)&&delete a[d].values),a[d].children&&(c(a[d].children),a[d].children.length||delete a[d].children),ve.isEmptyObject(a[d])&&(a.splice(d,1),d--)}a.htmlAttributes&&(c(a.htmlAttributes),a.htmlAttributes.length||delete a.htmlAttributes)},ve.dm.Model.prototype.isInspectable=function(){return!0},ve.dm.Model.prototype.getElement=function(){return this.element},ve.dm.Model.prototype.getType=function(){return this.constructor.static.name},ve.dm.Model.prototype.getAttribute=function(a){return this.element&&this.element.attributes?this.element.attributes[a]:void 0},ve.dm.Model.prototype.getAttributes=function(a){var b,c,d=this.element&&this.element.attributes?this.element.attributes:{};if(a){c={};for(b in d)0===b.indexOf(a)&&(c[b.substr(a.length)]=d[b]);return c}return ve.extendObject({},d)},ve.dm.Model.prototype.getHtmlAttributes=function(){return this.element&&this.element.htmlAttributes||[]},ve.dm.Model.prototype.hasAttributes=function(a,b){var c,d,e,f=this.getAttributes()||{};if(ve.isPlainObject(a)){for(c in a)if(!(c in f)||(b?a[c]!==f[c]:String(a[c])!==String(f[c])))return!1}else if(ve.isArray(a))for(d=0,e=a.length;e>d;d++)if(!(a[d]in f))return!1;return!0},ve.dm.Model.prototype.getClonedElement=function(){return ve.copy(this.element)},ve.dm.Model.prototype.getHashObject=function(){return this.constructor.static.getHashObject(this.element)},function(a){function b(a){var b,c,d=a;for(b=1,c=arguments.length-2;c>b;b++)void 0===d[arguments[b]]&&(d[arguments[b]]={}),d=d[arguments[b]];void 0===d[arguments[b]]&&(d[arguments[b]]=[]),d[arguments[b]].unshift(arguments[b+1])}a.dm.ModelRegistry=function(){OO.Registry.call(this),this.modelsByTag=[{},{}],this.modelsByTypeAndTag=[],this.modelsWithTypeRegExps=[[],[]],this.registrationOrder={},this.nextNumber=0,this.extSpecificTypes=[]},OO.inheritClass(a.dm.ModelRegistry,OO.Registry),a.dm.ModelRegistry.prototype.register=function(c){var d,e,f,g,h=c.static&&c.static.name;if("string"!=typeof h||""===h)throw new Error("Model names must be strings and must not be empty");if(!(c.prototype instanceof a.dm.Model))throw new Error("Models must be subclasses of ve.dm.Model");if(c.prototype instanceof a.dm.Annotation)a.dm.annotationFactory.register(c);else if(c.prototype instanceof a.dm.Node)a.dm.nodeFactory.register(c);
else{if(!(c.prototype instanceof a.dm.MetaItem))throw new Error("No factory associated with this ve.dm.Model subclass");a.dm.metaItemFactory.register(c)}for(OO.Registry.prototype.register.call(this,h,c),f=null===c.static.matchTagNames?[""]:c.static.matchTagNames,g=null===c.static.getMatchRdfaTypes()?[""]:c.static.getMatchRdfaTypes(),d=0;d<f.length;d++)b(this.modelsByTag,+!!c.static.matchFunction,f[d],h);for(d=0;d<g.length;d++)if(g[d]instanceof RegExp)b(this.modelsWithTypeRegExps,+!!c.static.matchFunction,h);else for(e=0;e<f.length;e++)b(this.modelsByTypeAndTag,+!!c.static.matchFunction,g[d],f[e],h);this.registrationOrder[h]=this.nextNumber++},a.dm.ModelRegistry.prototype.registerExtensionSpecificType=function(a){this.extSpecificTypes.push(a)},a.dm.ModelRegistry.prototype.isExtensionSpecificType=function(a){var b,c,d;for(b=0,c=this.extSpecificTypes.length;c>b;b++)if(d=this.extSpecificTypes[b],d===a||d instanceof RegExp&&a.match(d))return!0;return!1},a.dm.ModelRegistry.prototype.matchElement=function(b,c,d){function e(a,b){return t.registrationOrder[b]-t.registrationOrder[a]}function f(b,c,e){var f,g,h,i=[],j=t.modelsWithTypeRegExps[+e];for(f=0;f<j.length;f++)if(!d||-1===a.indexOf(j[f],d))for(h=t.registry[j[f]].static.getMatchRdfaTypes(),g=0;g<h.length;g++)h[g]instanceof RegExp&&b.match(h[g])&&(""===c&&null===t.registry[j[f]].static.matchTagNames||-1!==a.indexOf(c,t.registry[j[f]].static.matchTagNames))&&i.push(j[f]);return i}function g(a,b){var c,d,e,f=t.registry[b].static.getMatchRdfaTypes();for(c=0;c<a.length;c++){for(e=!1,d=0;d<f.length;d++)if(f[d]instanceof RegExp){if(a[c].match(f[d])){e=!0;break}}else if(a[c]===f[d]){e=!0;break}if(!e)return!1}return!0}function h(h,i,j){var k,l=[],m=[];for(k=0;k<h.length;k++)l=l.concat(a.getProp(t.modelsByTypeAndTag,1,h[k],i)||[]),d&&(l=OO.simpleArrayDifference(l,d)),m=m.concat(f(h[k],i,!0));for(j&&(l=l.filter(function(a){return g(h,a)}),m=m.filter(function(a){return g(h,a)})),c&&(l=l.filter(function(a){return t.registry[a].static.enableAboutGrouping}),m=m.filter(function(a){return t.registry[a].static.enableAboutGrouping})),l.sort(e),m.sort(e),l=l.concat(m),k=0;k<l.length;k++)if(t.registry[l[k]].static.matchFunction(b))return l[k];return null}function i(b,e,h){var i,j=[],k=[],l=null;for(i=0;i<b.length;i++)j=j.concat(a.getProp(t.modelsByTypeAndTag,0,b[i],e)||[]),d&&(j=OO.simpleArrayDifference(j,d)),k=k.concat(f(b[i],e,!1));for(h&&(j=j.filter(function(a){return g(b,a)}),k=k.filter(function(a){return g(b,a)})),c&&(j=j.filter(function(a){return t.registry[a].static.enableAboutGrouping}),k=k.filter(function(a){return t.registry[a].static.enableAboutGrouping})),j=j.length>0?j:k,i=0;i<j.length;i++)(null===l||t.registrationOrder[l]<t.registrationOrder[j[i]])&&(l=j[i]);return l}var j,k,l,m,n,o,p,q,r,s=b.nodeName.toLowerCase(),t=this;if(o=[],b.getAttribute&&(b.getAttribute("rel")&&(o=o.concat(b.getAttribute("rel").split(" "))),b.getAttribute("typeof")&&(o=o.concat(b.getAttribute("typeof").split(" "))),b.getAttribute("property")&&(o=o.concat(b.getAttribute("property").split(" ")))),p=o.filter(a.bind(this.isExtensionSpecificType,this)),r=0!==p.length,q=r?p:o,o.length){if(n=h(q,s,r),null!==n)return n;if(n=h(q,"",r),null!==n)return n}if(!r){for(m=a.getProp(this.modelsByTag,1,s)||[],j=0;j<m.length;j++)if(k=m[j],l=this.registry[k],null===l.static.getMatchRdfaTypes()&&l.static.matchFunction(b))return m[j];for(m=a.getProp(this.modelsByTypeAndTag,1,"","")||[],j=0;j<m.length;j++)if(this.registry[m[j]].static.matchFunction(b))return m[j]}if(n=i(q,s,r),null!==n)return n;if(n=i(q,"",r),null!==n)return n;if(p.length>0)return null;for(m=a.getProp(this.modelsByTag,0,s)||[],j=0;j<m.length;j++)if(k=m[j],l=this.registry[k],null===l.static.getMatchRdfaTypes())return m[j];return m=a.getProp(this.modelsByTypeAndTag,0,"","")||[],m.length>0?m[0]:null},a.dm.modelRegistry=new a.dm.ModelRegistry}(ve),ve.dm.NodeFactory=function(){OO.Factory.call(this)},OO.inheritClass(ve.dm.NodeFactory,OO.Factory),ve.dm.NodeFactory.prototype.getDataElement=function(a,b){var c={type:a};if(a in this.registry)return b=ve.extendObject({},this.registry[a].static.defaultAttributes,b),ve.isEmptyObject(b)||(c.attributes=ve.copy(b)),c;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.getChildNodeTypes=function(a){if(a in this.registry)return this.registry[a].static.childNodeTypes;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.getParentNodeTypes=function(a){if(a in this.registry)return this.registry[a].static.parentNodeTypes;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.getSuggestedParentNodeTypes=function(a){if(a in this.registry)return this.registry[a].static.suggestedParentNodeTypes;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.canNodeHaveChildren=function(a){if(a in this.registry){var b=this.registry[a].static.childNodeTypes;return null===b||ve.isArray(b)&&b.length>0}throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.canNodeHaveChildrenNotContent=function(a){if(a in this.registry)return this.canNodeHaveChildren(a)&&!this.registry[a].static.canContainContent&&!this.registry[a].static.isContent;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.isNodeWrapped=function(a){if(a in this.registry)return this.registry[a].static.isWrapped;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.canNodeContainContent=function(a){if(a in this.registry)return this.registry[a].static.canContainContent;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.canNodeTakeAnnotationType=function(a,b){if(!(a in this.registry))throw new Error("Unknown node type: "+a);var c,d,e=this.registry[a].static.blacklistedAnnotationTypes;for(c=0,d=e.length;d>c;c++)if(b instanceof ve.dm.annotationFactory.create(e[c]).constructor)return!1;return!0},ve.dm.NodeFactory.prototype.isNodeContent=function(a){if(a in this.registry)return this.registry[a].static.isContent;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.doesNodeHaveSignificantWhitespace=function(a){if(a in this.registry)return this.registry[a].static.hasSignificantWhitespace;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.doesNodeHandleOwnChildren=function(a){if(a in this.registry)return this.registry[a].static.handlesOwnChildren;throw new Error("Unknown node type: "+a)},ve.dm.NodeFactory.prototype.isNodeInternal=function(a){if(a in this.registry)return this.registry[a].static.isInternal;throw new Error("Unknown node type: "+a)},ve.dm.nodeFactory=new ve.dm.NodeFactory,ve.dm.AnnotationFactory=function(){OO.Factory.call(this)},OO.inheritClass(ve.dm.AnnotationFactory,OO.Factory),ve.dm.annotationFactory=new ve.dm.AnnotationFactory,ve.dm.AnnotationSet=function(a,b){this.store=a,this.storeIndexes=b||[]},ve.dm.AnnotationSet.prototype.getStore=function(){return this.store},ve.dm.AnnotationSet.prototype.clone=function(){return new ve.dm.AnnotationSet(this.getStore(),this.storeIndexes.slice(0))},ve.dm.AnnotationSet.prototype.getAnnotationsByName=function(a){return this.filter(function(b){return b.name===a})},ve.dm.AnnotationSet.prototype.getComparableAnnotations=function(a){return this.filter(function(b){return ve.compare(a.getComparableObject(),b.getComparableObject())})},ve.dm.AnnotationSet.prototype.getComparableAnnotationsFromSet=function(a){return this.filter(function(b){return a.containsComparable(b)})},ve.dm.AnnotationSet.prototype.hasAnnotationWithName=function(a){return this.containsMatching(function(b){return b.name===a})},ve.dm.AnnotationSet.prototype.get=function(a){return void 0!==a?this.getStore().value(this.getIndex(a)):this.getStore().values(this.getIndexes())},ve.dm.AnnotationSet.prototype.getIndex=function(a){return this.storeIndexes[a]},ve.dm.AnnotationSet.prototype.getIndexes=function(){return this.storeIndexes},ve.dm.AnnotationSet.prototype.getLength=function(){return this.storeIndexes.length},ve.dm.AnnotationSet.prototype.isEmpty=function(){return 0===this.getLength()},ve.dm.AnnotationSet.prototype.contains=function(a){return-1!==this.offsetOf(a)},ve.dm.AnnotationSet.prototype.containsIndex=function(a){return-1!==ve.indexOf(a,this.getIndexes())},ve.dm.AnnotationSet.prototype.containsAnyOf=function(a){var b,c,d=a.getIndexes(),e=this.getIndexes();for(b=0,c=d.length;c>b;b++)if(-1!==ve.indexOf(d[b],e))return!0;return!1},ve.dm.AnnotationSet.prototype.containsAllOf=function(a){var b,c,d=a.getIndexes(),e=this.getIndexes();for(b=0,c=d.length;c>b;b++)if(-1===ve.indexOf(d[b],e))return!1;return!0},ve.dm.AnnotationSet.prototype.offsetOf=function(a){return this.offsetOfIndex(this.store.indexOfHash(OO.getHash(a)))},ve.dm.AnnotationSet.prototype.offsetOfIndex=function(a){return ve.indexOf(a,this.getIndexes())},ve.dm.AnnotationSet.prototype.filter=function(a,b){var c,d,e,f,g;for(b||(e=this.clone(),e.removeAll()),c=0,d=this.getLength();d>c;c++)if(f=this.getIndex(c),g=this.getStore().value(f),a(g)){if(b)return!0;e.storeIndexes.push(f)}return b?!1:e},ve.dm.AnnotationSet.prototype.containsComparable=function(a){return this.filter(function(b){return a.compareTo(b)},!0)},ve.dm.AnnotationSet.prototype.containsComparableForSerialization=function(a){return this.filter(function(b){return a.compareToForSerialization(b)},!0)},ve.dm.AnnotationSet.prototype.containsMatching=function(a){return this.filter(a,!0)},ve.dm.AnnotationSet.prototype.compareTo=function(a){var b,c=this.getIndexes().length;if(c!==a.getLength())return!1;for(b=0;c>b;b++)if(!a.containsComparable(this.get(b)))return!1;return!0},ve.dm.AnnotationSet.prototype.add=function(a,b){var c=this.getStore().index(a);return 0>b&&(b=this.getLength()+b),b>=this.getLength()?void this.push(a):void(this.containsIndex(c)||this.storeIndexes.splice(b,0,c))},ve.dm.AnnotationSet.prototype.addSet=function(a){this.storeIndexes=OO.simpleArrayUnion(this.getIndexes(),a.getIndexes())},ve.dm.AnnotationSet.prototype.push=function(a){this.pushIndex(this.getStore().index(a))},ve.dm.AnnotationSet.prototype.pushIndex=function(a){this.storeIndexes.push(a)},ve.dm.AnnotationSet.prototype.removeAt=function(a){if(0>a&&(a=this.getLength()+a),a>=this.getLength())throw new Error("Offset out of bounds");this.storeIndexes.splice(a,1)},ve.dm.AnnotationSet.prototype.removeIndex=function(a){var b=this.offsetOfIndex(a);-1!==b&&this.storeIndexes.splice(b,1)},ve.dm.AnnotationSet.prototype.remove=function(a){var b=this.offsetOf(a);-1!==b&&this.storeIndexes.splice(b,1)},ve.dm.AnnotationSet.prototype.removeAll=function(){this.storeIndexes=[]},ve.dm.AnnotationSet.prototype.removeSet=function(a){this.storeIndexes=OO.simpleArrayDifference(this.getIndexes(),a.getIndexes())},ve.dm.AnnotationSet.prototype.removeNotInSet=function(a){this.storeIndexes=OO.simpleArrayIntersection(this.getIndexes(),a.getIndexes())},ve.dm.AnnotationSet.prototype.reversed=function(){var a=this.clone();return a.storeIndexes.reverse(),a},ve.dm.AnnotationSet.prototype.mergeWith=function(a){var b=this.clone();return b.addSet(a),b},ve.dm.AnnotationSet.prototype.diffWith=function(a){var b=this.clone();return b.removeSet(a),b},ve.dm.AnnotationSet.prototype.intersectWith=function(a){var b=this.clone();return b.removeNotInSet(a),b},ve.dm.MetaItemFactory=function(){OO.Factory.call(this)},OO.inheritClass(ve.dm.MetaItemFactory,OO.Factory),ve.dm.MetaItemFactory.prototype.getGroup=function(a){if(a in this.registry)return this.registry[a].static.group;throw new Error("Unknown item type: "+a)},ve.dm.MetaItemFactory.prototype.createFromElement=function(a){if(a&&a.type)return this.create(a.type,a);throw new Error("Element must have a .type property")},ve.dm.metaItemFactory=new ve.dm.MetaItemFactory,ve.dm.Scalable=function(a){a=ve.extendObject({fixedRatio:!0,enforceMin:!0,enforceMax:!0},a),OO.EventEmitter.call(this),this.ratio=null,this.valid=null,this.defaultSize=!1,this.fixedRatio=a.fixedRatio,a.currentDimensions&&this.setCurrentDimensions(a.currentDimensions),a.originalDimensions&&this.setOriginalDimensions(a.originalDimensions),a.defaultDimensions&&this.setDefaultDimensions(a.defaultDimensions),a.isDefault&&this.toggleDefault(!!a.isDefault),a.minDimensions&&this.setMinDimensions(a.minDimensions),a.maxDimensions&&this.setMaxDimensions(a.maxDimensions),this.setEnforcedMin(a.enforceMin),this.setEnforcedMax(a.enforceMax)},OO.mixinClass(ve.dm.Scalable,OO.EventEmitter),ve.dm.Scalable.static.getDimensionsFromValue=function(a,b){return a=ve.copy(a),""===a.width&&(a.width=0),""===a.height&&(a.height=0),!a.height&&null!==b&&$.isNumeric(a.width)&&(a.height=Math.round(a.width/b)),!a.width&&null!==b&&$.isNumeric(a.height)&&(a.width=Math.round(a.height*b)),a},ve.dm.Scalable.prototype.clone=function(){var a=this.getCurrentDimensions(),b=this.getOriginalDimensions(),c=this.getDefaultDimensions(),d=this.getMinDimensions(),e=this.getMaxDimensions(),f={isDefault:!!this.isDefault(),enforceMin:!!this.isEnforcedMin(),enforceMax:!!this.isEnforcedMax()};return a&&(f.currentDimensions=ve.copy(a)),b&&(f.originalDimensions=ve.copy(b)),c&&(f.defaultDimensions=ve.copy(c)),d&&(f.minDimensions=ve.copy(d)),e&&(f.maxDimensions=ve.copy(e)),new this.constructor(f)},ve.dm.Scalable.prototype.setRatioFromDimensions=function(a){a&&a.width&&a.height&&(this.ratio=a.width/a.height),this.valid=null},ve.dm.Scalable.prototype.setCurrentDimensions=function(a){this.isDimensionsObjectValid(a)&&(this.currentDimensions=ve.copy(a),this.fixedRatio&&!this.ratio&&this.setRatioFromDimensions(this.getCurrentDimensions()),this.valid=null)},ve.dm.Scalable.prototype.setOriginalDimensions=function(a){(!this.originalDimensions||this.isDimensionsObjectValid(a)&&!ve.compare(this.originalDimensions,a))&&(this.originalDimensions=ve.copy(a),this.fixedRatio&&this.setRatioFromDimensions(this.getOriginalDimensions()),this.valid=null,this.emit("originalSizeChange",this.getOriginalDimensions()))},ve.dm.Scalable.prototype.setDefaultDimensions=function(a){(!this.defaultDimensions||this.isDimensionsObjectValid(a)&&!ve.compare(this.defaultDimensions,a))&&(this.defaultDimensions=ve.copy(a),this.valid=null,this.emit("defaultSizeChange",this.isDefault()))},ve.dm.Scalable.prototype.toggleDefault=function(a){void 0===a&&(a=!this.isDefault()),this.isDefault()!==a&&(this.defaultSize=a,a&&this.setCurrentDimensions(this.getDefaultDimensions()),this.emit("defaultSizeChange",this.isDefault()))},ve.dm.Scalable.prototype.setMinDimensions=function(a){(!this.minDimensions||this.isDimensionsObjectValid(a)&&!ve.compare(this.minDimensions,a))&&(this.minDimensions=ve.copy(a),this.valid=null,this.emit("minSizeChange",a))},ve.dm.Scalable.prototype.setMaxDimensions=function(a){(!this.maxDimensions||this.isDimensionsObjectValid(a)&&!ve.compare(this.maxDimensions,a))&&(this.maxDimensions=ve.copy(a),this.emit("maxSizeChange",a),this.valid=null)},ve.dm.Scalable.prototype.unsetMinDimensions=function(){null!==this.minDimensions&&(this.minDimensions=null,this.valid=null,this.emit("minSizeChange",this.minDimensions))},ve.dm.Scalable.prototype.unsetMaxDimensions=function(){null!==this.maxDimensions&&(this.maxDimensions=null,this.valid=null,this.emit("maxSizeChange",this.maxDimensions))},ve.dm.Scalable.prototype.getCurrentDimensions=function(){return this.currentDimensions},ve.dm.Scalable.prototype.getOriginalDimensions=function(){return this.originalDimensions},ve.dm.Scalable.prototype.getDefaultDimensions=function(){return this.defaultDimensions},ve.dm.Scalable.prototype.isDefault=function(){return this.defaultSize},ve.dm.Scalable.prototype.getMinDimensions=function(){return this.minDimensions},ve.dm.Scalable.prototype.getMaxDimensions=function(){return this.maxDimensions},ve.dm.Scalable.prototype.isEnforcedMin=function(){return this.enforceMin},ve.dm.Scalable.prototype.isEnforcedMax=function(){return this.enforceMax},ve.dm.Scalable.prototype.setEnforcedMin=function(a){this.valid=null,this.enforceMin=!!a},ve.dm.Scalable.prototype.setEnforcedMax=function(a){this.valid=null,this.enforceMax=!!a},ve.dm.Scalable.prototype.getRatio=function(){return this.ratio},ve.dm.Scalable.prototype.isFixedRatio=function(){return this.fixedRatio},ve.dm.Scalable.prototype.getCurrentScale=function(){return this.isFixedRatio()&&this.getCurrentDimensions()&&this.getOriginalDimensions()?this.getCurrentDimensions().width/this.getOriginalDimensions().width:null},ve.dm.Scalable.prototype.isTooSmall=function(){return!!(this.getCurrentDimensions()&&this.getMinDimensions()&&(this.getCurrentDimensions().width<this.getMinDimensions().width||this.getCurrentDimensions().height<this.getMinDimensions().height))},ve.dm.Scalable.prototype.isTooLarge=function(){return!!(this.getCurrentDimensions()&&this.getMaxDimensions()&&(this.getCurrentDimensions().width>this.getMaxDimensions().width||this.getCurrentDimensions().height>this.getMaxDimensions().height))},ve.dm.Scalable.prototype.getBoundedDimensions=function(a,b){var c,d,e,f,g=this.isEnforcedMin()&&this.getMinDimensions(),h=this.isEnforcedMax()&&this.getMaxDimensions();return a=ve.copy(a),g&&(a.width=Math.max(a.width,this.minDimensions.width),a.height=Math.max(a.height,this.minDimensions.height)),h&&(a.width=Math.min(a.width,this.maxDimensions.width),a.height=Math.min(a.height,this.maxDimensions.height)),this.isFixedRatio()&&(c=a.width/a.height,c<this.getRatio()?a.height=Math.round(a.width/this.getRatio()):a.width=Math.round(a.height*this.getRatio())),b&&(e=g?Math.ceil(g.width/b):-1/0,f=h?Math.floor(h.width/b):1/0,d=Math.round(a.width/b),a.width=Math.max(Math.min(d,f),e)*b,this.isFixedRatio()?a.height=Math.round(a.width/this.getRatio()):(e=g?Math.ceil(g.height/b):-1/0,f=h?Math.floor(h.height/b):1/0,d=Math.round(a.height/b),a.height=Math.max(Math.min(d,f),e)*b)),a},ve.dm.Scalable.prototype.isCurrentDimensionsValid=function(){var a=this.getCurrentDimensions(),b=this.isEnforcedMin()&&this.getMinDimensions(),c=this.isEnforcedMax()&&this.getMaxDimensions();return this.valid=$.isNumeric(a.width)&&$.isNumeric(a.height)&&(!b||a.width>=b.width&&a.height>=b.height)&&(!c||a.width<=c.width&&a.height<=c.height),this.valid},ve.dm.Scalable.prototype.isDimensionsObjectValid=function(a){return!a||$.isEmptyObject(a)||void 0===a.width&&void 0===a.height?!1:!0},ve.dm.ResizableNode=function(a){a=a||{},this.scalable=null},ve.dm.ResizableNode.prototype.getScalable=function(){return this.scalable||(this.scalable=this.createScalable()),this.scalable},ve.dm.ResizableNode.prototype.createScalable=function(){throw new Error("ve.dm.ResizableNode subclass must implement createScalable")},ve.dm.Node=function(a){ve.dm.Model.call(this,a),ve.Node.call(this),OO.EventEmitter.call(this),this.length=0,this.element=a,this.doc=void 0},OO.inheritClass(ve.dm.Node,ve.dm.Model),OO.mixinClass(ve.dm.Node,ve.Node),OO.mixinClass(ve.dm.Node,OO.EventEmitter),ve.dm.Node.static.handlesOwnChildren=!1,ve.dm.Node.static.isInternal=!1,ve.dm.Node.static.isWrapped=!0,ve.dm.Node.static.isContent=!1,ve.dm.Node.static.canContainContent=!1,ve.dm.Node.static.hasSignificantWhitespace=!1,ve.dm.Node.static.childNodeTypes=null,ve.dm.Node.static.parentNodeTypes=null,ve.dm.Node.static.suggestedParentNodeTypes=null,ve.dm.Node.static.blacklistedAnnotationTypes=[],ve.dm.Node.static.defaultAttributes={},ve.dm.Node.static.remapStoreIndexes=function(){},ve.dm.Node.static.remapInternalListIndexes=function(){},ve.dm.Node.static.remapInternalListKeys=function(){},ve.dm.Node.static.isHybridInline=function(a,b){var c,d,e=!0;for(c=0,d=a.length;d>c;c++)if(ve.isBlockElement(a[c])){e=!1;break}return b.isExpectingContent()&&!b.isInWrapper()||b.isInWrapper()&&!b.canCloseWrapper()||e},ve.dm.Node.prototype.getClonedElement=function(){var a=ve.copy(this.element);return a.internal&&(delete a.internal.generated,ve.isEmptyObject(a.internal)&&delete a.internal),this.constructor.static.removeHtmlAttribute(a,"data-parsoid"),a},ve.dm.Node.prototype.getChildNodeTypes=function(){return this.constructor.static.childNodeTypes},ve.dm.Node.prototype.getParentNodeTypes=function(){return this.constructor.static.parentNodeTypes},ve.dm.Node.prototype.getSuggestedParentNodeTypes=function(){return this.constructor.static.suggestedParentNodeTypes},ve.dm.Node.prototype.canHaveChildren=function(){return ve.dm.nodeFactory.canNodeHaveChildren(this.type)},ve.dm.Node.prototype.canHaveChildrenNotContent=function(){return ve.dm.nodeFactory.canNodeHaveChildrenNotContent(this.type)},ve.dm.Node.prototype.isWrapped=function(){return this.constructor.static.isWrapped},ve.dm.Node.prototype.canContainContent=function(){return this.constructor.static.canContainContent},ve.dm.Node.prototype.isContent=function(){return this.constructor.static.isContent},ve.dm.Node.prototype.hasSignificantWhitespace=function(){return this.constructor.static.hasSignificantWhitespace},ve.dm.Node.prototype.handlesOwnChildren=function(){return this.constructor.static.handlesOwnChildren},ve.dm.Node.prototype.hasMatchingAncestor=function(a,b){for(var c,d=this;d&&d.getType()!==a;)if(d=d.getParent(),null===d)return!1;if(b)for(c in b)if(d.getAttribute(c)!==b[c])return!1;return!0},ve.dm.Node.prototype.getLength=function(){return this.length},ve.dm.Node.prototype.getOuterLength=function(){return this.length+(this.isWrapped()?2:0)},ve.dm.Node.prototype.getRange=function(){var a=this.getOffset();return this.isWrapped()&&a++,new ve.Range(a,a+this.length)},ve.dm.Node.prototype.getOuterRange=function(){var a=this.getOffset();return new ve.Range(a,a+this.getOuterLength())},ve.dm.Node.prototype.setLength=function(a){if(0>a)throw new Error("Length cannot be negative");var b=a-this.length;this.length=a,this.parent&&this.parent.adjustLength(b),this.emit("lengthChange",b),this.emit("update")},ve.dm.Node.prototype.adjustLength=function(a){this.setLength(this.length+a)},ve.dm.Node.prototype.getOffset=function(){var a,b,c,d;if(!this.parent)return 0;for(c=this.parent.children,d=this.parent.getOffset()+(this.parent===this.root?0:1),a=0,b=c.length;b>a&&c[a]!==this;a++)d+=c[a].getOuterLength();if(a===b)throw new Error("Node not found in parent's children array");return d},ve.dm.Node.prototype.canBeMergedWith=function(a){var b=this,c=a;for(b.canContainContent()&&c.isContent()?c=c.getParent():c.canContainContent()&&b.isContent()&&(b=b.getParent());b!==c;){if(null===b||null===c||b.getType()!==c.getType())return!1;b=b.getParent(),c=c.getParent()}return!0},ve.dm.BranchNode=function(a,b){ve.BranchNode.call(this),ve.dm.Node.call(this,a),ve.isArray(b)&&b.length&&this.splice.apply(this,[0,0].concat(b))},OO.inheritClass(ve.dm.BranchNode,ve.dm.Node),OO.mixinClass(ve.dm.BranchNode,ve.BranchNode),ve.dm.BranchNode.prototype.push=function(a){return this.splice(this.children.length,0,a),this.children.length},ve.dm.BranchNode.prototype.pop=function(){if(this.children.length){var a=this.children[this.children.length-1];return this.splice(this.children.length-1,1),a}},ve.dm.BranchNode.prototype.unshift=function(a){return this.splice(0,0,a),this.children.length},ve.dm.BranchNode.prototype.shift=function(){if(this.children.length){var a=this.children[0];return this.splice(0,1),a}},ve.dm.BranchNode.prototype.splice=function(){var a,b,c,d=Array.prototype.slice.call(arguments),e=0;for(c=this.children.splice.apply(this.children,d),a=0,b=c.length;b>a;a++)c[a].detach(),e-=c[a].getOuterLength();if(d.length>=3)for(b=d.length,a=2;b>a;a++)d[a].attach(this),e+=d[a].getOuterLength();return this.adjustLength(e,!0),this.emit.apply(this,["splice"].concat(d)),c},ve.dm.LeafNode=function(a){ve.LeafNode.call(this),ve.dm.Node.call(this,a)},OO.inheritClass(ve.dm.LeafNode,ve.dm.Node),OO.mixinClass(ve.dm.LeafNode,ve.LeafNode),ve.dm.LeafNode.static.childNodeTypes=[],ve.dm.LeafNode.prototype.getAnnotations=function(){return this.element.annotations||[]},ve.dm.Annotation=function(a){ve.dm.Model.call(this,a),this.name=this.constructor.static.name},OO.inheritClass(ve.dm.Annotation,ve.dm.Model),ve.dm.Annotation.static.enableAboutGrouping=!1,ve.dm.Annotation.static.applyToAppendedContent=!0,ve.dm.Annotation.static.splitOnWordbreak=!1,ve.dm.Annotation.static.removes=[],ve.dm.Annotation.static.toDomElements=function(){throw new Error("ve.dm.Annotation subclass must implement toDomElements")},ve.dm.Annotation.prototype.getDomElements=function(a){return this.constructor.static.toDomElements(this.element,a||document)},ve.dm.Annotation.prototype.getComparableObject=function(){var a=this.getHashObject();return delete a.htmlAttributes,a},ve.dm.Annotation.prototype.getComparableHtmlAttributes=function(){var a,b=this.getHtmlAttributes();return b[0]?(a=ve.copy(b[0].values),delete a["data-parsoid"],a):{}},ve.dm.Annotation.prototype.getComparableObjectForSerialization=function(){var a=this.getComparableObject(),b=this.getComparableHtmlAttributes();return ve.isEmptyObject(b)||(a.htmlAttributes=b),a},ve.dm.Annotation.prototype.isGenerated=function(){var a=this.getHtmlAttributes();return a[0]&&a[0].values&&a[0].values["data-parsoid"]},ve.dm.Annotation.prototype.compareTo=function(a){return ve.compare(this.getComparableObject(),a.getComparableObject())},ve.dm.Annotation.prototype.compareToForSerialization=function(a){return this.isGenerated()&&a.isGenerated()?ve.compare(this.getHashObject(),a.getHashObject()):ve.compare(this.getComparableObjectForSerialization(),a.getComparableObjectForSerialization())},ve.dm.InternalList=function(a){OO.EventEmitter.call(this),this.document=a,this.itemHtmlQueue=[],this.listNode=null,this.nodes={},this.groupsChanged=[],this.keyIndexes={},this.keys=[],this.nextUniqueNumber=0,a&&a.connect(this,{transact:"onTransact"})},OO.mixinClass(ve.dm.InternalList,OO.EventEmitter),ve.dm.InternalList.prototype.queueItemHtml=function(a,b,c){var d=!1,e=this.getKeyIndex(a,b);return void 0===e?(e=this.itemHtmlQueue.length,this.keyIndexes[a+"/"+b]=e,this.itemHtmlQueue.push(c),d=!0):""===this.itemHtmlQueue[e]&&(this.itemHtmlQueue[e]=c,d=!0),{index:e,isNew:d}},ve.dm.InternalList.prototype.getItemHtmlQueue=function(){return this.itemHtmlQueue},ve.dm.InternalList.prototype.getDocument=function(){return this.document},ve.dm.InternalList.prototype.getListNode=function(){var a,b;if(!this.listNode||!this.listNode.doc)for(b=this.getDocument().getDocumentNode().children,a=b.length;a>=0;a--)if(b[a]instanceof ve.dm.InternalListNode){this.listNode=b[a];break}return this.listNode},ve.dm.InternalList.prototype.getItemNodeCount=function(){return this.getListNode().children.length},ve.dm.InternalList.prototype.getItemNode=function(a){return this.getListNode().children[a]},ve.dm.InternalList.prototype.getNodeGroups=function(){return this.nodes},ve.dm.InternalList.prototype.getNodeGroup=function(a){return this.nodes[a]},ve.dm.InternalList.prototype.getUniqueListKey=function(a,b,c){var d=this.getNodeGroup(a),e=0;if(void 0!==d.uniqueListKeys[b])return d.uniqueListKeys[b];for(;d.keyedNodes[c+e]||d.uniqueListKeysInUse[c+e];)e++;return d.uniqueListKeys[b]=c+e,d.uniqueListKeysInUse[c+e]=!0,c+e},ve.dm.InternalList.prototype.getNextUniqueNumber=function(){return this.nextUniqueNumber++},ve.dm.InternalList.prototype.convertToData=function(a,b){var c,d,e,f=this.getItemHtmlQueue(),g=[];for(g.push({type:"internalList"}),c=0,d=f.length;d>c;c++)""!==f[c]?(e=a.getDataFromDomSubtree($("<div>",b).html(f[c])[0]),g=g.concat([{type:"internalItem"}],e,[{type:"/internalItem"}])):g=g.concat([{type:"internalItem"},{type:"/internalItem"}]);return g.push({type:"/internalList"}),this.itemHtmlQueue=[],g},ve.dm.InternalList.prototype.getItemInsertion=function(a,b,c){var d,e,f=this.getKeyIndex(a,b);return void 0===f?(f=this.getItemNodeCount(),this.keyIndexes[a+"/"+b]=f,e=[{type:"internalItem"}].concat(c,[{type:"/internalItem"}]),d=ve.dm.Transaction.newFromInsertion(this.getDocument(),this.getListNode().getRange().end,e)):d=null,{transaction:d,index:f}},ve.dm.InternalList.prototype.getIndexPosition=function(a,b){return ve.indexOf(b,this.nodes[a].indexOrder)},ve.dm.InternalList.prototype.getKeyIndex=function(a,b){return this.keyIndexes[a+"/"+b]},ve.dm.InternalList.prototype.addNode=function(a,b,c,d){var e,f,g,h,i=this.nodes[a];if(void 0===i&&(i=this.nodes[a]={keyedNodes:{},firstNodes:[],indexOrder:[],uniqueListKeys:{},uniqueListKeysInUse:{}}),h=i.keyedNodes[b],this.keys[c]=b,void 0===h&&(h=i.keyedNodes[b]=[]),d.getDocument().buildingNodeTree)h.push(d),1===h.length&&(i.firstNodes[c]=d);else{for(g=d.getRange().start,e=0,f=h.length;f>e&&!(g<h[e].getRange().start);e++);h.splice(e,0,d),0===e&&(i.firstNodes[c]=d)}-1===ve.indexOf(c,i.indexOrder)&&i.indexOrder.push(c),this.markGroupAsChanged(a)},ve.dm.InternalList.prototype.markGroupAsChanged=function(a){-1===ve.indexOf(a,this.groupsChanged)&&this.groupsChanged.push(a)},ve.dm.InternalList.prototype.onTransact=function(){var a;if(this.groupsChanged.length>0){for(a=0;a<this.groupsChanged.length;a++)this.sortGroupIndexes(this.nodes[this.groupsChanged[a]]);this.emit("update",this.groupsChanged),this.groupsChanged=[]}},ve.dm.InternalList.prototype.removeNode=function(a,b,c,d){var e,f,g,h,i=this.nodes[a];for(h=i.keyedNodes[b],e=0,f=h.length;f>e;e++)if(h[e]===d){h.splice(e,1),0===e&&(i.firstNodes[c]=h[0]);break}0===h.length&&(delete i.keyedNodes[b],delete i.firstNodes[c],g=ve.indexOf(c,i.indexOrder),i.indexOrder.splice(g,1)),this.markGroupAsChanged(a)},ve.dm.InternalList.prototype.sortGroupIndexes=function(a){a.indexOrder.sort(function(b,c){return a.firstNodes[b].getRange().start-a.firstNodes[c].getRange().start})},ve.dm.InternalList.prototype.clone=function(a){var b=new this.constructor(a||this.getDocument());return b.nextUniqueNumber=this.nextUniqueNumber,b.itemHtmlQueue=ve.copy(this.itemHtmlQueue),b},ve.dm.InternalList.prototype.merge=function(a,b){var c,d,e,f=a.getItemNodeCount(),g=this.getItemNodeCount(),h=[],i={};for(c=0;b>c;c++)i[c]=c;for(c=b;f>c;c++){e=void 0;for(d in a.keyIndexes)if(a.keyIndexes[d]===c){e=d;break}void 0!==this.keyIndexes[e]?i[c]=this.keyIndexes[e]:(i[c]=g,void 0!==e&&(this.keyIndexes[e]=g),g++,h.push(a.getItemNode(c).getOuterRange()))}return{mapping:i,newItemRanges:h}},ve.dm.MetaItem=function(a){ve.dm.Model.call(this,a),OO.EventEmitter.call(this),this.list=null,this.offset=null,this.index=null,this.move=null},OO.inheritClass(ve.dm.MetaItem,ve.dm.Model),OO.mixinClass(ve.dm.MetaItem,OO.EventEmitter),ve.dm.MetaItem.static.group="misc",ve.dm.MetaItem.prototype.remove=function(){if(!this.list)throw new Error("Cannot remove detached item");this.list.removeMeta(this)},ve.dm.MetaItem.prototype.replaceWith=function(a){var b=this.getOffset(),c=this.getIndex(),d=this.list;d.removeMeta(this),d.insertMeta(a,b,c)},ve.dm.MetaItem.prototype.getGroup=function(){return this.constructor.static.group},ve.dm.MetaItem.prototype.getParentList=function(){return this.list},ve.dm.MetaItem.prototype.getOffset=function(){return this.offset},ve.dm.MetaItem.prototype.getIndex=function(){return this.index},ve.dm.MetaItem.prototype.setOffset=function(a){this.offset=a},ve.dm.MetaItem.prototype.setIndex=function(a){this.index=a},ve.dm.MetaItem.prototype.attach=function(a,b,c){this.list=a,this.offset=b,this.index=c},ve.dm.MetaItem.prototype.detach=function(a){this.list===a&&(this.list=null,this.offset=null,this.index=null)},ve.dm.MetaItem.prototype.isAttached=function(){return null!==this.list},ve.dm.MetaList=function(a){var b,c,d,e,f,g;OO.EventEmitter.call(this),this.surface=a,this.document=a.getDocument(),this.groups={},this.items=[],this.document.connect(this,{transact:"onTransact"}),e=this.document.getMetadata();for(b in e)if(e.hasOwnProperty(b)&&ve.isArray(e[b]))for(c=0,d=e[b].length;d>c;c++)f=ve.dm.metaItemFactory.createFromElement(e[b][c]),g=this.groups[f.getGroup()],g||(g=this.groups[f.getGroup()]=[]),f.attach(this,Number(b),c),g.push(f),this.items.push(f)},OO.mixinClass(ve.dm.MetaList,OO.EventEmitter),ve.dm.MetaList.prototype.onTransact=function(a){var b,c,d,e,f,g,h,i,j,k,l,m=this.items.length,n=0,o=0,p=0,q=0,r=0,s=[],t=[],u=[],v=a.getOperations();for(b=0,c=v.length;c>b;b++)switch(v[b].type){case"retain":for(;m>n&&this.items[n].offset<o+v[b].length;n++)s.push({item:this.items[n],offset:this.items[n].offset+p-o,index:this.items[n].offset===o?r-q+this.items[n].index:this.items[n].index});
o+=v[b].length,p+=v[b].length,q=0,r=0;break;case"retainMetadata":for(;m>n&&this.items[n].offset===o&&this.items[n].index<q+v[b].length;n++)s.push({item:this.items[n],offset:p,index:this.items[n].index+r-q});q+=v[b].length,r+=v[b].length;break;case"replace":if(i=v[b].insert,j=v[b].remove,void 0!==v[b].removeMetadata){for(k=v[b].insertMetadata,l=v[b].removeMetadata;m>n&&this.items[n].offset<o+l.length;n++)t.push(this.items[n]);for(d=0,e=k.length;e>d;d++)if(k[d])for(f=0,g=k[d].length;g>f;f++)h=ve.dm.metaItemFactory.createFromElement(k[d][f]),s.push({item:h,offset:p+d,index:f})}else for(;m>n&&this.items[n].offset<o+j.length;n++)s.push({item:this.items[n],offset:this.items[n].offset+p-o,index:this.items[n].index});o+=j.length,p+=i.length;break;case"replaceMetadata":for(k=v[b].insert,l=v[b].remove;m>n&&this.items[n].offset===o&&this.items[n].index<q+l.length;n++)t.push(this.items[n]);for(d=0,e=k.length;e>d;d++)h=ve.dm.metaItemFactory.createFromElement(k[d]),s.push({item:h,offset:p,index:r+d});q+=l.length,r+=k.length}for(;m>n;n++)s.push({item:this.items[n],offset:this.items[n].offset+p-o,index:this.items[n].offset===o?r-q+this.items[n].index:this.items[n].index});for(b=0,c=t.length;c>b;b++)this.deleteRemovedItem(t[b].offset,t[b].index),u.push(["remove",t[b],t[b].offset,t[b].index]);for(b=0,c=s.length;c>b;b++)s[b].item.isAttached()&&(s[b].offset!==s[b].item.offset||s[b].index!==s[b].item.index)&&(this.deleteRemovedItem(s[b].item.offset,s[b].item.index),s[b].preExisting=!0);for(b=0,c=s.length;c>b;b++)s[b].item.isAttached()||(this.addInsertedItem(s[b].offset,s[b].index,s[b].item),s[b].preExisting||u.push(["insert",s[b].item]));for(b=0,c=u.length;c>b;b++)this.emit.apply(this,u[b])},ve.dm.MetaList.prototype.findItem=function(a,b,c,d){for(var e,f="string"==typeof c?this.groups[c]||[]:this.items,g=0,h=f.length;h>g;){if(e=g+h>>1,f[e].getOffset()===a&&f[e].getIndex()===b)return e;f[e].getOffset()<a||f[e].getOffset()===a&&f[e].getIndex()<b?g=e+1:h=e}return d?g:null},ve.dm.MetaList.prototype.getItemAt=function(a,b){var c=this.findItem(a,b);return null===c?null:this.items[c]},ve.dm.MetaList.prototype.getItemsInGroup=function(a){return(this.groups[a]||[]).slice(0)},ve.dm.MetaList.prototype.getAllItems=function(){return this.items.slice(0)},ve.dm.MetaList.prototype.insertMeta=function(a,b,c){var d;a instanceof ve.dm.MetaItem&&(a=a.getElement()),void 0===b&&(b=this.document.data.getLength()),void 0===c&&(c=(this.document.metadata.getData(b)||[]).length),d=ve.dm.Transaction.newFromMetadataInsertion(this.document,b,c,[a]),this.surface.change(d)},ve.dm.MetaList.prototype.removeMeta=function(a){var b;b=ve.dm.Transaction.newFromMetadataRemoval(this.document,a.getOffset(),new ve.Range(a.getIndex(),a.getIndex()+1)),this.surface.change(b)},ve.dm.MetaList.prototype.addInsertedItem=function(a,b,c){var d=c.getGroup(),e=this.findItem(a,b,null,!0);this.items.splice(e,0,c),this.groups[d]?(e=this.findItem(a,b,d,!0),this.groups[d].splice(e,0,c)):this.groups[d]=[c],c.attach(this,a,b)},ve.dm.MetaList.prototype.deleteRemovedItem=function(a,b){var c,d,e=this.findItem(a,b);if(null!==e)return c=this.items[e],d=c.getGroup(),this.items.splice(e,1),e=this.findItem(a,b,d),null!==e&&this.groups[d].splice(e,1),c.detach(this),c},ve.dm.TransactionProcessor=function(a,b){this.document=a,this.transaction=b,this.operations=b.getOperations(),this.synchronizer=new ve.dm.DocumentSynchronizer(a,b),this.cursor=0,this.metadataCursor=0,this.adjustment=0,this.set=new ve.dm.AnnotationSet(this.document.getStore()),this.clear=new ve.dm.AnnotationSet(this.document.getStore())},ve.dm.TransactionProcessor.processors={},ve.dm.TransactionProcessor.prototype.nextOperation=function(){return this.operations[this.operationIndex++]||!1},ve.dm.TransactionProcessor.prototype.executeOperation=function(a){if(!(a.type in ve.dm.TransactionProcessor.processors))throw new Error("Invalid operation error. Operation type is not supported: "+a.type);ve.dm.TransactionProcessor.processors[a.type].call(this,a)},ve.dm.TransactionProcessor.prototype.advanceCursor=function(a){this.cursor+=a,this.metadataCursor=0},ve.dm.TransactionProcessor.prototype.process=function(){var a;for(this.operationIndex=0;a=this.nextOperation();)this.executeOperation(a);this.synchronizer.synchronize(),this.transaction.markAsApplied()},ve.dm.TransactionProcessor.prototype.applyAnnotations=function(a){function b(a,b,c){if(a.containsAnyOf(b))throw new Error("Invalid transaction, annotation to be set is already set");if(a.addSet(b),!a.containsAllOf(c))throw new Error("Invalid transaction, annotation to be cleared is not set");a.removeSet(c)}var c,d,e,f,g,h,i;if(!this.set.isEmpty()||!this.clear.isEmpty()){for(e=this.cursor;a>e;e++){if(c=this.document.data.isElementData(e)){if(!ve.dm.nodeFactory.isNodeContent(this.document.data.getType(e)))throw new Error("Invalid transaction, cannot annotate a non-content element");if(this.document.data.isCloseElementData(e))continue}d=this.document.data.getAnnotationsFromOffset(e),b(d,this.set,this.clear),this.document.data.setAnnotationsAtOffset(e,d)}for(e=this.cursor+1;a>e;e++)for(f=0,g=this.document.metadata.getDataLength(e);g>f;f++)d=this.document.metadata.getAnnotationsFromOffsetAndIndex(e,f),b(d,this.set,this.clear),this.document.metadata.setAnnotationsAtOffsetAndIndex(e,f,d);this.cursor<a&&(h=new ve.Range(this.cursor,a),i=this.document.selectNodes(new ve.Range(this.cursor-this.adjustment,a-this.adjustment),"leaves"),this.synchronizer.pushAnnotation(new ve.Range(this.cursor,a)))}},ve.dm.TransactionProcessor.processors.retain=function(a){this.applyAnnotations(this.cursor+a.length),this.advanceCursor(a.length)},ve.dm.TransactionProcessor.processors.retainMetadata=function(a){this.metadataCursor+=a.length},ve.dm.TransactionProcessor.processors.annotate=function(a){var b;if("set"===a.method)b=this.set;else{if("clear"!==a.method)throw new Error("Invalid annotation method "+a.method);b=this.clear}"start"===a.bias?b.push(a.annotation):b.remove(a.annotation)},ve.dm.TransactionProcessor.processors.attribute=function(a){var b=this.document.data.getData(this.cursor),c=a.to,d=a.from;if(void 0===b.type)throw new Error("Invalid element error, cannot set attributes on non-element data");void 0===c?b.attributes&&delete b.attributes[a.key]:(b.attributes||(b.attributes={}),b.attributes[a.key]=c),this.synchronizer.pushAttributeChange(this.document.getDocumentNode().getNodeFromOffset(this.cursor+1),a.key,d,c)},ve.dm.TransactionProcessor.processors.replace=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p=a.remove,q=a.insert,r=a.removeMetadata,s=a.insertMetadata,t=new ve.dm.ElementLinearData(this.document.getStore(),p),u=new ve.dm.ElementLinearData(this.document.getStore(),q),v=t.isContentData(),w=u.isContentData(),x=t.containsElementData(),y=u.containsElementData(),z=a,A=0,B=0,C=[],D=0,E=0;if(v&&w)this.document.data.batchSplice(this.cursor,p.length,q),void 0!==r?this.document.metadata.batchSplice(this.cursor,r.length,s):this.document.metadata.batchSplice(this.cursor,p.length,new Array(q.length)),this.applyAnnotations(this.cursor+q.length),c=this.document.selectNodes(new ve.Range(this.cursor-this.adjustment,this.cursor-this.adjustment+p.length),"leaves"),b=c[0].node,x||y||1!==c.length||!b||"text"!==b.getType()?(d=new ve.Range(c[0].nodeOuterRange.start,c[c.length-1].nodeOuterRange.end),this.synchronizer.pushRebuild(d,new ve.Range(d.start+this.adjustment,d.end+this.adjustment+q.length-p.length))):this.synchronizer.pushResize(b,q.length-p.length),this.advanceCursor(q.length),this.adjustment+=q.length-p.length;else{for(;;){if("replace"===z.type){if(l=z.remove,m=z.insert,n=z.removeMetadata,o=z.insertMetadata,this.document.data.batchSplice(this.cursor,l.length,m),void 0!==n?this.document.metadata.batchSplice(this.cursor,n.length,o):this.document.metadata.batchSplice(this.cursor,l.length,new Array(m.length)),C.push(new ve.Range(this.cursor-this.adjustment,this.cursor-this.adjustment+l.length)),g=this.cursor,this.advanceCursor(m.length),l.length>0)for(c=this.document.selectNodes(new ve.Range(g-this.adjustment,g+l.length-this.adjustment),"siblings"),e=0;e<c.length;e++)C.push(c[e].nodeOuterRange);for(e=0;e<l.length;e++)f=l[e].type,void 0!==f&&("/"===f.charAt(0)?A--:A++);for(e=0;e<m.length;e++)f=m[e].type,void 0!==f&&("/"===f.charAt(0)?(B--,D>B&&(h=h||this.document.getNodeFromOffset(g),j=h.getOffset(),k=j+h.getOuterLength(),C.push(new ve.Range(j,k)),h=h.getParent()||h,D--)):B++);this.adjustment+=m.length-l.length,E+=m.length-l.length}else this.executeOperation(z);if(0===A&&0===B)break;if(z=this.nextOperation(),!z)throw new Error("Unbalanced set of replace operations found")}i=ve.Range.newCoveringRange(C),this.synchronizer.pushRebuild(i,new ve.Range(i.start+this.adjustment-E,i.end+this.adjustment))}},ve.dm.TransactionProcessor.processors.replaceMetadata=function(a){var b=a.remove,c=a.insert;this.document.spliceMetadata(this.cursor,this.metadataCursor,b.length,c),this.metadataCursor+=c.length},ve.dm.Transaction=function(){this.operations=[],this.lengthDifference=0,this.applied=!1},ve.dm.Transaction.newFromReplacement=function(a,b,c,d){var e,f=new ve.dm.Transaction;return e=f.pushRemoval(a,0,b,d),e=f.pushInsertion(a,e,e,c),f.pushFinalRetain(a,e),f},ve.dm.Transaction.newFromInsertion=function(a,b,c){var d=new ve.dm.Transaction,e=d.pushInsertion(a,0,b,c);return d.pushFinalRetain(a,e),d},ve.dm.Transaction.newFromRemoval=function(a,b,c){var d=new ve.dm.Transaction,e=d.pushRemoval(a,0,b,c);return d.pushFinalRetain(a,e),d},ve.dm.Transaction.newFromDocumentInsertion=function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r=a.internalList.getListNode(),s=r.getRange(),t=c.internalList.getListNode(),u=t.getRange(),v=t.getOuterRange();for(d?(h=new ve.dm.ElementLinearData(a.getStore(),c.getData(d,!0)),i=new ve.dm.MetaLinearData(a.getStore(),c.getMetadata(d,!0))):(h=new ve.dm.ElementLinearData(a.getStore(),c.getData(new ve.Range(0,v.start),!0).concat(c.getData(new ve.Range(v.end,c.data.getLength()),!0))),i=new ve.dm.MetaLinearData(a.getStore(),c.getMetadata(new ve.Range(0,v.start),!0).concat(v.end<c.data.getLength()?c.getMetadata(new ve.Range(v.end+1,c.data.getLength()),!0):[]))),g=a.getStore().merge(c.getStore()),h.remapStoreIndexes(g),g=a.internalList.merge(c.internalList,c.origInternalListLength||0),h.remapInternalListIndexes(g.mapping,a.internalList),c.origDoc===a?(c.origInternalListLength>0?(l=a.internalList.getItemNode(c.origInternalListLength-1).getOuterRange().end,m=c.internalList.getItemNode(c.origInternalListLength-1).getOuterRange().end):(l=s.start,m=u.start),j=c.getData(new ve.Range(u.start,m),!0).concat(a.getData(new ve.Range(l,s.end),!0)),k=c.getMetadata(new ve.Range(u.start,m),!0).concat(a.getMetadata(new ve.Range(l,s.end),!0))):(j=a.getData(s,!0),k=a.getMetadata(s,!0)),e=0,f=g.newItemRanges.length;f>e;e++)j=j.concat(c.getData(g.newItemRanges[e],!0)),k=k.concat(c.getMetadata(g.newItemRanges[e],!0));if(n=new ve.dm.Transaction,b<=s.start)o=a.fixupInsertion(h.data,b),n.pushRetain(o.offset),n.pushReplace(a,o.offset,o.remove,o.data,i.data),n.pushRetain(s.start-(o.offset+o.remove)),n.pushReplace(a,s.start,s.end-s.start,j,k),n.pushFinalRetain(a,s.end);else if(b>=s.end)o=a.fixupInsertion(h.data,b),n.pushRetain(s.start),n.pushReplace(a,s.start,s.end-s.start,j,k),n.pushRetain(o.offset-s.end),n.pushReplace(a,o.offset,o.remove,o.data,i.data),n.pushFinalRetain(a,o.offset+o.remove);else if(b>=s.start&&b<=s.end){for(e=0;(p=a.internalList.getItemNode(e).getRange())&&b>p.end;)e++;c.origDoc===a?(p=c.internalList.getItemNode(e).getRange(),q=u):q=s,ve.batchSplice(j,p.start-q.start,p.end-p.start,h.data),ve.batchSplice(k,p.start-q.start,p.end-p.start,i.data),n.pushRetain(s.start),n.pushReplace(a,s.start,s.end-s.start,j,k),n.pushFinalRetain(a,s.end)}return n},ve.dm.Transaction.newFromAttributeChanges=function(a,b,c){var d,e,f=new ve.dm.Transaction,g=a.getData();if(void 0===g[b].type)throw new Error("Cannot set attributes to non-element data");if("/"===g[b].type.charAt(0))throw new Error("Cannot set attributes on closing element");f.pushRetain(b);for(d in c)e="attributes"in g[b]?g[b].attributes[d]:void 0,e!==c[d]&&f.pushReplaceElementAttribute(d,e,c[d]);return f.pushFinalRetain(a,b),f},ve.dm.Transaction.newFromAnnotation=function(a,b,c,d){for(var e,f,g,h=new ve.dm.Transaction,i=a.data,j=b.start,k=j,l=!1,m=!1,n=0;j<b.end;)i.isElementData(j)?(f=i.getType(j),ve.dm.nodeFactory.doesNodeHandleOwnChildren(f)&&(n+=i.isOpenElementData(j)?1:-1),g=ve.dm.nodeFactory.isNodeContent(f)&&("set"!==c||ve.dm.nodeFactory.canNodeTakeAnnotationType(f,d))?!0:!1):g=!0,g=g&&!n,!g||m&&!i.isCloseElementData(j)?l&&(h.pushRetain(k),h.pushStopAnnotating(c,d),k=0,l=!1):i.isElementData(j)&&i.isCloseElementData(j)||m?i.isCloseElementData(j)&&(m=!1):(i.isElementData(j)&&(m=!0),e="set"===c?i.getAnnotationsFromOffset(j).containsComparable(d):i.getAnnotationsFromOffset(j).contains(d),e&&"set"===c||!e&&"clear"===c?l&&(h.pushRetain(k),h.pushStopAnnotating(c,d),k=0,l=!1):l||(h.pushRetain(k),h.pushStartAnnotating(c,d),k=0,l=!0)),k++,j++;return h.pushRetain(k),l&&h.pushStopAnnotating(c,d),h.pushFinalRetain(a,b.end),h},ve.dm.Transaction.newFromMetadataInsertion=function(a,b,c,d){var e=new ve.dm.Transaction,f=a.metadata,g=f.getData(b)||[];return 0===d.length?e:(e.pushRetain(b),e.pushRetainMetadata(c),e.pushReplaceMetadata([],d),e.pushRetainMetadata(g.length-c),e.pushFinalRetain(a,b,g.length),e)},ve.dm.Transaction.newFromMetadataRemoval=function(a,b,c){var d,e=new ve.dm.Transaction,f=a.metadata,g=f.getData(b)||[];if(!g.length)throw new Error("Cannot remove metadata from empty list");if(c.start<0||c.end>g.length)throw new Error("Range out of bounds");return d=g.slice(c.start,c.end),0===d.length?e:(e.pushRetain(b),e.pushRetainMetadata(c.start),e.pushReplaceMetadata(d,[]),e.pushRetainMetadata(g.length-c.end),e.pushFinalRetain(a,b,g.length),e)},ve.dm.Transaction.newFromMetadataElementReplacement=function(a,b,c,d){var e,f=new ve.dm.Transaction,g=a.getMetadata(),h=g[b]||[];if(c>=h.length)throw new Error("Metadata index out of bounds");return e=h[c],f.pushRetain(b),f.pushRetainMetadata(c),f.pushReplaceMetadata([e],[d]),f.pushRetainMetadata(h.length-c-1),f.pushFinalRetain(a,b,h.length),f},ve.dm.Transaction.newFromContentBranchConversion=function(a,b,c,d){var e,f,g,h,i,j,k=new ve.dm.Transaction,l=a.selectNodes(b,"leaves"),m={type:c},n={type:"/"+c};for(ve.isPlainObject(d)?m.attributes=d:d={},e=0;e<l.length;e++)if(f=l[e],g=f.node.isContent()?f.node.getParent():f.node,g.canContainContent()){if(g.getType()===c&&ve.compare(g.getAttributes(),d))continue;if(h=g.getOuterRange(),g===i)continue;k.pushRetain(h.start-(i?j.end:0)),k.pushReplace(a,h.start,1,[ve.copy(m)]),k.pushRetain(g.getLength()),k.pushReplace(a,h.end-1,1,[ve.copy(n)]),i=g,j=h}return k.pushFinalRetain(a,i?j.end:0),k},ve.dm.Transaction.newFromWrap=function(a,b,c,d,e,f){function g(a){var b,c=[],d=a.length;for(b=0;d>b;b++)c[c.length]={type:"/"+a[d-b-1].type};return c}var h,i,j,k,l,m,n,o=new ve.dm.Transaction,p=0;if(m=g(e),n=g(f),b.start>c.length)o.pushRetain(b.start-c.length);else if(b.start<c.length)throw new Error("unwrapOuter is longer than the data preceding the range");if(d.length>0||c.length>0){for(j=a.data.slice(b.start-c.length,b.start),h=0;h<j.length;h++)if(j[h].type!==c[h].type)throw new Error("Element in unwrapOuter does not match: expected "+c[h].type+" but found "+j[h].type);o.pushReplace(a,b.start-c.length,c.length,ve.copy(d))}if(f.length>0||e.length>0){for(h=b.start;h<b.end;h++)if(a.data.isElementData(h))if(a.data.isCloseElementData(h))p--,0===p&&(i=h+1-e.length,o.pushRetain(i-k),o.pushReplace(a,i,e.length,ve.copy(n)));else{if(0===p){for(l=a.data.slice(h,h+e.length),i=0;i<l.length;i++)if(l[i].type!==e[i].type)throw new Error("Element in unwrapEach does not match: expected "+e[i].type+" but found "+l[i].type);o.pushReplace(a,h,e.length,ve.copy(f)),k=h+e.length}p++}}else o.pushRetain(b.end-b.start);return o.pushReplace(a,b.end,c.length,g(d)),o.pushFinalRetain(a,b.end+c.length),o},ve.dm.Transaction.reversers={annotate:{method:{set:"clear",clear:"set"}},attribute:{from:"to",to:"from"},replace:{insert:"remove",remove:"insert",insertMetadata:"removeMetadata",removeMetadata:"insertMetadata"},replaceMetadata:{insert:"remove",remove:"insert"}},ve.dm.Transaction.prototype.clone=function(){var a=new this.constructor;return a.operations=ve.copy(this.operations),a.lengthDifference=this.lengthDifference,a},ve.dm.Transaction.prototype.reversed=function(){var a,b,c,d,e,f,g=new this.constructor;for(a=0,b=this.operations.length;b>a;a++){c=this.operations[a],d=ve.copy(c),e=this.constructor.reversers[c.type]||{};for(f in e)d[f]="string"==typeof e[f]?c[e[f]]:e[f][c[f]];g.operations.push(d)}return g.lengthDifference=-this.lengthDifference,g},ve.dm.Transaction.prototype.isNoOp=function(){return 0===this.operations.length?!0:1===this.operations.length?"retain"===this.operations[0].type:2===this.operations.length?"retain"===this.operations[0].type&&"retainMetadata"===this.operations[1].type:!1},ve.dm.Transaction.prototype.getOperations=function(){return this.operations},ve.dm.Transaction.prototype.hasOperationWithType=function(a){var b,c;for(b=0,c=this.operations.length;c>b;b++)if(this.operations[b].type===a)return!0;return!1},ve.dm.Transaction.prototype.hasContentDataOperations=function(){return this.hasOperationWithType("replace")},ve.dm.Transaction.prototype.hasElementAttributeOperations=function(){return this.hasOperationWithType("attribute")},ve.dm.Transaction.prototype.hasAnnotationOperations=function(){return this.hasOperationWithType("annotate")},ve.dm.Transaction.prototype.getLengthDifference=function(){return this.lengthDifference},ve.dm.Transaction.prototype.hasBeenApplied=function(){return this.applied},ve.dm.Transaction.prototype.markAsApplied=function(){this.applied=!0},ve.dm.Transaction.prototype.translateOffset=function(a,b){var c,d,e,f,g,h=0,i=0;for(c=0;c<this.operations.length;c++)if(d=this.operations[c],"replace"===d.type){if(e=d.insert.length,f=d.remove.length,g=i,i+=e-f,a===h+f)return b&&e>f?a+i-e+f:a+i;if(a===h)return 0===e?h+f+i:h+g;if(a>h&&h+f>a)return h+f+i;h+=f}else if("retain"===d.type){if(a>=h&&a<h+d.length)return a+i;h+=d.length}return a+i},ve.dm.Transaction.prototype.translateRange=function(a,b){var c=this.translateOffset(a.start,!b),d=this.translateOffset(a.end,b);return a.isBackwards()?new ve.Range(d,c):new ve.Range(c,d)},ve.dm.Transaction.prototype.getModifiedRange=function(){var a,b,c,d,e,f=0;for(a=0,b=this.operations.length;b>a;a++)switch(c=this.operations[a],c.type){case"retainMetadata":continue;case"retain":f+=c.length;break;default:void 0===d&&(d=f+(c.insertedDataOffset||0)),"replace"===c.type&&(f+=c.insert.length),e=c.insertedDataLength?d+c.insertedDataLength:f}return void 0===d||void 0===e?null:new ve.Range(d,e)},ve.dm.Transaction.prototype.pushFinalRetain=function(a,b,c){var d=a.data,e=a.metadata,f=e.getData(d.getLength());b<a.data.getLength()&&(this.pushRetain(a.data.getLength()-b),c=0),void 0!==f&&f.length>0&&this.pushRetainMetadata(f.length-(c||0))},ve.dm.Transaction.prototype.pushRetain=function(a){if(0>a)throw new Error("Invalid retain length, cannot retain backwards:"+a);if(a){var b=this.operations.length-1;this.operations.length&&"retain"===this.operations[b].type?this.operations[b].length+=a:this.operations.push({type:"retain",length:a})}},ve.dm.Transaction.prototype.pushRetainMetadata=function(a){if(0>a)throw new Error("Invalid retain length, cannot retain backwards:"+a);if(a){var b=this.operations.length-1;this.operations.length&&"retainMetadata"===this.operations[b].type?this.operations[b].length+=a:this.operations.push({type:"retainMetadata",length:a})}},ve.dm.Transaction.prototype.addSafeRemoveOps=function(a,b,c,d){var e,f,g=0;for(e=b;c>e;e++)a.data.isElementData(e)&&ve.dm.nodeFactory.isNodeInternal(a.data.getType(e))&&(a.data.isCloseElementData(e)?(g--,0===g&&(this.pushRetain(e+1-f),b=e+1)):(0===g&&(this.pushReplace(a,b,e-b,[],d?[]:void 0),f=e),g++));this.pushReplace(a,b,c-b,[],d?[]:void 0)},ve.dm.Transaction.prototype.pushReplace=function(a,b,c,d,e,f,g){if(0!==c||0!==d.length){var h,i,j=this.operations.length-1,k=j>=0?this.operations[j]:null,l=j>=1?this.operations[j-1]:null,m=new ve.Range(b,b+c),n=a.getData(m),o=a.getMetadata(m),p=ve.compare(o,new Array(o.length)),q=e&&ve.compare(e,new Array(e.length));if(e||p?q&&p&&(e=void 0):(e=ve.dm.MetaLinearData.static.merge(o),0===d.length?(i=e[0],e=[]):ve.batchSplice(e,1,0,new Array(d.length-1))),k&&"replaceMetadata"===k.type&&k.insert.length>0&&0===k.remove.length&&l&&"replace"===l.type&&0===l.insert.length&&(this.operations.pop(),k=l),k&&"replace"===k.type&&!(k.insert.length>0&&void 0!==e))return k=this.operations.pop(),this.lengthDifference-=k.insert.length-k.remove.length,void this.pushReplace(a,b-k.remove.length,k.remove.length+c,k.insert.concat(d));if(k&&"replaceMetadata"===k.type)throw new Error("replace after replaceMetadata not allowed");h={type:"replace",remove:n,insert:d},void 0!==e&&(h.removeMetadata=o,h.insertMetadata=e),void 0!==f&&(h.insertedDataOffset=f,h.insertedDataLength=g),this.operations.push(h),this.lengthDifference+=d.length-n.length,void 0!==i&&this.pushReplaceMetadata([],i)}},ve.dm.Transaction.prototype.pushReplaceMetadata=function(a,b){(0!==a.length||0!==b.length)&&this.operations.push({type:"replaceMetadata",remove:a,insert:b})},ve.dm.Transaction.prototype.pushReplaceElementAttribute=function(a,b,c){this.operations.push({type:"attribute",key:a,from:b,to:c})},ve.dm.Transaction.prototype.pushStartAnnotating=function(a,b){this.operations.push({type:"annotate",method:a,bias:"start",annotation:b})},ve.dm.Transaction.prototype.pushStopAnnotating=function(a,b){this.operations.push({type:"annotate",method:a,bias:"stop",annotation:b})},ve.dm.Transaction.prototype.pushInsertion=function(a,b,c,d){var e=a.fixupInsertion(d,c);return this.pushRetain(e.offset-b),this.pushReplace(a,e.offset,e.remove,e.data,void 0,e.insertedDataOffset,e.insertedDataLength),e.offset+e.remove},ve.dm.Transaction.prototype.pushRemoval=function(a,b,c,d){var e,f,g,h,i,j,k=b,l=null,m=null;if(c.isCollapsed())return this.pushRetain(c.start-b),c.start;if(f=a.selectNodes(c,"covered"),0===f.length)throw new Error("Invalid range, cannot remove from "+c.start+" to "+c.end);if(g=f[0],h=f[f.length-1],g.node.canBeMergedWith(h.node))return g.range||h.range?(l=(g.range||g.nodeRange).start,m=(h.range||h.nodeRange).end):(l=g.nodeOuterRange.start,m=h.nodeOuterRange.end),this.pushRetain(l-b),this.addSafeRemoveOps(a,l,m,d),m;for(e=0;e<f.length;e++)f[e].range?(i=f[e].range.start,j=f[e].range.end):(i=f[e].nodeOuterRange.start,j=f[e].nodeOuterRange.end),null===m?(l=i,m=j):m===i?m=j:(this.pushRetain(l-k),this.addSafeRemoveOps(a,l,m,d),k=m,l=i,m=j);return null!==m&&(this.pushRetain(l-k),this.addSafeRemoveOps(a,l,m,d),k=m),k},ve.dm.Surface=function(a){OO.EventEmitter.call(this),this.documentModel=a,this.metaList=new ve.dm.MetaList(this),this.selection=null,this.selectionBefore=null,this.selectedNodes={},this.newTransactions=[],this.stagingStack=[],this.undoStack=[],this.undoIndex=0,this.historyTrackingInterval=null,this.insertionAnnotations=new ve.dm.AnnotationSet(this.documentModel.getStore()),this.enabled=!0,this.transacting=!1,this.queueingContextChanges=!1,this.contextChangeQueued=!1,this.documentModel.connect(this,{transact:"onDocumentTransact"})},OO.mixinClass(ve.dm.Surface,OO.EventEmitter),ve.dm.Surface.prototype.disable=function(){this.stopHistoryTracking(),this.enabled=!1,this.emit("history")},ve.dm.Surface.prototype.enable=function(){this.enabled=!0,this.startHistoryTracking(),this.emit("history")},ve.dm.Surface.prototype.startHistoryTracking=function(){this.enabled&&null===this.historyTrackingInterval&&(this.historyTrackingInterval=setInterval(ve.bind(this.breakpoint,this),750))},ve.dm.Surface.prototype.stopHistoryTracking=function(){this.enabled&&null!==this.historyTrackingInterval&&(clearInterval(this.historyTrackingInterval),this.historyTrackingInterval=null)},ve.dm.Surface.prototype.getHistory=function(){return this.newTransactions.length>0?this.undoStack.slice(0).concat([{transactions:this.newTransactions.slice(0)}]):this.undoStack.slice(0)},ve.dm.Surface.prototype.isStaging=function(){return this.stagingStack.length>0},ve.dm.Surface.prototype.getStaging=function(){return this.stagingStack[this.stagingStack.length-1]},ve.dm.Surface.prototype.doesStagingAllowUndo=function(){var a=this.getStaging();return a&&a.allowUndo},ve.dm.Surface.prototype.getStagingTransactions=function(){var a=this.getStaging();return a&&a.transactions},ve.dm.Surface.prototype.pushStaging=function(a){this.isStaging()||(this.breakpoint(),this.stopHistoryTracking(),this.emit("history")),this.stagingStack.push({transactions:[],allowUndo:!!a})},ve.dm.Surface.prototype.popStaging=function(){if(this.isStaging()){var a,b,c=[],d=this.stagingStack.pop(),e=d.transactions;for(a=e.length-1;a>=0;a--)b=e[a].reversed(),c.push(b);return this.changeInternal(c,void 0,!0),this.isStaging()||(this.startHistoryTracking(),this.emit("history")),e}},ve.dm.Surface.prototype.applyStaging=function(){if(this.isStaging()){var a=this.stagingStack.pop(),b=a.transactions;this.isStaging()?Array.prototype.push.apply(this.getStagingTransactions(),b):(this.truncateUndoStack(),this.newTransactions=b,this.breakpoint()),this.isStaging()||(this.startHistoryTracking(),this.emit("history"))}},ve.dm.Surface.prototype.popAllStaging=function(){if(this.isStaging()){for(var a=[];this.isStaging();)ve.batchSplice(a,0,0,this.popStaging());return a}},ve.dm.Surface.prototype.applyAllStaging=function(){for(;this.isStaging();)this.applyStaging()},ve.dm.Surface.prototype.getInsertionAnnotations=function(){return this.insertionAnnotations.clone()},ve.dm.Surface.prototype.setInsertionAnnotations=function(a){this.enabled&&(this.insertionAnnotations=null!==a?a.clone():new ve.dm.AnnotationSet(this.documentModel.getStore()),this.emit("insertionAnnotationsChange",this.insertionAnnotations),this.isStaging()||this.emit("contextChange"))},ve.dm.Surface.prototype.addInsertionAnnotations=function(a){if(this.enabled){if(a instanceof ve.dm.Annotation)this.insertionAnnotations.push(a);else{if(!(a instanceof ve.dm.AnnotationSet))throw new Error("Invalid annotations");this.insertionAnnotations.addSet(a)}this.emit("insertionAnnotationsChange",this.insertionAnnotations),this.isStaging()||this.emit("contextChange")}},ve.dm.Surface.prototype.removeInsertionAnnotations=function(a){if(this.enabled){if(a instanceof ve.dm.Annotation)this.insertionAnnotations.remove(a);else{if(!(a instanceof ve.dm.AnnotationSet))throw new Error("Invalid annotations");this.insertionAnnotations.removeSet(a)}this.emit("insertionAnnotationsChange",this.insertionAnnotations),this.isStaging()||this.emit("contextChange")}},ve.dm.Surface.prototype.canRedo=function(){return this.undoIndex>0&&this.enabled},ve.dm.Surface.prototype.canUndo=function(){return this.hasBeenModified()&&this.enabled&&(!this.isStaging()||this.doesStagingAllowUndo())},ve.dm.Surface.prototype.hasBeenModified=function(){return this.undoStack.length-this.undoIndex>0||!!this.newTransactions.length},ve.dm.Surface.prototype.getDocument=function(){return this.documentModel},ve.dm.Surface.prototype.getMetaList=function(){return this.metaList},ve.dm.Surface.prototype.getSelection=function(){return this.selection},ve.dm.Surface.prototype.getFragment=function(a,b){return new ve.dm.SurfaceFragment(this,a||this.selection,b)},ve.dm.Surface.prototype.truncateUndoStack=function(){this.undoIndex&&(this.undoStack=this.undoStack.slice(0,this.undoStack.length-this.undoIndex),this.undoIndex=0,this.emit("history"))},ve.dm.Surface.prototype.startQueueingContextChanges=function(){this.queueingContextChanges||(this.queueingContextChanges=!0,this.contextChangeQueued=!1)},ve.dm.Surface.prototype.emitContextChange=function(){this.queueingContextChanges?this.contextChangeQueued=!0:this.isStaging()||this.emit("contextChange")},ve.dm.Surface.prototype.stopQueueingContextChanges=function(){this.queueingContextChanges&&(this.queueingContextChanges=!1,this.contextChangeQueued&&(this.contextChangeQueued=!1,this.isStaging()||this.emit("contextChange")))},ve.dm.Surface.prototype.setSelection=function(a){var b,c,d,e,f,g={},h=this.selection,i=!1,j=this.documentModel.data;if(this.enabled){if(this.transacting)return void(this.selection=a);g.start=a?this.documentModel.getNodeFromOffset(a.start):null,a&&a.getLength()&&(g.end=this.documentModel.getNodeFromOffset(a.end)),(g.start!==this.selectedNodes.start||g.end!==this.selectedNodes.end)&&(i=!0),this.selectedNodes=g,this.selection=a,this.selection&&(this.selection.isCollapsed()?(b=j.getNearestContentOffset(Math.max(0,this.selection.start-1),-1),c=j.getNearestContentOffset(Math.max(0,this.selection.start))):(b=j.getNearestContentOffset(this.selection.start),c=j.getNearestContentOffset(this.selection.end)),-1===b?f=new ve.dm.AnnotationSet(this.documentModel.getStore()):(d=j.getAnnotationsFromOffset(b),-1!==c?(e=j.getAnnotationsFromOffset(c),f=d.filter(function(a){return a.constructor.static.applyToAppendedContent||e.containsComparable(a)})):f=d),f.containsAllOf(this.insertionAnnotations)&&this.insertionAnnotations.containsAllOf(f)||(this.setInsertionAnnotations(f),i=!0)),h&&h.equals(this.selection)||this.emit("select",this.selection&&this.selection.clone()),i&&this.emitContextChange()}},ve.dm.Surface.prototype.selectFirstContentOffset=function(){var a=this.getDocument().data.getNearestContentOffset(0,1);this.setSelection(new ve.Range(-1!==a?a:1))},ve.dm.Surface.prototype.change=function(a,b){this.changeInternal(a,b,!1)},ve.dm.Surface.prototype.changeInternal=function(a,b,c){var d,e,f,g=this.selection,h=!1;if(this.enabled){if(this.startQueueingContextChanges(),a){for(a instanceof ve.dm.Transaction&&(a=[a]),this.transacting=!0,d=0,e=a.length;e>d;d++)a[d].isNoOp()||(c||(this.isStaging()?this.getStagingTransactions().push(a[d]):(this.truncateUndoStack(),this.newTransactions.length||(this.selectionBefore=g),this.newTransactions.push(a[d]))),this.documentModel.commit(a[d]),a[d].hasElementAttributeOperations()&&(h=!0));this.transacting=!1}f=this.selection,b?this.setSelection(b):a&&this.setSelection(this.selection),g&&g.equals(f)||!f||!f.equals(this.selection)||this.emit("select",this.selection&&this.selection.clone()),h&&this.emitContextChange(),this.stopQueueingContextChanges()}},ve.dm.Surface.prototype.breakpoint=function(){return this.enabled?this.newTransactions.length>0?(this.undoStack.push({transactions:this.newTransactions,selection:this.selection&&this.selection.clone(),selectionBefore:this.selectionBefore&&this.selectionBefore.clone()}),this.newTransactions=[],this.emit("history"),!0):(!this.selectionBefore&&this.selection&&(this.selectionBefore=this.selection.clone()),!1):!1},ve.dm.Surface.prototype.undo=function(){var a,b,c,d=[];if(this.canUndo()&&(this.isStaging()&&this.popAllStaging(),this.breakpoint(),this.undoIndex++,b=this.undoStack[this.undoStack.length-this.undoIndex])){for(a=b.transactions.length-1;a>=0;a--)c=b.transactions[a].reversed(),d.push(c);this.changeInternal(d,b.selectionBefore,!0),this.emit("history")}},ve.dm.Surface.prototype.redo=function(){var a;this.canRedo()&&(this.breakpoint(),a=this.undoStack[this.undoStack.length-this.undoIndex],a&&(this.changeInternal(ve.copy(a.transactions),a.selection,!0),this.undoIndex--,this.emit("history")))},ve.dm.Surface.prototype.onDocumentTransact=function(a){this.selection&&this.setSelection(a.translateRange(this.selection)),this.emit("documentUpdate",a,this.isStaging())},ve.dm.SurfaceFragment=function(a,b,c,d){if(!a)return this;if(this.document=a.getDocument(),this.noAutoSelect=!!c,this.excludeInsertions=!!d,this.surface=a,this.range=b&&b instanceof ve.Range?b:a.getSelection(),this.leafNodes=null,!this.range)return this;var e=this.document.data.getLength();this.range=new ve.Range(Math.min(Math.max(this.range.from,0),e),Math.min(Math.max(this.range.to,0),e)),this.historyPointer=this.document.getCompleteHistoryLength()},ve.dm.SurfaceFragment.static={},ve.dm.SurfaceFragment.prototype.getTranslatedRange=function(a,b){if(this.isNull())return null;
var c,d,e;for(ve.isArray(a)||(a=[a]),b||this.update(),e=this.range,c=0,d=a.length;d>c;c++)e=a[c].translateRange(e,this.excludeInsertions);return e},ve.dm.SurfaceFragment.prototype.getSelectedModels=function(a){if(this.isNull())return[];var b,c,d,e,f=this.getAnnotations(a);if(a)for(d=this.getCoveredNodes(),b=0,c=d.length;c>b;b++)d[b].range&&d[b].range.isCollapsed()?(d.splice(b,1),c--,b--):d[b]=d[b].node;else d=[],e=this.getSelectedNode(),e&&d.push(e);return d.concat(f.isEmpty()?[]:f.get())},ve.dm.SurfaceFragment.prototype.update=function(){if(!this.isNull()){var a;this.historyPointer<this.document.getCompleteHistoryLength()&&(a=this.document.getCompleteHistorySince(this.historyPointer),this.range=this.getTranslatedRange(a,!0),this.historyPointer+=a.length,this.leafNodes=null)}},ve.dm.SurfaceFragment.prototype.change=function(a,b){if(!b&&this.isNull())throw new Error("Cannot change null fragment without range");this.surface.change(a,!this.noAutoSelect&&(b||this.getTranslatedRange(a))),b&&(this.update(),this.range=b)},ve.dm.SurfaceFragment.prototype.getSurface=function(){return this.surface},ve.dm.SurfaceFragment.prototype.getDocument=function(){return this.document},ve.dm.SurfaceFragment.prototype.getRange=function(a){return this.update(),this.range&&!a?this.range.clone():this.range},ve.dm.SurfaceFragment.prototype.isNull=function(){return!this.range},ve.dm.SurfaceFragment.prototype.willAutoSelect=function(){return!this.noAutoSelect},ve.dm.SurfaceFragment.prototype.setAutoSelect=function(a){return this.noAutoSelect=!a,this},ve.dm.SurfaceFragment.prototype.clone=function(a){return new this.constructor(this.surface,a||this.getRange(),this.noAutoSelect,this.excludeInsertions)},ve.dm.SurfaceFragment.prototype.willExcludeInsertions=function(){return this.excludeInsertions},ve.dm.SurfaceFragment.prototype.setExcludeInsertions=function(a){a=!!a,this.excludeInsertions!==a&&(this.update(),this.excludeInsertions=a)},ve.dm.SurfaceFragment.prototype.adjustRange=function(a,b){var c,d=this.getRange(!0);return c=d&&new ve.Range(d.start+(a||0),d.end+(b||0)),this.clone(c)},ve.dm.SurfaceFragment.prototype.truncateRange=function(a){var b=this.getRange(!0);return this.clone(b&&b.truncate(a))},ve.dm.SurfaceFragment.prototype.collapseRangeToStart=function(){var a=this.getRange(!0);return this.clone(a&&new ve.Range(a.start))},ve.dm.SurfaceFragment.prototype.collapseRangeToEnd=function(){var a=this.getRange(!0);return this.clone(a&&new ve.Range(a.end))},ve.dm.SurfaceFragment.prototype.trimRange=function(){var a=this.getRange(),b=a;return a&&(b=0===this.document.getText(a).trim().length?new ve.Range(a.start):this.document.data.trimOuterSpaceFromRange(a)),this.clone(b)},ve.dm.SurfaceFragment.prototype.expandRange=function(a,b){var c,d,e,f,g=this.getRange();if(this.isNull())return this.clone();switch(a||"parent"){case"word":g.getLength()>0?(f=ve.Range.newCoveringRange([this.document.data.getNearestWordRange(this.getRange(!0).start),this.document.data.getNearestWordRange(this.getRange(!0).end)]),g.isBackwards()&&(f=f.flip())):f=this.document.data.getNearestWordRange(g.start);break;case"annotation":f=this.document.data.getAnnotatedRangeFromSelection(g,b),g.start>f.start||g.end<f.end?g.from>g.to&&(f=f.flip()):f=g;break;case"root":f=new ve.Range(0,this.getDocument().getInternalList().getListNode().getOuterRange().start);break;case"siblings":d=this.document.selectNodes(g,"siblings"),f=1===d.length?d[0].node.getOuterRange():new ve.Range(d[0].node.getOuterRange().start,d[d.length-1].node.getOuterRange().end);break;case"closest":for(c=this.document.selectNodes(g,"siblings")[0].node,e=c.getParent();e&&e.getType()!==b;)c=e,e=e.getParent();if(!e)return new ve.dm.SurfaceFragment(null);f=e.getOuterRange();break;case"parent":if(c=this.document.selectNodes(g,"siblings")[0].node,e=c.getParent(),!e)return new ve.dm.SurfaceFragment(null);f=e.getOuterRange();break;default:throw new Error("Invalid scope argument: "+a)}return this.clone(f)},ve.dm.SurfaceFragment.prototype.getData=function(a){return this.isNull()?[]:this.document.getData(this.getRange(),a)},ve.dm.SurfaceFragment.prototype.getText=function(){if(this.isNull())return"";var a,b,c="",d=this.document.getData(this.getRange());for(a=0,b=d.length;b>a;a++)void 0===d[a].type&&(c+="string"==typeof d[a]?d[a]:d[a][0]);return c},ve.dm.SurfaceFragment.prototype.getAnnotations=function(a){return this.isNull()?new ve.dm.AnnotationSet(this.getDocument().getStore()):this.getRange(!0).getLength()?this.getDocument().data.getAnnotationsFromRange(this.getRange(),a):this.surface.getInsertionAnnotations()},ve.dm.SurfaceFragment.prototype.hasAnnotations=function(){return this.isNull()?!1:this.getDocument().data.hasAnnotationsInRange(this.getRange(!0))},ve.dm.SurfaceFragment.prototype.getLeafNodes=function(){return this.isNull()?[]:(this.update(),this.leafNodes||(this.leafNodes=this.document.selectNodes(this.getRange(!0),"leaves")),this.leafNodes)},ve.dm.SurfaceFragment.prototype.getSelectedLeafNodes=function(){if(this.isNull())return[];var a,b,c=[],d=this.getLeafNodes();for(a=0,b=d.length;b>a;a++)(1===b||!d[a].range||d[a].range.getLength())&&c.push(d[a].node);return c},ve.dm.SurfaceFragment.prototype.getSelectedNode=function(){if(this.isNull())return null;var a,b,c=this.getRange(),d=this.document.selectNodes(c,"covered");for(a=0,b=d.length;b>a;a++)if(d[a].nodeOuterRange.equalsSelection(c))return d[a].node;return null},ve.dm.SurfaceFragment.prototype.getCoveredNodes=function(){return this.isNull()?[]:this.document.selectNodes(this.getRange(),"covered")},ve.dm.SurfaceFragment.prototype.getSiblingNodes=function(){return this.isNull()?[]:this.document.selectNodes(this.getRange(),"siblings")},ve.dm.SurfaceFragment.prototype.select=function(){return this.isNull()?this:(this.surface.setSelection(this.getRange()),this)},ve.dm.SurfaceFragment.prototype.changeAttributes=function(a,b){if(this.isNull())return this;var c,d,e,f=[],g=this.getCoveredNodes();for(c=0,d=g.length;d>c;c++)e=g[c],!e.node.isWrapped()||b&&e.node.getType()!==b||e.range&&e.range.isCollapsed()||f.push(ve.dm.Transaction.newFromAttributeChanges(this.document,e.nodeOuterRange.start,a));return f.length&&this.change(f),this},ve.dm.SurfaceFragment.prototype.annotateContent=function(a,b,c){if(this.isNull())return this;var d,e,f,g,h,i=[];if(b instanceof ve.dm.Annotation?e=[b]:(d=ve.dm.annotationFactory.create(b,c),e="set"===a?[d]:this.document.data.getAnnotationsFromRange(this.getRange(),!0).getAnnotationsByName(d.name).get()),this.getRange(!0).getLength()){for(f=0,g=e.length;g>f;f++)h=ve.dm.Transaction.newFromAnnotation(this.document,this.getRange(),a,e[f]),i.push(h);this.change(i)}else if("set"===a)for(f=0,g=e.length;g>f;f++)this.surface.addInsertionAnnotations(e[f]);else if("clear"===a)for(f=0,g=e.length;g>f;f++)this.surface.removeInsertionAnnotations(e[f]);return this},ve.dm.SurfaceFragment.prototype.insertContent=function(a,b){if(this.isNull())return this;var c,d,e;return this.getRange(!0).getLength()&&this.removeContent(),"string"==typeof a&&(a=ve.splitClusters(a)),a.length&&(b&&(c=this.document.data.getAnnotationsFromOffset(this.getRange(!0).start-1),c.getLength()>0&&ve.dm.Document.static.addAnnotationsToData(a,c)),d=ve.dm.Transaction.newFromInsertion(this.document,this.getRange(!0).start,a),e=d.getModifiedRange(),this.change(d,e)),this},ve.dm.SurfaceFragment.prototype.removeContent=function(){return this.isNull()?this:(this.getRange(!0).getLength()&&this.change(ve.dm.Transaction.newFromRemoval(this.document,this.getRange())),this)},ve.dm.SurfaceFragment.prototype.convertNodes=function(a,b){return this.isNull()?this:(this.change(ve.dm.Transaction.newFromContentBranchConversion(this.document,this.getRange(),a,b)),this)},ve.dm.SurfaceFragment.prototype.wrapNodes=function(a){return this.isNull()?this:(ve.isArray(a)||(a=[a]),this.change(ve.dm.Transaction.newFromWrap(this.document,this.getRange(),[],[],[],a)),this)},ve.dm.SurfaceFragment.prototype.unwrapNodes=function(a,b){if(this.isNull())return this;var c,d=[],e=[];if(this.getRange(!0).end-this.getRange(!0).start<2*b)throw new Error("cannot unwrap by greater depth than maximum theoretical depth of selection");for(c=0;b>c;c++)d.push(this.surface.getDocument().data.getData(this.getRange(!0).start+c));for(c=a;c>0;c--)e.push(this.surface.getDocument().data.getData(this.getRange(!0).start-c));return this.change(ve.dm.Transaction.newFromWrap(this.document,this.getRange(),e,[],d,[])),this},ve.dm.SurfaceFragment.prototype.rewrapNodes=function(a,b){if(this.isNull())return this;var c,d=[];if(ve.isArray(b)||(b=[b]),this.getRange(!0).end-this.getRange(!0).start<2*a)throw new Error("cannot unwrap by greater depth than maximum theoretical depth of selection");for(c=0;a>c;c++)d.push(this.surface.getDocument().data.getData(this.getRange(!0).start+c));return this.change(ve.dm.Transaction.newFromWrap(this.document,this.getRange(),[],[],d,b)),this},ve.dm.SurfaceFragment.prototype.wrapAllNodes=function(a){return this.isNull()?this:(ve.isArray(a)||(a=[a]),this.change(ve.dm.Transaction.newFromWrap(this.document,this.getRange(),[],a,[],[])),this)},ve.dm.SurfaceFragment.prototype.rewrapAllNodes=function(a,b){if(this.isNull())return this;var c,d=[],e=new ve.Range(this.getRange(!0).start+a,this.getRange(!0).end-a);if(ve.isArray(b)||(b=[b]),this.getRange(!0).end-this.getRange(!0).start<2*a)throw new Error("cannot unwrap by greater depth than maximum theoretical depth of selection");for(c=0;a>c;c++)d.push(this.surface.getDocument().data.getData(this.getRange(!0).start+c));return this.change(ve.dm.Transaction.newFromWrap(this.document,e,d,b,[],[])),this},ve.dm.SurfaceFragment.prototype.isolateAndUnwrap=function(a){function b(a,b){var c,d,e,h=0,i=[];for(c=0,d=a.length;d>c;c++)i.unshift({type:"/"+a[c].type}),i.push(a[c].getClonedElement()),b&&(h+=2);e=ve.dm.Transaction.newFromInsertion(p.getDocument(),b?f:g,i),p.change(e),f+=h,g+=h}if(this.isNull())return this;var c,d,e,f,g,h,i=0,j=ve.dm.nodeFactory,k=j.getSuggestedParentNodeTypes(a),l=!1,m=!1,n=[],o=[],p=this;for(c=this.getDocument().selectNodes(this.getRange(),"siblings"),d=c[0].node,f=d.getOuterRange().start;null!==k&&-1===ve.indexOf(d.getParent().type,k);)d.getParent().indexOf(d)>0&&(l=!0),d=d.getParent(),l?n.unshift(d):f=d.getOuterRange().start,i++;for(e=c[c.length-1].node,g=e.getOuterRange().end;null!==k&&-1===ve.indexOf(e.getParent().type,k);)e.getParent().indexOf(e)<e.getParent().getChildren().length-1&&(m=!0),e=e.getParent(),m?o.unshift(e):g=e.getOuterRange().end;return h=this.willExcludeInsertions(),this.setExcludeInsertions(!0),l&&b(n,!0),m&&b(o,!1),this.setExcludeInsertions(h),this.unwrapNodes(i,0),this},ve.dm.DataString=function(a){this.data=a},OO.inheritClass(ve.dm.DataString,unicodeJS.TextString),ve.dm.DataString.prototype.read=function(a){var b=this.data[a];return void 0!==b&&void 0===b.type?"string"==typeof b?b:b[0]:null},ve.dm.Document=function(a,b,c,d,e,f,g){ve.Document.call(this,new ve.dm.DocumentNode);var h,i,j=!0,k=c||this,l=this.documentNode;this.lang=f||"en",this.dir=g||"ltr",this.documentNode.setRoot(l),this.documentNode.setDocument(k),this.internalList=d?d.clone(this):new ve.dm.InternalList(this),this.innerWhitespace=e?ve.copy(e):new Array(2),this.parentDocument=c,this.completeHistory=[],a instanceof ve.dm.ElementLinearData?(j=!1,h=a):h=a instanceof ve.dm.FlatLinearData?a:new ve.dm.FlatLinearData(new ve.dm.IndexValueStore,ve.isArray(a)?a:[]),this.store=h.getStore(),this.htmlDocument=b||ve.createDocumentFromHtml(""),j?(i=this.constructor.static.splitData(h),this.data=i.elementData,this.metadata=i.metaData):(this.data=h,this.metadata=new ve.dm.MetaLinearData(this.data.getStore(),new Array(1+this.data.getLength())))},OO.inheritClass(ve.dm.Document,ve.Document),ve.dm.Document.static={},ve.dm.Document.static.splitData=function(a){var b,c,d,e,f,g;for(f=new ve.dm.ElementLinearData(a.getStore()),g=new ve.dm.MetaLinearData(a.getStore()),b=0,c=a.getLength();c>b;b++)if(a.isElementData(b)){if(a.isOpenElementData(b)&&ve.dm.metaItemFactory.lookup(a.getType(b))){e=a.getData(b),d=f.getLength(),g.getData(d)||g.setData(d,[]),g.getData(d).push(e),b++;continue}f.push(a.getData(b))}else f.push(a.getData(b));return g.getLength()<f.getLength()+1&&(g.data=g.data.concat(new Array(1+f.getLength()-g.getLength()))),{elementData:f,metaData:g}},ve.dm.Document.static.addAnnotationsToData=function(a,b){var c,d,e,f=b.getStore();if(!b.isEmpty())for(c=0,d=a.length;d>c;c++)a[c].type||(ve.isArray(a[c])?(e=new ve.dm.AnnotationSet(f,a[c][1]),e.addSet(b.clone())):(a[c]=[a[c]],e=b.clone()),a[c][1]=e.getIndexes())},ve.dm.Document.prototype.getDocumentNode=function(){return this.documentNode.length||this.documentNode.getDocument().buildingNodeTree||this.buildNodeTree(),this.documentNode},ve.dm.Document.prototype.buildNodeTree=function(){var a,b,c,d,e,f,g,h,i,j=0,k=!1;for(e=[],f=[this.documentNode],g=[f,e],h=this.documentNode,i=this.documentNode.getDocument(),a=0,b=this.data.getLength();b>a;a++)if(this.data.isElementData(a))if(k&&(h.setLength(j),h=f[f.length-1],k=!1,j=0),this.data.isOpenElementData(a))c=ve.dm.nodeFactory.create(this.data.getType(a),this.data.getData(a)),c.setDocument(i),e.push(c),ve.dm.nodeFactory.canNodeHaveChildren(c.getType())&&(f=e,e=[],g.push(e)),h=c;else{if(ve.dm.nodeFactory.canNodeHaveChildren(h.getType())){if(d=g.pop(),e=f,f=g[g.length-2],!f)throw new Error("Unbalanced input passed to document");ve.batchSplice(h,0,0,d)}h=f[f.length-1]}else k||(c=new ve.dm.TextNode,c.setDocument(i),e.push(c),h=c,k=!0),j++;k&&h.setLength(j),i.buildingNodeTree=!0,ve.batchSplice(this.documentNode,0,0,e),i.buildingNodeTree=!1},ve.dm.Document.prototype.commit=function(a){if(a.hasBeenApplied())throw new Error("Cannot commit a transaction that has already been committed");new ve.dm.TransactionProcessor(this,a).process(),this.completeHistory.push(a),this.emit("transact",a)},ve.dm.Document.prototype.getData=function(a,b){return this.data.getDataSlice(a,b)},ve.dm.Document.prototype.getMetadata=function(a,b){return this.metadata.getDataSlice(a,b)},ve.dm.Document.prototype.getHtmlDocument=function(){return this.htmlDocument},ve.dm.Document.prototype.getStore=function(){return this.store},ve.dm.Document.prototype.getInternalList=function(){return this.internalList},ve.dm.Document.prototype.getInnerWhitespace=function(){return this.innerWhitespace},ve.dm.Document.prototype.cloneSliceFromRange=function(a){for(var b,c,d,e,f,g,h,i,j,k,l,m=this.getNodeFromOffset(a.start),n=this.getNodeFromOffset(a.end),o=this.selectNodes(a,"siblings"),p=[],q=[],r=[],s=[];o[0]&&o[0].range&&o[0].range.isCollapsed()&&!o[0].node.isWrapped();)o.shift();for(b=o.length-1;o[b]&&o[b].range&&o[b].range.isCollapsed()&&!o[b].node.isWrapped();)o.pop(),b--;if(0===o.length)g=new ve.dm.ElementLinearData(this.getStore(),[]),i=j=new ve.Range(0);else if(m===n)k=o;else{for(c=o[0],d=o[o.length-1],e=c.node,f=d.node;!e.isWrapped();)e=e.getParent();for(;!f.isWrapped();)f=f.getParent();if(c.range)for(;;){for(;!m.isWrapped();)m=m.getParent();if(p.push(m.getClonedElement()),m===e)break;m=m.getParent()}if(d!==c&&d.range)for(;;){for(;!n.isWrapped();)n=n.getParent();if(q.push({type:"/"+n.getType()}),n===f)break;n=n.getParent()}k=this.selectNodes(new ve.Range(e.getOuterRange().start,f.getOuterRange().end),"covered")}if(!j){for(l=!1,b=k.length-1;b>=0;b--)if(null!==k[b].node.getParentNodeTypes()){l=!0;break}if(l)for(m=k[0].node;m.getParent()&&null!==m.getParentNodeTypes();)m=m.getParent(),r.push(m.getClonedElement()),s.push({type:"/"+m.getType()});g=new ve.dm.ElementLinearData(this.getStore(),r.reverse().concat(p.reverse()).concat(this.data.slice(a.start,a.end)).concat(q).concat(s)),i=new ve.Range(r.length+p.length,r.length+p.length+a.getLength()),j=new ve.Range(r.length,r.length+p.length+a.getLength()+q.length)}return ve.batchSplice(g.data,g.getLength(),0,this.getData(this.getInternalList().getListNode().getOuterRange(),!0)),h=new ve.dm.DocumentSlice(g,void 0,void 0,this.getInternalList().clone(),i,j)},ve.dm.Document.prototype.cloneFromRange=function(a){var b,c,d=this.getStore().clone(),e=this.getInternalList().getListNode().getOuterRange();return b=ve.copy(this.getFullData(a,!0)),(a.start>e.start||a.end<e.end)&&(b=b.concat(this.getFullData(e))),c=new this.constructor(new ve.dm.FlatLinearData(d,b),this.getHtmlDocument(),void 0,this.getInternalList(),void 0,this.getLang(),this.getDir()),c.origDoc=this,c.origInternalListLength=this.internalList.getItemNodeCount(),c},ve.dm.Document.prototype.spliceMetadata=function(a,b,c,d){var e=this.metadata.getData(a);return e||(e=[],this.metadata.setData(a,e)),d=d||[],ve.batchSplice(e,b,c,d)},ve.dm.Document.prototype.getFullData=function(a,b){var c,d,e=a?a.start:0,f=a?a.end:this.data.getLength(),g=[];for(void 0===b&&(b=!a);f>=e;){if(this.metadata.getData(e)&&(b||e!==a.start&&e!==a.end))for(c=0,d=this.metadata.getData(e).length;d>c;c++)g.push(this.metadata.getData(e)[c]),g.push({type:"/"+this.metadata.getData(e)[c].type});f>e&&g.push(this.data.getData(e)),e++}return g},ve.dm.Document.prototype.getNodeFromOffset=function(a){if(0>a||a>this.data.getLength())throw new Error("ve.dm.Document.getNodeFromOffset(): offset "+a+" is out of bounds");var b=this.getDocumentNode().getNodeFromOffset(a);return b.canHaveChildren()||(b=b.getParent()),b},ve.dm.Document.prototype.getDataFromNode=function(a){var b=a.getLength(),c=a.getOffset();return c>=0?(a.isWrapped()&&c++,this.data.slice(c,c+b)):null},ve.dm.Document.prototype.getText=function(a){var b,c=this.getData(a),d="";for(b=0;b<c.length;b++)"string"==typeof c[b]?d+=c[b]:ve.isArray(c[b])&&(d+=c[b][0]);return d},ve.dm.Document.prototype.rebuildNodes=function(a,b,c,d,e){var f=this.data.sliceObject(d,d+e),g=new this.constructor(f,this.htmlDocument,this),h=g.getDocumentNode().getChildren();return ve.batchSplice(a,b,c,h),h},ve.dm.Document.prototype.fixupInsertion=function(a,b){function c(a,b){var c;if(void 0!==a.type)if("/"!==a.type.charAt(0))0===w.length&&x.length>0&&x[x.length-1].getType()===a.type?f=x.pop():w.push(a),g=a.type;else if(w.length>0)c=w.pop().type;else{if(c=f.getType(),x.push(f),f=f.getParent(),!f)throw new Error("Inserted data is trying to close the root node (at index "+b+")");if(g=c,!(a.type==="/"+c||ve.dm.nodeFactory.canNodeContainContent(a.type.substr(1))&&ve.dm.nodeFactory.canNodeContainContent(c)))throw new Error("Cannot adopt content from "+a.type+" nodes into "+c+" nodes (at index "+b+")")}u.push(a)}var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u=[],v=0,w=[],x=[],y=0,z=a.length,A=this;for(f=this.getNodeFromOffset(b),g=f.getType(),h=!1,i=A.data.isOpenElementData(b-1),s=0;s<a.length;s++)if(h&&void 0!==a[s].type&&(g=w.length>0?w[w.length-1].type:f.getType()),void 0===a[s].type||"/"!==a[s].type.charAt(0)){j=a[s].type||"text",o=[],p=[],q=[],ve.dm.nodeFactory.isNodeContent(j)&&!ve.dm.nodeFactory.canNodeContainContent(g)&&(j="paragraph",o.unshift(ve.dm.nodeFactory.getDataElement(j)));do if(k=ve.dm.nodeFactory.getParentNodeTypes(j),m=null===k||-1!==ve.indexOf(g,k),!m){if(0===k.length)throw new Error("Cannot insert "+j+" because it  cannot have a parent (at index "+s+")");j=k[0],o.unshift(ve.dm.nodeFactory.getDataElement(j))}while(!m);do if(l=ve.dm.nodeFactory.getChildNodeTypes(g),n=null===l||-1!==ve.indexOf(j,l),n=n&&!(!ve.dm.nodeFactory.isNodeContent(j)&&ve.dm.nodeFactory.canNodeContainContent(g)),!n){if(i)return this.fixupInsertion(a,b-1);if(p.push({type:"/"+g}),w.length>0)r=w.pop(),g=r.type,q.push(ve.copy(r));else{if(x.push(f),q.push(f.getClonedElement()),f=f.getParent(),!f)throw new Error("Cannot insert "+j+" even  after closing all containing nodes (at index "+s+")");g=f.getType()}}while(!n);if(0===s&&"text"===j&&ve.isUnattachedCombiningMark(a[s])){if(A.data.isElementData(b-1))continue;b--,v++,d=A.data.getCharacterData(b)+a[s],e=A.data.getAnnotationIndexesFromOffset(b),e.length&&(d=[d,e]),a[s]=d}for(t=0;t<p.length;t++)0===s?y++:z++,u.push(p[t]);for(t=0;t<o.length;t++)0===s?y++:z++,c(o[t],s);c(a[s],s),void 0===a[s].type?(h=!0,o.length>0&&(g=j)):g=a[s].type}else c(a[s],s),g=w.length>0?w[w.length-1].type:f.getType();if(x.length>0&&A.data.isCloseElementData(b))return this.fixupInsertion(a,b+1);for(h&&(g=w.length>0?w[w.length-1].type:f.getType());w.length>0;)r=w[w.length-1],c({type:"/"+r.type},s);for(;x.length>0;)r=x[x.length-1],c(r.getClonedElement(),s);return{offset:b,data:u,remove:v,insertedDataOffset:y,insertedDataLength:z}},ve.dm.Document.prototype.getCompleteHistoryLength=function(){return this.completeHistory.length},ve.dm.Document.prototype.getCompleteHistorySince=function(a){return this.completeHistory.slice(a)},ve.dm.Document.prototype.getLang=function(){return this.lang},ve.dm.Document.prototype.getDir=function(){return this.dir},ve.dm.DocumentSlice=function(a,b,c,d,e,f){ve.dm.Document.call(this,a,b,c,d),this.originalRange=e,this.balancedRange=f},OO.inheritClass(ve.dm.DocumentSlice,ve.dm.Document),ve.dm.DocumentSlice.prototype.getOriginalData=function(){return this.getData(this.originalRange)},ve.dm.DocumentSlice.prototype.getBalancedData=function(){return this.getData(this.balancedRange)},ve.dm.LinearData=function(a,b){this.store=a,this.data=b||[]},ve.dm.LinearData.static={},ve.dm.LinearData.static.getType=function(a){return this.isCloseElementData(a)?a.type.substr(1):a.type},ve.dm.LinearData.static.isElementData=function(a){return void 0!==a&&"string"==typeof a.type},ve.dm.LinearData.static.isOpenElementData=function(a){return this.isElementData(a)&&"/"!==a.type.charAt(0)},ve.dm.LinearData.static.isCloseElementData=function(a){return this.isElementData(a)&&"/"===a.type.charAt(0)},ve.dm.LinearData.prototype.getData=function(a){return void 0===a?this.data:this.data[a]},ve.dm.LinearData.prototype.setData=function(a,b){this.data[a]=b},ve.dm.LinearData.prototype.push=function(){return Array.prototype.push.apply(this.data,arguments)},ve.dm.LinearData.prototype.getLength=function(){return this.getData().length},ve.dm.LinearData.prototype.getStore=function(){return this.store},ve.dm.LinearData.prototype.slice=function(){return Array.prototype.slice.apply(this.data,arguments)},ve.dm.LinearData.prototype.sliceObject=function(){return new this.constructor(this.getStore(),this.slice.apply(this,arguments))},ve.dm.LinearData.prototype.splice=function(){return Array.prototype.splice.apply(this.data,arguments)},ve.dm.LinearData.prototype.spliceObject=function(){return new this.constructor(this.getStore(),this.splice.apply(this,arguments))},ve.dm.LinearData.prototype.batchSplice=function(a,b,c){return ve.batchSplice(this.getData(),a,b,c)},ve.dm.LinearData.prototype.batchSpliceObject=function(a,b,c){return new this.constructor(this.getStore(),this.batchSplice.call(this,a,b,c))},ve.dm.LinearData.prototype.getDataSlice=function(a,b){var c,d,e=0,f=this.getLength();return void 0!==a&&(e=Math.max(0,Math.min(f,a.start)),c=Math.max(0,Math.min(f,a.end))),d=void 0===c?this.slice(e):this.slice(e,c),b?ve.copy(d):d},ve.dm.LinearData.prototype.clone=function(){return new this.constructor(this.getStore(),ve.copy(this.data))},ve.dm.DocumentSynchronizer=function(a,b){this.document=a,this.actionQueue=[],this.eventQueue=[],this.adjustment=0,this.transaction=b},ve.dm.DocumentSynchronizer.synchronizers={},ve.dm.DocumentSynchronizer.synchronizers.annotation=function(a){var b,c=ve.Range.newFromTranslatedRange(a.range,this.adjustment),d=this.document.selectNodes(c,"leaves");for(b=0;b<d.length;b++)this.queueEvent(d[b].node,"annotation"),this.queueEvent(d[b].node,"update")},ve.dm.DocumentSynchronizer.synchronizers.attributeChange=function(a){this.queueEvent(a.node,"attributeChange",a.key,a.from,a.to),this.queueEvent(a.node,"update")},ve.dm.DocumentSynchronizer.synchronizers.resize=function(a){var b=a.node,c=b.getParent();c&&"text"===b.getType()&&b.getLength()+a.adjustment===0?c.splice(c.indexOf(b),1):b.adjustLength(a.adjustment),this.adjustment+=a.adjustment},ve.dm.DocumentSynchronizer.synchronizers.rebuild=function(a){var b,c,d,e,f=ve.Range.newFromTranslatedRange(a.oldRange,this.adjustment),g=this.document.selectNodes(f,"siblings");"indexInNode"in g[0]||!g[0].node.getParent()?(c=g[0].node,d=g[0].indexInNode||0,e=0):(b=g[0].node,c=b.getParent(),d=g[0].index,e=g.length),this.document.rebuildNodes(c,d,e,f.from,a.newRange.getLength()),this.adjustment+=a.newRange.getLength()-f.getLength()},ve.dm.DocumentSynchronizer.prototype.getDocument=function(){return this.document},ve.dm.DocumentSynchronizer.prototype.pushAnnotation=function(a){this.actionQueue.push({type:"annotation",range:a})},ve.dm.DocumentSynchronizer.prototype.pushAttributeChange=function(a,b,c,d){this.actionQueue.push({type:"attributeChange",node:a,key:b,from:c,to:d})},ve.dm.DocumentSynchronizer.prototype.pushResize=function(a,b){this.actionQueue.push({type:"resize",node:a,adjustment:b})},ve.dm.DocumentSynchronizer.prototype.pushRebuild=function(a,b){this.actionQueue.push({type:"rebuild",oldRange:a,newRange:b})},ve.dm.DocumentSynchronizer.prototype.queueEvent=function(a){var b=Array.prototype.slice.call(arguments,1),c=OO.getHash(b);a.queuedEventHashes||(a.queuedEventHashes={}),a.queuedEventHashes[c]||(a.queuedEventHashes[c]=!0,this.eventQueue.push({node:a,args:b.concat(this.transaction)}))},ve.dm.DocumentSynchronizer.prototype.synchronize=function(){var a,b,c;for(c=0;c<this.actionQueue.length;c++){if(a=this.actionQueue[c],!(a.type in ve.dm.DocumentSynchronizer.synchronizers))throw new Error("Invalid action type "+a.type);ve.dm.DocumentSynchronizer.synchronizers[a.type].call(this,a)}for(c=0;c<this.eventQueue.length;c++)b=this.eventQueue[c],b.node.emit.apply(b.node,b.args),delete b.node.queuedEventHashes;this.actionQueue=[],this.eventQueue=[]},ve.dm.IndexValueStore=function(){this.hashStore={},this.valueStore=[]},ve.dm.IndexValueStore.prototype.index=function(a,b,c){var d;return"string"!=typeof b&&(b=OO.getHash(a)),d=this.indexOfHash(b),(null===d||c)&&(null===d&&(d=this.valueStore.length),this.valueStore[d]=ve.isArray(a)?ve.copy(a):"object"==typeof a?ve.cloneObject(a):a,this.hashStore[b]=d),d},ve.dm.IndexValueStore.prototype.indexOfHash=function(a){return a in this.hashStore?this.hashStore[a]:null},ve.dm.IndexValueStore.prototype.indexes=function(a){var b,c,d=[];for(b=0,c=a.length;c>b;b++)d.push(this.index(a[b]));return d},ve.dm.IndexValueStore.prototype.value=function(a){return this.valueStore[a]},ve.dm.IndexValueStore.prototype.values=function(a){var b,c,d=[];for(b=0,c=a.length;c>b;b++)d.push(this.value(a[b]));return d},ve.dm.IndexValueStore.prototype.clone=function(){var a,b=new this.constructor;b.valueStore=this.valueStore.slice();for(a in this.hashStore)b.hashStore[a]=this.hashStore[a];return b},ve.dm.IndexValueStore.prototype.merge=function(a){var b,c,d={};for(b in a.hashStore)b in this.hashStore||(c=this.valueStore.push(a.valueStore[a.hashStore[b]])-1,this.hashStore[b]=c),d[a.hashStore[b]]=this.hashStore[b];return d},ve.dm.Converter=function(a,b,c,d){this.modelRegistry=a,this.nodeFactory=b,this.annotationFactory=c,this.metaItemFactory=d,this.doc=null,this.documentData=null,this.store=null,this.internalList=null,this.forClipboard=null,this.contextStack=null},ve.dm.Converter.computedAttributes=["href","src"],ve.dm.Converter.getDataContentFromText=function(a,b){var c,d,e=ve.splitClusters(a);if(!b||b.isEmpty())return e;for(c=0,d=e.length;d>c;c++)e[c]=[e[c],b.getIndexes().slice()];return e},ve.dm.Converter.openAndCloseAnnotations=function(a,b,c,d){var e,f,g,h,i,j;for(j=b.clone(),e=0,f=a.getLength();f>e;e++){if(g=a.getIndex(e),!j.containsIndex(g)&&!j.containsComparableForSerialization(a.get(e))){h=e;break}j.removeIndex(g)}if(void 0!==h)for(e=a.getLength()-1;e>=h;e--)d(a.get(e)),a.removeAt(e);for(i=a.clone(),e=0,f=b.getLength();f>e;e++)g=b.getIndex(e),i.containsIndex(g)||i.containsComparableForSerialization(b.get(e))?i.removeIndex(g):(c(b.get(e)),a.pushIndex(g))},ve.dm.Converter.buildHtmlAttributeList=function(a,b,c,d){var e,f,g,h,i,j,k,l=!0;for(d=d||[],e=0,f=a.length;f>e;e++){for(i=a[e].attributes||[],d[e]={values:{}},g=0,h=i.length;h>g;g++)k=i[g].name,ve.dm.Model.matchesAttributeSpec(k,b)&&(d[e].values[k]=i[g].value,-1!==ve.indexOf(k,this.computedAttributes)&&(d[e].computed||(d[e].computed={}),d[e].computed[k]=a[e][k]),l=!1);c&&(d[e].children=[],j=ve.dm.Converter.buildHtmlAttributeList(a[e].children||[],b,c,d[e].children),j?l=!1:delete d[e].children)}return l?void 0:d},ve.dm.Converter.renderHtmlAttributeList=function(a,b,c,d,e){var f,g,h,i,j;if(void 0===c&&(c=!0),c!==!1)for(f=0,g=a.length;g>f;f++)if(b[f]){i=a[f].values;for(h in i)ve.dm.Model.matchesAttributeSpec(h,c)&&(j=d&&a[f].computed&&a[f].computed[h]||i[h],void 0===j?b[f].removeAttribute(h):(e||!b[f].hasAttribute(h))&&b[f].setAttribute(h,j));a[f].children&&ve.dm.Converter.renderHtmlAttributeList(a[f].children,b[f].children,c,d,e)}},ve.dm.Converter.prototype.isConverting=function(){return null!==this.contextStack},ve.dm.Converter.prototype.getStore=function(){return this.store},ve.dm.Converter.prototype.getHtmlDocument=function(){return this.doc},ve.dm.Converter.prototype.getTargetHtmlDocument=function(){return this.targetDoc},ve.dm.Converter.prototype.isForClipboard=function(){return this.forClipboard},ve.dm.Converter.prototype.getCurrentContext=function(){return null===this.contextStack?null:this.contextStack[this.contextStack.length-1]},ve.dm.Converter.prototype.getActiveAnnotations=function(){var a=this.getCurrentContext();return a?a.annotations:null},ve.dm.Converter.prototype.isExpectingContent=function(){var a=this.getCurrentContext();return a?a.expectingContent:null},ve.dm.Converter.prototype.isInWrapper=function(){var a=this.getCurrentContext();return a?a.inWrapper:null},ve.dm.Converter.prototype.canCloseWrapper=function(){var a=this.getCurrentContext();return a?a.canCloseWrapper:null},ve.dm.Converter.prototype.getDomElementsFromDataElement=function(a,b,c){var d,e=ve.isArray(a)?a[0]:a,f=this.modelRegistry.lookup(e.type);if(!f)throw new Error("Attempting to convert unknown data element type "+e.type);if(f.static.isInternal)return!1;if(d=f.static.toDomElements(a,b,this,c),!(d&&d.length||f.prototype instanceof ve.dm.Annotation))throw new Error("toDomElements() failed to return an array when converting element of type "+e.type);return e.htmlAttributes&&ve.dm.Converter.renderHtmlAttributeList(e.htmlAttributes,d),d},ve.dm.Converter.prototype.createDataElements=function(a,b){var c=a.static.toDataElement(b,this);return c?(ve.isArray(c)||(c=[c]),c):null},ve.dm.Converter.prototype.getDomElementFromDataAnnotation=function(a,b){var c=a.toHtml(),d=b.createElement(c.tag);return ve.setDomAttributes(d,c.attributes),d},ve.dm.Converter.prototype.getModelFromDom=function(a,b,c,d){var e,f,g,h=new ve.dm.IndexValueStore,i=new ve.dm.InternalList;return b=b||a,this.doc=a,this.targetDoc=b,this.store=h,this.internalList=i,this.contextStack=[],e=new ve.dm.FlatLinearData(h,this.getDataFromDomSubtree(a.body)),f=this.internalList.convertToData(this,a),e.batchSplice(e.getLength(),0,f),g=this.getInnerWhitespace(e),this.doc=null,this.targetDoc=null,this.store=null,this.internalList=null,this.contextStack=null,new ve.dm.Document(e,a,void 0,i,g,c,d)},ve.dm.Converter.prototype.getDataFromDomClean=function(a,b,c){var d,e=this.contextStack;return this.contextStack=[],d=this.getDataFromDomSubtree(a,b,c),this.contextStack=e,d},ve.dm.Converter.prototype.getDataFromDomSubtree=function(a,b,c){function d(a,b,c){c&&(a.internal||(a.internal={}),a.internal.whitespace||(a.internal.whitespace=[]),a.internal.whitespace[b]=c)}function e(a){""!==D&&(d(a,0,D),D="")}function f(a){var b,c,e=[],f=r;for(b=0,c=F.length;c>b;b++)F[b].type&&"/"!==F[b].type.charAt(0)&&(F[b].internal&&F[b].internal.whitespace&&("restore"===a?(e=e.concat(ve.dm.Converter.getDataContentFromText(F[b].internal.whitespace[0],G.annotations)),delete F[b].internal):"fixup"===a&&d(f,3,F[b].internal.whitespace[0])),f=F[b]),e.push(F[b]);""!==E&&"restore"===a?ve.batchSplice(C,A,0,e):C=C.concat(e),F=[]}function g(){r={type:"paragraph",internal:{generated:"wrapper"}},C.push(r),G.inWrapper=!0,G.canCloseWrapper=!0,G.expectingContent=!0,e(r)}function h(){""!==E&&(C.splice(A,E.length),d(F.length>0?F[F.length-2]:r,3,E),D=E),C.push({type:"/paragraph"}),f("fixup"),r=void 0,G.inWrapper=!1,G.canCloseWrapper=!1,G.expectingContent=G.originallyExpectingContent
}function i(a){var b,c,d=[],e=[a];if(!a.getAttribute||null===a.getAttribute("about"))return e;for(b=a.getAttribute("about"),c=a.nextSibling;c;c=c.nextSibling)if(c.getAttribute){if(c.getAttribute("about")!==b)break;e=e.concat(d),d=[],e.push(c)}else d.push(c);return e}function j(a,b){var c,d,e;for(c=a.length-1;c>=0;c--){if(d=ve.dm.LinearData.static.getType(a[c]),!d)return!1;if(e=B.lookup(d)||ve.dm.AlienNode,!(e.prototype===b.prototype||e.prototype instanceof b))return!1}return!0}var k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B=this.modelRegistry,C=[],D="",E="",F=[],G={},H=this.contextStack.length?this.contextStack[this.contextStack.length-1]:null;for(G.annotations=c||(H?H.annotations.clone():new ve.dm.AnnotationSet(this.store)),G.branchType=b?b.type:H?H.branchType:"document",G.branchHasContent=this.nodeFactory.canNodeContainContent(G.branchType),G.originallyExpectingContent=G.branchHasContent||!G.annotations.isEmpty(),G.expectingContent=G.originallyExpectingContent,G.inWrapper=H?H.inWrapper:!1,G.canCloseWrapper=!1,this.contextStack.push(G),b&&C.push(b),k=0;k<a.childNodes.length;k++)switch(l=a.childNodes[k],l.nodeType){case Node.ELEMENT_NODE:case Node.COMMENT_NODE:if(l.getAttribute&&l.getAttribute("data-ve-ignore"))continue;if(y=i(l),u=this.modelRegistry.matchElement(l,y.length>1),v=this.modelRegistry.lookup(u)||ve.dm.AlienNode,m=v.prototype instanceof ve.dm.Annotation?[l]:v.static.enableAboutGrouping?y:[l],n=this.createDataElements(v,m),n?v=this.modelRegistry.lookup(n[0].type):(v=ve.dm.AlienNode,m=v.static.enableAboutGrouping?y:[l],n=this.createDataElement(v,m)),v.prototype instanceof ve.dm.Annotation)z=ve.dm.Converter.buildHtmlAttributeList(m,v.static.storeHtmlAttributes),z&&(n[0].htmlAttributes=z),w=this.annotationFactory.create(u,n[0]),G.inWrapper||G.expectingContent||(g(),s=r),t=G.annotations.clone(),t.push(w),n=this.getDataFromDomSubtree(l,void 0,t),(!n.length||j(n,ve.dm.AlienMetaItem))&&(n=this.createDataElements(ve.dm.AlienMetaItem,m),n.push({type:"/"+n[0].type}),G.annotations.isEmpty()||(n[0].annotations=G.annotations.getIndexes().slice())),f("restore"),C=C.concat(n),E="";else{if(v.prototype instanceof ve.dm.MetaItem){z=ve.dm.Converter.buildHtmlAttributeList(m,v.static.storeHtmlAttributes,!0),z&&(n[0].htmlAttributes=z),1===n.length&&n.push({type:"/"+n[0].type}),G.annotations.isEmpty()||(n[0].annotations=G.annotations.getIndexes().slice()),G.inWrapper&&G.canCloseWrapper?(F=F.concat(n),""!==E&&(C.splice(A,E.length),d(n[0],0,E),D=E,E="")):(f("restore"),C=C.concat(n),e(n[0]),s=n[0]),k+=m.length-1;break}x=this.nodeFactory.isNodeContent(n[0].type),!G.expectingContent&&x?(g(),s=r):G.expectingContent&&!x&&(G.inWrapper&&G.canCloseWrapper?h():(v=ve.dm.AlienNode,m=v.static.enableAboutGrouping?y:[l],n=this.createDataElements(v,m),x=this.nodeFactory.isNodeContent(n[0].type))),G.inWrapper&&x&&(E=""),x&&!G.annotations.isEmpty()&&(n[0].annotations=G.annotations.getIndexes().slice()),1===n.length&&1===m.length&&this.nodeFactory.canNodeHaveChildren(n[0].type)&&!this.nodeFactory.doesNodeHandleOwnChildren(n[0].type)?(z=ve.dm.Converter.buildHtmlAttributeList(m,v.static.storeHtmlAttributes),z&&(n[0].htmlAttributes=z),f("restore"),C=C.concat(this.getDataFromDomSubtree(l,n[0],new ve.dm.AnnotationSet(this.store)))):(1===n.length&&n.push({type:"/"+n[0].type}),z=ve.dm.Converter.buildHtmlAttributeList(m,v.static.storeHtmlAttributes,!0),z&&(n[0].htmlAttributes=z),f("restore"),C=C.concat(n)),e(n[0]),s=n[0],k+=m.length-1}break;case Node.TEXT_NODE:if(o=l.data,""===o)break;if(!G.originallyExpectingContent){if(o.match(/^\s+$/)){G.inWrapper?(E=o,A=C.length,C=C.concat(ve.dm.Converter.getDataContentFromText(E,G.annotations))):(s?d(s,3,o):b&&d(b,1,o),D=o,E="",f("restore"));break}q=o.match(/^(\s*)([\s\S]*?)(\s*)$/),G.inWrapper?(f("restore"),C=C.concat(ve.dm.Converter.getDataContentFromText(q[1],G.annotations))):(g(),""!==q[1]&&(s?d(s,3,q[1]):b&&d(b,1,q[1]),d(r,0,q[1]))),C=C.concat(ve.dm.Converter.getDataContentFromText(q[2],G.annotations)),E=q[3],A=C.length,C=C.concat(ve.dm.Converter.getDataContentFromText(E,G.annotations)),s=r;break}G.annotations.isEmpty()&&0===k&&b&&!this.nodeFactory.doesNodeHaveSignificantWhitespace(b.type)&&(q=o.match(/^\s+/),q&&""!==q[0]&&(d(b,1,q[0]),o=o.substring(q[0].length))),G.annotations.isEmpty()&&k===a.childNodes.length-1&&b&&!this.nodeFactory.doesNodeHaveSignificantWhitespace(b.type)&&(q=o.match(/\s+$/),q&&""!==q[0]&&(d(b,2,q[0]),o=o.substring(0,o.length-q[0].length))),C=C.concat(ve.dm.Converter.getDataContentFromText(o,G.annotations))}return G.inWrapper&&G.canCloseWrapper&&(h(),G.inWrapper=!0),p=this.nodeFactory.getChildNodeTypes(G.branchType),"paragraph"===G.branchType||!b||C[C.length-1]!==b||G.inWrapper||this.nodeFactory.canNodeContainContent(G.branchType)||this.nodeFactory.isNodeContent(G.branchType)||null!==p&&-1===ve.indexOf("paragraph",p)||(C.push({type:"paragraph",internal:{generated:"empty"}}),C.push({type:"/paragraph"})),b&&(""!==D&&C[C.length-1]!==b&&(d(b,2,D),D=""),C.push({type:"/"+b.type})),"document"===G.branchType&&j(C,ve.dm.MetaItem)&&!c?C.concat([{type:"paragraph",internal:{generated:"empty"}},{type:"/paragraph"}]):(this.contextStack.pop(),C)},ve.dm.Converter.prototype.getInnerWhitespace=function(a){var b,c=new Array(2),d=0,e=a.getLength()-1;if(a.isOpenElementData(0)&&(b=ve.getProp(a.getData(0),"internal","whitespace"),c[0]=b?b[0]:void 0),a.isCloseElementData(e)){for(d++;--e;)if(a.isCloseElementData(e))d++;else if(a.isOpenElementData(e)&&(d--,0===d&&"internalList"!==a.getType(e)))break;b=ve.getProp(a.getData(e),"internal","whitespace"),c[1]=b?b[3]:void 0}return c},ve.dm.Converter.prototype.isDomAllMetaOrWhitespace=function(a,b){var c,d,e,f;for(c=0;c<a.length;c++){switch(d=a[c],d.nodeType){case Node.ELEMENT_NODE:case Node.COMMENT_NODE:if(e=this.modelRegistry.matchElement(d,!1,b),f=this.modelRegistry.lookup(e)||ve.dm.AlienNode,!(f.prototype instanceof ve.dm.Annotation||f.prototype instanceof ve.dm.MetaItem))return!1;if(d.childNodes.length&&!this.isDomAllMetaOrWhitespace(d.childNodes,b))return!1;continue;case Node.TEXT_NODE:if(!d.data.match(/\S/))continue}return!1}return!0},ve.dm.Converter.prototype.getDomFromModel=function(a,b){var c=ve.createDocumentFromHtml("");return this.getDomSubtreeFromModel(a,c.body,b),c},ve.dm.Converter.prototype.getDomSubtreeFromModel=function(a,b,c){this.documentData=a.getFullData(),this.store=a.getStore(),this.internalList=a.getInternalList(),this.forClipboard=!!c,this.getDomSubtreeFromData(this.documentData,b,a.getInnerWhitespace()),this.documentData=null,this.store=null,this.internalList=null,this.forClipboard=null},ve.dm.Converter.prototype.getDomSubtreeFromData=function(a,b,c){function d(){i.length>0&&(C.push(G.createTextNode(i)),i=""),C=[],B.push(C)}function e(a){var b,c,d,e;if(i.length>0&&(C.push(G.createTextNode(i)),i=""),e=B.pop(),C=B[B.length-1],d=F.getDomElementsFromDataElement(a.getElement(),G,e)[0]){for(b=0,c=e.length;c>b;b++)d.appendChild(e[b]);C.push(d)}else for(b=0,c=e.length;c>b;b++)C.push(e[b])}function f(b){var c,d;for(c=b+1,d=1;D>c&&d>0;c++)a[c].type&&(d+="/"===a[c].type.charAt(0)?-1:1);if(0!==d)throw new Error("Unbalanced data: "+d+" element(s) left open.");return c}function g(){var b;return b=ve.dm.nodeFactory.lookup(a[j].type)&&ve.dm.nodeFactory.doesNodeHandleOwnChildren(a[j].type)?a.slice(j,f(j)):a[j]}function h(){var b,c;for(j=0;D>j;j++)a[j].type&&"/"!==a[j].type.charAt(0)&&ve.dm.nodeFactory.lookup(a[j].type)&&ve.dm.nodeFactory.isNodeInternal(a[j].type)&&(b||(b=a.slice()),c=f(j),b.splice(j-(D-b.length),c-j),j=c-1);b&&(a=b,D=a.length)}var i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D=a.length,E=[],F=this,G=b.ownerDocument,H=b,I=new ve.dm.AnnotationSet(this.store);for(h(),j=0;D>j;j++)if("string"==typeof a[j]){for(i="",l=j>0&&ve.dm.LinearData.static.isOpenElementData(a[j-1])&&!ve.dm.nodeFactory.doesNodeHaveSignificantWhitespace(ve.dm.LinearData.static.getType(a[j-1]));"string"==typeof a[j];)l&&a[j].match(/\s/)||(i+=a[j],l=!1),j++;j--,H.appendChild(G.createTextNode(i))}else if(ve.isArray(a[j])||void 0!==a[j].annotations&&(this.metaItemFactory.lookup(a[j].type)||this.nodeFactory.isNodeContent(a[j].type))){for(i="",C=[],B=[C];void 0!==a[j]&&(ve.isArray(a[j])||void 0!==a[j].annotations&&(this.metaItemFactory.lookup(a[j].type)||this.nodeFactory.isNodeContent(a[j].type)));){if(m=new ve.dm.AnnotationSet(this.store,a[j].annotations||a[j][1]),ve.dm.Converter.openAndCloseAnnotations(I,m,d,e),void 0===a[j].annotations)i+=a[j][0];else{for(i.length>0&&(C.push(G.createTextNode(i)),i=""),o=g(),p=this.getDomElementsFromDataElement(o,G),k=0;k<p.length;k++)C.push(p[k]);ve.isArray(o)?j+=o.length-1:j++}j++}for(j--,i.length>0&&(C.push(G.createTextNode(i)),i=""),ve.dm.Converter.openAndCloseAnnotations(I,new ve.dm.AnnotationSet(this.store),d,e),k=0;k<C.length;k++)H.appendChild(C[k])}else if(void 0!==a[j].type)if(n=a[j],"/"===n.type.charAt(0)){if(t=H.parentNode,A=a[j].type.substr(1),this.metaItemFactory.lookup(A)?v=E[E.length-1]:(v=this.nodeFactory.isNodeContent(A),E.pop()),!v&&H.veInternal&&H.veInternal.whitespace?(q=H.veInternal.whitespace[1],q&&(H.firstChild&&H.firstChild.nodeType===Node.TEXT_NODE?H.firstChild.insertData(0,q):(z=G.createTextNode(q),z.veIsWhitespace=!0,H.insertBefore(z,H.firstChild))),u=H.veInternal.childDomElements?H.veInternal.childDomElements[H.veInternal.childDomElements.length-1].lastChild:H.lastChild,r=H.veInternal.whitespace[2],s=void 0===H.lastOuterPost?r:H.lastOuterPost,r&&r===s&&(u&&u.nodeType===Node.TEXT_NODE?H.lastChild.appendData(r):(z=G.createTextNode(r),z.veIsWhitespace=!0,H.appendChild(z))),t.lastOuterPost=H.veInternal.whitespace[3]||""):v||(t.lastOuterPost=""),y=!1,H.veInternal)switch(H.veInternal.generated){case"empty":0!==H.childNodes.length||j!==a.length-1&&"/"!==a[j+1].type.charAt(0)||(y=!0);break;case"wrapper":for(y=!0,x=H.parentElement.childNodes,k=x.length-2;k>=0;k--){if(w=x[k],w.nodeType===Node.TEXT_NODE&&!w.veIsWhitespace){y=!1;break}if(ve.isBlockElement(w))break}}if(y){for(;H.firstChild;)t.insertBefore(H.firstChild,H);t.removeChild(H)}delete H.veInternal,delete H.lastOuterPost,ve.dm.nodeFactory.lookup(A)&&ve.dm.nodeFactory.isNodeInternal(A)||(H=t)}else{if(this.metaItemFactory.lookup(a[j].type)||E.push(E[E.length-1]||this.nodeFactory.canNodeContainContent(a[j].type)),o=g(),p=this.getDomElementsFromDataElement(o,G)){for(p[0].veInternal=ve.extendObject({childDomElements:p},n.internal?ve.copy(n.internal):{}),k=0;k<p.length;k++)H.appendChild(p[k]);t=H,H=p[0],H.veInternal&&H.veInternal.whitespace&&(r=H.veInternal.whitespace[0],s=void 0,H.previousSibling?s=t.lastOuterPost:t===b?s=c?c[0]:r:t.veInternal&&t.veInternal.whitespace&&(s=t.veInternal.whitespace[1],t.veInternal.whitespace[1]=void 0),r&&r===s&&(z=G.createTextNode(r),z.veIsWhitespace=!0,t.insertBefore(z,H)))}ve.isArray(o)&&(j+=o.length-2)}void 0===b.lastOuterPost||c&&b.lastOuterPost!==c[1]||(b.lastChild&&b.lastChild.nodeType===Node.TEXT_NODE?b.lastChild.appendData(b.lastOuterPost):b.appendChild(G.createTextNode(b.lastOuterPost)),delete b.lastOuterPost),b.normalize()},ve.dm.converter=new ve.dm.Converter(ve.dm.modelRegistry,ve.dm.nodeFactory,ve.dm.annotationFactory,ve.dm.metaItemFactory),ve.dm.FlatLinearData=function(a,b){ve.dm.LinearData.call(this,a,b)},OO.inheritClass(ve.dm.FlatLinearData,ve.dm.LinearData),ve.dm.FlatLinearData.prototype.getType=function(a){return ve.dm.LinearData.static.getType(this.getData(a))},ve.dm.FlatLinearData.prototype.isElementData=function(a){return ve.dm.LinearData.static.isElementData(this.getData(a))},ve.dm.FlatLinearData.prototype.containsElementData=function(){for(var a=this.getLength();a--;)if(this.isElementData(a))return!0;return!1},ve.dm.FlatLinearData.prototype.isOpenElementData=function(a){return ve.dm.LinearData.static.isOpenElementData(this.getData(a))},ve.dm.FlatLinearData.prototype.isCloseElementData=function(a){return ve.dm.LinearData.static.isCloseElementData(this.getData(a))},ve.dm.ElementLinearData=function(a,b){ve.dm.FlatLinearData.call(this,a,b)},OO.inheritClass(ve.dm.ElementLinearData,ve.dm.FlatLinearData),ve.dm.ElementLinearData.static.compareUnannotated=function(a,b){if(void 0===a||void 0===b)return!1;var c=a,d=b;return ve.isArray(a)&&(c=a[0]),ve.isArray(b)&&(d=b[0]),a&&a.type&&(c=ve.copy(a),delete c.annotations,delete c.internal),b&&b.type&&(d=ve.copy(b),delete d.annotations,delete d.internal),ve.compare(c,d)},ve.dm.ElementLinearData.prototype.isContentOffset=function(a){if(0===a||a===this.getLength())return!1;var b=this.getData(a-1),c=this.getData(a),d=ve.dm.nodeFactory;return void 0!==b&&void 0!==c&&("string"==typeof b||"string"==typeof c||ve.isArray(b)||ve.isArray(c)||"string"==typeof b.type&&"/"===b.type.charAt(0)&&d.isNodeContent(b.type.substr(1))||"string"==typeof c.type&&"/"!==c.type.charAt(0)&&d.isNodeContent(c.type)||"/"+b.type===c.type&&d.canNodeContainContent(b.type))},ve.dm.ElementLinearData.prototype.isStructuralOffset=function(a,b){if(0===a||a===this.getLength())return!0;var c=this.getData(a-1),d=this.getData(a),e=ve.dm.nodeFactory;return!(void 0===c||void 0===d||"string"!=typeof c.type||"string"!=typeof d.type||("/"!==c.type.charAt(0)||!e.canNodeHaveChildren(c.type.substr(1))&&e.isNodeContent(c.type.substr(1))||b&&null!==e.getParentNodeTypes(c.type.substr(1)))&&("/"===d.type.charAt(0)||!e.canNodeHaveChildren(d.type)&&e.isNodeContent(d.type)||b&&null!==e.getParentNodeTypes(d.type))&&("/"+c.type!==d.type||!e.canNodeHaveChildrenNotContent(c.type)||b&&null!==e.getChildNodeTypes(c.type)))},ve.dm.ElementLinearData.prototype.isContentData=function(){for(var a,b=this.getLength();b--;)if(a=this.getData(b),void 0!==a.type&&"/"!==a.type.charAt(0)&&!ve.dm.nodeFactory.isNodeContent(a.type))return!1;return!0},ve.dm.ElementLinearData.prototype.getAnnotationIndexesFromOffset=function(a,b){if(0>a||a>this.getLength())throw new Error("offset "+a+" out of bounds");b||!this.isCloseElementData(a)||ve.dm.nodeFactory.canNodeHaveChildren(this.getType(a))||(a=this.getRelativeContentOffset(a,-1));var c=this.getData(a);return void 0===c||"string"==typeof c?[]:c.annotations?c.annotations.slice():c[1]?c[1].slice():[]},ve.dm.ElementLinearData.prototype.getAnnotationsFromOffset=function(a,b){return new ve.dm.AnnotationSet(this.getStore(),this.getAnnotationIndexesFromOffset(a,b))},ve.dm.ElementLinearData.prototype.setAnnotationsAtOffset=function(a,b){var c,d=this.getData(a),e=this.isElementData(a);b.isEmpty()?e?delete d.annotations:(c=this.getCharacterData(a),this.setData(a,c)):e?d.annotations=this.getStore().indexes(b.get()):(c=this.getCharacterData(a),this.setData(a,[c,this.getStore().indexes(b.get())]))},ve.dm.ElementLinearData.prototype.getCharacterData=function(a){var b=this.getData(a);return ve.isArray(b)?b[0]:b},ve.dm.ElementLinearData.prototype.getAnnotatedRangeFromOffset=function(a,b){var c=a,d=a;if(this.getAnnotationsFromOffset(a).contains(b)===!1)return null;for(;c>0;)if(c--,this.getAnnotationsFromOffset(c).contains(b)===!1){c++;break}for(;d<this.getLength()&&this.getAnnotationsFromOffset(d).contains(b)!==!1;)d++;return new ve.Range(c,d)},ve.dm.ElementLinearData.prototype.getAnnotatedRangeFromSelection=function(a,b){for(var c=a.start,d=a.end;c>0;)if(c--,this.getAnnotationsFromOffset(c).contains(b)===!1){c++;break}for(;d<this.getLength()&&this.getAnnotationsFromOffset(d).contains(b)!==!1;)d++;return new ve.Range(c,d)},ve.dm.ElementLinearData.prototype.getAnnotationsFromRange=function(a,b){var c,d,e;if(d=this.getAnnotationsFromOffset(a.start),0===a.getLength()||1===a.getLength())return d;for(c=a.start+1;c<a.end;c++)if(!this.isElementData(c)||ve.dm.nodeFactory.isNodeContent(this.getType(c)))if(e=this.getAnnotationsFromOffset(c),b&&!e.isEmpty())d.addSet(e);else if(!b){if(e.isEmpty())return new ve.dm.AnnotationSet(this.getStore());if(d=d.getComparableAnnotationsFromSet(e),d.isEmpty())break}return d},ve.dm.ElementLinearData.prototype.hasAnnotationsInRange=function(a){var b;for(b=a.start;b<a.end;b++)if(this.getAnnotationIndexesFromOffset(b,!0).length)return!0;return!1},ve.dm.ElementLinearData.prototype.trimOuterSpaceFromRange=function(a){for(var b=a.start,c=a.end;" "===this.getCharacterData(c-1);)c--;for(;c>b&&" "===this.getCharacterData(b);)b++;return a.to<a.end?new ve.Range(c,b):new ve.Range(b,c)},ve.dm.ElementLinearData.prototype.getRelativeOffset=function(a,b,c){var d,e,f,g,h=Array.prototype.slice.call(arguments,3),i=a,j=0,k=!1,l=0;if(0===b){if(c.apply(this,[a].concat(h)))return a;b=1}for(e=0>=a?1:a>=this.getLength()?-1:b>0?1:-1,b=Math.abs(b),d=i+e,a=-1;d>=0&&d<=this.getLength();){if(f=d+(e>0?-1:0),this.isElementData(f)&&ve.dm.nodeFactory.doesNodeHandleOwnChildren(this.getType(f)))if(g=this.isOpenElementData(f),e>0&&g||0>e&&!g)l++;else if(l--,0>l)throw new Error("offset was inside a handlesOwnChildren node");if(c.apply(this,[d].concat(h))){if(!l&&(j++,a=d,b===j))return a}else if(!k&&0===j&&(0>e&&0===d||e>0&&d===this.getLength())){if(c.apply(this,[i].concat(h)))return i;e*=-1,d=i,b=1,k=!0,l=0}d+=e}return a},ve.dm.ElementLinearData.prototype.getRelativeContentOffset=function(a,b){return this.getRelativeOffset(a,b,this.constructor.prototype.isContentOffset)},ve.dm.ElementLinearData.prototype.getNearestContentOffset=function(a,b){if(this.isContentOffset(a))return a;if(void 0===b){var c=this.getRelativeContentOffset(a,-1),d=this.getRelativeContentOffset(a,1);return d-a>a-c?c:d}return this.getRelativeContentOffset(a,b>0?1:-1)},ve.dm.ElementLinearData.prototype.getRelativeStructuralOffset=function(a,b,c){return 0!==b||0!==a&&a!==this.getLength()?this.getRelativeOffset(a,b,this.constructor.prototype.isStructuralOffset,c):a},ve.dm.ElementLinearData.prototype.getNearestStructuralOffset=function(a,b,c){if(this.isStructuralOffset(a,c))return a;if(b)return this.getRelativeStructuralOffset(a,b>0?1:-1,c);var d=this.getRelativeStructuralOffset(a,-1,c),e=this.getRelativeStructuralOffset(a,1,c);return e-a>a-d?d:e},ve.dm.ElementLinearData.prototype.getNearestWordRange=function(a){var b,c,d=new ve.dm.DataString(this.getData());if(a=this.getNearestContentOffset(a),unicodeJS.wordbreak.isBreak(d,a))if(unicodeJS.wordbreak.isBreak(d,a+1)){if(unicodeJS.wordbreak.isBreak(d,a-1))return new ve.Range(a);a--}else a++;return c=unicodeJS.wordbreak.nextBreakOffset(d,a),b=unicodeJS.wordbreak.prevBreakOffset(d,a),new ve.Range(b,c)},ve.dm.ElementLinearData.prototype.getUsedStoreValues=function(){var a,b,c,d={};for(a=this.getLength();a--;)for(b=this.getAnnotationIndexesFromOffset(a,!0),c=b.length;c--;)d[b[c]]=!0;for(a in d)d[a]=this.getStore().value(a);return d},ve.dm.ElementLinearData.prototype.remapStoreIndexes=function(a){var b,c,d,e,f,g;for(b=0,c=this.data.length;c>b;b++){for(f=this.getAnnotationIndexesFromOffset(b,!0),d=0,e=f.length;e>d;d++)f[d]=a[f[d]];this.isOpenElementData(b)&&(g=ve.dm.nodeFactory.lookup(this.getType(b)),g.static.remapStoreIndexes(this.data[b],a))}},ve.dm.ElementLinearData.prototype.remapInternalListIndexes=function(a,b){var c,d,e;for(c=0,d=this.data.length;d>c;c++)this.isOpenElementData(c)&&(e=ve.dm.nodeFactory.lookup(this.getType(c)),e.static.remapInternalListIndexes(this.data[c],a,b))},ve.dm.ElementLinearData.prototype.remapInternalListKeys=function(a){var b,c,d;for(b=0,c=this.data.length;c>b;b++)this.isOpenElementData(b)&&(d=ve.dm.nodeFactory.lookup(this.getType(b)),d.static.remapInternalListKeys(this.data[b],a))},ve.dm.ElementLinearData.prototype.sanitize=function(a,b,c){var d,e,f,g,h,i,j=this.getAnnotationsFromRange(new ve.Range(0,this.getLength()),!0);if(b)g=new ve.dm.AnnotationSet(this.getStore());else{if(a.removeHtmlAttributes)for(d=0,e=j.getLength();e>d;d++)delete j.get(d).element.htmlAttributes;if(a.removeStyles)for(d=0,e=j.getLength();e>d;d++)ve.dm.Model.static.removeHtmlAttribute(j.get(d).element,"style");h=j.filter(function(b){return-1!==ve.indexOf(b.name,a.blacklist)||"textStyle/span"===b.name&&!b.element.htmlAttributes&&(a.removeHtmlAttributes||a.removeStyles)})}for(d=0,e=this.getLength();e>d;d++){if(this.isElementData(d)){if(i=this.getType(d),a.conversions&&a.conversions[i]&&(this.getData(d).type=(this.isCloseElementData(d)?"/":"")+a.conversions[i]),-1!==ve.indexOf(i,a.blacklist)||b&&"paragraph"!==i&&"internalList"!==i){this.splice(d,1),ve.getProp(this.getData(d),"internal","generated")&&(delete this.getData(d).internal.generated,ve.isEmptyObject(this.getData(d).internal)&&delete this.getData(d).internal),d--,e--;continue}if(!c&&d>0&&this.isCloseElementData(d)&&this.isOpenElementData(d-1)&&ve.dm.nodeFactory.canNodeContainContent(i)){this.splice(d-1,2),d-=2,e-=2;continue}}f=this.getAnnotationsFromOffset(d,!0),f.isEmpty()||(b?this.setAnnotationsAtOffset(d,g):h.getLength()&&(f.removeSet(h),this.setAnnotationsAtOffset(d,f))),this.isOpenElementData(d)&&(a.removeHtmlAttributes&&delete this.getData(d).htmlAttributes,a.removeStyles&&ve.dm.Model.static.removeHtmlAttribute(this.getData(d),"style"))}},ve.dm.ElementLinearData.prototype.cloneElements=function(){var a,b,c;for(a=0,b=this.getLength();b>a;a++)this.isOpenElementData(a)&&(c=ve.dm.nodeFactory.create(this.getType(a),this.getData(a)),this.data[a]=c.getClonedElement())},ve.dm.ElementLinearData.prototype.countNonInternalElements=function(){var a,b,c,d=0,e=0;for(a=0,b=this.getLength();b>a;a++)c=this.getType(a),c&&ve.dm.nodeFactory.isNodeInternal(c)?this.isOpenElementData(a)?d++:d--:d||e++;return e},ve.dm.MetaLinearData=function(a,b){ve.dm.LinearData.call(this,a,b)},OO.inheritClass(ve.dm.MetaLinearData,ve.dm.LinearData),ve.dm.MetaLinearData.static.merge=function(a){var b,c=[],d=!0;for(b=0;b<a.length;b++)void 0!==a[b]&&(d=!1,c=c.concat(a[b]));return d?[void 0]:[c]},ve.dm.MetaLinearData.prototype.getData=function(a,b){return void 0===a?this.data:void 0===b?this.data[a]:void 0===this.data[a]?void 0:this.data[a][b]},ve.dm.MetaLinearData.prototype.getDataLength=function(a){return void 0===this.data[a]?0:this.data[a].length},ve.dm.MetaLinearData.prototype.getTotalDataLength=function(){for(var a=0,b=this.getLength();b--;)a+=this.getDataLength(b);return a},ve.dm.MetaLinearData.prototype.getAnnotationIndexesFromOffsetAndIndex=function(a,b){var c=this.getData(a,b);return c&&c.annotations||[]},ve.dm.MetaLinearData.prototype.getAnnotationsFromOffsetAndIndex=function(a,b){return new ve.dm.AnnotationSet(this.getStore(),this.getAnnotationIndexesFromOffsetAndIndex(a,b))},ve.dm.MetaLinearData.prototype.setAnnotationsAtOffsetAndIndex=function(a,b,c){var d=this.getData(a,b);c.isEmpty()?delete d.annotations:d.annotations=this.getStore().indexes(c.get())},ve.dm.GeneratedContentNode=function(){},ve.dm.GeneratedContentNode.static={},ve.dm.GeneratedContentNode.static.storeGeneratedContents=function(a,b,c){var d=OO.getHash([this.getHashObject(a),void 0]);return c.index(b,d)},ve.dm.AlienNode=function(){ve.dm.LeafNode.apply(this,arguments),ve.dm.GeneratedContentNode.call(this)},OO.inheritClass(ve.dm.AlienNode,ve.dm.LeafNode),OO.mixinClass(ve.dm.AlienNode,ve.dm.GeneratedContentNode),ve.dm.AlienNode.static.name="alien",ve.dm.AlienNode.static.storeHtmlAttributes=!1,ve.dm.AlienNode.static.enableAboutGrouping=!0,ve.dm.AlienNode.static.matchRdfaTypes=["ve:Alien"],ve.dm.AlienNode.static.toDataElement=function(a,b){var c=this.isHybridInline(a,b),d=c?"alienInline":"alienBlock";return{type:d,attributes:{domElements:ve.copy(a)}}},ve.dm.AlienNode.static.toDomElements=function(a,b){return ve.copyDomElements(a.attributes.domElements,b)},ve.dm.AlienNode.static.getHashObject=function(a){var b=ve.dm.LeafNode.static.getHashObject(a);return b.attributes&&b.attributes.domElements&&(b.attributes=ve.copy(b.attributes),b.attributes.domElements=ve.copy(b.attributes.domElements,ve.convertDomElements)),b},ve.dm.AlienBlockNode=function(){ve.dm.AlienNode.apply(this,arguments)},OO.inheritClass(ve.dm.AlienBlockNode,ve.dm.AlienNode),ve.dm.AlienBlockNode.static.name="alienBlock",ve.dm.AlienInlineNode=function(){ve.dm.AlienNode.apply(this,arguments)},OO.inheritClass(ve.dm.AlienInlineNode,ve.dm.AlienNode),ve.dm.AlienInlineNode.static.name="alienInline",ve.dm.AlienInlineNode.static.isContent=!0,ve.dm.modelRegistry.register(ve.dm.AlienNode),ve.dm.modelRegistry.register(ve.dm.AlienBlockNode),ve.dm.modelRegistry.register(ve.dm.AlienInlineNode),ve.dm.BreakNode=function(){ve.dm.LeafNode.apply(this,arguments)},OO.inheritClass(ve.dm.BreakNode,ve.dm.LeafNode),ve.dm.BreakNode.static.name="break",ve.dm.BreakNode.static.isContent=!0,ve.dm.BreakNode.static.matchTagNames=["br"],ve.dm.modelRegistry.register(ve.dm.BreakNode),ve.dm.CenterNode=function(){ve.dm.BranchNode.apply(this,arguments)},OO.inheritClass(ve.dm.CenterNode,ve.dm.BranchNode),ve.dm.CenterNode.static.name="center",ve.dm.CenterNode.static.matchTagNames=["center"],ve.dm.modelRegistry.register(ve.dm.CenterNode),ve.dm.DefinitionListItemNode=function(){ve.dm.BranchNode.apply(this,arguments)},OO.inheritClass(ve.dm.DefinitionListItemNode,ve.dm.BranchNode),ve.dm.DefinitionListItemNode.static.name="definitionListItem",ve.dm.DefinitionListItemNode.static.parentNodeTypes=["definitionList"],ve.dm.DefinitionListItemNode.static.defaultAttributes={style:"term"},ve.dm.DefinitionListItemNode.static.matchTagNames=["dt","dd"],ve.dm.DefinitionListItemNode.static.toDataElement=function(a){var b="dt"===a[0].nodeName.toLowerCase()?"term":"definition";return{type:this.name,attributes:{style:b}}},ve.dm.DefinitionListItemNode.static.toDomElements=function(a,b){var c=a.attributes&&"term"===a.attributes.style?"dt":"dd";return[b.createElement(c)]},ve.dm.modelRegistry.register(ve.dm.DefinitionListItemNode),ve.dm.DefinitionListNode=function(){ve.dm.BranchNode.apply(this,arguments)},OO.inheritClass(ve.dm.DefinitionListNode,ve.dm.BranchNode),ve.dm.DefinitionListNode.static.name="definitionList",ve.dm.DefinitionListNode.static.childNodeTypes=["definitionListItem"],ve.dm.DefinitionListNode.static.matchTagNames=["dl"],ve.dm.modelRegistry.register(ve.dm.DefinitionListNode),ve.dm.DivNode=function(){ve.dm.BranchNode.apply(this,arguments)},OO.inheritClass(ve.dm.DivNode,ve.dm.BranchNode),ve.dm.DivNode.static.name="div",ve.dm.DivNode.static.matchTagNames=["div"],ve.dm.modelRegistry.register(ve.dm.DivNode),ve.dm.DocumentNode=function(a){ve.dm.BranchNode.call(this,null,a),this.root=this},OO.inheritClass(ve.dm.DocumentNode,ve.dm.BranchNode),ve.dm.DocumentNode.static.name="document",ve.dm.DocumentNode.static.isWrapped=!1,ve.dm.DocumentNode.static.parentNodeTypes=[],ve.dm.DocumentNode.static.matchTagNames=[],ve.dm.modelRegistry.register(ve.dm.DocumentNode),ve.dm.HeadingNode=function(){ve.dm.BranchNode.apply(this,arguments)},OO.inheritClass(ve.dm.HeadingNode,ve.dm.BranchNode),ve.dm.HeadingNode.static.name="heading",ve.dm.HeadingNode.static.canContainContent=!0,ve.dm.HeadingNode.static.defaultAttributes={level:1},ve.dm.HeadingNode.static.matchTagNames=["h1","h2","h3","h4","h5","h6"],ve.dm.HeadingNode.static.toDataElement=function(a){var b={h1:1,h2:2,h3:3,h4:4,h5:5,h6:6},c=b[a[0].nodeName.toLowerCase()];return{type:this.name,attributes:{level:c}}},ve.dm.HeadingNode.static.toDomElements=function(a,b){var c=a.attributes&&a.attributes.level||1;return[b.createElement("h"+c)]},ve.dm.modelRegistry.register(ve.dm.HeadingNode),ve.dm.ImageNode=function(){ve.dm.LeafNode.apply(this,arguments),ve.dm.ResizableNode.call(this)},OO.inheritClass(ve.dm.ImageNode,ve.dm.LeafNode),OO.mixinClass(ve.dm.ImageNode,ve.dm.ResizableNode),ve.dm.ImageNode.static.name="image",ve.dm.ImageNode.static.isContent=!0,ve.dm.ImageNode.static.matchTagNames=["img"],ve.dm.ImageNode.static.toDataElement=function(a){var b=$(a[0]),c=b.attr("alt"),d=b.attr("width"),e=b.attr("height");return{type:this.name,attributes:{src:b.attr("src"),alt:void 0!==c?c:null,width:void 0!==d&&""!==d?Number(d):null,height:void 0!==e&&""!==e?Number(e):null}}},ve.dm.ImageNode.static.toDomElements=function(a,b){var c=b.createElement("img");return ve.setDomAttributes(c,a.attributes,["alt","src","width","height"]),[c]},ve.dm.ImageNode.prototype.createScalable=function(){return new ve.dm.Scalable({currentDimensions:{width:this.getAttribute("width"),height:this.getAttribute("height")},minDimensions:{width:1,height:1}})},ve.dm.modelRegistry.register(ve.dm.ImageNode),ve.dm.InternalItemNode=function(){ve.dm.BranchNode.apply(this,arguments)},OO.inheritClass(ve.dm.InternalItemNode,ve.dm.BranchNode),ve.dm.InternalItemNode.static.name="internalItem",ve.dm.InternalItemNode.static.matchTagNames=[],ve.dm.InternalItemNode.static.handlesOwnChildren=!0,ve.dm.InternalItemNode.static.isInternal=!0,ve.dm.modelRegistry.register(ve.dm.InternalItemNode),ve.dm.InternalListNode=function(){ve.dm.BranchNode.apply(this,arguments)},OO.inheritClass(ve.dm.InternalListNode,ve.dm.BranchNode),ve.dm.InternalListNode.static.name="internalList",ve.dm.InternalListNode.static.childNodeTypes=["internalItem"],ve.dm.InternalListNode.static.matchTagNames=[],ve.dm.InternalListNode.static.isInternal=!0,ve.dm.modelRegistry.register(ve.dm.InternalListNode),ve.dm.ListItemNode=function(){ve.dm.BranchNode.apply(this,arguments)},OO.inheritClass(ve.dm.ListItemNode,ve.dm.BranchNode),ve.dm.ListItemNode.static.name="listItem",ve.dm.ListItemNode.static.parentNodeTypes=["list"],ve.dm.ListItemNode.static.matchTagNames=["li"],ve.dm.modelRegistry.register(ve.dm.ListItemNode),ve.dm.ListNode=function(){ve.dm.BranchNode.apply(this,arguments)},OO.inheritClass(ve.dm.ListNode,ve.dm.BranchNode),ve.dm.ListNode.static.name="list",ve.dm.ListNode.static.childNodeTypes=["listItem"],ve.dm.ListNode.static.defaultAttributes={style:"bullet"},ve.dm.ListNode.static.matchTagNames=["ul","ol"],ve.dm.ListNode.static.toDataElement=function(a){var b="ol"===a[0].nodeName.toLowerCase()?"number":"bullet";return{type:this.name,attributes:{style:b}}},ve.dm.ListNode.static.toDomElements=function(a,b){var c=a.attributes&&"number"===a.attributes.style?"ol":"ul";return[b.createElement(c)]},ve.dm.modelRegistry.register(ve.dm.ListNode),ve.dm.ParagraphNode=function(){ve.dm.BranchNode.apply(this,arguments)},OO.inheritClass(ve.dm.ParagraphNode,ve.dm.BranchNode),ve.dm.ParagraphNode.static.name="paragraph",ve.dm.ParagraphNode.static.canContainContent=!0,ve.dm.ParagraphNode.static.matchTagNames=["p"],ve.dm.modelRegistry.register(ve.dm.ParagraphNode),ve.dm.PreformattedNode=function(){ve.dm.BranchNode.apply(this,arguments)},OO.inheritClass(ve.dm.PreformattedNode,ve.dm.BranchNode),ve.dm.PreformattedNode.static.name="preformatted",ve.dm.PreformattedNode.static.canContainContent=!0,ve.dm.PreformattedNode.static.hasSignificantWhitespace=!0,ve.dm.PreformattedNode.static.matchTagNames=["pre"],ve.dm.modelRegistry.register(ve.dm.PreformattedNode),ve.dm.TableCaptionNode=function(){ve.dm.BranchNode.apply(this,arguments)},OO.inheritClass(ve.dm.TableCaptionNode,ve.dm.BranchNode),ve.dm.TableCaptionNode.static.name="tableCaption",ve.dm.TableCaptionNode.static.parentNodeTypes=["table"],ve.dm.TableCaptionNode.static.matchTagNames=["caption"],ve.dm.modelRegistry.register(ve.dm.TableCaptionNode),ve.dm.TableCellNode=function(){ve.dm.BranchNode.apply(this,arguments)},OO.inheritClass(ve.dm.TableCellNode,ve.dm.BranchNode),ve.dm.TableCellNode.static.name="tableCell",ve.dm.TableCellNode.static.parentNodeTypes=["tableRow"],ve.dm.TableCellNode.static.defaultAttributes={style:"data"},ve.dm.TableCellNode.static.matchTagNames=["td","th"],ve.dm.TableCellNode.static.toDataElement=function(a){var b="th"===a[0].nodeName.toLowerCase()?"header":"data";return{type:this.name,attributes:{style:b}}},ve.dm.TableCellNode.static.toDomElements=function(a,b){var c=a.attributes&&"header"===a.attributes.style?"th":"td";return[b.createElement(c)]},ve.dm.modelRegistry.register(ve.dm.TableCellNode),ve.dm.TableNode=function(){ve.dm.BranchNode.apply(this,arguments)},OO.inheritClass(ve.dm.TableNode,ve.dm.BranchNode),ve.dm.TableNode.static.name="table",ve.dm.TableNode.static.childNodeTypes=["tableSection","tableCaption"],ve.dm.TableNode.static.matchTagNames=["table"],ve.dm.modelRegistry.register(ve.dm.TableNode),ve.dm.TableRowNode=function(){ve.dm.BranchNode.apply(this,arguments)},OO.inheritClass(ve.dm.TableRowNode,ve.dm.BranchNode),ve.dm.TableRowNode.static.name="tableRow",ve.dm.TableRowNode.static.childNodeTypes=["tableCell"],ve.dm.TableRowNode.static.parentNodeTypes=["tableSection"],ve.dm.TableRowNode.static.matchTagNames=["tr"],ve.dm.modelRegistry.register(ve.dm.TableRowNode),ve.dm.TableSectionNode=function(){ve.dm.BranchNode.apply(this,arguments)
},OO.inheritClass(ve.dm.TableSectionNode,ve.dm.BranchNode),ve.dm.TableSectionNode.static.name="tableSection",ve.dm.TableSectionNode.static.childNodeTypes=["tableRow"],ve.dm.TableSectionNode.static.parentNodeTypes=["table"],ve.dm.TableSectionNode.static.defaultAttributes={style:"body"},ve.dm.TableSectionNode.static.matchTagNames=["thead","tbody","tfoot"],ve.dm.TableSectionNode.static.toDataElement=function(a){var b={thead:"header",tbody:"body",tfoot:"footer"},c=b[a[0].nodeName.toLowerCase()]||"body";return{type:this.name,attributes:{style:c}}},ve.dm.TableSectionNode.static.toDomElements=function(a,b){var c={header:"thead",body:"tbody",footer:"tfoot"},d=c[a.attributes&&a.attributes.style||"body"];return[b.createElement(d)]},ve.dm.modelRegistry.register(ve.dm.TableSectionNode),ve.dm.TextNode=function(a){ve.dm.LeafNode.call(this),this.length=a||0},OO.inheritClass(ve.dm.TextNode,ve.dm.LeafNode),ve.dm.TextNode.static.name="text",ve.dm.TextNode.static.isWrapped=!1,ve.dm.TextNode.static.isContent=!0,ve.dm.TextNode.static.matchTagNames=[],ve.dm.modelRegistry.register(ve.dm.TextNode),ve.dm.LanguageAnnotation=function(a){ve.dm.Annotation.call(this,a)},OO.inheritClass(ve.dm.LanguageAnnotation,ve.dm.Annotation),ve.dm.LanguageAnnotation.static.name="meta/language",ve.dm.LanguageAnnotation.static.matchTagNames=["span"],ve.dm.LanguageAnnotation.static.matchFunction=function(a){return a.getAttribute("lang")||a.getAttribute("dir")},ve.dm.LanguageAnnotation.static.applyToAppendedContent=!0,ve.dm.LanguageAnnotation.static.toDataElement=function(a){return{type:this.name,attributes:{lang:a[0].getAttribute("lang"),dir:a[0].getAttribute("dir")}}},ve.dm.LanguageAnnotation.static.toDomElements=function(a,b){var c=b.createElement("span");return a.attributes.lang&&c.setAttribute("lang",a.attributes.lang),a.attributes.dir&&c.setAttribute("dir",a.attributes.dir),[c]},ve.dm.LanguageAnnotation.prototype.getComparableObject=function(){return{type:"meta/language",lang:this.getAttribute("lang"),dir:this.getAttribute("dir")}},ve.dm.modelRegistry.register(ve.dm.LanguageAnnotation),ve.dm.LinkAnnotation=function(a){ve.dm.Annotation.call(this,a)},OO.inheritClass(ve.dm.LinkAnnotation,ve.dm.Annotation),ve.dm.LinkAnnotation.static.name="link",ve.dm.LinkAnnotation.static.matchTagNames=["a"],ve.dm.LinkAnnotation.static.splitOnWordbreak=!0,ve.dm.LinkAnnotation.static.toDataElement=function(a){return{type:this.name,attributes:{href:a[0].getAttribute("href")}}},ve.dm.LinkAnnotation.static.toDomElements=function(a,b){var c=b.createElement("a");return c.setAttribute("href",this.getHref(a)),[c]},ve.dm.LinkAnnotation.static.getHref=function(a){return a.attributes.href},ve.dm.LinkAnnotation.prototype.getHref=function(){return this.constructor.static.getHref(this.element)},ve.dm.LinkAnnotation.prototype.getComparableObject=function(){return{type:this.getType(),href:this.getAttribute("href")}},ve.dm.modelRegistry.register(ve.dm.LinkAnnotation),ve.dm.TextStyleAnnotation=function(a){ve.dm.Annotation.call(this,a)},OO.inheritClass(ve.dm.TextStyleAnnotation,ve.dm.Annotation),ve.dm.TextStyleAnnotation.static.name="textStyle",ve.dm.TextStyleAnnotation.static.matchTagNames=[],ve.dm.TextStyleAnnotation.static.toDataElement=function(a){return{type:this.name,attributes:{nodeName:a[0].nodeName.toLowerCase()}}},ve.dm.TextStyleAnnotation.static.toDomElements=function(a,b){var c=ve.getProp(a,"attributes","nodeName");return[b.createElement(c||this.matchTagNames[0])]},ve.dm.TextStyleAnnotation.prototype.getComparableObject=function(){return{type:this.getType()}},ve.dm.modelRegistry.register(ve.dm.TextStyleAnnotation),ve.dm.AbbreviationAnnotation=function(a){ve.dm.TextStyleAnnotation.call(this,a)},OO.inheritClass(ve.dm.AbbreviationAnnotation,ve.dm.TextStyleAnnotation),ve.dm.AbbreviationAnnotation.static.name="textStyle/abbreviation",ve.dm.AbbreviationAnnotation.static.matchTagNames=["abbr"],ve.dm.modelRegistry.register(ve.dm.AbbreviationAnnotation),ve.dm.BigAnnotation=function(a){ve.dm.TextStyleAnnotation.call(this,a)},OO.inheritClass(ve.dm.BigAnnotation,ve.dm.TextStyleAnnotation),ve.dm.BigAnnotation.static.name="textStyle/big",ve.dm.BigAnnotation.static.matchTagNames=["big"],ve.dm.modelRegistry.register(ve.dm.BigAnnotation),ve.dm.BoldAnnotation=function(a){ve.dm.TextStyleAnnotation.call(this,a)},OO.inheritClass(ve.dm.BoldAnnotation,ve.dm.TextStyleAnnotation),ve.dm.BoldAnnotation.static.name="textStyle/bold",ve.dm.BoldAnnotation.static.matchTagNames=["b","strong"],ve.dm.modelRegistry.register(ve.dm.BoldAnnotation),ve.dm.CodeSampleAnnotation=function(a){ve.dm.TextStyleAnnotation.call(this,a)},OO.inheritClass(ve.dm.CodeSampleAnnotation,ve.dm.TextStyleAnnotation),ve.dm.CodeSampleAnnotation.static.name="textStyle/codeSample",ve.dm.CodeSampleAnnotation.static.matchTagNames=["samp"],ve.dm.modelRegistry.register(ve.dm.CodeSampleAnnotation),ve.dm.CodeAnnotation=function(a){ve.dm.TextStyleAnnotation.call(this,a)},OO.inheritClass(ve.dm.CodeAnnotation,ve.dm.TextStyleAnnotation),ve.dm.CodeAnnotation.static.name="textStyle/code",ve.dm.CodeAnnotation.static.matchTagNames=["code","tt"],ve.dm.modelRegistry.register(ve.dm.CodeAnnotation),ve.dm.DatetimeAnnotation=function(a){ve.dm.TextStyleAnnotation.call(this,a)},OO.inheritClass(ve.dm.DatetimeAnnotation,ve.dm.TextStyleAnnotation),ve.dm.DatetimeAnnotation.static.name="textStyle/datetime",ve.dm.DatetimeAnnotation.static.matchTagNames=["time"],ve.dm.modelRegistry.register(ve.dm.DatetimeAnnotation),ve.dm.DefinitionAnnotation=function(a){ve.dm.TextStyleAnnotation.call(this,a)},OO.inheritClass(ve.dm.DefinitionAnnotation,ve.dm.TextStyleAnnotation),ve.dm.DefinitionAnnotation.static.name="textStyle/definition",ve.dm.DefinitionAnnotation.static.matchTagNames=["dfn"],ve.dm.modelRegistry.register(ve.dm.DefinitionAnnotation),ve.dm.HighlightAnnotation=function(a){ve.dm.TextStyleAnnotation.call(this,a)},OO.inheritClass(ve.dm.HighlightAnnotation,ve.dm.TextStyleAnnotation),ve.dm.HighlightAnnotation.static.name="textStyle/highlight",ve.dm.HighlightAnnotation.static.matchTagNames=["mark"],ve.dm.modelRegistry.register(ve.dm.HighlightAnnotation),ve.dm.ItalicAnnotation=function(a){ve.dm.TextStyleAnnotation.call(this,a)},OO.inheritClass(ve.dm.ItalicAnnotation,ve.dm.TextStyleAnnotation),ve.dm.ItalicAnnotation.static.name="textStyle/italic",ve.dm.ItalicAnnotation.static.matchTagNames=["i","em"],ve.dm.modelRegistry.register(ve.dm.ItalicAnnotation),ve.dm.QuotationAnnotation=function(a){ve.dm.TextStyleAnnotation.call(this,a)},OO.inheritClass(ve.dm.QuotationAnnotation,ve.dm.TextStyleAnnotation),ve.dm.QuotationAnnotation.static.name="textStyle/quotation",ve.dm.QuotationAnnotation.static.matchTagNames=["q"],ve.dm.modelRegistry.register(ve.dm.QuotationAnnotation),ve.dm.SmallAnnotation=function(a){ve.dm.TextStyleAnnotation.call(this,a)},OO.inheritClass(ve.dm.SmallAnnotation,ve.dm.TextStyleAnnotation),ve.dm.SmallAnnotation.static.name="textStyle/small",ve.dm.SmallAnnotation.static.matchTagNames=["small"],ve.dm.modelRegistry.register(ve.dm.SmallAnnotation),ve.dm.SpanAnnotation=function(a){ve.dm.TextStyleAnnotation.call(this,a)},OO.inheritClass(ve.dm.SpanAnnotation,ve.dm.TextStyleAnnotation),ve.dm.SpanAnnotation.static.name="textStyle/span",ve.dm.SpanAnnotation.static.matchTagNames=["span"],ve.dm.modelRegistry.register(ve.dm.SpanAnnotation),ve.dm.StrikethroughAnnotation=function(a){ve.dm.TextStyleAnnotation.call(this,a)},OO.inheritClass(ve.dm.StrikethroughAnnotation,ve.dm.TextStyleAnnotation),ve.dm.StrikethroughAnnotation.static.name="textStyle/strikethrough",ve.dm.StrikethroughAnnotation.static.matchTagNames=["s"],ve.dm.modelRegistry.register(ve.dm.StrikethroughAnnotation),ve.dm.SubscriptAnnotation=function(a){ve.dm.TextStyleAnnotation.call(this,a)},OO.inheritClass(ve.dm.SubscriptAnnotation,ve.dm.TextStyleAnnotation),ve.dm.SubscriptAnnotation.static.name="textStyle/subscript",ve.dm.SubscriptAnnotation.static.matchTagNames=["sub"],ve.dm.SubscriptAnnotation.static.removes=["textStyle/superscript"],ve.dm.modelRegistry.register(ve.dm.SubscriptAnnotation),ve.dm.SuperscriptAnnotation=function(a){ve.dm.TextStyleAnnotation.call(this,a)},OO.inheritClass(ve.dm.SuperscriptAnnotation,ve.dm.TextStyleAnnotation),ve.dm.SuperscriptAnnotation.static.name="textStyle/superscript",ve.dm.SuperscriptAnnotation.static.matchTagNames=["sup"],ve.dm.SuperscriptAnnotation.static.removes=["textStyle/subscript"],ve.dm.modelRegistry.register(ve.dm.SuperscriptAnnotation),ve.dm.UnderlineAnnotation=function(a){ve.dm.TextStyleAnnotation.call(this,a)},OO.inheritClass(ve.dm.UnderlineAnnotation,ve.dm.TextStyleAnnotation),ve.dm.UnderlineAnnotation.static.name="textStyle/underline",ve.dm.UnderlineAnnotation.static.matchTagNames=["u"],ve.dm.modelRegistry.register(ve.dm.UnderlineAnnotation),ve.dm.UserInputAnnotation=function(a){ve.dm.TextStyleAnnotation.call(this,a)},OO.inheritClass(ve.dm.UserInputAnnotation,ve.dm.TextStyleAnnotation),ve.dm.UserInputAnnotation.static.name="textStyle/userInput",ve.dm.UserInputAnnotation.static.matchTagNames=["kbd"],ve.dm.modelRegistry.register(ve.dm.UserInputAnnotation),ve.dm.VariableAnnotation=function(a){ve.dm.TextStyleAnnotation.call(this,a)},OO.inheritClass(ve.dm.VariableAnnotation,ve.dm.TextStyleAnnotation),ve.dm.VariableAnnotation.static.name="textStyle/variable",ve.dm.VariableAnnotation.static.matchTagNames=["var"],ve.dm.modelRegistry.register(ve.dm.VariableAnnotation),ve.dm.AlienMetaItem=function(a){ve.dm.MetaItem.call(this,a)},OO.inheritClass(ve.dm.AlienMetaItem,ve.dm.MetaItem),ve.dm.AlienMetaItem.static.name="alienMeta",ve.dm.AlienMetaItem.static.matchTagNames=["meta","link"],ve.dm.AlienMetaItem.static.storeHtmlAttributes=!1,ve.dm.AlienMetaItem.static.toDataElement=function(a){return{type:this.name,attributes:{domElements:ve.copy(a)}}},ve.dm.AlienMetaItem.static.toDomElements=function(a,b){return ve.copyDomElements(a.attributes.domElements,b)},ve.dm.modelRegistry.register(ve.dm.AlienMetaItem),ve.dm.CommentMetaItem=function(a){ve.dm.CommentMetaItem.super.call(this,a)},OO.inheritClass(ve.dm.CommentMetaItem,ve.dm.MetaItem),ve.dm.CommentMetaItem.static.name="commentMeta",ve.dm.CommentMetaItem.static.matchTagNames=[],ve.dm.CommentMetaItem.static.storeHtmlAttributes=!1,ve.dm.CommentMetaItem.static.toDomElements=function(a,b){return[b.createComment(a.attributes.text)]},ve.dm.modelRegistry.register(ve.dm.CommentMetaItem),ve.dm.CommentNode=function(a){ve.dm.CommentNode.super.call(this,a)},OO.inheritClass(ve.dm.CommentNode,ve.dm.LeafNode),ve.dm.CommentNode.static.isContent=!0,ve.dm.CommentNode.static.storeHtmlAttributes=!1,ve.dm.CommentNode.static.toDataElement=function(a,b){var c=a[0].nodeType===Node.COMMENT_NODE?a[0].data:a[0].getAttribute("data-ve-comment");return{type:b.isExpectingContent()&&""!==c?"comment":"commentMeta",attributes:{text:c}}},ve.dm.CommentNode.static.toDomElements=function(a,b,c){if(c.isForClipboard()){var d=b.createElement("span");return d.setAttribute("rel","ve:Comment"),d.setAttribute("data-ve-comment",a.attributes.text),[d]}return[b.createComment(a.attributes.text)]},ve.dm.RealCommentNode=function(a){ve.dm.RealCommentNode.super.call(this,a)},OO.inheritClass(ve.dm.RealCommentNode,ve.dm.CommentNode),ve.dm.RealCommentNode.static.name="comment",ve.dm.RealCommentNode.static.matchTagNames=["#comment"],ve.dm.FakeCommentNode=function(a){ve.dm.FakeCommentNode.super.call(this,a)},OO.inheritClass(ve.dm.FakeCommentNode,ve.dm.CommentNode),ve.dm.FakeCommentNode.static.name="fakeComment",ve.dm.FakeCommentNode.static.matchRdfaTypes=["ve:Comment"],ve.dm.modelRegistry.register(ve.dm.RealCommentNode),ve.dm.modelRegistry.register(ve.dm.FakeCommentNode),ve.ce={},ve.ce.whitespacePattern=/[\u0020\u00A0]/g,ve.ce.getDomText=function(a){var b=function(a){var c,d=a.nodeType,e=$(a),f="";if(d===Node.ELEMENT_NODE||d===Node.DOCUMENT_NODE||d===Node.DOCUMENT_FRAGMENT_NODE){if(e.hasClass("ve-ce-branchNode-slug"))return"";if(e.hasClass("ve-ce-leafNode"))return c=e.data("view"),c&&a===c.$element[0]?new Array(c.getOuterLength()+1).join("☃"):"";for(a=a.firstChild;a;a=a.nextSibling)f+=b(a)}else if(d===Node.TEXT_NODE)return a.data;return f};return b(a).replace(ve.ce.whitespacePattern," ")},ve.ce.getDomHash=function(a){var b=a.nodeType,c=a.nodeName,d="";if(3===b||4===b)return"#";if(1===b||9===b){for(d+="<"+c+">",a=a.firstChild;a;a=a.nextSibling)d+=ve.ce.getDomHash(a);d+="</"+c+">",d=d.replace(/##+/g,"#")}return d},ve.ce.getOffset=function(a,b){function c(a){for(;!a.previousSibling;){if(a=a.parentNode,!a)throw new Error("domNode has no ancestor with a .data( 'view' )");if($(a).data("view")instanceof ve.ce.Node)return a}if(a=a.previousSibling,$(a).data("view")instanceof ve.ce.Node)return a;for(;a.lastChild;)if(a=a.lastChild,$(a).data("view")instanceof ve.ce.Node)return a;return a}var d,e,f,g,h,i=0;if(h=a.nodeType===Node.ELEMENT_NODE?a.childNodes.length:a.data.length,0>b||b>h)throw new Error("domOffset is out of bounds");if(a.nodeType===Node.ELEMENT_NODE)if(0===a.childNodes.length){if(g=a,e=$(g).data("view"),e instanceof ve.ce.Node)return e.getOffset()+(e.isWrapped()?1:0);d=g}else if(b===a.childNodes.length){if(g=a.lastChild,e=$(g).data("view"),e instanceof ve.ce.Node)return e.getOffset()+e.getOuterLength();for(;g.lastChild;)if(g=g.lastChild,e=$(g).data("view"),e instanceof ve.ce.Node)return e.getOffset()+e.getOuterLength();d=g}else g=a.childNodes[b],d=c(g);else $(a.parentNode).hasClass("ve-ce-branchNode-slug")||(i+=b),g=a,d=c(g);for(;;){if(e=$(d).data("view"),e instanceof ve.ce.Node)break;d.nodeType!==Node.TEXT_NODE||$(d.parentNode).hasClass("ve-ce-branchNode-slug")||(i+=d.data.length),d=c(d)}return f=e.getOffset(),$.contains(d,g)?e.getModel().isContent()||(f+=e.getModel().isWrapped()?1:0,f+=i):(f+=e.getOuterLength(),e.isContent()&&(f+=i)),f},ve.ce.getOffsetOfSlug=function(a){var b;if(0===a.index())return b=a.parent().data("view").getModel(),b.getOffset()+(b.isWrapped()?1:0);if(a.prev().length)return b=a.prev().data("view").getModel(),b.getOffset()+b.getOuterLength();throw new Error("Incorrect slug location")},ve.ce.isShortcutKey=function(a){return!(!a.ctrlKey&&!a.metaKey)},ve.ce.DomRange=function(a,b,c,d){this.focusNode=a,this.focusOffset=b,this.anchorNode=c,this.anchorOffset=d},ve.ce.DomRange.newFromDomSelection=function(a){return new ve.ce.DomRange(a.focusNode,a.focusOffset,a.anchorNode,a.anchorOffset)},ve.ce.DomRange.prototype.equals=function(a){return a&&this.focusNode===a.focusNode&&this.focusOffset===a.focusOffset&&this.anchorNode===a.anchorNode&&this.anchorOffset===a.anchorOffset},ve.ce.DomRange.prototype.getRange=function(){return new ve.Range(ve.ce.getOffset(this.anchorNode,this.anchorOffset),ve.ce.getOffset(this.focusNode,this.focusOffset))},ve.ce.AnnotationFactory=function(){OO.Factory.call(this)},OO.inheritClass(ve.ce.AnnotationFactory,OO.Factory),ve.ce.AnnotationFactory.prototype.getDescription=function(a){var b=a.constructor.static.name;if(b in this.registry)return this.registry[b].static.getDescription(a);throw new Error("Unknown annotation type: "+b)},ve.ce.AnnotationFactory.prototype.isAnnotationContinuationForced=function(a){return a in this.registry?this.registry[a].static.forceContinuation:!1},ve.ce.annotationFactory=new ve.ce.AnnotationFactory,ve.ce.NodeFactory=function(){OO.Factory.call(this)},OO.inheritClass(ve.ce.NodeFactory,OO.Factory),ve.ce.NodeFactory.prototype.getDescription=function(a){var b=a.constructor.static.name;if(b in this.registry)return this.registry[b].static.getDescription(a);throw new Error("Unknown node type: "+b)},ve.ce.NodeFactory.prototype.splitNodeOnEnter=function(a){if(a in this.registry)return this.registry[a].static.splitOnEnter;throw new Error("Unknown node type: "+a)},ve.ce.NodeFactory.prototype.isNodeFocusable=function(a){if(a in this.registry)return this.registry[a].static.isFocusable;throw new Error("Unknown node type: "+a)},ve.ce.NodeFactory.prototype.getNodePrimaryCommandName=function(a){if(a in this.registry)return this.registry[a].static.primaryCommandName;throw new Error("Unknown node type: "+a)},ve.ce.nodeFactory=new ve.ce.NodeFactory,ve.ce.Document=function(a,b){ve.Document.call(this,new ve.ce.DocumentNode(a.getDocumentNode(),b,{$:b.$})),this.getDocumentNode().$element.attr({lang:a.getLang(),dir:a.getDir()}),this.model=a},OO.inheritClass(ve.ce.Document,ve.Document),ve.ce.Document.prototype.getNodeFromOffset=function(a){var b=this.getDocumentNode().getNodeFromOffset(a);return b&&!b.canHaveChildren()&&(b=b.getParent()),b},ve.ce.Document.prototype.getSlugAtOffset=function(a){var b=this.getNodeFromOffset(a);return b?b.getSlugAtOffset(a):null},ve.ce.Document.prototype.getSiblingWordBoundary=function(a,b){var c=new ve.dm.DataString(this.model.getData());return unicodeJS.wordbreak.moveBreakOffset(b,c,a,!0)},ve.ce.Document.prototype.getRelativeOffset=function(a,b,c){var d,e,f,g,h,i=this.model.data;return"word"===c?(f=this.getSiblingWordBoundary(a,b),a===f&&(f=this.getRelativeOffset(a,b,"character")),f):(g=a+(b>0?0:-1),i.isElementData(g)&&ve.ce.nodeFactory.isNodeFocusable(i.getType(g))?a+b:(d=i.getRelativeContentOffset(a,b),e=i.getRelativeStructuralOffset(a,b,!0),(0>e-a?-1:1)!==b?e=a:h=(0>e-a?-1:1)===b&&i.isElementData(e+b)&&ve.ce.nodeFactory.isNodeFocusable(i.getType(e+b)),h||this.getSlugAtOffset(e)?(h&&(e+=b),d===a||(0>d-a?-1:1)!==b?e:b>0?Math.min(d,e):Math.max(d,e)):b>0?Math.max(d,a):Math.min(d,a)))},ve.ce.Document.prototype.getNodeAndOffset=function(a){var b,c,d,e,f,g,h,i,j=[],k=this.getSlugAtOffset(a);if(k)return{node:k,offset:0};for(b=this.getNodeFromOffset(a),c=b.getOffset()+(b.isWrapped()?1:0),d=[b.$element.contents(),0],e=[d];e.length>0;)if(d[1]>=d[0].length)e.pop(),d=e[e.length-1];else{if(f=d[0][d[1]],f.nodeType===Node.TEXT_NODE){if(h=f.textContent.length,a>=c&&c+h>=a)return{node:f,offset:a-c};c+=h}else if(f.nodeType===Node.ELEMENT_NODE)if(g=d[0].eq(d[1]),g.hasClass("ve-ce-branchNode-slug")){if(a===c)return{node:g[0],offset:1}}else{if(!g.is(".ve-ce-branchNode, .ve-ce-leafNode")){e.push([g.contents(),0]),d[1]++,d=e[e.length-1];continue}if(i=g.data("view").model,-1===ve.indexOf(i,j)){if(h=i.getOuterLength(),j.push(i),a>=c&&c+h>a){e.push([g.contents(),0]),d[1]++,d=e[e.length-1];continue}c+=h}}d[1]++}throw new Error("Offset could not be translated to a DOM element and offset: "+a)},ve.ce.Document.prototype.getNearestFocusableNode=function(a,b,c){var d;return this.model.data.getRelativeOffset(a,1===b?0:-1,function(b,c){return b>=Math.max(a,c)||b<Math.min(a,c)?!0:this.isOpenElementData(b)&&ve.ce.nodeFactory.isNodeFocusable(this.getType(b))?(d=b+1,!0):this.isCloseElementData(b)&&ve.ce.nodeFactory.isNodeFocusable(this.getType(b))?(d=b,!0):void 0},c),d?this.getDocumentNode().getNodeFromOffset(d):null},ve.ce.Document.prototype.getRelativeRange=function(a,b,c,d){var e,f,g,h,i=a.to;if(!a.isCollapsed()&&!d){if(g=b>0?a.end:a.start,this.model.data.isContentOffset(g)||this.getSlugAtOffset(g))return new ve.Range(g);i=g}return e=this.getRelativeOffset(i,b,c),f=this.getNearestFocusableNode(i,b,e),h=f?f.getOuterRange(-1===b):new ve.Range(e),d?new ve.Range(a.from,h.to):h},ve.ce.Document.prototype.getDirectionFromRange=function(a){var b,c=this.selectNodes(a,"covered");if(c.length>1)b=this.selectNodes(a,"siblings")[0].node.getParent();else for(b=c[0].node;b.isContent();)b=b.parent;return b.$element.css("direction")},ve.ce.View=function(a,b){this.model=a,OO.ui.Element.call(this,b),OO.EventEmitter.call(this),this.live=!1,this.connect(this,{setup:"onSetup",teardown:"onTeardown"}),this.renderAttributes()},OO.inheritClass(ve.ce.View,OO.ui.Element),OO.mixinClass(ve.ce.View,OO.EventEmitter),ve.ce.View.static.renderHtmlAttributes=["abbr","about","align","alt","axis","bgcolor","border","cellpadding","cellspacing","char","charoff","cite","class","clear","color","colspan","datatype","datetime","dir","face","frame","headers","height","href","id","itemid","itemprop","itemref","itemscope","itemtype","lang","noshade","nowrap","property","rbspan","rel","resource","rev","rowspan","rules","scope","size","span","src","start","style","summary","title","type","typeof","valign","value","width"],ve.ce.View.prototype.getModelHtmlDocument=function(){return null},ve.ce.View.prototype.onSetup=function(){this.$element.data("view",this)},ve.ce.View.prototype.onTeardown=function(){this.$element.removeData("view")},ve.ce.View.prototype.getModel=function(){return this.model},ve.ce.View.prototype.isLive=function(){return this.live},ve.ce.View.prototype.setLive=function(a){this.live=a,this.emit(this.live?"setup":"teardown")},ve.ce.View.prototype.renderAttributes=function(a){ve.dm.Converter.renderHtmlAttributeList(a||this.model.getHtmlAttributes(),this.$element,this.constructor.static.renderHtmlAttributes,!0)},ve.ce.View.prototype.getResolvedAttribute=function(a){var b=this.model.getAttribute(a),c=this.getModelHtmlDocument();return c&&"string"==typeof b?ve.resolveUrl(b,c):b},ve.ce.Annotation=function(a,b,c){ve.ce.View.call(this,a,c),this.parentNode=b||null},OO.inheritClass(ve.ce.Annotation,ve.ce.View),ve.ce.Annotation.static.tagName="span",ve.ce.Annotation.static.forceContinuation=!1,ve.ce.Annotation.static.getDescription=function(){return""},ve.ce.Annotation.prototype.getParentNode=function(){return this.parentNode},ve.ce.Annotation.prototype.getModelHtmlDocument=function(){return this.parentNode&&this.parentNode.getModelHtmlDocument()},ve.ce.Node=function(a,b){ve.ce.View.call(this,a,b),ve.Node.call(this),this.parent=null},OO.inheritClass(ve.ce.Node,ve.ce.View),OO.mixinClass(ve.ce.Node,ve.Node),ve.ce.Node.static.splitOnEnter=!1,ve.ce.Node.static.isFocusable=!1,ve.ce.Node.static.primaryCommandName=null,ve.ce.Node.static.getDescription=function(){return""},ve.ce.Node.prototype.getChildNodeTypes=function(){return this.model.getChildNodeTypes()},ve.ce.Node.prototype.getParentNodeTypes=function(){return this.model.getParentNodeTypes()},ve.ce.Node.prototype.canHaveChildren=function(){return this.model.canHaveChildren()},ve.ce.Node.prototype.canHaveChildrenNotContent=function(){return this.model.canHaveChildrenNotContent()},ve.ce.Node.prototype.isWrapped=function(){return this.model.isWrapped()},ve.ce.Node.prototype.canContainContent=function(){return this.model.canContainContent()},ve.ce.Node.prototype.isContent=function(){return this.model.isContent()},ve.ce.Node.prototype.handlesOwnChildren=function(){return this.model.handlesOwnChildren()},ve.ce.Node.prototype.isFocusable=function(){return this.constructor.static.isFocusable},ve.ce.Node.prototype.canHaveSlugBefore=function(){return!this.canContainContent()&&null===this.getParentNodeTypes()&&"text"!==this.type&&"list"!==this.type},ve.ce.Node.prototype.canHaveSlugAfter=ve.ce.Node.prototype.canHaveSlugBefore,ve.ce.Node.prototype.getLength=function(){return this.model.getLength()},ve.ce.Node.prototype.getOuterLength=function(){return this.model.getOuterLength()},ve.ce.Node.prototype.getOffset=function(){return this.model.getOffset()},ve.ce.Node.prototype.splitOnEnter=function(){return this.constructor.static.splitOnEnter},ve.ce.Node.prototype.destroy=function(){this.parent=null,this.model.disconnect(this)},ve.ce.Node.prototype.getModelHtmlDocument=function(){return this.model.getDocument()&&this.model.getDocument().getHtmlDocument()},ve.ce.BranchNode=function(a,b){ve.BranchNode.call(this),ve.ce.Node.call(this,a,b),this.tagName=this.$element.get(0).nodeName.toLowerCase(),this.slugs={},this.model.connect(this,{splice:"onSplice"}),this.onSplice.apply(this,[0,0].concat(a.getChildren()))},OO.inheritClass(ve.ce.BranchNode,ve.ce.Node),OO.mixinClass(ve.ce.BranchNode,ve.BranchNode),ve.ce.BranchNode.$inlineSlugTemplate=$("<span>").addClass("ve-ce-branchNode-slug ve-ce-branchNode-inlineSlug").html("&#xFEFF;"),ve.ce.BranchNode.$blockSlugTemplate=$("<div>").addClass("ve-ce-branchNode-blockSlugWrapper ve-ce-branchNode-blockSlugWrapper-unfocused").append($("<p>").addClass("ve-ce-branchNode-slug ve-ce-branchNode-blockSlug").html("&#xFEFF;")),ve.ce.BranchNode.prototype.onSetup=function(){ve.ce.Node.prototype.onSetup.call(this),this.$element.addClass("ve-ce-branchNode")},ve.ce.BranchNode.prototype.onTeardown=function(){ve.ce.Node.prototype.onTeardown.call(this),this.$element.removeClass("ve-ce-branchNode")},ve.ce.BranchNode.prototype.updateTagName=function(){var a,b=this.getTagName();b!==this.tagName&&(this.emit("teardown"),a=this.$(this.$.context.createElement(b)),a.append(this.$element.contents()),this.$element.replaceWith(a),this.$element=a,this.emit("setup"),this.tagName=b)},ve.ce.BranchNode.prototype.onModelUpdate=function(a){this.emit("childUpdate",a)},ve.ce.BranchNode.prototype.onSplice=function(a){var b,c,d,e,f,g,h,i,j=Array.prototype.slice.call(arguments);if(j.length>=3)for(b=2,d=j.length;d>b;b++)j[b]=ve.ce.nodeFactory.create(j[b].getType(),j[b],{$:this.$}),j[b].model.connect(this,{update:"onModelUpdate"});for(i=this.children.splice.apply(this.children,j),b=0,d=i.length;d>b;b++)i[b].model.disconnect(this,{update:"onModelUpdate"}),i[b].setLive(!1),i[b].detach(),i[b].$element.detach();if(j.length>=3)for(a&&(e=this.children[a-1].$element.last()),b=j.length-1;b>=2;b--){if(j[b].attach(this),a)for(f=e[0].nextSibling,h=e[0].parentNode,c=0,d=j[b].$element.length;d>c;c++)h.insertBefore(j[b].$element[c],f);else for(g=this.$element[0],c=j[b].$element.length-1;c>=0;c--)g.insertBefore(j[b].$element[c],g.firstChild);this.live!==j[b].isLive()&&j[b].setLive(this.live)}this.setupSlugs()},ve.ce.BranchNode.prototype.setupSlugs=function(){function a(a){var b=a.getChildNodeTypes();return null===b||-1!==ve.indexOf("paragraph",b)}var b,c,d,e,f,g,h=this.canHaveChildrenNotContent(),i=this.getElementDocument();for(b in this.slugs)this.slugs[b].parentNode&&this.slugs[b].parentNode.removeChild(this.slugs[b]),delete this.slugs[b];if(h){if(!a(this))return;c=ve.ce.BranchNode.$blockSlugTemplate[0]}else c=ve.ce.BranchNode.$inlineSlugTemplate[0];if(0===this.$element.contents().length)this.slugs[0]=i.importNode(c,!0),this.$element[0].appendChild(this.slugs[0]);else for(d=0,e=this.children.length;e>d;d++)ve.dm.nodeFactory.isNodeInternal(this.children[d].model.type)||(0===d&&this.children[d].canHaveSlugBefore()&&(this.slugs[d]=i.importNode(c,!0),f=this.children[d].$element[0],f.parentNode.insertBefore(this.slugs[d],f)),this.children[d].canHaveSlugAfter()&&(d===this.children.length-1||this.children[d+1]&&this.children[d+1].canHaveSlugBefore())&&(this.slugs[d+1]=i.importNode(c,!0),g=this.children[d].$element[this.children[d].$element.length-1],g.parentNode.insertBefore(this.slugs[d+1],g.nextSibling)))},ve.ce.BranchNode.prototype.getSlugAtOffset=function(a){var b,c=this.model.getOffset()+(this.isWrapped()?1:0);if(a===c)return this.slugs[0]||null;for(b=0;b<this.children.length;b++)if(c+=this.children[b].model.getOuterLength(),a===c)return this.slugs[b+1]||null},ve.ce.BranchNode.prototype.setLive=function(a){ve.ce.Node.prototype.setLive.call(this,a);for(var b=0;b<this.children.length;b++)this.children[b].setLive(a)},ve.ce.BranchNode.prototype.destroy=function(){var a,b;for(a=0,b=this.children.length;b>a;a++)this.children[a].destroy();ve.ce.Node.prototype.destroy.call(this)},ve.ce.ContentBranchNode=function(a,b){ve.ce.BranchNode.call(this,a,b),this.lastTransaction=null,this.connect(this,{childUpdate:"onChildUpdate"})},OO.inheritClass(ve.ce.ContentBranchNode,ve.ce.BranchNode),ve.ce.ContentBranchNode.static.splitOnEnter=!0,ve.ce.ContentBranchNode.static.appendRenderedContents=function(a,b){function c(a){var b,d,e;for(b=0,d=a.childNodes.length;d>b;b++)e=a.childNodes[b],e.veOrigNode?a.replaceChild(e.veOrigNode,e):e.childNodes&&e.childNodes.length&&c(e)}for(c(b);b.firstChild;)a.appendChild(b.firstChild)},ve.ce.ContentBranchNode.prototype.onChildUpdate=function(a){return null===a||a===this.lastTransaction?void(this.lastTransaction=a):void this.renderContents()},ve.ce.ContentBranchNode.prototype.onSplice=function(){ve.ce.BranchNode.prototype.onSplice.apply(this,arguments),this.renderContents()},ve.ce.ContentBranchNode.prototype.getRenderedContents=function(){function a(a){""!==q&&(p.appendChild(n.createTextNode(q)),q=""),i=ve.ce.annotationFactory.create(a.getType(),a,r,{$:r.$}).$element[0],p.appendChild(i),p=i}function b(){""!==q&&(p.appendChild(n.createTextNode(q)),q=""),p=p.parentNode}var c,d,e,f,g,h,i,j,k=this.model.doc.getStore(),l=new ve.dm.AnnotationSet(k),m=[],n=this.getElementDocument(),o=n.createElement("div"),p=o,q="",r=this;for(c=0,d=this.children.length;d>c;c++)m=m.concat(this.children[c].getAnnotatedHtml());for(c=0,d=m.length;d>c;c++)if(ve.isArray(m[c])?(g=m[c][0],h=new ve.dm.AnnotationSet(k,m[c][1])):(g=m[c],h=new ve.dm.AnnotationSet(k)),ve.dm.Converter.openAndCloseAnnotations(l,h,a,b),"string"==typeof g)q+=g;else for(""!==q&&(p.appendChild(n.createTextNode(q)),q=""),e=0,f=g.length;f>e;e++)j=g[e].cloneNode(!0),j.veOrigNode=g[e],p.appendChild(j);return""!==q&&(p.appendChild(n.createTextNode(q)),q=""),o},ve.ce.ContentBranchNode.prototype.renderContents=function(){var a,b,c,d,e,f;if(!(this.root instanceof ve.ce.DocumentNode&&this.root.getSurface().isRenderingLocked())){for(this.root instanceof ve.ce.DocumentNode&&this.root.getSurface().setContentBranchNodeChanged(!0),d=this.getRenderedContents(),e=this.$element[0].cloneNode(!0),f=this.$element[0].cloneNode(!1);d.firstChild;)f.appendChild(d.firstChild);if(e.normalize(),f.normalize(),!f.isEqualNode(e)){for(a=0,b=this.$element.length;b>a;a++)for(c=this.$element[a];c.firstChild;)c.removeChild(c.firstChild);this.constructor.static.appendRenderedContents(this.$element[0],f),this.setupSlugs(),ve.debug&&(this.$element.css("backgroundColor","#eee"),setTimeout(ve.bind(function(){this.$element.css("backgroundColor","")},this),500))}}},ve.ce.LeafNode=function(a){ve.LeafNode.call(this),ve.ce.Node.apply(this,arguments),a.isWrapped()&&this.$element.addClass("ve-ce-leafNode")},OO.inheritClass(ve.ce.LeafNode,ve.ce.Node),OO.mixinClass(ve.ce.LeafNode,ve.LeafNode),ve.ce.LeafNode.static.tagName="span",ve.ce.LeafNode.prototype.onSetup=function(){ve.ce.Node.prototype.onSetup.call(this),this.$element.addClass("ve-ce-leafNode")},ve.ce.LeafNode.prototype.onTeardown=function(){ve.ce.Node.prototype.onTeardown.call(this),this.$element.removeClass("ve-ce-leafNode")},ve.ce.LeafNode.prototype.getAnnotatedHtml=function(){return[[this.$element,this.getModel().getAnnotations()]]},ve.ce.FocusableNode=function(a){this.focused=!1,this.highlighted=!1,this.isSetup=!1,this.$highlights=this.$("<div>").addClass("ve-ce-focusableNode-highlights"),this.$focusable=a||this.$element,this.surface=null,this.boundingRect=null,this.connect(this,{setup:"onFocusableSetup",teardown:"onFocusableTeardown",resizeStart:"onFocusableResizeStart",resizeEnd:"onFocusableResizeEnd",rerender:"onFocusableRerender"})},ve.ce.FocusableNode.static={},ve.ce.FocusableNode.static.isFocusable=!0,ve.ce.FocusableNode.prototype.createHighlight=function(){return this.$("<div>").addClass("ve-ce-focusableNode-highlight").attr("draggable",!1).append(this.$("<img>").addClass("ve-ce-focusableNode-highlight-relocatable-marker").attr("src","data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==").on({dragstart:ve.bind(this.onFocusableDragStart,this),dragend:ve.bind(this.onFocusableDragEnd,this)}))},ve.ce.FocusableNode.prototype.onFocusableSetup=function(){!this.isSetup&&this.root&&(this.surface=this.getRoot().getSurface(),this.$element.addClass("ve-ce-focusableNode").prop("contentEditable","false"),this.$focusable.on({"mouseenter.ve-ce-focusableNode":ve.bind(this.onFocusableMouseEnter,this),"mousedown.ve-ce-focusableNode touchend.ve-ce-focusableNode":ve.bind(this.onFocusableMouseDown,this)}),this.isSetup=!0)},ve.ce.FocusableNode.prototype.onFocusableTeardown=function(){this.isSetup&&this.root&&(this.$focusable.off(".ve-ce-focusableNode"),this.clearHighlights(),this.$element.removeClass("ve-ce-focusableNode").removeProp("contentEditable"),this.isSetup=!1,this.surface=null)},ve.ce.FocusableNode.prototype.onFocusableMouseDown=function(a){var b=this.surface.getModel(),c=b.getSelection(),d=this.model.getOuterRange();setTimeout(function(){b.getFragment(a.shiftKey?ve.Range.newCoveringRange([c,d],c.from>d.from):d).select()
})},ve.ce.FocusableNode.prototype.onFocusableDblClick=function(){this.executeCommand()},ve.ce.FocusableNode.prototype.executeCommand=function(){if(!this.model.isInspectable())return!1;var a=ve.ui.commandRegistry.getCommandForNode(this);a&&a.execute(this.surface.getSurface())},ve.ce.FocusableNode.prototype.onFocusableDragStart=function(){this.surface&&this.surface.startRelocation(this),this.$highlights.addClass("ve-ce-focusableNode-highlights-relocating")},ve.ce.FocusableNode.prototype.onFocusableDragEnd=function(){this.surface&&this.surface.endRelocation(),this.$highlights.removeClass("ve-ce-focusableNode-highlights-relocating")},ve.ce.FocusableNode.prototype.onFocusableMouseEnter=function(){this.root.getSurface().dragging||this.root.getSurface().resizing||this.createHighlights()},ve.ce.FocusableNode.prototype.onSurfaceMouseMove=function(a){var b=this.$(a.target);b.hasClass("ve-ce-focusableNode-highlight")||0!==b.closest(".ve-ce-focusableNode").length||this.clearHighlights()},ve.ce.FocusableNode.prototype.onSurfaceMouseOut=function(a){null===a.relatedTarget&&this.clearHighlights()},ve.ce.FocusableNode.prototype.onFocusableResizeStart=function(){this.clearHighlights()},ve.ce.FocusableNode.prototype.onFocusableResizeEnd=function(){this.redrawHighlights()},ve.ce.FocusableNode.prototype.onFocusableRerender=function(){this.focused&&(this.redrawHighlights(),this.surface.getSurface().getContext().updateDimensions(!0))},ve.ce.FocusableNode.prototype.isFocused=function(){return this.focused},ve.ce.FocusableNode.prototype.setFocused=function(a){a=!!a,this.focused!==a&&(this.focused=a,this.focused?(this.emit("focus"),this.$element.addClass("ve-ce-focusableNode-focused"),this.createHighlights(),this.surface.appendHighlights(this.$highlights,this.focused),this.surface.$element.off(".ve-ce-focusableNode")):(this.emit("blur"),this.$element.removeClass("ve-ce-focusableNode-focused"),this.clearHighlights()))},ve.ce.FocusableNode.prototype.createHighlights=function(){this.highlighted||(this.$highlights.on({mousedown:ve.bind(this.onFocusableMouseDown,this),dblclick:ve.bind(this.onFocusableDblClick,this)}),this.highlighted=!0,this.positionHighlights(),this.surface.appendHighlights(this.$highlights,this.focused),this.focused||this.surface.$element.on({"mousemove.ve-ce-focusableNode":ve.bind(this.onSurfaceMouseMove,this),"mouseout.ve-ce-focusableNode":ve.bind(this.onSurfaceMouseOut,this)}),this.surface.getModel().getDocument().connect(this,{transact:"positionHighlights"}),this.surface.connect(this,{position:"positionHighlights"}))},ve.ce.FocusableNode.prototype.clearHighlights=function(){this.highlighted&&(this.$highlights.remove().empty(),this.surface.$element.off(".ve-ce-focusableNode"),this.surface.getModel().getDocument().disconnect(this,{transact:"positionHighlights"}),this.surface.disconnect(this,{position:"positionHighlights"}),this.highlighted=!1,this.boundingRect=null)},ve.ce.FocusableNode.prototype.redrawHighlights=function(){this.clearHighlights(),this.createHighlights()},ve.ce.FocusableNode.prototype.positionHighlights=function(){function a(a,b){return b.left>=a.left&&b.top>=a.top&&b.right<=a.right&&b.bottom<=a.bottom}if(this.highlighted){var b,c,d,e,f,g,h=[],i=this.surface.getSurface().$element[0].getClientRects()[0];for(this.$highlights.empty(),this.$focusable.find("*").addBack().each(function(){var b,c,d,e,f,g;if(!$(this).hasClass("ve-ce-noHighlight"))for(g=this.getClientRects(),b=0,d=g.length;d>b;b++)if(!(g[b].width<=1||g[b].height<=1)){for(f=!1,c=0,e=h.length;e>c;c++){if(a(h[c],g[b])){f=!0;break}a(g[b],h[c])&&(h.splice(c,1),c--,e--)}f||h.push(g[b])}}),this.boundingRect={top:1/0,left:1/0,bottom:-1/0,right:-1/0},b=0,c=h.length;c>b;b++)d=h[b].top-i.top,e=h[b].left-i.left,f=h[b].bottom-i.top,g=h[b].right-i.left,this.$highlights.append(this.createHighlight().css({top:d,left:e,height:h[b].height,width:h[b].width})),this.boundingRect.top=Math.min(this.boundingRect.top,d),this.boundingRect.left=Math.min(this.boundingRect.left,e),this.boundingRect.bottom=Math.max(this.boundingRect.bottom,f),this.boundingRect.right=Math.max(this.boundingRect.right,g)}},ve.ce.FocusableNode.prototype.getRelativeOffset=function(){return this.highlighted||this.createHighlights(),{top:this.boundingRect.top,left:this.boundingRect.left}},ve.ce.FocusableNode.prototype.getDimensions=function(){return this.highlighted||this.createHighlights(),{width:this.boundingRect.right-this.boundingRect.left,height:this.boundingRect.bottom-this.boundingRect.top}},ve.ce.ResizableNode=function(a,b){b=b||{},this.$resizable=a||this.$element,this.resizing=!1,this.$resizeHandles=this.$("<div>"),this.snapToGrid=void 0!==b.snapToGrid?b.snapToGrid:10,this.outline=!!b.outline,this.showSizeLabel=b.showSizeLabel!==!1,this.showScaleLabel=b.showScaleLabel!==!1,this.canShowScaleLabel=!1,(this.showSizeLabel||this.showScaleLabel)&&(this.$sizeText=this.$("<span>").addClass("ve-ce-resizableNode-sizeText"),this.$sizeLabel=this.$("<div>").addClass("ve-ce-resizableNode-sizeLabel").append(this.$sizeText)),this.resizableOffset=null,this.connect(this,{focus:"onResizableFocus",blur:"onResizableBlur",teardown:"onResizableTeardown",resizing:"onResizableResizing",resizeEnd:"onResizableFocus",rerender:"onResizableFocus"}),this.$resizeHandles.addClass("ve-ce-resizableNode-handles").append(this.$("<div>").addClass("ve-ce-resizableNode-nwHandle").data("handle","nw")).append(this.$("<div>").addClass("ve-ce-resizableNode-neHandle").data("handle","ne")).append(this.$("<div>").addClass("ve-ce-resizableNode-seHandle").data("handle","se")).append(this.$("<div>").addClass("ve-ce-resizableNode-swHandle").data("handle","sw"))},ve.ce.ResizableNode.static={},ve.ce.ResizableNode.prototype.getResizableOffset=function(){return this.resizableOffset||(this.resizableOffset=OO.ui.Element.getRelativePosition(this.$resizable,this.getRoot().getSurface().getSurface().$element)),this.resizableOffset},ve.ce.ResizableNode.prototype.setOriginalDimensions=function(a){var b=this.model.getScalable();b.setOriginalDimensions(a),this.canShowScaleLabel=this.showScaleLabel&&b.getOriginalDimensions().width&&b.getOriginalDimensions().height},ve.ce.ResizableNode.prototype.hideSizeLabel=function(){var a=this;setTimeout(function(){a.$sizeLabel.removeClass("ve-ce-resizableNode-sizeLabel-resizing")}),setTimeout(function(){a.$sizeLabel.hide()},200)},ve.ce.ResizableNode.prototype.updateSizeLabel=function(){if(this.showSizeLabel||this.canShowScaleLabel){var a,b,c=this.model.getScalable(),d=c.getCurrentDimensions(),e=this.getResizableOffset(),f=(this.showSizeLabel?100:0)+(this.showScaleLabel?30:0);d.width<f?(a=e.top+d.height,b=30):(a=e.top,b=d.height),this.$sizeLabel.show().addClass("ve-ce-resizableNode-sizeLabel-resizing").css({top:a,left:e.left,width:d.width,height:b,lineHeight:b+"px"}),this.$sizeText.empty(),this.showSizeLabel&&this.$sizeText.append(this.$("<span>").addClass("ve-ce-resizableNode-sizeText-size").text(Math.round(d.width)+" × "+Math.round(d.height))),this.canShowScaleLabel&&this.$sizeText.append(this.$("<span>").addClass("ve-ce-resizableNode-sizeText-scale").text(Math.round(100*c.getCurrentScale())+"%")),this.$sizeText.toggleClass("ve-ce-resizableNode-sizeText-warning",c.isTooSmall()||c.isTooLarge())}},ve.ce.ResizableNode.prototype.showHandles=function(a){var b,c;if(void 0===a)this.$resizeHandles.find("div").show();else{for(this.$resizeHandles.find("div").hide(),b=a.length,c=[];b--;)c.push(".ve-ce-resizableNode-"+a[b]+"Handle");this.$resizeHandles.find(c.join(",")).show()}},ve.ce.ResizableNode.prototype.onResizableFocus=function(){var a=this.getRoot().getSurface(),b=a.getModel().getDocument();this.$sizeLabel&&this.$sizeLabel.appendTo(this.root.getSurface().getSurface().$controls),this.$resizeHandles.appendTo(this.root.getSurface().getSurface().$controls),this.model.getScalable(),this.setResizableHandlesSizeAndPosition(),this.$resizeHandles.find(".ve-ce-resizableNode-neHandle").css({marginRight:-this.$resizable.width()}).end().find(".ve-ce-resizableNode-swHandle").css({marginBottom:-this.$resizable.height()}).end().find(".ve-ce-resizableNode-seHandle").css({marginRight:-this.$resizable.width(),marginBottom:-this.$resizable.height()}),this.$resizeHandles.children().off(".ve-ce-resizableNode").on("mousedown.ve-ce-resizableNode",ve.bind(this.onResizeHandlesCornerMouseDown,this)),b.connect(this,{transact:"setResizableHandlesSizeAndPosition"}),a.connect(this,{position:"setResizableHandlesSizeAndPosition"})},ve.ce.ResizableNode.prototype.onResizableBlur=function(){if(this.getRoot()){var a=this.getRoot().getSurface(),b=a.getModel().getDocument();this.$resizeHandles.detach(),this.$sizeLabel&&this.$sizeLabel.detach(),b.disconnect(this,{transact:"setResizableHandlesSizeAndPosition"}),a.disconnect(this,{position:"setResizableHandlesSizeAndPosition"})}},ve.ce.ResizableNode.prototype.onResizableTeardown=function(){this.onResizableBlur()},ve.ce.ResizableNode.prototype.onResizableResizing=function(a){this.resizableOffset=null,this.model.getScalable().setCurrentDimensions(a),this.outline||(this.$resizable.css(this.model.getScalable().getCurrentDimensions()),this.setResizableHandlesPosition()),this.updateSizeLabel()},ve.ce.ResizableNode.prototype.onResizeHandlesCornerMouseDown=function(a){return this.root.getSurface().getSurface().getContext().toggle(!1),this.$resizeHandles.addClass("ve-ce-resizableNode-handles-resizing").css({width:this.$resizable.width(),height:this.$resizable.height()}),this.$resizeHandles.children().css("margin",0),this.resizeInfo={mouseX:a.screenX,mouseY:a.screenY,top:this.$resizeHandles.position().top,left:this.$resizeHandles.position().left,height:this.$resizeHandles.height(),width:this.$resizeHandles.width(),handle:$(a.target).data("handle")},this.resizing=!0,this.root.getSurface().resizing=!0,this.model.getScalable().setCurrentDimensions({width:this.resizeInfo.width,height:this.resizeInfo.height}),this.updateSizeLabel(),this.$(this.getElementDocument()).on({"mousemove.ve-ce-resizableNode":ve.bind(this.onDocumentMouseMove,this),"mouseup.ve-ce-resizableNode":ve.bind(this.onDocumentMouseUp,this)}),this.emit("resizeStart"),!1},ve.ce.ResizableNode.prototype.setResizableHandlesSizeAndPosition=function(){var a=this.$resizable.width(),b=this.$resizable.height();this.resizableOffset=null,this.setResizableHandlesPosition(),this.$resizeHandles.css({width:0,height:0}).find(".ve-ce-resizableNode-neHandle").css({marginRight:-a}).end().find(".ve-ce-resizableNode-swHandle").css({marginBottom:-b}).end().find(".ve-ce-resizableNode-seHandle").css({marginRight:-a,marginBottom:-b})},ve.ce.ResizableNode.prototype.setResizableHandlesPosition=function(){var a=this.getResizableOffset();this.$resizeHandles.css({top:a.top,left:a.left})},ve.ce.ResizableNode.prototype.onDocumentMouseMove=function(a){var b={},c={width:0,height:0,top:this.resizeInfo.top,left:this.resizeInfo.left};if(this.resizing){switch(this.resizeInfo.handle){case"se":b.x=a.screenX-this.resizeInfo.mouseX,b.y=a.screenY-this.resizeInfo.mouseY;break;case"nw":b.x=this.resizeInfo.mouseX-a.screenX,b.y=this.resizeInfo.mouseY-a.screenY;break;case"ne":b.x=a.screenX-this.resizeInfo.mouseX,b.y=this.resizeInfo.mouseY-a.screenY;break;case"sw":b.x=this.resizeInfo.mouseX-a.screenX,b.y=a.screenY-this.resizeInfo.mouseY}switch(c=this.model.getScalable().getBoundedDimensions({width:this.resizeInfo.width+b.x,height:this.resizeInfo.height+b.y},a.shiftKey&&this.snapToGrid),this.resizeInfo.handle){case"ne":c.top=this.resizeInfo.top+(this.resizeInfo.height-c.height);break;case"sw":c.left=this.resizeInfo.left+(this.resizeInfo.width-c.width);break;case"nw":c.top=this.resizeInfo.top+(this.resizeInfo.height-c.height),c.left=this.resizeInfo.left+(this.resizeInfo.width-c.width)}this.$resizeHandles.css(c),this.emit("resizing",{width:c.width,height:c.height})}},ve.ce.ResizableNode.prototype.onDocumentMouseUp=function(){var a,b=this.model.getOffset(),c=this.$resizeHandles.outerWidth(),d=this.$resizeHandles.outerHeight(),e=this.getRoot().getSurface().getModel(),f=e.getDocument(),g=e.getSelection();this.$resizeHandles.removeClass("ve-ce-resizableNode-handles-resizing"),this.$(this.getElementDocument()).off(".ve-ce-resizableNode"),this.resizing=!1,this.root.getSurface().resizing=!1,this.hideSizeLabel(),a=this.getAttributeChanges(c,d),ve.isEmptyObject(a)||e.change(ve.dm.Transaction.newFromAttributeChanges(f,b,a),g),this.root.getSurface().getSurface().getContext().updateDimensions(),this.emit("resizeEnd")},ve.ce.ResizableNode.prototype.getAttributeChanges=function(a,b){var c={};return this.model.getAttribute("width")!==a&&(c.width=a),this.model.getAttribute("height")!==b&&(c.height=b),c},ve.ce.Surface=function(a,b,c){var d;OO.ui.Element.call(this,c),OO.EventEmitter.call(this),this.surface=b,this.model=a,this.documentView=new ve.ce.Document(a.getDocument(),this),this.surfaceObserver=new ve.ce.SurfaceObserver(this.documentView),this.selectionTimeout=null,this.$window=this.$(OO.ui.Element.getWindow(this.$.context)),this.$document=this.$(this.getElementDocument()),this.eventSequencer=new ve.EventSequencer(["keydown","keypress","keyup","compositionstart","compositionend"]),this.clipboard=[],this.clipboardId=String(Math.random()),this.renderLocks=0,this.dragging=!1,this.relocating=!1,this.selecting=!1,this.resizing=!1,this.focused=!1,this.contentBranchNodeChanged=!1,this.$highlightsFocused=this.$("<div>"),this.$highlightsBlurred=this.$("<div>"),this.$highlights=this.$("<div>").append(this.$highlightsFocused,this.$highlightsBlurred),this.$dropMarker=this.$("<div>").addClass("ve-ce-focusableNode-dropMarker"),this.$lastDropTarget=null,this.lastDropPosition=null,this.$pasteTarget=this.$("<div>"),this.pasting=!1,this.pasteSpecial=!1,this.focusedNode=null,this.newModelSelection=null,this.surfaceObserver.connect(this,{contentChange:"onContentChange",selectionChange:"onSelectionChange"}),this.model.connect(this,{select:"onModelSelect",documentUpdate:"onModelDocumentUpdate"}),d=this.getDocument().getDocumentNode().$element,d.on({mousedown:ve.bind(this.onDocumentMouseDown,this),mouseup:ve.bind(this.onDocumentMouseUp,this),mousemove:ve.bind(this.onDocumentMouseMove,this),cut:ve.bind(this.onCut,this),copy:ve.bind(this.onCopy,this)}),this.onWindowResizeHandler=ve.bind(this.onWindowResize,this),this.$window.on("resize",this.onWindowResizeHandler),this.documentFocusChangeHandler=ve.bind(ve.debounce(this.onFocusChange),this),OO.ui.Element.onDOMEvent(this.getElementDocument(),"focusin",this.documentFocusChangeHandler),OO.ui.Element.onDOMEvent(this.getElementDocument(),"focusout",this.documentFocusChangeHandler),this.$document.on("mousedown",this.documentFocusChangeHandler),this.$pasteTarget.on({cut:ve.bind(this.onCut,this),copy:ve.bind(this.onCopy,this)}),d.on("paste",ve.bind(this.onPaste,this)).on("focus","a",function(){d[0].focus()}),this.$element.on({dragstart:ve.bind(this.onDocumentDragStart,this),dragover:ve.bind(this.onDocumentDragOver,this),drop:ve.bind(this.onDocumentDrop,this)}),this.eventSequencer.on({keydown:ve.bind(this.onDocumentKeyDown,this),keyup:ve.bind(this.onDocumentKeyUp,this),keypress:ve.bind(this.onDocumentKeyPress,this),compositionstart:ve.bind(this.onDocumentCompositionStart,this),compositionend:ve.bind(this.onDocumentCompositionEnd,this)}).after({keypress:ve.bind(this.afterDocumentKeyPress,this)}),this.$element.addClass("ve-ce-surface"),this.$highlights.addClass("ve-ce-surface-highlights"),this.$highlightsFocused.addClass("ve-ce-surface-highlights-focused"),this.$highlightsBlurred.addClass("ve-ce-surface-highlights-blurred"),this.$pasteTarget.addClass("ve-ce-surface-paste").attr("tabIndex",-1).prop("contentEditable","true"),this.$element.append(this.documentView.getDocumentNode().$element,this.$pasteTarget),this.surface.$blockers.append(this.$highlights)},OO.inheritClass(ve.ce.Surface,OO.ui.Element),OO.mixinClass(ve.ce.Surface,OO.EventEmitter),ve.ce.Surface.static.unsafeAttributes=["about","content","datatype","property","rel","resource","rev","typeof","style"],ve.ce.Surface.static.getClipboardHash=function(a){var b="";return a.each(function(){(this.nodeType===Node.TEXT_NODE||this.nodeType===Node.ELEMENT_NODE)&&(b+=this.textContent||"<"+this.nodeName+">")}),b.replace(/\s/gm,"")},ve.ce.Surface.prototype.destroy=function(){this.surfaceObserver.detach(),this.eventSequencer.detach(),this.documentView.getDocumentNode().setLive(!1),this.surfaceObserver.disconnect(this),this.model.disconnect(this),OO.ui.Element.offDOMEvent(this.getElementDocument(),"focusin",this.documentFocusChangeHandler),OO.ui.Element.offDOMEvent(this.getElementDocument(),"focusout",this.documentFocusChangeHandler),this.$document.off("mousedown",this.documentFocusChangeHandler),this.$window.off("resize",this.onWindowResizeHandler),this.$element.remove(),this.$highlights.remove()},ve.ce.Surface.prototype.getSelectionRect=function(){var a,b;if(this.focusedNode)return b=this.focusedNode.$element.offset(),{start:{x:b.left,y:b.top},end:{x:b.left+this.focusedNode.$element.width(),y:b.top+this.focusedNode.$element.height()}};if(rangy.initialized||rangy.init(),a=rangy.getSelection(this.getElementDocument()),0===a.rangeCount)return null;try{return{start:a.getStartDocumentPos(),end:a.getEndDocumentPos()}}catch(c){return null}},ve.ce.Surface.prototype.initialize=function(){rangy.initialized||rangy.init(),this.documentView.getDocumentNode().setLive(!0);try{this.$document[0].execCommand("enableObjectResizing",!1,!1),this.$document[0].execCommand("enableInlineTableEditing",!1,!1)}catch(a){}},ve.ce.Surface.prototype.enable=function(){this.documentView.getDocumentNode().enable()},ve.ce.Surface.prototype.disable=function(){this.documentView.getDocumentNode().disable()},ve.ce.Surface.prototype.focus=function(){this.focusedNode?this.$pasteTarget[0].focus():(this.documentView.getDocumentNode().$element[0].focus(),this.onModelSelect(this.surface.getModel().getSelection()),setTimeout(ve.bind(function(){this.isFocused()||this.getModel().selectFirstContentOffset()},this)))},ve.ce.Surface.prototype.onFocusChange=function(a){var b=!1;try{b=ve.contains([this.documentView.getDocumentNode().$element[0],this.$pasteTarget[0]],rangy.getSelection(this.getElementDocument()).anchorNode,!0)}catch(c){}b&&!this.isFocused()&&this.onDocumentFocus(a),!b&&this.isFocused()&&this.onDocumentBlur(a)},ve.ce.Surface.prototype.onDocumentFocus=function(){this.dragging||this.focusedNode||this.getModel().selectFirstContentOffset(),this.eventSequencer.attach(this.$element),this.surfaceObserver.startTimerLoop(),this.focused=!0,this.emit("focus")},ve.ce.Surface.prototype.onDocumentBlur=function(){this.eventSequencer.detach(),this.surfaceObserver.stopTimerLoop(),this.surfaceObserver.pollOnce(),this.surfaceObserver.clear(),this.focusedNode&&(this.focusedNode.setFocused(!1),this.focusedNode=null),this.dragging=!1,this.focused=!1,this.getModel().setSelection(null),this.emit("blur")},ve.ce.Surface.prototype.isFocused=function(){return this.focused},ve.ce.Surface.prototype.onDocumentMouseDown=function(a){var b,c;if(this.dragging=!0,1===a.which&&(this.surfaceObserver.stopTimerLoop(),this.surfaceObserver.pollOnce()),a.originalEvent.detail>=3&&!ve.init.platform.isInternetExplorer()){for(a.preventDefault(),b=this.model.getSelection(),c=this.documentView.getDocumentNode().getNodeFromOffset(b.start);null!==c.parent&&c.getModel().isContent();)c=c.parent;this.model.setSelection(c.getModel().getRange())}},ve.ce.Surface.prototype.onDocumentMouseUp=function(a){this.surfaceObserver.startTimerLoop(),this.surfaceObserver.pollOnce(),!a.shiftKey&&this.selecting&&(this.emit("selectionEnd"),this.selecting=!1),this.dragging=!1},ve.ce.Surface.prototype.onDocumentMouseMove=function(){this.dragging&&!this.selecting&&(this.selecting=!0,this.emit("selectionStart"))},ve.ce.Surface.prototype.onDocumentDragStart=function(a){a.originalEvent.dataTransfer.setData("application-x/VisualEditor",this.getModel().getSelection().toJSON())},ve.ce.Surface.prototype.onDocumentDragOver=function(a){if(this.relocating){var b,c,d,e;if(!this.relocating.getModel().isContent()){if(a.preventDefault(),b=$(a.target).closest(".ve-ce-branchNode, .ve-ce-leafNode"),b.length){for(d=b.data("view");null!==d.parent&&d.getModel().isContent();)d=d.parent;d.parent?(c=d.$element,e=a.originalEvent.pageY-c.offset().top>c.outerHeight()/2?"bottom":"top"):(c=this.$lastDropTarget,e=this.lastDropPosition)}!this.$lastDropTarget||this.$lastDropTarget.is(c)&&e===this.lastDropPosition||(this.$dropMarker.detach(),c=null),!c||c.is(this.$lastDropTarget)&&e===this.lastDropPosition||(this.$dropMarker.width(c.width()),"top"===e?this.$dropMarker.insertBefore(c):this.$dropMarker.insertAfter(c)),void 0!==c&&(this.$lastDropTarget=c,this.lastDropPosition=e)}this.selecting&&(this.emit("selectionEnd"),this.selecting=!1,this.dragging=!1)}},ve.ce.Surface.prototype.onDocumentDrop=function(a){var b=this.relocating,c=this.$lastDropTarget,d=this.lastDropPosition,e=a.originalEvent.dataTransfer.getData("application-x/VisualEditor");return setTimeout(ve.bind(function(){var f,g,h,i,j,k,l;if(b?f=b.getModel().getOuterRange():e&&(f=ve.Range.newFromJSON(e)),f&&!f.isCollapsed()){if(b&&!b.getModel().isContent()){if(!c)return;j=c.data("view").getModel().getOuterRange(),k="top"===d?j.start:j.end}else{if(g=rangy.positionFromPoint(a.originalEvent.pageX-this.$document.scrollLeft(),a.originalEvent.pageY-this.$document.scrollTop()),!g)return;k=ve.ce.getOffset(g.node,g.offset)}l=this.getModel().getFragment(new ve.Range(k),!1),h=this.getModel().getFragment(f,!1),i=h.getData(),h.removeContent(),l.insertContent(i),this.endRelocation()}},this)),!1},ve.ce.Surface.prototype.onDocumentKeyDown=function(a){var b,c,d=!1;if(229!==a.which){this.surfaceObserver.stopTimerLoop(),this.incRenderLock();try{this.surfaceObserver.pollOnce()}finally{this.decRenderLock()}switch(a.keyCode){case OO.ui.Keys.LEFT:case OO.ui.Keys.RIGHT:case OO.ui.Keys.UP:case OO.ui.Keys.DOWN:this.dragging||this.selecting||!a.shiftKey||(this.selecting=!0,this.emit("selectionStart")),a.keyCode===OO.ui.Keys.LEFT||a.keyCode===OO.ui.Keys.RIGHT?this.handleLeftOrRightArrowKey(a):(this.handleUpOrDownArrowKey(a),d=!0);break;case OO.ui.Keys.ENTER:a.preventDefault(),c=this.getFocusedNode(),c?c.executeCommand():(this.handleEnter(a),d=!0);break;case OO.ui.Keys.BACKSPACE:a.preventDefault(),this.handleDelete(a,!0),d=!0;break;case OO.ui.Keys.DELETE:a.preventDefault(),this.handleDelete(a,!1),d=!0;break;default:b=new ve.ui.Trigger(a),b.isComplete()&&this.surface.execute(b)&&(a.preventDefault(),d=!0)}d||this.incRenderLock();try{this.surfaceObserver.pollOnce()}finally{d||this.decRenderLock()}this.surfaceObserver.startTimerLoop()}},ve.ce.Surface.prototype.onDocumentKeyPress=function(a){var b,c,d=this.model.getDocument();ve.isMsie===!0&&(b=this.model.getSelection(),0!==b.start&&b.isCollapsed()&&(c=d.getDocumentNode().getNodeFromOffset(b.start-1),!this.documentView.getSlugAtOffset(b.start)&&c.isContent()&&d.data.isCloseElementData(b.start-1)&&this.model.setSelection(new ve.Range(b.start)))),0===a.which||0===a.charCode||a.keyCode===OO.ui.Keys.TAB||a.keyCode===OO.ui.Keys.ESCAPE||ve.ce.isShortcutKey(a)||this.handleInsertion()},ve.ce.Surface.prototype.afterDocumentKeyPress=function(){this.surfaceObserver.pollOnce()},ve.ce.Surface.prototype.onDocumentKeyUp=function(a){!this.dragging&&this.selecting&&a.keyCode===OO.ui.Keys.SHIFT&&(this.selecting=!1,this.emit("selectionEnd"))},ve.ce.Surface.prototype.onCut=function(a){this.surfaceObserver.stopTimerLoop(),this.onCopy(a),setTimeout(ve.bind(function(){var a,b;this.$document[0].execCommand("undo",!1,!1),a=this.model.getSelection(),b=ve.dm.Transaction.newFromRemoval(this.documentView.model,a),this.documentView.getDocumentNode().$element[0].focus(),this.model.change(b,new ve.Range(a.start)),this.surfaceObserver.clear(),this.surfaceObserver.startTimerLoop(),this.surfaceObserver.pollOnce()},this))},ve.ce.Surface.prototype.onCopy=function(a){var b,c,d,e,f,g,h,i,j=this,k=this.model.documentModel.cloneSliceFromRange(this.model.getSelection()),l=this.getModel().getDocument().getHtmlDocument(),m=a.originalEvent.clipboardData;this.$pasteTarget.empty(),g=k.data.clone(),k.data.cloneElements(),ve.dm.converter.getDomSubtreeFromModel(k,this.$pasteTarget[0],!0),this.$pasteTarget.find("span").addClass("ve-pasteProtect"),this.$pasteTarget.find("a").attr("href",function(a,b){return ve.resolveUrl(b,l)}),i="["+ve.ce.Surface.static.unsafeAttributes.join("],[")+"]",this.$pasteTarget.find(i).each(function(){var a,b,c={},d=ve.ce.Surface.static.unsafeAttributes;for(a=d.length;a--;)b=this.getAttribute(d[a]),null!==b&&(c[d[a]]=b);this.setAttribute("data-ve-attributes",JSON.stringify(c))}),f={slice:k,hash:null},e=this.clipboard.push(f)-1,m&&m.setData&&m.setData("text/xcustom","")&&m.setData("text/html","")?(a.preventDefault(),m.setData("text/xcustom",this.clipboardId+"-"+e),m.setData("text/html",this.$pasteTarget.html()),m.setData("text/plain",this.$pasteTarget.text())):(f.hash=this.constructor.static.getClipboardHash(this.$pasteTarget.contents()),this.$pasteTarget.prepend(this.$("<span>").attr("data-ve-clipboard-key",this.clipboardId+"-"+e)),b=rangy.createRange(this.getElementDocument()),b.setStart(this.$pasteTarget[0],0),b.setEnd(this.$pasteTarget[0],this.$pasteTarget[0].childNodes.length),h=this.$window.scrollTop(),c=rangy.getSelection(this.getElementDocument()),d=c.getRangeAt(0).cloneRange(),c.removeAllRanges(),this.$pasteTarget[0].focus(),c.addRange(b,!1),this.$window.scrollTop(h),setTimeout(function(){c=rangy.getSelection(j.getElementDocument()),c.removeAllRanges(),j.documentView.getDocumentNode().$element[0].focus(),c.addRange(d),j.$window.scrollTop(h)}))},ve.ce.Surface.prototype.onPaste=function(a){return this.pasting?!1:(this.pasting=!0,this.beforePaste(a),void setTimeout(ve.bind(function(){this.afterPaste(a),this.pasting=!1,this.pasteSpecial=!1,this.beforePasteData=null},this)))},ve.ce.Surface.prototype.beforePaste=function(a){var b,c,d,e,f,g,h,i,j,k,l,m=this.model.getSelection(),n=a.originalEvent.clipboardData,o=this.model.documentModel;this.beforePasteData={},n&&(this.beforePasteData.custom=n.getData("text/xcustom"),this.beforePasteData.html=n.getData("text/html")),this.surfaceObserver.stopTimerLoop(),rangy.getSelection(this.$document[0]).isCollapsed||(b=ve.dm.Transaction.newFromRemoval(o,m),m=b.translateRange(m),this.model.change(b,m),m=this.model.getSelection()),this.beforePasteData.scrollTop=this.$window.scrollTop(),this.$pasteTarget.empty(),c=o.getNodeFromOffset(m.start),c.canContainContent()?(k=l=0,d=c.getRange(),g=[c.getClonedElement()],m.start>d.start&&(h="☀",g.push(h),k=l=1),m.end<d.end&&(i="☂",g.push(i)),h||i||(g.push("☁"),l=1),g.push({type:"/"+g[0].type}),ve.dm.converter.getDomSubtreeFromModel(new ve.dm.Document(new ve.dm.ElementLinearData(o.getStore(),g),o.getHtmlDocument(),void 0,o.getInternalList(),o.getLang(),o.getDir()),this.$pasteTarget[0]),this.$pasteTarget[0].focus(),e=rangy.createRange(this.getElementDocument()),j=this.$pasteTarget.children().contents()[0],e.setStart(j,k),e.setEnd(j,l),f=rangy.getSelection(this.getElementDocument()),f.removeAllRanges(),f.addRange(e,!1),this.beforePasteData.context=g,this.beforePasteData.leftText=h,this.beforePasteData.rightText=i):this.$pasteTarget[0].focus(),this.$window.scrollTop(this.beforePasteData.scrollTop)},ve.ce.Surface.prototype.afterPaste=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q=this.getSurface().getPasteRules(),r=this.beforePasteData||{},s=this.model.getSelection();if(rangy.getSelection(this.getElementDocument()).isCollapsed){if(this.$pasteTarget.find("span").removeClass("ve-pasteProtect"),this.$pasteTarget.find("[style]").removeAttr("style"),this.$pasteTarget.find("[data-ve-attributes]").each(function(){var a;try{a=JSON.parse(this.getAttribute("data-ve-attributes"))}catch(b){return}$(this).attr(a),this.removeAttribute("data-ve-attributes")}),r.custom?a=r.custom:(d=r.html?this.$($.parseHTML(r.html)):this.$pasteTarget.contents(),d=d.filter(function(){var b=this.getAttribute&&this.getAttribute("data-ve-clipboard-key");return b?(a=b,!1):!0})),a&&(e=a.split("-"),b=e[0],c=e[1],b===this.clipboardId&&this.clipboard[c]&&(r.custom||this.clipboard[c].hash===this.constructor.static.getClipboardHash(d))&&(g=this.clipboard[c].slice)),g)try{f=new ve.dm.ElementLinearData(g.getStore(),ve.copy(g.getOriginalData())),(q.all||this.pasteSpecial)&&f.sanitize(q.all||{},this.pasteSpecial),ve.dm.Document.static.addAnnotationsToData(f.getData(),this.model.getInsertionAnnotations()),h=ve.dm.Transaction.newFromInsertion(this.documentView.model,s.start,f.getData())}catch(t){f=new ve.dm.ElementLinearData(g.getStore(),ve.copy(g.getBalancedData())),(q.all||this.pasteSpecial)&&f.sanitize(q.all||{},this.pasteSpecial),ve.dm.Document.static.addAnnotationsToData(f.getData(),this.model.getInsertionAnnotations()),h=ve.dm.Transaction.newFromInsertion(this.documentView.model,s.start,f.getData())}else{if(a&&r.html&&(d||(d=this.$($.parseHTML(r.html))),("useClipboardData-0"===a||d.filter("span[id],span[typeof],span[rel]").length>0&&0===this.$pasteTarget.filter("span[id],span[typeof],span[rel]").length)&&(l=ve.createDocumentFromHtml(r.html),$(l).find("span").removeClass("ve-pasteProtect"),r.context=null)),l||(l=ve.createDocumentFromHtml(this.$pasteTarget.html())),k=ve.dm.converter.getModelFromDom(l,this.getModel().getDocument().getHtmlDocument()),j=k.data,k.metadata=new ve.dm.MetaLinearData(k.getStore(),new Array(1+j.getLength())),a?(q.all||this.pasteSpecial)&&j.sanitize(q.all||{},this.pasteSpecial):(j.sanitize(q.external,this.pasteSpecial),q.all&&j.sanitize(q.all)),j.remapInternalListKeys(this.model.getDocument().getInternalList()),k.buildNodeTree(),r.context){for(i=k.getInternalList().getListNode().getOuterRange(),m=new ve.dm.ElementLinearData(k.getStore(),ve.copy(r.context)),this.pasteSpecial&&m.sanitize(q,this.pasteSpecial,!0),n=0;m.getLength()&&ve.dm.ElementLinearData.static.compareUnannotated(j.getData(n),j.isElementData(n)?m.getData(0):r.leftText);)n++,m.splice(0,1);for(o=i.start;m.getLength()&&ve.dm.ElementLinearData.static.compareUnannotated(j.getData(o-1),j.isElementData(o-1)?m.getData(m.getLength()-1):r.rightText);)o--,m.splice(m.getLength()-1,1);for(;"break"===j.getType(o-1);)o--;p=new ve.Range(n,o)}h=ve.dm.Transaction.newFromDocumentInsertion(this.documentView.model,s.start,k,p)}this.documentView.getDocumentNode().$element[0].focus(),this.$window.scrollTop(r.scrollTop),s=h.translateRange(s),this.model.change(h,new ve.Range(s.start)),this.model.setSelection(new ve.Range(s.end))}},ve.ce.Surface.prototype.onDocumentCompositionStart=function(){this.handleInsertion()},ve.ce.Surface.prototype.onDocumentCompositionEnd=function(){this.incRenderLock();try{this.surfaceObserver.pollOnce()}finally{this.decRenderLock()}this.surfaceObserver.startTimerLoop()},ve.ce.Surface.prototype.onModelSelect=function(a){var b,c,d,e,f=null,g=this.focusedNode;this.contentBranchNodeChanged=!1,a&&(a.isCollapsed()?(b=this.documentView.getDocumentNode().getNodeFromOffset(a.start),b.isFocusable()&&(f=b)):(b=this.documentView.getDocumentNode().getNodeFromOffset(a.start+1),b.isFocusable()&&(c=this.documentView.getDocumentNode().getNodeFromOffset(a.end-1),b===c&&(f=b))),g!==f&&(g&&(g.setFocused(!1),this.focusedNode=null),f&&(f.setFocused(!0),this.focusedNode=f)),f&&(d=rangy.getSelection(this.getElementDocument()),this.$pasteTarget.text(" "),e=rangy.createRange(this.getElementDocument()),e.setStart(this.$pasteTarget[0],0),e.setEnd(this.$pasteTarget[0],1),d.removeAllRanges(),this.$pasteTarget[0].focus(),d.addRange(e,!1),this.surfaceObserver.clear()),this.focusedNode||this.isRenderingLocked()||a===this.newModelSelection||this.showSelection(a),this.surfaceObserver.pollOnceNoEmit())},ve.ce.Surface.prototype.onModelDocumentUpdate=function(a,b){b||(this.contentBranchNodeChanged&&this.onModelSelect(this.surface.getModel().selection),this.surfaceObserver.pollOnceNoEmit())},ve.ce.Surface.prototype.onSelectionChange=function(a,b){if(!(a&&b&&b.flip().equals(a))){this.incRenderLock();try{this.changeModel(null,b)}finally{this.decRenderLock()}}},ve.ce.Surface.prototype.onContentChange=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w=0,x=0,y=a.getModel().getOffset();
if(b.range&&c.range){if(h=b.range.isCollapsed()&&c.range.isCollapsed()?c.range.start-b.range.start:null,i=c.text.length-b.text.length,k=b.range.start-y-1,l=c.range.start-y-1,j=null!==h&&(i>0&&b.text.substring(0,k)===c.text.substring(0,k)&&b.text.substring(k)===c.text.substring(l)||0>i&&b.text.substring(0,l)===c.text.substring(0,l)&&b.text.substring(k-i+h)===c.text.substring(l)),i>0&&h===i){d=ve.splitClusters(c.text).slice(b.range.start-y-1,c.range.start-y-1),g=this.model.getInsertionAnnotations(),g instanceof ve.dm.AnnotationSet&&ve.dm.Document.static.addAnnotationsToData(d,this.model.getInsertionAnnotations()),this.incRenderLock();try{this.changeModel(ve.dm.Transaction.newFromInsertion(this.documentView.model,b.range.start,d),c.range)}finally{this.decRenderLock()}return}if((0===h||h===i)&&j){e=0===h?new ve.Range(c.range.start,c.range.start-i):new ve.Range(c.range.start,b.range.start),this.incRenderLock();try{this.changeModel(ve.dm.Transaction.newFromRemoval(this.documentView.model,e),c.range)}finally{this.decRenderLock()}return}}for(n=ve.splitClusters(b.text),o=ve.splitClusters(c.text),f=Math.min(n.length,o.length);f>w&&n[w]===o[w];)++w;for(;f-w>x&&n[n.length-1-x]===o[o.length-1-x];)++x;if(d=o.slice(w,o.length-x),g=this.model.getDocument().data.getAnnotationsFromOffset(y+1+w),g.getLength()){for(u=this.model.getDocument().data.getAnnotationsFromOffset(y+w),v=this.model.getDocument().data.getAnnotationsFromOffset(y+1+n.length-x),p=0,q=g.getLength();q>p;p++)r=g.get(p),s=g.getIndex(p),r.constructor.static.splitOnWordbreak&&(t=new ve.dm.DataString(o),(!v.containsIndex(s)&&unicodeJS.wordbreak.isBreak(t,w)||!u.containsIndex(s)&&unicodeJS.wordbreak.isBreak(t,o.length-x))&&(g.removeAt(p),p--,q--));ve.dm.Document.static.addAnnotationsToData(d,g)}m=c.range,m.isCollapsed()&&(m=new ve.Range(this.getNearestCorrectOffset(m.start,1))),this.changeModel(ve.dm.Transaction.newFromReplacement(this.documentView.model,new ve.Range(y+1+w,y+1+n.length-x),d),m)},ve.ce.Surface.prototype.onWindowResize=ve.debounce(function(){this.emit("position")},50),ve.ce.Surface.prototype.startRelocation=function(a){this.relocating=a,this.emit("relocationStart",a)},ve.ce.Surface.prototype.endRelocation=function(){this.relocating&&(this.emit("relocationEnd",this.relocating),this.relocating=null,this.$lastDropTarget&&(this.$dropMarker.detach(),this.$lastDropTarget=null,this.lastDropPosition=null))},ve.ce.Surface.prototype.handleLeftOrRightArrowKey=function(a){var b,c,d;if(!a.metaKey){a.preventDefault(),this.surfaceObserver.stopTimerLoop(),this.incRenderLock();try{this.surfaceObserver.pollOnce()}finally{this.decRenderLock()}b=this.model.getSelection(),d="rtl"===this.$(a.target).css("direction")?a.keyCode===OO.ui.Keys.LEFT?1:-1:a.keyCode===OO.ui.Keys.LEFT?-1:1,c=this.getDocument().getRelativeRange(b,d,a.altKey===!0||a.ctrlKey===!0?"word":"character",a.shiftKey),this.model.setSelection(c),this.surfaceObserver.startTimerLoop(),this.surfaceObserver.pollOnce()}},ve.ce.Surface.prototype.handleUpOrDownArrowKey=function(a){var b,c,d,e,f,g=a.keyCode===OO.ui.Keys.DOWN?1:-1;this.surfaceObserver.stopTimerLoop(),this.surfaceObserver.pollOnce(),b=this.model.getSelection(),c=rangy.getSelection(this.$document[0]),this.focusedNode?(f=this.$('<span class="ve-ce-surface-cursorHolder"> </span>').hide(),-1===g?f.insertBefore(this.focusedNode.$element.first()):f.insertAfter(this.focusedNode.$element.last())):b.isCollapsed()||!b.isBackwards()||c.isBackwards()||(e=this.documentView.getSlugAtOffset(b.to),e||(f=this.$('<span class="ve-ce-surface-cursorHolder"> </span>').hide(),c.anchorNode.splitText(c.anchorOffset),c.anchorNode.parentNode.insertBefore(f[0],c.anchorNode.nextSibling))),(f||e)&&(d=rangy.createRange(this.$document[0]),d.selectNode(f?f[0]:e),c.setSingleRange(d)),setTimeout(ve.bind(function(){var d,e;f&&(f.remove(),this.surfaceObserver.clear()),c=rangy.getSelection(this.$document[0]),d=$(c.anchorNode).closest(".ve-ce-leafNode,.ve-ce-branchNode").data("view"),d.isFocusable()?e=1===g?d.getOuterRange():d.getOuterRange().flip():(this.surfaceObserver.pollOnce(),e=new ve.Range(this.model.getSelection().to)),a.shiftKey===!0&&(e=new ve.Range(b.from,e.to)),this.model.setSelection(e),this.surfaceObserver.pollOnce()},this))},ve.ce.Surface.prototype.handleInsertion=function(){if(!this.focusedNode){var a,b,c,d,e,f,g=!1,h=this.model.getSelection(),i=this.model.getDocument();h.isCollapsed()||(d=i.data.getAnnotationsFromRange(new ve.Range(h.start,h.start+1)),this.selectionInsideOneLeafNode(h)||(this.model.change(ve.dm.Transaction.newFromRemoval(this.documentView.model,h),new ve.Range(h.start)),g=!0,this.surfaceObserver.clear(),h=this.model.getSelection()),this.model.setInsertionAnnotations(d)),e=this.model.getInsertionAnnotations()||new ve.dm.AnnotationSet(i.getStore()),h.isCollapsed()&&(a=this.documentView.getSlugAtOffset(h.start),(a||this.needsPawn(h,e))&&(f="♙",e.isEmpty()||(f=[f,e.getIndexes()]),a&&i.data.isStructuralOffset(h.start)?(c=new ve.Range(h.start+1,h.start+2),b=[{type:"paragraph"},f,{type:"/paragraph"}]):(c=new ve.Range(h.start,h.start+1),b=[f]),this.model.change(ve.dm.Transaction.newFromInsertion(this.documentView.model,h.start,b),c),g=!0)),g&&(this.surfaceObserver.stopTimerLoop(),this.surfaceObserver.pollOnce())}},ve.ce.Surface.prototype.selectionInsideOneLeafNode=function(a){var b=this.documentView.selectNodes(a,"leaves");return 1===b.length},ve.ce.Surface.prototype.handleEnter=function(a){var b,c,d,e,f,g,h,i,j=this.model.getSelection(),k=this.model.getDocument(),l=[{type:"paragraph"},{type:"/paragraph"}],m=!0,n=j.from,o=[],p=null,q=null,r=null;if(j.from!==j.to&&(b=ve.dm.Transaction.newFromRemoval(k,j),j=b.translateRange(j),this.model.change(b,j)),i=this.documentView.getNodeFromOffset(j.from),null!==i&&(q=i.getModel(),r=q.getRange()),null===i)throw new Error("node === null");"paragraph"===q.getType()||n!==r.from&&n!==r.to?a.shiftKey&&q.hasSignificantWhitespace()?c=ve.dm.Transaction.newFromInsertion(k,j.from,"\n"):i.splitOnEnter()||(h=!1,this.hasSlugAtOffset(j.from)?h=!0:(g=this.documentView.model.data.getNearestContentOffset(n,-1),-1===g&&(h=!0)),h?c=ve.dm.Transaction.newFromInsertion(k,n,l):(n=g,i=this.documentView.getNodeFromOffset(n),c=void 0),h=void 0):n===r.from?(c=ve.dm.Transaction.newFromInsertion(k,q.getOuterRange().from,l),m=!1):n===r.to&&(c=ve.dm.Transaction.newFromInsertion(k,q.getOuterRange().to,l)),void 0===c&&(i.traverseUpstream(function(b){return b.splitOnEnter()?(o.splice(o.length/2,0,{type:"/"+b.type},b.getModel().getClonedElement()),p=b,a.shiftKey?!1:!0):!1}),d=p.getModel().getParent(),e=d.getChildren().length,"listItem"===p.type&&d.getChildren()[e-1]===p.getModel()&&1===p.children.length&&0===i.getModel().length?(f=p.getModel().getParent(),1===f.getChildren().length?c=ve.dm.Transaction.newFromRemoval(k,f.getOuterRange()):(c=ve.dm.Transaction.newFromRemoval(k,p.getModel().getOuterRange()),this.model.change(c),j=c.translateRange(j),c=ve.dm.Transaction.newFromInsertion(k,f.getOuterRange().to,l)),m=!1):c=ve.dm.Transaction.newFromInsertion(k,j.from,o)),this.model.change(c),j=c.translateRange(j),n=m?k.data.getRelativeContentOffset(j.from,1):k.data.getNearestContentOffset(j.from),-1===n?(this.model.change(ve.dm.Transaction.newFromInsertion(k,j.from,l)),this.model.setSelection(new ve.Range(j.from+1))):this.model.setSelection(new ve.Range(n)),this.surfaceObserver.clear()},ve.ce.Surface.prototype.handleDelete=function(a,b){var c,d,e,f,g,h,i,j,k=0,l=b?-1:1,m=this.getModel(),n=m.getDocument(),o=this.getDocument(),p=n.data,q=m.getSelection();if(q.isCollapsed()){if(q=o.getRelativeRange(q,l,a.altKey===!0||a.ctrlKey===!0?"word":"character",!0),k=q.start,e=p.getLength(),e>k){for(;e>k&&p.isCloseElementData(k);)k++;if(g=o.getDocumentNode().getNodeFromOffset(k+1),g.isFocusable())return void m.setSelection(g.getModel().getOuterRange())}if(q.isCollapsed())return}d=n.getInternalList().getListNode().getOuterRange(),0===q.start&&q.end>=d.start?(f=ve.dm.Transaction.newFromReplacement(n,new ve.Range(0,d.start),[{type:"paragraph"},{type:"/paragraph"}]),m.change(f),c=new ve.Range(1)):(f=ve.dm.Transaction.newFromRemoval(n,q),m.change(f),c=f.translateRange(q)),c.isCollapsed()||(h=o.getNodeFromOffset(c.end,!1),h.getModel().getRange().start>=c.end&&(g=o.getNodeFromOffset(c.start,!1),g.getModel().getRange().isCollapsed()?m.change([ve.dm.Transaction.newFromRemoval(n,g.getModel().getOuterRange())]):(i=n.getData(h.getModel().getRange()),j=h,j.traverseUpstream(function(a){var b=a.getParent();return 1===b.children.length?(j=b,!0):!1}),m.change([ve.dm.Transaction.newFromRemoval(n,j.getModel().getOuterRange()),ve.dm.Transaction.newFromInsertion(n,c.start,i)]))),c=new ve.Range(c.start)),n.data.isContentOffset(c.start)||(c=o.getRelativeRange(c,l)),m.setSelection(c),this.focus(),this.surfaceObserver.clear()},ve.ce.Surface.prototype.showSelection=function(a){var b=this.documentView.getDocumentNode().$element[0],c=this.getSelection(a),d=rangy.getSelection(this.$document[0]),e=rangy.createRange(this.$document[0]);c.end?(e.setStart(c.start.node,c.start.offset),e.setEnd(c.end.node,c.end.offset),d.removeAllRanges(),d.addRange(e,c.isBackwards)):(e.setStart(c.start.node,c.start.offset),d.setSingleRange(e)),this.getElementDocument().activeElement!==b&&b.focus()},ve.ce.Surface.prototype.getSelection=function(a){return a=new ve.Range(this.getNearestCorrectOffset(a.from,-1),this.getNearestCorrectOffset(a.to,1)),a.isCollapsed()?{start:this.documentView.getNodeAndOffset(a.start)}:{start:this.documentView.getNodeAndOffset(a.start),end:this.documentView.getNodeAndOffset(a.end),isBackwards:a.isBackwards()}},ve.ce.Surface.prototype.appendHighlights=function(a,b){this.$highlightsBlurred.children().detach(),b?this.$highlightsFocused.append(a):this.$highlightsBlurred.append(a)},ve.ce.Surface.prototype.getNearestCorrectOffset=function(a,b){var c,d,e=this.getModel().getDocument().data;return b=b>0?1:-1,e.isContentOffset(a)||this.hasSlugAtOffset(a)?a:(c=e.getNearestContentOffset(a,b),d=e.getNearestStructuralOffset(a,b,!0),this.hasSlugAtOffset(d)||-1===c?1===b?a>c?d:Math.min(c,d):c>a?d:Math.max(c,d):c)},ve.ce.Surface.prototype.hasSlugAtOffset=function(a){return!!this.documentView.getSlugAtOffset(a)},ve.ce.Surface.prototype.needsPawn=function(a,b){function c(a){return ve.ce.annotationFactory.isAnnotationContinuationForced(a.constructor.static.name)}var d,e,f=this.model.documentModel;return a.start>0&&(d=f.data.getAnnotationsFromOffset(a.start-1)),a.start<f.data.getLength()&&(e=f.data.getAnnotationsFromOffset(a.start+1)),d&&!d.compareTo(b)?!0:0===rangy.getSelection(this.$document[0]).anchorOffset&&e&&!e.compareTo(b)?!0:d&&e&&!d.filter(c).compareTo(e.filter(c))?!0:!1},ve.ce.Surface.prototype.getSurface=function(){return this.surface},ve.ce.Surface.prototype.getModel=function(){return this.model},ve.ce.Surface.prototype.getDocument=function(){return this.documentView},ve.ce.Surface.prototype.getFocusedNode=function(){return this.focusedNode},ve.ce.Surface.prototype.isRenderingLocked=function(){return this.renderLocks>0},ve.ce.Surface.prototype.incRenderLock=function(){this.renderLocks++},ve.ce.Surface.prototype.decRenderLock=function(){this.renderLocks--},ve.ce.Surface.prototype.changeModel=function(a,b){if(null!==this.newModelSelection)throw new Error("Nested change of newModelSelection");this.newModelSelection=b;try{this.model.change(a,b)}finally{this.newModelSelection=null}},ve.ce.Surface.prototype.setContentBranchNodeChanged=function(a){this.contentBranchNodeChanged=a},ve.ce.SurfaceObserver=function(a){OO.EventEmitter.call(this),this.documentView=a,this.domDocument=null,this.polling=!1,this.timeoutId=null,this.frequency=250,this.clear()},OO.mixinClass(ve.ce.SurfaceObserver,OO.EventEmitter),ve.ce.SurfaceObserver.prototype.clear=function(a){this.rangyRange=null,this.range=a||null,this.node=null,this.text=null,this.hash=null},ve.ce.SurfaceObserver.prototype.detach=function(){this.documentView=null,this.domDocument=null},ve.ce.SurfaceObserver.prototype.startTimerLoop=function(){this.domDocument=this.documentView.getDocumentNode().getElementDocument(),this.polling=!0,this.timerLoop(!0)},ve.ce.SurfaceObserver.prototype.timerLoop=function(a){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),a||this.pollOnce(),null!==this.frequency&&(this.timeoutId=setTimeout(ve.bind(this.timerLoop,this),this.frequency))},ve.ce.SurfaceObserver.prototype.stopTimerLoop=function(){this.polling===!0&&(this.polling=!1,clearTimeout(this.timeoutId),this.timeoutId=null)},ve.ce.SurfaceObserver.prototype.pollOnce=function(){this.pollOnceInternal(!0)},ve.ce.SurfaceObserver.prototype.pollOnceNoEmit=function(){this.pollOnceInternal(!1)},ve.ce.SurfaceObserver.prototype.pollOnceInternal=function(a){var b,c,d,e,f,g,h,i=this;this.domDocument&&(f=this.range,c=this.node,g=ve.ce.DomRange.newFromDomSelection(rangy.getSelection(this.domDocument)),g.equals(this.rangyRange)||(this.rangyRange=g,c=null,b=$(g.anchorNode).closest(".ve-ce-branchNode, .ve-ce-branchNode-slug"),b.length&&(f=g.getRange(),b.hasClass("ve-ce-branchNode-slug")?h=b.closest(".ve-ce-branchNode-blockSlugWrapper"):(c=b.data("view"),c&&c.root!==this.documentView.getDocumentNode()&&(c=null,f=null))),this.$slugWrapper&&!this.$slugWrapper.is(h)&&(this.$slugWrapper.addClass("ve-ce-branchNode-blockSlugWrapper-unfocused").removeClass("ve-ce-branchNode-blockSlugWrapper-focused"),this.$slugWrapper=null,setTimeout(function(){i.documentView&&i.documentView.documentNode.surface.emit("position")},200)),h&&!h.is(this.$slugWrapper)&&(this.$slugWrapper=h.addClass("ve-ce-branchNode-blockSlugWrapper-focused").removeClass("ve-ce-branchNode-blockSlugWrapper-unfocused"))),this.node!==c?null===c?(this.text=null,this.hash=null,this.node=null):(this.text=ve.ce.getDomText(c.$element[0]),this.hash=ve.ce.getDomHash(c.$element[0]),this.node=c):null!==c&&(d=ve.ce.getDomText(c.$element[0]),e=ve.ce.getDomHash(c.$element[0]),(this.text!==d||this.hash!==e)&&(a&&this.emit("contentChange",c,{text:this.text,hash:this.hash,range:this.range},{text:d,hash:e,range:f}),this.text=d,this.hash=e)),(this.range&&f?this.range.equals(f):this.range===f)||(a&&this.emit("selectionChange",this.range,f),this.range=f))},ve.ce.GeneratedContentNode=function(){this.generatingPromise=null,this.model.connect(this,{update:"onGeneratedContentNodeUpdate"}),this.connect(this,{teardown:"abortGenerating"}),this.update()},ve.ce.GeneratedContentNode.static={},ve.ce.GeneratedContentNode.static.renderHtmlAttributes=!1,ve.ce.GeneratedContentNode.prototype.generateContents=function(){throw new Error("ve.ce.GeneratedContentNode subclass must implement generateContents")},ve.ce.GeneratedContentNode.prototype.onGeneratedContentNodeUpdate=function(){this.update()},ve.ce.GeneratedContentNode.prototype.getRenderedDomElements=function(a){function b(){this.setAttribute(e,this[e])}var c,d,e,f,g=this.getElementDocument();if(f=this.$(a).not("link, meta, style"),f.find("link, meta, style").remove(),f.length)for(c=0,d=f.length;d>c;c++)f[c].nodeType===Node.TEXT_NODE&&(f[c]=this.$("<span>").append(f[c])[0]);else f=this.$("<span>");for(c=0,d=ve.dm.Converter.computedAttributes.length;d>c;c++)e=ve.dm.Converter.computedAttributes[c],f.find("["+e+"]").add(f.filter("["+e+"]")).each(b);return ve.copyDomElements(f.toArray(),g)},ve.ce.GeneratedContentNode.prototype.render=function(a){this.live&&this.emit("teardown");var b=this.$(this.getRenderedDomElements(ve.copyDomElements(a)));this.$element[0].parentNode?(this.$element.first().replaceWith(b),this.$element.remove(),this.$element=b):this.$element=b,this.$focusable&&(this.$focusable=this.getFocusableElement()),this.$resizable&&(this.$resizable=this.getResizableElement()),this.live&&(this.emit("setup"),this.afterRender())},ve.ce.GeneratedContentNode.prototype.afterRender=function(){this.emit("rerender")},ve.ce.GeneratedContentNode.prototype.update=function(a){var b=this.model.doc.getStore(),c=b.indexOfHash(OO.getHash([this.model,a]));null!==c?this.render(b.value(c)):this.forceUpdate(a)},ve.ce.GeneratedContentNode.prototype.forceUpdate=function(a){var b,c=this;this.generatingPromise?this.abortGenerating():this.startGenerating(),b=this.generatingPromise=this.generateContents(a),b.done(function(d){c.generatingPromise===b&&c.doneGenerating(d,a)}).fail(function(){c.generatingPromise===b&&c.failGenerating()})},ve.ce.GeneratedContentNode.prototype.startGenerating=function(){this.$element.addClass("ve-ce-generatedContentNode-generating")},ve.ce.GeneratedContentNode.prototype.abortGenerating=function(){var a=this.generatingPromise;a&&(this.generatingPromise=null,$.isFunction(a.abort)&&a.abort()),this.$element.removeClass("ve-ce-generatedContentNode-generating")},ve.ce.GeneratedContentNode.prototype.doneGenerating=function(a,b){var c,d;this.model.doc&&(c=this.model.doc.getStore(),d=OO.getHash([this.model,b]),c.index(a,d)),this.$element.removeClass("ve-ce-generatedContentNode-generating"),this.generatingPromise=null,this.render(a)},ve.ce.GeneratedContentNode.prototype.failGenerating=function(){this.$element.removeClass("ve-ce-generatedContentNode-generating"),this.generatingPromise=null},ve.ce.GeneratedContentNode.prototype.getFocusableElement=function(){return this.$element},ve.ce.GeneratedContentNode.prototype.getResizableElement=function(){return this.$element},ve.ce.AlienNode=function(){ve.ce.LeafNode.apply(this,arguments),ve.ce.FocusableNode.call(this),ve.ce.GeneratedContentNode.call(this),this.$highlights.addClass("ve-ce-alienNode-highlights")},OO.inheritClass(ve.ce.AlienNode,ve.ce.LeafNode),OO.mixinClass(ve.ce.AlienNode,ve.ce.FocusableNode),OO.mixinClass(ve.ce.AlienNode,ve.ce.GeneratedContentNode),ve.ce.AlienNode.static.name="alien",ve.ce.AlienNode.prototype.createHighlight=function(){return ve.ce.FocusableNode.prototype.createHighlight.call(this).addClass("ve-ce-alienNode-highlight").attr("title",ve.msg("visualeditor-aliennode-tooltip"))},ve.ce.AlienNode.prototype.generateContents=function(a){var b=$.Deferred();return b.resolve(a&&a.domElements||this.model.getAttribute("domElements")||[]),b.promise()},ve.ce.AlienBlockNode=function(){ve.ce.AlienNode.apply(this,arguments)},OO.inheritClass(ve.ce.AlienBlockNode,ve.ce.AlienNode),ve.ce.AlienBlockNode.static.name="alienBlock",ve.ce.AlienInlineNode=function(){ve.ce.AlienNode.apply(this,arguments)},OO.inheritClass(ve.ce.AlienInlineNode,ve.ce.AlienNode),ve.ce.AlienInlineNode.static.name="alienInline",ve.ce.nodeFactory.register(ve.ce.AlienNode),ve.ce.nodeFactory.register(ve.ce.AlienBlockNode),ve.ce.nodeFactory.register(ve.ce.AlienInlineNode),ve.ce.BreakNode=function(a,b){ve.ce.LeafNode.call(this,a,b),this.$element.addClass("ve-ce-BreakNode")},OO.inheritClass(ve.ce.BreakNode,ve.ce.LeafNode),ve.ce.BreakNode.static.name="break",ve.ce.BreakNode.static.tagName="br",ve.ce.nodeFactory.register(ve.ce.BreakNode),ve.ce.CenterNode=function(a,b){ve.ce.BranchNode.call(this,a,b)},OO.inheritClass(ve.ce.CenterNode,ve.ce.BranchNode),ve.ce.CenterNode.static.name="center",ve.ce.CenterNode.static.tagName="center",ve.ce.nodeFactory.register(ve.ce.CenterNode),ve.ce.CommentNode=function(a,b){ve.ce.LeafNode.call(this,a,b),this.$element.addClass("ve-ce-commentNode").text(" "),ve.ce.FocusableNode.call(this,this.$element,b),OO.ui.IndicatedElement.call(this,this.$element,{$:this.$,indicator:"alert"})},OO.inheritClass(ve.ce.CommentNode,ve.ce.LeafNode),OO.mixinClass(ve.ce.CommentNode,ve.ce.FocusableNode),OO.mixinClass(ve.ce.CommentNode,OO.ui.IndicatedElement),ve.ce.CommentNode.static.name="comment",ve.ce.CommentNode.static.primaryCommandName="comment",ve.ce.CommentNode.static.getDescription=function(a){return a.getAttribute("text")},ve.ce.nodeFactory.register(ve.ce.CommentNode),ve.ce.DefinitionListItemNode=function(a,b){ve.ce.BranchNode.call(this,a,b),this.model.connect(this,{update:"onUpdate"})},OO.inheritClass(ve.ce.DefinitionListItemNode,ve.ce.BranchNode),ve.ce.DefinitionListItemNode.static.name="definitionListItem",ve.ce.DefinitionListItemNode.static.splitOnEnter=!0,ve.ce.DefinitionListItemNode.prototype.getTagName=function(){var a=this.model.getAttribute("style"),b={definition:"dd",term:"dt"};if(!(a in b))throw new Error("Invalid style");return b[a]},ve.ce.DefinitionListItemNode.prototype.onUpdate=function(){this.updateTagName()},ve.ce.nodeFactory.register(ve.ce.DefinitionListItemNode),ve.ce.DefinitionListNode=function(a,b){ve.ce.BranchNode.call(this,a,b)},OO.inheritClass(ve.ce.DefinitionListNode,ve.ce.BranchNode),ve.ce.DefinitionListNode.static.name="definitionList",ve.ce.DefinitionListNode.static.tagName="dl",ve.ce.nodeFactory.register(ve.ce.DefinitionListNode),ve.ce.DivNode=function(a,b){ve.ce.BranchNode.call(this,a,b)},OO.inheritClass(ve.ce.DivNode,ve.ce.BranchNode),ve.ce.DivNode.static.name="div",ve.ce.nodeFactory.register(ve.ce.DivNode),ve.ce.DocumentNode=function(a,b,c){ve.ce.BranchNode.call(this,a,c),this.surface=b,this.setRoot(this),this.$element.addClass("ve-ce-documentNode"),this.$element.prop({contentEditable:"true",spellcheck:!0})},OO.inheritClass(ve.ce.DocumentNode,ve.ce.BranchNode),ve.ce.DocumentNode.static.name="document",ve.ce.DocumentNode.prototype.getOuterLength=function(){return this.length},ve.ce.DocumentNode.prototype.getSurface=function(){return this.surface},ve.ce.DocumentNode.prototype.disable=function(){this.$element.prop("contentEditable","false")},ve.ce.DocumentNode.prototype.enable=function(){this.$element.prop("contentEditable","true")},ve.ce.nodeFactory.register(ve.ce.DocumentNode),ve.ce.HeadingNode=function(a,b){ve.ce.ContentBranchNode.call(this,a,b),this.model.connect(this,{update:"onUpdate"})},OO.inheritClass(ve.ce.HeadingNode,ve.ce.ContentBranchNode),ve.ce.HeadingNode.static.name="heading",ve.ce.HeadingNode.prototype.getTagName=function(){var a=this.model.getAttribute("level"),b={1:"h1",2:"h2",3:"h3",4:"h4",5:"h5",6:"h6"};if(!(a in b))throw new Error("Invalid level");return b[a]},ve.ce.HeadingNode.prototype.onUpdate=function(){this.updateTagName()},ve.ce.nodeFactory.register(ve.ce.HeadingNode),ve.ce.ImageNode=function(a,b){b=ve.extendObject({minDimensions:{width:1,height:1}},b),ve.ce.LeafNode.call(this,a,b),this.$image=this.$("<img>").appendTo(this.$element),ve.ce.FocusableNode.call(this),ve.ce.ResizableNode.call(this,this.$image,b),this.$element.on("click",ve.bind(this.onClick,this)),this.$image.on("load",ve.bind(this.onLoad,this)),this.model.connect(this,{attributeChange:"onAttributeChange"}),this.$element.addClass("ve-ce-imageNode"),this.$image.attr({alt:this.model.getAttribute("alt"),src:this.getResolvedAttribute("src")}).css({width:this.model.getAttribute("width"),height:this.model.getAttribute("height")})},OO.inheritClass(ve.ce.ImageNode,ve.ce.LeafNode),OO.mixinClass(ve.ce.ImageNode,ve.ce.FocusableNode),OO.mixinClass(ve.ce.ImageNode,ve.ce.ResizableNode),ve.ce.ImageNode.static.name="image",ve.ce.ImageNode.static.tagName="span",ve.ce.ImageNode.prototype.onAttributeChange=function(a,b,c){"src"===a&&this.$image.attr("src",this.getResolvedAttribute("src")),("width"===a||"height"===a)&&this.$image.css(a,c)},ve.ce.ImageNode.prototype.onClick=function(a){var b=this.getRoot().getSurface().getModel(),c=b.getSelection(),d=this.model.getOuterRange();b.getFragment(a.shiftKey?ve.Range.newCoveringRange([c,d],c.from>d.from):d).select()},ve.ce.ImageNode.prototype.onLoad=function(){this.setOriginalDimensions({width:this.$image.prop("naturalWidth"),height:this.$image.prop("naturalHeight")})},ve.ce.nodeFactory.register(ve.ce.ImageNode),ve.ce.InternalItemNode=function(a,b){ve.ce.BranchNode.call(this,a,b),this.$element.addClass("ve-ce-internalItemNode")},OO.inheritClass(ve.ce.InternalItemNode,ve.ce.BranchNode),ve.ce.InternalItemNode.static.name="internalItem",ve.ce.InternalItemNode.static.tagName="span",ve.ce.nodeFactory.register(ve.ce.InternalItemNode),ve.ce.InternalListNode=function(a,b){ve.ce.BranchNode.call(this,a,b),this.$element=this.$([])},OO.inheritClass(ve.ce.InternalListNode,ve.ce.BranchNode),ve.ce.InternalListNode.static.name="internalList",ve.ce.InternalListNode.prototype.onSplice=function(){},ve.ce.nodeFactory.register(ve.ce.InternalListNode),ve.ce.ListItemNode=function(a,b){ve.ce.BranchNode.call(this,a,b)},OO.inheritClass(ve.ce.ListItemNode,ve.ce.BranchNode),ve.ce.ListItemNode.static.name="listItem",ve.ce.ListItemNode.static.tagName="li",ve.ce.ListItemNode.static.splitOnEnter=!0,ve.ce.nodeFactory.register(ve.ce.ListItemNode),ve.ce.ListNode=function(a,b){ve.ce.BranchNode.call(this,a,b),this.model.connect(this,{update:"onUpdate"})},OO.inheritClass(ve.ce.ListNode,ve.ce.BranchNode),ve.ce.ListNode.static.name="list",ve.ce.ListNode.prototype.getTagName=function(){var a=this.model.getAttribute("style"),b={bullet:"ul",number:"ol"};if(!(a in b))throw new Error("Invalid style");return b[a]},ve.ce.ListNode.prototype.onUpdate=function(){this.updateTagName()},ve.ce.ListNode.prototype.canHaveSlugAfter=function(){return"listItem"===this.getParent().getType()?!1:ve.ce.BranchNode.prototype.canHaveSlugAfter.call(this)},ve.ce.nodeFactory.register(ve.ce.ListNode),ve.ce.ParagraphNode=function(a,b){ve.ce.ContentBranchNode.call(this,a,b),this.$element.addClass("ve-ce-paragraphNode"),this.model.getElement().internal&&"wrapper"===this.model.getElement().internal.generated&&this.$element.addClass("ve-ce-generated-wrapper")},OO.inheritClass(ve.ce.ParagraphNode,ve.ce.ContentBranchNode),ve.ce.ParagraphNode.static.name="paragraph",ve.ce.ParagraphNode.static.tagName="p",ve.ce.nodeFactory.register(ve.ce.ParagraphNode),ve.ce.PreformattedNode=function(a,b){ve.ce.ContentBranchNode.call(this,a,b)},OO.inheritClass(ve.ce.PreformattedNode,ve.ce.ContentBranchNode),ve.ce.PreformattedNode.static.name="preformatted",ve.ce.PreformattedNode.static.tagName="pre",ve.ce.nodeFactory.register(ve.ce.PreformattedNode),ve.ce.TableCaptionNode=function(a,b){ve.ce.BranchNode.call(this,a,b)},OO.inheritClass(ve.ce.TableCaptionNode,ve.ce.BranchNode),ve.ce.TableCaptionNode.static.name="tableCaption",ve.ce.TableCaptionNode.static.tagName="caption",ve.ce.nodeFactory.register(ve.ce.TableCaptionNode),ve.ce.TableCellNode=function(a,b){ve.ce.BranchNode.call(this,a,b),this.model.connect(this,{update:"onUpdate"}),this.$element.addClass("ve-ce-tableCellNode")},OO.inheritClass(ve.ce.TableCellNode,ve.ce.BranchNode),ve.ce.TableCellNode.static.name="tableCell",ve.ce.TableCellNode.prototype.getTagName=function(){var a=this.model.getAttribute("style"),b={data:"td",header:"th"};if(!(a in b))throw new Error("Invalid style");return b[a]},ve.ce.TableCellNode.prototype.onUpdate=function(){this.updateTagName()},ve.ce.nodeFactory.register(ve.ce.TableCellNode),ve.ce.TableNode=function(a,b){ve.ce.BranchNode.call(this,a,b),this.$element.addClass("ve-ce-tableNode")},OO.inheritClass(ve.ce.TableNode,ve.ce.BranchNode),ve.ce.TableNode.static.name="table",ve.ce.TableNode.static.tagName="table",ve.ce.nodeFactory.register(ve.ce.TableNode),ve.ce.TableRowNode=function(a,b){ve.ce.BranchNode.call(this,a,b)},OO.inheritClass(ve.ce.TableRowNode,ve.ce.BranchNode),ve.ce.TableRowNode.static.name="tableRow",ve.ce.TableRowNode.static.tagName="tr",ve.ce.nodeFactory.register(ve.ce.TableRowNode),ve.ce.TableSectionNode=function(a,b){ve.ce.BranchNode.call(this,a,b),this.model.connect(this,{update:"onUpdate"})},OO.inheritClass(ve.ce.TableSectionNode,ve.ce.BranchNode),ve.ce.TableSectionNode.static.name="tableSection",ve.ce.TableSectionNode.prototype.getTagName=function(){var a=this.model.getAttribute("style"),b={header:"thead",body:"tbody",footer:"tfoot"};if(!(a in b))throw new Error("Invalid style");return b[a]},ve.ce.TableSectionNode.prototype.onUpdate=function(){this.updateTagName()},ve.ce.nodeFactory.register(ve.ce.TableSectionNode),ve.ce.TextNode=function(a,b){ve.ce.LeafNode.call(this,a,b)},OO.inheritClass(ve.ce.TextNode,ve.ce.LeafNode),ve.ce.TextNode.static.name="text",ve.ce.TextNode.static.splitOnEnter=!0,ve.ce.TextNode.whitespaceHtmlCharacters={"\n":"↵","	":"➞"},ve.ce.TextNode.prototype.getAnnotatedHtml=function(){function a(a,b,c){ve.isArray(c[b])?(c[b]=c[b].slice(0),c[b][0]=a):c[b]=a}function b(a,b){return ve.isArray(b[a])?b[a][0]:b[a]}var c,d,e=this.model.getDocument().getDataFromNode(this.model),f=ve.ce.TextNode.whitespaceHtmlCharacters,g=this.getModel().getParent().hasSignificantWhitespace();if(!g)for(e.length>0&&" "===b(0,e)&&a(" ",0,e),e.length>1&&" "===b(e.length-1,e)&&a(" ",e.length-1,e),c=0;c<e.length;c++)d=b(c,e)," "===d&&" "===b(c+1,e)&&a(" ",c+1,e),d in f&&a(f[d],c,e);return e},ve.ce.nodeFactory.register(ve.ce.TextNode),ve.ce.LanguageAnnotation=function(a,b,c){var d=a.getAttribute("lang"),e=a.getAttribute("dir");ve.ce.Annotation.call(this,a,b,c),this.$element.addClass("ve-ce-LanguageAnnotation").addClass("ve-ce-bidi-isolate").attr({lang:d,dir:e,title:this.constructor.static.getDescription(this.model)})},OO.inheritClass(ve.ce.LanguageAnnotation,ve.ce.Annotation),ve.ce.LanguageAnnotation.static.name="meta/language",ve.ce.LanguageAnnotation.static.tagName="span",ve.ce.LanguageAnnotation.static.getDescription=function(a){var b=a.getAttribute("lang").toLowerCase(),c=ve.init.platform.getLanguageName(b),d=(a.getAttribute("dir")||"").toUpperCase();return d&&d!==ve.init.platform.getLanguageDirection(b).toUpperCase()?ve.msg("visualeditor-languageannotation-description-with-dir",c,d):ve.msg("visualeditor-languageannotation-description",c)},ve.ce.annotationFactory.register(ve.ce.LanguageAnnotation),ve.ce.LinkAnnotation=function(a,b,c){ve.ce.Annotation.call(this,a,b,c),this.$element.addClass("ve-ce-LinkAnnotation").attr("href",ve.resolveUrl(this.model.getHref(),this.getModelHtmlDocument())).attr("title",this.constructor.static.getDescription(this.model)).on("click",function(a){a.altKey||a.ctrlKey||a.metaKey||a.shiftKey||a.preventDefault()})},OO.inheritClass(ve.ce.LinkAnnotation,ve.ce.Annotation),ve.ce.LinkAnnotation.static.name="link",ve.ce.LinkAnnotation.static.tagName="a",ve.ce.LinkAnnotation.static.forceContinuation=!0,ve.ce.LinkAnnotation.static.getDescription=function(a){return a.getHref()},ve.ce.annotationFactory.register(ve.ce.LinkAnnotation),ve.ce.TextStyleAnnotation=function(a,b,c){ve.ce.Annotation.call(this,a,b,c),this.$element.addClass("ve-ce-TextStyleAnnotation")},OO.inheritClass(ve.ce.TextStyleAnnotation,ve.ce.Annotation),ve.ce.TextStyleAnnotation.static.name="textStyle",ve.ce.TextStyleAnnotation.prototype.getTagName=function(){return this.getModel().getAttribute("nodeName")||this.constructor.static.tagName},ve.ce.annotationFactory.register(ve.ce.TextStyleAnnotation),ve.ce.AbbreviationAnnotation=function(a,b,c){ve.ce.TextStyleAnnotation.call(this,a,b,c),this.$element.addClass("ve-ce-AbbreviationAnnotation")},OO.inheritClass(ve.ce.AbbreviationAnnotation,ve.ce.TextStyleAnnotation),ve.ce.AbbreviationAnnotation.static.name="textStyle/abbreviation",ve.ce.AbbreviationAnnotation.static.tagName="abbr",ve.ce.annotationFactory.register(ve.ce.AbbreviationAnnotation),ve.ce.BigAnnotation=function(a,b,c){ve.ce.TextStyleAnnotation.call(this,a,b,c),this.$element.addClass("ve-ce-BigAnnotation")},OO.inheritClass(ve.ce.BigAnnotation,ve.ce.TextStyleAnnotation),ve.ce.BigAnnotation.static.name="textStyle/big",ve.ce.BigAnnotation.static.tagName="big",ve.ce.annotationFactory.register(ve.ce.BigAnnotation),ve.ce.BoldAnnotation=function(a,b,c){ve.ce.TextStyleAnnotation.call(this,a,b,c),this.$element.addClass("ve-ce-BoldAnnotation")},OO.inheritClass(ve.ce.BoldAnnotation,ve.ce.TextStyleAnnotation),ve.ce.BoldAnnotation.static.name="textStyle/bold",ve.ce.BoldAnnotation.static.tagName="b",ve.ce.annotationFactory.register(ve.ce.BoldAnnotation),ve.ce.CodeAnnotation=function(a,b,c){ve.ce.TextStyleAnnotation.call(this,a,b,c),this.$element.addClass("ve-ce-CodeAnnotation")},OO.inheritClass(ve.ce.CodeAnnotation,ve.ce.TextStyleAnnotation),ve.ce.CodeAnnotation.static.name="textStyle/code",ve.ce.CodeAnnotation.static.tagName="code",ve.ce.annotationFactory.register(ve.ce.CodeAnnotation),ve.ce.CodeSampleAnnotation=function(a,b,c){ve.ce.TextStyleAnnotation.call(this,a,b,c),this.$element.addClass("ve-ce-CodeSampleAnnotation")},OO.inheritClass(ve.ce.CodeSampleAnnotation,ve.ce.TextStyleAnnotation),ve.ce.CodeSampleAnnotation.static.name="textStyle/codeSample",ve.ce.CodeSampleAnnotation.static.tagName="samp",ve.ce.annotationFactory.register(ve.ce.CodeSampleAnnotation),ve.ce.DatetimeAnnotation=function(a,b,c){ve.ce.TextStyleAnnotation.call(this,a,b,c),this.$element.addClass("ve-ce-DatetimeAnnotation")
},OO.inheritClass(ve.ce.DatetimeAnnotation,ve.ce.TextStyleAnnotation),ve.ce.DatetimeAnnotation.static.name="textStyle/datetime",ve.ce.DatetimeAnnotation.static.tagName="time",ve.ce.annotationFactory.register(ve.ce.DatetimeAnnotation),ve.ce.DefinitionAnnotation=function(a,b,c){ve.ce.TextStyleAnnotation.call(this,a,b,c),this.$element.addClass("ve-ce-DefinitionAnnotation")},OO.inheritClass(ve.ce.DefinitionAnnotation,ve.ce.TextStyleAnnotation),ve.ce.DefinitionAnnotation.static.name="textStyle/definition",ve.ce.DefinitionAnnotation.static.tagName="dfn",ve.ce.annotationFactory.register(ve.ce.DefinitionAnnotation),ve.ce.HighlightAnnotation=function(a,b,c){ve.ce.TextStyleAnnotation.call(this,a,b,c),this.$element.addClass("ve-ce-HighlightAnnotation")},OO.inheritClass(ve.ce.HighlightAnnotation,ve.ce.TextStyleAnnotation),ve.ce.HighlightAnnotation.static.name="textStyle/highlight",ve.ce.HighlightAnnotation.static.tagName="mark",ve.ce.annotationFactory.register(ve.ce.HighlightAnnotation),ve.ce.ItalicAnnotation=function(a,b,c){ve.ce.TextStyleAnnotation.call(this,a,b,c),this.$element.addClass("ve-ce-ItalicAnnotation")},OO.inheritClass(ve.ce.ItalicAnnotation,ve.ce.TextStyleAnnotation),ve.ce.ItalicAnnotation.static.name="textStyle/italic",ve.ce.ItalicAnnotation.static.tagName="i",ve.ce.annotationFactory.register(ve.ce.ItalicAnnotation),ve.ce.QuotationAnnotation=function(a,b,c){ve.ce.TextStyleAnnotation.call(this,a,b,c),this.$element.addClass("ve-ce-QuotationAnnotation")},OO.inheritClass(ve.ce.QuotationAnnotation,ve.ce.TextStyleAnnotation),ve.ce.QuotationAnnotation.static.name="textStyle/quotation",ve.ce.QuotationAnnotation.static.tagName="q",ve.ce.annotationFactory.register(ve.ce.QuotationAnnotation),ve.ce.SmallAnnotation=function(a,b,c){ve.ce.TextStyleAnnotation.call(this,a,b,c),this.$element.addClass("ve-ce-SmallAnnotation")},OO.inheritClass(ve.ce.SmallAnnotation,ve.ce.TextStyleAnnotation),ve.ce.SmallAnnotation.static.name="textStyle/small",ve.ce.SmallAnnotation.static.tagName="small",ve.ce.annotationFactory.register(ve.ce.SmallAnnotation),ve.ce.SpanAnnotation=function(a,b,c){ve.ce.TextStyleAnnotation.call(this,a,b,c),this.$element.addClass("ve-ce-SpanAnnotation")},OO.inheritClass(ve.ce.SpanAnnotation,ve.ce.TextStyleAnnotation),ve.ce.SpanAnnotation.static.name="textStyle/span",ve.ce.SpanAnnotation.static.tagName="span",ve.ce.annotationFactory.register(ve.ce.SpanAnnotation),ve.ce.StrikethroughAnnotation=function(a,b,c){ve.ce.TextStyleAnnotation.call(this,a,b,c),this.$element.addClass("ve-ce-StrikethroughAnnotation")},OO.inheritClass(ve.ce.StrikethroughAnnotation,ve.ce.TextStyleAnnotation),ve.ce.StrikethroughAnnotation.static.name="textStyle/strikethrough",ve.ce.StrikethroughAnnotation.static.tagName="s",ve.ce.annotationFactory.register(ve.ce.StrikethroughAnnotation),ve.ce.SubscriptAnnotation=function(a,b,c){ve.ce.TextStyleAnnotation.call(this,a,b,c),this.$element.addClass("ve-ce-SubscriptAnnotation")},OO.inheritClass(ve.ce.SubscriptAnnotation,ve.ce.TextStyleAnnotation),ve.ce.SubscriptAnnotation.static.name="textStyle/subscript",ve.ce.SubscriptAnnotation.static.tagName="sub",ve.ce.annotationFactory.register(ve.ce.SubscriptAnnotation),ve.ce.SuperscriptAnnotation=function(a,b,c){ve.ce.TextStyleAnnotation.call(this,a,b,c),this.$element.addClass("ve-ce-SuperscriptAnnotation")},OO.inheritClass(ve.ce.SuperscriptAnnotation,ve.ce.TextStyleAnnotation),ve.ce.SuperscriptAnnotation.static.name="textStyle/superscript",ve.ce.SuperscriptAnnotation.static.tagName="sup",ve.ce.annotationFactory.register(ve.ce.SuperscriptAnnotation),ve.ce.UnderlineAnnotation=function(a,b,c){ve.ce.TextStyleAnnotation.call(this,a,b,c),this.$element.addClass("ve-ce-UnderlineAnnotation")},OO.inheritClass(ve.ce.UnderlineAnnotation,ve.ce.TextStyleAnnotation),ve.ce.UnderlineAnnotation.static.name="textStyle/underline",ve.ce.UnderlineAnnotation.static.tagName="u",ve.ce.annotationFactory.register(ve.ce.UnderlineAnnotation),ve.ce.UserInputAnnotation=function(a,b,c){ve.ce.TextStyleAnnotation.call(this,a,b,c),this.$element.addClass("ve-ce-UserInputAnnotation")},OO.inheritClass(ve.ce.UserInputAnnotation,ve.ce.TextStyleAnnotation),ve.ce.UserInputAnnotation.static.name="textStyle/userInput",ve.ce.UserInputAnnotation.static.tagName="kbd",ve.ce.annotationFactory.register(ve.ce.UserInputAnnotation),ve.ce.VariableAnnotation=function(a,b,c){ve.ce.TextStyleAnnotation.call(this,a,b,c),this.$element.addClass("ve-ce-VariableAnnotation")},OO.inheritClass(ve.ce.VariableAnnotation,ve.ce.TextStyleAnnotation),ve.ce.VariableAnnotation.static.name="textStyle/variable",ve.ce.VariableAnnotation.static.tagName="var",ve.ce.annotationFactory.register(ve.ce.VariableAnnotation),ve.ui={windowFactory:new OO.Factory},ve.ui.windowFactory.register(OO.ui.MessageDialog),ve.ui.Overlay=function(a){OO.ui.Element.call(this,a),this.$element.addClass("ve-ui-overlay")},OO.inheritClass(ve.ui.Overlay,OO.ui.Element),ve.ui.Surface=function(a,b){var c;OO.ui.Element.call(this,b),OO.EventEmitter.call(this,b),this.globalOverlay=new ve.ui.Overlay({classes:["ve-ui-overlay-global"]}),this.localOverlay=new ve.ui.Overlay({$:this.$,classes:["ve-ui-overlay-local"]}),this.$blockers=this.$("<div>"),this.$controls=this.$("<div>"),c=a instanceof ve.dm.Document?a:a instanceof ve.dm.LinearData||ve.isArray(a)?new ve.dm.Document(a):ve.dm.converter.getModelFromDom(a),this.model=new ve.dm.Surface(c),this.view=new ve.ce.Surface(this.model,this,{$:this.$}),this.dialogs=this.createDialogWindowManager(),this.commands={},this.triggers={},this.pasteRules={},this.enabled=!0,this.context=this.createContext(),this.dialogs.connect(this,{closing:"onDialogClosing"}),this.$element.addClass("ve-ui-surface").append(this.view.$element),this.localOverlay.$element.append(this.$blockers,this.$controls),this.globalOverlay.$element.append(this.dialogs.$element),ve.instances.push(this)},OO.inheritClass(ve.ui.Surface,OO.ui.Element),OO.mixinClass(ve.ui.Surface,OO.EventEmitter),ve.ui.Surface.prototype.destroy=function(){ve.instances.splice(ve.instances.indexOf(this),1),this.model.stopHistoryTracking(),this.view.destroy(),this.context.destroy(),this.dialogs.disconnect(this),this.$element.remove(),this.globalOverlay.$element.remove(),this.localOverlay.$element.remove(),this.emit("destroy")},ve.ui.Surface.prototype.onDialogClosing=function(a,b){b.progress(ve.bind(function(a){"teardown"===a.state&&(this.getView().focus(),this.getModel().getFragment().select())},this))},ve.ui.Surface.prototype.initialize=function(){this.getView().$element.after(this.localOverlay.$element),$("body").append(this.globalOverlay.$element),this.$element.addClass("ve-ui-surface-dir-"+this.getDir()),this.getView().initialize(),this.getModel().startHistoryTracking()},ve.ui.Surface.prototype.createContext=function(){throw new Error("ve.ui.Surface.createContext must be overridden in subclass")},ve.ui.Surface.prototype.createDialogWindowManager=function(){throw new Error("ve.ui.Surface.createDialogWindowManager must be overridden in subclass")},ve.ui.Surface.prototype.isEnabled=function(){return this.enabled},ve.ui.Surface.prototype.getModel=function(){return this.model},ve.ui.Surface.prototype.getView=function(){return this.view},ve.ui.Surface.prototype.getContext=function(){return this.context},ve.ui.Surface.prototype.getDialogs=function(){return this.dialogs},ve.ui.Surface.prototype.getLocalOverlay=function(){return this.localOverlay},ve.ui.Surface.prototype.getGlobalOverlay=function(){return this.globalOverlay},ve.ui.Surface.prototype.getCommand=function(a){return this.commands[a]},ve.ui.Surface.prototype.getTriggers=function(a){return this.triggers[a]},ve.ui.Surface.prototype.disable=function(){this.view.disable(),this.model.disable(),this.enabled=!1},ve.ui.Surface.prototype.enable=function(){this.enabled=!0,this.view.enable(),this.model.enable()},ve.ui.Surface.prototype.execute=function(a,b){var c,d,e;if(this.enabled){if(a instanceof ve.ui.Trigger){if(c=a.toString(),c in this.commands)return this.commands[c].execute(this)}else if("string"==typeof a&&"string"==typeof b&&ve.ui.actionFactory.doesActionSupportMethod(a,b))return d=ve.ui.actionFactory.create(a,this),e=d[b].apply(d,Array.prototype.slice.call(arguments,2)),void 0===e||!!e;return!1}},ve.ui.Surface.prototype.addCommands=function(a){var b,c,d,e,f,g,h;for(b=0,d=a.length;d>b;b++){if(f=ve.ui.commandRegistry.lookup(a[b]),!f)throw new Error("No command registered by that name: "+a[b]);if(g=ve.ui.triggerRegistry.lookup(a[b]),!g)throw new Error("No triggers registered by that name: "+a[b]);for(c=g.length-1;c>=0;c--){if(h=g[c],e=h.toString(),0===e.length)throw new Error("Incomplete trigger: "+h);this.commands[e]=f}this.triggers[a[b]]=g,this.emit("addCommand",a[b],f,g)}},ve.ui.Surface.prototype.getPasteRules=function(){return this.pasteRules},ve.ui.Surface.prototype.setPasteRules=function(a){this.pasteRules=a},ve.ui.Surface.prototype.getDir=function(){return this.$element.css("direction")},ve.ui.Context=function(a,b){OO.ui.Element.call(this,b),this.surface=a,this.visible=!1,this.inspector=null,this.inspectors=this.createInspectorWindowManager(),this.menu=new ve.ui.ContextMenuWidget({$:this.$}),this.afterContextChangeTimeout=null,this.afterContextChangeHandler=ve.bind(this.afterContextChange,this),this.surface.getModel().connect(this,{contextChange:"onContextChange",select:"onContextChange"}),this.inspectors.connect(this,{opening:"onInspectorOpening"}),this.menu.connect(this,{choose:"onContextItemChoose"}),this.$element.addClass("ve-ui-context"),this.menu.toggle(!1).$element.addClass("ve-ui-context-menu"),this.inspectors.$element.addClass("ve-ui-context-inspectors")},OO.inheritClass(ve.ui.Context,OO.ui.Element),ve.ui.Context.prototype.onContextChange=function(){this.inspector&&(this.inspector.isOpening()||this.inspector.isClosing())?(clearTimeout(this.afterContextChangeTimeout),this.afterContextChangeTimeout=null):null===this.afterContextChangeTimeout&&(this.afterContextChangeTimeout=setTimeout(this.afterContextChangeHandler)),this.availableTools=null},ve.ui.Context.prototype.afterContextChange=function(){this.afterContextChangeTimeout=null,this.isVisible()?this.menu.isVisible()?this.isInspectable()?(this.populateMenu(),this.updateDimensions()):(this.menu.toggle(!1),this.toggle(!1)):this.inspector&&this.inspector.close():this.isInspectable()&&(this.menu.toggle(!0),this.populateMenu(),this.toggle(!0))},ve.ui.Context.prototype.onInspectorOpening=function(a,b){this.inspector=a,b.progress(ve.bind(function(a){"setup"===a.state&&(this.menu.isVisible()?this.menu.toggle(!1):this.isVisible()||this.toggle(!0)),this.updateDimensions(!0)},this)).always(ve.bind(function(a){a.always(ve.bind(function(a){a.always(ve.bind(function(){var a=!!this.getAvailableTools().length;this.inspector=null,a?(this.menu.toggle(!0),this.populateMenu(),this.updateDimensions()):this.toggle(!1),this.getSurface().getModel().getSelection()&&this.getSurface().getView().focus()},this))},this))},this))},ve.ui.Context.prototype.onContextItemChoose=function(a){a&&a.getCommand().execute(this.surface)},ve.ui.Context.prototype.isVisible=function(){return this.visible},ve.ui.Context.prototype.isInspectable=function(){return!!this.getAvailableTools().length},ve.ui.Context.prototype.getAvailableTools=function(){return this.availableTools||(this.availableTools=ve.ui.toolFactory.getToolsForFragment(this.surface.getModel().getFragment(null,!1))),this.availableTools},ve.ui.Context.prototype.getSurface=function(){return this.surface},ve.ui.Context.prototype.getInspectors=function(){return this.inspectors},ve.ui.Context.prototype.getMenu=function(){return this.menu},ve.ui.Context.prototype.createInspectorWindowManager=function(){throw new Error("ve.ui.Context.createInspectorWindowManager must be overridden in subclass")},ve.ui.Context.prototype.populateMenu=function(){var a,b,c,d=[],e=this.getAvailableTools();if(this.menu.clearItems(),e.length){for(a=0,b=e.length;b>a;a++)c=e[a],d.push(new ve.ui.ContextItemWidget(c.tool.static.name,c.tool,c.model,{$:this.$}));this.menu.addItems(d)}return this},ve.ui.Context.prototype.toggle=function(a){return a=void 0===a?!this.visible:!!a,a!==this.visible&&(this.visible=a,this.$element.toggle()),$.Deferred().resolve().promise()},ve.ui.Context.prototype.updateDimensions=function(){return this},ve.ui.Context.prototype.destroy=function(){return this.surface.getModel().disconnect(this),this.inspectors.disconnect(this),this.menu.disconnect(this),clearTimeout(this.afterContextChangeTimeout),this.$element.remove(),this.inspectors.$element.remove(),this},ve.ui.Tool=function(a,b){OO.ui.Tool.call(this,a,b)},OO.inheritClass(ve.ui.Tool,OO.ui.Tool),ve.ui.Tool.static.requiresRange=!1,ve.ui.Tool.static.commandName=null,ve.ui.Tool.static.deactivateOnSelect=!0,ve.ui.Tool.static.getCommandName=function(){return this.commandName},ve.ui.Tool.prototype.onUpdateState=function(a){this.setDisabled(this.constructor.static.requiresRange&&!a.getRange())},ve.ui.Tool.prototype.onSelect=function(){var a=this.getCommand();a instanceof ve.ui.Command&&a.execute(this.toolbar.getSurface()),this.constructor.static.deactivateOnSelect&&this.setActive(!1)},ve.ui.Tool.prototype.getCommand=function(){return ve.ui.commandRegistry.lookup(this.constructor.static.commandName)},ve.ui.Toolbar=function(a,b){var c=this;b=b||{},OO.ui.Toolbar.call(this,ve.ui.toolFactory,ve.ui.toolGroupFactory,b),this.surface=a,this.floating=!1,this.floatable=!1,this.$window=null,this.$surfaceView=null,this.elementOffset=null,this.windowEvents={resize:function(){return c.onWindowResize.apply(c,arguments)},scroll:function(){return c.onWindowScroll.apply(c,arguments)}},this.surfaceViewEvents={keyup:function(){return c.onSurfaceViewKeyUp.apply(c,arguments)}},this.contextDirection={inline:"ltr",block:"ltr"},this.$element.addClass("ve-ui-dir-inline-"+this.contextDirection.inline).addClass("ve-ui-dir-block-"+this.contextDirection.block),this.surface.getModel().connect(this,{contextChange:"onContextChange"}),this.surface.connect(this,{addCommand:"onSurfaceAddCommand"})},OO.inheritClass(ve.ui.Toolbar,OO.ui.Toolbar),ve.ui.Toolbar.prototype.onWindowScroll=function(){var a=this.$window.scrollTop();a>this.elementOffset.top?this.float():this.floating&&this.unfloat()},ve.ui.Toolbar.prototype.onWindowResize=function(){var a={},b=this.elementOffset;b.right=this.$window.width()-this.$element.outerWidth()-b.left,a.offset=b,this.floating&&(a.css={right:b.right},this.$bar.css(a.css)),this.emit("position",this.$bar,a)},ve.ui.Toolbar.prototype.onSurfaceViewKeyUp=function(){var a,b,c,d;this.floating&&(d=this.surface.view.getSelectionRect(),d&&(a=this.$bar.height(),b=this.$bar.offset().top-a+(d.end.y-d.start.y),c=d.start.y-this.$window.scrollTop()<a,c&&this.$("html, body").prop("scrollTop",b)))},ve.ui.Toolbar.prototype.onContextChange=function(){this.updateToolState()},ve.ui.Toolbar.prototype.updateToolState=function(){var a,b,c,d=this.surface.getModel().getFragment(null,!1);d.isNull()||(a=b=this.surface.getView().documentView.getDirectionFromRange(d.getRange()),c=d.getAnnotations(),c.hasAnnotationWithName("meta/language")&&(a=c.getAnnotationsByName("meta/language").get(0).getAttribute("dir")),a!==this.contextDirection.inline&&(this.$element.removeClass("ve-ui-dir-inline-rtl ve-ui-dir-inline-ltr"),this.$element.addClass("ve-ui-dir-inline-"+a),this.contextDirection.inline=a),b!==this.contextDirection.block&&(this.$element.removeClass("ve-ui-dir-block-rtl ve-ui-dir-block-ltr"),this.$element.addClass("ve-ui-dir-block-"+b),this.contextDirection.block=b)),this.emit("updateState",d,this.contextDirection)},ve.ui.Toolbar.prototype.onSurfaceAddCommand=function(a){this.tools[a]&&this.tools[a].updateTitle()},ve.ui.Toolbar.prototype.getToolAccelerator=function(a){var b,c,d=this.surface.getTriggers(a),e=[];if(d){for(b=0,c=d.length;c>b;b++)e.push(d[b].getMessage());return e.join(", ")}return void 0},ve.ui.Toolbar.prototype.getSurface=function(){return this.surface},ve.ui.Toolbar.prototype.initialize=function(){OO.ui.Toolbar.prototype.initialize.call(this),this.$window=this.$(this.getElementWindow()),this.$surfaceView=this.surface.getView().$element,this.elementOffset=this.$element.offset(),this.elementOffset.right=this.$window.width()-this.$element.outerWidth()-this.elementOffset.left,this.emit("position",this.$bar,{floating:!1,offset:this.elementOffset}),this.updateToolState(),this.floatable&&(this.$window.on(this.windowEvents),this.$surfaceView.on(this.surfaceViewEvents),this.onWindowScroll())},ve.ui.Toolbar.prototype.destroy=function(){this.disableFloatable(),this.surface.getModel().disconnect(this,{contextChange:"onContextChange"}),OO.ui.Toolbar.prototype.destroy.call(this)},ve.ui.Toolbar.prototype.float=function(){var a;this.floating||(a={css:{left:this.elementOffset.left,right:this.elementOffset.right},floating:!0},this.$element.css("height",this.$element.height()).addClass("ve-ui-toolbar-floating"),this.$bar.css(a.css),this.floating=!0,this.emit("position",this.$bar,a))},ve.ui.Toolbar.prototype.unfloat=function(){this.floating&&(this.$element.css("height","").removeClass("ve-ui-toolbar-floating"),this.$bar.css({left:"",right:""}),this.floating=!1,this.emit("position",this.$bar,{floating:!1}))},ve.ui.Toolbar.prototype.enableFloatable=function(){this.floatable=!0,this.initialized&&(this.$window.on(this.windowEvents),this.$surfaceView.on(this.surfaceViewEvents))},ve.ui.Toolbar.prototype.disableFloatable=function(){this.$window&&this.$window.off(this.windowEvents),this.$surfaceView&&this.$surfaceView.off(this.surfaceViewEvents),this.floating&&this.unfloat(),this.floatable=!1},ve.ui.TargetToolbar=function(a,b,c){ve.ui.Toolbar.call(this,b,c),this.target=a},OO.inheritClass(ve.ui.TargetToolbar,ve.ui.Toolbar),ve.ui.TargetToolbar.prototype.getTarget=function(){return this.target},ve.ui.ToolFactory=function(){OO.ui.ToolFactory.call(this)},OO.inheritClass(ve.ui.ToolFactory,OO.ui.ToolFactory),ve.ui.ToolFactory.prototype.getToolsForFragment=function(a){var b,c,d,e,f,g,h,i=a.getSelectedModels(),j={},k=[];for(b=0,c=i.length;c>b;b++)for(h=i[b],g=this.collectCompatibleTools(h),d=0,e=g.length;e>d;d++)f=g[d].static.name,j[f]||k.push({tool:g[d],model:h}),j[f]=!0;return k},ve.ui.ToolFactory.prototype.collectCompatibleTools=function(a){var b,c,d,e,f,g=[];for(d in this.registry)if(e=this.registry[d],e.static.isCompatibleWith(a)){for(f=!0,b=0,c=g.length;c>b;b++){if(e.prototype instanceof g[b]){g.splice(b,1,e),f=!1;break}if(g[b].prototype instanceof e){f=!1;break}}f&&g.push(e)}return g},ve.ui.toolFactory=new ve.ui.ToolFactory,ve.ui.toolGroupFactory=new OO.ui.ToolGroupFactory,ve.ui.Command=function(a,b,c){this.name=a,this.action=b,this.method=c,this.data=Array.prototype.slice.call(arguments,3)},ve.ui.Command.prototype.execute=function(a){return a.execute.apply(a,[this.action,this.method].concat(this.data))},ve.ui.Command.prototype.getAction=function(){return this.action},ve.ui.Command.prototype.getMethod=function(){return this.method},ve.ui.Command.prototype.getName=function(){return this.name},ve.ui.Command.prototype.getData=function(){return this.data},ve.ui.CommandRegistry=function(){OO.Registry.call(this)},OO.inheritClass(ve.ui.CommandRegistry,OO.Registry),ve.ui.CommandRegistry.prototype.register=function(a){if(!(a instanceof ve.ui.Command))throw new Error("command must be an instance of ve.ui.Command, cannot be a "+typeof a);OO.Registry.prototype.register.call(this,a.getName(),a)},ve.ui.CommandRegistry.prototype.getCommandForNode=function(a){return this.lookup(a.constructor.static.primaryCommandName)},ve.ui.commandRegistry=new ve.ui.CommandRegistry,ve.ui.commandRegistry.register(new ve.ui.Command("undo","history","undo")),ve.ui.commandRegistry.register(new ve.ui.Command("redo","history","redo")),ve.ui.commandRegistry.register(new ve.ui.Command("bold","annotation","toggle","textStyle/bold")),ve.ui.commandRegistry.register(new ve.ui.Command("italic","annotation","toggle","textStyle/italic")),ve.ui.commandRegistry.register(new ve.ui.Command("code","annotation","toggle","textStyle/code")),ve.ui.commandRegistry.register(new ve.ui.Command("strikethrough","annotation","toggle","textStyle/strikethrough")),ve.ui.commandRegistry.register(new ve.ui.Command("underline","annotation","toggle","textStyle/underline")),ve.ui.commandRegistry.register(new ve.ui.Command("subscript","annotation","toggle","textStyle/subscript")),ve.ui.commandRegistry.register(new ve.ui.Command("superscript","annotation","toggle","textStyle/superscript")),ve.ui.commandRegistry.register(new ve.ui.Command("link","window","open","link")),ve.ui.commandRegistry.register(new ve.ui.Command("specialcharacter","window","open","specialcharacter")),ve.ui.commandRegistry.register(new ve.ui.Command("clear","annotation","clearAll")),ve.ui.commandRegistry.register(new ve.ui.Command("indent","indentation","increase")),ve.ui.commandRegistry.register(new ve.ui.Command("outdent","indentation","decrease")),ve.ui.commandRegistry.register(new ve.ui.Command("number","list","toggle","number")),ve.ui.commandRegistry.register(new ve.ui.Command("bullet","list","toggle","bullet")),ve.ui.commandRegistry.register(new ve.ui.Command("commandHelp","window","open","commandHelp")),ve.ui.commandRegistry.register(new ve.ui.Command("code","annotation","toggle","textStyle/code")),ve.ui.commandRegistry.register(new ve.ui.Command("strikethrough","annotation","toggle","textStyle/strikethrough")),ve.ui.commandRegistry.register(new ve.ui.Command("language","window","open","language")),ve.ui.commandRegistry.register(new ve.ui.Command("paragraph","format","convert","paragraph")),ve.ui.commandRegistry.register(new ve.ui.Command("heading1","format","convert","heading",{level:1})),ve.ui.commandRegistry.register(new ve.ui.Command("heading2","format","convert","heading",{level:2})),ve.ui.commandRegistry.register(new ve.ui.Command("heading3","format","convert","heading",{level:3})),ve.ui.commandRegistry.register(new ve.ui.Command("heading4","format","convert","heading",{level:4})),ve.ui.commandRegistry.register(new ve.ui.Command("heading5","format","convert","heading",{level:5})),ve.ui.commandRegistry.register(new ve.ui.Command("heading6","format","convert","heading",{level:6})),ve.ui.commandRegistry.register(new ve.ui.Command("preformatted","format","convert","preformatted")),ve.ui.commandRegistry.register(new ve.ui.Command("pasteSpecial","content","pasteSpecial")),ve.ui.commandRegistry.register(new ve.ui.Command("comment","window","open","comment")),ve.ui.Trigger=function(a,b){this.modifiers={meta:!1,ctrl:!1,alt:!1,shift:!1},this.primary=!1;var c,d,e,f,g=ve.ui.Trigger.static.keyAliases,h=ve.ui.Trigger.static.primaryKeys,i=ve.ui.Trigger.static.primaryKeyMap;if(a instanceof jQuery.Event)this.modifiers.meta=a.metaKey||!1,this.modifiers.ctrl=a.ctrlKey||!1,this.modifiers.alt=a.altKey||!1,this.modifiers.shift=a.shiftKey||!1,this.primary=i[a.which]||!1;else if("string"==typeof a)for(f=a.replace(/\s*/g,"").toLowerCase().split("+"),c=0,d=f.length;d>c;c++)e=f[c],e in g&&(e=g[e]),e in this.modifiers?this.modifiers[e]=!0:(-1!==h.indexOf(e)||b)&&(this.primary=e)},ve.ui.Trigger.static={},ve.ui.Trigger.static.modifierKeys=["meta","ctrl","alt","shift"],ve.ui.Trigger.static.primaryKeys=["backspace","tab","enter","escape","page-up","page-down","end","home","left","up","right","down","delete","clear","0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","multiply","add","subtract","decimal","divide","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12",";","=",",","-",".","/","`","[","\\","]","'"],ve.ui.Trigger.static.platformFilters={mac:function(){var a={meta:"⌘",shift:"⇧",backspace:"⌫",ctrl:"^",alt:"⎇",escape:"⎋"};return function(b){var c,d;for(c=0,d=b.length;d>c;c++)b[c]=a[b[c]]||b[c];return b.join("").toUpperCase()}}()},ve.ui.Trigger.static.keyAliases={command:"meta",apple:"meta",windows:"meta",option:"alt","return":"enter",esc:"escape",cmd:"meta",del:"delete",control:"ctrl",alternate:"alt","⌘":"meta","⎇":"alt","⇧":"shift","⏎":"enter","⌫":"backspace","⎋":"escape"},ve.ui.Trigger.static.primaryKeyMap={8:"backspace",9:"tab",12:"clear",13:"enter",27:"escape",33:"page-up",34:"page-down",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",46:"delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"multiply",107:"add",109:"subtract",110:"decimal",111:"divide",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},ve.ui.Trigger.prototype.isComplete=function(){return this.primary!==!1},ve.ui.Trigger.prototype.toString=function(){var a,b,c=ve.ui.Trigger.static.modifierKeys,d=[];for(a=0,b=c.length;b>a;a++)this.modifiers[c[a]]&&d.push(c[a]);return this.primary?(d.push(this.primary),d.join("+")):""},ve.ui.Trigger.prototype.getMessage=function(){var a,b=ve.ui.Trigger.static.platformFilters,c=ve.init.platform.getSystemPlatform();return a=this.toString().split("+"),c in b?b[c](a):a.map(function(a){return a[0].toUpperCase()+a.substr(1).toLowerCase()}).join("+")},ve.ui.TriggerRegistry=function(){OO.Registry.call(this)},OO.inheritClass(ve.ui.TriggerRegistry,OO.Registry),ve.ui.TriggerRegistry.prototype.register=function(a,b){var c,d,e,f=ve.init.platform.getSystemPlatform(),g="mac"===f?"mac":"pc";if(ve.isPlainObject(b)){if(!(g in b))return;e=ve.isArray(b[g])?b[g]:[b[g]]}else e=ve.isArray(b)?b:[b];for(c=0,d=e.length;d>c;c++)if(!(e[c]instanceof ve.ui.Trigger))throw new Error("Trigger must be an instance of ve.ui.Trigger");OO.Registry.prototype.register.call(this,a,e)},ve.ui.triggerRegistry=new ve.ui.TriggerRegistry,ve.ui.triggerRegistry.register("undo",{mac:new ve.ui.Trigger("cmd+z"),pc:new ve.ui.Trigger("ctrl+z")}),ve.ui.triggerRegistry.register("redo",{mac:[new ve.ui.Trigger("cmd+shift+z"),new ve.ui.Trigger("cmd+y")],pc:[new ve.ui.Trigger("ctrl+shift+z"),new ve.ui.Trigger("ctrl+y")]}),ve.ui.triggerRegistry.register("bold",{mac:new ve.ui.Trigger("cmd+b"),pc:new ve.ui.Trigger("ctrl+b")}),ve.ui.triggerRegistry.register("italic",{mac:new ve.ui.Trigger("cmd+i"),pc:new ve.ui.Trigger("ctrl+i")}),ve.ui.triggerRegistry.register("link",{mac:new ve.ui.Trigger("cmd+k"),pc:new ve.ui.Trigger("ctrl+k")}),ve.ui.triggerRegistry.register("clear",{mac:[new ve.ui.Trigger("cmd+\\"),new ve.ui.Trigger("cmd+m")],pc:[new ve.ui.Trigger("ctrl+\\"),new ve.ui.Trigger("ctrl+m")]}),ve.ui.triggerRegistry.register("underline",{mac:new ve.ui.Trigger("cmd+u"),pc:new ve.ui.Trigger("ctrl+u")}),ve.ui.triggerRegistry.register("subscript",{mac:new ve.ui.Trigger("cmd+,"),pc:new ve.ui.Trigger("ctrl+,")}),ve.ui.triggerRegistry.register("superscript",{mac:new ve.ui.Trigger("cmd+."),pc:new ve.ui.Trigger("ctrl+.")}),ve.ui.triggerRegistry.register("indent",new ve.ui.Trigger("tab")),ve.ui.triggerRegistry.register("outdent",new ve.ui.Trigger("shift+tab")),ve.ui.triggerRegistry.register("commandHelp",{mac:[new ve.ui.Trigger("cmd+/"),new ve.ui.Trigger("cmd+shift+/")],pc:[new ve.ui.Trigger("ctrl+/"),new ve.ui.Trigger("ctrl+shift+/")]}),ve.ui.triggerRegistry.register("paragraph",new ve.ui.Trigger("ctrl+0")),ve.ui.triggerRegistry.register("heading1",new ve.ui.Trigger("ctrl+1")),ve.ui.triggerRegistry.register("heading2",new ve.ui.Trigger("ctrl+2")),ve.ui.triggerRegistry.register("heading3",new ve.ui.Trigger("ctrl+3")),ve.ui.triggerRegistry.register("heading4",new ve.ui.Trigger("ctrl+4")),ve.ui.triggerRegistry.register("heading5",new ve.ui.Trigger("ctrl+5")),ve.ui.triggerRegistry.register("heading6",new ve.ui.Trigger("ctrl+6")),ve.ui.triggerRegistry.register("preformatted",new ve.ui.Trigger("ctrl+7")),ve.ui.triggerRegistry.register("pasteSpecial",{mac:new ve.ui.Trigger("cmd+shift+v"),pc:new ve.ui.Trigger("ctrl+shift+v")}),ve.ui.Action=function(a){this.surface=a},ve.ui.Action.static={},ve.ui.Action.static.methods=[],ve.ui.ActionFactory=function(){OO.Factory.call(this)},OO.inheritClass(ve.ui.ActionFactory,OO.Factory),ve.ui.ActionFactory.prototype.doesActionSupportMethod=function(a,b){if(a in this.registry)return-1!==this.registry[a].static.methods.indexOf(b);throw new Error("Unknown action: "+a)},ve.ui.actionFactory=new ve.ui.ActionFactory,ve.ui.WindowManager=function(a){a=a||{},ve.ui.WindowManager.super.call(this,a),this.overlay=a.overlay||null},OO.inheritClass(ve.ui.WindowManager,OO.ui.WindowManager),ve.ui.WindowManager.prototype.getOverlay=function(){return this.overlay},ve.ui.AnnotationAction=function(a){ve.ui.Action.call(this,a)},OO.inheritClass(ve.ui.AnnotationAction,ve.ui.Action),ve.ui.AnnotationAction.static.name="annotation",ve.ui.AnnotationAction.static.methods=["set","clear","toggle","clearAll"],ve.ui.AnnotationAction.prototype.set=function(a,b){var c,d=this.surface.getModel().getFragment(),e=ve.dm.annotationFactory.lookup(a),f=e.static.removes;for(c=f.length-1;c>=0;c--)d.annotateContent("clear",f[c]);d.annotateContent("set",a,b)},ve.ui.AnnotationAction.prototype.clear=function(a,b){this.surface.getModel().getFragment().annotateContent("clear",a,b)},ve.ui.AnnotationAction.prototype.toggle=function(a,b){var c,d,e,f,g=this.surface.getModel(),h=g.getFragment(),i=ve.dm.annotationFactory.create(a,b),j=i.constructor.static.removes;if(h.getRange().isCollapsed())e=g.getInsertionAnnotations(),d=e.getAnnotationsByName(i.name),d.isEmpty()?(f=e.filter(function(a){return-1!==ve.indexOf(a.name,j)}),g.removeInsertionAnnotations(f),g.addInsertionAnnotations(i)):g.removeInsertionAnnotations(d);else if(h.getAnnotations().containsComparable(i))h.annotateContent("clear",a);else{for(c=j.length-1;c>=0;c--)h.annotateContent("clear",j[c]);h.annotateContent("set",a,b)}},ve.ui.AnnotationAction.prototype.clearAll=function(){var a,b,c,d=this.surface.getModel(),e=d.getFragment(),f=e.getAnnotations(!0);for(c=f.get(),a=0,b=c.length;b>a;a++)e.annotateContent("clear",c[a].name,c[a].data);d.setInsertionAnnotations(null)},ve.ui.actionFactory.register(ve.ui.AnnotationAction),ve.ui.ContentAction=function(a){ve.ui.Action.call(this,a)},OO.inheritClass(ve.ui.ContentAction,ve.ui.Action),ve.ui.ContentAction.static.name="content",ve.ui.ContentAction.static.methods=["insert","remove","select","pasteSpecial"],ve.ui.ContentAction.prototype.insert=function(a,b){this.surface.getModel().getFragment().insertContent(a,b)},ve.ui.ContentAction.prototype.remove=function(){this.surface.getModel().getFragment().removeContent()},ve.ui.ContentAction.prototype.select=function(a){this.surface.getModel().setSelection(a)},ve.ui.ContentAction.prototype.pasteSpecial=function(){return this.surface.getView().pasteSpecial=!0,!1},ve.ui.actionFactory.register(ve.ui.ContentAction),ve.ui.FormatAction=function(a){ve.ui.Action.call(this,a)},OO.inheritClass(ve.ui.FormatAction,ve.ui.Action),ve.ui.FormatAction.static.name="format",ve.ui.FormatAction.static.methods=["convert"],ve.ui.FormatAction.prototype.convert=function(a,b){var c,d,e,f,g,h=this.surface.getModel(),i=h.getSelection(),j=h.getFragment(i,!0),k=h.getDocument(),l=[];for(c=k.selectNodes(i,"leaves"),d=0,e=c.length;e>d;d++)f=c[d].node.isContent()?c[d].node.getParent():c[d].node,l.push(h.getFragment(f.getOuterRange(),!0));for(d=0,e=l.length;e>d;d++)l[d].isolateAndUnwrap(a);i=j.getRange(),g=ve.dm.Transaction.newFromContentBranchConversion(k,i,a,b),h.change(g,i),this.surface.getView().focus()},ve.ui.actionFactory.register(ve.ui.FormatAction),ve.ui.HistoryAction=function(a){ve.ui.Action.call(this,a)},OO.inheritClass(ve.ui.HistoryAction,ve.ui.Action),ve.ui.HistoryAction.static.name="history",ve.ui.HistoryAction.static.methods=["undo","redo"],ve.ui.HistoryAction.prototype.undo=function(){this.surface.getModel().undo(),this.surface.getView().focus()},ve.ui.HistoryAction.prototype.redo=function(){this.surface.getModel().redo(),this.surface.getView().focus()
},ve.ui.actionFactory.register(ve.ui.HistoryAction),ve.ui.IndentationAction=function(a){ve.ui.Action.call(this,a)},OO.inheritClass(ve.ui.IndentationAction,ve.ui.Action),ve.ui.IndentationAction.static.name="indentation",ve.ui.IndentationAction.static.methods=["increase","decrease"],ve.ui.IndentationAction.prototype.increase=function(){var a,b,c=[],d=!1,e=this.surface.getModel(),f=e.getDocument(),g=e.getFragment(),h=f.getCoveredSiblingGroups(g.getRange());for(a=0;a<h.length;a++)b=h[a],b.grandparent&&"list"===b.grandparent.getType()&&(c.push(e.getFragment(b.parent.getRange(),!0)),d=!0);for(a=0;a<c.length;a++)this.indentListItem(f.getNodeFromOffset(c[a].getRange().start));return g.select(),d},ve.ui.IndentationAction.prototype.decrease=function(){var a,b,c=[],d=!1,e=this.surface.getModel(),f=e.getDocument(),g=e.getFragment(),h=f.getCoveredSiblingGroups(g.getRange());for(a=0;a<h.length;a++)b=h[a],b.grandparent&&"list"===b.grandparent.getType()?(c.push(e.getFragment(b.parent.getRange(),!0)),d=!0):b.parent&&"list"===b.parent.getType()&&(c.push(e.getFragment(b.nodes[0].getRange(),!0)),d=!0);for(a=0;a<c.length;a++)this.unindentListItem(f.getNodeFromOffset(c[a].getRange().start));return g.select(),d},ve.ui.IndentationAction.prototype.indentListItem=function(a){if(!(a instanceof ve.dm.ListItemNode))throw new Error("listItem must be a ve.dm.ListItemNode");var b,c,d,e,f,g=this.surface.getModel(),h=g.getDocument(),i=g.getSelection(),j=a.getParent().getAttribute("style"),k=a.getOuterRange();b=ve.dm.Transaction.newFromWrap(h,k,[],[{type:"listItem"},{type:"list",attributes:{style:j}}],[],[]),g.change(b),i=b.translateRange(i),c=ve.Range.newFromTranslatedRange(k,2),d=new ve.Range(k.start,k.end+2),"listItem"===h.data.getData(k.start).type&&"/listItem"===h.data.getData(k.start-1).type&&(e=k.start-1,f=k.start+1,"list"===h.data.getData(f).type&&"/list"===h.data.getData(e-1).type&&(e--,f++),b=ve.dm.Transaction.newFromRemoval(h,new ve.Range(e,f)),g.change(b),i=b.translateRange(i),c=b.translateRange(c),d=b.translateRange(d)),g.setSelection(i)},ve.ui.IndentationAction.prototype.unindentListItem=function(a){if(!(a instanceof ve.dm.ListItemNode))throw new Error("listItem must be a ve.dm.ListItemNode");var b,c,d,e,f,g,h=this.surface.getModel(),i=h.getFragment(a.getOuterRange(),!0),j=h.getDocument(),k=a.getParent(),l=k.getClonedElement(),m=k.getParent().getType(),n=a.getOuterRange();if("list"!==j.data.getData(n.start-1).type&&(b=ve.dm.Transaction.newFromInsertion(j,n.start,[{type:"/list"},l]),h.change(b),n=ve.Range.newFromTranslatedRange(n,2)),"/list"!==j.data.getData(n.end).type&&(b=ve.dm.Transaction.newFromInsertion(j,n.end,[{type:"/list"},l]),h.change(b)),g=new ve.Range(n.start-1,n.end+1),"listItem"!==m)for(b=ve.dm.Transaction.newFromWrap(j,new ve.Range(n.start+1,n.end-1),[{type:"list"},{type:"listItem"}],[],[],[]),h.change(b),e=i.getSiblingNodes(),c=0,d=e.length;d>c;c++)f=e[c].node,"paragraph"===f.type&&f.element.internal&&"wrapper"===f.element.internal.generated&&(delete f.element.internal.generated,ve.isEmptyObject(f.element.internal)&&delete f.element.internal);else"listItem"!==j.data.getData(g.start-1).type&&(b=ve.dm.Transaction.newFromInsertion(j,g.start,[{type:"/listItem"},{type:"listItem"}]),h.change(b),g=ve.Range.newFromTranslatedRange(g,2)),"/listItem"!==j.data.getData(g.end).type&&(b=ve.dm.Transaction.newFromInsertion(j,g.end,[{type:"/listItem"},{type:"listItem"}]),h.change(b)),b=ve.dm.Transaction.newFromWrap(j,new ve.Range(g.start+1,g.end-1),[{type:"listItem"},{type:"list"}],[],[],[]),h.change(b)},ve.ui.actionFactory.register(ve.ui.IndentationAction),ve.ui.ListAction=function(a){ve.ui.Action.call(this,a)},OO.inheritClass(ve.ui.ListAction,ve.ui.Action),ve.ui.ListAction.static.name="list",ve.ui.ListAction.static.methods=["wrap","unwrap","toggle"],ve.ui.ListAction.prototype.toggle=function(a){var b,c,d=this.surface.getModel().getFragment().getLeafNodes(),e=!!d.length;for(b=0,c=d.length;c>b;b++)if((1===c||!d[b].range||d[b].range.getLength())&&!d[b].node.hasMatchingAncestor("list",{style:a})){e=!1;break}this[e?"unwrap":"wrap"](a)},ve.ui.ListAction.prototype.wrap=function(a){var b,c,d,e,f,g,h=this.surface.getModel(),i=h.getDocument(),j=h.getSelection();if(h.breakpoint(),j.isCollapsed()&&!i.data.isContentOffset(j.to)&&this.surface.view.documentView.getSlugAtOffset(j.to))h.change(ve.dm.Transaction.newFromInsertion(i,j.from,[{type:"list",attributes:{style:a}},{type:"listItem"},{type:"paragraph"},{type:"/paragraph"},{type:"/listItem"},{type:"/list"}]),new ve.Range(j.to+3));else for(g=i.getCoveredSiblingGroups(j),c=0;c<g.length;c++)f=g[c],f.grandparent&&"list"===f.grandparent.getType()?f.grandparent!==d&&(h.change(ve.dm.Transaction.newFromAttributeChanges(i,f.grandparent.getOffset(),{style:a}),j),d=f.grandparent):(e=new ve.Range(f.nodes[0].getOuterRange().start,f.nodes[f.nodes.length-1].getOuterRange().end),h.change(ve.dm.Transaction.newFromContentBranchConversion(i,e,"paragraph"),j),b=ve.dm.Transaction.newFromWrap(i,e,[],[{type:"list",attributes:{style:a}}],[],[{type:"listItem"}]),h.change(b,b.translateRange(j)));h.breakpoint(),this.surface.getView().focus()},ve.ui.ListAction.prototype.unwrap=function(){var a,b=this.surface.getModel(),c=b.getDocument();b.breakpoint();do a=c.getNodeFromOffset(b.getSelection().start);while(a.hasMatchingAncestor("list")&&this.surface.execute("indentation","decrease"));b.breakpoint(),this.surface.getView().focus()},ve.ui.actionFactory.register(ve.ui.ListAction),ve.ui.WindowAction=function(a){ve.ui.Action.call(this,a)},OO.inheritClass(ve.ui.WindowAction,ve.ui.Action),ve.ui.WindowAction.static.name="window",ve.ui.WindowAction.static.methods=["open"],ve.ui.WindowAction.prototype.open=function(a,b){var c,d=ve.ui.windowFactory.lookup(a),e=this.surface.getModel().getFragment(null,!0),f=e.getRange()?this.surface.getView().getDocument().getDirectionFromRange(e.getRange()):this.surface.getModel().getDocument().getDir();b=ve.extendObject({dir:f},b,{fragment:e}),d&&(d.prototype instanceof ve.ui.FragmentInspector?c=this.surface.getContext().getInspectors():d.prototype instanceof OO.ui.Dialog&&(c=this.surface.getDialogs()),c.openWindow(a,b))},ve.ui.actionFactory.register(ve.ui.WindowAction),ve.ui.CommandHelpDialog=function(a,b){ve.ui.CommandHelpDialog.super.call(this,a,b)},OO.inheritClass(ve.ui.CommandHelpDialog,OO.ui.ProcessDialog),ve.ui.CommandHelpDialog.static.name="commandHelp",ve.ui.CommandHelpDialog.static.size="large",ve.ui.CommandHelpDialog.static.title=OO.ui.deferMsg("visualeditor-dialog-command-help-title"),ve.ui.CommandHelpDialog.static.actions=[{label:OO.ui.deferMsg("visualeditor-dialog-action-done"),flags:"safe"}],ve.ui.CommandHelpDialog.prototype.getBodyHeight=function(){return Math.round(this.contentLayout.$element[0].scrollHeight)},ve.ui.CommandHelpDialog.prototype.initialize=function(){ve.ui.CommandHelpDialog.super.prototype.initialize.call(this);var a,b,c,d,e,f,g,h,i,j,k=ve.init.platform.getSystemPlatform(),l="mac"===k?"mac":"pc",m=this.constructor.static.getCommandGroups();this.contentLayout=new OO.ui.PanelLayout({$:this.$,scrollable:!0,padded:!0}),this.$container=this.$("<div>").addClass("ve-ui-commandHelpDialog-container");for(a in m){for(g=m[a].commands,i=this.$("<dl>").addClass("ve-ui-commandHelpDialog-list"),b=0,c=g.length;c>b;b++){if(g[b].trigger)f=ve.ui.triggerRegistry.lookup(g[b].trigger);else for(f=[],d=0,e=g[b].shortcuts.length;e>d;d++)h=g[b].shortcuts[d],f.push(new ve.ui.Trigger(ve.isPlainObject(h)?h[l]:h,!0));for(j=this.$("<dt>"),d=0,e=f.length;e>d;d++)j.append(this.$("<kbd>").text(f[d].getMessage().replace(/\+/g," + ")));i.append(j,this.$("<dd>").text(ve.msg(g[b].msg)))}this.$container.append(this.$("<div>").addClass("ve-ui-commandHelpDialog-section").append(this.$("<h3>").text(ve.msg(m[a].title)),i))}this.contentLayout.$element.append(this.$container),this.$body.append(this.contentLayout.$element)},ve.ui.CommandHelpDialog.static.getCommandGroups=function(){return{textStyle:{title:"visualeditor-shortcuts-text-style",commands:[{trigger:"bold",msg:"visualeditor-annotationbutton-bold-tooltip"},{trigger:"italic",msg:"visualeditor-annotationbutton-italic-tooltip"},{trigger:"link",msg:"visualeditor-annotationbutton-link-tooltip"},{trigger:"superscript",msg:"visualeditor-annotationbutton-superscript-tooltip"},{trigger:"subscript",msg:"visualeditor-annotationbutton-subscript-tooltip"},{trigger:"underline",msg:"visualeditor-annotationbutton-underline-tooltip"},{trigger:"clear",msg:"visualeditor-clearbutton-tooltip"}]},formatting:{title:"visualeditor-shortcuts-formatting",commands:[{trigger:"paragraph",msg:"visualeditor-formatdropdown-format-paragraph"},{shortcuts:["ctrl+(1-6)"],msg:"visualeditor-formatdropdown-format-heading-label"},{trigger:"preformatted",msg:"visualeditor-formatdropdown-format-preformatted"},{trigger:"indent",msg:"visualeditor-indentationbutton-indent-tooltip"},{trigger:"outdent",msg:"visualeditor-indentationbutton-outdent-tooltip"}]},history:{title:"visualeditor-shortcuts-history",commands:[{trigger:"undo",msg:"visualeditor-historybutton-undo-tooltip"},{trigger:"redo",msg:"visualeditor-historybutton-redo-tooltip"}]},clipboard:{title:"visualeditor-shortcuts-clipboard",commands:[{shortcuts:[{mac:"cmd+x",pc:"ctrl+x"}],msg:"visualeditor-clipboard-cut"},{shortcuts:[{mac:"cmd+c",pc:"ctrl+c"}],msg:"visualeditor-clipboard-copy"},{shortcuts:[{mac:"cmd+v",pc:"ctrl+v"}],msg:"visualeditor-clipboard-paste"},{trigger:"pasteSpecial",msg:"visualeditor-clipboard-paste-special"}]},other:{title:"visualeditor-shortcuts-other",commands:[{trigger:"commandHelp",msg:"visualeditor-dialog-command-help-title"}]}}},ve.ui.windowFactory.register(ve.ui.CommandHelpDialog),ve.ui.FragmentDialog=function(a,b){ve.ui.FragmentDialog.super.call(this,a,b),this.fragment=null},OO.inheritClass(ve.ui.FragmentDialog,OO.ui.ProcessDialog),ve.ui.FragmentDialog.prototype.getSetupProcess=function(a){return a=a||{},ve.ui.FragmentDialog.super.prototype.getSetupProcess.apply(this,a).next(function(){if(!(a.fragment instanceof ve.dm.SurfaceFragment))throw new Error("Cannot open dialog: opening data must contain a fragment");this.fragment=a.fragment},this)},ve.ui.FragmentDialog.prototype.getTeardownProcess=function(a){return ve.ui.FragmentDialog.super.prototype.getTeardownProcess.apply(this,a).first(function(){this.fragment=null},this)},ve.ui.FragmentDialog.prototype.getFragment=function(){return this.fragment},ve.ui.NodeDialog=function(a,b){ve.ui.NodeDialog.super.call(this,a,b),this.selectedNode=null},OO.inheritClass(ve.ui.NodeDialog,ve.ui.FragmentDialog),ve.ui.NodeDialog.static.modelClasses=[],ve.ui.NodeDialog.prototype.getSelectedNode=function(){var a,b,c=this.constructor.static.modelClasses,d=this.getFragment().getSelectedNode();for(a=0,b=c.length;b>a;a++)if(d instanceof c[a])return d;return null},ve.ui.NodeDialog.prototype.initialize=function(a){ve.ui.NodeDialog.super.prototype.initialize.call(this,a),this.frame.$content.addClass("ve-ui-nodeDialog")},ve.ui.NodeDialog.prototype.getSetupProcess=function(a){return ve.ui.NodeDialog.super.prototype.getSetupProcess.call(this,a).next(function(){this.selectedNode=this.getSelectedNode(a)},this)},ve.ui.NodeDialog.prototype.getTeardownProcess=function(a){return ve.ui.NodeDialog.super.prototype.getTeardownProcess.call(this,a).first(function(){this.selectedNode=null},this)},ve.ui.LanguageSearchWidget=function(a){a=ve.extendObject({placeholder:ve.msg("visualeditor-language-search-input-placeholder")},a),OO.ui.SearchWidget.call(this,a),this.languageResultWidgets=[];var b,c,d,e=ve.init.platform.getLanguageCodes().sort();for(b=0,c=e.length;c>b;b++)d=e[b],this.languageResultWidgets.push(new ve.ui.LanguageResultWidget({code:d,name:ve.init.platform.getLanguageName(d),autonym:ve.init.platform.getLanguageAutonym(d)},{$:this.$}));this.$element.addClass("ve-ui-languageSearchWidget")},OO.inheritClass(ve.ui.LanguageSearchWidget,OO.ui.SearchWidget),ve.ui.LanguageSearchWidget.prototype.onQueryChange=function(){OO.ui.SearchWidget.prototype.onQueryChange.call(this),this.addResults()},ve.ui.LanguageSearchWidget.prototype.addResults=function(){var a,b,c,d,e,f,g,h=["name","autonym","code"],i=this.query.getValue().trim(),j=new RegExp("^"+this.constructor.static.escapeRegex(i),"i"),k=!!i.length,l=[];for(this.results.clearItems(),a=0,b=this.languageResultWidgets.length;b>a;a++){for(e=this.languageResultWidgets[a],f=e.getData(),g=null,c=0,d=h.length;d>c;c++)if(j.test(f[h[c]])){g=h[c];break}(""===i||g)&&l.push(e.updateLabel(i,g).setSelected(!1).setHighlighted(!1))}this.results.addItems(l),k&&this.results.highlightItem(this.results.getFirstSelectableItem())},ve.ui.LanguageSearchWidget.static.escapeRegex=function(a){return a.replace(/[\-\[\]{}()*+?.,\\\^$\|#\s]/g,"\\$&")},ve.ui.LanguageResultWidget=function(a,b){OO.ui.OptionWidget.call(this,a,b),this.$element.addClass("ve-ui-languageResultWidget"),this.$name=this.$("<div>").addClass("ve-ui-languageResultWidget-name"),this.$otherMatch=this.$("<div>").addClass("ve-ui-languageResultWidget-otherMatch"),this.setLabel(this.$otherMatch.add(this.$name))},OO.inheritClass(ve.ui.LanguageResultWidget,OO.ui.OptionWidget),ve.ui.LanguageResultWidget.prototype.updateLabel=function(a,b){var c,d=this.getData();return this.$name.text(d.name),this.$otherMatch.text(d.code),b&&(c=this.highlightQuery(d[b],a),"name"===b?this.$name.empty().append(c):this.$otherMatch.empty().append(c)),this},ve.ui.LanguageResultWidget.prototype.highlightQuery=function(a,b){var c=this.$("<span>"),d=a.toLowerCase().indexOf(b.toLowerCase());return b.length&&-1!==d?(c.append(document.createTextNode(a.substr(0,d)),this.$("<span>").addClass("ve-ui-languageResultWidget-highlight").text(a.substr(d,b.length)),document.createTextNode(a.substr(d+b.length))),c.contents()):c.text(a)},ve.ui.LanguageSearchDialog=function(a,b){ve.ui.LanguageSearchDialog.super.call(this,a,b)},OO.inheritClass(ve.ui.LanguageSearchDialog,OO.ui.ProcessDialog),ve.ui.LanguageSearchDialog.static.name="languageSearch",ve.ui.LanguageSearchDialog.static.size="medium",ve.ui.LanguageSearchDialog.static.title=OO.ui.deferMsg("visualeditor-dialog-language-search-title"),ve.ui.LanguageSearchDialog.static.actions=[{label:OO.ui.deferMsg("visualeditor-dialog-action-cancel")}],ve.ui.LanguageSearchDialog.static.languageSearchWidget=ve.ui.LanguageSearchWidget,ve.ui.LanguageSearchDialog.prototype.initialize=function(){ve.ui.LanguageSearchDialog.super.prototype.initialize.apply(this,arguments),this.searchWidget=new this.constructor.static.languageSearchWidget({$:this.$}).on("select",ve.bind(this.onSearchWidgetSelect,this)),this.$body.append(this.searchWidget.$element)},ve.ui.LanguageSearchDialog.prototype.onSearchWidgetSelect=function(a){this.close({action:"apply",lang:a.code,dir:ve.init.platform.getLanguageDirection(a.code)})},ve.ui.LanguageSearchDialog.prototype.getSetupProcess=function(a){return ve.ui.LanguageSearchDialog.super.prototype.getSetupProcess.call(this,a).next(function(){this.searchWidget.addResults()},this)},ve.ui.LanguageSearchDialog.prototype.getReadyProcess=function(a){return ve.ui.LanguageSearchDialog.super.prototype.getReadyProcess.call(this,a).next(function(){this.searchWidget.getQuery().focus()},this)},ve.ui.LanguageSearchDialog.prototype.getTeardownProcess=function(a){return ve.ui.LanguageSearchDialog.super.prototype.getTeardownProcess.call(this,a).first(function(){this.searchWidget.getQuery().setValue("")},this)},ve.ui.LanguageSearchDialog.prototype.getBodyHeight=function(){return 300},ve.ui.windowFactory.register(ve.ui.LanguageSearchDialog),ve.ui.LanguageInputWidget=function(a){a=a||{},OO.ui.Widget.call(this,a),this.lang=null,this.dir=null,this.overlay=new ve.ui.Overlay({classes:["ve-ui-overlay-global"]}),this.dialogs=new OO.ui.WindowManager({factory:ve.ui.windowFactory}),this.findLanguageButton=new OO.ui.ButtonWidget({$:this.$,classes:["ve-ui-languageInputWidget-findLanguageButton"],label:ve.msg("visualeditor-languageinspector-widget-changelang"),indicator:"next"}),this.languageCodeTextInput=new OO.ui.TextInputWidget({$:this.$,classes:["ve-ui-languageInputWidget-languageCodeTextInput"]}),this.directionSelect=new OO.ui.ButtonSelectWidget({$:this.$,classes:["ve-ui-languageInputWidget-directionSelect"]}),this.findLanguageField=new OO.ui.FieldLayout(this.findLanguageButton,{$:this.$,align:"left",label:ve.msg("visualeditor-languageinspector-widget-label-language")}),this.languageCodeField=new OO.ui.FieldLayout(this.languageCodeTextInput,{$:this.$,align:"left",label:ve.msg("visualeditor-languageinspector-widget-label-langcode")}),this.directionField=new OO.ui.FieldLayout(this.directionSelect,{$:this.$,align:"left",label:ve.msg("visualeditor-languageinspector-widget-label-direction")}),this.findLanguageButton.connect(this,{click:"onFindLanguageButtonClick"}),this.languageCodeTextInput.connect(this,{change:"onChange"}),this.directionSelect.connect(this,{select:"onChange"});var b=[new OO.ui.ButtonOptionWidget("rtl",{$:this.$,icon:"text-dir-rtl"}),new OO.ui.ButtonOptionWidget("ltr",{$:this.$,icon:"text-dir-ltr"})];a.requireDir||b.splice(1,0,new OO.ui.ButtonOptionWidget(null,{$:this.$,label:ve.msg("visualeditor-dialog-language-auto-direction")})),this.directionSelect.addItems(b),this.overlay.$element.append(this.dialogs.$element),$("body").append(this.overlay.$element),this.$element.addClass("ve-ui-languageInputWidget").append(this.findLanguageField.$element,this.languageCodeField.$element,this.directionField.$element)},OO.inheritClass(ve.ui.LanguageInputWidget,OO.ui.Widget),ve.ui.LanguageInputWidget.prototype.onFindLanguageButtonClick=function(){this.dialogs.openWindow("languageSearch").then(ve.bind(function(a){a.then(ve.bind(function(a){a.then(ve.bind(function(a){a=a||{},"apply"===a.action&&this.setLangAndDir(a.lang,a.dir)},this))},this))},this))},ve.ui.LanguageInputWidget.prototype.onChange=function(){if(!this.updating){var a=this.directionSelect.getSelectedItem();this.setLangAndDir(this.languageCodeTextInput.getValue(),a?a.getData():null)}},ve.ui.LanguageInputWidget.prototype.setLangAndDir=function(a,b){(a!==this.lang||b!==this.dir)&&(this.updating=!0,a||b?(this.languageCodeTextInput.setValue(a),this.findLanguageButton.setLabel(ve.init.platform.getLanguageName(a.toLowerCase())||ve.msg("visualeditor-languageinspector-widget-changelang")),this.directionSelect.selectItem(this.directionSelect.getItemFromData(b||null))):(this.languageCodeTextInput.setValue(""),this.findLanguageButton.setLabel(ve.msg("visualeditor-languageinspector-widget-changelang")),this.directionSelect.selectItem(this.directionSelect.getItemFromData(null))),this.updating=!1,this.emit("change",a,b),this.lang=a,this.dir=b)},ve.ui.LanguageInputWidget.prototype.getLang=function(){return this.lang},ve.ui.LanguageInputWidget.prototype.getDir=function(){return this.dir},ve.ui.SurfaceWidget=function(a,b){if(b=b||{},OO.ui.Widget.call(this,b),this.surface=ve.init.target.createSurface(a,{$:this.$}),this.toolbar=new ve.ui.Toolbar(this.surface,{$:this.$}),this.surface.$element.addClass("ve-ui-surfaceWidget-surface"),this.toolbar.$element.addClass("ve-ui-surfaceWidget-toolbar"),this.$element.addClass("ve-ui-surfaceWidget").append(this.toolbar.$element,this.surface.$element),b.tools&&this.toolbar.setup(b.tools),b.commands&&this.surface.addCommands(b.commands),b.pasteRules&&this.surface.setPasteRules(b.pasteRules),ve.debug){var c=new ve.ui.DebugBar(this.surface,{$:this.$});this.$element.append(c.$element)}},OO.inheritClass(ve.ui.SurfaceWidget,OO.ui.Widget),ve.ui.SurfaceWidget.prototype.getSurface=function(){return this.surface},ve.ui.SurfaceWidget.prototype.getToolbar=function(){return this.toolbar},ve.ui.SurfaceWidget.prototype.getContent=function(){return this.surface.getModel().getDocument().getData()},ve.ui.SurfaceWidget.prototype.initialize=function(){this.toolbar.initialize(),this.surface.initialize()},ve.ui.SurfaceWidget.prototype.destroy=function(){this.surface&&this.surface.destroy(),this.toolbar&&this.toolbar.destroy(),this.$element.remove()},ve.ui.SurfaceWidget.prototype.focus=function(){this.surface.getView().focus()},ve.ui.LinkTargetInputWidget=function(a){OO.ui.TextInputWidget.call(this,a),this.annotation=null,this.$element.addClass("ve-ui-linkTargetInputWidget"),$("body").hasClass("rtl")&&this.$input.addClass("oo-ui-rtl")},OO.inheritClass(ve.ui.LinkTargetInputWidget,OO.ui.TextInputWidget),ve.ui.LinkTargetInputWidget.prototype.onEdit=function(){this.disabled||setTimeout(ve.bind(function(){if($("body").hasClass("rtl")){var a=ve.init.platform.getExternalLinkUrlProtocolsRegExp().test(this.$input.val());this.setRTL(!a)}this.setValue(this.$input.val())},this))},ve.ui.LinkTargetInputWidget.prototype.isValid=function(){return this.getValue().match(/(^|\s)((https?:\/\/)?[\w-]+(\.[\w-]+)+\.?(:\d+)?(\/\S*)?)/gi)},ve.ui.LinkTargetInputWidget.prototype.setValue=function(a){a=this.sanitizeValue(a),""===a?this.annotation=null:this.setAnnotation(new ve.dm.LinkAnnotation({type:"link",attributes:{href:a}})),OO.ui.TextInputWidget.prototype.setValue.call(this,a)},ve.ui.LinkTargetInputWidget.prototype.setAnnotation=function(a){return this.annotation=a,OO.ui.TextInputWidget.prototype.setValue.call(this,this.getTargetFromAnnotation(a)),this},ve.ui.LinkTargetInputWidget.prototype.getAnnotation=function(){return this.annotation},ve.ui.LinkTargetInputWidget.prototype.getHref=function(){return this.getValue()},ve.ui.LinkTargetInputWidget.prototype.getTargetFromAnnotation=function(a){return a instanceof ve.dm.LinkAnnotation?a.getAttribute("href"):""},ve.ui.ContextMenuWidget=function(a){a=a||{},ve.ui.ContextMenuWidget.super.call(this,a),this.connect(this,{choose:"onChooseItem"}),this.$element.addClass("ve-ui-contextMenuWidget")},OO.inheritClass(ve.ui.ContextMenuWidget,OO.ui.SelectWidget),ve.ui.ContextMenuWidget.prototype.onChooseItem=function(){this.selectItem(null)},ve.ui.ContextItemWidget=function(a,b,c,d){d=d||{},ve.ui.ContextItemWidget.super.call(this,a,d),this.tool=b,this.model=c,this.$element.addClass("ve-ui-contextItemWidget"),this.setIcon(this.tool.static.icon),this.setLabel(this.getDescription())},OO.inheritClass(ve.ui.ContextItemWidget,OO.ui.DecoratedOptionWidget),ve.ui.ContextItemWidget.prototype.getDescription=function(){var a;return this.model instanceof ve.dm.Annotation?a=ve.ce.annotationFactory.getDescription(this.model):this.model instanceof ve.dm.Node&&(a=ve.ce.nodeFactory.getDescription(this.model)),a||(a=this.tool.static.title),a},ve.ui.ContextItemWidget.prototype.getCommand=function(){return ve.ui.commandRegistry.lookup(this.tool.static.commandName)},ve.ui.DimensionsWidget=function(a){var b,c;a=a||{},OO.ui.Widget.call(this,a),this.widthInput=new OO.ui.TextInputWidget({$:this.$}),this.heightInput=new OO.ui.TextInputWidget({$:this.$}),this.defaults=a.defaults||{width:"",height:""},this.renderDefaults(),b=new OO.ui.LabelWidget({$:this.$,label:ve.msg("visualeditor-dimensionswidget-times")}),c=new OO.ui.LabelWidget({$:this.$,label:ve.msg("visualeditor-dimensionswidget-px")}),this.widthInput.connect(this,{change:"onWidthChange"}),this.heightInput.connect(this,{change:"onHeightChange"}),this.$element.addClass("ve-ui-dimensionsWidget").append([this.widthInput.$element,b.$element.addClass("ve-ui-dimensionsWidget-label-times"),this.heightInput.$element,c.$element.addClass("ve-ui-dimensionsWidget-label-px")])},OO.inheritClass(ve.ui.DimensionsWidget,OO.ui.Widget),ve.ui.DimensionsWidget.prototype.onWidthChange=function(a){this.emit("widthChange",a)},ve.ui.DimensionsWidget.prototype.onHeightChange=function(a){this.emit("heightChange",a)},ve.ui.DimensionsWidget.prototype.setDefaults=function(a){a.width&&a.height&&(this.defaults=ve.copy(a),this.renderDefaults())},ve.ui.DimensionsWidget.prototype.renderDefaults=function(){this.widthInput.$input.attr("placeholder",this.getDefaults().width),this.heightInput.$input.attr("placeholder",this.getDefaults().height)},ve.ui.DimensionsWidget.prototype.getDefaults=function(){return this.defaults},ve.ui.DimensionsWidget.prototype.removeDefaults=function(){this.defaults={width:"",height:""},this.renderDefaults()},ve.ui.DimensionsWidget.prototype.isEmpty=function(){return""===this.widthInput.getValue()&&""===this.heightInput.getValue()},ve.ui.DimensionsWidget.prototype.clear=function(){this.widthInput.setValue(""),this.heightInput.setValue("")},ve.ui.DimensionsWidget.prototype.reset=function(){this.setDimensions(this.getDefaults())},ve.ui.DimensionsWidget.prototype.setDimensions=function(a){a.width&&this.setWidth(a.width),a.height&&this.setHeight(a.height)},ve.ui.DimensionsWidget.prototype.getDimensions=function(){return{width:this.widthInput.getValue(),height:this.heightInput.getValue()}},ve.ui.DimensionsWidget.prototype.setDisabled=function(a){this.widthInput&&this.widthInput.setDisabled(a),this.heightInput&&this.heightInput.setDisabled(a)},ve.ui.DimensionsWidget.prototype.getWidth=function(){return this.widthInput.getValue()},ve.ui.DimensionsWidget.prototype.getHeight=function(){return this.heightInput.getValue()},ve.ui.DimensionsWidget.prototype.setWidth=function(a){this.widthInput.setValue(a)},ve.ui.DimensionsWidget.prototype.setHeight=function(a){this.heightInput.setValue(a)},ve.ui.MediaSizeWidget=function(a,b){var c,d,e;b=b||{},this.scalable=a||{},OO.ui.Widget.call(this,b),this.ratio={},this.currentDimensions={},this.maxDimensions={},this.sizeTypeSelectWidget=new OO.ui.ButtonSelectWidget({$:this.$,classes:["ve-ui-mediaSizeWidget-section-sizetype"]}),this.sizeTypeSelectWidget.addItems([new OO.ui.ButtonOptionWidget("default",{$:this.$,label:ve.msg("visualeditor-mediasizewidget-sizeoptions-default")}),new OO.ui.ButtonOptionWidget("custom",{$:this.$,label:ve.msg("visualeditor-mediasizewidget-sizeoptions-custom")})]),this.scaleInput=new OO.ui.TextInputWidget({$:this.$}),e=new OO.ui.LabelWidget({$:this.$,input:this.scaleInput,label:ve.msg("visualeditor-mediasizewidget-label-scale-percent")}),this.dimensionsWidget=new ve.ui.DimensionsWidget({$:this.$}),this.errorLabel=new OO.ui.LabelWidget({$:this.$,label:ve.msg("visualeditor-mediasizewidget-label-defaulterror")}),c=new OO.ui.FieldLayout(this.scaleInput,{$:this.$,align:"right",label:ve.msg("visualeditor-mediasizewidget-label-scale")}),d=new OO.ui.FieldLayout(this.dimensionsWidget,{$:this.$,align:"right",label:ve.msg("visualeditor-mediasizewidget-label-custom"),classes:["ve-ui-mediaSizeWidget-section-custom"]}),this.fullSizeButton=new OO.ui.ButtonWidget({$:this.$,label:ve.msg("visualeditor-mediasizewidget-button-originaldimensions"),classes:["ve-ui-mediaSizeWidget-button-fullsize"]}),this.$element.addClass("ve-ui-mediaSizeWidget").append([this.sizeTypeSelectWidget.$element,d.$element,this.fullSizeButton.$element,this.$("<div>").addClass("ve-ui-mediaSizeWidget-label-error").append(this.errorLabel.$element)]),this.dimensionsWidget.connect(this,{widthChange:["onDimensionsChange","width"],heightChange:["onDimensionsChange","height"]}),this.sizeTypeSelectWidget.connect(this,{choose:"onSizeTypeChoose"}),this.fullSizeButton.connect(this,{click:"onFullSizeButtonClick"})},OO.inheritClass(ve.ui.MediaSizeWidget,OO.ui.Widget),ve.ui.MediaSizeWidget.prototype.onScalableOriginalSizeChange=function(a){var b=!a||$.isEmptyObject(a);this.fullSizeButton.setDisabled(b),this.sizeTypeSelectWidget.getItemFromData("default").setDisabled(b)},ve.ui.MediaSizeWidget.prototype.onScalableDefaultSizeChange=function(a){this.updateDefaultDimensions(),this.setSizeType(a?"default":"custom")},ve.ui.MediaSizeWidget.prototype.onDimensionsChange=function(a,b){var c={};""===b?this.setSizeType("default"):$.isNumeric(b)&&(this.setSizeType("custom"),c[a]=Number(b),this.setCurrentDimensions(c))},ve.ui.MediaSizeWidget.prototype.onScaleChange=function(){this.sizeTypeSelectWidget.selectItem(this.dimensionsWidget.isEmpty()?this.sizeTypeSelectWidget.getItemFromData("default"):this.sizeTypeSelectWidget.getItemFromData("scale"))},ve.ui.MediaSizeWidget.prototype.onSizeTypeChoose=function(a){var b=a&&a.getData();"default"===b?(this.scaleInput.setDisabled(!0),$.isEmptyObject(this.dimensionsWidget.getDefaults())||this.dimensionsWidget.clear()):"scale"===b?(this.dimensionsWidget.setDisabled(!0),this.scaleInput.setDisabled(!1)):"custom"===b&&(this.dimensionsWidget.setDisabled(!1),this.scaleInput.setDisabled(!0),this.scalable.isDefault()&&!$.isEmptyObject(this.dimensionsWidget.getDefaults())&&this.setCurrentDimensions(this.dimensionsWidget.getDefaults()),this.validateDimensions()),this.scalable.toggleDefault("default"===b),this.emit("changeSizeType",b),this.validateDimensions()},ve.ui.MediaSizeWidget.prototype.setScalePlaceholder=function(a){this.scaleInput.$element.attr("placeholder",a)},ve.ui.MediaSizeWidget.prototype.getScalePlaceholder=function(){return this.scaleInput.$element.attr("placeholder")},ve.ui.MediaSizeWidget.prototype.setSizeType=function(a){this.getSizeType()!==a&&this.sizeTypeSelectWidget.chooseItem(this.sizeTypeSelectWidget.getItemFromData(a))},ve.ui.MediaSizeWidget.prototype.getSizeType=function(){return this.sizeTypeSelectWidget.getSelectedItem()?this.sizeTypeSelectWidget.getSelectedItem().getData():""},ve.ui.MediaSizeWidget.prototype.setScalable=function(a){this.scalable instanceof ve.dm.Scalable&&this.scalable.disconnect(this),this.scalable=a,this.scalable.connect(this,{defaultSizeChange:"onScalableDefaultSizeChange",originalSizeChange:"onScalableOriginalSizeChange"}),this.updateDefaultDimensions(),this.scalable.isDefault()||this.setCurrentDimensions(this.scalable.getCurrentDimensions()),this.scalable.getOriginalDimensions()?(this.fullSizeButton.setDisabled(!1),this.sizeTypeSelectWidget.getItemFromData("default").setDisabled(!1),this.setSizeType(this.scalable.isDefault()?"default":"custom")):(this.fullSizeButton.setDisabled(!0),this.sizeTypeSelectWidget.getItemFromData("default").setDisabled(!0))},ve.ui.MediaSizeWidget.prototype.getScalable=function(){return this.scalable},ve.ui.MediaSizeWidget.prototype.onFullSizeButtonClick=function(){this.sizeTypeSelectWidget.chooseItem(this.sizeTypeSelectWidget.getItemFromData("custom")),this.setCurrentDimensions(this.scalable.getOriginalDimensions()),this.dimensionsWidget.setDisabled(!1)},ve.ui.MediaSizeWidget.prototype.setRatio=function(a){this.scalable.setRatio(a)},ve.ui.MediaSizeWidget.prototype.getRatio=function(){return this.scalable.getRatio()},ve.ui.MediaSizeWidget.prototype.setMaxDimensions=function(a){var b=ve.dm.Scalable.static.getDimensionsFromValue(a,this.scalable.getRatio());this.scalable.setMaxDimensions(b)},ve.ui.MediaSizeWidget.prototype.getMaxDimensions=function(){return this.scalable.getMaxDimensions()},ve.ui.MediaSizeWidget.prototype.getCurrentDimensions=function(){return this.currentDimensions},ve.ui.MediaSizeWidget.prototype.setDisabled=function(a){this.sizeTypeSelectWidget&&this.dimensionsWidget&&this.scalable&&this.fullSizeButton&&(this.sizeTypeSelectWidget.setDisabled(a),this.dimensionsWidget.setDisabled(a),this.fullSizeButton.setDisabled(a||!this.scalable.getOriginalDimensions()))},ve.ui.MediaSizeWidget.prototype.setCurrentDimensions=function(a){this.preventChangeRecursion||(this.preventChangeRecursion=!0,this.currentDimensions=ve.dm.Scalable.static.getDimensionsFromValue(a,this.scalable.getRatio()),(this.currentDimensions.width||this.currentDimensions.height)&&(this.dimensionsWidget.setWidth(this.currentDimensions.width),this.dimensionsWidget.setHeight(this.currentDimensions.height)),this.scalable.setCurrentDimensions(this.currentDimensions),this.validateDimensions(),this.emit("change",this.currentDimensions),this.preventChangeRecursion=!1)},ve.ui.MediaSizeWidget.prototype.validateDimensions=function(){var a=this.isValid();return this.errorLabel.$element.toggle(!a),this.$element.toggleClass("ve-ui-mediaSizeWidget-input-hasError",!a),a},ve.ui.MediaSizeWidget.prototype.updateDefaultDimensions=function(){var a=this.scalable.getDefaultDimensions();$.isEmptyObject(a)?this.dimensionsWidget.removeDefaults():this.dimensionsWidget.setDefaults(a)},ve.ui.MediaSizeWidget.prototype.isCustomEmpty=function(){return this.dimensionsWidget.isEmpty()},ve.ui.MediaSizeWidget.prototype.toggleFullSizeButtonDisabled=function(a){this.fullSizeButton.setDisabled(a)
},ve.ui.MediaSizeWidget.prototype.isScaleEmpty=function(){return""===this.scaleInput.getValue()},ve.ui.MediaSizeWidget.prototype.isEmpty=function(){return this.isCustomEmpty()&&this.isScaleEmpty()},ve.ui.MediaSizeWidget.prototype.isValid=function(){var a=this.sizeTypeSelectWidget.getSelectedItem()?this.sizeTypeSelectWidget.getSelectedItem().getData():"custom";return"custom"===a?this.dimensionsWidget.getDefaults()&&this.dimensionsWidget.isEmpty()?!0:$.isNumeric(this.dimensionsWidget.getWidth())&&$.isNumeric(this.dimensionsWidget.getHeight())?this.scalable.isCurrentDimensionsValid():!1:!0},ve.ui.WhitespacePreservingTextInputWidget=function(a){a=a||{},ve.ui.WhitespacePreservingTextInputWidget.super.call(this,a),this.limit=a.limit,this.whitespace=["",""],this.setValueAndWhitespace(a.valueAndWhitespace||""),this.$element.addClass("ve-ui-WhitespacePreservingTextInputWidget")},OO.inheritClass(ve.ui.WhitespacePreservingTextInputWidget,OO.ui.TextInputWidget),ve.ui.WhitespacePreservingTextInputWidget.prototype.setValueAndWhitespace=function(a){var b,c;b=this.limit?a.slice(0,this.limit):a,this.whitespace[0]=b.match(/^\s*/)[0],a=a.slice(this.whitespace[0].length),c=this.limit?a.slice(-this.limit):a,this.whitespace[1]=c.match(/\s*$/)[0],a=a.slice(0,a.length-this.whitespace[1].length),this.setValue(a)},ve.ui.WhitespacePreservingTextInputWidget.prototype.setWhitespace=function(a){this.whitespace=a},ve.ui.WhitespacePreservingTextInputWidget.prototype.getValue=function(){return this.whitespace[0]+this.value+this.whitespace[1]},ve.ui.WhitespacePreservingTextInputWidget.prototype.getInnerValue=function(){return this.value},ve.ui.AnnotationTool=function(a,b){ve.ui.Tool.call(this,a,b)},OO.inheritClass(ve.ui.AnnotationTool,ve.ui.Tool),ve.ui.AnnotationTool.static.annotation={name:""},ve.ui.AnnotationTool.static.requiresRange=!0,ve.ui.AnnotationTool.static.deactivateOnSelect=!1,ve.ui.AnnotationTool.prototype.onUpdateState=function(a){ve.ui.Tool.prototype.onUpdateState.apply(this,arguments),this.setActive(a.getAnnotations().hasAnnotationWithName(this.constructor.static.annotation.name))},ve.ui.BoldAnnotationTool=function(a,b){ve.ui.AnnotationTool.call(this,a,b)},OO.inheritClass(ve.ui.BoldAnnotationTool,ve.ui.AnnotationTool),ve.ui.BoldAnnotationTool.static.name="bold",ve.ui.BoldAnnotationTool.static.group="textStyle",ve.ui.BoldAnnotationTool.static.icon={"default":"bold-a",ar:"bold-arab-ain",be:"bold-cyrl-te",cs:"bold-b",da:"bold-f",de:"bold-f",en:"bold-b",es:"bold-n",eu:"bold-l",fa:"bold-arab-dad",fi:"bold-l",fr:"bold-g",gl:"bold-n",he:"bold-b",hu:"bold-f",it:"bold-g",ka:"bold-geor-man",ksh:"bold-f",ky:"bold-cyrl-zhe",ml:"bold-b",nl:"bold-v",nn:"bold-f",no:"bold-f",os:"bold-cyrl-be",pl:"bold-b",pt:"bold-n",ru:"bold-cyrl-zhe",sv:"bold-f"},ve.ui.BoldAnnotationTool.static.title=OO.ui.deferMsg("visualeditor-annotationbutton-bold-tooltip"),ve.ui.BoldAnnotationTool.static.annotation={name:"textStyle/bold"},ve.ui.BoldAnnotationTool.static.commandName="bold",ve.ui.toolFactory.register(ve.ui.BoldAnnotationTool),ve.ui.ItalicAnnotationTool=function(a,b){ve.ui.AnnotationTool.call(this,a,b)},OO.inheritClass(ve.ui.ItalicAnnotationTool,ve.ui.AnnotationTool),ve.ui.ItalicAnnotationTool.static.name="italic",ve.ui.ItalicAnnotationTool.static.group="textStyle",ve.ui.ItalicAnnotationTool.static.icon={"default":"italic-a",ar:"italic-arab-meem",be:"italic-cyrl-ka",cs:"italic-i",da:"italic-k",de:"italic-k",en:"italic-i",es:"italic-c",eu:"italic-e",fa:"italic-arab-keheh-jeem",fi:"italic-k",fr:"italic-i",gl:"italic-c",he:"italic-i",hu:"italic-d",it:"italic-c",ka:"italic-geor-kan",ksh:"italic-s",ky:"italic-cyrl-ka",ml:"italic-i",nl:"italic-c",nn:"italic-k",no:"italic-k",os:"italic-cyrl-ka",pl:"italic-i",pt:"italic-i",ru:"italic-cyrl-ka",sv:"italic-k"},ve.ui.ItalicAnnotationTool.static.title=OO.ui.deferMsg("visualeditor-annotationbutton-italic-tooltip"),ve.ui.ItalicAnnotationTool.static.annotation={name:"textStyle/italic"},ve.ui.ItalicAnnotationTool.static.commandName="italic",ve.ui.toolFactory.register(ve.ui.ItalicAnnotationTool),ve.ui.CodeAnnotationTool=function(a,b){ve.ui.AnnotationTool.call(this,a,b)},OO.inheritClass(ve.ui.CodeAnnotationTool,ve.ui.AnnotationTool),ve.ui.CodeAnnotationTool.static.name="code",ve.ui.CodeAnnotationTool.static.group="textStyle",ve.ui.CodeAnnotationTool.static.icon="code",ve.ui.CodeAnnotationTool.static.title=OO.ui.deferMsg("visualeditor-annotationbutton-code-tooltip"),ve.ui.CodeAnnotationTool.static.annotation={name:"textStyle/code"},ve.ui.CodeAnnotationTool.static.commandName="code",ve.ui.toolFactory.register(ve.ui.CodeAnnotationTool),ve.ui.StrikethroughAnnotationTool=function(a,b){ve.ui.AnnotationTool.call(this,a,b)},OO.inheritClass(ve.ui.StrikethroughAnnotationTool,ve.ui.AnnotationTool),ve.ui.StrikethroughAnnotationTool.static.name="strikethrough",ve.ui.StrikethroughAnnotationTool.static.group="textStyle",ve.ui.StrikethroughAnnotationTool.static.icon={"default":"strikethrough-a",en:"strikethrough-s",fi:"strikethrough-y"},ve.ui.StrikethroughAnnotationTool.static.title=OO.ui.deferMsg("visualeditor-annotationbutton-strikethrough-tooltip"),ve.ui.StrikethroughAnnotationTool.static.annotation={name:"textStyle/strikethrough"},ve.ui.StrikethroughAnnotationTool.static.commandName="strikethrough",ve.ui.toolFactory.register(ve.ui.StrikethroughAnnotationTool),ve.ui.UnderlineAnnotationTool=function(a,b){ve.ui.AnnotationTool.call(this,a,b)},OO.inheritClass(ve.ui.UnderlineAnnotationTool,ve.ui.AnnotationTool),ve.ui.UnderlineAnnotationTool.static.name="underline",ve.ui.UnderlineAnnotationTool.static.group="textStyle",ve.ui.UnderlineAnnotationTool.static.icon={"default":"underline-a",en:"underline-u"},ve.ui.UnderlineAnnotationTool.static.title=OO.ui.deferMsg("visualeditor-annotationbutton-underline-tooltip"),ve.ui.UnderlineAnnotationTool.static.annotation={name:"textStyle/underline"},ve.ui.UnderlineAnnotationTool.static.commandName="underline",ve.ui.toolFactory.register(ve.ui.UnderlineAnnotationTool),ve.ui.SuperscriptAnnotationTool=function(a,b){ve.ui.AnnotationTool.call(this,a,b)},OO.inheritClass(ve.ui.SuperscriptAnnotationTool,ve.ui.AnnotationTool),ve.ui.SuperscriptAnnotationTool.static.name="superscript",ve.ui.SuperscriptAnnotationTool.static.group="textStyle",ve.ui.SuperscriptAnnotationTool.static.icon="superscript",ve.ui.SuperscriptAnnotationTool.static.title=OO.ui.deferMsg("visualeditor-annotationbutton-superscript-tooltip"),ve.ui.SuperscriptAnnotationTool.static.annotation={name:"textStyle/superscript"},ve.ui.SuperscriptAnnotationTool.static.commandName="superscript",ve.ui.toolFactory.register(ve.ui.SuperscriptAnnotationTool),ve.ui.SubscriptAnnotationTool=function(a,b){ve.ui.AnnotationTool.call(this,a,b)},OO.inheritClass(ve.ui.SubscriptAnnotationTool,ve.ui.AnnotationTool),ve.ui.SubscriptAnnotationTool.static.name="subscript",ve.ui.SubscriptAnnotationTool.static.group="textStyle",ve.ui.SubscriptAnnotationTool.static.icon="subscript",ve.ui.SubscriptAnnotationTool.static.title=OO.ui.deferMsg("visualeditor-annotationbutton-subscript-tooltip"),ve.ui.SubscriptAnnotationTool.static.annotation={name:"textStyle/subscript"},ve.ui.SubscriptAnnotationTool.static.commandName="subscript",ve.ui.toolFactory.register(ve.ui.SubscriptAnnotationTool),ve.ui.ClearAnnotationTool=function(a,b){ve.ui.Tool.call(this,a,b),this.setDisabled(!0)},OO.inheritClass(ve.ui.ClearAnnotationTool,ve.ui.Tool),ve.ui.ClearAnnotationTool.static.name="clear",ve.ui.ClearAnnotationTool.static.group="utility",ve.ui.ClearAnnotationTool.static.icon="clear",ve.ui.ClearAnnotationTool.static.title=OO.ui.deferMsg("visualeditor-clearbutton-tooltip"),ve.ui.ClearAnnotationTool.static.requiresRange=!0,ve.ui.ClearAnnotationTool.static.commandName="clear",ve.ui.ClearAnnotationTool.prototype.onUpdateState=function(a){ve.ui.Tool.prototype.onUpdateState.apply(this,arguments),this.isDisabled()||this.setDisabled(!a.hasAnnotations())},ve.ui.toolFactory.register(ve.ui.ClearAnnotationTool),ve.ui.DialogTool=function(a,b){ve.ui.Tool.call(this,a,b)},OO.inheritClass(ve.ui.DialogTool,ve.ui.Tool),ve.ui.DialogTool.static.modelClasses=[],ve.ui.DialogTool.static.isCompatibleWith=function(a){return ve.isInstanceOfAny(a,this.modelClasses)},ve.ui.DialogTool.prototype.onUpdateState=function(){ve.ui.Tool.prototype.onUpdateState.apply(this,arguments),this.setActive(!1)},ve.ui.CommandHelpDialogTool=function(a,b){ve.ui.DialogTool.call(this,a,b)},OO.inheritClass(ve.ui.CommandHelpDialogTool,ve.ui.DialogTool),ve.ui.CommandHelpDialogTool.static.name="commandHelp",ve.ui.CommandHelpDialogTool.static.group="dialog",ve.ui.CommandHelpDialogTool.static.icon="help",ve.ui.CommandHelpDialogTool.static.title=OO.ui.deferMsg("visualeditor-dialog-command-help-title"),ve.ui.CommandHelpDialogTool.static.autoAddToCatchall=!1,ve.ui.CommandHelpDialogTool.static.autoAddToGroup=!1,ve.ui.CommandHelpDialogTool.static.commandName="commandHelp",ve.ui.toolFactory.register(ve.ui.CommandHelpDialogTool),ve.ui.FormatTool=function(a,b){ve.ui.Tool.call(this,a,b),this.convertible=!1},OO.inheritClass(ve.ui.FormatTool,ve.ui.Tool),ve.ui.FormatTool.static.format=null,ve.ui.FormatTool.static.requiresRange=!0,ve.ui.FormatTool.prototype.onUpdateState=function(a){ve.ui.Tool.prototype.onUpdateState.apply(this,arguments);var b,c,d=a.getSelectedLeafNodes(),e=this.constructor.static.format,f=!!d.length;for(b=0,c=d.length;c>b;b++)if(!d[b].hasMatchingAncestor(e.type,e.attributes)){f=!1;break}this.convertible=!f,this.setActive(f)},ve.ui.ParagraphFormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.ParagraphFormatTool,ve.ui.FormatTool),ve.ui.ParagraphFormatTool.static.name="paragraph",ve.ui.ParagraphFormatTool.static.group="format",ve.ui.ParagraphFormatTool.static.title=OO.ui.deferMsg("visualeditor-formatdropdown-format-paragraph"),ve.ui.ParagraphFormatTool.static.format={type:"paragraph"},ve.ui.ParagraphFormatTool.static.commandName="paragraph",ve.ui.toolFactory.register(ve.ui.ParagraphFormatTool),ve.ui.Heading1FormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.Heading1FormatTool,ve.ui.FormatTool),ve.ui.Heading1FormatTool.static.name="heading1",ve.ui.Heading1FormatTool.static.group="format",ve.ui.Heading1FormatTool.static.title=OO.ui.deferMsg("visualeditor-formatdropdown-format-heading1"),ve.ui.Heading1FormatTool.static.format={type:"heading",attributes:{level:1}},ve.ui.Heading1FormatTool.static.commandName="heading1",ve.ui.toolFactory.register(ve.ui.Heading1FormatTool),ve.ui.Heading2FormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.Heading2FormatTool,ve.ui.FormatTool),ve.ui.Heading2FormatTool.static.name="heading2",ve.ui.Heading2FormatTool.static.group="format",ve.ui.Heading2FormatTool.static.title=OO.ui.deferMsg("visualeditor-formatdropdown-format-heading2"),ve.ui.Heading2FormatTool.static.format={type:"heading",attributes:{level:2}},ve.ui.Heading2FormatTool.static.commandName="heading2",ve.ui.toolFactory.register(ve.ui.Heading2FormatTool),ve.ui.Heading3FormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.Heading3FormatTool,ve.ui.FormatTool),ve.ui.Heading3FormatTool.static.name="heading3",ve.ui.Heading3FormatTool.static.group="format",ve.ui.Heading3FormatTool.static.title=OO.ui.deferMsg("visualeditor-formatdropdown-format-heading3"),ve.ui.Heading3FormatTool.static.format={type:"heading",attributes:{level:3}},ve.ui.Heading3FormatTool.static.commandName="heading3",ve.ui.toolFactory.register(ve.ui.Heading3FormatTool),ve.ui.Heading4FormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.Heading4FormatTool,ve.ui.FormatTool),ve.ui.Heading4FormatTool.static.name="heading4",ve.ui.Heading4FormatTool.static.group="format",ve.ui.Heading4FormatTool.static.title=OO.ui.deferMsg("visualeditor-formatdropdown-format-heading4"),ve.ui.Heading4FormatTool.static.format={type:"heading",attributes:{level:4}},ve.ui.Heading4FormatTool.static.commandName="heading4",ve.ui.toolFactory.register(ve.ui.Heading4FormatTool),ve.ui.Heading5FormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.Heading5FormatTool,ve.ui.FormatTool),ve.ui.Heading5FormatTool.static.name="heading5",ve.ui.Heading5FormatTool.static.group="format",ve.ui.Heading5FormatTool.static.title=OO.ui.deferMsg("visualeditor-formatdropdown-format-heading5"),ve.ui.Heading5FormatTool.static.format={type:"heading",attributes:{level:5}},ve.ui.Heading5FormatTool.static.commandName="heading5",ve.ui.toolFactory.register(ve.ui.Heading5FormatTool),ve.ui.Heading6FormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.Heading6FormatTool,ve.ui.FormatTool),ve.ui.Heading6FormatTool.static.name="heading6",ve.ui.Heading6FormatTool.static.group="format",ve.ui.Heading6FormatTool.static.title=OO.ui.deferMsg("visualeditor-formatdropdown-format-heading6"),ve.ui.Heading6FormatTool.static.format={type:"heading",attributes:{level:6}},ve.ui.Heading6FormatTool.static.commandName="heading6",ve.ui.toolFactory.register(ve.ui.Heading6FormatTool),ve.ui.PreformattedFormatTool=function(a,b){ve.ui.FormatTool.call(this,a,b)},OO.inheritClass(ve.ui.PreformattedFormatTool,ve.ui.FormatTool),ve.ui.PreformattedFormatTool.static.name="preformatted",ve.ui.PreformattedFormatTool.static.group="format",ve.ui.PreformattedFormatTool.static.title=OO.ui.deferMsg("visualeditor-formatdropdown-format-preformatted"),ve.ui.PreformattedFormatTool.static.format={type:"preformatted"},ve.ui.PreformattedFormatTool.static.commandName="preformatted",ve.ui.toolFactory.register(ve.ui.PreformattedFormatTool),ve.ui.HistoryTool=function(a,b){ve.ui.Tool.call(this,a,b),this.toolbar.getSurface().getModel().connect(this,{history:"onUpdateState"}),this.setDisabled(!0)},OO.inheritClass(ve.ui.HistoryTool,ve.ui.Tool),ve.ui.HistoryTool.static.check="",ve.ui.HistoryTool.prototype.onUpdateState=function(){ve.ui.Tool.prototype.onUpdateState.apply(this,arguments),this.setDisabled(!this.toolbar.getSurface().getModel()[this.constructor.static.check]())},ve.ui.HistoryTool.prototype.destroy=function(){this.toolbar.getSurface().getModel().disconnect(this),ve.ui.HistoryTool.super.prototype.destroy.call(this)},ve.ui.UndoHistoryTool=function(a,b){ve.ui.HistoryTool.call(this,a,b)},OO.inheritClass(ve.ui.UndoHistoryTool,ve.ui.HistoryTool),ve.ui.UndoHistoryTool.static.name="undo",ve.ui.UndoHistoryTool.static.group="history",ve.ui.UndoHistoryTool.static.icon="undo",ve.ui.UndoHistoryTool.static.title=OO.ui.deferMsg("visualeditor-historybutton-undo-tooltip"),ve.ui.UndoHistoryTool.static.check="canUndo",ve.ui.UndoHistoryTool.static.commandName="undo",ve.ui.toolFactory.register(ve.ui.UndoHistoryTool),ve.ui.RedoHistoryTool=function(a,b){ve.ui.HistoryTool.call(this,a,b)},OO.inheritClass(ve.ui.RedoHistoryTool,ve.ui.HistoryTool),ve.ui.RedoHistoryTool.static.name="redo",ve.ui.RedoHistoryTool.static.group="history",ve.ui.RedoHistoryTool.static.icon="redo",ve.ui.RedoHistoryTool.static.title=OO.ui.deferMsg("visualeditor-historybutton-redo-tooltip"),ve.ui.RedoHistoryTool.static.check="canRedo",ve.ui.RedoHistoryTool.static.commandName="redo",ve.ui.toolFactory.register(ve.ui.RedoHistoryTool),ve.ui.IndentationTool=function(a,b){ve.ui.Tool.call(this,a,b)},OO.inheritClass(ve.ui.IndentationTool,ve.ui.Tool),ve.ui.IndentationTool.static.requiresRange=!0,ve.ui.IndentationTool.prototype.onUpdateState=function(a){if(ve.ui.Tool.prototype.onUpdateState.apply(this,arguments),!this.isDisabled()){var b,c,d=a.getSelectedLeafNodes(),e=!1;for(b=0,c=d.length;c>b;b++)if(d[b].hasMatchingAncestor("listItem")){e=!0;break}this.setDisabled(!e)}},ve.ui.IncreaseIndentationTool=function(a,b){ve.ui.IndentationTool.call(this,a,b)},OO.inheritClass(ve.ui.IncreaseIndentationTool,ve.ui.IndentationTool),ve.ui.IncreaseIndentationTool.static.name="indent",ve.ui.IncreaseIndentationTool.static.group="structure",ve.ui.IncreaseIndentationTool.static.icon="indent-list",ve.ui.IncreaseIndentationTool.static.title=OO.ui.deferMsg("visualeditor-indentationbutton-indent-tooltip"),ve.ui.IncreaseIndentationTool.static.commandName="indent",ve.ui.toolFactory.register(ve.ui.IncreaseIndentationTool),ve.ui.DecreaseIndentationTool=function(a,b){ve.ui.IndentationTool.call(this,a,b)},OO.inheritClass(ve.ui.DecreaseIndentationTool,ve.ui.IndentationTool),ve.ui.DecreaseIndentationTool.static.name="outdent",ve.ui.DecreaseIndentationTool.static.group="structure",ve.ui.DecreaseIndentationTool.static.icon="outdent-list",ve.ui.DecreaseIndentationTool.static.title=OO.ui.deferMsg("visualeditor-indentationbutton-outdent-tooltip"),ve.ui.DecreaseIndentationTool.static.commandName="outdent",ve.ui.toolFactory.register(ve.ui.DecreaseIndentationTool),ve.ui.InspectorTool=function(a,b){ve.ui.Tool.call(this,a,b)},OO.inheritClass(ve.ui.InspectorTool,ve.ui.Tool),ve.ui.InspectorTool.static.modelClasses=[],ve.ui.InspectorTool.static.requiresRange=!0,ve.ui.InspectorTool.static.deactivateOnSelect=!1,ve.ui.InspectorTool.static.isCompatibleWith=function(a){return ve.isInstanceOfAny(a,this.modelClasses)},ve.ui.InspectorTool.prototype.onUpdateState=function(a){var b,c,d,e=!1;for(ve.ui.Tool.prototype.onUpdateState.apply(this,arguments),d=a.getSelectedModels(),b=0,c=d.length;c>b;b++)if(this.constructor.static.isCompatibleWith(d[b])){e=!0;break}this.setActive(e)},ve.ui.LinkInspectorTool=function(a,b){ve.ui.InspectorTool.call(this,a,b)},OO.inheritClass(ve.ui.LinkInspectorTool,ve.ui.InspectorTool),ve.ui.LinkInspectorTool.static.name="link",ve.ui.LinkInspectorTool.static.group="meta",ve.ui.LinkInspectorTool.static.icon="link",ve.ui.LinkInspectorTool.static.title=OO.ui.deferMsg("visualeditor-annotationbutton-link-tooltip"),ve.ui.LinkInspectorTool.static.modelClasses=[ve.dm.LinkAnnotation],ve.ui.LinkInspectorTool.static.commandName="link",ve.ui.toolFactory.register(ve.ui.LinkInspectorTool),ve.ui.InsertCharacterInspectorTool=function(a,b){ve.ui.InspectorTool.call(this,a,b)},OO.inheritClass(ve.ui.InsertCharacterInspectorTool,ve.ui.InspectorTool),ve.ui.InsertCharacterInspectorTool.static.name="specialcharacter",ve.ui.InsertCharacterInspectorTool.static.group="insert",ve.ui.InsertCharacterInspectorTool.static.icon="special-character",ve.ui.InsertCharacterInspectorTool.static.title=OO.ui.deferMsg("visualeditor-specialcharacter-button-tooltip"),ve.ui.InsertCharacterInspectorTool.static.commandName="specialcharacter",ve.ui.InsertCharacterInspectorTool.static.deactivateOnSelect=!0,ve.ui.toolFactory.register(ve.ui.InsertCharacterInspectorTool),ve.ui.CommentInspectorTool=function(a,b){ve.ui.InspectorTool.call(this,a,b)},OO.inheritClass(ve.ui.CommentInspectorTool,ve.ui.InspectorTool),ve.ui.CommentInspectorTool.static.name="comment",ve.ui.CommentInspectorTool.static.group="meta",ve.ui.CommentInspectorTool.static.icon="comment",ve.ui.CommentInspectorTool.static.title=OO.ui.deferMsg("visualeditor-commentinspector-tooltip"),ve.ui.CommentInspectorTool.static.modelClasses=[ve.dm.CommentNode],ve.ui.CommentInspectorTool.static.commandName="comment",ve.ui.CommentInspectorTool.static.deactivateOnSelect=!0,ve.ui.toolFactory.register(ve.ui.CommentInspectorTool),ve.ui.LanguageInspectorTool=function(a,b){ve.ui.InspectorTool.call(this,a,b)},OO.inheritClass(ve.ui.LanguageInspectorTool,ve.ui.InspectorTool),ve.ui.LanguageInspectorTool.static.name="language",ve.ui.LanguageInspectorTool.static.group="meta",ve.ui.LanguageInspectorTool.static.icon="language",ve.ui.LanguageInspectorTool.static.title=OO.ui.deferMsg("visualeditor-annotationbutton-language-tooltip"),ve.ui.LanguageInspectorTool.static.modelClasses=[ve.dm.LanguageAnnotation],ve.ui.LanguageInspectorTool.static.commandName="language",ve.ui.toolFactory.register(ve.ui.LanguageInspectorTool),ve.ui.ListTool=function(a,b){ve.ui.Tool.call(this,a,b),this.method=null},OO.inheritClass(ve.ui.ListTool,ve.ui.Tool),ve.ui.ListTool.static.style="",ve.ui.ListTool.static.requiresRange=!0,ve.ui.ListTool.static.deactivateOnSelect=!1,ve.ui.ListTool.prototype.onUpdateState=function(a){ve.ui.Tool.prototype.onUpdateState.apply(this,arguments);var b,c,d=a.getSelectedLeafNodes(),e=this.constructor.static.style,f=!!d.length;for(b=0,c=d.length;c>b;b++)if(!d[b].hasMatchingAncestor("list",{style:e})){f=!1;break}this.setActive(f)},ve.ui.BulletListTool=function(a,b){ve.ui.ListTool.call(this,a,b)},OO.inheritClass(ve.ui.BulletListTool,ve.ui.ListTool),ve.ui.BulletListTool.static.name="bullet",ve.ui.BulletListTool.static.group="structure",ve.ui.BulletListTool.static.icon="bullet-list",ve.ui.BulletListTool.static.title=OO.ui.deferMsg("visualeditor-listbutton-bullet-tooltip"),ve.ui.BulletListTool.static.style="bullet",ve.ui.BulletListTool.static.commandName="bullet",ve.ui.toolFactory.register(ve.ui.BulletListTool),ve.ui.NumberListTool=function(a,b){ve.ui.ListTool.call(this,a,b)},OO.inheritClass(ve.ui.NumberListTool,ve.ui.ListTool),ve.ui.NumberListTool.static.name="number",ve.ui.NumberListTool.static.group="structure",ve.ui.NumberListTool.static.icon="number-list",ve.ui.NumberListTool.static.title=OO.ui.deferMsg("visualeditor-listbutton-number-tooltip"),ve.ui.NumberListTool.static.style="number",ve.ui.NumberListTool.static.commandName="number",ve.ui.toolFactory.register(ve.ui.NumberListTool),ve.ui.FragmentInspector=function(a,b){ve.ui.FragmentInspector.super.call(this,a,b),this.fragment=null,this.$element.addClass("ve-ui-fragmentInspector")},OO.inheritClass(ve.ui.FragmentInspector,OO.ui.ProcessDialog),ve.ui.FragmentInspector.static.actions=ve.ui.FragmentInspector.super.static.actions.concat([{action:"done",label:OO.ui.deferMsg("visualeditor-dialog-action-done"),flags:"primary"}]),ve.ui.FragmentInspector.prototype.onFormSubmit=function(){this.close({action:"done"})},ve.ui.FragmentInspector.prototype.getFragment=function(){return this.fragment},ve.ui.FragmentInspector.prototype.initialize=function(){ve.ui.FragmentInspector.super.prototype.initialize.call(this),this.container=new OO.ui.PanelLayout({$:this.$,scrollable:!0,classes:["ve-ui-fragmentInspector-container"]}),this.form=new OO.ui.FormLayout({$:this.$,classes:["ve-ui-fragmentInspector-form"]}),this.form.connect(this,{submit:"onFormSubmit"}),this.frame.$content.addClass("ve-ui-fragmentInspector-content"),this.container.$element.append(this.form.$element,this.$otherActions),this.$body.append(this.container.$element)},ve.ui.FragmentInspector.prototype.getActionProcess=function(a){return"done"===a?new OO.ui.Process(function(){this.close({action:"done"})},this):ve.ui.FragmentInspector.super.prototype.getActionProcess.call(this,a)},ve.ui.FragmentInspector.prototype.getSetupProcess=function(a){return a=a||{},ve.ui.FragmentInspector.super.prototype.getSetupProcess.call(this,a).first(function(){if(!(a.fragment instanceof ve.dm.SurfaceFragment))throw new Error("Cannot open inspector: opening data must contain a fragment");this.fragment=a.fragment},this)},ve.ui.FragmentInspector.prototype.getTeardownProcess=function(a){return ve.ui.FragmentDialog.super.prototype.getTeardownProcess.apply(this,a).next(function(){this.fragment=null},this)},ve.ui.FragmentInspector.prototype.getReadyProcess=function(a){return ve.ui.FragmentInspector.super.prototype.getReadyProcess.call(this,a).first(function(){},this)},ve.ui.FragmentInspector.prototype.getBodyHeight=function(){return Math.ceil(this.form.$element.outerHeight(!0)+this.$otherActions.outerHeight(!0))},ve.ui.FragmentInspector.prototype.setDimensions=function(a){ve.ui.FragmentInspector.super.prototype.setDimensions.call(this,a)},ve.ui.AnnotationInspector=function(a,b){ve.ui.FragmentInspector.call(this,a,b),this.previousSelection=null,this.initialSelection=null,this.initialAnnotation=null,this.initialAnnotationIsCovering=!1,this.isNewAnnotation=!1},OO.inheritClass(ve.ui.AnnotationInspector,ve.ui.FragmentInspector),ve.ui.AnnotationInspector.static.modelClasses=[],ve.ui.AnnotationInspector.static.actions=[{action:"remove",label:OO.ui.deferMsg("visualeditor-inspector-remove-tooltip"),flags:"destructive"}].concat(ve.ui.FragmentInspector.static.actions),ve.ui.AnnotationInspector.prototype.shouldRemoveAnnotation=function(){return!1},ve.ui.AnnotationInspector.prototype.getInsertionText=function(){return""},ve.ui.AnnotationInspector.prototype.getAnnotation=function(){throw new Error("ve.ui.AnnotationInspector.getAnnotation not implemented in subclass")},ve.ui.AnnotationInspector.prototype.getAnnotationFromFragment=function(){throw new Error("ve.ui.AnnotationInspector.getAnnotationFromFragment not implemented in subclass")},ve.ui.AnnotationInspector.prototype.getMatchingAnnotations=function(a,b){var c=this.constructor.static.modelClasses;return a.getAnnotations(b).filter(function(a){return ve.isInstanceOfAny(a,c)})},ve.ui.AnnotationInspector.prototype.getActionProcess=function(a){return"remove"===a?new OO.ui.Process(function(){this.close({action:"remove"})},this):ve.ui.AnnotationInspector.super.prototype.getActionProcess.call(this,a)},ve.ui.AnnotationInspector.prototype.getSetupProcess=function(a){return ve.ui.AnnotationInspector.super.prototype.getSetupProcess.call(this,a).next(function(){var a,b,c,d=this.getFragment(),e=this.getMatchingAnnotations(d,!0).get(0);this.previousSelection=d.getRange(),e?(a=d.expandRange("annotation",e),d=a):(d.getRange().isCollapsed()&&d.getDocument().data.isContentOffset(d.getRange().start)?(a=d.expandRange("word"),d=a):(b=d.trimRange(),d=b),d.getRange().isCollapsed()||(e=this.getAnnotationFromFragment(d),e&&d.annotateContent("set",e),this.isNewAnnotation=!0)),d.select(),this.initialSelection=d.getRange(),this.initialAnnotation=this.getMatchingAnnotations(d,!0).get(0),c=this.getMatchingAnnotations(d).get(0),this.initialAnnotation?c&&c.compareTo(this.initialAnnotation)&&(this.initialAnnotationIsCovering=!0):this.initialAnnotation=this.getAnnotationFromFragment(d)},this)},ve.ui.AnnotationInspector.prototype.getTeardownProcess=function(a){return a=a||{},ve.ui.AnnotationInspector.super.prototype.getTeardownProcess.call(this,a).first(function(){var b,c,d,e,f=!1,g=!1,h=!1,i=!1,j=!1,k=this.getAnnotation(),l=this.shouldRemoveAnnotation()||"remove"===a.action,m=this.getFragment().getSurface(),n=m.getFragment(this.initialSelection,!1),o=this.getFragment().getRange();if(this.initialSelection.isCollapsed()&&!l&&(g=!0),l?i=!0:k&&(this.initialAnnotationIsCovering&&this.initialAnnotation&&this.initialAnnotation.compareTo(k)||(this.isNewAnnotation?h=!0:i=!0,j=!0)),g&&(e=this.getInsertionText(),e.length&&(n.insertContent(e,!1),n.adjustRange(-e.length,0),this.previousSelection=new ve.Range(this.initialSelection.start+e.length))),h&&m.undo(),i)for(d=this.getMatchingAnnotations(n,!0).get(),b=0,c=d.length;c>b;b++)n.annotateContent("clear",d[b]);j&&k&&(n.getRange().isCollapsed()?f=!0:n.annotateContent("set",k)),(!a.action||g)&&(o=this.previousSelection),a.action&&m.setSelection(o),f&&m.addInsertionAnnotations(k),this.previousSelection=null,this.initialSelection=null,this.initialAnnotation=null,this.initialAnnotationIsCovering=!1,this.isNewAnnotation=!1},this)},ve.ui.InsertionInspector=function(a,b){ve.ui.FragmentInspector.call(this,a,b)},OO.inheritClass(ve.ui.InsertionInspector,ve.ui.FragmentInspector),ve.ui.InsertionInspector.static.actions=[{label:OO.ui.deferMsg("visualeditor-dialog-action-cancel"),flags:"safe"}],ve.ui.NodeInspector=function(a,b){ve.ui.FragmentInspector.call(this,a,b),this.selectedNode=null},OO.inheritClass(ve.ui.NodeInspector,ve.ui.FragmentInspector),ve.ui.NodeInspector.static.modelClasses=[],ve.ui.NodeInspector.prototype.getSelectedNode=function(){var a,b,c=this.constructor.static.modelClasses,d=this.getFragment().getSelectedNode();for(a=0,b=c.length;b>a;a++)if(d instanceof c[a])return d;return null},ve.ui.NodeInspector.prototype.initialize=function(a){ve.ui.NodeInspector.super.prototype.initialize.call(this,a),this.frame.$content.addClass("ve-ui-nodeInspector")},ve.ui.NodeInspector.prototype.getSetupProcess=function(a){return ve.ui.NodeInspector.super.prototype.getSetupProcess.call(this,a).next(function(){this.selectedNode=this.getSelectedNode(a)},this)},ve.ui.NodeInspector.prototype.getTeardownProcess=function(a){return ve.ui.NodeInspector.super.prototype.getTeardownProcess.call(this,a).next(function(){this.selectedNode=null},this)},ve.ui.LinkInspector=function(a,b){ve.ui.AnnotationInspector.call(this,a,b)},OO.inheritClass(ve.ui.LinkInspector,ve.ui.AnnotationInspector),ve.ui.LinkInspector.static.name="link",ve.ui.LinkInspector.static.title=OO.ui.deferMsg("visualeditor-linkinspector-title"),ve.ui.LinkInspector.static.linkTargetInputWidget=ve.ui.LinkTargetInputWidget,ve.ui.LinkInspector.static.modelClasses=[ve.dm.LinkAnnotation],ve.ui.LinkInspector.static.actions=ve.ui.LinkInspector.super.static.actions.concat([{action:"open",label:OO.ui.deferMsg("visualeditor-linkinspector-open")}]),ve.ui.LinkInspector.prototype.onTargetInputChange=function(){var a=this.targetInput.getHref(),b=this.targetInput.isValid();this.actions.forEach({actions:"open"},function(c){c.setHref(a).setTarget("_blank").setDisabled(!b),c.$element.hide().fadeIn(0)})},ve.ui.LinkInspector.prototype.shouldRemoveAnnotation=function(){return!this.targetInput.getValue().length},ve.ui.LinkInspector.prototype.getInsertionText=function(){return this.targetInput.getValue()},ve.ui.LinkInspector.prototype.getAnnotation=function(){return this.targetInput.getAnnotation()},ve.ui.LinkInspector.prototype.getAnnotationFromFragment=function(a){return new ve.dm.LinkAnnotation({type:"link",attributes:{href:a.getText()}})},ve.ui.LinkInspector.prototype.initialize=function(){var a=this.manager.getOverlay();ve.ui.LinkInspector.super.prototype.initialize.call(this),this.targetInput=new this.constructor.static.linkTargetInputWidget({$:this.$,$overlay:a?a.$element:this.$frame,disabled:!0,classes:["ve-ui-linkInspector-target"]}),this.targetInput.connect(this,{change:"onTargetInputChange"}),this.frame.$content.addClass("ve-ui-linkInspector-content"),this.form.$element.append(this.targetInput.$element)},ve.ui.LinkInspector.prototype.getSetupProcess=function(a){return ve.ui.LinkInspector.super.prototype.getSetupProcess.call(this,a).next(function(){this.getFragment().getSurface().disable(),this.targetInput.setAnnotation(this.initialAnnotation)},this)},ve.ui.LinkInspector.prototype.getReadyProcess=function(a){return ve.ui.LinkInspector.super.prototype.getReadyProcess.call(this,a).next(function(){this.targetInput.setDisabled(!1).focus().select(),this.getFragment().getSurface().enable()},this)},ve.ui.LinkInspector.prototype.getHoldProcess=function(a){return ve.ui.LinkInspector.super.prototype.getHoldProcess.call(this,a).next(function(){this.targetInput.setDisabled(!0).blur()},this)},ve.ui.LinkInspector.prototype.getTeardownProcess=function(a){return ve.ui.LinkInspector.super.prototype.getTeardownProcess.call(this,a).next(function(){this.targetInput.setAnnotation(null)},this)},ve.ui.windowFactory.register(ve.ui.LinkInspector),ve.ui.CommentInspector=function(a,b){ve.ui.NodeInspector.call(this,a,b)},OO.inheritClass(ve.ui.CommentInspector,ve.ui.NodeInspector),ve.ui.CommentInspector.static.name="comment",ve.ui.CommentInspector.static.icon="comment",ve.ui.CommentInspector.static.title=OO.ui.deferMsg("visualeditor-commentinspector-title"),ve.ui.CommentInspector.static.modelClasses=[ve.dm.CommentNode],ve.ui.CommentInspector.static.size="large",ve.ui.CommentInspector.static.actions=[{action:"done",label:OO.ui.deferMsg("visualeditor-dialog-action-done"),flags:"primary",modes:"edit"},{action:"insert",label:OO.ui.deferMsg("visualeditor-commentinspector-insert"),flags:["constructive","primary"],modes:"insert"},{action:"remove",label:OO.ui.deferMsg("visualeditor-inspector-remove-tooltip"),flags:"destructive",modes:"edit"}],ve.ui.CommentInspector.prototype.initialize=function(){ve.ui.CommentInspector.super.prototype.initialize.call(this),this.textWidget=new ve.ui.WhitespacePreservingTextInputWidget({$:this.$,multiline:!0,autosize:!0}),this.frame.$content.addClass("ve-ui-commentInspector-content"),this.form.$element.append(this.textWidget.$element)},ve.ui.CommentInspector.prototype.getActionProcess=function(a){return"remove"===a||"insert"===a?new OO.ui.Process(function(){this.close({action:a})
},this):ve.ui.CommentInspector.super.prototype.getActionProcess.call(this,a)},ve.ui.CommentInspector.prototype.getSetupProcess=function(a){return ve.ui.CommentInspector.super.prototype.getSetupProcess.call(this,a).next(function(){this.getFragment().getSurface().disable(),this.commentNode=this.getSelectedNode(),this.commentNode?(this.textWidget.setValueAndWhitespace(this.commentNode.getAttribute("text")||""),this.actions.setMode("edit")):(this.textWidget.setWhitespace([" "," "]),this.actions.setMode("insert"))},this)},ve.ui.CommentInspector.prototype.getReadyProcess=function(a){return ve.ui.CommentInspector.super.prototype.getReadyProcess.call(this,a).next(function(){this.getFragment().getSurface().enable(),this.textWidget.focus()},this)},ve.ui.CommentInspector.prototype.getTeardownProcess=function(a){return a=a||{},ve.ui.CommentInspector.super.prototype.getTeardownProcess.call(this,a).first(function(){var b=this.getFragment().getSurface(),c=this.textWidget.getValue(),d=this.textWidget.getInnerValue();this.commentNode?"remove"===a.action||""===d?(this.fragment=this.getFragment().clone(this.commentNode.getOuterRange()),this.fragment.removeContent()):b.change(ve.dm.Transaction.newFromAttributeChanges(b.getDocument(),this.commentNode.getOffset(),{text:c})):""!==d&&this.getFragment().insertContent([{type:"comment",attributes:{text:c}},{type:"/comment"}]),this.textWidget.setValueAndWhitespace("")},this)},ve.ui.windowFactory.register(ve.ui.CommentInspector),ve.ui.LanguageInspector=function(a,b){ve.ui.AnnotationInspector.call(this,a,b)},OO.inheritClass(ve.ui.LanguageInspector,ve.ui.AnnotationInspector),ve.ui.LanguageInspector.static.name="language",ve.ui.LanguageInspector.static.title=OO.ui.deferMsg("visualeditor-languageinspector-title"),ve.ui.LanguageInspector.static.modelClasses=[ve.dm.LanguageAnnotation],ve.ui.LanguageInspector.prototype.getAnnotation=function(){var a=this.languageInput.getLang(),b=this.languageInput.getDir();return a||b?new ve.dm.LanguageAnnotation({type:"meta/language",attributes:{lang:a,dir:b}}):null},ve.ui.LanguageInspector.prototype.getAnnotationFromFragment=function(a){return new ve.dm.LanguageAnnotation({type:"meta/language",attributes:{lang:a.getDocument().getLang(),dir:a.getDocument().getDir()}})},ve.ui.LanguageInspector.prototype.initialize=function(){ve.ui.LanguageInspector.super.prototype.initialize.call(this),this.languageInput=new ve.ui.LanguageInputWidget({$:this.$}),this.form.$element.append(this.languageInput.$element)},ve.ui.LanguageInspector.prototype.getSetupProcess=function(a){return ve.ui.LanguageInspector.super.prototype.getSetupProcess.call(this,a).next(function(){this.languageInput.setLangAndDir(this.initialAnnotation.getAttribute("lang"),this.initialAnnotation.getAttribute("dir"))},this)},ve.ui.windowFactory.register(ve.ui.LanguageInspector),ve.ui.SpecialCharacterInspector=function(a,b){ve.ui.InsertionInspector.call(this,a,b),this.characters=null,this.$buttonDomList=null,this.initialSelection=null,this.categories=null,this.$element.addClass("ve-ui-specialCharacterInspector")},OO.inheritClass(ve.ui.SpecialCharacterInspector,ve.ui.InsertionInspector),ve.ui.SpecialCharacterInspector.static.name="specialcharacter",ve.ui.SpecialCharacterInspector.static.title=OO.ui.deferMsg("visualeditor-specialcharacterinspector-title"),ve.ui.SpecialCharacterInspector.static.size="large",ve.ui.SpecialCharacterInspector.prototype.initialize=function(){ve.ui.SpecialCharacterInspector.super.prototype.initialize.call(this),this.$spinner=this.$("<div>").addClass("ve-ui-specialCharacterInspector-spinner"),this.form.$element.append(this.$spinner)},ve.ui.SpecialCharacterInspector.prototype.getSetupProcess=function(a){return ve.ui.SpecialCharacterInspector.super.prototype.getSetupProcess.call(this,a).next(function(){this.initialSelection=this.getFragment().getRange(),this.characters||(this.$spinner.show(),this.fetchCharList().done(ve.bind(function(){this.buildButtonList()},this)).always(ve.bind(function(){this.$spinner.hide()},this)))},this)},ve.ui.SpecialCharacterInspector.prototype.fetchCharList=function(){var a,b={};a=ve.msg("visualeditor-specialcharinspector-characterlist-insert");try{b=$.parseJSON(a)}catch(c){ve.log("ve.ui.SpecialCharacterInspector: Could not parse the Special Character list."),ve.log(c.message)}finally{this.characters=b}return $.Deferred().resolve().promise()},ve.ui.SpecialCharacterInspector.prototype.buildButtonList=function(){var a,b,c,d,e=this.$("<div>").addClass("ve-ui-specialCharacterInspector-list");for(a in this.characters){c=this.characters[a],d=$("<div>").addClass("ve-ui-specialCharacterInspector-list-group");for(b in c)d.append($("<div>").addClass("ve-ui-specialCharacterInspector-list-character").data("character",c[b]).text(b));e.append(this.$("<h3>").text(a)).append(d)}e.on("click",ve.bind(this.onListClick,this)),this.form.$element.append(e)},ve.ui.SpecialCharacterInspector.prototype.onListClick=function(a){var b=$(a.target).data("character");void 0!==b&&this.getFragment().insertContent(b,!1).collapseRangeToEnd().select()},ve.ui.windowFactory.register(ve.ui.SpecialCharacterInspector),ve.ui.DesktopSurface=function(){ve.ui.Surface.apply(this,arguments),this.$menus=this.$("<div>"),this.localOverlay.$element.append(this.$menus),this.$menus.append(this.context.$element)},OO.inheritClass(ve.ui.DesktopSurface,ve.ui.Surface),ve.ui.DesktopSurface.prototype.createContext=function(){return new ve.ui.DesktopContext(this,{$:this.$})},ve.ui.DesktopSurface.prototype.createDialogWindowManager=function(){return new OO.ui.WindowManager({factory:ve.ui.windowFactory})},ve.ui.DesktopContext=function(a,b){ve.ui.DesktopContext.super.call(this,a,b),this.popup=new OO.ui.PopupWidget({$:this.$,$container:this.surface.$element}),this.transitioning=null,this.suppressed=!1,this.onWindowResizeHandler=ve.bind(this.onWindowResize,this),this.$window=this.$(this.getElementWindow()),this.surface.getView().connect(this,{selectionStart:"onSuppress",selectionEnd:"onUnsuppress",relocationStart:"onSuppress",relocationEnd:"onUnsuppress",blur:"onSuppress",focus:"onUnsuppress",position:"onSurfacePosition"}),this.$window.on("resize",this.onWindowResizeHandler),this.$element.on("mousedown",!1),this.$element.addClass("ve-ui-desktopContext").append(this.popup.$element),this.menu.$element.addClass("ve-ui-desktopContext-menu"),this.inspectors.$element.addClass("ve-ui-desktopContext-inspectors"),this.popup.$body.append(this.menu.$element,this.inspectors.$element),this.popup.$element.css({visibility:"hidden",display:""})},OO.inheritClass(ve.ui.DesktopContext,ve.ui.Context),ve.ui.DesktopContext.prototype.afterContextChange=function(){ve.ui.DesktopContext.super.prototype.afterContextChange.call(this),this.suppressed},ve.ui.DesktopContext.prototype.onSuppress=function(){this.suppressed=!0,this.isVisible()&&(this.menu.isVisible()?(this.menu.toggle(!1),this.toggle(!1)):this.inspector&&this.inspector.close())},ve.ui.DesktopContext.prototype.onUnsuppress=function(){var a=!!this.getAvailableTools().length;this.suppressed=!1,a&&(this.menu.toggle(!0),this.populateMenu(),this.toggle(!0))},ve.ui.DesktopContext.prototype.onSurfacePosition=function(){this.updateDimensions(!0)},ve.ui.DesktopContext.prototype.onWindowResize=function(){this.isVisible()&&this.updateDimensions()},ve.ui.DesktopContext.prototype.isEmbeddable=function(){var a,b=this.surface.getView().getFocusedNode();return b instanceof ve.ce.FocusableNode?(a=b.getDimensions(),a.height>this.menu.$element.outerHeight()+5&&a.width>this.menu.$element.outerWidth()+10):!1},ve.ui.DesktopContext.prototype.createInspectorWindowManager=function(){return new ve.ui.DesktopInspectorManager({$:this.$,factory:ve.ui.windowFactory,overlay:this.surface.getLocalOverlay(),modal:!1})},ve.ui.DesktopContext.prototype.toggle=function(a){var b;return this.transitioning?this.transitioning:(a=void 0===a?!this.visible:!!a,a===this.visible?$.Deferred().resolve().promise():(this.visible=a,this.transitioning=$.Deferred(),b=this.transitioning.promise(),this.popup.toggle(a),this.$element.add(this.popup.$element).css({visibility:a?"":"hidden",display:""}),this.transitioning.resolve(),this.transitioning=null,this.visible=a,a?(this.inspector&&this.inspectors.updateWindowSize(this.inspector),this.updateDimensions()):this.inspector&&this.inspector.close(),b))},ve.ui.DesktopContext.prototype.updateDimensions=function(a){var b,c,d,e,f,g=this.surface.getView(),h=g.getFocusedNode(),i=g.$element.offset(),j="rtl"===this.surface.getModel().getDocument().getDir(),k=this.isEmbeddable();return b=this.inspector?this.inspector.$frame:this.menu.$element,h?(this.popup.toggleAnchor(!k),c=h.getRelativeOffset(),d=h.getDimensions(),k?(f={y:c.top},j?(f.x=c.left,this.popup.align="left"):(f.x=c.left+d.width,this.popup.align="right")):(f={x:c.left+d.width/2,y:c.top+d.height},this.popup.align="center")):(e=g.getSelectionRect(),e&&(f={x:e.end.x-i.left,y:e.end.y-i.top}),this.popup.align="center"),f&&this.$element.css({left:f.x,top:f.y}),this.popup.setSize(b.outerWidth(!0),b.outerHeight(!0),!1),this},ve.ui.DesktopContext.prototype.destroy=function(){return this.surface.getView().disconnect(this),this.$window.off("resize",this.onWindowResizeHandler),ve.ui.DesktopContext.super.prototype.destroy.call(this)},ve.ui.DesktopInspectorManager=function(a){ve.ui.DesktopInspectorManager.super.call(this,a)},OO.inheritClass(ve.ui.DesktopInspectorManager,ve.ui.WindowManager),ve.ui.DesktopInspectorManager.static.sizes={small:{width:200,maxHeight:"100%"},medium:{width:300,maxHeight:"100%"},large:{width:400,maxHeight:"100%"},full:{width:"100%",height:"100%"}},ve.ui.DesktopInspectorManager.prototype.getSetupDelay=function(){return 0},ve.ui.DesktopInspectorManager.prototype.getReadyDelay=function(){return 0},ve.ui.DesktopInspectorManager.prototype.getHoldDelay=function(){return 0},ve.ui.DesktopInspectorManager.prototype.getTeardownDelay=function(){return 0};