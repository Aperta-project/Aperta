- content_for :nav_bar_items do
  %li.nav-bar-item= link_to 'Article Page', '#', class: 'active'

- content_for :control_bar do
  #control-bar-container
    #control-bar
      %section
        %ul
          %li#paper-journal
            - if @paper.journal.logo.present?
              = image_tag @paper.journal.logo.url
            - else
              %div
                = @paper.journal.name
          %li#paper-short-title= @paper.short_title
          %li#paper-revision R0
        %ul
          - if current_user.admin?
            %li= link_to 'Task Manager', manage_paper_path(@paper)

%main
  %article
    %div
      .title
        %h2#paper-title
          = @paper.title

      #paper-abstract
        = @paper.abstract

      - authors_array = @paper.authors.map { |a| a.slice(:first_name, :last_name, :email, :affiliation) }
      #paper-authors{data: { authors: authors_array.to_json }}

      #paper-body
        = @paper.body.html_safe

  %aside
    %ul.assigned-tasks.cards
      %ul.cards
        - @tasks.each do |task|
          - case task.title
          - when 'Declarations'
            %li
              = link_to '#', class: "card #{'completed' if task.completed?}", data: { 'card-name' => "declarations", 'paper-title' => @paper.short_title, 'paper-path' => paper_path(@paper), 'paper-id' => @paper.to_param, 'task-path' => paper_task_path(@paper, task), 'task-completed' => task.completed?, declarations: @paper.declarations.map { |d| d.slice(:question, :answer, :id) }.to_json } do
                %span.glyphicon.glyphicon-ok
                = task.title
          - when 'Upload Figures'
            %li
              = link_to '#', class: "card #{'completed' if task.completed?}", data: { 'card-name' => "figures", 'paper-title' => @paper.short_title, 'figures-path' => paper_figures_path(@paper), 'paper-path' => paper_path(@paper), 'paper-id' => @paper.to_param, 'task-path' => paper_task_path(@paper, task), figures: @paper.figures.map(&:access_details).to_json } do
                %span.glyphicon.glyphicon-ok
                = task.title
          - when 'Upload Manuscript'
            %li
              = link_to '#', class: "card #{'completed' if task.completed?}", data: { 'card-name' => "upload-manuscript", 'paper-title' => @paper.short_title, 'figures-path' => paper_figures_path(@paper), 'paper-path' => paper_path(@paper), 'paper-id' => @paper.to_param, 'task-path' => paper_task_path(@paper, task) } do
                %span.glyphicon.glyphicon-ok
                = task.title
          - when 'Authors'
            %li
              = link_to '#', class: "card", data: { 'card-name' => "authors", 'paper-title' => @paper.short_title, 'paper-path' => paper_path(@paper), 'paper-id' => @paper.to_param, 'task-path' => paper_task_path(@paper, task), authors: @paper.authors_json, 'refresh-on-close' => false } do
                %span.glyphicon.glyphicon-ok
                = task.title
          - else
            %li
              = link_to '#', class: "card #{'completed' if task.completed?}", data: { 'overlay-name' => "card-#{task.id}", 'overlay-title' => task.paper.short_title, 'paper-id' => task.paper.to_param, 'task-id' => task.to_param, 'task-completed' => task.completed? } do
                %span.glyphicon.glyphicon-ok
                = task.title
            .hidden{id: "card-#{task.id}-content"}
              = render task, paper: task.paper
    %div
      - task = Task.where(title: "Declarations", phase: @paper.phases.where(name: 'Submission Data').first).first
      = link_to '#', class: "card #{'completed' if task.completed?}", data: { 'card-name' => "declarations", 'paper-title' => @paper.short_title, 'paper-path' => paper_path(@paper), 'paper-id' => @paper.to_param, 'task-path' => paper_task_path(@paper, task), declarations: @paper.declarations.map { |d| d.slice(:question, :answer, :id) }.to_json } do
        %span.glyphicon.glyphicon-ok
        = task.title

      - task = Task.where(title: "Authors", phase: @paper.phases.where(name: 'Submission Data').first).first
      = link_to '#', class: "card", data: { 'card-name' => "authors", 'paper-title' => @paper.short_title, 'paper-path' => paper_path(@paper), 'paper-id' => @paper.to_param, 'task-path' => paper_task_path(@paper, task), authors: @paper.authors_json, 'refresh-on-close' => false } do
        %span.glyphicon.glyphicon-ok
        = task.title

      - task = Task.where(title: "Upload Figures", phase: @paper.phases.where(name: 'Submission Data').first).first
      = link_to '#', class: "card #{'completed' if task.completed?}", data: { 'card-name' => "figures", 'paper-title' => @paper.short_title, 'figures-path' => paper_figures_path(@paper), 'paper-path' => paper_path(@paper), 'paper-id' => @paper.to_param, 'task-path' => paper_task_path(@paper, task), figures: @paper.figures.map(&:access_details).to_json } do
        %span.glyphicon.glyphicon-ok
        Upload Figures

      = link_to 'Upload Manuscript', '#', data: { 'overlay-name' => 'upload-manuscript', 'overlay-title' => @paper.short_title }, class: 'card'
      #upload-manuscript-content.hidden
        = render 'overlays/upload_manuscript'

      = form_for @paper, remote: true, format: :json, html: { class: 'js-submit-on-change' } do |f|
        .form-group
          = f.label :paper_type
          = f.select :paper_type, Paper::PAPER_TYPES.map { |t| [t.humanize, t] }
